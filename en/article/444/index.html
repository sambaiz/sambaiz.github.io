<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Enable S3 versioning to retrieve accidentally overwritten or deleted objects - sambaiz-net</title>
  <meta name="twitter:title" content="Enable S3 versioning to retrieve accidentally overwritten or deleted objects - sambaiz-net">
  <meta property='og:title' content="Enable S3 versioning to retrieve accidentally overwritten or deleted objects - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="When enabled, all PUT data will remain with the version ID, and on DELETE, a delete marker is put as the latest version without actually deleting">
  <meta name="twitter:description" content="When enabled, all PUT data will remain with the version ID, and on DELETE, a delete marker is put as the latest version without actually deleting">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/444/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/444/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/444/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/444/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Enable S3 versioning to retrieve accidentally overwritten or deleted objects",
    "datePublished": "2023-03-15T22:35:00JST",
    "dateModified": "2023-03-15T22:35:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "When enabled, all PUT data will remain with the version ID, and on DELETE, a delete marker is put as the latest version without actually deleting"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/444/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/docker/">
            docker</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Enable S3 versioning to retrieve accidentally overwritten or deleted objects</h1>
        <time>2023-03-15</time>
        <a class="tag" href='/en/tags/aws/'>aws</a>
      </div>
      <p><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Versioning.html">Versioning</a> is settings of S3 Bucket.
When enabled, all PUT data will remain with the version ID, and on DELETE, a delete marker is put as the latest version without actually deleting.
If you GET an object whose latest version is a delete marker, it returns Not found like when there is no object, but if you delete the delete marker version, you can get that object again.</p>




<div class="img_container"><a href="/article/444/images/deletemarker.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/444/images/deletemarker_hu94af0976203cb0c5f1260b45be8c3add_133933_600x370_fit_lanczos_3.png" width="600" height="101" alt="Delete marker">
</a></div>


<p>If you delete an object with the version, the delete marker is not created.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">BUCKET</span><span style="color:#ff79c6">=</span>&lt;bucket&gt; <span style="color:#8be9fd;font-style:italic">PREFIX</span><span style="color:#ff79c6">=</span>&lt;prefix&gt; <span style="color:#8be9fd;font-style:italic">RESTORE_TIME</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;2023-03-14T15:00+00:00&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># permanently delete existing objects</span>
</span></span><span style="display:flex;"><span>$ aws s3api list-object-versions --bucket <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">BUCKET</span><span style="color:#f1fa8c">}</span> --prefix <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">PREFIX</span><span style="color:#f1fa8c">}</span> --output json --query <span style="color:#f1fa8c">&#39;Versions[?IsLatest==`true` &amp;&amp; LastModified&gt;`&#39;</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">RESTORE_TIME</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">&#39;].[Key, VersionId]&#39;</span> | jq -r <span style="color:#f1fa8c">&#39;.[] | &#34;--key &#39;</span><span style="color:#f1fa8c">\&#39;</span><span style="color:#f1fa8c">&#39;&#34; + .[0] + &#34;&#39;</span><span style="color:#f1fa8c">\&#39;</span><span style="color:#f1fa8c">&#39; --version-id &#34; + .[1]&#39;</span> | xargs -L1 aws s3api delete-object --bucket <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">BUCKET</span><span style="color:#f1fa8c">}</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># permanently delete delete markers</span>
</span></span><span style="display:flex;"><span>$ aws s3api list-object-versions --bucket &lt;bucket&gt; --prefix <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">PREFIX</span><span style="color:#f1fa8c">}</span> --output json --query <span style="color:#f1fa8c">&#39;DeleteMarkers[?IsLatest==`true` &amp;&amp; LastModified&gt;`&#39;</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">RESTORE_TIME</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">&#39;`].[Key, VersionId]&#39;</span> | jq -r <span style="color:#f1fa8c">&#39;.[] | &#34;--key &#39;</span><span style="color:#f1fa8c">\&#39;</span><span style="color:#f1fa8c">&#39;&#34; + .[0] + &#34;&#39;</span><span style="color:#f1fa8c">\&#39;</span><span style="color:#f1fa8c">&#39; --version-id &#34; + .[1]&#39;</span> | xargs -L1 aws s3api delete-object --bucket <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">BUCKET</span><span style="color:#f1fa8c">}</span> 
</span></span></code></pre></div><p>Past versions are also applied to billing in the same way as the latest objects.
So if objects are frequently overwritten or deleted on a daily basis, enabling versioning will increase the cost,
but if they are not updated so much, they can be saved from accidents without paying the cost for the backup.
By creating a lifecycle rule that deletes outdated versions, you can prevent deleted objects from remaining forever.</p>




<div class="img_container"><a href="/article/444/images/lifecycle.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/444/images/lifecycle_hufdbe681b38e9ebeef9737c67fef25fea_612185_600x370_fit_lanczos_3.png" width="600" height="352" alt="lifecyle rule which deletes outdated versions">
</a></div>


<h2 id="reference">Reference</h2>
<p><a href="https://repost.aws/knowledge-center/s3-undelete-configuration">Retrieve an Amazon S3 object that was deleted | AWS re:Post</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>