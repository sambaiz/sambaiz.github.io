<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Spark Web UI: Monitor Job Stages, Tasks distribution and SQL plan - sambaiz-net</title>
  <meta name="twitter:title" content="Spark Web UI: Monitor Job Stages, Tasks distribution and SQL plan - sambaiz-net">
  <meta property='og:title' content="Spark Web UI: Monitor Job Stages, Tasks distribution and SQL plan - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="Monitor Jobs and Executors">
  <meta name="twitter:description" content="Monitor Jobs and Executors">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/382/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/382/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/382/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/382/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Spark Web UI: Monitor Job Stages, Tasks distribution and SQL plan",
    "datePublished": "2021-09-30T13:00:00JST",
    "dateModified": "2021-09-30T13:00:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "Monitor Jobs and Executors"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/382/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/linux/">
            linux</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Spark Web UI: Monitor Job Stages, Tasks distribution and SQL plan</h1>
        <time>2021-09-30</time>
        <a class="tag" href='/en/tags/spark/'>spark</a><a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/etl/'>etl</a>
      </div>
      <p>Spark <a href="https://spark.apache.org/docs/latest/web-ui.html">Web UI</a> is a tool for monitoring Jobs and Executors.</p>
<p>Get Dockerfile that runs Spark based on maven:3.6-amazoncorretto-8 from <a href="https://github.com/aws-samples/aws-glue-samples/tree/b76ad0583bdc66e9e5a903f9da3a953c9f6aac4f">aws-glue-samples</a>, and <a href="https://docs.aws.amazon.com/glue/latest/dg/monitor-spark-ui-history.html#monitor-spark-ui-history-local">start</a> <a href="https://spark.apache.org/docs/latest/monitoring.html">History Server</a> with the path of EventLog output by Glue and authentication information to get it.</p>




<div class="img_container"><a href="/article/382/images/eventlog-settings.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/382/images/eventlog-settings_hu17683940079105328013.png" width="385" height="167" alt="Output EventLog config">
</a></div>


<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ git clone https://github.com/aws-samples/aws-glue-samples.git
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">cd</span> aws-glue-samples/utilities/Spark_UI/glue-3_0/
</span></span><span style="display:flex;"><span>$ docker build -t glue/sparkui:latest .
</span></span><span style="display:flex;"><span>$ docker run -it -e <span style="color:#8be9fd;font-style:italic">SPARK_HISTORY_OPTS</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$SPARK_HISTORY_OPTS</span><span style="color:#f1fa8c"> -Dspark.history.fs.logDirectory=s3a://path_to_eventlog 
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">-Dspark.hadoop.fs.s3a.access.key=</span><span style="color:#8be9fd;font-style:italic">$AWS_ACCESS_KEY_ID</span><span style="color:#f1fa8c"> -Dspark.hadoop.fs.s3a.secret.key=</span><span style="color:#8be9fd;font-style:italic">$AWS_SECRET_ACCESS_KEY</span><span style="color:#f1fa8c">&#34;</span> 
</span></span><span style="display:flex;"><span>-p 18080:18080 glue/sparkui:latest <span style="color:#f1fa8c">&#34;/opt/spark/bin/spark-class org.apache.spark.deploy.history.HistoryServer&#34;</span>
</span></span></code></pre></div><p>Now, you can access http://localhost:18080 and select Application.
The timeline of executing Jobs and adding Executors is displayed.</p>




<div class="img_container"><a href="/article/382/images/job-execution-timeline.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/382/images/job-execution-timeline_hu5030241373218191109.png" width="600" height="234" alt="Job and Executors timeline">
</a></div>


<p>When you select Job, Stage and DAG (Directed Acyclic Graph) are displayed as shown below.
WholeStageCodeGen is a process to generate code in Stage units instead of doing it in each process for acceleration.
However, if the generated code is large, the JVM&rsquo;s JIT compiler does not natively compile and executes it with the interpreter, so it may actually slow down.</p>
<p>The number of Stages is the number that requires a costly shuffle, so the smaller, the better.
If it is big due to joins, consider adjusting parameters to do <a href="https://spark.apache.org/docs/latest/sql-performance-tuning.html#converting-sort-merge-join-to-broadcast-join">Broadcast Hash Join</a> that doesn&rsquo;t need to shuffle instead.</p>
<p><a href="https://www.sambaiz.net/en/article/208/">What is Apache Spark, RDD, DataFrame, DataSet, Action and Transformation - sambaiz-net</a></p>




<div class="img_container"><a href="/article/382/images/stages-dag.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/382/images/stages-dag_hu2161780313050912993.png" width="528" height="370" alt="DAG for each Stage">
</a></div>


<p>When you select Stage, the Task timeline of each Executor is displayed.
Most of the time is spent for computing, and the Task execution time and input records of each Executor are also almost uniform, so appear to be well distributed.</p>




<div class="img_container"><a href="/article/382/images/task-timeline.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/382/images/task-timeline_hu2682895387803262804.png" width="600" height="286" alt="Timeline of executed Task by each Executor">
</a></div>


<p>At the SQL tab, you can see the Logical plan of optimized queries, Physical plan that is actual executed, and how long each process takes.</p>




<div class="img_container"><a href="/article/382/images/sql-physical-plan.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/382/images/sql-physical-plan_hu11480996184284601735.png" width="236" height="370" alt="SQL Physical plan">
</a></div>


<h2 id="references">References</h2>
<p><a href="https://logmi.jp/tech/articles/321475">Apache Sparkコミッターが教える、Spark SQLの詳しい仕組みとパフォーマンスチューニング Part2 - ログミーTech</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>