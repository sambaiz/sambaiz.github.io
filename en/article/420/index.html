<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Develop Spark Applications in Scala, deploy with GitHub Actions, and perform remote debugging on EMR - sambaiz-net</title>
  <meta name="twitter:title" content="Develop Spark Applications in Scala, deploy with GitHub Actions, and perform remote debugging on EMR - sambaiz-net">
  <meta property='og:title' content="Develop Spark Applications in Scala, deploy with GitHub Actions, and perform remote debugging on EMR - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="It can be performed remote debugging without inserting codes with JDWP, and written easily because the Spark API is close to the standard library">
  <meta name="twitter:description" content="It can be performed remote debugging without inserting codes with JDWP, and written easily because the Spark API is close to the standard library">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/420/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/420/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/420/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/420/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Develop Spark Applications in Scala, deploy with GitHub Actions, and perform remote debugging on EMR",
    "datePublished": "2022-10-21T23:36:00JST",
    "dateModified": "2022-10-21T23:36:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "It can be performed remote debugging without inserting codes with JDWP, and written easily because the Spark API is close to the standard library"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/420/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Develop Spark Applications in Scala, deploy with GitHub Actions, and perform remote debugging on EMR</h1>
        <time>2022-10-21</time>
        <a class="tag" href='/en/tags/spark/'>spark</a><a class="tag" href='/en/tags/scala/'>scala</a><a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/etl/'>etl</a>
      </div>
      <p>Spark provides Java and Python APIs in addition to Scala, which is used for developing Spark itself.
You can choose among them depending on the technical stack and technologies used in other components, etc.</p>
<p>While Python has highly compatible with data analysis and machine learning skill sets and easy to edit and run on Glue Studio, the error is hard to understand, and the performance also has disadvantages because it needs to exchange the data between JVM and Python Workers.
Also, if the Python interpreter, which is not controlled by the JVM, try to use more memory than a resource manager such as YARN has allocated, the executor can be killed.</p>
<p>Scala tends to be said it is a relatively hard language, but it&rsquo;s not much different from PySpark in terms of calling the Spark API.
The Spark API is close to the standard library, so you may feel easy to write codes if you have already experienced Scala.
Besides, it also has an advantage that can perform remote debugging without inserting codes with JDWP.</p>
<p>From Spark 3.2.0, <a href="https://spark.apache.org/docs/latest/index.html#downloading">Scala 2.12/2.13</a> were supported, so you may expect <a href="https://docs.scala-lang.org/scala3/reference/enums/enums.html">enum</a> and <a href="https://docs.scala-lang.org/scala3/reference/contextual/extension-methods.html">extension</a> added in Scala 3 can be used by <a href="https://www.scala-lang.org/blog/2021/04/08/scala-3-in-sbt.html#using-scala-213-libraries-in-scala-3">CrossVersion.for3Use2_13</a>, but the default version still seems to be 2.12, and Spark on EMR is also built with 2.12, so it doesn&rsquo;t work currently.</p>
<p><a href="https://www.sambaiz.net/en/article/423/">Enumerated types and extending existing types in Scala 2/3 - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ spark-shell --version
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Using Scala version 2.12.15, OpenJDK 64-Bit Server VM, 1.8.0_342
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ spark-submit --class <span style="color:#f1fa8c">&#34;TestApp&#34;</span> --master <span style="color:#f1fa8c">&#34;local[4]&#34;</span> target/scala-3.2.1/simple-project_3-1.0.jar
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Exception in thread <span style="color:#f1fa8c">&#34;main&#34;</span> java.lang.NoSuchMethodError: <span style="color:#f1fa8c">&#39;java.lang.Object scala.Predef$.refArrayOps(java.lang.Object[])&#39;</span>
</span></span><span style="display:flex;"><span>        at TestApp$.main<span style="color:#ff79c6">(</span>Main.scala:6<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>        at TestApp.main<span style="color:#ff79c6">(</span>Main.scala<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h2 id="set-up-scalahttpsdocsscala-langorggetting-startedindexhtml"><a href="https://docs.scala-lang.org/getting-started/index.html">Set up Scala</a></h2>
<p>Install sbt etc. with <a href="https://get-coursier.io/docs/cli-setup">cs setup</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ brew install coursier/formulas/coursier <span style="color:#ff79c6">&amp;&amp;</span> cs setup
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Checking <span style="color:#ff79c6">if</span> the standard Scala applications are installed
</span></span><span style="display:flex;"><span>  Installed ammonite
</span></span><span style="display:flex;"><span>  Installed cs
</span></span><span style="display:flex;"><span>  Installed coursier
</span></span><span style="display:flex;"><span>  Installed scala
</span></span><span style="display:flex;"><span>  Installed scalac
</span></span><span style="display:flex;"><span>  Installed scala-cli
</span></span><span style="display:flex;"><span>  Installed sbt
</span></span><span style="display:flex;"><span>  Installed sbtn
</span></span><span style="display:flex;"><span>  Installed scalafmt
</span></span></code></pre></div><p>Create a hello world project, and try to execute.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sbt new scala/hello-world.g8
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">cd</span> hello-world-template
</span></span><span style="display:flex;"><span>$ tree .
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── build.sbt
</span></span><span style="display:flex;"><span>├── project
</span></span><span style="display:flex;"><span>│ └── build.properties
</span></span><span style="display:flex;"><span>└── src
</span></span><span style="display:flex;"><span>└── main
</span></span><span style="display:flex;"><span>└── scala
</span></span><span style="display:flex;"><span>└── Main.scala
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat build.sbt | grep <span style="color:#f1fa8c">&#34;scalaVersion&#34;</span>
</span></span><span style="display:flex;"><span>scalaVersion :<span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;2.13.8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sbt run
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>info<span style="color:#ff79c6">]</span>   Compilation completed in 6.913s.
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>info<span style="color:#ff79c6">]</span> running Main 
</span></span><span style="display:flex;"><span>Hello, World!
</span></span></code></pre></div><h2 id="implementationhttpssparkapacheorgdocs330quick-starthtml"><a href="https://spark.apache.org/docs/3.3.0/quick-start.html">Implementation</a></h2>
<p>Add <a href="https://mvnrepository.com/artifact/org.apache.spark/spark-sql_2.13/3.3.0">spark-sql</a> to dependencies.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cat build.sbt
</span></span><span style="display:flex;"><span>name :<span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Simple Project&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>version :<span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;1.0&#34;</span>
</span></span><span style="display:flex;"><span>scalaVersion :<span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;2.12.17&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">libraryDependencies</span> <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">&#34;org.apache.spark&#34;</span> %% <span style="color:#f1fa8c">&#34;spark-sql&#34;</span> % <span style="color:#f1fa8c">&#34;3.3.0&#34;</span> % <span style="color:#f1fa8c">&#34;provided&#34;</span>
</span></span></code></pre></div><p>Run a simple SQL.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.spark.sql.SparkSession
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">object</span> <span style="color:#50fa7b">TestApp</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">])</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> spark <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">SparkSession</span><span style="color:#ff79c6">.</span>builder<span style="color:#ff79c6">.</span>appName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Test Application&#34;</span><span style="color:#ff79c6">).</span>getOrCreate<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">var</span> out <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>sql<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;SELECT 1 as a, 2 as b, 3 as c&#34;</span><span style="color:#ff79c6">).</span>collect<span style="color:#ff79c6">().</span>map<span style="color:#ff79c6">(</span>row <span style="color:#ff79c6">=&gt;</span> row<span style="color:#ff79c6">.</span>mkString<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;,&#34;</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>    println<span style="color:#ff79c6">(</span>out<span style="color:#ff79c6">.</span>head<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    spark<span style="color:#ff79c6">.</span>stop<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>Package it and generate a jar.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sbt package
</span></span><span style="display:flex;"><span>$ ls target/scala-2.12 | grep <span style="color:#f1fa8c">&#34;.jar&#34;</span>
</span></span><span style="display:flex;"><span>simple-project_2.12-1.0.jar
</span></span></code></pre></div><h2 id="execution">Execution</h2>
<p>Execute it with spark-submit.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ brew install apache-spark
</span></span><span style="display:flex;"><span>$ spark-submit --class <span style="color:#f1fa8c">&#34;TestApp&#34;</span> --master <span style="color:#f1fa8c">&#34;local[4]&#34;</span> target/scala-2.12/simple-project_2.12-1.0.jar
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>1,2,3
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h2 id="deploy">Deploy</h2>
<p>Upload the jar file to S3 with GitHub Actions.</p>
<p><a href="https://www.sambaiz.net/en/article/421/">Create a role that can assume with OIDC from GitHub Actions with CDK - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>$ cat .github/workflows/ci.yml 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">name</span>: CI
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">on</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">push</span>:
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">env</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">DEPLOY_ROLE_NAME</span>: <span style="color:#f1fa8c">&#34;arn:aws:iam::&lt;aws_account_id&gt;:role/ScalaSparkCiRemoteDebugStack_DeployRole&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">DEPLOY_BUCKET_NAME</span>: <span style="color:#f1fa8c">&#34;scalasparkciremotedebugstack-&lt;aws_account_id&gt;-deploy-bucket&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">AWS_REGION</span>: <span style="color:#f1fa8c">&#34;ap-northeast-1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">permissions</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">id-token</span>: write <span style="color:#6272a4"># This is required for requesting the JWT</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">contents</span>: read  <span style="color:#6272a4"># This is required for actions/checkout</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">jobs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">test</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">runs-on</span>: ubuntu-latest
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">steps</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">name</span>: Checkout
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">uses</span>: actions/checkout@v2
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">name</span>: Setup JDK
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">uses</span>: actions/setup-java@v3
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">with</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">distribution</span>: temurin
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">java-version</span>: <span style="color:#bd93f9">8</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">name</span>: Creates a jar file
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">run</span>: sbt package
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">name</span>: Configure AWS Credentials
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">uses</span>: aws-actions/configure-aws-credentials@v1
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">with</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">role-to-assume</span>: ${{ env.DEPLOY_ROLE_NAME }}
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">aws-region</span>: ${{ env.AWS_REGION }}
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">name</span>: Deploy the jar file
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">run</span>: aws s3 cp target/scala-2.12/simple-project_2.12-1.0.jar s3://${{ env.DEPLOY_BUCKET_NAME }}/
</span></span></code></pre></div><h2 id="remote-debugging">Remote debugging</h2>
<p>With preventing the application from running until a debugger connects with server=y,suspend=y, spark-submit to EMR.</p>
<p><a href="https://www.sambaiz.net/en/article/411/">Debug a Java application running on a remote machine by enabling JDWP - sambaiz-net</a></p>
<p>Pass client as deploy-mode to run the driver on the master instance.</p>
<p><a href="https://www.sambaiz.net/en/article/409/">Launch an EMR cluster with AWS CLI and run Spark applications - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ aws emr add-steps <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --cluster-id &lt;cluster_id&gt; <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --steps <span style="color:#f1fa8c">&#39;[{
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;Type&#34;: &#34;CUSTOM_JAR&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;Name&#34;: &#34;spark-submit&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;Jar&#34;: &#34;command-runner.jar&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;Args&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      &#34;spark-submit&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      &#34;--master&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      &#34;yarn&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      &#34;--deploy-mode&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      &#34;client&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      &#34;--conf&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      &#34;spark.driver.extraJavaOptions=-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      &#34;s3://&lt;bucket&gt;/simple-project_2.12-1.0.jar&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">}]&#39;</span>
</span></span></code></pre></div><p>Start port forwarding to the master instance with Session Manager, etc., and then remote debugging begins.
If handshake failed occurs, check the port number is correct and so on.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ aws ssm start-session --target &lt;master_instance_id&gt; --document-name AWS-StartPortForwardingSession --parameters <span style="color:#f1fa8c">&#39;{&#34;portNumber&#34;:[&#34;5005&#34;], &#34;localPortNumber&#34;:[&#34;5005&#34;]}&#39;</span>
</span></span></code></pre></div>



<div class="img_container"><a href="/article/420/images/debug.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/420/images/debug_hu14423993262688867707.png" width="600" height="305" alt="Remote debugging">
</a></div>


<h2 id="references">References</h2>
<p><a href="https://www.47deg.com/blog/using-scala-3-with-spark/">Using Scala 3 with Spark | 47 Degrees</a></p>
<p><a href="https://youtu.be/V6DkTVvy9vk">Getting The Best Performance With PySpark</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>