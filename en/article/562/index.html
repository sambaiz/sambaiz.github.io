<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Understanding DuckDB Hive Partition Pruning from Source Code - sambaiz-net</title>
  <meta name="twitter:title" content="Understanding DuckDB Hive Partition Pruning from Source Code - sambaiz-net">
  <meta property='og:title' content="Understanding DuckDB Hive Partition Pruning from Source Code - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="When reading Hive partitions in DuckDB, pruning is performed to skip unnecessary files based on WHERE conditions. This article explains the mechanism from the source code.">
  <meta name="twitter:description" content="When reading Hive partitions in DuckDB, pruning is performed to skip unnecessary files based on WHERE conditions. This article explains the mechanism from the source code.">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/562/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/562/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/562/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/562/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Understanding DuckDB Hive Partition Pruning from Source Code",
    "datePublished": "2026-02-15T02:00:00JST",
    "dateModified": "2026-02-15T02:00:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "When reading Hive partitions in DuckDB, pruning is performed to skip unnecessary files based on WHERE conditions. This article explains the mechanism from the source code."
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/562/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="/places/">
            <img src="/image/pin.svg" width="32px" height="32px" alt="places">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Understanding DuckDB Hive Partition Pruning from Source Code</h1>
        <time>2026-02-15</time>
        <a class="tag" href='/en/tags/database/'>database</a>
      </div>
      <p>When reading Hive partitions in DuckDB, pruning is performed to skip unnecessary files based on WHERE conditions. This article explains the mechanism from the source code.</p>
<p><a href="https://www.sambaiz.net/en/article/508/">Retrieve Google Sheets data using SQL with DuckDB&rsquo;s Go client - sambaiz-net</a></p>
<h2 id="confirming-pruning">Confirming Pruning</h2>
<p>Prepare data in Hive partition format.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ duckdb --version
</span></span><span style="display:flex;"><span>v1.4.4 (Andium) 6ddac802ff
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>$ duckdb
</span></span><span style="display:flex;"><span>D <span style="color:#ff79c6">COPY</span> (<span style="color:#ff79c6">SELECT</span> i, i <span style="color:#ff79c6">%</span> <span style="color:#bd93f9">12</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">AS</span> <span style="color:#ff79c6">month</span> <span style="color:#ff79c6">FROM</span> range(<span style="color:#bd93f9">1000000</span>) t(i))
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">TO</span> <span style="color:#f1fa8c">&#39;data&#39;</span> (FORMAT PARQUET, PARTITION_BY (<span style="color:#ff79c6">month</span>));
</span></span></code></pre></div><p>Read with <code>hive_partitioning=true</code>. You can check the execution plan with <code>EXPLAIN ANALYZE</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>D <span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">ANALYZE</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> read_parquet(<span style="color:#f1fa8c">&#39;data/**/*.parquet&#39;</span>, hive_partitioning<span style="color:#ff79c6">=</span><span style="color:#ff79c6">true</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">WHERE</span> <span style="color:#ff79c6">month</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>┌────────────────────────────────────────────────┐
</span></span><span style="display:flex;"><span>│┌──────────────────────────────────────────────┐│
</span></span><span style="display:flex;"><span>││              Total Time: <span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">0034</span>s             ││
</span></span><span style="display:flex;"><span>│└──────────────────────────────────────────────┘│
</span></span><span style="display:flex;"><span>└────────────────────────────────────────────────┘
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>┌───────────────────────────┐
</span></span><span style="display:flex;"><span>│         TABLE_SCAN        │
</span></span><span style="display:flex;"><span>│    ────────────────────   │
</span></span><span style="display:flex;"><span>│         <span style="color:#ff79c6">Function</span>:         │
</span></span><span style="display:flex;"><span>│        READ_PARQUET       │
</span></span><span style="display:flex;"><span>│                           │
</span></span><span style="display:flex;"><span>│       File Filters:       │
</span></span><span style="display:flex;"><span>│        (<span style="color:#ff79c6">month</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>)        │
</span></span><span style="display:flex;"><span>│                           │
</span></span><span style="display:flex;"><span>│    Scanning Files: <span style="color:#bd93f9">1</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">12</span>   │
</span></span><span style="display:flex;"><span>│    Total Files <span style="color:#ff79c6">Read</span>: <span style="color:#bd93f9">1</span>    │
</span></span><span style="display:flex;"><span>└───────────────────────────┘
</span></span></code></pre></div><p>Only 1 out of 12 files is scanned.</p>
<p>DuckDB query execution proceeds in the order Parser → Binder → Optimizer → Executor. Pruning is performed in both the Optimizer and Executor.</p>
<h2 id="pruning-in-optimizer">Pruning in Optimizer</h2>
<h3 id="recognizing-partition-information">Recognizing Partition Information</h3>
<p>The Binder extracts Hive partition information from file paths. <a href="https://github.com/duckdb/duckdb/blob/v1.4.4/src/common/hive_partitioning.cpp#L95-L122">HivePartitioning::Parse()</a> parses <code>key=value</code> pairs from path strings, and <a href="https://github.com/duckdb/duckdb/blob/v1.4.4/src/common/multi_file/multi_file_reader.cpp#L220-L284">MultiFileReader::BindOptions()</a> registers them in <code>bind_data.hive_partitioning_indexes</code>.</p>
<h3 id="static-filters">Static Filters</h3>
<p><code>read_parquet</code> is a <a href="https://duckdb.org/docs/sql/functions/table_functions">table function</a> that can be used like a table in the FROM clause, and can implement a callback called <code>pushdown_complex_filter</code>. The Optimizer&rsquo;s <a href="https://github.com/duckdb/duckdb/blob/v1.4.4/src/optimizer/pushdown/pushdown_get.cpp#L10-L86">FilterPushdown::PushdownGet()</a> calls this and passes filter expressions.</p>
<p><a href="https://github.com/duckdb/duckdb/blob/v1.4.4/src/common/hive_partitioning.cpp#L152-L209">HivePartitioning::ApplyFiltersToFileList()</a> performs the following for each file:</p>
<ol>
<li>Extract partition value from file path (e.g., <code>data/month=2/...</code> → <code>month=2</code>)</li>
<li>Replace column references in filter expression with constants using <a href="https://github.com/duckdb/duckdb/blob/v1.4.4/src/common/hive_partitioning.cpp#L51-L80">ConvertKnownColRefToConstants()</a> (<code>month</code> → <code>2</code>)</li>
<li>Evaluate expression (<code>WHERE month = 1</code> → <code>2 = 1</code> → false)</li>
<li>Exclude file if false</li>
</ol>
<p>This narrows down the file list itself.</p>
<h3 id="notes-on-join">Notes on JOIN</h3>
<p>Pruning works in queries with JOIN, but only for constant comparisons like <code>month = 1</code>. For JOIN conditions like <code>t2.month = t1.month</code>, pruning does not work for t2.
Since <code>ConvertKnownColRefToConstants()</code> only converts column references from the same table to constants, filters containing column references from other tables cannot be evaluated. Therefore, to enable pruning on both tables, you need to write it explicitly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>D <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">FROM</span> read_parquet(<span style="color:#f1fa8c">&#39;data1/**/*.parquet&#39;</span>, hive_partitioning<span style="color:#ff79c6">=</span><span style="color:#ff79c6">true</span>) t1
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">JOIN</span> read_parquet(<span style="color:#f1fa8c">&#39;data2/**/*.parquet&#39;</span>, hive_partitioning<span style="color:#ff79c6">=</span><span style="color:#ff79c6">true</span>) t2 <span style="color:#ff79c6">ON</span> t1.id <span style="color:#ff79c6">=</span> t2.id
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">WHERE</span> t1.<span style="color:#ff79c6">month</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">-- WHERE t1.month = 1 AND t2.month = 1 → OK
</span></span></span></code></pre></div><p>Alternatively, using the USING clause enables pruning on both tables.
This is because <a href="https://github.com/duckdb/duckdb/blob/v1.4.4/src/optimizer/filter_combiner.cpp">FilterCombiner</a> groups columns with equal values and filters them. From <code>USING (month)</code>, <code>t1.month = t2.month</code> is derived, and combined with <code>WHERE month = 1</code>, <code>month = 1</code> is applied to both tables.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>D <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">FROM</span> read_parquet(<span style="color:#f1fa8c">&#39;data1/**/*.parquet&#39;</span>, hive_partitioning<span style="color:#ff79c6">=</span><span style="color:#ff79c6">true</span>) t1
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">JOIN</span> read_parquet(<span style="color:#f1fa8c">&#39;data2/**/*.parquet&#39;</span>, hive_partitioning<span style="color:#ff79c6">=</span><span style="color:#ff79c6">true</span>) t2 <span style="color:#ff79c6">USING</span> (<span style="color:#ff79c6">month</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">WHERE</span> <span style="color:#ff79c6">month</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span></code></pre></div><h2 id="pruning-in-executor">Pruning in Executor</h2>
<p>Subqueries are converted to HASH_JOIN, and <a href="https://github.com/duckdb/duckdb/blob/v1.4.4/src/optimizer/join_filter_pushdown_optimizer.cpp">Join Filter Pushdown</a> is applied to skip files outside the min/max of the result. Note that in BigQuery, pruning does <a href="https://cloud.google.com/bigquery/docs/querying-partitioned-tables">not work</a> with dynamic expressions like subqueries.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>D <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">FROM</span> read_parquet(<span style="color:#f1fa8c">&#39;data/**/*.parquet&#39;</span>, hive_partitioning<span style="color:#ff79c6">=</span><span style="color:#ff79c6">true</span>) t1
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">WHERE</span> t1.<span style="color:#ff79c6">month</span> <span style="color:#ff79c6">=</span> (<span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">month</span> <span style="color:#ff79c6">FROM</span> other_table <span style="color:#ff79c6">WHERE</span> <span style="color:#ff79c6">key</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>);
</span></span></code></pre></div>
    </div>
  </article>
</div>

</div>
</body>

</html>