<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Call AWS API with AwsCustomResource in CDK - sambaiz-net</title>
  <meta name="twitter:title" content="Call AWS API with AwsCustomResource in CDK - sambaiz-net">
  <meta property='og:title' content="Call AWS API with AwsCustomResource in CDK - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="When you need to pass values that can be obtained only after createing resources in CDK, you may want to call Describe API. Normally, to do someting like this that is not managed by CloudFormation, you need to prepare your own lambda function and create a CustomResource, but if you just want to call AWS APIs, you can use AwsCustomResource">
  <meta name="twitter:description" content="When you need to pass values that can be obtained only after createing resources in CDK, you may want to call Describe API. Normally, to do someting like this that is not managed by CloudFormation, you need to prepare your own lambda function and create a CustomResource, but if you just want to call AWS APIs, you can use AwsCustomResource">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/468/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/468/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/468/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/468/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Call AWS API with AwsCustomResource in CDK",
    "datePublished": "2024-01-30T22:19:00JST",
    "dateModified": "2024-01-30T22:19:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "When you need to pass values that can be obtained only after createing resources in CDK, you may want to call Describe API. Normally, to do someting like this that is not managed by CloudFormation, you need to prepare your own lambda function and create a CustomResource, but if you just want to call AWS APIs, you can use AwsCustomResource"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/468/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/linux/">
            linux</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Call AWS API with AwsCustomResource in CDK</h1>
        <time>2024-01-30</time>
        <a class="tag" href='/en/tags/aws/'>aws</a>
      </div>
      <p>When you need to pass values that can be obtained only after createing resources in CDK,
you may want to call Describe API. Normally, to do someting like this that is not managed by CloudFormation, you need to prepare your own lambda function and create a CustomResource,
but if you just want to <a href="https://github.com/aws/aws-cdk/blob/v2.124.0/packages/%40aws-cdk/custom-resource-handlers/lib/custom-resources/aws-custom-resource-handler/aws-sdk-v3-handler.ts#L122">call</a> AWS APIs, you can use <a href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.custom_resources.AwsCustomResource.html">AwsCustomResource</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">as</span> cdk <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#39;aws-cdk-lib&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> { Construct } <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#39;constructs&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">as</span> ec2 <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#39;aws-cdk-lib/aws-ec2&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">as</span> eks <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#39;aws-cdk-lib/aws-eks&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> { KubectlV27Layer } <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#39;@aws-cdk/lambda-layer-kubectl-v27&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> CdkCallAwsApiTestStack <span style="color:#ff79c6">extends</span> cdk.Stack {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">constructor</span>(scope: <span style="color:#8be9fd">Construct</span>, id: <span style="color:#8be9fd">string</span>, props?: <span style="color:#8be9fd">cdk.StackProps</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">super</span>(scope, id, props);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> vpc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ec2.Vpc(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;vpc&#39;</span>, {
</span></span><span style="display:flex;"><span>      vpcName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;cdk-call-aws-api-test&#39;</span>,
</span></span><span style="display:flex;"><span>      ipAddresses: <span style="color:#8be9fd">ec2.IpAddresses.cidr</span>(<span style="color:#f1fa8c">&#39;10.18.0.0/18&#39;</span>),
</span></span><span style="display:flex;"><span>      maxAzs: <span style="color:#8be9fd">2</span>,
</span></span><span style="display:flex;"><span>      ipProtocol: <span style="color:#8be9fd">ec2.IpProtocol.DUAL_STACK</span>,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> cluster <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> eks.Cluster(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;cluster&#39;</span>, {
</span></span><span style="display:flex;"><span>      vpc,
</span></span><span style="display:flex;"><span>      clusterName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;cdk-call-aws-api-test&#39;</span>,
</span></span><span style="display:flex;"><span>      version: <span style="color:#8be9fd">eks.KubernetesVersion.V1_27</span>,
</span></span><span style="display:flex;"><span>      kubectlLayer: <span style="color:#8be9fd">new</span> KubectlV27Layer(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;KubectlV27Layer&#39;</span>),
</span></span><span style="display:flex;"><span>      defaultCapacity: <span style="color:#8be9fd">1</span>,
</span></span><span style="display:flex;"><span>      defaultCapacityInstance: <span style="color:#8be9fd">new</span> ec2.InstanceType(<span style="color:#f1fa8c">&#39;m5.large&#39;</span>),
</span></span><span style="display:flex;"><span>      ipFamily: <span style="color:#8be9fd">eks.IpFamily.IP_V6</span>,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> customResourceParams <span style="color:#ff79c6">=</span> ({
</span></span><span style="display:flex;"><span>      onCreate<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>        service<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;eks&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// https://docs.aws.amazon.com/eks/latest/APIReference/API_DescribeCluster.html
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        action<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;describeCluster&#39;</span>,
</span></span><span style="display:flex;"><span>        parameters<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>          name: <span style="color:#8be9fd">cluster.clusterName</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        physicalResourceId: <span style="color:#8be9fd">cdk.custom_resources.PhysicalResourceId.fromResponse</span>(<span style="color:#f1fa8c">&#34;cluster.arn&#34;</span>) <span style="color:#6272a4">// = PhysicalResourceId.of(cluster.clusterArn)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      },
</span></span><span style="display:flex;"><span>      onUpdate<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>        service<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;sts&#39;</span>,
</span></span><span style="display:flex;"><span>        action<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;getCallerIdentity&#39;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#6272a4">// parameters: {},
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      },
</span></span><span style="display:flex;"><span>      policy: <span style="color:#8be9fd">cdk.custom_resources.AwsCustomResourcePolicy.fromSdkCalls</span>({
</span></span><span style="display:flex;"><span>        resources: <span style="color:#8be9fd">cdk.custom_resources.AwsCustomResourcePolicy.ANY_RESOURCE</span>,
</span></span><span style="display:flex;"><span>      }),
</span></span><span style="display:flex;"><span>      timeout: <span style="color:#8be9fd">cdk.Duration.minutes</span>(<span style="color:#bd93f9">5</span>),
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> clusterInfo <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> cdk.custom_resources.AwsCustomResource(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;EksDescribeCluster&#39;</span>, customResourceParams);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">new</span> cdk.custom_resources.AwsCustomResource(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;EksDescribeCluster2&#39;</span>, customResourceParams);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">new</span> cdk.CfnOutput(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;ServiceIpv6CidrOutput&#39;</span>, {
</span></span><span style="display:flex;"><span>      value: <span style="color:#8be9fd">clusterInfo.getResponseField</span>(<span style="color:#f1fa8c">&#34;cluster.kubernetesNetworkConfig.serviceIpv6Cidr&#34;</span>),
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>When you deploy this, the following Role will be created and the response of eks.describeCluster in onCreate will be shown as Output.</p>




<div class="img_container"><a href="/article/468/images/role.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/468/images/role_hubb61f3c2a66f1208e43288fd12572665_376584_600x370_fit_lanczos_3.png" width="481" height="370" alt="Created role">
</a></div>


<p>Even if physicalResourceIds for <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudformation-customresource.html#aws-resource-cloudformation-customresource--remarks">judging</a> whether to replace the custom resource are duplicated, no error occurs.</p>




<div class="img_container"><a href="/article/468/images/physical_resource_id.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/468/images/physical_resource_id_hu2b6b79deacbcd855b6e20476b3cb61b3_653015_600x370_fit_lanczos_3.png" width="592" height="370" alt="Duplicated physical resource ids">
</a></div>


<p>After that, if you change the timeout etc., the output is still the same, but
if you change the parameters field <a href="https://github.com/aws/aws-cdk/blob/v2.124.0/packages/aws-cdk-lib/custom-resources/lib/aws-custom-resource/aws-custom-resource.ts#L490">passed</a> to the lambda function, sts.getCallerIndentity in onUpdate will be called and getResponseField() in Output will fail due to the field not existing. Besides, if you remove onUpdate and deploy again, the same error will occur.</p>
<p>The <a href="https://github.com/aws/aws-cdk/blob/v2.124.0/packages/aws-cdk-lib/custom-resources/lib/aws-custom-resource/aws-custom-resource.ts#L484">default value</a> of onCreate is onUpdate, so if you call an API that doesn&rsquo;t create resources like Describe, I understand that you can pass only onUpdate, and if it creates resources, you should also pass onDelete for cleanup.</p>

    </div>
  </article>
</div>

</div>
</body>

</html>