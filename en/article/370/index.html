<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 30px;
        height: 30px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .share-button > img {
        border: none;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .share {
        position: relative;
        text-align: right;
        margin-top: 5px;
    }

    .share .cell {
        display: inline-block;
        text-align: center;
        margin-bottom: 5px;
    }

    .share-button {
        display: inline-block;
        margin: 0 5px;
    }

    @media screen and (min-width: 1400px) {
        .share .cell {
            position: absolute;
            bottom: 0;
            margin-left: 5px;
        }

        .share-button {
            display: inline-block;
            margin: 5px 0;
        }
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Athena (Presto) and Glue (Spark) can return different values when running the same query - sambaiz-net</title>
  <meta name="twitter:title" content="Athena (Presto) and Glue (Spark) can return different values when running the same query - sambaiz-net">
  <meta property='og:title' content="Athena (Presto) and Glue (Spark) can return different values when running the same query - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="Differences in number types, behavior when decimals are casted to integers, and array indexes">
  <meta name="twitter:description" content="Differences in number types, behavior when decimals are casted to integers, and array indexes">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/370/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/370/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/370/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/370/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Athena (Presto) and Glue (Spark) can return different values when running the same query",
    "datePublished": "2021-07-03T23:13:00JST",
    "dateModified": "2021-07-03T23:13:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "Differences in number types, behavior when decimals are casted to integers, and array indexes"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/370/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.goodreads.com/sambaiz">
            <img src="/image/goodreads.svg" width="30px" height="30px" alt="goodreads">
          </a>
        </div>
        <div class="sns-item">
          <a href="https://filmarks.com/users/sambaiz" class="filmarks" aria-label="filmarks"></a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/log/">
            log</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/docker/">
            docker</a>
          
          <a class="tag" href="/tags/infra/">
            infra</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Athena (Presto) and Glue (Spark) can return different values when running the same query</h1>
        <time>2021-07-03</time>
        <a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/presto/'>presto</a><a class="tag" href='/en/tags/spark/'>spark</a>
      </div>
      <p>AWS has multiple managed services that aggregate with SQL-like queries.
If queries are executed ad-hoc, Presto-based Athena, which can quickly and easily query to tables in Glue&rsquo;s data catalog, is handy, while if heavy queries are executed in batch, Spark-based Glue, which can avoid resource and time limitation, can be better. Therefore, they can be used properly depending on the case.</p>
<p><a href="https://www.sambaiz.net/en/article/392/">Redshift Serverless and other serverless aggregation services, run query with Glue Data Catalog - sambaiz-net</a></p>
<p>Presto that <a href="https://prestodb.io/docs/current/overview/concepts.html#statement">executes ANSI-compatible SQL</a> and Spark that <a href="https://spark.apache.org/docs/latest/sql-ref-ansi-compliance.html">executes Hive-compatible Spark SQL</a> by default have different syntaxes partially, but sometimes the same query can be reused. In that case, the same result would be expected to be returned, but it may vary significantly due to the following differences in behavior.</p>
<h2 id="number-types">Number types</h2>
<p>In <a href="https://prestodb.io/docs/current/language/types.html#decimal">Presto 0.198</a> and later, decimal literals are treated as DECIMAL by default, but in Athena engine version 2 (Presto 0.217), it becomes <strong>DOUBLE</strong>. Perhaps parse-decimal-literals-as-double is being passed for compatibility with engine version 1 (Presto 0.172).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#ff79c6">SELECT</span> typeof(<span style="color:#bd93f9">1</span>.<span style="color:#bd93f9">2</span>), <span style="color:#6272a4">/* double */</span>
       <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">/</span> <span style="color:#bd93f9">3</span>.<span style="color:#bd93f9">0</span> <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">10000000</span> <span style="color:#6272a4">/* 3333333.333333333 */</span>
</code></pre></div><p>Similarly, in <a href="https://spark.apache.org/docs/2.3.1/sql-programming-guide.html#upgrading-from-spark-sql-22-to-23">Spark 2.3</a> and later, decimal literal are treated as <strong>DECIMAL</strong>, and so is <a href="https://docs.aws.amazon.com/glue/latest/dg/release-notes.html">Glue 2.0</a> (Spark 2.4.3). DECIMAL scale (number of digits after the decimal point) is limited to a maximum of 6.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">print</span>(spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;&#34;&#34;SELECT 1.2&#34;&#34;&#34;</span>)<span style="color:#ff79c6">.</span>dtypes) 
<span style="color:#6272a4"># [(&#39;1.2&#39;, &#39;decimal(2,1)&#39;)]</span>
<span style="color:#ff79c6">print</span>(spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;&#34;&#34;SELECT 1 / 3.0 * 10000000&#34;&#34;&#34;</span>)<span style="color:#ff79c6">.</span>collect())
<span style="color:#6272a4"># [Row((CAST((CAST(CAST(1 AS DECIMAL(1,0)) AS DECIMAL(2,1)) / CAST(3.0 AS DECIMAL(2,1))) AS DECIMAL(14,6)) * CAST(CAST(10000000 AS DECIMAL(8,0)) AS DECIMAL(14,6)))=Decimal(&#39;3333330.000000&#39;))]</span>
</code></pre></div><p>In Presto, if interger is divided by an integer, it will be truncated without being cast, but in Spark, it will be cast to DOUBLE. Also, if integer is divided by a decimal literal, it will be DOUBLE for Presto and DECIMAL for Spark, so the accuracy will be different.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#ff79c6">SELECT</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">/</span> <span style="color:#bd93f9">3</span>, <span style="color:#6272a4">/* 0 */</span>
       <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">/</span> <span style="color:#bd93f9">3</span>.<span style="color:#bd93f9">0</span> <span style="color:#6272a4">/* 0.3333333333333333 */</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">print</span>(spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;SELECT 1 / 3&#34;</span>)<span style="color:#ff79c6">.</span>collect())
<span style="color:#6272a4">#[Row((CAST(1 AS DOUBLE) / CAST(3 AS DOUBLE))=0.3333333333333333)]   </span>
<span style="color:#ff79c6">print</span>(spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;SELECT 1 / 3.0&#34;</span>)<span style="color:#ff79c6">.</span>collect())
<span style="color:#6272a4"># [Row((CAST(CAST(1 AS DECIMAL(1,0)) AS DECIMAL(2,1)) / CAST(3.0 AS DECIMAL(2,1)))=Decimal(&#39;0.333333&#39;))]</span>
<span style="color:#ff79c6">print</span>(spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;SELECT 1D / 3.0&#34;</span>)<span style="color:#ff79c6">.</span>collect())
<span style="color:#6272a4"># [Row((1.0 / CAST(3.0 AS DOUBLE))=0.3333333333333333)] </span>
</code></pre></div><h2 id="cast-to-integer">cast to integer</h2>
<p>In Athena, decimal are casted to integer with <strong>round</strong>, while in Glue, with <strong>floor</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">CAST</span>(<span style="color:#bd93f9">1</span>.<span style="color:#bd93f9">49</span> <span style="color:#ff79c6">AS</span> <span style="color:#8be9fd;font-style:italic">INTEGER</span>), <span style="color:#6272a4">/* 1 */</span>
       <span style="color:#ff79c6">CAST</span>(<span style="color:#bd93f9">1</span>.<span style="color:#bd93f9">50</span> <span style="color:#ff79c6">AS</span> <span style="color:#8be9fd;font-style:italic">INTEGER</span>)  <span style="color:#6272a4">/* 2 */</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">print</span>(spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;&#34;&#34;SELECT CAST(1.49 AS INTEGER)&#34;&#34;&#34;</span>)<span style="color:#ff79c6">.</span>collect()[<span style="color:#bd93f9">0</span>][<span style="color:#bd93f9">0</span>])
<span style="color:#6272a4"># 1</span>
<span style="color:#ff79c6">print</span>(spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;&#34;&#34;SELECT CAST(1.50 AS INTEGER)&#34;&#34;&#34;</span>)<span style="color:#ff79c6">.</span>collect()[<span style="color:#bd93f9">0</span>][<span style="color:#bd93f9">0</span>])
<span style="color:#6272a4"># 1</span>
</code></pre></div><h2 id="array-indexes">Array indexes</h2>
<p>Athena&rsquo;s indexes are 1-based, while Spark is 0-based.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#ff79c6">SELECT</span> split(<span style="color:#f1fa8c">&#39;aaa,bbb,ccc,ddd&#39;</span>, <span style="color:#f1fa8c">&#39;,&#39;</span>)[<span style="color:#bd93f9">1</span>] <span style="color:#6272a4">/* aaa */</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">print</span>(spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;SELECT split(&#39;aaa,bbb,ccc,ddd&#39;, &#39;,&#39;)[1] as v&#34;</span>)<span style="color:#ff79c6">.</span>collect()[<span style="color:#bd93f9">0</span>][<span style="color:#f1fa8c">&#39;v&#39;</span>]) 
<span style="color:#6272a4"># bbb</span>
</code></pre></div>
    </div>
    <div class="share">
      <div class="cell">
        <div>share</div>
        <div>
          <a class="share-button" href='https://twitter.com/intent/tweet?url=https://www.sambaiz.net/en/article/370/&text=Athena%20%28Presto%29%20and%20Glue%20%28Spark%29%20can%20return%20different%20values%20when%20running%20the%20same%20query%20-%20sambaiz-net'>
            <img src="/image/twitter.png" width="40px" height="40px" alt="twitter">
          </a>
          <a href="https://b.hatena.ne.jp/entry/" class="share-button hatena-bookmark-button" data-hatena-bookmark-layout="touch" data-hatena-bookmark-width="40" data-hatena-bookmark-height="40" title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="40" height="40" style="border: none;" />
          </a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
        </div>
      </div>
    </div>
  </article>
</div>

</div>
</body>

</html>