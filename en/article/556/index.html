<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Apply Row and Column Level Access Control on Glue Data Catalog Tables with Lake Formation in CDK - sambaiz-net</title>
  <meta name="twitter:title" content="Apply Row and Column Level Access Control on Glue Data Catalog Tables with Lake Formation in CDK - sambaiz-net">
  <meta property='og:title' content="Apply Row and Column Level Access Control on Glue Data Catalog Tables with Lake Formation in CDK - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="When attempting to create PrincipalPermissions to SELECT through a DataCellsFilter, the stack update failed because the DataCellsFilter had not stabilized. Adding a retry via CustomResource resolved the issue.">
  <meta name="twitter:description" content="When attempting to create PrincipalPermissions to SELECT through a DataCellsFilter, the stack update failed because the DataCellsFilter had not stabilized. Adding a retry via CustomResource resolved the issue.">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/556/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/556/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/556/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/556/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Apply Row and Column Level Access Control on Glue Data Catalog Tables with Lake Formation in CDK",
    "datePublished": "2026-01-02T23:43:00JST",
    "dateModified": "2026-01-02T23:43:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "When attempting to create PrincipalPermissions to SELECT through a DataCellsFilter, the stack update failed because the DataCellsFilter had not stabilized. Adding a retry via CustomResource resolved the issue."
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/556/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="/places/">
            <img src="/image/pin.svg" width="32px" height="32px" alt="places">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Apply Row and Column Level Access Control on Glue Data Catalog Tables with Lake Formation in CDK</h1>
        <time>2026-01-02</time>
        <a class="tag" href='/en/tags/database/'>database</a><a class="tag" href='/en/tags/aws/'>aws</a>
      </div>
      <p><a href="https://docs.aws.amazon.com/lake-formation/latest/dg/what-is-lake-formation.html">Lake Formation</a> is a service that provides RDBMS-like permission model access control for Glue Data Catalog metadata and S3 data. It <a href="https://docs.aws.amazon.com/lake-formation/latest/dg/how-it-works.html">handles</a> transparent permission checks when returning metadata to engines, and issues temporary credentials for S3 access. Since the objects themselves can still be retrieved, row and column level filtering is the <a href="https://docs.aws.amazon.com/lake-formation/latest/dg/limitations.html">engine&rsquo;s responsibility</a>. Care should be taken when accessing from non-AWS managed environments like EMR.</p>
<p>Set up the data lake location to be governed by Lake Formation and create a service role.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">new</span> lakeformation.CfnResource(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;DataLakeLocation&#39;</span>, {
</span></span><span style="display:flex;"><span>  resourceArn<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">`arn:aws:s3:::</span><span style="color:#f1fa8c">${</span>dataBucket.bucketName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/employee_db/`</span>,
</span></span><span style="display:flex;"><span>  useServiceLinkedRole: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> lakeFormationServiceRole <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> iam.Role(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;LakeFormationServiceRole&#39;</span>, {
</span></span><span style="display:flex;"><span>  assumedBy: <span style="color:#8be9fd">new</span> iam.ServicePrincipal(<span style="color:#f1fa8c">&#39;lakeformation.amazonaws.com&#39;</span>),
</span></span><span style="display:flex;"><span>  managedPolicies<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>    iam.ManagedPolicy.fromAwsManagedPolicyName(<span style="color:#f1fa8c">&#39;AWSLakeFormationDataAdmin&#39;</span>),
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dataBucket.grantReadWrite(lakeFormationServiceRole);
</span></span></code></pre></div><p>Make this role a Lake Formation Admin. Note that even IAM AdministratorAccess cannot perform any operations, including DESCRIBE, without Lake Formation permissions. With the following settings, newly created tables will have no PrincipalPermissions by default, making them inaccessible via IAM policies alone. However, for tables in databases created before this setting, the IAMAllowedPrincipals group (which includes all users and roles with IAM policies) is <a href="https://docs.aws.amazon.com/lake-formation/latest/dg/lf-permissions-reference.html">granted</a> Super permissions. You need to uncheck &ldquo;Use only IAM access control ~&rdquo; and Revoke these permissions for Lake Formation access control to take effect.</p>




<div class="img_container"><a href="/article/556/images/prev_database.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/556/images/prev_database_hu_a38c60f0325b4259.png" width="600" height="164" alt="Database with Use only IAM access control for new tables in this database enabled">
</a></div>


<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> synthesizer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.synthesizer <span style="color:#ff79c6">as</span> cdk.DefaultStackSynthesizer;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> cdkExecRoleArn <span style="color:#ff79c6">=</span> cdk.Fn.sub(synthesizer.cloudFormationExecutionRoleArn);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> dataLakeSettings <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> lakeformation.CfnDataLakeSettings(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;DataLakeSettings&#39;</span>, {
</span></span><span style="display:flex;"><span>  admins<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>    { dataLakePrincipalIdentifier: <span style="color:#8be9fd">lakeFormationServiceRole.roleArn</span> },
</span></span><span style="display:flex;"><span>    { dataLakePrincipalIdentifier: <span style="color:#8be9fd">grantPermissionsFunction.role</span><span style="color:#ff79c6">!</span>.roleArn },
</span></span><span style="display:flex;"><span>    { dataLakePrincipalIdentifier: <span style="color:#8be9fd">cdkExecRoleArn</span> },
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  createDatabaseDefaultPermissions<span style="color:#ff79c6">:</span> [],
</span></span><span style="display:flex;"><span>  createTableDefaultPermissions<span style="color:#ff79c6">:</span> [],
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>database.addDependency(dataLakeSettings);
</span></span></code></pre></div><p>Create a DataCellsFilter that specifies rows and columns for the table.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> salesFilter <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> lakeformation.CfnDataCellsFilter(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;SalesFilter&#39;</span>, {
</span></span><span style="display:flex;"><span>  tableCatalogId: <span style="color:#8be9fd">this.account</span>,
</span></span><span style="display:flex;"><span>  databaseName: <span style="color:#8be9fd">database.ref</span>,
</span></span><span style="display:flex;"><span>  tableName: <span style="color:#8be9fd">table.ref</span>,
</span></span><span style="display:flex;"><span>  name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;sales_department_filter&#39;</span>,
</span></span><span style="display:flex;"><span>  rowFilter<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    filterExpression<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;department = &#39;営業部&#39;&#34;</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  columnNames<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;employee_id&#39;</span>, <span style="color:#f1fa8c">&#39;name&#39;</span>, <span style="color:#f1fa8c">&#39;department&#39;</span>, <span style="color:#f1fa8c">&#39;position&#39;</span>, <span style="color:#f1fa8c">&#39;hire_date&#39;</span>],
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>salesFilter.addDependency(table);
</span></span></code></pre></div><p>When attempting to create PrincipalPermissions to SELECT through this DataCellsFilter, the stack update failed because the DataCellsFilter had not stabilized. Adding a retry via CustomResource resolved the issue.</p>
<p><a href="https://www.sambaiz.net/en/article/468/">Call AWS API with AwsCustomResource in CDK - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#6272a4">// ../lambda/grant-lf-permissions/index.ts
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> { LakeFormation } <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#39;@aws-sdk/client-lakeformation&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> lakeformation <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LakeFormation({});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">interface</span> ResourceProperties {
</span></span><span style="display:flex;"><span>  RoleArn: <span style="color:#8be9fd">string</span>;
</span></span><span style="display:flex;"><span>  CatalogId: <span style="color:#8be9fd">string</span>;
</span></span><span style="display:flex;"><span>  DatabaseName: <span style="color:#8be9fd">string</span>;
</span></span><span style="display:flex;"><span>  TableName: <span style="color:#8be9fd">string</span>;
</span></span><span style="display:flex;"><span>  FilterName: <span style="color:#8be9fd">string</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">const</span> handler <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">async</span> (event: <span style="color:#8be9fd">any</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">any</span>&gt; <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>  console.log(<span style="color:#f1fa8c">&#39;Event:&#39;</span>, JSON.stringify(event, <span style="color:#ff79c6">null</span>, <span style="color:#bd93f9">2</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> props <span style="color:#ff79c6">=</span> event.ResourceProperties <span style="color:#ff79c6">as</span> ResourceProperties;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> { RoleArn, CatalogId, DatabaseName, TableName, FilterName } <span style="color:#ff79c6">=</span> props;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> resource <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>    DataCellsFilter<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      TableCatalogId: <span style="color:#8be9fd">CatalogId</span>,
</span></span><span style="display:flex;"><span>      DatabaseName: <span style="color:#8be9fd">DatabaseName</span>,
</span></span><span style="display:flex;"><span>      TableName: <span style="color:#8be9fd">TableName</span>,
</span></span><span style="display:flex;"><span>      Name: <span style="color:#8be9fd">FilterName</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (event.RequestType <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;Delete&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">await</span> lakeformation.revokePermissions({
</span></span><span style="display:flex;"><span>      Principal<span style="color:#ff79c6">:</span> { DataLakePrincipalIdentifier: <span style="color:#8be9fd">RoleArn</span> },
</span></span><span style="display:flex;"><span>      Resource: <span style="color:#8be9fd">resource</span>,
</span></span><span style="display:flex;"><span>      Permissions<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;SELECT&#39;</span>],
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> {
</span></span><span style="display:flex;"><span>      PhysicalResourceId: <span style="color:#8be9fd">event.PhysicalResourceId</span> <span style="color:#ff79c6">||</span> <span style="color:#f1fa8c">&#39;SalesPermissions&#39;</span>,
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// Create or Update
</span></span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">await</span> sleep(<span style="color:#bd93f9">30000</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">await</span> lakeformation.grantPermissions({
</span></span><span style="display:flex;"><span>    Principal<span style="color:#ff79c6">:</span> { DataLakePrincipalIdentifier: <span style="color:#8be9fd">RoleArn</span> },
</span></span><span style="display:flex;"><span>    Resource: <span style="color:#8be9fd">resource</span>,
</span></span><span style="display:flex;"><span>    Permissions<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;SELECT&#39;</span>],
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  console.log(<span style="color:#f1fa8c">&#39;Successfully granted permissions&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> {
</span></span><span style="display:flex;"><span>    PhysicalResourceId<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;SalesPermissions&#39;</span>,
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> sleep(ms: <span style="color:#8be9fd">number</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">void</span>&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Promise(resolve <span style="color:#ff79c6">=&gt;</span> setTimeout(resolve, ms));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Associate the DataCellsFilter sales_department_filter with salesRole.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> grantPermissionsFunction <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NodejsFunction(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;GrantPermissionsFunction&#39;</span>, {
</span></span><span style="display:flex;"><span>  entry: <span style="color:#8be9fd">path.join</span>(__dirname, <span style="color:#f1fa8c">&#39;../lambda/grant-lf-permissions/index.ts&#39;</span>),
</span></span><span style="display:flex;"><span>  handler<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;handler&#39;</span>,
</span></span><span style="display:flex;"><span>  runtime: <span style="color:#8be9fd">lambda.Runtime.NODEJS_22_X</span>,
</span></span><span style="display:flex;"><span>  timeout: <span style="color:#8be9fd">cdk.Duration.minutes</span>(<span style="color:#bd93f9">2</span>),
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>grantPermissionsFunction.addToRolePolicy(<span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>  actions<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;lakeformation:GrantPermissions&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;lakeformation:RevokePermissions&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;glue:GetDatabase&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;glue:GetTable&#39;</span>,
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  resources<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;*&#39;</span>],
</span></span><span style="display:flex;"><span>}));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> salesPermissionsProvider <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> customResources.Provider(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;SalesPermissionsProvider&#39;</span>, {
</span></span><span style="display:flex;"><span>  onEventHandler: <span style="color:#8be9fd">grantPermissionsFunction</span>,
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> salesPermissions <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> cdk.CustomResource(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;SalesPermissions&#39;</span>, {
</span></span><span style="display:flex;"><span>  serviceToken: <span style="color:#8be9fd">salesPermissionsProvider.serviceToken</span>,
</span></span><span style="display:flex;"><span>  properties<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    RoleArn: <span style="color:#8be9fd">salesRole.roleArn</span>,
</span></span><span style="display:flex;"><span>    CatalogId: <span style="color:#8be9fd">this.account</span>,
</span></span><span style="display:flex;"><span>    DatabaseName: <span style="color:#8be9fd">database.ref</span>,
</span></span><span style="display:flex;"><span>    TableName: <span style="color:#8be9fd">table.ref</span>,
</span></span><span style="display:flex;"><span>    FilterName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;sales_department_filter&#39;</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>salesPermissions.node.addDependency(salesFilter);
</span></span></code></pre></div><p>Direct permission grants to databases or tables without going through DataCellsFilter could be done with CfnPrincipalPermissions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">new</span> lakeformation.CfnPrincipalPermissions(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;SalesDatabasePermissions&#39;</span>, {
</span></span><span style="display:flex;"><span>  principal<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    dataLakePrincipalIdentifier: <span style="color:#8be9fd">salesRole.roleArn</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  resource<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    database<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      catalogId: <span style="color:#8be9fd">this.account</span>,
</span></span><span style="display:flex;"><span>      name: <span style="color:#8be9fd">database.ref</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  permissions<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;DESCRIBE&#39;</span>],
</span></span><span style="display:flex;"><span>  permissionsWithGrantOption<span style="color:#ff79c6">:</span> [],
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>When querying with salesRole, you can confirm that rows and columns are filtered in the results.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">QUERY</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;SELECT * FROM employee_db.employees&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">QUERY_ID</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>aws athena start-query-execution <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --query-string <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$QUERY</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --profile admin <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --query QueryExecutionId <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --output text<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>  sleep <span style="color:#bd93f9">5</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>  aws athena get-query-results <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --query-execution-id <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$QUERY_ID</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --profile admin <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --query <span style="color:#f1fa8c">&#34;ResultSet.Rows[*].Data[*].VarCharValue&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --output table
</span></span><span style="display:flex;"><span>+-------------+-------------+-------------+-----------+----------+-------------------------+--------------+
</span></span><span style="display:flex;"><span>|  employee_id|  name       |  department |  position |  salary  |  email                  |  hire_date   |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1001</span>       |  山田太郎   |  営業部     |  部長     |  <span style="color:#bd93f9">8000000</span> |  yamada@example.com     |  2015-04-01  |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1002</span>       |  佐藤花子   |  営業部     |  課長     |  <span style="color:#bd93f9">6500000</span> |  sato@example.com       |  2017-06-15  |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1003</span>       |  鈴木一郎   |  営業部     |  主任     |  <span style="color:#bd93f9">5500000</span> |  suzuki@example.com     |  2019-08-20  |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1004</span>       |  田中美咲   |  営業部     |  一般     |  <span style="color:#bd93f9">4500000</span> |  tanaka@example.com     |  2021-04-01  |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1005</span>       |  高橋健太   |  営業部     |  一般     |  <span style="color:#bd93f9">4200000</span> |  takahashi@example.com  |  2022-03-15  |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1006</span>       |  伊藤由美   |  人事部     |  部長     |  <span style="color:#bd93f9">7800000</span> |  ito@example.com        |  2016-05-10  |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1007</span>       |  渡辺直樹   |  人事部     |  課長     |  <span style="color:#bd93f9">6200000</span> |  watanabe@example.com   |  2018-07-01  |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1008</span>       |  中村恵     |  人事部     |  主任     |  <span style="color:#bd93f9">5300000</span> |  nakamura@example.com   |  2020-03-15  |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1009</span>       |  小林雅人   |  人事部     |  一般     |  <span style="color:#bd93f9">4700000</span> |  kobayashi@example.com  |  2021-09-01  |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1010</span>       |  加藤さくら |  人事部     |  一般     |  <span style="color:#bd93f9">4500000</span> |  kato@example.com       |  2022-06-01  |
</span></span><span style="display:flex;"><span>+-------------+-------------+-------------+-----------+----------+-------------------------+--------------+
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">QUERY_ID</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>aws athena start-query-execution <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --query-string <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$QUERY</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --profile sales <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --query QueryExecutionId <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --output text<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>  sleep <span style="color:#bd93f9">5</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>  aws athena get-query-results <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --query-execution-id <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$QUERY_ID</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --profile sales <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --query <span style="color:#f1fa8c">&#34;ResultSet.Rows[*].Data[*].VarCharValue&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    --output table
</span></span><span style="display:flex;"><span>---------------------------------------------------------------------
</span></span><span style="display:flex;"><span>|                          GetQueryResults                          |
</span></span><span style="display:flex;"><span>+-------------+-----------+-------------+------------+--------------+
</span></span><span style="display:flex;"><span>|  employee_id|  name     |  department |  position  |  hire_date   |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1001</span>       |  山田太郎 |  営業部     |  部長      |  2015-04-01  |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1002</span>       |  佐藤花子 |  営業部     |  課長      |  2017-06-15  |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1003</span>       |  鈴木一郎 |  営業部     |  主任      |  2019-08-20  |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1004</span>       |  田中美咲 |  営業部     |  一般      |  2021-04-01  |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1005</span>       |  高橋健太 |  営業部     |  一般      |  2022-03-15  |
</span></span><span style="display:flex;"><span>+-------------+-----------+-------------+------------+--------------+
</span></span></code></pre></div>
    </div>
  </article>
</div>

</div>
</body>

</html>