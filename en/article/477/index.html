<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Adjusting GC frequency in Go with GOGC and GOMEMLIMIT and checking the behavior with trace - sambaiz-net</title>
  <meta name="twitter:title" content="Adjusting GC frequency in Go with GOGC and GOMEMLIMIT and checking the behavior with trace - sambaiz-net">
  <meta property='og:title' content="Adjusting GC frequency in Go with GOGC and GOMEMLIMIT and checking the behavior with trace - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="According to A Guide to the Go Garbage Collector, GC in Go is performed with a way called mark-sweep, which marks objects that are referenced by root objects such as global and local variables recursively, and sweeps not marked ones. The cost increases as the heap size, but since it targets not only newly allocated memory but also existing memory with a long lifetime, reducing the frequency can reduce the load on the CPU.">
  <meta name="twitter:description" content="According to A Guide to the Go Garbage Collector, GC in Go is performed with a way called mark-sweep, which marks objects that are referenced by root objects such as global and local variables recursively, and sweeps not marked ones. The cost increases as the heap size, but since it targets not only newly allocated memory but also existing memory with a long lifetime, reducing the frequency can reduce the load on the CPU.">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/477/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/477/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/477/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/477/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Adjusting GC frequency in Go with GOGC and GOMEMLIMIT and checking the behavior with trace",
    "datePublished": "2024-04-06T20:45:00JST",
    "dateModified": "2024-04-06T20:45:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "According to A Guide to the Go Garbage Collector, GC in Go is performed with a way called mark-sweep, which marks objects that are referenced by root objects such as global and local variables recursively, and sweeps not marked ones. The cost increases as the heap size, but since it targets not only newly allocated memory but also existing memory with a long lifetime, reducing the frequency can reduce the load on the CPU."
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/477/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Adjusting GC frequency in Go with GOGC and GOMEMLIMIT and checking the behavior with trace</h1>
        <time>2024-04-06</time>
        <a class="tag" href='/en/tags/golang/'>golang</a>
      </div>
      <p>According to <a href="https://go.dev/doc/gc-guide">A Guide to the Go Garbage Collector</a>, GC in Go is performed with a way called mark-sweep, which marks objects that are referenced by root objects such as global and local variables recursively, and sweeps not marked ones. The <a href="https://go.dev/doc/gc-guide#Understanding_costs">cost</a> increases as the heap size, but since it targets not only newly allocated memory but also existing memory with a long lifetime, reducing the frequency can reduce the load on the CPU.</p>
<p>You can adjust the frequency with <a href="https://go.dev/doc/gc-guide#GOGC">GOGC</a>. GC runs when the heap size exceeds a threshold calculated by the following formula. The <a href="https://github.com/golang/go/blob/go1.22.2/src/runtime/mgcpacer.go#L1285">default value is 100</a>, so the threshold is roughly twice the Live heap, which is the heap size after the last GC, and increasing it will reduce the frequency of GC.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Target heap memory = Live heap + (Live heap + GC roots) * GOGC / 100
</span></span></code></pre></div><p>Another parameter, <a href="https://go.dev/doc/gc-guide#Memory_limit">GOMEMLIMIT</a>, added in Go 1.19, also works as a GC threshold. By setting a value based on the amount of available memory, you can increase the frequency of GC when memory is about to run out, but this is just a soft limit.
Besides, to prevent processing from slowing down due to GC, at most 50% CPU can be used.</p>
<p>Run <a href="https://pkg.go.dev/cmd/trace">go tool trace</a> to confirm that these values actually changes the GC frequency.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">var</span> heapValues []<span style="color:#ff79c6">*</span><span style="color:#8be9fd">int64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ticker <span style="color:#ff79c6">:=</span> time.<span style="color:#50fa7b">Tick</span>(<span style="color:#bd93f9">50</span> <span style="color:#ff79c6">*</span> time.Nanosecond)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&lt;-</span>ticker
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(heapValues) &gt; <span style="color:#bd93f9">1000</span> {
</span></span><span style="display:flex;"><span>			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#8be9fd;font-style:italic">len</span>(heapValues))
</span></span><span style="display:flex;"><span>			heapValues = heapValues[<span style="color:#bd93f9">1000</span>:]
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		heapValues = <span style="color:#8be9fd;font-style:italic">append</span>(heapValues, <span style="color:#8be9fd;font-style:italic">new</span>(<span style="color:#8be9fd">int64</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Make sure values are stored on the heap.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go build -gcflags <span style="color:#f1fa8c">&#39;-m&#39;</span>
</span></span><span style="display:flex;"><span>./main.go:11:21: inlining call to time.Tick
</span></span><span style="display:flex;"><span>./main.go:15:15: inlining call to fmt.Println
</span></span><span style="display:flex;"><span>./main.go:15:15: ... argument does not escape
</span></span><span style="display:flex;"><span>./main.go:15:19: len<span style="color:#ff79c6">(</span>heapValues<span style="color:#ff79c6">)</span> escapes to heap
</span></span><span style="display:flex;"><span>./main.go:18:38: new<span style="color:#ff79c6">(</span>int64<span style="color:#ff79c6">)</span> escapes to heap
</span></span></code></pre></div><p>Output and parse the trace file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cat main_test.go
</span></span><span style="display:flex;"><span>package main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import <span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func TestMain<span style="color:#ff79c6">(</span>t *testing.T<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>	go main<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>	time.Sleep<span style="color:#ff79c6">(</span><span style="color:#bd93f9">10</span> * time.Second<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ go <span style="color:#8be9fd;font-style:italic">test</span> -trace trace.out .
</span></span><span style="display:flex;"><span>$ go tool trace trace.out
</span></span></code></pre></div><p>Once completed, a browser will open and you can check the visualized trace.</p>




<div class="img_container"><a href="/article/477/images/visualized_trace.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/477/images/visualized_trace_hu9647000227481902651.png" width="600" height="234" alt="visualized trace">
</a></div>


<p>Allocated, which is represented by the orange part of Heap, increases, NextGC decreases everyabout 340ms, GC runs, Allocated decreases, and NextGC recovers.</p>
<p>Setting GOGC=50, the interval became about 130ms.</p>




<div class="img_container"><a href="/article/477/images/gogc.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/477/images/gogc_hu18001884212780605658.png" width="600" height="84" alt="GOGC=50">
</a></div>


<p>Additionally, setting GOMEMLIMIT=10MiB, GC ran in every about 40ms.</p>




<div class="img_container"><a href="/article/477/images/gogc.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/477/images/gogc_hu18001884212780605658.png" width="600" height="84" alt="GOMEMLIMIT=10MiB">
</a></div>



    </div>
  </article>
</div>

</div>
</body>

</html>