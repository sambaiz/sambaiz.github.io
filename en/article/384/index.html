<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 30px;
        height: 30px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .share-button > img {
        border: none;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .share {
        position: relative;
        text-align: right;
        margin-top: 5px;
    }

    .share .cell {
        display: inline-block;
        text-align: center;
        margin-bottom: 5px;
    }

    .share-button {
        display: inline-block;
        margin: 0 5px;
    }

    @media screen and (min-width: 1400px) {
        .share .cell {
            position: absolute;
            bottom: 0;
            margin-left: 5px;
        }

        .share-button {
            display: inline-block;
            margin: 5px 0;
        }
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Treat Spark struct as map to expand to multiple rows with explode - sambaiz-net</title>
  <meta name="twitter:title" content="Treat Spark struct as map to expand to multiple rows with explode - sambaiz-net">
  <meta property='og:title' content="Treat Spark struct as map to expand to multiple rows with explode - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="Read data with explicit schema or convert by Row.asDict() in UDF">
  <meta name="twitter:description" content="Read data with explicit schema or convert by Row.asDict() in UDF">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/384/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/384/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/384/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/384/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Treat Spark struct as map to expand to multiple rows with explode",
    "datePublished": "2021-10-13T02:30:00JST",
    "dateModified": "2021-10-13T02:30:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "Read data with explicit schema or convert by Row.asDict() in UDF"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/384/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.goodreads.com/sambaiz">
            <img src="/image/goodreads.svg" width="30px" height="30px" alt="goodreads">
          </a>
        </div>
        <div class="sns-item">
          <a href="https://filmarks.com/users/sambaiz" class="filmarks" aria-label="filmarks"></a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/ios/">
            ios</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Treat Spark struct as map to expand to multiple rows with explode</h1>
        <time>2021-10-13</time>
        <a class="tag" href='/en/tags/spark/'>spark</a><a class="tag" href='/en/tags/python/'>python</a><a class="tag" href='/en/tags/etl/'>etl</a>
      </div>
      <p>When you <a href="https://spark.apache.org/docs/3.1.1/api/python/reference/api/pyspark.sql.DataFrameReader.json.html">read data</a> without specifying schema in Spark, the schema is automatically determined from the input as follows.</p>
<p><a href="https://www.sambaiz.net/en/article/415/">Why can Athena v2 fail to query map columns in parquet source tables - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#6272a4"># {&#34;aaa&#34;:123,&#34;ccc&#34;:[123],&#34;eee&#34;:{&#34;fff&#34;:123},&#34;hhh&#34;:null}</span>
</span></span><span style="display:flex;"><span>df <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>read<span style="color:#ff79c6">.</span>json(<span style="color:#f1fa8c">&#34;s3://hogefuga/testjson/&#34;</span>)
</span></span><span style="display:flex;"><span>df<span style="color:#ff79c6">.</span>printSchema()
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">root
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> |-- aaa: long (nullable = true)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> |-- ccc: array (nullable = true)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> |    |-- element: long (containsNull = true)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> |-- eee: struct (nullable = true)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> |    |-- fff: long (nullable = true)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> |-- hhh: string (nullable = true)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span></code></pre></div><p>This works well in most cases, but if the field that assumes map is determined as struct, or if the field is determined as string as it contains only null, processings may fail by mismatch of function inputs.
<a href="https://spark.apache.org/docs/3.1.1/api/sql/index.html#explode">explode()</a> is a function that expands array and map into multiple rows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>df<span style="color:#ff79c6">.</span>createOrReplaceTempView(<span style="color:#f1fa8c">&#34;tbl&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;SELECT v FROM tbl LATERAL VIEW explode(ccc) as v&#34;</span>)<span style="color:#ff79c6">.</span>head()) <span style="color:#6272a4"># Row(v=123)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;SELECT k, v FROM tbl LATERAL VIEW explode(eee) as k, v&#34;</span>)<span style="color:#ff79c6">.</span>head()) 
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># cannot resolve &#39;explode(tbl.`eee`)&#39; due to data type mismatch: input to function explode should be array or map type, not struct&lt;fff:bigint&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;SELECT v FROM tbl LATERAL VIEW explode(CAST(eee AS map&lt;string,long&gt;)) as v&#34;</span>)<span style="color:#ff79c6">.</span>head()) 
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># cannot resolve &#39;tbl.`eee`&#39; due to data type mismatch: cannot cast struct&lt;fff:bigint&gt; to map&lt;string,bigint&gt;</span>
</span></span></code></pre></div><p>You can explicitly pass the schema to the DataFrameReader.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> pyspark.sql.types <span style="color:#ff79c6">import</span> StructType, StructField, LongType, ArrayType, MapType, StringType, LongType
</span></span><span style="display:flex;"><span>schema <span style="color:#ff79c6">=</span> StructType([
</span></span><span style="display:flex;"><span>    StructField(<span style="color:#f1fa8c">&#34;aaa&#34;</span>, LongType()),
</span></span><span style="display:flex;"><span>    StructField(<span style="color:#f1fa8c">&#34;ccc&#34;</span>, ArrayType(LongType())),
</span></span><span style="display:flex;"><span>    StructField(<span style="color:#f1fa8c">&#34;eee&#34;</span>, MapType(StringType(), LongType())),
</span></span><span style="display:flex;"><span>    StructField(<span style="color:#f1fa8c">&#34;hhh&#34;</span>, LongType()),
</span></span><span style="display:flex;"><span>])
</span></span><span style="display:flex;"><span>df2 <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>read<span style="color:#ff79c6">.</span>schema(schema)<span style="color:#ff79c6">.</span>json(<span style="color:#f1fa8c">&#34;s3://hogefuga/testjson/&#34;</span>)
</span></span><span style="display:flex;"><span>df2<span style="color:#ff79c6">.</span>printSchema()
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">root
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> |-- aaa: long (nullable = true)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> |-- ccc: array (nullable = true)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> |    |-- element: long (containsNull = true)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> |-- eee: map (nullable = true)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> |    |-- key: string
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> |    |-- value: long (valueContainsNull = true)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> |-- hhh: long (nullable = true)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df2<span style="color:#ff79c6">.</span>createOrReplaceTempView(<span style="color:#f1fa8c">&#34;tbl2&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;SELECT k, v FROM tbl2 LATERAL VIEW explode(eee) as k, v&#34;</span>)<span style="color:#ff79c6">.</span>head()) <span style="color:#6272a4"># Row(k=&#39;fff&#39;, v=123)</span>
</span></span></code></pre></div><p>But if you call <a href="https://spark.apache.org/docs/3.1.1/api/python/reference/api/pyspark.sql.SparkSession.createDataFrame.html">createDataFrame()</a> with explicit schema and the existing rdd, the conversion to map fails like cast().</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span>createDataFrame(spark<span style="color:#ff79c6">.</span>read<span style="color:#ff79c6">.</span>json(<span style="color:#f1fa8c">&#34;s3://hogefuga/testjson/&#34;</span>)<span style="color:#ff79c6">.</span>rdd, schema)
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># TypeError: field eee: MapType(StringType,LongType,true) can not accept object Row(fff=123) in type &lt;class &#39;pyspark.sql.types.Row&#39;&gt;</span>
</span></span></code></pre></div><p>If the data structure is large and it is troublesome to specify all schemas, there is also a way of converting by <a href="https://spark.apache.org/docs/3.1.1/api/python/reference/api/pyspark.sql.Row.asDict.html">Row.asDict()</a> in <a href="https://spark.apache.org/docs/3.1.1/sql-ref-functions-udf-scalar.html">UDF (User Defined Function)</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> pyspark.sql <span style="color:#ff79c6">import</span> functions <span style="color:#ff79c6">as</span> F
</span></span><span style="display:flex;"><span>struct_to_string_long_map <span style="color:#ff79c6">=</span> F<span style="color:#ff79c6">.</span>udf(<span style="color:#ff79c6">lambda</span> row: row<span style="color:#ff79c6">.</span>asDict()), MapType(StringType(), LongType()))
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span>udf<span style="color:#ff79c6">.</span>register(<span style="color:#f1fa8c">&#34;struct_to_string_long_map&#34;</span>, struct_to_string_long_map)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;SELECT k, v FROM tbl LATERAL VIEW explode(struct_to_string_long_map(eee)) as k, v&#34;</span>)<span style="color:#ff79c6">.</span>head()) <span style="color:#6272a4"># Row(k=&#39;fff&#39;, v=123)</span>
</span></span></code></pre></div><h2 id="references">References</h2>
<p><a href="http://tech-blog.tsukaby.com/archives/1333">Spark DataFrameのschemaにまつわる罠とschemaの補正 | つかびーの技術日記</a></p>
<p><a href="https://blog.amedama.jp/entry/2018/01/31/210755">PySpark の UDF (User Defined Function) を試す - CUBE SUGAR CONTAINER</a></p>

    </div>
    <div class="share">
      <div class="cell">
        <div>share</div>
        <div>
          <a class="share-button" href='https://twitter.com/intent/tweet?url=https://www.sambaiz.net/en/article/384/&text=Treat%20Spark%20struct%20as%20map%20to%20expand%20to%20multiple%20rows%20with%20explode%20-%20sambaiz-net'>
            <img src="/image/twitter.png" width="40px" height="40px" alt="twitter">
          </a>
          <a href="https://b.hatena.ne.jp/entry/" class="share-button hatena-bookmark-button" data-hatena-bookmark-layout="touch" data-hatena-bookmark-width="40" data-hatena-bookmark-height="40" title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="40" height="40" style="border: none;" />
          </a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
        </div>
      </div>
    </div>
  </article>
</div>

</div>
</body>

</html>