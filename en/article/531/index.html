<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Create BigQuery Tables for Apache Iceberg using dbt and Read them from Snowflake - sambaiz-net</title>
  <meta name="twitter:title" content="Create BigQuery Tables for Apache Iceberg using dbt and Read them from Snowflake - sambaiz-net">
  <meta property='og:title' content="Create BigQuery Tables for Apache Iceberg using dbt and Read them from Snowflake - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="When reading data stored in BigQuery from Snowflake, direct access is not possible, so it&#39;s necessary to either reload it into Snowflake tables or export it to GCS. However, regarding the former approach, there are concerns about data and schema discrepancy due to losing the single source of truth, and in either case, when using both BigQuery and Snowflake, storage costs are doubled. For the latter approach, instead of storing data in BigQuery storage, it&#39;s possible to operate it as an external table, but this requires an external engine like Spark for writing data.">
  <meta name="twitter:description" content="When reading data stored in BigQuery from Snowflake, direct access is not possible, so it&#39;s necessary to either reload it into Snowflake tables or export it to GCS. However, regarding the former approach, there are concerns about data and schema discrepancy due to losing the single source of truth, and in either case, when using both BigQuery and Snowflake, storage costs are doubled. For the latter approach, instead of storing data in BigQuery storage, it&#39;s possible to operate it as an external table, but this requires an external engine like Spark for writing data.">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/531/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/531/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/531/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/531/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Create BigQuery Tables for Apache Iceberg using dbt and Read them from Snowflake",
    "datePublished": "2025-04-20T23:55:00JST",
    "dateModified": "2025-04-20T23:55:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "When reading data stored in BigQuery from Snowflake, direct access is not possible, so it's necessary to either reload it into Snowflake tables or export it to GCS. However, regarding the former approach, there are concerns about data and schema discrepancy due to losing the single source of truth, and in either case, when using both BigQuery and Snowflake, storage costs are doubled. For the latter approach, instead of storing data in BigQuery storage, it's possible to operate it as an external table, but this requires an external engine like Spark for writing data."
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/531/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="/places/">
            <img src="/image/pin.svg" width="32px" height="32px" alt="places">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Create BigQuery Tables for Apache Iceberg using dbt and Read them from Snowflake</h1>
        <time>2025-04-20</time>
        <a class="tag" href='/en/tags/snowflake/'>snowflake</a><a class="tag" href='/en/tags/gcp/'>gcp</a><a class="tag" href='/en/tags/terraform/'>terraform</a><a class="tag" href='/en/tags/iceberg/'>iceberg</a>
      </div>
      <p>When reading data stored in BigQuery from Snowflake, direct access is not possible, so it&rsquo;s necessary to either reload it into Snowflake tables or export it to GCS. However, regarding the former approach, there are concerns about data and schema discrepancy due to losing the single source of truth, and in either case, when using both BigQuery and Snowflake, storage costs are doubled. For the latter approach, instead of storing data in BigQuery storage, it&rsquo;s possible to operate it as an external table, but this requires an external engine like Spark for writing data.</p>
<p><a href="https://www.sambaiz.net/en/article/523/">Walk through Iceberg metadata contents by creating tables, modifying schema and write mode, and writing data in Spark - sambaiz-net</a></p>
<p><a href="https://cloud.google.com/bigquery/docs/iceberg-tables">BigQuery tables for Apache Iceberg</a> are Iceberg tables that can be read from and written to using BigQuery. This means you can write to them using the BigQuery adapter for dbt with CREATE TABLE AS statements, just like regular tables.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">TABLE</span> <span style="color:#ff79c6">`</span>PROJECT_ID<span style="color:#ff79c6">`</span>.DATASET_NAME.ICEBERG_TABLE_NAME(
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WITH</span> <span style="color:#ff79c6">CONNECTION</span> <span style="color:#ff79c6">`</span>(project_id).us.<span style="color:#ff79c6">****`</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">OPTIONS</span> (
</span></span><span style="display:flex;"><span>file_format <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;PARQUET&#39;</span>,
</span></span><span style="display:flex;"><span>table_format <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;ICEBERG&#39;</span>,
</span></span><span style="display:flex;"><span>storage_uri <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;gs://****&#39;</span>);
</span></span></code></pre></div><p>You need to grant objectCreator permissions to the connection&rsquo;s ServiceAccount.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-terraform" data-lang="terraform"><span style="display:flex;"><span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;google_bigquery_connection&#34;</span> <span style="color:#f1fa8c">&#34;iceberg_table&#34;</span> {
</span></span><span style="display:flex;"><span>  project       <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;(project_id)&#34;</span>
</span></span><span style="display:flex;"><span>  connection_id <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;iceberg_table&#34;</span>
</span></span><span style="display:flex;"><span>  location      <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;US&#34;</span>
</span></span><span style="display:flex;"><span>  cloud_resource {}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;google_storage_bucket_iam_member&#34;</span> <span style="color:#f1fa8c">&#34;iceberg_connection_gcs_creator&#34;</span> {
</span></span><span style="display:flex;"><span>  bucket <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;(bucket_name)&#34;</span>
</span></span><span style="display:flex;"><span>  role   <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;roles/storage.objectCreator&#34;</span>
</span></span><span style="display:flex;"><span>  member <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;serviceAccount:</span><span style="color:#f1fa8c">${</span>google_bigquery_connection.iceberg_table.cloud_resource[<span style="color:#bd93f9">0</span>].service_account_id<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>However, since this is still in preview, the dbt <a href="https://github.com/dbt-labs/dbt-bigquery/pull/1416">PR</a> hasn&rsquo;t been merged yet and we cannot pass Iceberg-specific parameters when creating tables. Therefore, I overwrote the <a href="https://github.com/dbt-labs/dbt-bigquery/blob/v1.9.1/dbt/include/bigquery/macros/relations/table/options.sql">bigquery_table_options</a> macro to pass these parameters. The reason I didn&rsquo;t overwrite <a href="https://github.com/dbt-labs/dbt-bigquery/blob/v1.9.1/dbt/include/bigquery/macros/relations/options.sql">bigquery_options</a> is to avoid failures when creating _tmp tables during incremental merges by specifying a different directory when temporary = True. Besides, since only clustering is supported and not partitioning, insert_overwrite is not possible.</p>
<p><a href="https://www.sambaiz.net/en/article/509/">Creating new tables in BigQuery by processing data with SQL using dbt - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>{<span style="color:#ff79c6">%</span> macro bigquery_table_options(config, node, <span style="color:#ff79c6">temporary</span>) <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%</span> <span style="color:#ff79c6">set</span> opts <span style="color:#ff79c6">=</span> adapter.get_table_options(config, node, <span style="color:#ff79c6">temporary</span>) <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%-</span> <span style="color:#ff79c6">if</span> config.<span style="color:#ff79c6">get</span>(<span style="color:#f1fa8c">&#39;table_format&#39;</span>) <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;iceberg&#39;</span> <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>    {<span style="color:#ff79c6">%-</span> <span style="color:#ff79c6">set</span> direcotry <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;iceberg/&#39;</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> <span style="color:#ff79c6">temporary</span> <span style="color:#ff79c6">else</span> <span style="color:#f1fa8c">&#39;iceberg_tmp/&#39;</span> <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>    {<span style="color:#ff79c6">%-</span> <span style="color:#ff79c6">do</span> opts.<span style="color:#ff79c6">update</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#39;file_format&#39;</span>: <span style="color:#f1fa8c">&#34;&#39;parquet&#39;&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#39;table_format&#39;</span>: <span style="color:#f1fa8c">&#34;&#39;iceberg&#39;&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#39;storage_uri&#39;</span>: <span style="color:#f1fa8c">&#34;&#39;gs://(bucket_name)/&#34;</span> <span style="color:#ff79c6">~</span> direcotry <span style="color:#ff79c6">~</span> model.<span style="color:#ff79c6">schema</span> <span style="color:#ff79c6">~</span> <span style="color:#f1fa8c">&#34;/&#34;</span> <span style="color:#ff79c6">~</span> model.name <span style="color:#ff79c6">~</span> <span style="color:#f1fa8c">&#34;&#39;&#34;</span>
</span></span><span style="display:flex;"><span>    }) <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%-</span> endif <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%</span> <span style="color:#ff79c6">set</span> <span style="color:#ff79c6">connection</span> <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>    {<span style="color:#ff79c6">%-</span> <span style="color:#ff79c6">if</span> config.<span style="color:#ff79c6">get</span>(<span style="color:#f1fa8c">&#39;table_format&#39;</span>) <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;iceberg&#39;</span> <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">WITH</span> <span style="color:#ff79c6">CONNECTION</span> <span style="color:#ff79c6">`</span>{{ target.project }}.us.iceberg_table<span style="color:#ff79c6">`</span>
</span></span><span style="display:flex;"><span>    {<span style="color:#ff79c6">%-</span> endif <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%-</span> endset <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%-</span> <span style="color:#ff79c6">do</span> <span style="color:#ff79c6">return</span>(<span style="color:#ff79c6">connection</span> <span style="color:#ff79c6">~</span> <span style="color:#f1fa8c">&#34;\n&#34;</span> <span style="color:#ff79c6">~</span> bigquery_options(opts)) <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>{<span style="color:#ff79c6">%-</span> endmacro <span style="color:#ff79c6">-%</span>}
</span></span></code></pre></div><p>Now we can create Iceberg tables. However, the initial v0.metadata.json doesn&rsquo;t contain format-version and other required fields, which causes errors when creating ICEBERG TABLE in Snowflake, so we need to <a href="https://cloud.google.com/bigquery/docs/iceberg-tables?hl=ja#create-iceberg-table-snapshots">EXPORT TABLE METADATA</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>{{ config(
</span></span><span style="display:flex;"><span>    materialized<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;incremental&#39;</span>,
</span></span><span style="display:flex;"><span>    table_format<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;iceberg&#39;</span>,
</span></span><span style="display:flex;"><span>    storage_uri<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;gs://*****&#39;</span>,
</span></span><span style="display:flex;"><span>    post_hook<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;EXPORT TABLE METADATA FROM {{ this }}&#34;</span>,
</span></span><span style="display:flex;"><span>) }}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">select</span> ...
</span></span></code></pre></div><p>Then create an <a href="https://docs.snowflake.com/en/user-guide/tables-iceberg-configure-external-volume-gcs">EXTERNAL VOLUME</a> and <a href="https://docs.snowflake.com/en/user-guide/tables-iceberg-configure-catalog-integration-object-storage">CATALOG INTEGRATION</a> for GCS in Snowflake, grant the ServiceAccount the required <a href="https://docs.snowflake.com/en/user-guide/tables-iceberg-configure-external-volume-gcs#create-a-custom-iam-role">permissions</a>, and create an ICEBERG TABLE to read the data. Note that storage.buckets.get permission is required, so objectCreator permission alone is not sufficient.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">EXTERNAL</span> VOLUME GCS_EXTERNAL_VOLUME
</span></span><span style="display:flex;"><span>  STORAGE_LOCATIONS <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>    (
</span></span><span style="display:flex;"><span>      (
</span></span><span style="display:flex;"><span>        NAME <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;asia-northeast1&#39;</span>
</span></span><span style="display:flex;"><span>        STORAGE_PROVIDER <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;GCS&#39;</span>
</span></span><span style="display:flex;"><span>        STORAGE_BASE_URL <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;gcs://******/&#39;</span>
</span></span><span style="display:flex;"><span>      )
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">DESC</span> <span style="color:#ff79c6">EXTERNAL</span> VOLUME GCS_EXTERNAL_VOLUME;
</span></span><span style="display:flex;"><span><span style="color:#6272a4">-- {&#34;STORAGE_GCP_SERVICE_ACCOUNT&#34;:&#34;****.iam.gserviceaccount.com&#34;,...}
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">SYSTEM</span>$VERIFY_EXTERNAL_VOLUME(<span style="color:#f1fa8c">&#39;GCS_EXTERNAL_VOLUME&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#6272a4">-- {&#34;success&#34;:true,...}
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">CATALOG</span> INTEGRATION OBJECT_STORE_CATALOG_INTEGRATION
</span></span><span style="display:flex;"><span>  CATALOG_SOURCE <span style="color:#ff79c6">=</span> OBJECT_STORE
</span></span><span style="display:flex;"><span>  TABLE_FORMAT <span style="color:#ff79c6">=</span> ICEBERG
</span></span><span style="display:flex;"><span>  ENABLED <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">TRUE</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> ICEBERG <span style="color:#ff79c6">TABLE</span> test
</span></span><span style="display:flex;"><span>   EXTERNAL_VOLUME <span style="color:#ff79c6">=</span> GCS_EXTERNAL_VOLUME
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">CATALOG</span> <span style="color:#ff79c6">=</span> OBJECT_STORE_CATALOG_INTEGRATION
</span></span><span style="display:flex;"><span>   METADATA_FILE_PATH <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;****/metadata/v****.metadata.json&#39;</span>;
</span></span></code></pre></div><p>However, unlike with Glue, AUTO REFRESH does not occur because the metadata file path needs to be specified.</p>
<p><a href="https://www.sambaiz.net/en/article/525/">Register Iceberg Tables in Glue Data Catalog to query from Athena and Snowflake - sambaiz-net</a></p>
<p>You can retrieve the latest metadata file as shown below, and keep it up to date by ALTER TABLE REFRESH. This can also be <a href="https://medium.com/snowflake/eliminating-redundancies-in-etl-with-iceberg-tables-on-snowflake-cff678d49bd3">done from a PROCEDURE</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">STORAGE</span> INTEGRATION GCS_DATA_INTEGRATION
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">TYPE</span> <span style="color:#ff79c6">=</span> EXTERNAL_STAGE
</span></span><span style="display:flex;"><span>  STORAGE_PROVIDER <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;GCS&#39;</span>
</span></span><span style="display:flex;"><span>  ENABLED <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">TRUE</span>
</span></span><span style="display:flex;"><span>  STORAGE_ALLOWED_LOCATIONS <span style="color:#ff79c6">=</span> (<span style="color:#f1fa8c">&#39;gcs://******/&#39;</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> STAGE GCS_DATA_STAGE
</span></span><span style="display:flex;"><span>  STORAGE_INTEGRATION <span style="color:#ff79c6">=</span> GCS_DATA_INTEGRATION
</span></span><span style="display:flex;"><span>  URL <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;gcs://******/&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> METADATA$FILENAME <span style="color:#ff79c6">AS</span> FILE_PATH
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> <span style="color:#ff79c6">@</span>GCS_DATA_STAGE
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WHERE</span> METADATA$FILENAME <span style="color:#ff79c6">LIKE</span> <span style="color:#f1fa8c">&#39;%metadata.json&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> METADATA$FILE_LAST_MODIFIED <span style="color:#ff79c6">DESC</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">LIMIT</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">ALTER</span> ICEBERG <span style="color:#ff79c6">TABLE</span> test REFRESH <span style="color:#f1fa8c">&#39;*****.metadata.json&#39;</span>;
</span></span></code></pre></div>
    </div>
  </article>
</div>

</div>
</body>

</html>