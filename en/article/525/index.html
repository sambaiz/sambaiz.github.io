<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Register Iceberg Tables in Glue Data Catalog to query from Athena and Snowflake - sambaiz-net</title>
  <meta name="twitter:title" content="Register Iceberg Tables in Glue Data Catalog to query from Athena and Snowflake - sambaiz-net">
  <meta property='og:title' content="Register Iceberg Tables in Glue Data Catalog to query from Athena and Snowflake - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="If you register Iceberg tables in the Glue Data Catalog, you can not only reference them from Athena and EMR etc. like other tables, but you can also create an ICEBERG TABLE in Snowflake without specifying the schema, avoiding duplicate metadata management. It even has a feature for automatic compaction">
  <meta name="twitter:description" content="If you register Iceberg tables in the Glue Data Catalog, you can not only reference them from Athena and EMR etc. like other tables, but you can also create an ICEBERG TABLE in Snowflake without specifying the schema, avoiding duplicate metadata management. It even has a feature for automatic compaction">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/525/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/525/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/525/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/525/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Register Iceberg Tables in Glue Data Catalog to query from Athena and Snowflake",
    "datePublished": "2025-01-30T20:31:00JST",
    "dateModified": "2025-01-30T20:31:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "If you register Iceberg tables in the Glue Data Catalog, you can not only reference them from Athena and EMR etc. like other tables, but you can also create an ICEBERG TABLE in Snowflake without specifying the schema, avoiding duplicate metadata management. It even has a feature for automatic compaction"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/525/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Register Iceberg Tables in Glue Data Catalog to query from Athena and Snowflake</h1>
        <time>2025-01-30</time>
        <a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/iceberg/'>iceberg</a><a class="tag" href='/en/tags/spark/'>spark</a><a class="tag" href='/en/tags/snowflake/'>snowflake</a>
      </div>
      <p>If you register Iceberg tables in the Glue Data Catalog, you can not only reference them from Athena and EMR etc. like other tables, but you can also create an <a href="https://docs.snowflake.com/en/user-guide/tables-iceberg">ICEBERG TABLE</a> in Snowflake without specifying the schema, avoiding duplicate metadata management. It even has a feature for automatic <a href="https://docs.aws.amazon.com/glue/latest/dg/enable-compaction.html">compaction</a> and <a href="https://docs.aws.amazon.com/glue/latest/dg/enable-orphan-file-deletion.html">deleting orphan files</a> that are created when a job fails and not referenced from metadata.</p>
<p><a href="https://www.sambaiz.net/en/article/523/">Walk through Iceberg metadata contents by creating tables, modifying schema and write mode, and writing data in Spark - sambaiz-net</a></p>
<p>This article I create tables and other resources using Athena for Spark. When you select Iceberg as the table format, settings like catalog-impl are <a href="https://docs.aws.amazon.com/athena/latest/ug/notebooks-spark-table-formats-apache-iceberg.html">configured</a>. <a href="https://iceberg.apache.org/docs/latest/spark-configuration/#sql-extensions">IcebergSparkSessionExtensions</a> is a module to CALL <a href="https://iceberg.apache.org/docs/1.5.1/spark-procedures/">procedures</a> from SQL.</p>




<div class="img_container"><a href="/article/525/images/athena_for_spark.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/525/images/athena_for_spark_hu_8d0e2c4e54eadf91.png" width="500" height="370" alt="select Iceberg as the table format">
</a></div>


<p>By the way, when I <a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/tutorial-iceberg.html">ran it on EMR on EKS</a>, I got ClassNotFoundException: org.apache.iceberg.spark.SparkCatalog even though Iceberg is <a href="https://docs.aws.amazon.com/emr/latest/ReleaseGuide/Iceberg-release-history.html">available</a> with the version, emr-7.0.0, I could confirm that it works with the latest version.</p>
<p><a href="https://www.sambaiz.net/en/article/434/">Launch an EKS cluster and register it to EMR on EKS with CDK to run Spark jobs - sambaiz-net</a></p>
<p>Creating or updating databases and Iceberg tables from Spark, it is reflected in the Glue Data Catalog as well. You need glue and S3 policies.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;CREATE DATABASE iceberg_test LOCATION &#39;s3://*****/iceberg_test&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;CREATE TABLE iceberg_test.test_table (id bigint, data string) USING iceberg&#34;</span>)
</span></span></code></pre></div><p>Besides, you can also register Iceberg tables in the Glue Data Catalog in CDK (CloudFormation) by creating an EXTERNAL_TABLE with openTableFormatInput.icebergInput, but there are issues where it is <a href="https://github.com/aws-cloudformation/cloudformation-coverage-roadmap/issues/1919">broken</a> as an Iceberg table when you update the schema, and it also <a href="https://github.com/aws-cloudformation/cloudformation-coverage-roadmap/issues/1866">doesn&rsquo;t support</a> partitioning, so it&rsquo;s not very practical at the moment.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> database <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> glue.CfnDatabase(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#34;Database&#34;</span>, {
</span></span><span style="display:flex;"><span>  catalogId: <span style="color:#8be9fd">this.account</span>,
</span></span><span style="display:flex;"><span>  databaseInput<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    name: <span style="color:#8be9fd">databaseName</span>,
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">new</span> glue.CfnTable(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#34;Table&#34;</span>, {
</span></span><span style="display:flex;"><span>  databaseName: <span style="color:#8be9fd">databaseName</span>,
</span></span><span style="display:flex;"><span>  catalogId: <span style="color:#8be9fd">this.account</span>,
</span></span><span style="display:flex;"><span>  tableInput<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;test_table&#34;</span>,
</span></span><span style="display:flex;"><span>      storageDescriptor<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>          columns<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>            { name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;id&#34;</span>, <span style="color:#ff79c6">type</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;int&#34;</span> },
</span></span><span style="display:flex;"><span>            { name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;data&#34;</span>, <span style="color:#ff79c6">type</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;string&#34;</span> },
</span></span><span style="display:flex;"><span>          ],
</span></span><span style="display:flex;"><span>          location<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">`s3://*****/iceberg_test`</span>,
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      tableType<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;EXTERNAL_TABLE&#39;</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  openTableFormatInput<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      icebergInput<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>          metadataOperation<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;CREATE&#34;</span>,
</span></span><span style="display:flex;"><span>          version<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;2&#34;</span>,
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>metadata_location written and updated as the a table property is referred for optimistic locking, which detects concurrent updates to the table and <a href="https://github.com/apache/iceberg/blob/980212e7000f7a62439e8876cc555a5066147df6/aws/src/main/java/org/apache/iceberg/aws/glue/GlueTableOperations.java#L271">fails</a> the commits. Previously, DynamoLockManager <a href="https://iceberg.apache.org/docs/latest/aws/#optimistic-locking">was used</a>.</p>




<div class="img_container"><a href="/article/525/images/catalog_table.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/525/images/catalog_table_hu_f40923a2176cd680.png" width="600" height="339" alt="reflected in the Glue Data Catalog">
</a></div>


<p>By the way, if you set write.spark.accept-any-schema = true in TBLPROPERTIES and write with .option(&ldquo;mergeSchema&rdquo;,&ldquo;true&rdquo;), <a href="https://iceberg.apache.org/docs/1.5.0/spark-writes/#schema-merge">Schema Merge</a> will be performed and columns will be added according to the data, and in this case too, it will be reflected in the catalog.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">CREATE TABLE iceberg_test.test_table
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">USING ICEBERG
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">TBLPROPERTIES (&#39;write.spark.accept-any-schema&#39;=&#39;true&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df<span style="color:#ff79c6">.</span>writeTo(<span style="color:#f1fa8c">&#34;iceberg_test.test_table&#34;</span>) \
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">.</span>option(<span style="color:#f1fa8c">&#34;mergeSchema&#34;</span>, <span style="color:#f1fa8c">&#34;true&#34;</span>) \
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">.</span>append()
</span></span></code></pre></div><p>By this, you can CREATE TABLE without schema, but the columns haven&rsquo;t existed yet, so you have to ADD PARTITION FIELD later.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;ALTER TABLE iceberg_test.test_table2 ADD PARTITION FIELD aaa&#34;</span>)
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;ALTER TABLE iceberg_test.test_table2 ADD PARTITION FIELD bbb&#34;</span>)
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;DESCRIBE TABLE iceberg_test.test_table2&#34;</span>)
</span></span></code></pre></div><p>When trying to add new columns in the middle, you&rsquo;ll get an error indicating that the columns are not in order. You can bypass this <a href="https://github.com/apache/iceberg/blob/apache-iceberg-1.7.2/api/src/main/java/org/apache/iceberg/types/CheckCompatibility.java#L141">check</a> by setting spark.sql.iceberg.check-ordering = false. This check is designed to prevent writing data to incorrect positions when the input data and table definition orders differ. However, in the <a href="https://github.com/apache/iceberg/pull/745">PR</a> that added this setting, it was also modified to take field positions from the input data schema rather than the table, so I think it is no problem to set it to false and actually I did it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Exception in thread &#34;main&#34; java.lang.IllegalArgumentException: Cannot write incompatible dataset to table with schema:
</span></span><span style="display:flex;"><span>table {
</span></span><span style="display:flex;"><span>  1: id: optional string
</span></span><span style="display:flex;"><span>  2: age: optional int
</span></span><span style="display:flex;"><span>  3: name: optional string
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>Provided schema:
</span></span><span style="display:flex;"><span>table {
</span></span><span style="display:flex;"><span>  1: id: optional string
</span></span><span style="display:flex;"><span>  3: name: optional string
</span></span><span style="display:flex;"><span>  2: age: optional int
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>Problems:
</span></span><span style="display:flex;"><span>* name is out of order, before age
</span></span><span style="display:flex;"><span>	at org.apache.iceberg.types.TypeUtil.checkSchemaCompatibility(TypeUtil.java:489)
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Inserting the data,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>createDataFrame([
</span></span><span style="display:flex;"><span>    (<span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">&#34;aaaa&#34;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#bd93f9">2</span>, <span style="color:#f1fa8c">&#34;bbbb&#34;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#bd93f9">3</span>, <span style="color:#f1fa8c">&#34;cccc&#34;</span>)
</span></span><span style="display:flex;"><span>], [<span style="color:#f1fa8c">&#34;id&#34;</span>, <span style="color:#f1fa8c">&#34;data&#34;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df<span style="color:#ff79c6">.</span>writeTo(<span style="color:#f1fa8c">&#34;iceberg_test.test_table&#34;</span>)<span style="color:#ff79c6">.</span>append()
</span></span></code></pre></div><p>check that we can access the table from Athena.</p>




<div class="img_container"><a href="/article/525/images/athena_query.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/525/images/athena_query_hu_de9b7f60d403e014.png" width="591" height="370" alt="access the table from Athena">
</a></div>


<p>In Snowflake, create an <a href="https://docs.snowflake.com/en/user-guide/tables-iceberg#external-volume">EXTERNAL VOLUME</a> for S3 and a <a href="https://docs.snowflake.com/en/user-guide/tables-iceberg#catalog-integration">CATALOG INTEGRATION</a> for Glue, then pass them to the ICEBERG TABLE. Similar to STORAGE INTEGRATION, you need to obtain and configure the access user and External ID for the role.</p>
<p><a href="https://www.sambaiz.net/en/article/518/">Copy and Query S3 Data in Snowflake - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">OR</span> <span style="color:#ff79c6">REPLACE</span> <span style="color:#ff79c6">EXTERNAL</span> VOLUME ICEBERG_EXTERNAL_VOLUME
</span></span><span style="display:flex;"><span>   STORAGE_LOCATIONS <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>      (
</span></span><span style="display:flex;"><span>         (
</span></span><span style="display:flex;"><span>            NAME <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;iceberg_test&#39;</span>
</span></span><span style="display:flex;"><span>            STORAGE_PROVIDER <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;S3&#39;</span>
</span></span><span style="display:flex;"><span>            STORAGE_BASE_URL <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;s3://*****/iceberg_test/&#39;</span>
</span></span><span style="display:flex;"><span>            STORAGE_AWS_ROLE_ARN <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;arn:aws:iam::*****:role/*****&#39;</span>
</span></span><span style="display:flex;"><span>         )
</span></span><span style="display:flex;"><span>      );
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">DESC</span> <span style="color:#ff79c6">EXTERNAL</span> VOLUME ICEBERG_EXTERNAL_VOLUME;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">CATALOG</span> INTEGRATION GLUE_CATALOG_INTEGRATION
</span></span><span style="display:flex;"><span>  CATALOG_SOURCE <span style="color:#ff79c6">=</span> GLUE
</span></span><span style="display:flex;"><span>  CATALOG_NAMESPACE <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;iceberg_test&#39;</span>
</span></span><span style="display:flex;"><span>  TABLE_FORMAT <span style="color:#ff79c6">=</span> ICEBERG
</span></span><span style="display:flex;"><span>  GLUE_AWS_ROLE_ARN <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;arn:aws:iam::*****:role/*****&#39;</span>
</span></span><span style="display:flex;"><span>  GLUE_CATALOG_ID <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;(aws account id)&#39;</span>
</span></span><span style="display:flex;"><span>  GLUE_REGION <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;ap-northeast-1&#39;</span>
</span></span><span style="display:flex;"><span>  ENABLED <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">TRUE</span>
</span></span><span style="display:flex;"><span>  REFRESH_INTERVAL_SECONDS <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">60</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">DESC</span> <span style="color:#ff79c6">CATALOG</span> INTEGRATION GLUE_CATALOG_INTEGRATION;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">DATABASE</span> TESTDB;
</span></span><span style="display:flex;"><span>USE TESTDB;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">SCHEMA</span> TEST_SCHEMA;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> ICEBERG <span style="color:#ff79c6">TABLE</span> TEST_SCHEMA.TEST_TABLE
</span></span><span style="display:flex;"><span>  EXTERNAL_VOLUME <span style="color:#ff79c6">=</span> ICEBERG_EXTERNAL_VOLUME
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">CATALOG</span> <span style="color:#ff79c6">=</span> GLUE_CATALOG_INTEGRATION
</span></span><span style="display:flex;"><span>  CATALOG_TABLE_NAME <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;test_table&#39;</span>
</span></span><span style="display:flex;"><span>  CATALOG_NAMESPACE <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;iceberg_test&#39;</span>
</span></span><span style="display:flex;"><span>  AUTO_REFRESH <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">TRUE</span>;
</span></span></code></pre></div><p>Terraform only has a <a href="https://registry.terraform.io/providers/Snowflake-Labs/snowflake/latest/docs/resources/external_volume">snowflake_external_volume</a> for preview now, and other resources are <a href="https://github.com/Snowflake-Labs/terraform-provider-snowflake/issues/2249">not yet available</a>.</p>
<p><a href="https://www.sambaiz.net/en/article/524/">Running Terraform and Querying from Snowflake CLI and gosnowflake with Key Pair Authentication - sambaiz-net</a></p>
<p>Now you can access it from Snowflake as well.</p>




<div class="img_container"><a href="/article/525/images/snowflake_query.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/525/images/snowflake_query_hu_b322e1ccc83f9064.png" width="600" height="365" alt="Check if Snowflake can access data">
</a></div>


<p>If you can&rsquo;t get the latest data, check whether AUTO_REFRESH is disabled or failed, or whether <a href="https://docs.snowflake.com/en/user-guide/querying-persisted-results">caching</a> is enabled.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">SYSTEM</span>$AUTO_REFRESH_STATUS(TEST_TABLE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">ALTER</span> <span style="color:#ff79c6">SESSION</span> <span style="color:#ff79c6">SET</span> USE_CACHED_RESULT<span style="color:#ff79c6">=</span><span style="color:#ff79c6">FALSE</span>;
</span></span></code></pre></div><p>By the way, you can convert tables to reference <a href="https://docs.snowflake.com/en/user-guide/tables-iceberg#catalog-options">Snowflake&rsquo;s catalog</a> instead of external catalogs like Glue. By this, it can be used as a source for <a href="https://docs.snowflake.com/en/user-guide/dynamic-tables-create-iceberg">DYNAMIC ICEBERG TABLE</a> which updates data through <a href="https://docs.snowflake.com/en/user-guide/dynamic-tables-about">periodic query execution</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">ALTER</span> ICEBERG <span style="color:#ff79c6">TABLE</span> TEST_TABLE <span style="color:#ff79c6">CONVERT</span> <span style="color:#ff79c6">TO</span> MANAGED
</span></span><span style="display:flex;"><span>  BASE_LOCATION <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;snowflake/test_table&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">DYNAMIC</span> ICEBERG <span style="color:#ff79c6">TABLE</span> TEST_TABLE_ID (id <span style="color:#8be9fd;font-style:italic">bigint</span>)
</span></span><span style="display:flex;"><span>  TARGET_LAG <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;20 minutes&#39;</span>
</span></span><span style="display:flex;"><span>  WAREHOUSE <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">***</span>
</span></span><span style="display:flex;"><span>  EXTERNAL_VOLUME <span style="color:#ff79c6">=</span> ICEBERG_EXTERNAL_VOLUME
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">CATALOG</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;SNOWFLAKE&#39;</span>
</span></span><span style="display:flex;"><span>  BASE_LOCATION <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;snowflake/test_table_id&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">AS</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">SELECT</span> id <span style="color:#ff79c6">FROM</span> test_table;
</span></span></code></pre></div><p>After conversion, the table is written to the external volume&rsquo;s (STORAGE_BASE_URL)/BASE_LOCATION and Snowflake will perform maintenance operations like compaction. This means it becomes a different table thereafter, so to keep up with the Glue table, you need to periodically REPLACE and CONVERT the table.</p>
<h2 id="reference">Reference</h2>
<p><a href="https://qiita.com/yota-p/items/e5fdcb6924cb5945d9d7">AWS上でIcebergテーブルを作成する方法についての検討メモ #iceberg - Qiita</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>