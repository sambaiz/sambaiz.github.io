<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }

    .single ol {
        list-style-type: decimal;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Install ExternalDNS to an EKS cluster with CDK, and register Service or Ingress host to Route53 - sambaiz-net</title>
  <meta name="twitter:title" content="Install ExternalDNS to an EKS cluster with CDK, and register Service or Ingress host to Route53 - sambaiz-net">
  <meta property='og:title' content="Install ExternalDNS to an EKS cluster with CDK, and register Service or Ingress host to Route53 - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="an application that synchronizes Service or Ingress host with external DNS records">
  <meta name="twitter:description" content="an application that synchronizes Service or Ingress host with external DNS records">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/475/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/475/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/475/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/475/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Install ExternalDNS to an EKS cluster with CDK, and register Service or Ingress host to Route53",
    "datePublished": "2024-03-20T15:01:00JST",
    "dateModified": "2024-03-20T15:01:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "an application that synchronizes Service or Ingress host with external DNS records"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/475/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="/places/">
            <img src="/image/pin.svg" width="32px" height="32px" alt="places">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/linux/">
            linux</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Install ExternalDNS to an EKS cluster with CDK, and register Service or Ingress host to Route53</h1>
        <time>2024-03-20</time>
        <a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/kubernetes/'>kubernetes</a>
      </div>
      <p><a href="https://github.com/kubernetes-sigs/external-dns">ExternalDNS</a> is an application that synchronizes Service or Ingress host with external DNS records. Route53 records can also be created using CDK, but it is hard to handle ELBs that are created asynchronously after cluster.addManifest() and are managed by controllers.</p>
<p>First, let&rsquo;s create a <a href="https://github.com/kubernetes-sigs/external-dns/blob/v0.14.0/docs/tutorials/aws.md#iam-policy">Role</a> to edit records.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-tsx" data-lang="tsx"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> externalDNSRole <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> iam.Role(scope, <span style="color:#f1fa8c">&#39;ExternalDNSRole&#39;</span>, {
</span></span><span style="display:flex;"><span>  roleName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">`ExternalDNSRole-</span><span style="color:#f1fa8c">${</span>cluster.clusterName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>,
</span></span><span style="display:flex;"><span>  assumedBy: <span style="color:#8be9fd">new</span> iam.WebIdentityPrincipal(
</span></span><span style="display:flex;"><span>    cluster.openIdConnectProvider.openIdConnectProviderArn,
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;StringEquals&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">new</span> cdk.CfnJson(scope, <span style="color:#f1fa8c">&#39;ExternalDNSRoleStringEquals&#39;</span>, { value<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>        [<span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>cluster.clusterOpenIdConnectIssuer<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:aud`</span>]<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;sts.amazonaws.com&#39;</span>,
</span></span><span style="display:flex;"><span>        [<span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>cluster.clusterOpenIdConnectIssuer<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:sub`</span>]<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;system:serviceaccount:external-dns:external-dns-sa&#39;</span>
</span></span><span style="display:flex;"><span>      }}),
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  ),
</span></span><span style="display:flex;"><span>  inlinePolicies<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;Route53&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">new</span> iam.PolicyDocument({
</span></span><span style="display:flex;"><span>      statements<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>          actions<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;route53:ChangeResourceRecordSets&#39;</span>,
</span></span><span style="display:flex;"><span>          ],
</span></span><span style="display:flex;"><span>          resources<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;arn:aws:route53:::hostedzone/*&#39;</span>
</span></span><span style="display:flex;"><span>          ]
</span></span><span style="display:flex;"><span>        }),
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>          actions<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;route53:ListHostedZones&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;route53:ListResourceRecordSets&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;route53:ListTagsForResource&#39;</span>
</span></span><span style="display:flex;"><span>          ],
</span></span><span style="display:flex;"><span>          resources<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;*&#39;</span>
</span></span><span style="display:flex;"><span>          ]
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>I registered some records to check the behavior in the existing zone.</p>




<div class="img_container"><a href="/article/475/images/existingzone.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/475/images/existingzone_hu_8194deecd4cae63c.png" width="600" height="88" alt="Existing zone">
</a></div>


<p>Specify the target zone in domainFilters, and install ExternalDNS with <a href="https://github.com/kubernetes-sigs/external-dns/tree/v0.14.0/charts/external-dns">Helm</a>. If multiple ExternalDNS refer to the same domain, txtOwnerId must be set to a unique value, otherwise they will try to delete records from each other because modified records are <a href="https://github.com/kubernetes-sigs/external-dns/blob/v0.15.0/plan/plan.go#L254">chosen</a> by txtOwnerId.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-tsx" data-lang="tsx"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> externalDns <span style="color:#ff79c6">=</span> cluster.addHelmChart(<span style="color:#f1fa8c">&#39;ExternalDNS&#39;</span>, {
</span></span><span style="display:flex;"><span>  release<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;external-dns&#39;</span>,
</span></span><span style="display:flex;"><span>  chart<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;external-dns&#39;</span>,
</span></span><span style="display:flex;"><span>  repository<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;https://kubernetes-sigs.github.io/external-dns&#39;</span>,
</span></span><span style="display:flex;"><span>  version<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;1.14.3&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;external-dns&#39;</span>,
</span></span><span style="display:flex;"><span>  createNamespace: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>  values<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    serviceAccount<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;external-dns-sa&#34;</span>,
</span></span><span style="display:flex;"><span>      annotations<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#39;eks.amazonaws.com/role-arn&#39;</span><span style="color:#ff79c6">:</span> externalDNSRole.roleArn
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    sources<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#39;service&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#39;ingress&#39;</span>
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    domainFilters<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;externaldns.test&#39;</span>],
</span></span><span style="display:flex;"><span>    provider<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;aws&#39;</span>,
</span></span><span style="display:flex;"><span>    policy<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;sync&#39;</span>, <span style="color:#6272a4">// or &#39;upsert-only&#39;
</span></span></span><span style="display:flex;"><span>    awsZoneType<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;public&#39;</span>,
</span></span><span style="display:flex;"><span>    registry<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;txt&#39;</span>, <span style="color:#6272a4">// Specify the registry for storing ownership and labels
</span></span></span><span style="display:flex;"><span>    txtOwnerId<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;external-dns&#39;</span>, <span style="color:#6272a4">// Specify an identifier for this instance of ExternalDNS
</span></span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  wait: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (cluster.albController) {
</span></span><span style="display:flex;"><span>  externalDns.node.addDependency(cluster.albController)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Specifying <a href="https://github.com/kubernetes-sigs/external-dns/blob/v0.14.0/docs/tutorials/aws.md#verify-externaldns-works-service-example">Service</a>&rsquo;s external-dns.alpha.kubernetes.io/hostname annotations or <a href="https://github.com/kubernetes-sigs/external-dns/blob/v0.14.0/docs/tutorials/aws.md#verify-externaldns-works-ingress-example">Ingress</a>&rsquo;s rule.host,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: nginx
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">annotations</span>:
</span></span><span style="display:flex;"><span>	  <span style="color:#ff79c6">service.beta.kubernetes.io/aws-load-balancer-type</span>: external
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">external-dns.alpha.kubernetes.io/hostname</span>: cccc.externaldns.test
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: LoadBalancer
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">targetPort</span>: <span style="color:#bd93f9">80</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: nginx
</span></span></code></pre></div><p>A record and TXT records like &ldquo;heritage=external-dns,external-dns/owner=external-dns,external-dns/resource=service/default/nginx&rdquo; are created.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">Desired change: CREATE cccc.externaldns.test A [Id</span>: /hostedzone/****]
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">Desired change: CREATE cccc.externaldns.test TXT [Id</span>: /hostedzone/****]
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">Desired change: CREATE cname-cccc.externaldns.test TXT [Id</span>: /hostedzone/****]
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">3 record(s) in zone externaldns.test. [Id</span>: /hostedzone/****] were successfully updated
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">Applying provider record filter for domains</span>: [externaldns.test. .externaldns.test.]
</span></span><span style="display:flex;"><span>All records are already up to date
</span></span></code></pre></div><p>ALB managed by Load Balancer Controller uses Host header for routing.</p>
<p><a href="https://www.sambaiz.net/en/article/471/">Install AWS Load Balancer Controller on EKS cluster and set up ALB Ingress - sambaiz-net</a></p>




<div class="img_container"><a href="/article/475/images/albcondition.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/475/images/albcondition_hu_5d43749c6135609a.png" width="600" height="225" alt="Host header for routing">
</a></div>


<p>If policy is &ldquo;sync&rdquo;, when you delete a resource, the records are deleted, but the existing records remain.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Desired change: DELETE cccc.externaldns.test A <span style="color:#ff79c6">[</span>Id: /hostedzone/****<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>Desired change: DELETE cccc.externaldns.test TXT <span style="color:#ff79c6">[</span>Id: /hostedzone/****<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>Desired change: DELETE cname-cccc.externaldns.test TXT <span style="color:#ff79c6">[</span>Id: /hostedzone/****<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">3</span> record<span style="color:#ff79c6">(</span>s<span style="color:#ff79c6">)</span> in zone externaldns.test. <span style="color:#ff79c6">[</span>Id: /hostedzone/****<span style="color:#ff79c6">]</span> were successfully updated
</span></span><span style="display:flex;"><span>All records are already up to date
</span></span></code></pre></div><p>To register a record with the same name, you <a href="https://github.com/kubernetes-sigs/external-dns/blob/v0.14.0/docs/tutorials/aws.md#routing-policies">need</a> to set external-dns.alpha.kubernetes.io/set-identifier as well as external-dns.alpha.kubernetes.io/aws-weight etc.</p>




<div class="img_container"><a href="/article/475/images/weightedrecords.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/475/images/weightedrecords_hu_d25f3f3d64f71f85.png" width="600" height="137" alt="Weighted routing">
</a></div>


<p>If existing record&rsquo;s routing policy is different, it occurs error.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">Failure in zone externaldns.test. [Id: /hostedzone/*****] when submitting change batch: InvalidChangeBatch: [RRSet with DNS name bbbb.externaldns.test., type A, SetIdentifier nginx cannot be created as a non-weighted set exists with the same name and type.]\n\tstatus code</span>: <span style="color:#bd93f9">400</span>
</span></span></code></pre></div>
    </div>
  </article>
</div>

</div>
</body>

</html>