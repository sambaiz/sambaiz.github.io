<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Copy and Query S3 Data in Snowflake - sambaiz-net</title>
  <meta name="twitter:title" content="Copy and Query S3 Data in Snowflake - sambaiz-net">
  <meta property='og:title' content="Copy and Query S3 Data in Snowflake - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="Snowflake is a fully managed data platform that runs on AWS, GCP, and Azure">
  <meta name="twitter:description" content="Snowflake is a fully managed data platform that runs on AWS, GCP, and Azure">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/518/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/518/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/518/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/518/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Copy and Query S3 Data in Snowflake",
    "datePublished": "2024-12-31T23:57:00JST",
    "dateModified": "2024-12-31T23:57:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "Snowflake is a fully managed data platform that runs on AWS, GCP, and Azure"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/518/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="/places/">
            <img src="/image/pin.svg" width="30px" height="30px" alt="places">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Copy and Query S3 Data in Snowflake</h1>
        <time>2024-12-31</time>
        <a class="tag" href='/en/tags/snowflake/'>snowflake</a><a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/database/'>database</a>
      </div>
      <p>Snowflake is a fully managed data platform that runs on AWS, GCP, and Azure. It <a href="https://docs.snowflake.com/en/user-guide/intro-key-concepts#database-storage">stores data</a> in columnar format, is built with <a href="https://docs.snowflake.com/en/user-guide/intro-key-concepts#snowflake-architecture">hybrid shared-nothing architecture</a> where nodes cache portions of shared datasets locally to suppress network traffic, and does automatic <a href="https://docs.snowflake.com/en/user-guide/tables-clustering-micropartitions">micro-partitioning</a> for fine-grained pruning, enabling efficient large-scale query execution.</p>
<p><a href="https://www.sambaiz.net/en/article/386/">Columnar format Parquet structure and read optimization - sambaiz-net</a></p>
<p>In addition to eliminating the need to manage infrastructure like Hadoop clusters, it offers features such as <a href="https://docs.snowflake.com/en/user-guide/data-time-travel">time travel</a> similar to BigQuery and easily <a href="https://docs.snowflake.com/en/user-guide/data-sharing-intro">data sharing</a> between accounts.</p>
<p><a href="https://www.sambaiz.net/en/article/511/">Restoring BigQuery Data using time travel and snapshots - sambaiz-net</a></p>
<p><a href="https://docs.snowflake.com/en/user-guide/cost-understanding-overall">Pricing</a> is based on computing <a href="https://www.snowflake.com/en/pricing-options/">credits</a> that the unit price depends on the plan, storage, and <a href="https://docs.snowflake.com/en/user-guide/cost-understanding-data-transfer">data egress to another region or cloud</a>. There is no Snowflake charge for ingress, but egress costs on the cloud side may occur, so it is better to run it in a cloud region where data is concentrated as much as possible to reduce costs, but currently there are few <a href="https://docs.snowflake.com/en/user-guide/intro-regions">supported regions</a> for GCP. In many cases, credits will account for the majority of the charge, and you can check your consumption on the screen or with the following query.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">WITH</span> wh_bill <span style="color:#ff79c6">AS</span> (
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">SELECT</span> <span style="color:#8be9fd;font-style:italic">DATE</span>(start_time) <span style="color:#ff79c6">as</span> <span style="color:#ff79c6">day</span>, warehouse_name, <span style="color:#ff79c6">SUM</span>(credits_used_compute) <span style="color:#ff79c6">AS</span> compute_credits
</span></span><span style="display:flex;"><span>     <span style="color:#ff79c6">FROM</span> SNOWFLAKE.ACCOUNT_USAGE.WAREHOUSE_METERING_HISTORY
</span></span><span style="display:flex;"><span>     <span style="color:#ff79c6">WHERE</span> start_time <span style="color:#ff79c6">&gt;=</span> DATEADD(<span style="color:#ff79c6">day</span>, <span style="color:#ff79c6">-</span><span style="color:#bd93f9">30</span>, <span style="color:#ff79c6">CURRENT_TIMESTAMP</span>())
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">GROUP</span> <span style="color:#ff79c6">BY</span> <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>user_credits <span style="color:#ff79c6">AS</span> (
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">SELECT</span> <span style="color:#8be9fd;font-style:italic">DATE</span>(start_time) <span style="color:#ff79c6">as</span> <span style="color:#ff79c6">day</span>, user_name, warehouse_name, <span style="color:#ff79c6">SUM</span>(credits_attributed_compute) <span style="color:#ff79c6">AS</span> credits
</span></span><span style="display:flex;"><span>     <span style="color:#ff79c6">FROM</span> SNOWFLAKE.ACCOUNT_USAGE.QUERY_ATTRIBUTION_HISTORY
</span></span><span style="display:flex;"><span>     <span style="color:#ff79c6">WHERE</span> start_time <span style="color:#ff79c6">&gt;=</span> DATEADD(<span style="color:#ff79c6">day</span>, <span style="color:#ff79c6">-</span><span style="color:#bd93f9">30</span>, <span style="color:#ff79c6">CURRENT_TIMESTAMP</span>())
</span></span><span style="display:flex;"><span>     <span style="color:#ff79c6">GROUP</span> <span style="color:#ff79c6">BY</span> <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>total_credit <span style="color:#ff79c6">AS</span> (
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">day</span>, warehouse_name, <span style="color:#ff79c6">SUM</span>(credits) <span style="color:#ff79c6">AS</span> sum_all_credits
</span></span><span style="display:flex;"><span>     <span style="color:#ff79c6">FROM</span> user_credits
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">GROUP</span> <span style="color:#ff79c6">BY</span> <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">day</span>,
</span></span><span style="display:flex;"><span>       u.user_name,
</span></span><span style="display:flex;"><span>       u.warehouse_name,
</span></span><span style="display:flex;"><span>       u.credits <span style="color:#ff79c6">/</span> t.sum_all_credits <span style="color:#ff79c6">*</span> w.compute_credits <span style="color:#ff79c6">AS</span> attributed_credits
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">FROM</span> user_credits u
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">JOIN</span> total_credit t <span style="color:#ff79c6">USING</span> (<span style="color:#ff79c6">day</span>, warehouse_name) 
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">JOIN</span> wh_bill w <span style="color:#ff79c6">USING</span> (<span style="color:#ff79c6">day</span>, warehouse_name)
</span></span></code></pre></div><p>First, select a <a href="https://docs.snowflake.com/en/user-guide/security-access-control-overview#roles">ROLE</a> with appropriate permissions and a provisioned <a href="https://docs.snowflake.com/en/user-guide/warehouses-overview">WAREHOUSE</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>USE <span style="color:#ff79c6">ROLE</span> ACCOUNTADMIN;
</span></span><span style="display:flex;"><span>USE WAREHOUSE COMPUTE_WH;
</span></span></code></pre></div><p>While the WAREHOUSE is running, it consumes credits according to its size. It can also be automatically resumed/suspended.</p>




<div class="img_container"><a href="/article/518/images/warehouse.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/518/images/warehouse_hu_4954fe55760d634.png" width="474" height="370" alt="WAREHOUSE">
</a></div>


<p>Create a <a href="https://docs.snowflake.com/en/sql-reference/sql/create-storage-integration">STORAGE INTEGRATION</a> with S3 and obtain the accessing AWS account for Snowflake and External ID.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">OR</span> <span style="color:#ff79c6">REPLACE</span> <span style="color:#ff79c6">STORAGE</span> INTEGRATION S3_DATA_INTEGRATION
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">TYPE</span> <span style="color:#ff79c6">=</span> EXTERNAL_STAGE
</span></span><span style="display:flex;"><span>  STORAGE_PROVIDER <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;S3&#39;</span>
</span></span><span style="display:flex;"><span>  STORAGE_AWS_ROLE_ARN <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;arn:aws:iam::*****:role/*****&#39;</span>
</span></span><span style="display:flex;"><span>  ENABLED <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">TRUE</span>
</span></span><span style="display:flex;"><span>  STORAGE_ALLOWED_LOCATIONS <span style="color:#ff79c6">=</span> (<span style="color:#f1fa8c">&#39;s3://*****/&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">DESC</span> INTEGRATION S3_DATA_INTEGRATION;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#</span> STORAGE_AWS_IAM_USER_ARN,String,arn:aws:iam::<span style="color:#ff79c6">*****</span>:<span style="color:#ff79c6">user</span><span style="color:#6272a4">/*****,
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># STORAGE_AWS_EXTERNAL_ID,String,*****,
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">...
</span></span></span></code></pre></div><p>Create an IAM Role that this user will assume.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> snowflakeRole <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> iam.Role(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;SnowflakeS3Role&#39;</span>, {
</span></span><span style="display:flex;"><span>  assumedBy: <span style="color:#8be9fd">new</span> iam.ServicePrincipal(<span style="color:#f1fa8c">&#39;sts.amazonaws.com&#39;</span>),
</span></span><span style="display:flex;"><span>  inlinePolicies<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    SnowflakeS3AccessPolicy: <span style="color:#8be9fd">new</span> iam.PolicyDocument({
</span></span><span style="display:flex;"><span>      statements<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>          actions<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;s3:GetObject&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;s3:PutObject&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;s3:ListBucket&#39;</span>,
</span></span><span style="display:flex;"><span>          ],
</span></span><span style="display:flex;"><span>          resources<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>            bucket.bucketArn,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>bucket.bucketArn<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/*`</span>,
</span></span><span style="display:flex;"><span>          ],
</span></span><span style="display:flex;"><span>        }),
</span></span><span style="display:flex;"><span>      ],
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>snowflakeRole.assumeRolePolicy<span style="color:#ff79c6">?</span>.addStatements(
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>    actions<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;sts:AssumeRole&#39;</span>],
</span></span><span style="display:flex;"><span>    principals<span style="color:#ff79c6">:</span> [<span style="color:#ff79c6">new</span> iam.AccountPrincipal(<span style="color:#f1fa8c">&#39;*****&#39;</span>)],
</span></span><span style="display:flex;"><span>    conditions<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      StringEquals<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#39;sts:ExternalId&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;*****&#39;</span>,
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Next, create a <a href="https://docs.snowflake.com/en/sql-reference/sql/create-stage">STAGE</a> and COPY the data to a TABLE. You can also load automatically using <a href="https://docs.snowflake.com/en/user-guide/data-load-snowpipe-intro">Snowpipe</a>. Besides, if you don&rsquo;t enclose identifiers such as database names in double quotes, they will be <a href="https://docs.snowflake.com/en/sql-reference/identifiers-syntax#unquoted-identifiers">treated</a> as uppercase, but you can create lowercase objects by enclosing them, and they will be created as written in Terraform, etc. However, in that case, you will need to enclose them in double quotes when referencing them, which can lead to unnecessary confusion, so I think it would be better to standardize on uppercase.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">OR</span> <span style="color:#ff79c6">REPLACE</span> <span style="color:#ff79c6">DATABASE</span> TESTDB;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">OR</span> <span style="color:#ff79c6">REPLACE</span> <span style="color:#ff79c6">SCHEMA</span> TESTDB.S3_DATA;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">OR</span> <span style="color:#ff79c6">REPLACE</span> <span style="color:#ff79c6">TABLE</span> TESTDB.S3_DATA.USERS (
</span></span><span style="display:flex;"><span>  id <span style="color:#8be9fd;font-style:italic">INT</span>
</span></span><span style="display:flex;"><span>  ,name <span style="color:#8be9fd;font-style:italic">VARCHAR</span>(<span style="color:#bd93f9">30</span>)
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">OR</span> <span style="color:#ff79c6">REPLACE</span> STAGE TESTDB.S3_DATA.S3_DATA_STAGE
</span></span><span style="display:flex;"><span>  STORAGE_INTEGRATION <span style="color:#ff79c6">=</span> S3_DATA_INTEGRATION
</span></span><span style="display:flex;"><span>  URL <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;s3://*****/&#39;</span>
</span></span><span style="display:flex;"><span>  FILE_FORMAT <span style="color:#ff79c6">=</span> (<span style="color:#ff79c6">TYPE</span> <span style="color:#ff79c6">=</span> CSV, SKIP_HEADER <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">COPY</span> <span style="color:#ff79c6">INTO</span> TESTDB.S3_DATA.USERS
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">FROM</span> <span style="color:#ff79c6">@</span>TESTDB.S3_DATA.S3_DATA_STAGE
</span></span><span style="display:flex;"><span>    FILES <span style="color:#ff79c6">=</span> (<span style="color:#f1fa8c">&#39;users.csv&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> TESTDB.S3_DATA.USERS;
</span></span></code></pre></div><p>Then you can query from Snowflake.</p>




<div class="img_container"><a href="/article/518/images/query.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/518/images/query_hu_b6dd5a268aaa0fc8.png" width="600" height="156" alt="Query">
</a></div>


<p><a href="https://www.sambaiz.net/en/article/530/">Create Snowflake roles with Terraform and grant users table access permissions - sambaiz-net</a></p>
<h2 id="reference">Reference</h2>
<p><a href="https://zenn.dev/rshimajiri/articles/89393861f106a0">Snowflakeの論文「The Snowflake Elastic Data Warehouse」を読んでみた_Part1</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>