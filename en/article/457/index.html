<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Create resources required for EC2 instance without public IPv4 but IPv6 address to communicate with the Internet - sambaiz-net</title>
  <meta name="twitter:title" content="Create resources required for EC2 instance without public IPv4 but IPv6 address to communicate with the Internet - sambaiz-net">
  <meta property='og:title' content="Create resources required for EC2 instance without public IPv4 but IPv6 address to communicate with the Internet - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="Public IPv4 addresses will start being charged like EIPs soon, so I would like to migrate them to IPv6 recently">
  <meta name="twitter:description" content="Public IPv4 addresses will start being charged like EIPs soon, so I would like to migrate them to IPv6 recently">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/457/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/457/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/457/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/457/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Create resources required for EC2 instance without public IPv4 but IPv6 address to communicate with the Internet",
    "datePublished": "2023-11-06T09:30:00JST",
    "dateModified": "2023-11-06T09:30:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "Public IPv4 addresses will start being charged like EIPs soon, so I would like to migrate them to IPv6 recently"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/457/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Create resources required for EC2 instance without public IPv4 but IPv6 address to communicate with the Internet</h1>
        <time>2023-11-06</time>
        <a class="tag" href='/en/tags/aws/'>aws</a>
      </div>
      <p>Public IPv4 addresses will start being <a href="https://aws.amazon.com/jp/blogs/aws/new-aws-public-ipv4-address-charge-public-ip-insights/">charged</a> like EIPs soon, so I would like to migrate them to IPv6 recently.
In this article, I construct an IPv6 environment with CDK and check the resources required to communicate with the Internet and the behavior.</p>
<blockquote>
<p>(PS: 2024-01-29) In <a href="https://github.com/aws/aws-cdk/releases/tag/v2.122.0">v2.122.0</a>, ipProtocol: ec2.IpProtocol.DUAL_STACK was added to ec2.Vpc, which creates resources for IPv6 automatically.</p>
</blockquote>
<h2 id="create-a-vpc">Create a VPC</h2>
<p>IPv6 block assigned to VPC is fixed length <a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-cidr-blocks.html#vpc-sizing-ipv6">/56</a> and one assigned to subnets is also fixed length <a href="https://docs.aws.amazon.com/vpc/latest/userguide/subnet-sizing.html#subnet-sizing-ipv6">/64</a>.
I disabled automatically assigning public IPv4 addresses and make IPv6 addresses assigned automatically.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> vpc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ec2.Vpc(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;VPC&#39;</span>, {
</span></span><span style="display:flex;"><span>  ipAddresses: <span style="color:#8be9fd">ec2.IpAddresses.cidr</span>(<span style="color:#f1fa8c">&#39;10.0.0.0/22&#39;</span>),
</span></span><span style="display:flex;"><span>  maxAzs: <span style="color:#8be9fd">2</span>,
</span></span><span style="display:flex;"><span>  natGateways: <span style="color:#8be9fd">0</span>,
</span></span><span style="display:flex;"><span>  subnetConfiguration<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      subnetType: <span style="color:#8be9fd">ec2.SubnetType.PUBLIC</span>,
</span></span><span style="display:flex;"><span>      name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;Public&#39;</span>,
</span></span><span style="display:flex;"><span>      cidrMask: <span style="color:#8be9fd">24</span>,
</span></span><span style="display:flex;"><span>      mapPublicIpOnLaunch: <span style="color:#8be9fd">false</span>  <span style="color:#6272a4">// settings for Auto-assign public IPv4 address (default: true)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      subnetType: <span style="color:#8be9fd">ec2.SubnetType.PRIVATE_WITH_EGRESS</span>,
</span></span><span style="display:flex;"><span>      name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;Private&#39;</span>,
</span></span><span style="display:flex;"><span>      cidrMask: <span style="color:#8be9fd">24</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> cidrBlockIPV6 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ec2.CfnVPCCidrBlock(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;CidrBlockIPV6&#39;</span>, {
</span></span><span style="display:flex;"><span>  vpcId: <span style="color:#8be9fd">vpc.vpcId</span>,
</span></span><span style="display:flex;"><span>  amazonProvidedIpv6CidrBlock: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> vpcIpv6CidrBlock <span style="color:#ff79c6">=</span> cdk.Fn.select(<span style="color:#bd93f9">0</span>, vpc.vpcIpv6CidrBlocks);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// IPV6 ::/56 block is split into 256 chunks of ::/64 blocks
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// e.g. 2406:da14:856:3200::/64, 2406:da14:856:3201::/64, ...
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">const</span> subnetIpv6CidrBlocks <span style="color:#ff79c6">=</span> cdk.Fn.cidr(vpcIpv6CidrBlock, <span style="color:#bd93f9">256</span>, <span style="color:#f1fa8c">&#34;64&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[...vpc.publicSubnets, ...vpc.privateSubnets].forEach((subnet, i) <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>  subnet.node.addDependency(cidrBlockIPV6);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> cfnSubnet <span style="color:#ff79c6">=</span> subnet.node.defaultChild <span style="color:#ff79c6">as</span> ec2.CfnSubnet
</span></span><span style="display:flex;"><span>  cfnSubnet.ipv6CidrBlock <span style="color:#ff79c6">=</span> cdk.Fn.select(i, subnetIpv6CidrBlocks);
</span></span><span style="display:flex;"><span>  cfnSubnet.assignIpv6AddressOnCreation <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>  cfnSubnet.enableDns64 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><h2 id="update-route-tableshttpsdocsawsamazoncomvpclatestuserguidevpc-migrate-ipv6htmlvpc-migrate-ipv6-routes"><a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-migrate-ipv6.html#vpc-migrate-ipv6-routes">Update route tables</a></h2>
<p>For public subnets, add a route to the Internet gateway same as v4, but for private subnets, add a route to the Egress-only Internet gateway instead without NAT.
Egress-only Internet gateway is <a href="https://docs.aws.amazon.com/vpc/latest/userguide/egress-only-internet-gateway.html#egress-only-internet-gateway-pricing">free</a> unlike NAT gateway,
but it only supports v6, so v4 communication still requires NAT gateway.
When calling APIs of services that do not support IPv6 such as SSM, v4 communication is still required.</p>
<p>Additionally, I enabled DNS64 and added a route for NAT64 to enable instances with only IPv6 addresses to communicate with IPv4.
DNS64 returns IPv4 addresses as IPv6 ones by attaching <a href="https://datatracker.ietf.org/doc/html/rfc6052">RFC6052</a> 64:ff9b:: prefix,
and when NAT gateway receives addresses with this prefix, it converts the IPv6 packets to IPv4 ones, so instances can communicate without public IPv4 addresses.
However, <a href="https://aws.amazon.com/jp/blogs/networking-and-content-delivery/dual-stack-architectures-for-aws-and-hybrid-networks-part-2/">note</a> that if you enable this setting in an IPv4/v6 dual-stack environment,
IPv6 is preferred and so unnecessary NAT will occur and IPv4 address routing won&rsquo;t work.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> natGatewayEIP <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ec2.CfnEIP(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;NatGatewayEIP&#39;</span>, {
</span></span><span style="display:flex;"><span>  domain<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;vpc&#39;</span>,
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> natGateway <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ec2.CfnNatGateway(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;NatGateway&#39;</span>, {
</span></span><span style="display:flex;"><span>  allocationId: <span style="color:#8be9fd">natGatewayEIP.attrAllocationId</span>,
</span></span><span style="display:flex;"><span>  subnetId: <span style="color:#8be9fd">vpc.publicSubnets</span>[<span style="color:#bd93f9">0</span>].subnetId,
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vpc.publicSubnets.forEach((subnet) <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> ec2Subnet <span style="color:#ff79c6">=</span> subnet <span style="color:#ff79c6">as</span> ec2.Subnet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ec2Subnet.addRoute(<span style="color:#f1fa8c">&#39;DefaultIPV6Route&#39;</span>, {
</span></span><span style="display:flex;"><span>    routerType: <span style="color:#8be9fd">ec2.RouterType.GATEWAY</span>,
</span></span><span style="display:flex;"><span>    routerId: <span style="color:#8be9fd">vpc.internetGatewayId</span><span style="color:#ff79c6">!</span>,
</span></span><span style="display:flex;"><span>    destinationIpv6CidrBlock<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;::/0&#34;</span>,
</span></span><span style="display:flex;"><span>    enablesInternetConnectivity: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ec2Subnet.addRoute(<span style="color:#f1fa8c">&#39;NAT64IPV6Route&#39;</span>, {
</span></span><span style="display:flex;"><span>    routerType: <span style="color:#8be9fd">ec2.RouterType.NAT_GATEWAY</span>,
</span></span><span style="display:flex;"><span>    routerId: <span style="color:#8be9fd">natGateway.ref</span>,
</span></span><span style="display:flex;"><span>    destinationIpv6CidrBlock<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;64:ff9b::/96&#34;</span>,
</span></span><span style="display:flex;"><span>    enablesInternetConnectivity: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> egressOnlyIgw <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ec2.CfnEgressOnlyInternetGateway(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#34;EgressOnlyIGW&#34;</span>, {
</span></span><span style="display:flex;"><span>  vpcId: <span style="color:#8be9fd">vpc.vpcId</span>
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vpc.privateSubnets.forEach((subnet, i) <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> ec2Subnet <span style="color:#ff79c6">=</span> subnet <span style="color:#ff79c6">as</span> ec2.Subnet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ec2Subnet.addDefaultNatRoute(natGateway.ref)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ec2Subnet.addRoute(<span style="color:#f1fa8c">&#39;DefaultIPV6Route&#39;</span>, {
</span></span><span style="display:flex;"><span>    routerType: <span style="color:#8be9fd">ec2.RouterType.EGRESS_ONLY_INTERNET_GATEWAY</span>,
</span></span><span style="display:flex;"><span>    routerId: <span style="color:#8be9fd">egressOnlyIgw.ref</span>,
</span></span><span style="display:flex;"><span>    destinationIpv6CidrBlock<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;::/0&#34;</span>,
</span></span><span style="display:flex;"><span>    enablesInternetConnectivity: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><h2 id="check-behavior">Check behavior</h2>
<p>Launch instances in public and private subnets with SG accepting IPv6 outbound traffic.
If you enable IPv6 in an existing subnet, you should also check the settings of Network ACLs as well as SG.</p>
<p><a href="https://www.sambaiz.net/en/article/467/">See traffic denied by SG or Network ACL with VPC Flow Logs and CloudWatch Logs Insights - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> role <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> iam.Role(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;EC2Role&#39;</span>, {
</span></span><span style="display:flex;"><span>  assumedBy: <span style="color:#8be9fd">new</span> iam.ServicePrincipal(<span style="color:#f1fa8c">&#39;ec2.amazonaws.com&#39;</span>),
</span></span><span style="display:flex;"><span>  managedPolicies<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>    iam.ManagedPolicy.fromAwsManagedPolicyName(<span style="color:#f1fa8c">&#39;AmazonSSMManagedInstanceCore&#39;</span>),
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> securityGroup <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ec2.SecurityGroup(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;EC2SecurityGroup&#39;</span>, {
</span></span><span style="display:flex;"><span>  vpc,
</span></span><span style="display:flex;"><span>  allowAllOutbound: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>  allowAllIpv6Outbound: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> publicSubnetEC2Instance <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ec2.Instance(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;EC2PublicSubnet&#39;</span>, {
</span></span><span style="display:flex;"><span>  vpc,
</span></span><span style="display:flex;"><span>  instanceType: <span style="color:#8be9fd">new</span> ec2.InstanceType(<span style="color:#f1fa8c">&#39;t2.micro&#39;</span>),
</span></span><span style="display:flex;"><span>  machineImage: <span style="color:#8be9fd">new</span> ec2.AmazonLinuxImage(),
</span></span><span style="display:flex;"><span>  role: <span style="color:#8be9fd">role</span>,
</span></span><span style="display:flex;"><span>  securityGroup: <span style="color:#8be9fd">securityGroup</span>,
</span></span><span style="display:flex;"><span>  vpcSubnets<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    subnetType: <span style="color:#8be9fd">ec2.SubnetType.PUBLIC</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> privateSubnetEC2Instance <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ec2.Instance(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;EC2PrivateSubnet&#39;</span>, {
</span></span><span style="display:flex;"><span>  vpc,
</span></span><span style="display:flex;"><span>  instanceType: <span style="color:#8be9fd">new</span> ec2.InstanceType(<span style="color:#f1fa8c">&#39;t2.micro&#39;</span>),
</span></span><span style="display:flex;"><span>  machineImage: <span style="color:#8be9fd">new</span> ec2.AmazonLinuxImage(),
</span></span><span style="display:flex;"><span>  role: <span style="color:#8be9fd">role</span>,
</span></span><span style="display:flex;"><span>  securityGroup: <span style="color:#8be9fd">securityGroup</span>,
</span></span><span style="display:flex;"><span>  vpcSubnets<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    subnetType: <span style="color:#8be9fd">ec2.SubnetType.PRIVATE_WITH_EGRESS</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>Requesting to ifconfig.io, which returns AAAA records from instances, the IPv6 addresses of the instances are returned, so it can be seen that communication with IPv6 is successful.
Also, httpbin.org, which does not return AAAA records, returns IPv6 addresses with 64:ff9b:: prefix by DNS64, and IPv4 addresses of NAT gateway are returned, so it can be seen that NAT64 conversion is successful.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl ifconfig.io
</span></span><span style="display:flex;"><span>2406:da14:45a:3402:7815:32a9:72db:d9e4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ nslookup -q<span style="color:#ff79c6">=</span>AAAA httpbin.org
</span></span><span style="display:flex;"><span>Server:         10.0.0.2
</span></span><span style="display:flex;"><span>Address:        10.0.0.2#53
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-authoritative answer:
</span></span><span style="display:flex;"><span>    httpbin.org     has AAAA address 64:ff9b::3448:ee09
</span></span><span style="display:flex;"><span>    httpbin.org     has AAAA address 64:ff9b::3e4:853a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ man curl
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>-6, --ipv6
</span></span><span style="display:flex;"><span>This option tells curl to resolve names to IPv6 addresses only, and not <span style="color:#ff79c6">for</span> example try IPv4.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl --ipv6 httpbin.org/ip
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># public subnet</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;origin&#34;</span>: <span style="color:#f1fa8c">&#34;57.180.96.138&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h2 id="references">References</h2>
<p><a href="https://www.turbogeek.co.uk/aws-cdk-ipv6-v/">How to Create an IPV6 VPC using AWS-CDK - TurboGeek</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>