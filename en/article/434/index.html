<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Launch an EKS cluster and register it to EMR on EKS with CDK to run Spark jobs - sambaiz-net</title>
  <meta name="twitter:title" content="Launch an EKS cluster and register it to EMR on EKS with CDK to run Spark jobs - sambaiz-net">
  <meta property='og:title' content="Launch an EKS cluster and register it to EMR on EKS with CDK to run Spark jobs - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="While normal EMR also manages Hadoop clusters, EMR on EKS is only responsible for starting containers">
  <meta name="twitter:description" content="While normal EMR also manages Hadoop clusters, EMR on EKS is only responsible for starting containers">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/434/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/434/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/434/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/434/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Launch an EKS cluster and register it to EMR on EKS with CDK to run Spark jobs",
    "datePublished": "2023-01-02T14:53:00JST",
    "dateModified": "2023-01-02T14:53:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "While normal EMR also manages Hadoop clusters, EMR on EKS is only responsible for starting containers"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/434/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Launch an EKS cluster and register it to EMR on EKS with CDK to run Spark jobs</h1>
        <time>2023-01-02</time>
        <a class="tag" href='/en/tags/kubernetes/'>kubernetes</a><a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/spark/'>spark</a><a class="tag" href='/en/tags/etl/'>etl</a>
      </div>
      <p><a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/emr-eks.html">EMR on EKS</a> is a feature to run Spark on EKS.
While normal EMR also manages Hadoop clusters, EMR on EKS is only responsible for starting containers.</p>
<p><a href="https://www.sambaiz.net/en/article/409/">Launch an EMR cluster with AWS CLI and run Spark applications - sambaiz-net</a></p>
<p>By running on Kubernetes, you can use tools and functions for Kubernetes to manage and monitor, and utilize resources left over if you have an existing cluster.
It also enables to use knowledge about Kubernetes learned from other applications for aggregation and analysis, and also may be vice versa.
However, some knowledge about Kubernetes and EKS is required.
You can start using normal EMR without knowledge of YARN, but I think EMR on EKS will be difficult to even operate with no knowledge.</p>
<p>By the way, Docker is <a href="https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-plan-docker.html">supported</a> from EMR 6.x (Hadoop 3).</p>
<p><a href="https://aws.amazon.com/emr/pricing/?nc1=h_ls">Pricing</a> is based on requested the amount of vCPU and memory.</p>
<p>In this article, I lanchced an EKS cluster and register it to EMR on EKS with CDK, and confirmed that Spark jobs can run on it.
The entire code is on <a href="https://github.com/sambaiz/emr-on-eks-with-cdk">GitHub</a>.</p>
<h2 id="launch-a-cluster">Launch a cluster</h2>
<p>Since v1.22, you <a href="https://github.com/aws/aws-cdk/issues/20263">need</a> to pass kubectlLayer of an external package to use
the latest kubectl on addManifest() etc.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> { KubectlV27Layer } <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#39;@aws-cdk/lambda-layer-kubectl-v27&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> mastersRole <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> iam.Role(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;MastersRole&#39;</span>, {
</span></span><span style="display:flex;"><span>  assumedBy: <span style="color:#8be9fd">new</span> iam.CompositePrincipal(
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">new</span> iam.ServicePrincipal(<span style="color:#f1fa8c">&#39;eks.amazonaws.com&#39;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">new</span> iam.AccountRootPrincipal(),
</span></span><span style="display:flex;"><span>  ),
</span></span><span style="display:flex;"><span>  managedPolicies<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>    iam.ManagedPolicy.fromAwsManagedPolicyName(<span style="color:#f1fa8c">&#39;AmazonEKSClusterPolicy&#39;</span>),
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> eks.Cluster(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;EKSCluster&#39;</span>, {
</span></span><span style="display:flex;"><span>  vpc,
</span></span><span style="display:flex;"><span>  mastersRole,
</span></span><span style="display:flex;"><span>  clusterName: <span style="color:#8be9fd">clusterName</span>,
</span></span><span style="display:flex;"><span>  version: <span style="color:#8be9fd">eks.KubernetesVersion.V1_27</span>,
</span></span><span style="display:flex;"><span>  kubectlLayer: <span style="color:#8be9fd">new</span> KubectlV27Layer(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;KubectlLayer&#39;</span>),
</span></span><span style="display:flex;"><span>  defaultCapacity: <span style="color:#8be9fd">3</span>,
</span></span><span style="display:flex;"><span>  defaultCapacityInstance: <span style="color:#8be9fd">new</span> ec2.InstanceType(<span style="color:#f1fa8c">&#39;m5.large&#39;</span>)
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>If you later want to grant cluster access to EMR with &ldquo;eksctl create iamidentitymapping&rdquo; instead of using CDK,
you need eks:DescribeCluster in addition to Kubernetes permissions, so add this to the master role or add the user&rsquo;s role to aws-auth to grant Kubernetes permissions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>inlinePolicies<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#39;eksctl-iamidentitymapping&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">new</span> iam.PolicyDocument({
</span></span><span style="display:flex;"><span>    statements<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>        effect: <span style="color:#8be9fd">iam.Effect.ALLOW</span>,
</span></span><span style="display:flex;"><span>        actions<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;eks:DescribeCluster&#39;</span>],
</span></span><span style="display:flex;"><span>        resources<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;*&#39;</span>],
</span></span><span style="display:flex;"><span>      })
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In that case, also add the profile to assume to the config.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ brew tap weaveworks/tap
</span></span><span style="display:flex;"><span>$ brew install weaveworks/tap/eksctl
</span></span><span style="display:flex;"><span>$ eksctl version
</span></span><span style="display:flex;"><span>0.124.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat ~/.aws/config
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>profile eks-master<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">region</span> <span style="color:#ff79c6">=</span> us-east-1
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">role_arn</span> <span style="color:#ff79c6">=</span> arn:aws:iam::xxxxx:role/EmrOnEksTestStack-clusterMastersRoleEABFBB9C-10Q5X4BE7QN51
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">source_profile</span> <span style="color:#ff79c6">=</span> &lt;user_profile_name&gt; 
</span></span></code></pre></div><h2 id="grant-the-cluster-accesshttpsdocsawsamazoncomemrlatestemr-on-eks-developmentguidesetting-up-cluster-accesshtml"><a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/setting-up-cluster-access.html">Grant the cluster access</a></h2>
<p>Bind a Kubernetes role to a User linked to <a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/using-service-linked-roles.html">service-linked role</a> for EMR on EKS.</p>
<p><a href="https://www.sambaiz.net/article/160/">RBACが有効なGKEでHelmを使う - sambaiz-net</a></p>
<h3 id="a-eksctl-create-iamidentitymapping-way">a. &ldquo;eksctl create iamidentitymapping&rdquo; way</h3>
<p>First, checked what resources are created by eksctl as per the documentation.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">CLUSTER_NAME</span><span style="color:#ff79c6">=</span>emr-on-eks-test
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">NAMESPACE</span><span style="color:#ff79c6">=</span>default
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ eksctl create iamidentitymapping <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --cluster <span style="color:#8be9fd;font-style:italic">$CLUSTER_NAME</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --namespace <span style="color:#8be9fd;font-style:italic">$NAMESPACE</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --service-name emr-containers <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --profile eks-master
</span></span><span style="display:flex;"><span>2022-12-31 17:40:34 <span style="color:#ff79c6">[</span>ℹ<span style="color:#ff79c6">]</span>  created <span style="color:#f1fa8c">&#34;default:Role.rbac.authorization.k8s.io/emr-containers&#34;</span>
</span></span><span style="display:flex;"><span>2022-12-31 17:40:34 <span style="color:#ff79c6">[</span>ℹ<span style="color:#ff79c6">]</span>  created <span style="color:#f1fa8c">&#34;default:RoleBinding.rbac.authorization.k8s.io/emr-containers&#34;</span>
</span></span><span style="display:flex;"><span>2022-12-31 17:40:34 <span style="color:#ff79c6">[</span>ℹ<span style="color:#ff79c6">]</span>  adding identity <span style="color:#f1fa8c">&#34;arn:aws:iam::xxxxx:role/AWSServiceRoleForAmazonEMRContainers&#34;</span> to auth ConfigMap
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl describe -n kube-system configmap aws-auth
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>mapRoles:
</span></span><span style="display:flex;"><span>  ----
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>- rolearn: arn:aws:iam::xxxxx:role/AWSServiceRoleForAmazonEMRContainers
</span></span><span style="display:flex;"><span>  username: emr-containers
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h3 id="b-cdk-way">b. CDK way</h3>
<p>I expressed <a href="https://github.com/eksctl-io/eksctl/blob/4fb29ad0bc523126ea837d1b7061eb639a65bfa4/pkg/authconfigmap/assets/emr-containers-rbac.yaml#L4">manifests</a> existing in the eksctl repository.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>const <span style="color:#8be9fd;font-style:italic">emrRole</span> <span style="color:#ff79c6">=</span> cluster.addManifest<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#39;EMRContainersRole&#39;</span>, <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  apiVersion: <span style="color:#f1fa8c">&#39;rbac.authorization.k8s.io/v1&#39;</span>,
</span></span><span style="display:flex;"><span>  kind: <span style="color:#f1fa8c">&#39;Role&#39;</span>,
</span></span><span style="display:flex;"><span>  metadata: <span style="color:#ff79c6">{</span> name: <span style="color:#f1fa8c">&#39;emr-containers&#39;</span>, namespace: emrcontainersNamespace <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>  rules: <span style="color:#ff79c6">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">{</span> apiGroups: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;&#39;</span><span style="color:#ff79c6">]</span>, resources: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;namespaces&#39;</span><span style="color:#ff79c6">]</span>, verbs: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;get&#39;</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">{</span> apiGroups: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;&#39;</span><span style="color:#ff79c6">]</span>, resources: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;serviceaccounts&#39;</span>, <span style="color:#f1fa8c">&#39;services&#39;</span>, <span style="color:#f1fa8c">&#39;configmaps&#39;</span>, <span style="color:#f1fa8c">&#39;events&#39;</span>, <span style="color:#f1fa8c">&#39;pods&#39;</span>, <span style="color:#f1fa8c">&#39;pods/log&#39;</span><span style="color:#ff79c6">]</span>, verbs: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;get&#39;</span>, <span style="color:#f1fa8c">&#39;list&#39;</span>, <span style="color:#f1fa8c">&#39;watch&#39;</span>, <span style="color:#f1fa8c">&#39;describe&#39;</span>, <span style="color:#f1fa8c">&#39;create&#39;</span>, <span style="color:#f1fa8c">&#39;edit&#39;</span>, <span style="color:#f1fa8c">&#39;delete&#39;</span>, <span style="color:#f1fa8c">&#39;deletecollection&#39;</span>, <span style="color:#f1fa8c">&#39;annotate&#39;</span>, <span style="color:#f1fa8c">&#39;patch&#39;</span>, <span style="color:#f1fa8c">&#39;label&#39;</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">{</span> apiGroups: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;&#39;</span><span style="color:#ff79c6">]</span>, resources: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;secrets&#39;</span><span style="color:#ff79c6">]</span>, verbs: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;create&#39;</span>, <span style="color:#f1fa8c">&#39;patch&#39;</span>, <span style="color:#f1fa8c">&#39;delete&#39;</span>, <span style="color:#f1fa8c">&#39;watch&#39;</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">{</span> apiGroups: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;apps&#39;</span><span style="color:#ff79c6">]</span>, resources: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;statefulsets&#39;</span>, <span style="color:#f1fa8c">&#39;deployments&#39;</span><span style="color:#ff79c6">]</span>, verbs: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;get&#39;</span>, <span style="color:#f1fa8c">&#39;list&#39;</span>, <span style="color:#f1fa8c">&#39;watch&#39;</span>, <span style="color:#f1fa8c">&#39;describe&#39;</span>, <span style="color:#f1fa8c">&#39;create&#39;</span>, <span style="color:#f1fa8c">&#39;edit&#39;</span>, <span style="color:#f1fa8c">&#39;delete&#39;</span>, <span style="color:#f1fa8c">&#39;annotate&#39;</span>, <span style="color:#f1fa8c">&#39;patch&#39;</span>, <span style="color:#f1fa8c">&#39;label&#39;</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">{</span> apiGroups: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;batch&#39;</span><span style="color:#ff79c6">]</span>, resources: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;jobs&#39;</span><span style="color:#ff79c6">]</span>, verbs: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;get&#39;</span>, <span style="color:#f1fa8c">&#39;list&#39;</span>, <span style="color:#f1fa8c">&#39;watch&#39;</span>, <span style="color:#f1fa8c">&#39;describe&#39;</span>, <span style="color:#f1fa8c">&#39;create&#39;</span>, <span style="color:#f1fa8c">&#39;edit&#39;</span>, <span style="color:#f1fa8c">&#39;delete&#39;</span>, <span style="color:#f1fa8c">&#39;annotate&#39;</span>, <span style="color:#f1fa8c">&#39;patch&#39;</span>, <span style="color:#f1fa8c">&#39;label&#39;</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">{</span> apiGroups: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;extensions&#39;</span>, <span style="color:#f1fa8c">&#39;networking.k8s.io&#39;</span><span style="color:#ff79c6">]</span>, resources: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;ingresses&#39;</span><span style="color:#ff79c6">]</span>, verbs: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;get&#39;</span>, <span style="color:#f1fa8c">&#39;list&#39;</span>, <span style="color:#f1fa8c">&#39;watch&#39;</span>, <span style="color:#f1fa8c">&#39;describe&#39;</span>, <span style="color:#f1fa8c">&#39;create&#39;</span>, <span style="color:#f1fa8c">&#39;edit&#39;</span>, <span style="color:#f1fa8c">&#39;delete&#39;</span>, <span style="color:#f1fa8c">&#39;annotate&#39;</span>, <span style="color:#f1fa8c">&#39;patch&#39;</span>, <span style="color:#f1fa8c">&#39;label&#39;</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">{</span> apiGroups: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;rbac.authorization.k8s.io&#39;</span><span style="color:#ff79c6">]</span>, resources: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;roles&#39;</span>, <span style="color:#f1fa8c">&#39;rolebindings&#39;</span><span style="color:#ff79c6">]</span>, verbs: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;get&#39;</span>, <span style="color:#f1fa8c">&#39;list&#39;</span>, <span style="color:#f1fa8c">&#39;watch&#39;</span>, <span style="color:#f1fa8c">&#39;describe&#39;</span>, <span style="color:#f1fa8c">&#39;create&#39;</span>, <span style="color:#f1fa8c">&#39;edit&#39;</span>, <span style="color:#f1fa8c">&#39;delete&#39;</span>, <span style="color:#f1fa8c">&#39;deletecollection&#39;</span>, <span style="color:#f1fa8c">&#39;annotate&#39;</span>, <span style="color:#f1fa8c">&#39;patch&#39;</span>, <span style="color:#f1fa8c">&#39;label&#39;</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">{</span> apiGroups: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;&#39;</span><span style="color:#ff79c6">]</span>, resources: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;persistentvolumeclaims&#39;</span><span style="color:#ff79c6">]</span>, verbs: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;create&#39;</span>, <span style="color:#f1fa8c">&#39;list&#39;</span>, <span style="color:#f1fa8c">&#39;delete&#39;</span><span style="color:#ff79c6">]}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">{</span> apiGroups: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;scheduling.volcano.sh&#39;</span><span style="color:#ff79c6">]</span>, resources: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;podgroups&#39;</span><span style="color:#ff79c6">]</span>, verbs: <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;get&#39;</span>, <span style="color:#f1fa8c">&#39;list&#39;</span>, <span style="color:#f1fa8c">&#39;watch&#39;</span>, <span style="color:#f1fa8c">&#39;create&#39;</span>, <span style="color:#f1fa8c">&#39;delete&#39;</span>, <span style="color:#f1fa8c">&#39;update&#39;</span><span style="color:#ff79c6">]}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">]</span>,
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">})</span>;
</span></span><span style="display:flex;"><span>emrRole.node.addDependency<span style="color:#ff79c6">(</span>namespace<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>const <span style="color:#8be9fd;font-style:italic">emrRoleBind</span> <span style="color:#ff79c6">=</span> cluster.addManifest<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#39;EMRContainersRoleBind&#39;</span>, <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  apiVersion: <span style="color:#f1fa8c">&#39;rbac.authorization.k8s.io/v1&#39;</span>,
</span></span><span style="display:flex;"><span>  kind: <span style="color:#f1fa8c">&#39;RoleBinding&#39;</span>,
</span></span><span style="display:flex;"><span>  metadata: <span style="color:#ff79c6">{</span> name: <span style="color:#f1fa8c">&#39;emr-containers&#39;</span>, namespace: emrcontainersNamespace <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>  subjects: <span style="color:#ff79c6">[{</span> kind: <span style="color:#f1fa8c">&#39;User&#39;</span>, name: <span style="color:#f1fa8c">&#39;emr-containers&#39;</span>, apiGroup: <span style="color:#f1fa8c">&#39;rbac.authorization.k8s.io&#39;</span> <span style="color:#ff79c6">}]</span>,
</span></span><span style="display:flex;"><span>  roleRef: <span style="color:#ff79c6">{</span> kind: <span style="color:#f1fa8c">&#39;Role&#39;</span>, name: <span style="color:#f1fa8c">&#39;emr-containers&#39;</span>, apiGroup: <span style="color:#f1fa8c">&#39;rbac.authorization.k8s.io&#39;</span> <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">})</span>;
</span></span><span style="display:flex;"><span>emrRoleBind.node.addDependency<span style="color:#ff79c6">(</span>emrRole<span style="color:#ff79c6">)</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>const <span style="color:#8be9fd;font-style:italic">emrContainersRole</span> <span style="color:#ff79c6">=</span> iam.Role.fromRoleName<span style="color:#ff79c6">(</span>this, <span style="color:#f1fa8c">&#39;EMRContainersRole&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#39;AWSServiceRoleForAmazonEMRContainers&#39;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cluster.awsAuth.addRoleMapping<span style="color:#ff79c6">(</span>emrContainersRole, <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  username: <span style="color:#f1fa8c">&#34;emr-containers&#34;</span>,
</span></span><span style="display:flex;"><span>  groups: <span style="color:#ff79c6">[]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">})</span>
</span></span></code></pre></div><h2 id="register-the-clusterhttpsdocsawsamazoncomemrlatestemr-on-eks-developmentguidesetting-up-registrationhtml"><a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/setting-up-registration.html">Register the cluster</a></h2>
<p>Register the cluster to EMR.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">new</span> emrcontainers.CfnVirtualCluster(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;virtual-cluster&#39;</span>, {
</span></span><span style="display:flex;"><span>  name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;test_virtual_cluster&#39;</span>,
</span></span><span style="display:flex;"><span>  containerProvider<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    id: <span style="color:#8be9fd">cluster.clusterName</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">type</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;EKS&#39;</span>,
</span></span><span style="display:flex;"><span>    info<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      eksInfo<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">namespace</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><h2 id="create-an-execution-rolehttpsdocsawsamazoncomemrlatestemr-on-eks-developmentguideiam-execution-rolehtml"><a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/iam-execution-role.html">Create an execution role</a></h2>
<p>Create a Role used for Job execution.
Set a trust policy so that ServiceAccount for EMR on EKS, which is created when submitting a job, can assume it with OIDC.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>createJobExecutionRole(cluster: <span style="color:#8be9fd">eks.Cluster</span>, emrcontainersNamespace: <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> roleName <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;emr-on-eks-test-job-execution-role&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> bs36 <span style="color:#ff79c6">=</span> basex(<span style="color:#f1fa8c">&#34;0123456789abcdefghijklmnopqrstuvwxyz&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> base36RoleName <span style="color:#ff79c6">=</span> bs36.encode(<span style="color:#ff79c6">new</span> TextEncoder().encode(roleName))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> iam.Role(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;EMRJobExecutionRole&#39;</span>, {
</span></span><span style="display:flex;"><span>    roleName: <span style="color:#8be9fd">roleName</span>,
</span></span><span style="display:flex;"><span>    assumedBy: <span style="color:#8be9fd">new</span> iam.WebIdentityPrincipal(
</span></span><span style="display:flex;"><span>      cluster.openIdConnectProvider.openIdConnectProviderArn,
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;StringLike&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">new</span> cdk.CfnJson(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;JobExecutionRoleStringEquals&#39;</span>, {
</span></span><span style="display:flex;"><span>          value<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>            [<span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>cluster.clusterOpenIdConnectIssuer<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:sub`</span>]<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">`system:serviceaccount:</span><span style="color:#f1fa8c">${</span>emrcontainersNamespace<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:emr-containers-sa-*-*-</span><span style="color:#f1fa8c">${</span><span style="color:#ff79c6">this</span>.account<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">-</span><span style="color:#f1fa8c">${</span>base36RoleName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>    inlinePolicies<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#39;job-execution-policy&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">new</span> iam.PolicyDocument({
</span></span><span style="display:flex;"><span>        statements<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>            effect: <span style="color:#8be9fd">iam.Effect.ALLOW</span>,
</span></span><span style="display:flex;"><span>            actions<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>              <span style="color:#f1fa8c">&#39;s3:PutObject&#39;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#f1fa8c">&#39;s3:GetObject&#39;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#f1fa8c">&#39;s3:ListBucket&#39;</span>
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            resources<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;arn:aws:s3:::*&#39;</span>],
</span></span><span style="display:flex;"><span>          }),
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>            effect: <span style="color:#8be9fd">iam.Effect.ALLOW</span>,
</span></span><span style="display:flex;"><span>            actions<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>              <span style="color:#f1fa8c">&#39;logs:PutLogEvents&#39;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#f1fa8c">&#39;logs:CreateLogStream&#39;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#f1fa8c">&#39;logs:DescribeLogGroups&#39;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#f1fa8c">&#39;logs:DescribeLogStreams&#39;</span>
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            resources<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;arn:aws:logs:*:*:*&#39;</span>],
</span></span><span style="display:flex;"><span>          })
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>      })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Following command can add the trust policy as well.
If you get an error after this, you would be good to check that what was added with this command matches what was created with CDK.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">EXECUTION_ROLE_NAME</span><span style="color:#ff79c6">=</span>emr-on-eks-test-job-execution-role
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ aws emr-containers update-role-trust-policy <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --cluster-name <span style="color:#8be9fd;font-style:italic">$CLUSTER_NAME</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --namespace <span style="color:#8be9fd;font-style:italic">$NAMESPACE</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --role-name <span style="color:#8be9fd;font-style:italic">$EXECUTION_ROLE_NAME</span>
</span></span><span style="display:flex;"><span>Successfully updated trust policy of role emr-on-eks-test-job-execution-role
</span></span></code></pre></div><h2 id="run-spark-jobs">Run Spark jobs</h2>
<p>start-job-run launches pods. If the resource is insufficient, it will be pending.
If the driver fails with S3 AccessDenied, execution-role may be failed to be assumed, so check if trust policy and IAM OIDC provider are registered.</p>
<p>Enable <a href="https://spark.apache.org/docs/latest/configuration.html#dynamic-allocation">dynamic resource allocation (DAR)</a> to increase or decrease the number of executors based on demand.
Spark on Kubernetes doesn&rsquo;t support external shuffle service for now, so you need to enable shuffle file tracking instead to prevent executors storing shuffle data from being removed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">VIRTUAL_CLUSTER_ID</span><span style="color:#ff79c6">=</span>xxxxx
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">EXECUTION_ROLE_ARN</span><span style="color:#ff79c6">=</span>arn:aws:iam::xxxxx:role/emr-on-eks-test-job-execution-role
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ aws emr-containers start-job-run <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --virtual-cluster-id <span style="color:#8be9fd;font-style:italic">$VIRTUAL_CLUSTER_ID</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --name pi-2 <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --execution-role-arn <span style="color:#8be9fd;font-style:italic">$EXECUTION_ROLE_ARN</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --release-label emr-6.13.0-latest <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --job-driver <span style="color:#f1fa8c">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      &#34;sparkSubmitJobDriver&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          &#34;entryPoint&#34;: &#34;s3://&lt;mybucket&gt;/pi.py&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          &#34;sparkSubmitParameters&#34;: &#34;--conf spark.executor.instances=1 --conf spark.executor.memory=2G --conf spark.executor.cores=1 --conf spark.driver.cores=1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  }&#39;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --configuration-overrides <span style="color:#f1fa8c">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;monitoringConfiguration&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      &#34;persistentAppUI&#34;: &#34;ENABLED&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      &#34;s3MonitoringConfiguration&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;logUri&#34;: &#34;s3://&lt;mybucket&gt;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    },
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;applicationConfiguration&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;classification&#34;: &#34;spark-defaults&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;properties&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          &#34;spark.dynamicAllocation.enabled&#34;:&#34;true&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          &#34;spark.dynamicAllocation.shuffleTracking.enabled&#34;:&#34;true&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          &#34;spark.dynamicAllocation.minExecutors&#34;:&#34;1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          &#34;spark.dynamicAllocation.maxExecutors&#34;:&#34;100&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          &#34;spark.dynamicAllocation.initialExecutors&#34;:&#34;1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  }&#39;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>$ kubectl get pod -n emrcontainers
</span></span><span style="display:flex;"><span>NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>000000032u7ddboo153-p52fj          3/3     Running    <span style="color:#bd93f9">0</span>          53s
</span></span><span style="display:flex;"><span>pythonpi-a6561a8bc76bc424-exec-1   1/2     NotReady   <span style="color:#bd93f9">0</span>          25s
</span></span><span style="display:flex;"><span>pythonpi-a6561a8bc76bc424-exec-2   0/2     Pending    <span style="color:#bd93f9">0</span>          17s
</span></span><span style="display:flex;"><span>spark-000000032u7ddboo153-driver   1/2     NotReady   <span style="color:#bd93f9">0</span>          40s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ aws s3 cp s3://&lt;mybucket&gt;/&lt;cluster_id&gt;/jobs/&lt;job_id&gt;/containers/spark-000000032psj6spu6q7/spark-000000032psj6spu6q7-driver/stdout.gz .
</span></span><span style="display:flex;"><span>$ gzcat stdout.gz
</span></span><span style="display:flex;"><span>Pi is roughly 3.140920
</span></span></code></pre></div><p>If you <a href="https://aws.github.io/aws-emr-containers-best-practices/troubleshooting/docs/change-log-level/">pass log4j2 settings</a> to classification: spark-log4j, you can patch /etc/spark/conf/log4j2.properties.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;classification&#34;</span>: <span style="color:#f1fa8c">&#34;spark-log4j&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;rootLogger.level&#34;</span>: <span style="color:#f1fa8c">&#34;warn&#34;</span>,
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;appender.myapp.type&#34;</span>: <span style="color:#f1fa8c">&#34;RollingFile&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;appender.myapp.name&#34;</span>: <span style="color:#f1fa8c">&#34;MyAppLogFile&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;appender.myapp.filePattern&#34;</span>: <span style="color:#f1fa8c">&#34;/var/log/spark/user/myapp/myapp-%d{MM-dd-yy-HH-mm-ss}-%i.log.gz&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;appender.myapp.policies.type&#34;</span>: <span style="color:#f1fa8c">&#34;Policies&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;appender.myapp.policies.time.type&#34;</span>: <span style="color:#f1fa8c">&#34;TimeBasedTriggeringPolicy&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;appender.myapp.policies.time.interval&#34;</span>: <span style="color:#f1fa8c">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;logger.myapp.name&#34;</span>: <span style="color:#f1fa8c">&#34;net.sambaiz&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;logger.myapp&#34;</span>: <span style="color:#f1fa8c">&#34;debug, MyAppLogFile&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;logger.myapp.additivity&#34;</span>: <span style="color:#f1fa8c">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The rootLogger has an appender of stderr, and stdout/stderr are output to spark.yarn.app.container.log.dir in log4j2.properties, and sent to the destination set in monitoringConfiguration by fluentd sidecar.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ls /var/log/spark/user/spark-******-driver/
</span></span><span style="display:flex;"><span>stderr	stderr-s3-container-log-in-tail.pos  stdout  stdout-s3-container-log-in-tail.pos
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat /etc/fluent/fluent.conf
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>&lt;source&gt;
</span></span><span style="display:flex;"><span>  @type tail
</span></span><span style="display:flex;"><span>  path <span style="color:#f1fa8c">&#34;#{ENV[&#39;K8S_SPARK_LOG_URL_STDERR&#39;]}&#34;</span>
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>&lt;/source&gt;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>&lt;match chicago-spark-s3-container-stdout-logs&gt;
</span></span><span style="display:flex;"><span>  @type s3
</span></span><span style="display:flex;"><span>  s3_bucket &lt;mybucket&gt;
</span></span><span style="display:flex;"><span>  s3_region &lt;region&gt;
</span></span><span style="display:flex;"><span>  path <span style="color:#f1fa8c">&#34;emr-logs/****/containers/#{ENV[&#39;SPARK_APPLICATION_ID&#39;]}/#{ENV[&#39;SPARK_CONTAINER_ID&#39;]}&#34;</span>
</span></span><span style="display:flex;"><span>  s3_object_key_format %<span style="color:#ff79c6">{</span>path<span style="color:#ff79c6">}</span>/stdout.gz
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>&lt;/match&gt;
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Therefore, if you output logs to stdout, you can send them separately from the Spark logs.
Besides, if you use logger that doesn&rsquo;t have appenders of stdout/stderr and additivity is false, it won&rsquo;t be sent.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> net.sambaiz.myapp
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.log4j.Logger
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">object</span> <span style="color:#50fa7b">MyApp</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>input<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">])</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> logger <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Logger</span><span style="color:#ff79c6">.</span>getLogger<span style="color:#ff79c6">(</span>getClass<span style="color:#ff79c6">().</span>getName<span style="color:#ff79c6">())</span>
</span></span><span style="display:flex;"><span>    println<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;aaaa&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#ff79c6">.</span>warn<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bbbb&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>You can pass a <a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/pod-templates.html">pod template</a> with &ldquo;spark.kubernetes.(driver|executor).podTemplateFile=s3://bucket/template.yml&rdquo; to <a href="https://aws.amazon.com/blogs/big-data/stream-amazon-emr-on-eks-logs-to-third-party-providers-like-splunk-amazon-opensearch-service-or-other-log-aggregators/">add</a> a fluentbit sidecar for your own logs, or <a href="https://github.com/aws-samples/emr-on-eks-for-transient-emr-clusters/blob/aac00b5223813056001fd610deed56ce0a2155d4/scripts/8-pod-templates.sh">spcify</a> priorityClassName etc.</p>
<p><a href="https://www.sambaiz.net/en/article/481/">Priority of K8s pods and preemption - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Pod
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">priorityClassName</span>: low-priority
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">name</span>: spark-kubernetes-driver
</span></span></code></pre></div><h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="table_or_view_not_found-when-referring-to-the-glue-data-catalog">TABLE_OR_VIEW_NOT_FOUND when referring to the Glue Data Catalog</h3>
<p>When referring Glue Data Catalog, TABLE_OR_VIEW_NOT_FOUND error occurs unless the following settings are added.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>--configuration-overrides <span style="color:#f1fa8c">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;applicationConfiguration&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            &#34;classification&#34;: &#34;spark-defaults&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            &#34;properties&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">                &#34;spark.hadoop.hive.metastore.client.factory.class&#34;: &#34;com.amazonaws.glue.catalog.metastore.AWSGlueDataCatalogHiveClientFactory&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">                &#34;spark.sql.catalogImplementation&#34;: &#34;hive&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">}&#39;</span>
</span></span></code></pre></div><h3 id="diskpressure-on-the-node">DiskPressure on the node</h3>
<p>If shuffled data does not fit into memory, spill will occur and the data will be <a href="https://spark.apache.org/docs/latest/running-on-kubernetes.html#local-storage">written</a> to storage. By default, the written volume is emptyDir, which can cause disk pressure on the node.</p>
<p><a href="https://www.sambaiz.net/en/article/476/">Pods evicted without waiting for terminationGracePeriodSeconds due to lack resources of Kubernetes nodes - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#ff79c6">emptyDir</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: spark-local-dir-1
</span></span></code></pre></div><p>By configuring the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;spark.kubernetes.executor.volumes.persistentVolumeClaim.spark-local-dir-1.options.claimName&#34;</span>: <span style="color:#f1fa8c">&#34;OnDemand&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;spark.kubernetes.executor.volumes.persistentVolumeClaim.spark-local-dir-1.options.storageClass&#34;</span>: <span style="color:#f1fa8c">&#34;gp2&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;spark.kubernetes.executor.volumes.persistentVolumeClaim.spark-local-dir-1.options.sizeLimit&#34;</span>: <span style="color:#f1fa8c">&#34;50Gi&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;spark.kubernetes.executor.volumes.persistentVolumeClaim.spark-local-dir-1.mount.path&#34;</span>: <span style="color:#f1fa8c">&#34;/data&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;spark.kubernetes.executor.volumes.persistentVolumeClaim.spark-local-dir-1.mount.readOnly&#34;</span>: <span style="color:#f1fa8c">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>you can dynamically create PVCs and mount EBS, etc.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#ff79c6">name</span>: spark-local-dir-1
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">claimName</span>: testjob-xxxxxx-exec-1-pvc-0
</span></span></code></pre></div><p>Install the corresponding <a href="https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi.html">CSI driver</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> role <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> iam.Role(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;EBSCSIRole&#39;</span>, {
</span></span><span style="display:flex;"><span>  assumedBy: <span style="color:#8be9fd">new</span> iam.WebIdentityPrincipal(
</span></span><span style="display:flex;"><span>    cluster.openIdConnectProvider.openIdConnectProviderArn,
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      StringEquals: <span style="color:#8be9fd">new</span> CfnJson(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;EBSCSIRoleStringEquals&#39;</span>, {
</span></span><span style="display:flex;"><span>        value<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>            [<span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>cluster.clusterOpenIdConnectIssuer<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:aud`</span>]<span style="color:#ff79c6">:</span> 
</span></span><span style="display:flex;"><span>              <span style="color:#f1fa8c">&#39;sts.amazonaws.com&#39;</span>,
</span></span><span style="display:flex;"><span>            [<span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>cluster.clusterOpenIdConnectIssuer<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:sub`</span>]<span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f1fa8c">&#39;system:serviceaccount:kube-system:ebs-csi-controller-sa&#39;</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      }),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ),
</span></span><span style="display:flex;"><span>  managedPolicies<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>    iam.ManagedPolicy.fromAwsManagedPolicyName(<span style="color:#f1fa8c">&#39;service-role/AmazonEBSCSIDriverPolicy&#39;</span>)
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">new</span> eks.CfnAddon(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;EBSCSIAddon&#39;</span>, {
</span></span><span style="display:flex;"><span>  addonName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;aws-ebs-csi-driver&#39;</span>,
</span></span><span style="display:flex;"><span>  clusterName: <span style="color:#8be9fd">cluster.clusterName</span>,
</span></span><span style="display:flex;"><span>  serviceAccountRoleArn:<span style="color:#8be9fd">role.roleArn</span>,
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><h3 id="job-failure-due-to-sparkcontext-was-shut-down">Job failure due to SparkContext was shut down</h3>
<p>If job-submitter or driver pods are stopped due to node scaling, SparkContext shuts down and the job fails,
so you should avoid this by adding <a href="https://spark.apache.org/docs/latest/running-on-kubernetes.html#configuration">spark.kubernetes.driver.annotation.&lt;AnnotationName&gt;</a> etc.
However, this method is currently not available for job-submitter, so you need to specify nodes in a node group that doesn&rsquo;t scale with nodeSelector, or add the annotation in some way.</p>
<p><a href="https://www.sambaiz.net/en/article/455/">Install Karpenter on an EKS cluster with CDK to auto-scale flexibility and quickly - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&#34;spark.kubernetes.driver.annotation.karpenter.sh/do-not-disrupt&#34;: &#34;true&#34;
</span></span><span style="display:flex;"><span>&#34;jobsubmitter.node.selector.&lt;label&gt;&#34;: &#34;&lt;value&gt;&#34;,
</span></span></code></pre></div><h3 id="permissiondenied-when-using-aws-sdk">PermissionDenied when using AWS SDK</h3>
<p>Information you need to assume the execution role is in environment variables AWS_ROLE_ARN and AWS_WEB_IDENTITY_TOKEN_FILE, but
if &ldquo;software.amazon.awssdk&rdquo; % &ldquo;sts&rdquo; isn&rsquo;t included in dependency,<br>
AWS SDK for Java outputs the following WARN logs and uses the instance profile&rsquo;s role with <a href="https://sdk.amazonaws.com/java/api/latest/software/amazon/awssdk/auth/credentials/DefaultCredentialsProvider.html">lower order</a> instead.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>WARN WebIdentityCredentialsUtils: To use web identity tokens, the &#39;sts&#39; service module must be on the class path.
</span></span></code></pre></div><h2 id="references">References</h2>
<p><a href="https://qiita.com/watany/items/daf433338de5b6858ed6">EKS Cluster v1.22以降の作り方がCDKで変わった話 #AWS - Qiita</a></p>
<p><a href="https://medium.com/@oiuypp00/how-to-make-robust-emr-on-eks-pipelines-scheduling-by-airflow-e53b15c78ea9">How to Make Robust EMR on EKS pipelines + Airflow | by Jun Seokjun Han | Medium</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>