<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Register an EKS cluster launched with CDK to EMR on EKS and run Spark jobs - sambaiz-net</title>
  <meta name="twitter:title" content="Register an EKS cluster launched with CDK to EMR on EKS and run Spark jobs - sambaiz-net">
  <meta property='og:title' content="Register an EKS cluster launched with CDK to EMR on EKS and run Spark jobs - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="While normal EMR also manages Hadoop clusters, EMR on EKS is only responsible for starting containers">
  <meta name="twitter:description" content="While normal EMR also manages Hadoop clusters, EMR on EKS is only responsible for starting containers">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/434/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/434/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/434/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/434/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Register an EKS cluster launched with CDK to EMR on EKS and run Spark jobs",
    "datePublished": "2023-01-02T14:53:00JST",
    "dateModified": "2023-01-02T14:53:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "While normal EMR also manages Hadoop clusters, EMR on EKS is only responsible for starting containers"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/434/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/ios/">
            ios</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Register an EKS cluster launched with CDK to EMR on EKS and run Spark jobs</h1>
        <time>2023-01-02</time>
        <a class="tag" href='/en/tags/kubernetes/'>kubernetes</a><a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/spark/'>spark</a><a class="tag" href='/en/tags/etl/'>etl</a>
      </div>
      <p><a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/emr-eks.html">EMR on EKS</a> is a feature to run Spark on EKS.
While normal EMR also manages Hadoop clusters, EMR on EKS is only responsible for starting containers.</p>
<p><a href="https://www.sambaiz.net/en/article/409/">Launch an EMR cluster with AWS CLI and run Spark applications - sambaiz-net</a></p>
<p>By running on Kubernetes, you can use tools and functions for Kubernetes to manage and monitor, and utilize resources left over if you have an existing cluster.
It also enables to use knowledge about Kubernetes learned from other applications for aggregation and analysis, and also may be vice versa.
However, some knowledge about Kubernetes and EKS is required.
You can start using normal EMR without knowledge of YARN, but I think EMR on EKS will be difficult to even operate with no knowledge.</p>
<p>By the way, Docker is <a href="https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-plan-docker.html">supported</a> from EMR 6.x (Hadoop 3).</p>
<p><a href="https://aws.amazon.com/emr/pricing/?nc1=h_ls">Pricing</a> is based on requested the amount of vCPU and memory.</p>
<h2 id="launch-a-cluster">Launch a cluster</h2>
<p>Launch an EKS cluster with CDK.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">as</span> cdk <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#39;aws-cdk-lib&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> { Construct } <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#39;constructs&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">as</span> iam <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#39;aws-cdk-lib/aws-iam&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">as</span> ec2 <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#39;aws-cdk-lib/aws-ec2&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">as</span> eks <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#39;aws-cdk-lib/aws-eks&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> vpc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ec2.Vpc(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;vpc&#39;</span>, {
</span></span><span style="display:flex;"><span>  cidr<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;10.0.0.0/16&#39;</span>,
</span></span><span style="display:flex;"><span>  maxAzs: <span style="color:#8be9fd">2</span>,
</span></span><span style="display:flex;"><span>  subnetConfiguration<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      cidrMask: <span style="color:#8be9fd">18</span>,
</span></span><span style="display:flex;"><span>      name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;public&#39;</span>,
</span></span><span style="display:flex;"><span>      subnetType: <span style="color:#8be9fd">ec2.SubnetType.PUBLIC</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      cidrMask: <span style="color:#8be9fd">18</span>,
</span></span><span style="display:flex;"><span>      name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;private&#39;</span>,
</span></span><span style="display:flex;"><span>      subnetType: <span style="color:#8be9fd">ec2.SubnetType.PRIVATE_WITH_EGRESS</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>cdk.Tags.<span style="color:#ff79c6">of</span>(vpc).add(<span style="color:#f1fa8c">&#34;Name&#34;</span>, <span style="color:#ff79c6">this</span>.stackName)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> mastersRole <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> iam.Role(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;masters-role&#39;</span>, {
</span></span><span style="display:flex;"><span>  assumedBy: <span style="color:#8be9fd">new</span> iam.CompositePrincipal(
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">new</span> iam.ServicePrincipal(<span style="color:#f1fa8c">&#39;eks.amazonaws.com&#39;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">new</span> iam.AccountRootPrincipal(),
</span></span><span style="display:flex;"><span>  ),
</span></span><span style="display:flex;"><span>  managedPolicies<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>    iam.ManagedPolicy.fromAwsManagedPolicyName(<span style="color:#f1fa8c">&#39;AmazonEKSClusterPolicy&#39;</span>),
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  inlinePolicies<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;eksctl-iamidentitymapping&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">new</span> iam.PolicyDocument({
</span></span><span style="display:flex;"><span>      statements<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>          effect: <span style="color:#8be9fd">iam.Effect.ALLOW</span>,
</span></span><span style="display:flex;"><span>          actions<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;eks:DescribeCluster&#39;</span>],
</span></span><span style="display:flex;"><span>          resources<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;*&#39;</span>],
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> eks.Cluster(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;cluster&#39;</span>, {
</span></span><span style="display:flex;"><span>  vpc,
</span></span><span style="display:flex;"><span>  mastersRole,
</span></span><span style="display:flex;"><span>  clusterName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;emr-on-eks-test&#39;</span>,
</span></span><span style="display:flex;"><span>  version: <span style="color:#8be9fd">eks.KubernetesVersion.V1_23</span>,
</span></span><span style="display:flex;"><span>  defaultCapacity: <span style="color:#8be9fd">3</span>,
</span></span><span style="display:flex;"><span>  defaultCapacityInstance: <span style="color:#8be9fd">new</span> ec2.InstanceType(<span style="color:#f1fa8c">&#39;m5.large&#39;</span>)
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>&ldquo;eksctl create iamidentitymapping&rdquo; to be executed later requires eks:DescribeCluster in addition to Kubernetes permissions, so I attached the policy to the master role and set the profile to assume the role.
Alternatively, you can add user roles to aws-auth to give Kubernetes permissions to it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ brew tap weaveworks/tap
</span></span><span style="display:flex;"><span>$ brew install weaveworks/tap/eksctl
</span></span><span style="display:flex;"><span>$ eksctl version
</span></span><span style="display:flex;"><span>0.124.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat ~/.aws/config
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>profile eks-master<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">region</span> <span style="color:#ff79c6">=</span> ap-northeast-1
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">role_arn</span> <span style="color:#ff79c6">=</span> arn:aws:iam::xxxxx:role/EmrOnEksTestStack-clusterMastersRoleEABFBB9C-10Q5X4BE7QN51
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">source_profile</span> <span style="color:#ff79c6">=</span> &lt;user_profile_name&gt; 
</span></span></code></pre></div><h2 id="grant-the-cluster-accesshttpsdocsawsamazoncomemrlatestemr-on-eks-developmentguidesetting-up-cluster-accesshtml"><a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/setting-up-cluster-access.html">Grant the cluster access</a></h2>
<p>Bind a Kubernetes role to a user linked to <a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/using-service-linked-roles.html">service-linked role</a> for EMR on EKS.</p>
<p><a href="https://www.sambaiz.net/article/160/">RBACが有効なGKEでHelmを使う - sambaiz-net</a></p>
<p>You can do that manually, but the following command automatically adds resources and settings.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">CLUSTER_NAME</span><span style="color:#ff79c6">=</span>emr-on-eks-test
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">NAMESPACE</span><span style="color:#ff79c6">=</span>default
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ eksctl create iamidentitymapping <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --cluster <span style="color:#8be9fd;font-style:italic">$CLUSTER_NAME</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --namespace <span style="color:#8be9fd;font-style:italic">$NAMESPACE</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --service-name emr-containers <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --profile eks-master
</span></span><span style="display:flex;"><span>2022-12-31 17:40:34 <span style="color:#ff79c6">[</span>ℹ<span style="color:#ff79c6">]</span>  created <span style="color:#f1fa8c">&#34;default:Role.rbac.authorization.k8s.io/emr-containers&#34;</span>
</span></span><span style="display:flex;"><span>2022-12-31 17:40:34 <span style="color:#ff79c6">[</span>ℹ<span style="color:#ff79c6">]</span>  created <span style="color:#f1fa8c">&#34;default:RoleBinding.rbac.authorization.k8s.io/emr-containers&#34;</span>
</span></span><span style="display:flex;"><span>2022-12-31 17:40:34 <span style="color:#ff79c6">[</span>ℹ<span style="color:#ff79c6">]</span>  adding identity <span style="color:#f1fa8c">&#34;arn:aws:iam::xxxxx:role/AWSServiceRoleForAmazonEMRContainers&#34;</span> to auth ConfigMap
</span></span></code></pre></div><p>It can be confirmed that a role is bound.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ kubectl describe -n kube-system configmap aws-auth
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>mapRoles:
</span></span><span style="display:flex;"><span>  ----
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>- rolearn: arn:aws:iam::xxxxx:role/AWSServiceRoleForAmazonEMRContainers
</span></span><span style="display:flex;"><span>  username: emr-containers
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl get rolebinding -n <span style="color:#8be9fd;font-style:italic">$NAMESPACE</span> emr-containers
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  NAME             ROLE                  AGE
</span></span><span style="display:flex;"><span>  emr-containers   Role/emr-containers   14m
</span></span></code></pre></div><h2 id="register-the-clusterhttpsdocsawsamazoncomemrlatestemr-on-eks-developmentguidesetting-up-registrationhtml"><a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/setting-up-registration.html">Register the cluster</a></h2>
<p>Register the cluster to EMR.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">new</span> emrcontainers.CfnVirtualCluster(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;virtual-cluster&#39;</span>, {
</span></span><span style="display:flex;"><span>  name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;test_virtual_cluster&#39;</span>,
</span></span><span style="display:flex;"><span>  containerProvider<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    id: <span style="color:#8be9fd">cluster.clusterName</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">type</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;EKS&#39;</span>,
</span></span><span style="display:flex;"><span>    info<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      eksInfo<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">namespace</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><h2 id="create-an-execution-rolehttpsdocsawsamazoncomemrlatestemr-on-eks-developmentguideiam-execution-rolehtml"><a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/iam-execution-role.html">Create an execution role</a></h2>
<p>Create a Role with Policy required for Job execution.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">new</span> iam.Role(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;job-exectuion-role&#39;</span>, {
</span></span><span style="display:flex;"><span>  roleName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;emr-on-eks-test-job-execution-role&#34;</span>,
</span></span><span style="display:flex;"><span>  assumedBy: <span style="color:#8be9fd">new</span> iam.AccountRootPrincipal(), <span style="color:#6272a4">// update later
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  inlinePolicies<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;job-execution-policy&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">new</span> iam.PolicyDocument({
</span></span><span style="display:flex;"><span>      statements<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>          effect: <span style="color:#8be9fd">iam.Effect.ALLOW</span>,
</span></span><span style="display:flex;"><span>          actions<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;s3:PutObject&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;s3:GetObject&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;s3:ListBucket&#39;</span>,
</span></span><span style="display:flex;"><span>          ],
</span></span><span style="display:flex;"><span>          resources<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;arn:aws:s3:::*&#39;</span>],
</span></span><span style="display:flex;"><span>        }),
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>          effect: <span style="color:#8be9fd">iam.Effect.ALLOW</span>,
</span></span><span style="display:flex;"><span>          actions<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;logs:PutLogEvents&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;logs:CreateLogStream&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;logs:DescribeLogGroups&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;logs:DescribeLogStreams&#39;</span>
</span></span><span style="display:flex;"><span>          ],
</span></span><span style="display:flex;"><span>          resources<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;arn:aws:logs:*:*:*&#39;</span>],
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>The following command adds a trust policy for the EMR on EKS service account that is created when a job is submitted.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">EXECUTION_ROLE_NAME</span><span style="color:#ff79c6">=</span>emr-on-eks-test-job-execution-role
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ aws emr-containers update-role-trust-policy <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --cluster-name <span style="color:#8be9fd;font-style:italic">$CLUSTER_NAME</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --namespace <span style="color:#8be9fd;font-style:italic">$NAMESPACE</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --role-name <span style="color:#8be9fd;font-style:italic">$EXECUTION_ROLE_NAME</span>
</span></span><span style="display:flex;"><span>Successfully updated trust policy of role emr-on-eks-test-job-execution-role
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;Effect&#34;</span>: <span style="color:#f1fa8c">&#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;Principal&#34;</span>: <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;Federated&#34;</span>: <span style="color:#f1fa8c">&#34;arn:aws:iam::xxxxx:oidc-provider/oidc.eks.ap-northeast-1.amazonaws.com/id/aaaaa&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;Action&#34;</span>: <span style="color:#f1fa8c">&#34;sts:AssumeRoleWithWebIdentity&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;Condition&#34;</span>: <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;StringLike&#34;</span>: <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;oidc.eks.ap-northeast-1.amazonaws.com/id/aaaaa:sub&#34;</span>: <span style="color:#f1fa8c">&#34;system:serviceaccount:default:emr-containers-sa-*-*-xxxxx-&lt;BASE36_ENCODED_ROLE_NAME&gt;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>The issuer url of the cluster can be obtained with the following command.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ aws eks describe-cluster --name <span style="color:#8be9fd;font-style:italic">$CLUSTER_NAME</span> --query <span style="color:#f1fa8c">&#34;cluster.identity.oidc.issuer&#34;</span> --output text 
</span></span><span style="display:flex;"><span>https://oidc.eks.ap-northeast-1.amazonaws.com/id/aaaaa
</span></span></code></pre></div><p>Register it to IAM OIDC providers.</p>
<p><a href="https://www.sambaiz.net/en/article/421/">Create a role that can assume with OIDC from GitHub Actions with CDK - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ eksctl utils associate-iam-oidc-provider --cluster <span style="color:#8be9fd;font-style:italic">$CLUSTER_NAME</span> --approve
</span></span><span style="display:flex;"><span>2023-01-02 13:39:28 <span style="color:#ff79c6">[</span>ℹ<span style="color:#ff79c6">]</span>  will create IAM Open ID Connect provider <span style="color:#ff79c6">for</span> cluster <span style="color:#f1fa8c">&#34;emr-on-eks-test&#34;</span> in <span style="color:#f1fa8c">&#34;ap-northeast-1&#34;</span>
</span></span><span style="display:flex;"><span>2023-01-02 13:39:29 <span style="color:#ff79c6">[</span>✔<span style="color:#ff79c6">]</span>  created IAM Open ID Connect provider <span style="color:#ff79c6">for</span> cluster <span style="color:#f1fa8c">&#34;emr-on-eks-test&#34;</span> in <span style="color:#f1fa8c">&#34;ap-northeast-1&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ aws iam list-open-id-connect-providers 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;OpenIDConnectProviderList&#34;</span>: <span style="color:#ff79c6">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;Arn&#34;</span>: <span style="color:#f1fa8c">&#34;arn:aws:iam::xxxxx:oidc-provider/oidc.eks.ap-northeast-1.amazonaws.com/id/aaaaa&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>        ....
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h2 id="run-spark-jobs">Run Spark jobs</h2>
<p>start-job-run launches pods. If the resource is insufficient, it will be pending.
If the driver fails with S3 AccessDenied, execution-role may be failed to be assumed, so check if trust policy and IAM OIDC provider are registered.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">VIRTUAL_CLUSTER_ID</span><span style="color:#ff79c6">=</span>xxxxx
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">EXECUTION_ROLE_ARN</span><span style="color:#ff79c6">=</span>arn:aws:iam::xxxxx:role/emr-on-eks-test-job-execution-role
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ aws emr-containers start-job-run <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --virtual-cluster-id <span style="color:#8be9fd;font-style:italic">$VIRTUAL_CLUSTER_ID</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --name pi-2 <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --execution-role-arn <span style="color:#8be9fd;font-style:italic">$EXECUTION_ROLE_ARN</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --release-label emr-6.7.0-latest <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --job-driver <span style="color:#f1fa8c">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      &#34;sparkSubmitJobDriver&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          &#34;entryPoint&#34;: &#34;s3://aws-data-analytics-workshops/emr-eks-workshop/scripts/pi.py&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          &#34;sparkSubmitParameters&#34;: &#34;--conf spark.executor.instances=1 --conf spark.executor.memory=2G --conf spark.executor.cores=1 --conf spark.driver.cores=1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  }&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;id&#34;</span>: <span style="color:#f1fa8c">&#34;000000031bdlkdo0q1k&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;pi-2&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;arn&#34;</span>: <span style="color:#f1fa8c">&#34;arn:aws:emr-containers:ap-northeast-1:xxxxx:/virtualclusters/xxxxx/jobruns/000000031bdlkdo0q1k&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;virtualClusterId&#34;</span>: <span style="color:#f1fa8c">&#34;xxxxx&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl get pod
</span></span><span style="display:flex;"><span>NAME                               READY   STATUS              RESTARTS   AGE
</span></span><span style="display:flex;"><span>000000031bdlkdo0q1k-sn72c          2/2     Running             <span style="color:#bd93f9">0</span>          21s
</span></span><span style="display:flex;"><span>pythonpi-c4ae29856dad6d33-exec-1   0/1     ContainerCreating   <span style="color:#bd93f9">0</span>          1s
</span></span><span style="display:flex;"><span>spark-000000031bdlkdo0q1k-driver   2/2     Running             <span style="color:#bd93f9">0</span>          12s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl describe pod spark-000000031bdlkdo0q1k-driver
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>spark-kubernetes-driver:
</span></span><span style="display:flex;"><span>  Image:         059004520145.dkr.ecr.ap-northeast-1.amazonaws.com/spark/emr-6.7.0:latest
</span></span><span style="display:flex;"><span>  Args:
</span></span><span style="display:flex;"><span>      driver
</span></span><span style="display:flex;"><span>      --properties-file
</span></span><span style="display:flex;"><span>      /usr/lib/spark/conf/spark.properties
</span></span><span style="display:flex;"><span>      --class
</span></span><span style="display:flex;"><span>      org.apache.spark.deploy.PythonRunner
</span></span><span style="display:flex;"><span>      local:///usr/lib/spark/examples/src/main/python/pi.py
</span></span><span style="display:flex;"><span>  ...
</span></span></code></pre></div>
    </div>
  </article>
</div>

</div>
</body>

</html>