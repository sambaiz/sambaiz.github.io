<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 30px;
        height: 30px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .share-button > img {
        border: none;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .share {
        position: relative;
        text-align: right;
        margin-top: 5px;
    }

    .share .cell {
        display: inline-block;
        text-align: center;
        margin-bottom: 5px;
    }

    .share-button {
        display: inline-block;
        margin: 0 5px;
    }

    @media screen and (min-width: 1400px) {
        .share .cell {
            position: absolute;
            bottom: 0;
            margin-left: 5px;
        }

        .share-button {
            display: inline-block;
            margin: 5px 0;
        }
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Why can Athena v2 fail to query map columns in parquet source tables - sambaiz-net</title>
  <meta name="twitter:title" content="Why can Athena v2 fail to query map columns in parquet source tables - sambaiz-net">
  <meta property='og:title' content="Why can Athena v2 fail to query map columns in parquet source tables - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="Output logs containing map fields as json etc., convert it to parquet with Glue Studio, and execute queries with Athena, then the queries can succeed or fail depending on the table">
  <meta name="twitter:description" content="Output logs containing map fields as json etc., convert it to parquet with Glue Studio, and execute queries with Athena, then the queries can succeed or fail depending on the table">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/415/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/415/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/415/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/415/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Why can Athena v2 fail to query map columns in parquet source tables",
    "datePublished": "2022-08-16T21:26:00JST",
    "dateModified": "2022-08-16T21:26:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "Output logs containing map fields as json etc., convert it to parquet with Glue Studio, and execute queries with Athena, then the queries can succeed or fail depending on the table"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/415/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.goodreads.com/sambaiz">
            <img src="/image/goodreads.svg" width="30px" height="30px" alt="goodreads">
          </a>
        </div>
        <div class="sns-item">
          <a href="https://filmarks.com/users/sambaiz" class="filmarks" aria-label="filmarks"></a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/tensorflow/">
            tensorflow</a>
          
          <a class="tag" href="/tags/ios/">
            ios</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Why can Athena v2 fail to query map columns in parquet source tables</h1>
        <time>2022-08-16</time>
        <a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/serialize/'>serialize</a>
      </div>
      <p>Output logs containing map fields as json etc., convert it to parquet with Glue Studio, and execute queries with Athena, then the queries can succeed or fail depending on the table.</p>
<p><a href="https://www.sambaiz.net/en/article/386/">Columnar format Parquet structure and read optimization - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">type</span> Log <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    A <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>=&gt; {<span style="color:#f1fa8c">&#34;A&#34;</span>:{<span style="color:#f1fa8c">&#34;B&#34;</span>:<span style="color:#bd93f9">10</span>,<span style="color:#f1fa8c">&#34;C&#34;</span>:<span style="color:#bd93f9">20</span>}}
</span></span></code></pre></div><p>The parquet metadata is as follows and the information about map is lost.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ parquet meta test.parquet
</span></span><span style="display:flex;"><span>File path:  test.parquet
</span></span><span style="display:flex;"><span>Created by: parquet-glue version 1.8.2
</span></span><span style="display:flex;"><span>Properties:
</span></span><span style="display:flex;"><span>  org.apache.spark.sql.parquet.row.metadata: <span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;type&#34;</span>:<span style="color:#f1fa8c">&#34;struct&#34;</span>,<span style="color:#f1fa8c">&#34;fields&#34;</span>:<span style="color:#ff79c6">[{</span><span style="color:#f1fa8c">&#34;name&#34;</span>:<span style="color:#f1fa8c">&#34;A&#34;</span>,<span style="color:#f1fa8c">&#34;type&#34;</span>:<span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;type&#34;</span>:<span style="color:#f1fa8c">&#34;struct&#34;</span>,<span style="color:#f1fa8c">&#34;fields&#34;</span>:<span style="color:#ff79c6">[{</span><span style="color:#f1fa8c">&#34;name&#34;</span>:<span style="color:#f1fa8c">&#34;B&#34;</span>,<span style="color:#f1fa8c">&#34;type&#34;</span>:<span style="color:#f1fa8c">&#34;integer&#34;</span>,<span style="color:#f1fa8c">&#34;nullable&#34;</span>:true,<span style="color:#f1fa8c">&#34;metadata&#34;</span>:<span style="color:#ff79c6">{}}</span>,<span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;name&#34;</span>:<span style="color:#f1fa8c">&#34;C&#34;</span>,<span style="color:#f1fa8c">&#34;type&#34;</span>:<span style="color:#f1fa8c">&#34;integer&#34;</span>,<span style="color:#f1fa8c">&#34;nullable&#34;</span>:true,<span style="color:#f1fa8c">&#34;metadata&#34;</span>:<span style="color:#ff79c6">{}}]}</span>,<span style="color:#f1fa8c">&#34;nullable&#34;</span>:true,<span style="color:#f1fa8c">&#34;metadata&#34;</span>:<span style="color:#ff79c6">{}}]}</span>
</span></span><span style="display:flex;"><span>Schema:
</span></span><span style="display:flex;"><span>message glue_schema <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  optional group A <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    optional int32 B;
</span></span><span style="display:flex;"><span>    optional int32 C;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Row group 0:  count: <span style="color:#bd93f9">1</span>  116.00 B records  start: <span style="color:#bd93f9">4</span>  total<span style="color:#ff79c6">(</span>compressed<span style="color:#ff79c6">)</span>: <span style="color:#bd93f9">116</span> B total<span style="color:#ff79c6">(</span>uncompressed<span style="color:#ff79c6">)</span>:112 B 
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>     <span style="color:#8be9fd;font-style:italic">type</span>      encodings count     avg size   nulls   min / max
</span></span><span style="display:flex;"><span>A.B  INT32     S   _     <span style="color:#bd93f9">1</span>         58.00 B    <span style="color:#bd93f9">0</span>       <span style="color:#f1fa8c">&#34;10&#34;</span> / <span style="color:#f1fa8c">&#34;10&#34;</span>
</span></span><span style="display:flex;"><span>A.C  INT32     S   _     <span style="color:#bd93f9">1</span>         58.00 B    <span style="color:#bd93f9">0</span>       <span style="color:#f1fa8c">&#34;20&#34;</span> / <span style="color:#f1fa8c">&#34;20&#34;</span>
</span></span></code></pre></div><p>If set this column type to map, I thought queries always fail, but if both key and value&rsquo;s type are set to value&rsquo;s one, queries themselves succeed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">select</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">from</span> test
</span></span><span style="display:flex;"><span><span style="color:#6272a4">-- struct&lt;B:int,C:int&gt; =&gt; {b=10, c=20}
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">-- map&lt;string,int&gt; =&gt; HIVE_BAD_DATA: Field b&#39;s type INT32 in parquet file s3://***/test.parquet is incompatible with type varchar defined in table schema
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">-- map&lt;int,int&gt; =&gt; {10=20}
</span></span></span></code></pre></div><h2 id="running-presto-on-emr">Running Presto on EMR</h2>
<p>Run Presto on EMR and try to reproduce the error.
<a href="https://docs.aws.amazon.com/emr/latest/ReleaseGuide/emr-presto-glue.html">Set</a> Glue Data Catalog as Hive metastore with &ndash;configurations.</p>
<p><a href="https://www.sambaiz.net/en/article/409/">Launch an EMR cluster with AWS CLI and run Spark applications - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ aws emr create-cluster <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --release-label emr-6.3.1 <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --applications <span style="color:#8be9fd;font-style:italic">Name</span><span style="color:#ff79c6">=</span>Presto <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --instance-type m6g.xlarge <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --instance-count <span style="color:#bd93f9">1</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --use-default-roles <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --enable-debugging <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --log-uri s3n://&lt;bucket&gt;/emrlogs/ <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --name presto_test <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --bootstrap-actions <span style="color:#8be9fd;font-style:italic">Path</span><span style="color:#ff79c6">=</span>s3://&lt;bucket&gt;/install-ssm-agent.sh,Name<span style="color:#ff79c6">=</span>insatall-ssm-agent <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --configurations <span style="color:#f1fa8c">&#39;[
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;Classification&#34;: &#34;presto-connector-hive&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;Properties&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          &#34;hive.metastore&#34;: &#34;glue&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    ]&#39;</span>
</span></span></code></pre></div><p>Went inside and ran the same query, but it failed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ aws ssm start-session --target &lt;instance_id&gt;
</span></span><span style="display:flex;"><span>$ presto-cli
</span></span><span style="display:flex;"><span>presto&gt; <span style="color:#ff79c6">select</span> * from awsdatacatalog.default.test;
</span></span><span style="display:flex;"><span>Query 20220814_125728_00018_5vv6m failed: The column a of table default.test is declared as <span style="color:#8be9fd;font-style:italic">type</span> map&lt;int,int&gt;, but the Parquet file <span style="color:#ff79c6">(</span>s3://***/test.parquet<span style="color:#ff79c6">)</span> declares the column as <span style="color:#8be9fd;font-style:italic">type</span> optional group a <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  optional int32 b;
</span></span><span style="display:flex;"><span>  optional int32 c;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>Looking at the code the error occurs, <a href="https://github.com/prestodb/presto/commit/5d18a1c01d048bec435e587887bf20ffbe9794f8">type check</a> implemented in Presto v0.226 seems not to be contained in Athena v2 that is based on <a href="https://docs.aws.amazon.com/athena/latest/ug/presto-functions.html">Presto v0.217</a>.</p>
<h2 id="parquet-generation-with-the-explicit-schema">Parquet generation with the explicit schema</h2>
<p>Anyway, it doesn&rsquo;t return the expected result, so generate the parquet with schema that is the same as the table explicitly.
<a href="https://spark.apache.org/docs/latest/sql-data-sources-json.html#data-source-option">mode=&lsquo;PERMISSIVE&rsquo;</a> which is the default parse mode, sets values of mismatched type fields to null, while FAILFAST raises an exception.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> pyspark.sql <span style="color:#ff79c6">import</span> SparkSession
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> pyspark.sql.types <span style="color:#ff79c6">import</span> StructType, StructField, MapType, IntegerType, StringType
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">with</span> SparkSession<span style="color:#ff79c6">.</span>builder<span style="color:#ff79c6">.</span>appName(<span style="color:#f1fa8c">&#34;json_to_parquet&#34;</span>)<span style="color:#ff79c6">.</span>getOrCreate() <span style="color:#ff79c6">as</span> spark:
</span></span><span style="display:flex;"><span>  schema <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>table(<span style="color:#f1fa8c">&#34;default.test&#34;</span>)<span style="color:#ff79c6">.</span>schema <span style="color:#6272a4"># StructType(List(StructField(a,MapType(StringType,IntegerType,true),true)))</span>
</span></span><span style="display:flex;"><span>  schema[<span style="color:#bd93f9">0</span>]<span style="color:#ff79c6">.</span>name <span style="color:#ff79c6">=</span> schema[<span style="color:#bd93f9">0</span>]<span style="color:#ff79c6">.</span>name<span style="color:#ff79c6">.</span>upper()
</span></span><span style="display:flex;"><span>  df <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>read<span style="color:#ff79c6">.</span>schema(schema)<span style="color:#ff79c6">.</span>json(<span style="color:#f1fa8c">&#34;s3://&lt;bucket&gt;/test.json&#34;</span>, mode<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;FAILFAST&#39;</span>)
</span></span><span style="display:flex;"><span>  df<span style="color:#ff79c6">.</span>write<span style="color:#ff79c6">.</span>parquet(<span style="color:#f1fa8c">&#34;s3://&lt;bucket&gt;/&#34;</span>, compression<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gzip&#34;</span>)
</span></span></code></pre></div><p>As a result, the following parquet that contains key and value fields, is output and can be accessed as map&lt;string,int&gt;.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ parquet meta test.parquet 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>File path:  test.parquet
</span></span><span style="display:flex;"><span>Created by: parquet-mr version 1.10.1 <span style="color:#ff79c6">(</span>build 65f31597b18a0f2718a129fd2d69af0168952c55<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>Properties:
</span></span><span style="display:flex;"><span>                   org.apache.spark.version: 3.1.1
</span></span><span style="display:flex;"><span>  org.apache.spark.sql.parquet.row.metadata: <span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;type&#34;</span>:<span style="color:#f1fa8c">&#34;struct&#34;</span>,<span style="color:#f1fa8c">&#34;fields&#34;</span>:<span style="color:#ff79c6">[{</span><span style="color:#f1fa8c">&#34;name&#34;</span>:<span style="color:#f1fa8c">&#34;A&#34;</span>,<span style="color:#f1fa8c">&#34;type&#34;</span>:<span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;type&#34;</span>:<span style="color:#f1fa8c">&#34;map&#34;</span>,<span style="color:#f1fa8c">&#34;keyType&#34;</span>:<span style="color:#f1fa8c">&#34;string&#34;</span>,<span style="color:#f1fa8c">&#34;valueType&#34;</span>:<span style="color:#f1fa8c">&#34;integer&#34;</span>,<span style="color:#f1fa8c">&#34;valueContainsNull&#34;</span>:true<span style="color:#ff79c6">}</span>,<span style="color:#f1fa8c">&#34;nullable&#34;</span>:true,<span style="color:#f1fa8c">&#34;metadata&#34;</span>:<span style="color:#ff79c6">{}}]}</span>
</span></span><span style="display:flex;"><span>Schema:
</span></span><span style="display:flex;"><span>message spark_schema <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  optional group A <span style="color:#ff79c6">(</span>MAP<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    repeated group key_value <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      required binary key <span style="color:#ff79c6">(</span>STRING<span style="color:#ff79c6">)</span>;
</span></span><span style="display:flex;"><span>      optional int32 value;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Row group 0:  count: <span style="color:#bd93f9">1</span>  144.00 B records  start: <span style="color:#bd93f9">4</span>  total: <span style="color:#bd93f9">144</span> B
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>                   <span style="color:#8be9fd;font-style:italic">type</span>      encodings count     avg size   nulls   min / max
</span></span><span style="display:flex;"><span>A.key_value.key    BINARY    G   _     <span style="color:#bd93f9">2</span>         32.00 B    <span style="color:#bd93f9">0</span>       <span style="color:#f1fa8c">&#34;B&#34;</span> / <span style="color:#f1fa8c">&#34;C&#34;</span>
</span></span><span style="display:flex;"><span>A.key_value.value  INT32     G   _     <span style="color:#bd93f9">2</span>         40.00 B    <span style="color:#bd93f9">0</span>       <span style="color:#f1fa8c">&#34;10&#34;</span> / <span style="color:#f1fa8c">&#34;20&#34;</span>
</span></span></code></pre></div><p>By the way, if the key in the code is int, so the schema&rsquo;s type is set to map&lt;int,int&gt; as well, reading json fails with &ldquo;org.apache.spark.unsafe.types.UTF8String cannot be cast to java.lang.Integer&rdquo; error.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">type</span> Log <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    A <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">int</span>]<span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>=&gt; {<span style="color:#f1fa8c">&#34;A&#34;</span>:{<span style="color:#f1fa8c">&#34;10&#34;</span>:<span style="color:#f1fa8c">&#34;aaa&#34;</span>,<span style="color:#f1fa8c">&#34;20&#34;</span>:<span style="color:#f1fa8c">&#34;bbb&#34;</span>}}
</span></span></code></pre></div>
    </div>
    <div class="share">
      <div class="cell">
        <div>share</div>
        <div>
          <a class="share-button" href='https://twitter.com/intent/tweet?url=https://www.sambaiz.net/en/article/415/&text=Why%20can%20Athena%20v2%20fail%20to%20query%20map%20columns%20in%20parquet%20source%20tables%20-%20sambaiz-net'>
            <img src="/image/twitter.png" width="40px" height="40px" alt="twitter">
          </a>
          <a href="https://b.hatena.ne.jp/entry/" class="share-button hatena-bookmark-button" data-hatena-bookmark-layout="touch" data-hatena-bookmark-width="40" data-hatena-bookmark-height="40" title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="40" height="40" style="border: none;" />
          </a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
        </div>
      </div>
    </div>
  </article>
</div>

</div>
</body>

</html>