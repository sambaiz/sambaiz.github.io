<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Solve an incompatible version conflict problem in Java by relocation and custom ClassLoader - sambaiz-net</title>
  <meta name="twitter:title" content="Solve an incompatible version conflict problem in Java by relocation and custom ClassLoader - sambaiz-net">
  <meta property='og:title' content="Solve an incompatible version conflict problem in Java by relocation and custom ClassLoader - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="even if you build uber-jar, classes in the jar are not preferentially loaded but loaded by the classpath order. At that time, if there are incompatible classes, NoSuchMethodError or unintended behavior can occur at runtime">
  <meta name="twitter:description" content="even if you build uber-jar, classes in the jar are not preferentially loaded but loaded by the classpath order. At that time, if there are incompatible classes, NoSuchMethodError or unintended behavior can occur at runtime">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/443/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/443/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/443/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/443/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Solve an incompatible version conflict problem in Java by relocation and custom ClassLoader",
    "datePublished": "2023-08-08T22:44:00JST",
    "dateModified": "2023-08-08T22:44:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "even if you build uber-jar, classes in the jar are not preferentially loaded but loaded by the classpath order. At that time, if there are incompatible classes, NoSuchMethodError or unintended behavior can occur at runtime"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/443/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Solve an incompatible version conflict problem in Java by relocation and custom ClassLoader</h1>
        <time>2023-08-08</time>
        <a class="tag" href='/en/tags/java/'>java</a>
      </div>
      <p>When your Java application occurs an incompatible version conflict problem,
even if you build uber-jar, classes in the jar are not preferentially loaded but loaded by the classpath order.
At that time, if there are incompatible classes, it will be in a state called <a href="https://en.wikipedia.org/wiki/Java_Classloader#:~:text=2%5D%5B6%5D-,JAR%20hell%5Bedit%5D,-JAR%20hell%20is">JAR hell</a>,
and NoSuchMethodError or unintended behavior can occur at runtime.</p>
<p>Say you have legacylib.jar containing guava 17.0 and modernlib.jar containing guava 32.1,
and the former calls ByteStreams.asByteSource() removed in guava 18.0 and the latter calls ByteStreams.exhaust() added in guava 20.0.
In this case, NoSuchMethodError will occur regardless of which jar is placed before the classpath. I will solve this problem.
The whole code is on <a href="https://github.com/sambaiz/resolve-java-lib-version-conflict-problem">GitHub</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cat Legacy.java
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>public class Legacy <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    public static void foo<span style="color:#ff79c6">()</span> throws IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        InputSupplier&lt;InputStream&gt; <span style="color:#8be9fd;font-style:italic">inputSupplier</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">()</span> -&gt; new ByteArrayInputStream<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;legacy ok&#34;</span>.getBytes<span style="color:#ff79c6">())</span>; // interface removed in guava <span style="color:#bd93f9">20</span>
</span></span><span style="display:flex;"><span>        byte<span style="color:#ff79c6">[]</span> <span style="color:#8be9fd;font-style:italic">bytes</span> <span style="color:#ff79c6">=</span> ByteStreams.asByteSource<span style="color:#ff79c6">(</span>inputSupplier<span style="color:#ff79c6">)</span>.read<span style="color:#ff79c6">()</span>; // method removed in guava <span style="color:#bd93f9">18</span>
</span></span><span style="display:flex;"><span>        System.out.println<span style="color:#ff79c6">(</span>new String<span style="color:#ff79c6">(</span>bytes, <span style="color:#f1fa8c">&#34;UTF-8&#34;</span><span style="color:#ff79c6">))</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat Modern.java
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>public class Modern <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    public static void bar<span style="color:#ff79c6">()</span> throws IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        InputStream <span style="color:#8be9fd;font-style:italic">inputStream</span> <span style="color:#ff79c6">=</span> new ByteArrayInputStream<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;aaaaa&#34;</span>.getBytes<span style="color:#ff79c6">())</span>;
</span></span><span style="display:flex;"><span>        ByteStreams.exhaust<span style="color:#ff79c6">(</span>inputStream<span style="color:#ff79c6">)</span>; // method added in guava 20.0
</span></span><span style="display:flex;"><span>        System.out.println<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;modern ok&#34;</span><span style="color:#ff79c6">)</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ java -cp myapp/target/myapp-1.0.0.jar:legacylib/target/legacylib-1.0.0.jar:modernlib/target/modernlib-1.0.0.jar net.sambaiz.Main
</span></span><span style="display:flex;"><span>Exception in thread <span style="color:#f1fa8c">&#34;main&#34;</span> java.lang.NoSuchMethodError: com.google.common.io.ByteStreams.exhaust<span style="color:#ff79c6">(</span>Ljava/io/InputStream;<span style="color:#ff79c6">)</span>J
</span></span><span style="display:flex;"><span>        at net.sambaiz.modernlib.Modern.bar<span style="color:#ff79c6">(</span>Modern.java:13<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>        at net.sambaiz.Main.main<span style="color:#ff79c6">(</span>Main.java:10<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ java -cp myapp/target/myapp-1.0.0.jar:modernlib/target/modernlib-1.0.0.jar:legacylib/target/legacylib-1.0.0.jar net.sambaiz.Main
</span></span><span style="display:flex;"><span>modern ok
</span></span><span style="display:flex;"><span>Exception in thread <span style="color:#f1fa8c">&#34;main&#34;</span> java.lang.NoSuchMethodError: com.google.common.io.ByteStreams.asByteSource<span style="color:#ff79c6">(</span>Lcom/google/common/io/InputSupplier;<span style="color:#ff79c6">)</span>Lcom/google/common/io/ByteSource;
</span></span><span style="display:flex;"><span>        at net.sambaiz.legacylib.Legacy.foo<span style="color:#ff79c6">(</span>Legacy.java:16<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>        at net.sambaiz.Main.main<span style="color:#ff79c6">(</span>Main.java:11<span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>Besides, InputSupplier interface removed in guava 20.0 is also used, but this is not a conflict because there is no class in 32.1.</p>
<h2 id="solution-with-relocation">Solution with relocation</h2>
<p>maven-shade-plugin has <a href="https://maven.apache.org/plugins/maven-shade-plugin/examples/class-relocation.html">relocation</a> settings to rewrite package names.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#ff79c6">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;artifactId&gt;</span>maven-shade-plugin<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;version&gt;</span>3.2.4<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;phase&gt;</span>package<span style="color:#ff79c6">&lt;/phase&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&lt;goal&gt;</span>shade<span style="color:#ff79c6">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&lt;relocations&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">&lt;relocation&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#ff79c6">&lt;pattern&gt;</span>com.google<span style="color:#ff79c6">&lt;/pattern&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#ff79c6">&lt;shadedPattern&gt;</span>com.google.legacy<span style="color:#ff79c6">&lt;/shadedPattern&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">&lt;/relocation&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&lt;/relocations&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/executions&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;/plugin&gt;</span>
</span></span></code></pre></div><p>This can avoid conflict of incompatible classes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ jar tf legacylib/target/legacylib-1.0.0.jar
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>com/google/legacy/common/io/ByteStreams.class
</span></span><span style="display:flex;"><span>com/google/legacy/common/io/CharSequenceReader.class
</span></span><span style="display:flex;"><span>com/google/legacy/common/io/CharSink.class
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ java -cp myapp/target/myapp-1.0.0.jar:modernlib/target/modernlib-1.0.0.jar:legacylib/target/legacylib-1.0.0.jar net.sambaiz.Main
</span></span><span style="display:flex;"><span>modern ok
</span></span><span style="display:flex;"><span>legacy ok
</span></span></code></pre></div><p>By the way, the version of libraries that is contained in the jar is determined by maven&rsquo;s <a href="https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html#transitive-dependencies">nearest definition</a> policy,
so the version can change if you change the order of dependencies.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ mvn clean package dependency:tree
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>INFO<span style="color:#ff79c6">]</span> --- maven-dependency-plugin:2.8:tree <span style="color:#ff79c6">(</span>default-cli<span style="color:#ff79c6">)</span> @ myapp ---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>INFO<span style="color:#ff79c6">]</span> net.sambaiz:myapp:jar:1.0.0
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>INFO<span style="color:#ff79c6">]</span> +- net.sambaiz:legacylib:jar:1.0.0:compile
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>INFO<span style="color:#ff79c6">]</span> |  <span style="color:#f1fa8c">\-</span> com.google.guava:guava:jar:17.0-rc2:compile
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>INFO<span style="color:#ff79c6">]</span> <span style="color:#f1fa8c">\-</span> net.sambaiz:modernlib:jar:1.0.0:compile
</span></span></code></pre></div><p>You can fix the version by dependencyManagement.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#ff79c6">&lt;dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;groupId&gt;</span>com.google.guava<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;artifactI&gt;</span>guava<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;version&gt;</span>32.1.2-jre<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;/dependencyManagement&gt;</span>
</span></span></code></pre></div><h2 id="solution-with-custom-classloader">Solution with custom ClassLoader</h2>
<p>This problem occurs because the loaded classes are selected at the application level,
so it can also be solved by changing the class to be loaded for each library with a custom ClassLoader.
Relocation is required to modify the library&rsquo;s settings, but this solution does not require it.
However, codes such as creating instances and passing it to an argument become complicated, so that itself can cause a runtime error.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> net.sambaiz;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ByteArrayOutputStream;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.InputStream;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.InvocationTargetException;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.jar.JarEntry;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.jar.JarFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MyClassLoader</span> <span style="color:#8be9fd;font-style:italic">extends</span> ClassLoader {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> String jarFilePath;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">MyClassLoader</span>(ClassLoader parent, String jarFilePath) {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">super</span>(parent);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">jarFilePath</span> <span style="color:#ff79c6">=</span> jarFilePath;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">protected</span> Class<span style="color:#ff79c6">&lt;?&gt;</span> findClass(String className) <span style="color:#8be9fd;font-style:italic">throws</span> ClassNotFoundException {
</span></span><span style="display:flex;"><span>        System.<span style="color:#50fa7b">out</span>.<span style="color:#50fa7b">printf</span>(<span style="color:#f1fa8c">&#34;findClass %s\n&#34;</span>, className);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>            JarFile jarFile <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> JarFile(<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">jarFilePath</span>);
</span></span><span style="display:flex;"><span>            JarEntry entry <span style="color:#ff79c6">=</span> jarFile.<span style="color:#50fa7b">getJarEntry</span>(className.<span style="color:#50fa7b">replace</span>(<span style="color:#f1fa8c">&#39;.&#39;</span>, <span style="color:#f1fa8c">&#39;/&#39;</span>) <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;.class&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> (entry <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> ClassNotFoundException(className);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            InputStream inputStream <span style="color:#ff79c6">=</span> jarFile.<span style="color:#50fa7b">getInputStream</span>(entry);
</span></span><span style="display:flex;"><span>            ByteArrayOutputStream outputStream <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayOutputStream();
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> buffer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span>4096<span style="color:#ff79c6">]</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd">int</span> bytesRead;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">while</span> ((bytesRead <span style="color:#ff79c6">=</span> inputStream.<span style="color:#50fa7b">read</span>(buffer)) <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">-</span>1) {
</span></span><span style="display:flex;"><span>                outputStream.<span style="color:#50fa7b">write</span>(buffer, 0, bytesRead);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> bytecode <span style="color:#ff79c6">=</span> outputStream.<span style="color:#50fa7b">toByteArray</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> defineClass(className, bytecode, 0, bytecode.<span style="color:#50fa7b">length</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#ff79c6">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> ClassNotFoundException(className);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span>(String<span style="color:#ff79c6">[]</span> args) <span style="color:#8be9fd;font-style:italic">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException {
</span></span><span style="display:flex;"><span>        System.<span style="color:#50fa7b">out</span>.<span style="color:#50fa7b">println</span>(ClassLoader.<span style="color:#50fa7b">getSystemClassLoader</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        MyClassLoader legacyClassLoader <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> MyClassLoader(ClassLoader.<span style="color:#50fa7b">getSystemClassLoader</span>(), <span style="color:#f1fa8c">&#34;legacylib/target/legacylib-1.0.0.jar&#34;</span>);
</span></span><span style="display:flex;"><span>        Class<span style="color:#ff79c6">&lt;?&gt;</span> legacyClass <span style="color:#ff79c6">=</span> legacyClassLoader.<span style="color:#50fa7b">loadClass</span>(<span style="color:#f1fa8c">&#34;net.sambaiz.legacylib.Legacy&#34;</span>);
</span></span><span style="display:flex;"><span>        Object legacyInstance <span style="color:#ff79c6">=</span> legacyClass.<span style="color:#50fa7b">getDeclaredConstructor</span>().<span style="color:#50fa7b">newInstance</span>();
</span></span><span style="display:flex;"><span>        legacyClass.<span style="color:#50fa7b">getMethod</span>(<span style="color:#f1fa8c">&#34;foo&#34;</span>).<span style="color:#50fa7b">invoke</span>(legacyInstance);;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        MyClassLoader modernClassLoader <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> MyClassLoader(ClassLoader.<span style="color:#50fa7b">getSystemClassLoader</span>(), <span style="color:#f1fa8c">&#34;modernlib/target/modernlib-1.0.0.jar&#34;</span>);
</span></span><span style="display:flex;"><span>        Class<span style="color:#ff79c6">&lt;?&gt;</span> modernClass <span style="color:#ff79c6">=</span> modernClassLoader.<span style="color:#50fa7b">loadClass</span>(<span style="color:#f1fa8c">&#34;net.sambaiz.modernlib.Modern&#34;</span>);
</span></span><span style="display:flex;"><span>        Object modernInstance <span style="color:#ff79c6">=</span> modernClass.<span style="color:#50fa7b">getDeclaredConstructor</span>().<span style="color:#50fa7b">newInstance</span>();
</span></span><span style="display:flex;"><span>        modernClass.<span style="color:#50fa7b">getMethod</span>(<span style="color:#f1fa8c">&#34;bar&#34;</span>).<span style="color:#50fa7b">invoke</span>(modernInstance);;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The library paths is not included even in the classpath, but they are loaded by the custom class loaders.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ java -cp myapp/target/myapp-1.0.0.jar net.sambaiz.MyClassLoader
</span></span><span style="display:flex;"><span>findClass net.sambaiz.legacylib.Legacy
</span></span><span style="display:flex;"><span>findClass com.google.common.io.InputSupplier
</span></span><span style="display:flex;"><span>findClass com.google.common.io.ByteStreams
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>legacy ok
</span></span><span style="display:flex;"><span>findClass net.sambaiz.modernlib.Modern
</span></span><span style="display:flex;"><span>findClass com.google.common.io.ByteStreams
</span></span><span style="display:flex;"><span>findClass com.google.common.io.ByteStreams<span style="color:#8be9fd;font-style:italic">$1</span>
</span></span><span style="display:flex;"><span>findClass com.google.common.io.ByteStreams<span style="color:#8be9fd;font-style:italic">$LimitedInputStream</span>
</span></span><span style="display:flex;"><span>findClass com.google.common.io.ByteArrayDataInput
</span></span><span style="display:flex;"><span>findClass com.google.common.io.ByteArrayDataOutput
</span></span><span style="display:flex;"><span>modern ok
</span></span></code></pre></div><h2 id="references">References</h2>
<p><a href="https://qiita.com/autotaker1984/items/9265b28553e74a9a8fb0">shaded-jarの作り方 - Qiita</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>