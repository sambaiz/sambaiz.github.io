<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Settings for running Spark on EMR - sambaiz-net</title>
  <meta name="twitter:title" content="Settings for running Spark on EMR - sambaiz-net">
  <meta property='og:title' content="Settings for running Spark on EMR - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="if the settings are not appropriate, the resources cannot be fully used, and tasks can fail due to OOM even if there is excess memory">
  <meta name="twitter:description" content="if the settings are not appropriate, the resources cannot be fully used, and tasks can fail due to OOM even if there is excess memory">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/414/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/414/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/414/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/414/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Settings for running Spark on EMR",
    "datePublished": "2022-08-13T19:53:00JST",
    "dateModified": "2022-08-13T19:53:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "if the settings are not appropriate, the resources cannot be fully used, and tasks can fail due to OOM even if there is excess memory"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/414/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Settings for running Spark on EMR</h1>
        <time>2022-08-13</time>
        <a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/hadoop/'>hadoop</a><a class="tag" href='/en/tags/spark/'>spark</a><a class="tag" href='/en/tags/etl/'>etl</a>
      </div>
      <p>EMR and Glue are managed services that run Spark applications on AWS.
Glue is easy to run ETL jobs with serverless, while EMR allows fine-tuning of resources and parameters.
In other words, if the settings are not appropriate, the resources cannot be fully used, and tasks can fail due to OOM even if there is excess memory.</p>




<div class="img_container"><a href="/article/414/images/resource.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/414/images/resource_hu1325476225419147310.png" width="600" height="356" alt="a resource that isn&#39;t fully used">
</a></div>


<p>In the CLI, settings can be passed as json string or a file with &ndash;configurations.</p>
<p><a href="https://www.sambaiz.net/en/article/409/">Launch an EMR cluster with AWS CLI and run Spark applications - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>--configurations <span style="color:#f1fa8c">&#39;[
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;Classification&#34;: &#34;spark-defaults&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;Properties&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      ...
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">]&#39;</span>
</span></span></code></pre></div><h2 id="refer-to-glue-data-cataloghttpsdocsawsamazoncomemrlatestreleaseguideemr-spark-gluehtmlemr-spark-glue-configure"><a href="https://docs.aws.amazon.com/emr/latest/ReleaseGuide/emr-spark-glue.html#emr-spark-glue-configure">Refer to Glue Data Catalog</a></h2>
<p>Refer to Glue Data Catalog as Hive metastore.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;Classification&#34;</span>: <span style="color:#f1fa8c">&#34;spark-hive-site&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;Properties&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;hive.metastore.client.factory.class&#34;</span>: <span style="color:#f1fa8c">&#34;com.amazonaws.glue.catalog.metastore.AWSGlueDataCatalogHiveClientFactory&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><h2 id="maximizeresourceallocationhttpsdocsawsamazoncomemrlatestreleaseguideemr-spark-configurehtmlemr-spark-maximizeresourceallocation"><a href="https://docs.aws.amazon.com/emr/latest/ReleaseGuide/emr-spark-configure.html#emr-spark-maximizeresourceallocation">maximizeResourceAllocation</a></h2>
<p>EMR has a unique parameter called maximizeResourceAllocation, and if this is set to true, the following parameters of spark-defaults are set according to the instance type.</p>
<ul>
<li>spark.default.parallelism</li>
<li>spark.driver.memory</li>
<li>spark.executor.memory</li>
<li>spark.executor.cores</li>
<li>spark.executor.instances</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;Classification&#34;</span>: <span style="color:#f1fa8c">&#34;spark&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;Properties&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;maximizeResourceAllocation&#34;</span>: <span style="color:#f1fa8c">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><h2 id="dynamic-resource-allocationhttpssparkapacheorgdocslatestjob-schedulinghtmldynamic-resource-allocation"><a href="https://spark.apache.org/docs/latest/job-scheduling.html#dynamic-resource-allocation">Dynamic Resource Allocation</a></h2>
<p>Dynamic Resource Allocation is a spark&rsquo;s feature to allocate resources to applications dynamically.
This is <a href="https://docs.aws.amazon.com/ja_jp/emr/latest/ReleaseGuide/emr-spark-configure.html#spark-defaults">enabled</a> in EMR by default.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;Classification&#34;</span>: <span style="color:#f1fa8c">&#34;spark-defaults&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;Properties&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;spark.dynamicAllocation.enabled&#34;</span>: <span style="color:#f1fa8c">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><h2 id="manual-setting">Manual setting</h2>
<p>However, there seems to be room for improvement with these settings, and <a href="https://aws.amazon.com/jp/blogs/big-data/best-practices-for-successfully-managing-memory-for-apache-spark-applications-on-amazon-emr/">best practices</a> suggest disabling them and setting the following values instead.</p>
<h3 id="spark">spark</h3>
<ul>
<li>
<p>spark.executor.cores = 5: Increasing it, the parallelism decreases, and decreasing it, the number of executors increases, and a large amount of I/O occurs.</p>
</li>
<li>
<p>spark.executor.memory = (RAM / ((vCPU - 1) / executor.cores = number of executors)) * 0.9: Hadoop daemon uses 1 vCPU.</p>
<ul>
<li>spark.executor.memoryOverhead = spark.executor.memory * (0.1/0.9)</li>
</ul>
</li>
<li>
<p>spark.executor.instances = number of executors - 1: 1 is for the driver. In the case of client mode, it works on the master node, so there is no need to subtract it.</p>
</li>
<li>
<p>spark.driver.memory = spark.executor.memory</p>
</li>
<li>
<p>spark.driver.cores = spark.executors.cores</p>
</li>
<li>
<p>spark.default.parallelism = executor.instances * executors.cores * 2</p>
</li>
</ul>
<h3 id="spark-defaults">spark-defaults</h3>
<ul>
<li>
<p>spark.network.timeout = 800s</p>
</li>
<li>
<p>spark.executor.heartbeatInterval = 60s: Should be significantly smaller than spark.network.timeout</p>
</li>
<li>
<p>spark.yarn.scheduler.reporterThread.maxFailures = 5: Maximum executor failures</p>
</li>
<li>
<p>spark.memory.fraction = 0.8: Ratio of heap space used for execution and storage. Making it smaller, spilling, which is moving data from buffer to disk, and cache deletion occur frequently.</p>
</li>
<li>
<p>spark.memory.storageFraction = 0.3</p>
</li>
<li>
<p>spark.rdd.compress = true: Compression saves space at the cost of CPU time</p>
</li>
<li>
<p>spark.shuffle.compress = true</p>
</li>
<li>
<p>spark.shuffle.spill.compress = true</p>
</li>
<li>
<p>spark.serializer = org.apache.spark.serializer.KryoSerializer: Faster than default JavaSerializer</p>
</li>
<li>
<p><a href="https://spark.apache.org/docs/latest/configuration.html">spark.jars.packages</a> (e.g. com.google.cloud.spark:spark-3.2-bigquery:0.31.1): Settings to put libraries in the classpath of the driver and executor, but they are downloaded every time a step is executed, so be careful that it costs NAT gateway if instances run in private subnets.</p>
</li>
</ul>
<h3 id="gc">GC</h3>
<p>Use the G1GC algorithm that is high-performance, and lower the threshold that GC starts to prevent Full GC. Also output GC logs.</p>
<p><a href="https://www.sambaiz.net/en/article/413/">Exploring the cause of OOM that occurred in Java from GC logs and heap dumps - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;Classification&#34;</span>: <span style="color:#f1fa8c">&#34;spark-defaults&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;Properties&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;spark.executor.extraJavaOptions&#34;</span>: <span style="color:#f1fa8c">&#34;-XX:+UseG1GC -XX:+UnlockDiagnosticVMOptions -XX:+G1SummarizeConcMark -XX:InitiatingHeapOccupancyPercent=35 -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:OnOutOfMemoryError=&#39;kill -9 %p&#39;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;spark.driver.extraJavaOptions&#34;</span>: <span style="color:#f1fa8c">&#34;-XX:+UseG1GC -XX:+UnlockDiagnosticVMOptions -XX:+G1SummarizeConcMark -XX:InitiatingHeapOccupancyPercent=35 -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:OnOutOfMemoryError=&#39;kill -9 %p&#39;&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="yarn">yarn</h3>
<p>Prevent rare virtual out-of-memory errors.</p>
<ul>
<li>yarn.nodemanager.vmem-check-enabled = false</li>
<li>yarn.nodemanager.pmem-check-enabled = false</li>
</ul>
<h2 id="references">References</h2>
<p><a href="https://community.cloudera.com/t5/Support-Questions/Explain-process-of-spilling-in-Hadoop-s-map-reduce-program/td-p/237245">Explain process of spilling in Hadoop’s map reduce&hellip; - Cloudera Community - 237245</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>