<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Install Livy on EMR on EKS and run Spark jobs from local Jupyter notebooks with Sparkmagic - sambaiz-net</title>
  <meta name="twitter:title" content="Install Livy on EMR on EKS and run Spark jobs from local Jupyter notebooks with Sparkmagic - sambaiz-net">
  <meta property='og:title' content="Install Livy on EMR on EKS and run Spark jobs from local Jupyter notebooks with Sparkmagic - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="Apache Livy provides a REST API for interacting with Spark clusters, and Sparkmagic calls this API to run jobs on remote Spark clusters from Jupyter Notebooks">
  <meta name="twitter:description" content="Apache Livy provides a REST API for interacting with Spark clusters, and Sparkmagic calls this API to run jobs on remote Spark clusters from Jupyter Notebooks">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/486/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/486/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/486/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/486/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Install Livy on EMR on EKS and run Spark jobs from local Jupyter notebooks with Sparkmagic",
    "datePublished": "2024-05-22T23:55:00JST",
    "dateModified": "2024-05-22T23:55:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "Apache Livy provides a REST API for interacting with Spark clusters, and Sparkmagic calls this API to run jobs on remote Spark clusters from Jupyter Notebooks"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/486/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Install Livy on EMR on EKS and run Spark jobs from local Jupyter notebooks with Sparkmagic</h1>
        <time>2024-05-22</time>
        <a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/kubernetes/'>kubernetes</a><a class="tag" href='/en/tags/spark/'>spark</a><a class="tag" href='/en/tags/etl/'>etl</a>
      </div>
      <p><a href="https://livy.apache.org/">Apache Livy</a> provides a REST API for interacting with Spark clusters, and <a href="https://github.com/jupyter-incubator/sparkmagic">Sparkmagic</a> calls this API to run jobs on remote Spark clusters from Jupyter Notebooks. It is also used by Athena for Apache Spark, and being able to run jobs interactively and check the results is useful for debugging and running ad-hoc queries.</p>
<p><a href="https://www.sambaiz.net/article/438/">Athena for Apache Spark の Notebook で DataFrame.toPandas().plot() した際の日本語が文字化けしないようにする - sambaiz-net</a></p>
<p>However, although <a href="https://github.com/apache/incubator-livy/pull/249">PR</a> for Livy’s Kubernetes support was created in 2019, there is no maintainer who knows Kubernetes well, and the situation continues to be that it is not merged. So I thought about building it myself, but surprisingly, EMR 7.1 <a href="https://aws.amazon.com/about-aws/whats-new/2024/04/amazon-emr-eks-apache-livy">supports</a> Livy. I try running Spark job on EMR on EKS from local Jupyter Notebooks using this.</p>
<p><a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/job-runs-apache-livy-install.html">Install</a> Livy with Helm chart by passing <a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/job-runs-apache-livy-installation-properties-710.html">parameters</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> livyExecutionRole <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> iam.Role(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;LivyExecutionRole&#39;</span>, {
</span></span><span style="display:flex;"><span>  roleName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;livy-execution-role&#39;</span>,
</span></span><span style="display:flex;"><span>  assumedBy: <span style="color:#8be9fd">new</span> iam.WebIdentityPrincipal(
</span></span><span style="display:flex;"><span>    cluster.openIdConnectProvider.openIdConnectProviderArn,
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      StringLike: <span style="color:#8be9fd">new</span> cdk.CfnJson(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;LivyExecutionRoleStringEquals&#39;</span>, {
</span></span><span style="display:flex;"><span>        value<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>          [<span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>cluster.clusterOpenIdConnectIssuer<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:sub`</span>]<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;system:serviceaccount:livy:emr-containers-sa-livy&#39;</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      }),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ),
</span></span><span style="display:flex;"><span>  inlinePolicies<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    UploadS3: <span style="color:#8be9fd">new</span> iam.PolicyDocument({
</span></span><span style="display:flex;"><span>      statements<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>          effect: <span style="color:#8be9fd">iam.Effect.ALLOW</span>,
</span></span><span style="display:flex;"><span>          actions<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;s3:PutObject&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;s3:ListBucket&#39;</span>,
</span></span><span style="display:flex;"><span>          ],
</span></span><span style="display:flex;"><span>          resources<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;arn:aws:s3:::&lt;bucket&gt;&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;arn:aws:s3:::&lt;bucket&gt;/*&#39;</span>
</span></span><span style="display:flex;"><span>          ],
</span></span><span style="display:flex;"><span>        }),
</span></span><span style="display:flex;"><span>      ],
</span></span><span style="display:flex;"><span>    }),
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cluster.addHelmChart(<span style="color:#f1fa8c">&#39;LivyChart&#39;</span>, {
</span></span><span style="display:flex;"><span>  chart<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;livy&#39;</span>,
</span></span><span style="display:flex;"><span>  repository<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;oci://059004520145.dkr.ecr.ap-northeast-1.amazonaws.com/livy&#39;</span>,
</span></span><span style="display:flex;"><span>  version<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;7.1.0&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;livy&#39;</span>,
</span></span><span style="display:flex;"><span>  createNamespace: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>  values<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    image<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;059004520145.dkr.ecr.ap-northeast-1.amazonaws.com/livy/emr-7.1.0:latest&#39;</span>,
</span></span><span style="display:flex;"><span>    sparkNamespace<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;emr&#39;</span>,
</span></span><span style="display:flex;"><span>    serviceAccount<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      executionRoleArn: <span style="color:#8be9fd">livyExecutionRole.roleArn</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    service<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      annotations<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#39;service.beta.kubernetes.io/aws-load-balancer-subnets&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;testpublicsubnet1,testpublicsubnet2&#39;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>Load Balancer Controller creates an internal NLB corresponding to the service, but you can also do port forwarding to access it from local environment.</p>
<p><a href="https://www.sambaiz.net/en/article/471/">Install AWS Load Balancer Controller on EKS cluster and set up ALB Ingress - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ kubectl port-forward -n livy svc/emr-containers-livy 8998:8998
</span></span><span style="display:flex;"><span>containers-livy 8998:8998
</span></span><span style="display:flex;"><span>Forwarding from 127.0.0.1:8998 -&gt; <span style="color:#bd93f9">8998</span>
</span></span><span style="display:flex;"><span>Forwarding from <span style="color:#ff79c6">[</span>::1<span style="color:#ff79c6">]</span>:8998 -&gt; <span style="color:#bd93f9">8998</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl http://localhost:8998/sessions
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;from&#34;</span>:0,<span style="color:#f1fa8c">&#34;total&#34;</span>:0,<span style="color:#f1fa8c">&#34;sessions&#34;</span>:<span style="color:#ff79c6">[]}</span>
</span></span></code></pre></div><p><a href="https://www.sambaiz.net/en/article/489/">Call Livy&rsquo;s REST API to run a Spark job - sambaiz-net</a></p>
<p>It seems that there are no official images for Sparkmagic, so I built it using the <a href="https://github.com/jupyter-incubator/sparkmagic/blob/0.21.0/Dockerfile.jupyter">Dockerfile</a> in the repository as a reference. There is a way to use %%spark magic to perform processing on a Spark cluster, but a kernel that automatically do it is also provided, so install it if needed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> <span style="color:#f1fa8c">jupyter/base-notebook</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">USER</span> <span style="color:#f1fa8c">root</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">RUN</span> apt update <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    apt install -y gcc <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    apt clean <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    rm -rf /var/lib/apt/lists/*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># This is needed because requests-kerberos fails to install on debian due to missing linux headers</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">RUN</span> conda install requests-kerberos -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">USER</span> <span style="color:#f1fa8c">$NB_USER</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">RUN</span> pip install --upgrade pip <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    pip install --upgrade --ignore-installed setuptools <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span>    pip install hdijupyterutils autovizwidget sparkmagic
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Jupyter extensions changed in &gt;7.x.x</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># For now (workaround), let&#39;s pin to 6 to avoid breaking things</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># xref: https://github.com/jupyter-incubator/sparkmagic/issues/825</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">RUN</span> pip install <span style="color:#8be9fd;font-style:italic">notebook</span><span style="color:#ff79c6">==</span>6.5.5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">RUN</span> mkdir /home/<span style="color:#8be9fd;font-style:italic">$NB_USER</span>/.sparkmagic
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">COPY</span> config.json /home/<span style="color:#8be9fd;font-style:italic">$NB_USER</span>/.sparkmagic/config.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">RUN</span> jupyter nbextension <span style="color:#8be9fd;font-style:italic">enable</span> --py --sys-prefix widgetsnbextension
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">RUN</span> jupyter-kernelspec install --user <span style="color:#ff79c6">$(</span>pip show sparkmagic | grep Location | cut -d<span style="color:#f1fa8c">&#34; &#34;</span> -f2<span style="color:#ff79c6">)</span>/sparkmagic/kernels/sparkkernel
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">RUN</span> jupyter-kernelspec install --user <span style="color:#ff79c6">$(</span>pip show sparkmagic | grep Location | cut -d<span style="color:#f1fa8c">&#34; &#34;</span> -f2<span style="color:#ff79c6">)</span>/sparkmagic/kernels/pysparkkernel
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">RUN</span> jupyter-kernelspec install --user <span style="color:#ff79c6">$(</span>pip show sparkmagic | grep Location | cut -d<span style="color:#f1fa8c">&#34; &#34;</span> -f2<span style="color:#ff79c6">)</span>/sparkmagic/kernels/sparkrkernel
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">RUN</span> jupyter serverextension <span style="color:#8be9fd;font-style:italic">enable</span> --py sparkmagic
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">USER</span> <span style="color:#f1fa8c">root</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">RUN</span> chown <span style="color:#8be9fd;font-style:italic">$NB_USER</span> /home/<span style="color:#8be9fd;font-style:italic">$NB_USER</span>/.sparkmagic/config.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">CMD</span> [ <span style="color:#f1fa8c">&#34;start-notebook.sh&#34;</span>, <span style="color:#f1fa8c">&#34;--NotebookApp.token=&#39;&#39;&#34;</span> ]
</span></span></code></pre></div><p>config.json is as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;kernel_scala_credentials&#34;</span> : {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;url&#34;</span>: <span style="color:#f1fa8c">&#34;http://host.docker.internal:8998&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;session_configs&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;driverMemory&#34;</span>: <span style="color:#f1fa8c">&#34;1000M&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;executorCores&#34;</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;session_configs_defaults&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;conf&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;spark.kubernetes.namespace&#34;</span>: <span style="color:#f1fa8c">&#34;emr&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;spark.kubernetes.container.image&#34;</span>: <span style="color:#f1fa8c">&#34;public.ecr.aws/emr-on-eks/spark/emr-7.1.0:latest&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;spark.kubernetes.authenticate.driver.serviceAccountName&#34;</span>: <span style="color:#f1fa8c">&#34;emr-containers-sa-spark-driver-*****&#34;</span>, 
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;spark.kubernetes.file.upload.path&#34;</span>: <span style="color:#f1fa8c">&#34;s3://&lt;bucket&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;spark.hadoop.hive.metastore.client.factory.class&#34;</span>: <span style="color:#f1fa8c">&#34;com.amazonaws.glue.catalog.metastore.AWSGlueDataCatalogHiveClientFactory&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;spark.sql.catalog.spark_catalog.type&#34;</span>: <span style="color:#f1fa8c">&#34;hive&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;livy_session_startup_timeout_seconds&#34;</span>: <span style="color:#bd93f9">180</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;max_results_sql&#34;</span>: <span style="color:#bd93f9">2500</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If you execute something like spark.sql() on a notebook, a session is started on the EKS cluster and the results are returned.</p>




<div class="img_container"><a href="/article/486/images/session.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/486/images/session_hu_fe79b6a26f9452e4.png" width="600" height="101" alt="Launched driver and executor pods">
</a></div>






<div class="img_container"><a href="/article/486/images/result.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/486/images/result_hu_fae42c7144591e27.png" width="600" height="172" alt="Execution result">
</a></div>



    </div>
  </article>
</div>

</div>
</body>

</html>