<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }

    .single ol {
        list-style-type: decimal;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Install AWS Load Balancer Controller on EKS cluster and set up ALB Ingress - sambaiz-net</title>
  <meta name="twitter:title" content="Install AWS Load Balancer Controller on EKS cluster and set up ALB Ingress - sambaiz-net">
  <meta property='og:title' content="Install AWS Load Balancer Controller on EKS cluster and set up ALB Ingress - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="A controller that creates and manages ELBs for Kubernetes resources">
  <meta name="twitter:description" content="A controller that creates and manages ELBs for Kubernetes resources">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/471/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/471/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/471/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/471/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Install AWS Load Balancer Controller on EKS cluster and set up ALB Ingress",
    "datePublished": "2024-02-26T23:55:00JST",
    "dateModified": "2024-02-26T23:55:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "A controller that creates and manages ELBs for Kubernetes resources"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/471/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="/places/">
            <img src="/image/pin.svg" width="32px" height="32px" alt="places">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/linux/">
            linux</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Install AWS Load Balancer Controller on EKS cluster and set up ALB Ingress</h1>
        <time>2024-02-26</time>
        <a class="tag" href='/en/tags/kubernetes/'>kubernetes</a><a class="tag" href='/en/tags/aws/'>aws</a>
      </div>
      <p><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.7/">AWS Load Balancer Controller</a> is a controller that creates and manages ELBs for Kubernetes resources.
It can be installed with a service account granted the required <a href="https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.7.0/docs/install/iam_policy.json">policies</a> and <a href="https://artifacthub.io/packages/helm/aws/aws-load-balancer-controller">Helm Chart</a>, but if you create the cluster with CDK, <a href="https://github.com/aws/aws-cdk/blob/798ef6789c53fc1ba28ffefa480889d5b0c9b151/packages/aws-cdk-lib/aws-eks/lib/alb-controller.ts#L304">this is done</a> by specifying the version in albController.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">new</span> eks.Cluster(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;Cluster&#39;</span>, {
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  albController<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    version: <span style="color:#8be9fd">eks.AlbControllerVersion.V2_6_2</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>An ALB is created by creating the Ingress as follows.
Subnets can be specified with <a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/ingress/annotations/#subnets">alb.ingress.kubernetes.io/subnets</a>, but
if subnets have following tags, <a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.7/deploy/subnet_discovery/">auto discovery</a> works.</p>
<ul>
<li>kubernetes.io/role/elb : 1</li>
<li>kubernetes.io/cluster/${cluster-name}: owned or shared</li>
</ul>
<p><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.7/guide/ingress/annotations/#target-type">alb.ingress.kubernetes.io/target-type</a> is instance or ip,
and directs traffic to instances or pods directly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: networking.k8s.io/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Ingress
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: test
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">alb.ingress.kubernetes.io/scheme</span>: internet-facing
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">alb.ingress.kubernetes.io/target-type</span>: ip
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">alb.ingress.kubernetes.io/subnets</span>: testpublicsubnet1, testpublicsubnet2
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">alb.ingress.kubernetes.io/healthcheck-path</span>: /health
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">alb.ingress.kubernetes.io/target-group-attributes</span>: deregistration_delay.timeout_seconds=5
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ingressClassName</span>: alb
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">http</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">paths</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">path</span>: /
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">pathType</span>: Prefix
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">backend</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">service</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: test
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">number</span>: <span style="color:#bd93f9">80</span>
</span></span></code></pre></div><p>In case ip, pods may stop before ALB deregistration, resulting in a connection failure and a 5xx error, so you should shorten the Deregistration delay and also wait longer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span> <span style="color:#ff79c6">lifecycle</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">preStop</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">exec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">command</span>: [<span style="color:#f1fa8c">&#34;sleep&#34;</span>, <span style="color:#f1fa8c">&#34;15s&#34;</span>]
</span></span></code></pre></div><p>Additionally, if pods become ready before the ALB health check passes during a rolling update, previous pods will terminate and resources will be insufficient.To prevent this, add the following label to the namespace and make <a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.7/deploy/pod_readiness_gate/">Pod readiness gate</a> inserted automatically.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Namespace
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: app
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">elbv2.k8s.aws/pod-readiness-gate-inject</span>: enabled
</span></span></code></pre></div><p>If load is concentrated on specific pods and the health check fails, requests will no longer be routed to them, causing the remaining pods also can be down due to traffic spike. It may be possible to resolve the concentrated load by using <a href="https://aws.amazon.com/about-aws/whats-new/2019/11/application-load-balancer-now-supports-least-outstanding-requests-algorithm-for-load-balancing-requests/">Least Outstanding Requests (LOR)</a>, which routes to the target with the fewest requests being processed instead of the default round robin. However, note that if it has a sidecar whose load increases by the number of requests, the load on that sidecar can be biased.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">alb.ingress.kubernetes.io/target-group-attributes</span>: load_balancing.algorithm.type=least_outstanding_requests
</span></span></code></pre></div><p>If an ALB is not created due to AccessDenied etc., you should check that the policies is up to date and that there are no errors in the annotations of ServiceAccount.</p>
<p>You can specify <a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.7/deploy/security_groups/">custom security groups</a> at alb.ingress.kubernetes.io/security-groups, but if you do that, unless you also set alb.ingress.kubernetes.io/manage-backend-security-group-rules to true, the Backend SG that included in instance&rsquo;s inbound rule won&rsquo;t be added to the ALB, so it can&rsquo;t access to the instances.</p>
<h2 id="references">References</h2>
<p><a href="https://qiita.com/da-ishi10/items/e7e7517a4b6161c981d8">AWS Load Balancer Controller v2.3.0 から導入された Optimized SG rules について #AWS - Qiita</a></p>
<p><a href="https://tech-blog.monotaro.com/entry/2023/08/22/090000">EKSコンテナ移行のトラブル事例：ALBの設定とPodのライフサイクル管理 - MonotaRO Tech Blog</a></p>
<p><a href="https://hagihala.hatenablog.com/entry/2022/12/27/154808">ALB ターゲットグループのバランシングアルゴリズムを LOR にする - hagihala&rsquo;s blog</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>