<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 30px;
        height: 30px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.5rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .share-button > img {
        border: none;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .share {
        position: relative;
        text-align: right;
        margin-top: 5px;
    }

    .share .cell {
        display: inline-block;
        text-align: center;
        margin-bottom: 5px;
    }

    .share-button {
        display: inline-block;
        margin: 0 5px;
    }

    @media screen and (min-width: 1400px) {
        .share .cell {
            position: absolute;
            bottom: 0;
            margin-left: 5px;
        }

        .share-button {
            display: inline-block;
            margin: 5px 0;
        }
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Monitor infrastructure and applications with New Relic - sambaiz-net</title>
  <meta name="twitter:title" content="Monitor infrastructure and applications with New Relic - sambaiz-net">
  <meta property='og:title' content="Monitor infrastructure and applications with New Relic - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="SaaS to monitor infrastructure and applications charged for transfer volume and number of admin users">
  <meta name="twitter:description" content="SaaS to monitor infrastructure and applications charged for transfer volume and number of admin users">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/399/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/399/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/399/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/399/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Monitor infrastructure and applications with New Relic",
    "datePublished": "2022-03-30T19:11:00JST",
    "dateModified": "2022-03-30T19:11:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "SaaS to monitor infrastructure and applications charged for transfer volume and number of admin users"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/399/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://twitter.com/sambaiz">
            <img src="/image/twitter.png" width="30px" height="30px" alt="twitter">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://bookmeter.com/users/1060169/books/read">
            <img src="/image/bookmeter.png" width="30px" height="30px" alt="bookmeter">
          </a>
        </div>
        <div class="sns-item">
          <a href="https://filmarks.com/users/sambaiz" class="filmarks" aria-label="filmarks"></a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/log/">
            log</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/docker/">
            docker</a>
          
          <a class="tag" href="/tags/infra/">
            infra</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Monitor infrastructure and applications with New Relic</h1>
        <time>2022-03-30</time>
        <a class="tag" href='/en/tags/newrelic/'>newrelic</a><a class="tag" href='/en/tags/infra/'>infra</a><a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/log/'>log</a><a class="tag" href='/en/tags/golang/'>golang</a>
      </div>
      <p><a href="https://newrelic.com/">New Relic</a> is a SaaS that monitors infrastructure and applications, and there is Datadog as a similar service.
It seems that the <a href="https://newrelic.com/pricing">pricing plans</a> were <a href="https://newrelic.com/jp/blog/nerdlog/new-relic-one-observability-made-simple">changed</a> drastically in 2020, and it charges according to the transfer volume and the number of admin users. Therefore compared to Datadog, which <a href="https://www.datadoghq.com/ja/pricing/">charges</a> for hosts and additional features, there is an advantage when managing a large number of instances with a small number of people.
And Datadog pricing plans are relatively complex and hard to estimate how much the bill will be in an environment where the number of instances increases and decreases frequently, while New Relic&rsquo;s plans are easy.
Even if you try to new features, the unit price will not increase, so you can easily try it.</p>
<p>On the other hand, if there are a lot of admin users or the number of requests is huge so the transfer volume about APM is increased, it may be more expensive than Datadog.
In many cases, user charges are the majority, so if you replaces some Full platform users with half priced Core user or free Basic user, the charges will be reduced but while Dashboard and Alert are available to all users, <a href="https://docs.newrelic.com/docs/accounts/accounts-billing/new-relic-one-user-management/user-type/#user-type-comparison-table">APM screens are available to only full platform users</a>.
The transfer volume charges can be reduced by <a href="https://docs.newrelic.com/docs/data-apis/manage-data/drop-data-using-nerdgraph/">Drop data</a>. It cannot be set from the screen for now, so it is necessary to use NerdGraph. The following is an example of setting with Terraform.</p>
<p><a href="https://www.sambaiz.net/en/article/400/">Query resources with NerdGraph, New Relic&rsquo;s GraphQL API - sambaiz-net</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">resource &#34;newrelic_nrql_drop_rule&#34; &#34;heavy_path&#34; {
  account_id  = *****
  description = &#34;Drop transactions data&#34;
  action      = &#34;drop_data&#34;
  nrql        = &#34;SELECT * FROM Transaction WHERE `request.uri` = &#39;/heavy_path&#39;&#34;
}
</code></pre></div><p>Also, I think troubleshooting is relatively difficult. I faced some problems sucha as sending no metrics or referencing old documents. However the libraries and documents are OSS and I can send PR if needed so I don&rsquo;t feel a big problem.</p>
<h2 id="aws-integrationhttpsdocsnewreliccomdocsinfrastructureamazon-integrationsget-startedintroduction-aws-integrations"><a href="https://docs.newrelic.com/docs/infrastructure/amazon-integrations/get-started/introduction-aws-integrations/">AWS integration</a></h2>
<p>Create a Role with <code>ReadOnlyAccess</code> and <code>budgets:ViewBudget</code> to <code>AssumeRole</code> from New Relic.</p>
<p><a href="https://www.sambaiz.net/article/72/">AWSのAssumeRole - sambaiz-net</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-json" data-lang="json">{
  <span style="color:#ff79c6">&#34;Statement&#34;</span>: [
    {
      <span style="color:#ff79c6">&#34;Action&#34;</span>: [
        <span style="color:#f1fa8c">&#34;budgets:ViewBudget&#34;</span>
      ],
      <span style="color:#ff79c6">&#34;Effect&#34;</span>: <span style="color:#f1fa8c">&#34;Allow&#34;</span>,
      <span style="color:#ff79c6">&#34;Resource&#34;</span>: <span style="color:#f1fa8c">&#34;*&#34;</span>
    }
  ],
  <span style="color:#ff79c6">&#34;Version&#34;</span>: <span style="color:#f1fa8c">&#34;2012-10-17&#34;</span>
}
</code></pre></div><p>For metric acquisition, the conventional method of calling the API regularly for polling, and the method of using <a href="https://aws.amazon.com/blogs/aws/cloudwatch-metric-streams-send-aws-metrics-to-partners-and-to-your-apps-in-real-time">CloudWatch Metric Steams</a> streaming to Firehose are supported, and the latter is recommended. Required resources can be created by passing the License Key to the provided <a href="https://docs.newrelic.com/docs/infrastructure/amazon-integrations/connect/aws-metric-stream-setup#setup-cloudformation">CloudFormation template</a>. The following resources are created and the metrics are displayed on the New Relic dashboard.</p>




<div class="img_container"><a href="/en/article/399/images/resources.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/en/article/399/images/resources_hu01cff156344c66a3d7f82c469543a7d4_186261_600x370_fit_lanczos_2.png" width="402" height="370" alt="Created resources">
</a></div>


<p>Looking at the created Metric Streams settings, it can find all namespace metrics are sent.</p>




<div class="img_container"><a href="/en/article/399/images/metricstream.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/en/article/399/images/metricstream_hua4360d0786f190ea2e08d1ff9bf43b4f_281762_600x370_fit_lanczos_2.png" width="600" height="292" alt="Metric Streams settings">
</a></div>


<p>If the metrics are not sent, make sure you have not copied the wrong Key or Key ID.</p>




<div class="img_container"><a href="/en/article/399/images/accountmetrics.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/en/article/399/images/accountmetrics_hu2a4394b3b72054e887906d6853b6851d_225401_600x370_fit_lanczos_2.png" width="559" height="370" alt="Account metrics dashboard">
</a></div>


<h2 id="install-an-infrastructure-monitoring-agenthttpsdocsnewreliccomdocsinfrastructureinstall-infrastructure-agentlinux-installationinstall-infrastructure-monitoring-agent-linux"><a href="https://docs.newrelic.com/docs/infrastructure/install-infrastructure-agent/linux-installation/install-infrastructure-monitoring-agent-linux/">Install an infrastructure monitoring agent</a></h2>
<p>Install an agent to collect the CPU usage rate and network I/O etc. of the instance.
The following commands are for Amazon Linux 2 (arm64).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh">$ <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;license_key: ****-&#34;</span> | sudo tee -a /etc/newrelic-infra.yml
$ sudo curl -o /etc/yum.repos.d/newrelic-infra.repo https://download.newrelic.com/infrastructure_agent/linux/yum/amazonlinux/2/aarch64/newrelic-infra.repo
$ sudo yum -q makecache -y --disablerepo<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;*&#39;</span> --enablerepo<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;newrelic-infra&#39;</span>
$ sudo yum install newrelic-infra -y
$ sudo systemctl start newrelic-infra
</code></pre></div>



<div class="img_container"><a href="/en/article/399/images/hostmetrics.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/en/article/399/images/hostmetrics_huec2d6f10058924d3988cf04ae3a1a0f0_392139_600x370_fit_lanczos_2.png" width="600" height="313" alt="Hosts&#39; metrics">
</a></div>


<h2 id="apmhttpsdocsnewreliccomdocsapmagentsgo-agentget-startedintroduction-new-relic-go"><a href="https://docs.newrelic.com/docs/apm/agents/go-agent/get-started/introduction-new-relic-go">APM</a></h2>
<p>APM is a feature to collect runtime information such as the number of Goroutines and GC execution time, as well as X-Ray-like request traces and show their summaries. The agent libraries are provided in C, Go, Java, .NET, Node.js, PHP, Python ans Ruby.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh">$ go get github.com/newrelic/go-agent
</code></pre></div><p>Integrations are provided for major WAFs such as echo and gin in Go, and this middleware writes <code>Transaction</code> associated with the request to the <code>Context</code> and make it retrievable with <code>nrecho.FromContext(c)</code>. <code>Transaction</code> that are not associated with a request are treated as <code>Background jobs</code>.</p>
<p><code>NewApplication()</code> <a href="https://github.com/newrelic/go-agent/blob/06c801d5571056abac8ac9dfa07cf12ca869e920/internal_app.go#L376">spawns</a> a goroutine which hervests data and send it so if you new a <code>Application</code> each time without calling <a href="https://github.com/newrelic/go-agent/blob/06c801d5571056abac8ac9dfa07cf12ca869e920/v3/newrelic/application.go#L102">Shutdown()</a>, the goroutine leaks.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/newrelic/go-agent/v3/integrations/nrecho-v4&#34;</span>
app, err <span style="color:#ff79c6">:=</span> newrelic.<span style="color:#50fa7b">NewApplication</span>(
    newrelic.<span style="color:#50fa7b">ConfigAppName</span>(<span style="color:#f1fa8c">&#34;app_name&#34;</span>),
    newrelic.<span style="color:#50fa7b">ConfigLicense</span>(<span style="color:#f1fa8c">&#34;*****&#34;</span>),
    newrelic.<span style="color:#50fa7b">ConfigDistributedTracerEnabled</span>(<span style="color:#ff79c6">true</span>),
)
http.<span style="color:#50fa7b">HandleFunc</span>(newrelic.<span style="color:#50fa7b">WrapHandleFunc</span>(app, <span style="color:#f1fa8c">&#34;/users&#34;</span>, usersHandler))
e.<span style="color:#50fa7b">Use</span>(nrecho.<span style="color:#50fa7b">Middleware</span>(app))

<span style="color:#6272a4">// middleware
</span><span style="color:#6272a4"></span>txn.<span style="color:#50fa7b">SetWebRequestHTTP</span>(c.<span style="color:#50fa7b">Request</span>())
c.<span style="color:#50fa7b">Response</span>().Writer = txn.<span style="color:#50fa7b">SetWebResponse</span>(rw)
c.<span style="color:#50fa7b">SetRequest</span>(c.<span style="color:#50fa7b">Request</span>().<span style="color:#50fa7b">WithContext</span>(newrelic.<span style="color:#50fa7b">NewContext</span>(c.<span style="color:#50fa7b">Request</span>().<span style="color:#50fa7b">Context</span>(), txn)))

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">handler</span>(c echo.Context) <span style="color:#8be9fd">error</span> {
	txn <span style="color:#ff79c6">:=</span> nrecho.<span style="color:#50fa7b">FromContext</span>(c)
	<span style="color:#ff79c6">return</span> c.<span style="color:#50fa7b">String</span>(http.StatusOK, <span style="color:#f1fa8c">&#34;ok&#34;</span>)
}
</code></pre></div><p>If create a segment, the execution time of that section is displayed on the timeline.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">do</span>(ctx context.Context) {
  <span style="color:#ff79c6">defer</span> newrelic.<span style="color:#50fa7b">FromContext</span>(ctx).<span style="color:#50fa7b">StartSegment</span>(<span style="color:#f1fa8c">&#34;do&#34;</span>).<span style="color:#50fa7b">End</span>()
}
</code></pre></div><p>If wrap a HTTP request, a segment for the external request is created and average latency etc. are displayed on the Service Map.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go">client <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>http.Client{}
client.Transport = newrelic.<span style="color:#50fa7b">NewRoundTripper</span>(client.Transport)

request, _ <span style="color:#ff79c6">:=</span> http.<span style="color:#50fa7b">NewRequest</span>(<span style="color:#f1fa8c">&#34;GET&#34;</span>, <span style="color:#f1fa8c">&#34;http://example.com&#34;</span>, <span style="color:#ff79c6">nil</span>)
request = newrelic.<span style="color:#50fa7b">RequestWithTransactionContext</span>(request, txn)

response, err <span style="color:#ff79c6">:=</span> client.<span style="color:#50fa7b">Do</span>(request)
</code></pre></div><h2 id="log-forwardinghttpsdocsnewreliccomdocslogsforward-logsfluentd-plugin-log-forwarding"><a href="https://docs.newrelic.com/docs/logs/forward-logs/fluentd-plugin-log-forwarding/">Log forwarding</a></h2>
<p>Logs can be forwarded with Fluentd, Fluent Bit and Log stash <a href="https://github.com/newrelic/newrelic-fluentd-output">plugin</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">$ td-agent-gem install fluent-plugin-newrelic
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-xml" data-lang="xml"><span style="color:#ff79c6">&lt;filter</span> foo<span style="color:#ff79c6">&gt;</span>
  @type record_transformer
  <span style="color:#ff79c6">&lt;record&gt;</span>
    service_name ${tag}
    hostname &#34;#{Socket.gethostname}&#34;
  <span style="color:#ff79c6">&lt;/record&gt;</span>
<span style="color:#ff79c6">&lt;/filter&gt;</span>

<span style="color:#ff79c6">&lt;match</span> foo<span style="color:#ff79c6">&gt;</span>
  @type newrelic
  api_key ****
<span style="color:#ff79c6">&lt;/match&gt;</span>
</code></pre></div><p>Logrus, a logger in Go, integration is provided, which <a href="https://github.com/newrelic/go-agent/blob/v3.15.2/_integrations/logcontext/logcontext.go#L34">adds</a> following fields to the log and associate the request trace with the log. Any loggers are available if add these yourself.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">AddLinkingMetadata</span>(m <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}, md newrelic.LinkingMetadata) {
	<span style="color:#50fa7b">metadataMapField</span>(m, KeyTraceID, md.TraceID)
	<span style="color:#50fa7b">metadataMapField</span>(m, KeySpanID, md.SpanID)
	<span style="color:#50fa7b">metadataMapField</span>(m, KeyEntityName, md.EntityName)
	<span style="color:#50fa7b">metadataMapField</span>(m, KeyEntityType, md.EntityType)
	<span style="color:#50fa7b">metadataMapField</span>(m, KeyEntityGUID, md.EntityGUID)
	<span style="color:#50fa7b">metadataMapField</span>(m, KeyHostname, md.Hostname)
}
</code></pre></div><p>If log is linked, it can be jumped from Errors Event, which is helpful to troubleshoot.</p>
<p><a href="https://www.sambaiz.net/en/article/401/">About newrelic-lambda-extension and how it works telemetry without CloudWatch Logs - sambaiz-net</a></p>

    </div>
    <div class="share">
      <div class="cell">
        <div>share</div>
        <div>
          <a class="share-button" href='https://twitter.com/intent/tweet?url=https://www.sambaiz.net/en/article/399/&text=Monitor%20infrastructure%20and%20applications%20with%20New%20Relic%20-%20sambaiz-net'>
            <img src="/image/twitter.png" width="40px" height="40px" alt="twitter">
          </a>
          <a href="https://b.hatena.ne.jp/entry/" class="share-button hatena-bookmark-button" data-hatena-bookmark-layout="touch" data-hatena-bookmark-width="40" data-hatena-bookmark-height="40" title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="40" height="40" style="border: none;" />
          </a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
        </div>
      </div>
    </div>
  </article>
</div>

</div>
</body>

</html>