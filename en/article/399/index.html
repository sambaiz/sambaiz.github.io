<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Monitor infrastructure and applications with New Relic - sambaiz-net</title>
  <meta name="twitter:title" content="Monitor infrastructure and applications with New Relic - sambaiz-net">
  <meta property='og:title' content="Monitor infrastructure and applications with New Relic - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="SaaS to monitor infrastructure and applications charged for transfer volume and number of admin users">
  <meta name="twitter:description" content="SaaS to monitor infrastructure and applications charged for transfer volume and number of admin users">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/399/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/399/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/399/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/399/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Monitor infrastructure and applications with New Relic",
    "datePublished": "2022-03-30T19:11:00JST",
    "dateModified": "2022-03-30T19:11:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "SaaS to monitor infrastructure and applications charged for transfer volume and number of admin users"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/399/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/ios/">
            ios</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Monitor infrastructure and applications with New Relic</h1>
        <time>2022-03-30</time>
        <a class="tag" href='/en/tags/newrelic/'>newrelic</a><a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/monitoring/'>monitoring</a><a class="tag" href='/en/tags/golang/'>golang</a><a class="tag" href='/en/tags/fluentd/'>fluentd</a>
      </div>
      <p><a href="https://newrelic.com/">New Relic</a> is a SaaS that monitors infrastructure and applications, and there is Datadog as a similar service.
It seems that the <a href="https://newrelic.com/pricing">pricing plans</a> were <a href="https://newrelic.com/jp/blog/nerdlog/new-relic-one-observability-made-simple">changed</a> drastically in 2020, and it charges according to the transfer volume and the number of admin users. Therefore compared to Datadog, which <a href="https://www.datadoghq.com/ja/pricing/">charges</a> for hosts and additional features, there is an advantage when managing a large number of instances with a small number of people.
And Datadog pricing plans are relatively complex and hard to estimate how much the bill will be in an environment where the number of instances increases and decreases frequently, while New Relic&rsquo;s plans are easy.
Even if you try to new features, the unit price will not increase, so you can easily try it.</p>
<p>On the other hand, if there are a lot of admin users or the number of requests is huge so the transfer volume about APM is increased, it may be more expensive than Datadog.
In many cases, user charges are the majority, so if you replaces some Full platform users with half priced Core user or free Basic user, the charges will be reduced but while Dashboard and Alert are available to all users, <a href="https://docs.newrelic.com/docs/accounts/accounts-billing/new-relic-one-user-management/user-type/#user-type-comparison-table">APM screens are available to only full platform users</a>.
The transfer volume charges can be reduced by <a href="https://docs.newrelic.com/docs/data-apis/manage-data/drop-data-using-nerdgraph/">Drop data</a>. It cannot be set from the screen for now, so it is necessary to use NerdGraph. The following is an example of setting with Terraform.</p>
<p><a href="https://www.sambaiz.net/en/article/400/">Query resources with NerdGraph, New Relic&rsquo;s GraphQL API - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>resource &#34;newrelic_nrql_drop_rule&#34; &#34;heavy_path&#34; {
</span></span><span style="display:flex;"><span>  account_id  = *****
</span></span><span style="display:flex;"><span>  description = &#34;Drop transactions data&#34;
</span></span><span style="display:flex;"><span>  action      = &#34;drop_data&#34;
</span></span><span style="display:flex;"><span>  nrql        = &#34;SELECT * FROM Transaction WHERE `request.uri` = &#39;/heavy_path&#39;&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I feel troubleshooting is relatively difficult. I faced some troubles such as sending no metrics or referencing old documents but the libraries and documents are OSS so I think they can be almost resolved by reading the code or sending a PR.
However, there are informations which are not written clearly in docs, or even if they are written, it may be difficult to find them, so esecially if you use New Relic for the first time, although the user unit price will increase, pro or higher plan which have support may be better.
New features, including CodeStream, which was <a href="https://newrelic.com/jp/press-release/20211111">acquired</a> last year, are being actively developed, so I hope that the troubleshooting will be improved as well.</p>
<p><a href="https://www.sambaiz.net/en/article/403/">Make asking about codes and debugging efficient with New Relic CodeStream - sambaiz-net</a></p>
<h2 id="aws-integrationhttpsdocsnewreliccomdocsinfrastructureamazon-integrationsget-startedintroduction-aws-integrations"><a href="https://docs.newrelic.com/docs/infrastructure/amazon-integrations/get-started/introduction-aws-integrations/">AWS integration</a></h2>
<p>Create a Role with <code>ReadOnlyAccess</code> and <code>budgets:ViewBudget</code> to <code>AssumeRole</code> from New Relic.</p>
<p><a href="https://www.sambaiz.net/article/72/">AWSのAssumeRole - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;Statement&#34;</span>: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;Action&#34;</span>: [
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;budgets:ViewBudget&#34;</span>
</span></span><span style="display:flex;"><span>      ],
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;Effect&#34;</span>: <span style="color:#f1fa8c">&#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;Resource&#34;</span>: <span style="color:#f1fa8c">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;Version&#34;</span>: <span style="color:#f1fa8c">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>For metric acquisition, the conventional method of calling the API regularly for polling, and the method of using <a href="https://aws.amazon.com/blogs/aws/cloudwatch-metric-streams-send-aws-metrics-to-partners-and-to-your-apps-in-real-time">CloudWatch Metric Steams</a> streaming to Firehose are supported, and the latter is recommended.
However, values that don&rsquo;t exist in CloudWatch metrics, such as Budget, can be fetched only with polling.</p>
<p><a href="https://www.sambaiz.net/en/article/424/">Monitor AWS costs with New Relic - sambaiz-net</a></p>
<p>Required resources can be created by passing the License Key to the provided <a href="https://docs.newrelic.com/docs/infrastructure/amazon-integrations/connect/aws-metric-stream-setup#setup-cloudformation">CloudFormation template</a>. The following resources are created and the metrics are displayed on the New Relic dashboard.</p>




<div class="img_container"><a href="/en/article/399/images/resources.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/en/article/399/images/resources_hu01cff156344c66a3d7f82c469543a7d4_186261_600x370_fit_lanczos_3.png" width="402" height="370" alt="Created resources">
</a></div>


<p>Looking at the created Metric Streams settings, it can find all namespace metrics are sent.</p>




<div class="img_container"><a href="/en/article/399/images/metricstream.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/en/article/399/images/metricstream_hua4360d0786f190ea2e08d1ff9bf43b4f_281762_600x370_fit_lanczos_3.png" width="600" height="292" alt="Metric Streams settings">
</a></div>


<p>If the metrics are not sent, make sure the region, and you have not copied the wrong Key or Key ID.</p>




<div class="img_container"><a href="/en/article/399/images/accountmetrics.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/en/article/399/images/accountmetrics_hu2a4394b3b72054e887906d6853b6851d_225401_600x370_fit_lanczos_3.png" width="559" height="370" alt="Account metrics dashboard">
</a></div>


<h2 id="install-an-infrastructure-monitoring-agenthttpsdocsnewreliccomdocsinfrastructureinstall-infrastructure-agentlinux-installationinstall-infrastructure-monitoring-agent-linux"><a href="https://docs.newrelic.com/docs/infrastructure/install-infrastructure-agent/linux-installation/install-infrastructure-monitoring-agent-linux/">Install an infrastructure monitoring agent</a></h2>
<p>Install an agent to collect the CPU usage rate and network I/O etc. of the instance.
The following commands are for Amazon Linux 2 (arm64).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;license_key: ****-&#34;</span> | sudo tee -a /etc/newrelic-infra.yml
</span></span><span style="display:flex;"><span>$ sudo curl -o /etc/yum.repos.d/newrelic-infra.repo https://download.newrelic.com/infrastructure_agent/linux/yum/amazonlinux/2/aarch64/newrelic-infra.repo
</span></span><span style="display:flex;"><span>$ sudo yum -q makecache -y --disablerepo<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;*&#39;</span> --enablerepo<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;newrelic-infra&#39;</span>
</span></span><span style="display:flex;"><span>$ sudo yum install newrelic-infra -y
</span></span><span style="display:flex;"><span>$ sudo systemctl start newrelic-infra
</span></span></code></pre></div>



<div class="img_container"><a href="/en/article/399/images/hostmetrics.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/en/article/399/images/hostmetrics_huec2d6f10058924d3988cf04ae3a1a0f0_392139_600x370_fit_lanczos_3.png" width="600" height="313" alt="Hosts&#39; metrics">
</a></div>


<h3 id="new-relic-flexhttpsdocsnewreliccomdocsinfrastructurehost-integrationshost-integrations-listflex-integration-tool-build-your-own-integration"><a href="https://docs.newrelic.com/docs/infrastructure/host-integrations/host-integrations-list/flex-integration-tool-build-your-own-integration/">New Relic Flex</a></h3>
<p>If following yaml file is put under /etc/newrelic-infra/integrations.d, metrics are generated from <a href="https://github.com/newrelic/nri-flex/blob/v1.4.4/docs/apis/commands.md">command outputs</a>, <a href="https://github.com/newrelic/nri-flex/blob/v1.4.4/docs/apis/url.md">HTTP responses</a> or <a href="https://github.com/newrelic/nri-flex/blob/v1.4.4/docs/apis/file.md">file contents</a>, and it can be send on a regular basis.</p>
<p>For monitoring Fluentd, the value of monitor_agent can be sent with <a href="https://docs.newrelic.com/docs/data-apis/ingest-apis/telemetry-sdks-report-custom-telemetry-data/">Telemetry SDK</a>, but if use this feature instead, an application to send it is not needed to run on log aggregator.
However, be careful that the larger the number of settings, the larger the amount of data.</p>
<p><a href="https://www.sambaiz.net/article/66/">fluentdのmonitor_agentのデータをGoでGoogle Stackdriverに送って監視する - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>$ cat /etc/newrelic-infra/integrations.d/fluentd.yml
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">integrations</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#ff79c6">name</span>: nri-flex
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">config</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">name</span>: fluentd
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">apis</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">event_type</span>: fluentd
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">url</span>: http://localhost:24220/api/plugins.json?@type=forward
</span></span></code></pre></div><p>Check the data with following NRQL.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> fluentd <span style="color:#ff79c6">SELECT</span> rate(average(buffer_total_queued_size), <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">minute</span>) FACET <span style="color:#ff79c6">`</span>config.<span style="color:#ff79c6">@</span>id<span style="color:#ff79c6">`</span> TIMESERIES 
</span></span></code></pre></div><h3 id="log-forwardinghttpsdocsnewreliccomdocslogsforward-logsfluentd-plugin-log-forwarding"><a href="https://docs.newrelic.com/docs/logs/forward-logs/fluentd-plugin-log-forwarding/">Log forwarding</a></h3>
<p>Logs can be forwarded with Fluent Bit <a href="https://docs.newrelic.com/docs/logs/forward-logs/forward-your-logs-using-infrastructure-agent/">installed by the agent</a>, self-installed Fluentd or Logstash.</p>
<p><a href="https://www.sambaiz.net/article/416/">EMRクラスタのEC2にFluent BitをインストールしログをNew Relicに送信する - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ td-agent-gem install fluent-plugin-newrelic
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#ff79c6">&lt;filter</span> foo<span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span>  @type record_transformer
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;record&gt;</span>
</span></span><span style="display:flex;"><span>    service_name ${tag}
</span></span><span style="display:flex;"><span>    hostname &#34;#{Socket.gethostname}&#34;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;/record&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;/filter&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;match</span> foo<span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span>  @type newrelic
</span></span><span style="display:flex;"><span>  api_key ****
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;/match&gt;</span>
</span></span></code></pre></div><p>Logrus, a logger in Go, integration is provided, which <a href="https://github.com/newrelic/go-agent/blob/v3.15.2/_integrations/logcontext/logcontext.go#L34">adds</a> following fields to the log and associate the request trace with the log. Any loggers are available if add these yourself.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">AddLinkingMetadata</span>(m <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}, md newrelic.LinkingMetadata) {
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">metadataMapField</span>(m, KeyTraceID, md.TraceID)
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">metadataMapField</span>(m, KeySpanID, md.SpanID)
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">metadataMapField</span>(m, KeyEntityName, md.EntityName)
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">metadataMapField</span>(m, KeyEntityType, md.EntityType)
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">metadataMapField</span>(m, KeyEntityGUID, md.EntityGUID)
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">metadataMapField</span>(m, KeyHostname, md.Hostname)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If log is linked, it can be jumped from Errors Event, which is helpful to troubleshoot.</p>
<p><a href="https://www.sambaiz.net/en/article/401/">About newrelic-lambda-extension and how it works telemetry without CloudWatch Logs - sambaiz-net</a></p>
<h2 id="apmhttpsdocsnewreliccomdocsapmagentsgo-agentget-startedintroduction-new-relic-go"><a href="https://docs.newrelic.com/docs/apm/agents/go-agent/get-started/introduction-new-relic-go">APM</a></h2>
<p>APM is a feature to collect runtime information such as the number of Goroutines and GC execution time, as well as X-Ray-like request traces and show their summaries. The agent libraries are provided in C, Go, Java, .NET, Node.js, PHP, Python ans Ruby.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go get github.com/newrelic/go-agent
</span></span></code></pre></div><p>Integrations are provided for major WAFs such as echo and gin in Go, and this middleware writes <strong>Transaction</strong> associated with the request to the context and make it retrievable with <code>nrecho.FromContext(c)</code>. Transaction that are not associated with a request are treated as <strong>Background jobs</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/newrelic/go-agent/v3/integrations/nrecho-v4&#34;</span>
</span></span><span style="display:flex;"><span>app, err <span style="color:#ff79c6">:=</span> newrelic.<span style="color:#50fa7b">NewApplication</span>(
</span></span><span style="display:flex;"><span>    newrelic.<span style="color:#50fa7b">ConfigAppName</span>(<span style="color:#f1fa8c">&#34;app_name&#34;</span>),
</span></span><span style="display:flex;"><span>    newrelic.<span style="color:#50fa7b">ConfigLicense</span>(<span style="color:#f1fa8c">&#34;*****&#34;</span>),
</span></span><span style="display:flex;"><span>    newrelic.<span style="color:#50fa7b">ConfigDistributedTracerEnabled</span>(<span style="color:#ff79c6">true</span>),
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http.<span style="color:#50fa7b">HandleFunc</span>(newrelic.<span style="color:#50fa7b">WrapHandleFunc</span>(app, <span style="color:#f1fa8c">&#34;/users&#34;</span>, usersHandler))
</span></span><span style="display:flex;"><span>e.<span style="color:#50fa7b">Use</span>(nrecho.<span style="color:#50fa7b">Middleware</span>(app))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// in middleware
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">txn.SetWebRequestHTTP(c.Request())
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">c.Response().Writer = txn.SetWebResponse(rw)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">c.SetRequest(c.Request().WithContext(newrelic.NewContext(c.Request().Context(), txn)))
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">handler</span>(c echo.Context) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>	txn <span style="color:#ff79c6">:=</span> nrecho.<span style="color:#50fa7b">FromContext</span>(c)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> c.<span style="color:#50fa7b">String</span>(http.StatusOK, <span style="color:#f1fa8c">&#34;ok&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>NewApplication()</code> <a href="https://github.com/newrelic/go-agent/blob/06c801d5571056abac8ac9dfa07cf12ca869e920/internal_app.go#L376">spawns</a> a goroutine which hervests data and send it so if you new a <strong>Application</strong> each time without calling <a href="https://github.com/newrelic/go-agent/blob/06c801d5571056abac8ac9dfa07cf12ca869e920/v3/newrelic/application.go#L102">Shutdown()</a>, the goroutine leaks.</p>
<p>If create a segment, the execution time of that section is displayed on the timeline.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">do</span>(ctx context.Context) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">defer</span> newrelic.<span style="color:#50fa7b">FromContext</span>(ctx).<span style="color:#50fa7b">StartSegment</span>(<span style="color:#f1fa8c">&#34;do&#34;</span>).<span style="color:#50fa7b">End</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If wrap a HTTP request, a segment for the external request is created and average latency etc. are displayed on the Service Map.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>client <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>http.Client{}
</span></span><span style="display:flex;"><span>client.Transport = newrelic.<span style="color:#50fa7b">NewRoundTripper</span>(client.Transport)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>request, _ <span style="color:#ff79c6">:=</span> http.<span style="color:#50fa7b">NewRequest</span>(<span style="color:#f1fa8c">&#34;GET&#34;</span>, <span style="color:#f1fa8c">&#34;http://example.com&#34;</span>, <span style="color:#ff79c6">nil</span>)
</span></span><span style="display:flex;"><span>request = newrelic.<span style="color:#50fa7b">RequestWithTransactionContext</span>(request, txn)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>response, err <span style="color:#ff79c6">:=</span> client.<span style="color:#50fa7b">Do</span>(request)
</span></span></code></pre></div><h3 id="custom-metricshttpsdocsnewreliccomdocsapmagentsmanage-apm-agentsagent-datacollect-custom-metrics"><a href="https://docs.newrelic.com/docs/apm/agents/manage-apm-agents/agent-data/collect-custom-metrics/">Custom metrics</a></h3>
<p>When <a href="https://github.com/newrelic/go-agent/blob/v3.15.2/v3/newrelic/application.go#L61">app.RecordCustomMetric(key,value)</a> is called, metrics of Custom/ prefix are sent.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>app.<span style="color:#50fa7b">RecordCustomMetric</span>(<span style="color:#f1fa8c">&#34;CustomMetricName&#34;</span>, <span style="color:#bd93f9">132</span>)
</span></span></code></pre></div><p>The metrics are not shown on Data explorer and you can see it on Metrics explorer of APM.</p>




<div class="img_container"><a href="/en/article/399/images/metrics_explorer.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/en/article/399/images/metrics_explorer_hu66a0fd01d5668b47f33bc666d830d18f_39102_600x370_fit_lanczos_3.png" width="344" height="370" alt="Metrics explorer">
</a></div>


<p>In NRQL, <a href="https://docs.newrelic.com/docs/data-apis/understand-data/metric-data/query-apm-metric-timeslice-data-nrql/#wildcard">refer</a> to <code>newrelic.timeslice.value</code> as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> Metric <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">count</span>(newrelic.timeslice.value) 
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">WHERE</span> appName <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;MY APP&#39;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">WITH</span> METRIC_FORMAT <span style="color:#f1fa8c">&#39;Custom/{name}&#39;</span> 
</span></span><span style="display:flex;"><span>  TIMESERIES FACET name
</span></span></code></pre></div><p><a href="https://www.sambaiz.net/en/article/408/">Characteristics of Metrics and Events in New Relic and queries in NRQL - sambaiz-net</a></p>
<h2 id="alerthttpsdocsnewreliccomdocsalerts-applied-intelligencenew-relic-alertslearn-alertsintroduction-alerts"><a href="https://docs.newrelic.com/docs/alerts-applied-intelligence/new-relic-alerts/learn-alerts/introduction-alerts/">Alert</a></h2>
<p>Once you set a &ldquo;condition&rdquo; from charts in a Dashboards etc. to send an alert, and the condition is met, an &ldquo;incident&rdquo; is created and an &ldquo;issue&rdquo; is opened.
Issue can be created per policy or condition, and in that case, multiple incidents are associated with one issue.
When the status of the issue changes, a notification is sent.</p>
<p><a href="https://docs.newrelic.com/docs/alerts-applied-intelligence/new-relic-alerts/advanced-alerts/advanced-techniques/alert-custom-violation-descriptions/">custom incident description</a> added to the notification can use templates such as {{tag.tags.Name}},
and it refers to the value of the incident&rsquo;s payload,<br>
but since the incident does not exist when the condition is created, it is troublesome to check the key.</p>
<p>Default <a href="https://docs.newrelic.com/docs/alerts-applied-intelligence/new-relic-alerts/advanced-alerts/understand-technical-concepts/streaming-alerts-key-terms-concepts/">Streaming method</a> is <a href="https://docs.newrelic.com/docs/alerts-applied-intelligence/new-relic-alerts/advanced-alerts/understand-technical-concepts/streaming-alerts-key-terms-concepts/#event-flow">Event flow</a>,
and it is not evaluated unless data arrives after the time set to Delay,
so if it is sent unpredictably, use <a href="https://docs.newrelic.com/docs/alerts-applied-intelligence/new-relic-alerts/advanced-alerts/understand-technical-concepts/streaming-alerts-key-terms-concepts/#event-timer">Event timer</a>, which waits Delay time after the last data is sent to evaluate the Window, and fill data gaps if necessary.</p>
<h2 id="references">References</h2>
<p><a href="https://y-ohgi.blog/entry/2020/12/24/NewRelic_%E3%81%A7td-agent%28fluentd%29_%E3%81%AB%E3%83%A1%E3%83%88%E3%83%AA%E3%82%AF%E3%82%B9%E3%82%92%E7%9B%A3%E8%A6%96%E3%81%99%E3%82%8B">NewRelic でtd-agent(fluentd) にメトリクスを監視する - y-ohgi&rsquo;s blog</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>