<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Avoiding OOM in count-distinct operations on massive datasets using HyperLogLog&#43;&#43;, a probabilistic cardinality estimation algorithm - sambaiz-net</title>
  <meta name="twitter:title" content="Avoiding OOM in count-distinct operations on massive datasets using HyperLogLog&#43;&#43;, a probabilistic cardinality estimation algorithm - sambaiz-net">
  <meta property='og:title' content="Avoiding OOM in count-distinct operations on massive datasets using HyperLogLog&#43;&#43;, a probabilistic cardinality estimation algorithm - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="When counting unique elements, such as the number of users in access logs, we often execute queries like count(distinct column_name). For massive datasets, regular count() operations can be scaled by splitting the data and summing the results. However, this method doesn&#39;t work with distinct operations, which can lead to extreme slowdowns due to memory shortages or, in the worst case, failure due to OOM errors">
  <meta name="twitter:description" content="When counting unique elements, such as the number of users in access logs, we often execute queries like count(distinct column_name). For massive datasets, regular count() operations can be scaled by splitting the data and summing the results. However, this method doesn&#39;t work with distinct operations, which can lead to extreme slowdowns due to memory shortages or, in the worst case, failure due to OOM errors">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/497/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/497/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/497/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/497/" />
  
  
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css" integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" integrity="sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>
  <style>
    .katex-display { margin: 1.5rem 0; }
  </style>
  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Avoiding OOM in count-distinct operations on massive datasets using HyperLogLog++, a probabilistic cardinality estimation algorithm",
    "datePublished": "2024-09-02T21:08:00JST",
    "dateModified": "2024-09-02T21:08:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "When counting unique elements, such as the number of users in access logs, we often execute queries like count(distinct column_name). For massive datasets, regular count() operations can be scaled by splitting the data and summing the results. However, this method doesn't work with distinct operations, which can lead to extreme slowdowns due to memory shortages or, in the worst case, failure due to OOM errors"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/497/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Avoiding OOM in count-distinct operations on massive datasets using HyperLogLog&#43;&#43;, a probabilistic cardinality estimation algorithm</h1>
        <time>2024-09-02</time>
        <a class="tag" href='/en/tags/spark/'>spark</a><a class="tag" href='/en/tags/paper/'>paper</a><a class="tag" href='/en/tags/gcp/'>gcp</a>
      </div>
      <p>When counting unique elements, such as the number of users in access logs, we often execute queries like &ldquo;count(distinct column_name)&rdquo;. For massive datasets, regular count() operations can be scaled by splitting the data and summing the results. However, this method doesn&rsquo;t work with distinct operations, which can lead to extreme slowdowns due to memory shortages or, in the worst case, failure due to OOM errors.</p>
<p>This issue is known as the <a href="https://en.wikipedia.org/wiki/Count-distinct_problem">Count-distinct problem (cardinality estimation problem)</a>, and several algorithms have been proposed to estimate cardinality (unique count) without retaining all elements. One of them is HyperLogLog, and its improved version, HyperLogLog++, is widely implemented as <a href="https://github.com/apache/spark/blob/c58148da5496245403b55c3fc423d35f3a669c79/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/FunctionRegistry.scala#L469">approx_count_distinct()</a> in Spark and <a href="https://github.com/prestodb/presto/blob/2bceaa02b982f2b10d4d577fac9b3c8944c36ace/presto-main/src/main/java/com/facebook/presto/operator/aggregation/ApproximateCountDistinctAggregation.java#L40">approx_distinct()</a> in Presto.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span>sql<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  select count(distinct id)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  from test_data
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;&#34;&#34;</span><span style="color:#ff79c6">).</span>show<span style="color:#ff79c6">()</span> <span style="color:#6272a4">// 100,818
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span>sql<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  select approx_count_distinct(id)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  from test_data
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;&#34;&#34;</span><span style="color:#ff79c6">).</span>show<span style="color:#ff79c6">()</span> <span style="color:#6272a4">// 100,598
</span></span></span></code></pre></div><p><a href="http://algo.inria.fr/flajolet/Publications/FlFuGaMe07.pdf">HyperLogLog</a> passes each data to a hash function, distributes them into \(m = 2^b\) registers based on the first \(b\) bits, and for each register, finds the maximum length of the leading zeros in the remaining bits, denoted as \(M[i]\ (1 \leqq i \leqq m)\).</p>




<div class="img_container"><a href="/article/497/images/hyperloglog.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/497/images/hyperloglog_hu4990809559516263606.png" width="600" height="360" alt="HyperLogLog process">
</a></div>


<p>It then estimates the cardinality \(E\) using the following formula, where \(\alpha\) is a correction factor depending on only \(m\).</p>




<div class="img_container"><a href="/article/497/images/cardinality.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/497/images/cardinality_hu13491381934396013907.png" width="600" height="69" alt="Formula">
</a></div>


<p>When \(b=2\ (m = 4)\) and the maximum number of leading zeros for each register is [1, 2, 3, 2], the denominator of E becomes \((\frac{1}{2} + \frac{1}{4} + \frac{1}{8} + \frac{1}{4})\). Multiplying this by m gives the harmonic mean of \(2^{M[j]}\). As the number of elements increases, leading zeros tend to be longer, increasing this value and consequently \(E\).</p>
<p>Increasing \(m\) improves accuracy but also increases memory usage, creating a trade-off. Surprisingly even with \(m = 2048\), the standard error remains around 2.3% regardless of cardinality. However, when cardinality is too low relative to the number of registers, accuracy decreases. HyperLogLog++ addresses this issue by using sparse representation in such cases.</p>
<p>A useful property is that merging registers can yield the result of a union data, which also contributes to the ease of parallel execution.
In addition to <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/approximate_aggregate_functions#approx-count-distinct">APPROX_COUNT_DISTINCT()</a>, BigQuery has <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/hll_functions#hll_countinit">HLL_COUNT</a>.INIT()/MERGE() functions, which allow you to save registers on aggregation, and to calculate cardinality later by grouping.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> HLL_COUNT.MERGE(hll_sketch) <span style="color:#ff79c6">AS</span> distinct_customers_with_open_invoice　<span style="color:#6272a4">-- =&gt; 3
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">FROM</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">SELECT</span>
</span></span><span style="display:flex;"><span>    country,
</span></span><span style="display:flex;"><span>    HLL_COUNT.INIT(customer_id) <span style="color:#ff79c6">AS</span> hll_sketch
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">FROM</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">UNNEST</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">ARRAY</span><span style="color:#ff79c6">&lt;</span>STRUCT<span style="color:#ff79c6">&lt;</span>country STRING, customer_id STRING, invoice_id STRING<span style="color:#ff79c6">&gt;&gt;</span>[
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#39;UA&#39;</span>, <span style="color:#f1fa8c">&#39;customer_id_1&#39;</span>, <span style="color:#f1fa8c">&#39;invoice_id_11&#39;</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#39;BR&#39;</span>, <span style="color:#f1fa8c">&#39;customer_id_3&#39;</span>, <span style="color:#f1fa8c">&#39;invoice_id_31&#39;</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#39;CZ&#39;</span>, <span style="color:#f1fa8c">&#39;customer_id_2&#39;</span>, <span style="color:#f1fa8c">&#39;invoice_id_22&#39;</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#39;CZ&#39;</span>, <span style="color:#f1fa8c">&#39;customer_id_2&#39;</span>, <span style="color:#f1fa8c">&#39;invoice_id_23&#39;</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#39;BR&#39;</span>, <span style="color:#f1fa8c">&#39;customer_id_3&#39;</span>, <span style="color:#f1fa8c">&#39;invoice_id_31&#39;</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#39;UA&#39;</span>, <span style="color:#f1fa8c">&#39;customer_id_2&#39;</span>, <span style="color:#f1fa8c">&#39;invoice_id_24&#39;</span>)])
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">GROUP</span> <span style="color:#ff79c6">BY</span> country
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div>
    </div>
  </article>
</div>

</div>
</body>

</html>