<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Preprocess data with SageMaker Processing, train model with Training and record the parameters and accuracy with Experiments - sambaiz-net</title>
  <meta name="twitter:title" content="Preprocess data with SageMaker Processing, train model with Training and record the parameters and accuracy with Experiments - sambaiz-net">
  <meta property='og:title' content="Preprocess data with SageMaker Processing, train model with Training and record the parameters and accuracy with Experiments - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="track from preprocessing to learning as a Run in Experiments and confirm that multiple results can be compared">
  <meta name="twitter:description" content="track from preprocessing to learning as a Run in Experiments and confirm that multiple results can be compared">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/442/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/442/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/442/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/442/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Preprocess data with SageMaker Processing, train model with Training and record the parameters and accuracy with Experiments",
    "datePublished": "2023-05-04T19:20:00JST",
    "dateModified": "2023-05-04T19:20:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "track from preprocessing to learning as a Run in Experiments and confirm that multiple results can be compared"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/442/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Preprocess data with SageMaker Processing, train model with Training and record the parameters and accuracy with Experiments</h1>
        <time>2023-05-04</time>
        <a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/machinelearning/'>machinelearning</a>
      </div>
      <p><a href="https://docs.aws.amazon.com/sagemaker/latest/dg/experiments.html">SageMaker Experiments</a> is a feature to record parameters and metrics
of <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/processing-job.html">Processing</a>
and <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/train-model.html">Training</a> jobs etc.
In this article, I track from preprocessing to learning as a Run in Experiments and confirm that multiple results can be compared.</p>
<p>The full code is on <a href="https://github.com/sambaiz/sagemaker-processing-training-experiments-test">GitHub</a>.</p>
<h2 id="sagemaker-experiments">SageMaker Experiments</h2>
<p>experiments.Run() creates an Experiment if it hasn&rsquo;t existed yet and starts a Run.
Previously, it was a separate library called sagemaker-experiments, but now it is <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/experiments-additional-sdk.html">integrated</a> into sagemaker.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> sagemaker <span style="color:#ff79c6">import</span> experiments
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>experiment_name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;test-experiment-</span><span style="color:#f1fa8c">{</span>now<span style="color:#ff79c6">.</span>strftime(<span style="color:#f1fa8c">&#34;%Y%m</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">%H%M%S&#34;</span>)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">with</span> experiments<span style="color:#ff79c6">.</span>Run(experiment_name, run_name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;run1&#34;</span>) <span style="color:#ff79c6">as</span> run:
</span></span><span style="display:flex;"><span>  preprocess(run)
</span></span><span style="display:flex;"><span>  train(run, {<span style="color:#f1fa8c">&#39;aaa&#39;</span>: <span style="color:#bd93f9">0.4</span>, <span style="color:#f1fa8c">&#39;bbb&#39;</span>: <span style="color:#ff79c6">True</span>})
</span></span></code></pre></div><p>Doing load_run() and log_parameter() in each script, parameters are recorded in Run.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> sagemaker.experiments <span style="color:#ff79c6">import</span> load_run
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">with</span> load_run() <span style="color:#ff79c6">as</span> run:
</span></span><span style="display:flex;"><span>    run<span style="color:#ff79c6">.</span>log_parameter(<span style="color:#f1fa8c">&#34;param1&#34;</span>, <span style="color:#f1fa8c">&#34;value1&#34;</span>) 
</span></span></code></pre></div><p>Metrics are also recorded in Experiments, but this is recorded in the Trial Component of the training job instead of Run.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>metric_definitions<span style="color:#ff79c6">=</span>[{<span style="color:#f1fa8c">&#39;Name&#39;</span>: <span style="color:#f1fa8c">&#39;test:accuracy&#39;</span>, <span style="color:#f1fa8c">&#39;Regex&#39;</span>: <span style="color:#f1fa8c">&#39;test:accuracy=(\d\.\d+)&#39;</span>}],
</span></span><span style="display:flex;"><span>enable_sagemaker_metrics<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,
</span></span></code></pre></div><h2 id="sagemaker-processing">SageMaker Processing</h2>
<p>If you call a function like the following from SageMaker Studio or locally, resources will be set up and the script will be executed.
In this example, <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-your-own-processing-container.html">running it on my own image</a>,
but you can also use images provided by SageMaker such as PySparkProcessor and SKLearnProcessor.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">preprocess</span>(run: experiments<span style="color:#ff79c6">.</span>Run):
</span></span><span style="display:flex;"><span>  processor <span style="color:#ff79c6">=</span> Processor(
</span></span><span style="display:flex;"><span>    base_job_name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;preprocess-</span><span style="color:#f1fa8c">{</span>run<span style="color:#ff79c6">.</span>run_name<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#39;</span>,
</span></span><span style="display:flex;"><span>    image_uri<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">{</span>os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#34;ECR_REPOSITORY_PREPROCESS&#34;</span>)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:latest&#39;</span>,
</span></span><span style="display:flex;"><span>    role<span style="color:#ff79c6">=</span>os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#39;ROLE_ARN&#39;</span>),
</span></span><span style="display:flex;"><span>    instance_count<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;"><span>    instance_type<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;ml.m5.xlarge&#39;</span>,
</span></span><span style="display:flex;"><span>    env<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;AWS_DEFAULT_REGION&#39;</span>: os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#39;AWS_DEFAULT_REGION&#39;</span>, <span style="color:#f1fa8c">&#39;ap-northeast-1&#39;</span>)},
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>  processor<span style="color:#ff79c6">.</span>run(
</span></span><span style="display:flex;"><span>    inputs<span style="color:#ff79c6">=</span>[
</span></span><span style="display:flex;"><span>      ProcessingInput(
</span></span><span style="display:flex;"><span>        source<span style="color:#ff79c6">=</span>os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#39;S3_DATA_PATH&#39;</span>),
</span></span><span style="display:flex;"><span>        destination<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;/opt/ml/processing/input&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># s3_data_distribution_type=&#39;ShardedByS3Key&#39;,</span>
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    outputs<span style="color:#ff79c6">=</span>[
</span></span><span style="display:flex;"><span>      ProcessingOutput(
</span></span><span style="display:flex;"><span>        source<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;/opt/ml/processing/output&#39;</span>,
</span></span><span style="display:flex;"><span>        destination<span style="color:#ff79c6">=</span>os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#39;S3_DATA_PATH&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># s3_upload_mode=&#39;Continuous&#39;</span>
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    arguments<span style="color:#ff79c6">=</span>[
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#39;--xxx&#39;</span>, <span style="color:#f1fa8c">&#39;12345&#39;</span>,
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    wait<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,
</span></span><span style="display:flex;"><span>  )
</span></span></code></pre></div><p>Source objects are downloaded to the path starting from /opt/ml/processing/ specified as inputs,
and once you write files to the path specified as outputs, it will be uploaded to S3.
By default, all objects are downloaded to each instance, but s3_data_distribution_type=&lsquo;ShardedByS3Key&rsquo; <a href="https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_S3DataSource.html">makes them sharded</a>.
Also, if you set s3_upload_mode=&lsquo;Continuous&rsquo;, files will be <a href="https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_ProcessingS3Output.html">uploaded continuously</a> instead of at the end of the job.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> argparse
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> pandas <span style="color:#ff79c6">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> sagemaker.experiments <span style="color:#ff79c6">import</span> load_run
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">main</span>():
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;- preprocessing started&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  parser <span style="color:#ff79c6">=</span> argparse<span style="color:#ff79c6">.</span>ArgumentParser()
</span></span><span style="display:flex;"><span>  parser<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--xxx&#39;</span>, <span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">int</span>, required<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)
</span></span><span style="display:flex;"><span>  args <span style="color:#ff79c6">=</span> parser<span style="color:#ff79c6">.</span>parse_args()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">with</span> load_run() <span style="color:#ff79c6">as</span> run:
</span></span><span style="display:flex;"><span>    run<span style="color:#ff79c6">.</span>log_parameters({<span style="color:#f1fa8c">&#39;preprocess:arg_xxx&#39;</span>: args<span style="color:#ff79c6">.</span>xxx})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  df <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>read_csv(<span style="color:#f1fa8c">&#34;/opt/ml/processing/input/raw.csv&#34;</span>)
</span></span><span style="display:flex;"><span>  df<span style="color:#ff79c6">.</span>iloc[:<span style="color:#bd93f9">5</span>,:]<span style="color:#ff79c6">.</span>to_csv(<span style="color:#f1fa8c">&#39;/opt/ml/processing/output/train.csv&#39;</span>)
</span></span><span style="display:flex;"><span>  df<span style="color:#ff79c6">.</span>iloc[<span style="color:#bd93f9">5</span>:,:]<span style="color:#ff79c6">.</span>to_csv(<span style="color:#f1fa8c">&#39;/opt/ml/processing/output/test.csv&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>  main()
</span></span></code></pre></div><h2 id="sagemaker-training">SageMaker Training</h2>
<p>Similar to Processing, if you call a function like the following, resources will be set up and training will start.
Estimators for each framework are provided by SageMaker, but this time I&rsquo;m <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/your-algorithms-training-algo.html">running it on my own image</a>.</p>
<p><a href="https://www.sambaiz.net/article/287/">SageMakerでPyTorchのモデルを学習させる - sambaiz-net</a></p>
<p><a href="https://www.sambaiz.net/article/293/">SageMakerでTensorFlowのモデルを学習させる - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">train</span>(run: experiments<span style="color:#ff79c6">.</span>Run, hyperparameters: <span style="color:#8be9fd;font-style:italic">object</span> <span style="color:#ff79c6">=</span> {}):
</span></span><span style="display:flex;"><span>  estimator <span style="color:#ff79c6">=</span> Estimator(
</span></span><span style="display:flex;"><span>    base_job_name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;train-</span><span style="color:#f1fa8c">{</span>run<span style="color:#ff79c6">.</span>run_name<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#39;</span>,
</span></span><span style="display:flex;"><span>    image_uri<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">{</span>os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#34;ECR_REPOSITORY_TRAIN&#34;</span>)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:latest&#39;</span>,
</span></span><span style="display:flex;"><span>    training_repository_access_mode<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;Platform&#39;</span>,
</span></span><span style="display:flex;"><span>    role<span style="color:#ff79c6">=</span>os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#39;ROLE_ARN&#39;</span>),
</span></span><span style="display:flex;"><span>    instance_count<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;"><span>    instance_type<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;ml.m5.xlarge&#39;</span>,
</span></span><span style="display:flex;"><span>    hyperparameters<span style="color:#ff79c6">=</span>hyperparameters,
</span></span><span style="display:flex;"><span>    environment<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;AWS_DEFAULT_REGION&#39;</span>: os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#39;AWS_DEFAULT_REGION&#39;</span>, <span style="color:#f1fa8c">&#39;ap-northeast-1&#39;</span>)},
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># output_path=,</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  data_path <span style="color:#ff79c6">=</span> os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#39;S3_DATA_PATH&#39;</span>)
</span></span><span style="display:flex;"><span>  estimator<span style="color:#ff79c6">.</span>fit(
</span></span><span style="display:flex;"><span>    inputs<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;training&#39;</span>: data_path, <span style="color:#f1fa8c">&#39;testing&#39;</span>: data_path},
</span></span><span style="display:flex;"><span>    wait<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>  )
</span></span></code></pre></div><p>inputs are placed in <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/your-algorithms-training-algo-running-container.html#your-algorithms-training-algo-running-container-trainingdata">/opt/ml/input/data</a>,
and Hyperparameters are written to <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/your-algorithms-training-algo-running-container.html#your-algorithms-training-algo-running-container-hyperparameters">/opt/ml/input/config/hyperparameters.json</a>.
Trained models are uploaded by writing to <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/your-algorithms-training-algo-output.html">/opt/ml/model</a>.
You can refer to these paths with sagemaker_training library.
If no output_path is specified, it will be uploaded to SageMaker&rsquo;s default Bucket, sagemaker-region-account-id .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> sagemaker.experiments <span style="color:#ff79c6">import</span> load_run
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> sagemaker_training <span style="color:#ff79c6">import</span> environment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> pandas <span style="color:#ff79c6">as</span> pd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">train</span>(data_path: <span style="color:#8be9fd;font-style:italic">str</span>, hyperparameters: <span style="color:#8be9fd;font-style:italic">dict</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;data_path: </span><span style="color:#f1fa8c">{</span>data_path<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;hyperparameters: </span><span style="color:#f1fa8c">{</span>hyperparameters<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;training data:</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">{</span>pd<span style="color:#ff79c6">.</span>read_csv(data_path)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#39;trained model&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test</span>(data_path: <span style="color:#8be9fd;font-style:italic">str</span>, hyperparameters: <span style="color:#8be9fd;font-style:italic">dict</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">float</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">with</span> load_run() <span style="color:#ff79c6">as</span> run:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;test data:</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">{</span>pd<span style="color:#ff79c6">.</span>read_csv(data_path)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    run<span style="color:#ff79c6">.</span>log_parameters({<span style="color:#f1fa8c">&#39;test:hp_bbb&#39;</span>: hyperparameters<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;bbb&#39;</span>)})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> epoch <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">10</span>):
</span></span><span style="display:flex;"><span>      run<span style="color:#ff79c6">.</span>log_metric(name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;test:accuracy&#34;</span>, value<span style="color:#ff79c6">=</span>hyperparameters<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;aaa&#39;</span>, <span style="color:#bd93f9">0.0</span>) <span style="color:#ff79c6">/</span> epoch, step<span style="color:#ff79c6">=</span>epoch)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">main</span>():
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;- training started&#34;</span>)
</span></span><span style="display:flex;"><span>  env <span style="color:#ff79c6">=</span> environment<span style="color:#ff79c6">.</span>Environment()
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;master_hostname: </span><span style="color:#f1fa8c">{</span>env<span style="color:#ff79c6">.</span>master_hostname<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, current_host: </span><span style="color:#f1fa8c">{</span>env<span style="color:#ff79c6">.</span>current_host<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  model <span style="color:#ff79c6">=</span> train(os<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>join(env<span style="color:#ff79c6">.</span>channel_input_dirs[<span style="color:#f1fa8c">&#39;training&#39;</span>], <span style="color:#f1fa8c">&#39;train.csv&#39;</span>), env<span style="color:#ff79c6">.</span>hyperparameters)  <span style="color:#6272a4"># /opt/ml/input/data/training</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">with</span> <span style="color:#8be9fd;font-style:italic">open</span>(os<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>join(env<span style="color:#ff79c6">.</span>model_dir, <span style="color:#f1fa8c">&#39;some_model.dat&#39;</span>), <span style="color:#f1fa8c">&#39;w&#39;</span>) <span style="color:#ff79c6">as</span> f:  <span style="color:#6272a4"># /opt/ml/model</span>
</span></span><span style="display:flex;"><span>    f<span style="color:#ff79c6">.</span>write(model)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  test(os<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>join(env<span style="color:#ff79c6">.</span>channel_input_dirs[<span style="color:#f1fa8c">&#39;testing&#39;</span>], <span style="color:#f1fa8c">&#39;test.csv&#39;</span>), env<span style="color:#ff79c6">.</span>hyperparameters)  <span style="color:#6272a4"># /opt/ml/input/data/testing</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>  main()
</span></span></code></pre></div><h2 id="experiment-results">Experiment results</h2>
<p>Check experiment results with ExperimentAnalytics.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>from sagemaker.analytics import ExperimentAnalytics
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>experiment_analytics = ExperimentAnalytics(experiment_name)df = experiment_analytics.dataframe()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df[&#39;Source&#39;] = df[&#39;SourceArn&#39;].apply(lambda x: str(x).split(&#39;:&#39;)[-1])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(df[[
</span></span><span style="display:flex;"><span>  &#34;TrialComponentName&#34;,
</span></span><span style="display:flex;"><span>  &#34;Source&#34;,
</span></span><span style="display:flex;"><span>  &#34;preprocess:arg_xxx&#34;,
</span></span><span style="display:flex;"><span>  &#34;test:hp_bbb&#34;,
</span></span><span style="display:flex;"><span>  &#34;test:accuracy - Last&#34;
</span></span><span style="display:flex;"><span>]])
</span></span></code></pre></div><p>In addition to TrialComponents which have log_parameter() values, there are ones which have processing-job or training-job as Source.
By comparing run1 and run2, you can check which one has higher accuracy along with the parameter values.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>                                  TrialComponentName                                             Source  preprocess:arg_xxx test:hp_bbb  test:accuracy - Last
</span></span><span style="display:flex;"><span>0  train-run2-2023-05-02-16-40-40-901-aws-trainin...    training-job/train-run2-2023-05-02-16-40-40-901                 NaN         NaN                   NaN
</span></span><span style="display:flex;"><span>1                test-experiment-20230503012814-run2                                                nan             12345.0       False                   0.8
</span></span><span style="display:flex;"><span>2  preprocess-run2-2023-05-02-16-36-12-041-aws-pr...  processing-job/preprocess-run2-2023-05-02-16-3...                 NaN         NaN                   NaN
</span></span><span style="display:flex;"><span>3                test-experiment-20230503012814-run1                                                nan             12345.0        True                   0.4
</span></span><span style="display:flex;"><span>4  train-run1-2023-05-02-16-33-44-735-aws-trainin...    training-job/train-run1-2023-05-02-16-33-44-735                 NaN         NaN                   NaN
</span></span><span style="display:flex;"><span>5  preprocess-run1-2023-05-02-16-28-15-055-aws-pr...  processing-job/preprocess-run1-2023-05-02-16-2...                 NaN         NaN                   NaN
</span></span></code></pre></div><h2 id="visualize-on-sagemaker-studio">Visualize on SageMaker Studio</h2>
<p>Result of experiments can be checked on SageMaker Studio as well.</p>




<div class="img_container"><a href="/article/442/images/experiments.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/442/images/experiments_hu266782493441531571.png" width="548" height="370" alt="Experiment contents">
</a></div>


<p>Selecting runs and clicking Analyze, accuracy of each step can be visualized.</p>




<div class="img_container"><a href="/article/442/images/analyze.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/442/images/analyze_hu8542159377584484639.png" width="600" height="332" alt="visualized accuracy of each step">
</a></div>



    </div>
  </article>
</div>

</div>
</body>

</html>