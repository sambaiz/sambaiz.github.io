<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Install Prometheus with CDK and remote write aggregated data to New Relic with recording rules to save the amount of data - sambaiz-net</title>
  <meta name="twitter:title" content="Install Prometheus with CDK and remote write aggregated data to New Relic with recording rules to save the amount of data - sambaiz-net">
  <meta property='og:title' content="Install Prometheus with CDK and remote write aggregated data to New Relic with recording rules to save the amount of data - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="Prometheus&#39; recording rules is a feature that allows you to create new metrics from existing metrics in PromQL. This can save the amount of data sent to New Relic by sending aggregated data compared to sending raw data, but Prometheus in newrelic-prometheus-configurator included in newrelic-bundle is in Agent mode, so it doesn’t support Recording rules">
  <meta name="twitter:description" content="Prometheus&#39; recording rules is a feature that allows you to create new metrics from existing metrics in PromQL. This can save the amount of data sent to New Relic by sending aggregated data compared to sending raw data, but Prometheus in newrelic-prometheus-configurator included in newrelic-bundle is in Agent mode, so it doesn’t support Recording rules">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/487/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/487/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/487/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/487/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Install Prometheus with CDK and remote write aggregated data to New Relic with recording rules to save the amount of data",
    "datePublished": "2024-05-23T02:22:00JST",
    "dateModified": "2024-05-23T02:22:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "Prometheus' recording rules is a feature that allows you to create new metrics from existing metrics in PromQL. This can save the amount of data sent to New Relic by sending aggregated data compared to sending raw data, but Prometheus in newrelic-prometheus-configurator included in newrelic-bundle is in Agent mode, so it doesn’t support Recording rules"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/487/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Install Prometheus with CDK and remote write aggregated data to New Relic with recording rules to save the amount of data</h1>
        <time>2024-05-23</time>
        <a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/kubernetes/'>kubernetes</a><a class="tag" href='/en/tags/newrelic/'>newrelic</a><a class="tag" href='/en/tags/prometheus/'>prometheus</a>
      </div>
      <p>Prometheus&rsquo; <a href="https://prometheus.io/docs/prometheus/2.52/configuration/recording_rules/">recording rules</a> is a feature that allows you to create new metrics from existing metrics in PromQL. This can save the amount of data sent to New Relic by sending aggregated data compared to sending raw data, but Prometheus in newrelic-prometheus-configurator included in newrelic-bundle is in Agent mode, so it <a href="https://github.com/prometheus/prometheus/blob/v2.52.0/config/config.go#L124">doesn’t support</a> Recording rules.</p>
<p><a href="https://www.sambaiz.net/en/article/466/">Install newrelic-bundle to EKS cluster with CDK and monitor it - sambaiz-net</a></p>
<p>So I install my own Prometheus using <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus">Helm</a> and do remote write.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>cluster.addHelmChart(<span style="color:#f1fa8c">&#39;PrometheusOperatorChart&#39;</span>, {
</span></span><span style="display:flex;"><span>  release<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;kube-prometheus-stack&#39;</span>,
</span></span><span style="display:flex;"><span>  chart<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;kube-prometheus-stack&#39;</span>,
</span></span><span style="display:flex;"><span>  repository<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;https://prometheus-community.github.io/helm-charts&#39;</span>,
</span></span><span style="display:flex;"><span>  version<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;59.1.0&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;prometheus&#39;</span>,
</span></span><span style="display:flex;"><span>  createNamespace: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>  values<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    defaultRules<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      create: <span style="color:#8be9fd">false</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    prometheus<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      enabled: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>      prometheusSpec<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>        storageSpec<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>          volumeClaimTemplate<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>            spec<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>              resources<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>                requests<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>                  storage<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;30Gi&#39;</span>,
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>              },
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        retention<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;7d&#39;</span>,
</span></span><span style="display:flex;"><span>        retentionSize<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;25GB&#39;</span>,
</span></span><span style="display:flex;"><span>        remoteWrite<span style="color:#ff79c6">:</span> [{
</span></span><span style="display:flex;"><span>          url<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;https://metric-api.newrelic.com/prometheus/v1/write?prometheus_server=prometheus&#39;</span>,
</span></span><span style="display:flex;"><span>          authorization<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">type</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;Bearer&#39;</span>,
</span></span><span style="display:flex;"><span>            credentials<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>              key: <span style="color:#8be9fd">secretKey</span>,
</span></span><span style="display:flex;"><span>              name: <span style="color:#8be9fd">secretName</span>,
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>          writeRelabelConfigs<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              sourceLabels<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;aaaa&#39;</span>],
</span></span><span style="display:flex;"><span>              separator<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;;&#39;</span>,
</span></span><span style="display:flex;"><span>              regex<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;bbbb&#39;</span>,
</span></span><span style="display:flex;"><span>              action<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;keep&#39;</span>,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>          ],
</span></span><span style="display:flex;"><span>        }],
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    nodeExporter<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      enabled: <span style="color:#8be9fd">false</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    alertmanager<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      enabled: <span style="color:#8be9fd">false</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    grafana<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      enabled: <span style="color:#8be9fd">false</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>When you install this, a Prometheus server will be started via <a href="https://github.com/prometheus-operator/prometheus-operator?tab=readme-ov-file#customresourcedefinitions">CRD</a> such as Prometheus. There is also a <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus">chart</a> that doesn&rsquo;t use operators, but since extraScrapeConfigs is a string, if the indent is incorrect it will cause an error so it is difficult to set up. Additionally, the operator providing various CRDs has an advantage that it is easy to start a Prometheus server and set up scraping as needed on the application side.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> extraScrapeConfigs <span style="color:#ff79c6">=</span> 
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">`- job_name: newrelic-pods
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  honor_timestamps: true
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  scrape_interval: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  scrape_timeout: 10s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  ...`</span>
</span></span></code></pre></div><p>Alertmanager etc. are also started by default, but since I don’t use them this time, I disabled them.</p>




<div class="img_container"><a href="/article/487/images/prometheus.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/487/images/prometheus_hu1180738236905643609.png" width="600" height="360" alt="Architecture of Prometheus">
</a></div>


<p>You can add targets to scrape with Service|PodMonitor, and can set recording rules with PrometheusRule. <a href="https://prometheus.io/docs/practices/rules/#naming">Metric names</a> should be in the format of level:metric:operations.</p>
<p>If podMonitorSelectorNilUsesHelmValues ​​is the default true,
<a href="https://github.com/prometheus-community/helm-charts/blob/db15dcf70d06da9c71454f7d9757b47b04d2c5ae/charts/kube-prometheus-stack/templates/prometheus/prometheus.yaml#L175">service|podMonitorSelector</a> will be matchLabels: release:, so if you don&rsquo;t add this label, it won&rsquo;t be loaded into configuration. If it is loaded into configuration but doesn&rsquo;t appear in targets, check that the values ​​of selector, etc. are correct. port in <a href="https://github.com/prometheus-operator/prometheus-operator/blob/v0.74.0/Documentation/api.md#podmetricsendpoint">podMetricsEndpoints</a> can be received only port name, and the number can be passed as the targetPort corresponding to <a href="https://github.com/prometheus-operator/prometheus-operator/blob/77e92ecd4e89c6e647f2d57eca51d1c0d56c9aa5/pkg/prometheus/promcfg.go#L985C45-L985C88">__meta_kubernetes_pod_container_port_number</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: monitoring.coreos.com/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PodMonitor
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: testapp-monitor
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: prometheus
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">release</span>: kube-prometheus-stack
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: testapp
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespaceSelector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchNames</span>:
</span></span><span style="display:flex;"><span>    - testapp
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">podMetricsEndpoints</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">port</span>: monitor
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">path</span>: /metrics
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">interval</span>: 5m
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">scrapeTimeout</span>: 10s
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: monitoring.coreos.com/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PrometheusRule
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: example
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: prometheus
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">release</span>: kube-prometheus-stack
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">groups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">name</span>: example
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">interval</span>: 5m
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">record</span>: code:prometheus_http_requests_total:sum
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">expr</span>: sum by (code) (prometheus_http_requests_total)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">aaaa</span>: bbbb
</span></span></code></pre></div><p>Port forward to Prometheus server and try fetching the metrics of Recording rules with PromQL.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ kubectl -n prometheus port-forward svc/prometheus-server 9090:80
</span></span><span style="display:flex;"><span>Forwarding from 127.0.0.1:9090 -&gt; <span style="color:#bd93f9">9090</span>
</span></span><span style="display:flex;"><span>Forwarding from <span style="color:#ff79c6">[</span>::1<span style="color:#ff79c6">]</span>:9090 -&gt; <span style="color:#bd93f9">9090</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl -G <span style="color:#f1fa8c">&#39;http://localhost:9090/api/v1/query&#39;</span> --data-urlencode <span style="color:#f1fa8c">&#39;query=code:prometheus_http_requests_total:sum&#39;</span> | jq
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;status&#34;</span>: <span style="color:#f1fa8c">&#34;success&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;data&#34;</span>: <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;resultType&#34;</span>: <span style="color:#f1fa8c">&#34;vector&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;result&#34;</span>: <span style="color:#ff79c6">[</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;metric&#34;</span>: <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">&#34;__name__&#34;</span>: <span style="color:#f1fa8c">&#34;code:prometheus_http_requests_total:sum&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">&#34;aaaa&#34;</span>: <span style="color:#f1fa8c">&#34;bbbb&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">&#34;code&#34;</span>: <span style="color:#f1fa8c">&#34;200&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;value&#34;</span>: <span style="color:#ff79c6">[</span>
</span></span><span style="display:flex;"><span>          1716339421.309,
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">&#34;182&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;metric&#34;</span>: <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">&#34;__name__&#34;</span>: <span style="color:#f1fa8c">&#34;code:prometheus_http_requests_total:sum&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">&#34;aaaa&#34;</span>: <span style="color:#f1fa8c">&#34;bbbb&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">&#34;code&#34;</span>: <span style="color:#f1fa8c">&#34;302&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;value&#34;</span>: <span style="color:#ff79c6">[</span>
</span></span><span style="display:flex;"><span>          1716339421.309,
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">&#34;2&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>You can confirm that it has also been sent to New Relic.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> Metric 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> latest(<span style="color:#ff79c6">`</span>code:prometheus_http_requests_total:<span style="color:#ff79c6">sum</span><span style="color:#ff79c6">`</span>) 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WHERE</span> prometheus_server <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;prometheus&#39;</span> FACET code
</span></span></code></pre></div>
    </div>
  </article>
</div>

</div>
</body>

</html>