<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .share-button > img {
        border: none;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }

    .share {
        position: relative;
        text-align: right;
        margin-top: 5px;
    }

    .share .cell {
        display: inline-block;
        text-align: center;
        margin-bottom: 5px;
    }

    .share-button {
        display: inline-block;
        margin: 0 5px;
    }

    @media screen and (min-width: 1400px) {
        .share .cell {
            position: absolute;
            bottom: 0;
            margin-left: 5px;
        }

        .share-button {
            display: inline-block;
            margin: 5px 0;
        }
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Deploy a container to ECS on Fargate, execute commands by ECS Exec, and perform port forwarding by Session Manager - sambaiz-net</title>
  <meta name="twitter:title" content="Deploy a container to ECS on Fargate, execute commands by ECS Exec, and perform port forwarding by Session Manager - sambaiz-net">
  <meta property='og:title' content="Deploy a container to ECS on Fargate, execute commands by ECS Exec, and perform port forwarding by Session Manager - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="Execute commands and perform port forwarding on the container running in ECS on Fargate without sshd">
  <meta name="twitter:description" content="Execute commands and perform port forwarding on the container running in ECS on Fargate without sshd">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/410/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/410/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/410/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/410/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Deploy a container to ECS on Fargate, execute commands by ECS Exec, and perform port forwarding by Session Manager",
    "datePublished": "2022-07-23T13:45:00JST",
    "dateModified": "2022-07-23T13:45:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "Execute commands and perform port forwarding on the container running in ECS on Fargate without sshd"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/410/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.goodreads.com/sambaiz">
            <img src="/image/goodreads.svg" width="30px" height="30px" alt="goodreads">
          </a>
        </div>
        <div class="sns-item">
          <a href="https://filmarks.com/users/sambaiz" class="filmarks" aria-label="filmarks"></a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/ios/">
            ios</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Deploy a container to ECS on Fargate, execute commands by ECS Exec, and perform port forwarding by Session Manager</h1>
        <time>2022-07-23</time>
        <a class="tag" href='/en/tags/aws/'>aws</a>
      </div>
      <p>When investigating an application running in a remote non-container environment, sshd is often running, so commands can be executed with SSH connection.
On the other hand, sshd isn&rsquo;t usually running in a container environment, so it can&rsquo;t be executed similarly.
If absolutely necessary, there is a way to run sshd, but it would be better to avoid it in terms of opening ports and managing keys.
In this article, command execution and port forwarding are performed without running sshd in a container running in ECS on Fargate.</p>
<p>Deploy an application with <a href="https://aws.github.io/copilot-cli/">AWS Copilot</a>, which is a CLI to deploy an application to App Runner or ECS on Fargate.</p>
<p><a href="https://www.sambaiz.net/article/361/">AWS App Runnerの特徴と料金、CloudFormationのResource - sambaiz-net</a></p>
<p>It <a href="https://github.com/aws/copilot-cli/issues/1094">doesn&rsquo;t support</a> ECS on EC2 currently, but if the use case is suitable, it creates resources such as VPC and ELB depending on the type, so it is easy to deploy the application.
Besides, existing resources created with CDK etc. are also usable.</p>
<p><a href="https://www.sambaiz.net/article/377/">CDKでALBとECS(EC2)クラスタを作成し、ecs-cliでDocker Composeの構成をデプロイする - sambaiz-net</a></p>
<h2 id="deploy">Deploy</h2>
<p>Create an environment with <a href="https://aws.github.io/copilot-cli/docs/commands/init/">copilot init</a>, and &ndash;deploy Load Balanced Web Service on Fargate to the test environment.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ brew install aws/tap/copilot-cli
</span></span><span style="display:flex;"><span>$ copilot -v
</span></span><span style="display:flex;"><span>copilot version: v1.19.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ copilot init --app testapp         <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --name app                         <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --type <span style="color:#f1fa8c">&#39;Load Balanced Web Service&#39;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --dockerfile <span style="color:#f1fa8c">&#39;./Dockerfile&#39;</span>        <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --deploy
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>✔ Deployed service app.
</span></span><span style="display:flex;"><span>Recommended follow-up action:
</span></span><span style="display:flex;"><span>  - You can access your service at http://****.ap-northeast-1.elb.amazonaws.com over the internet.
</span></span><span style="display:flex;"><span>- Be a part of the Copilot ✨community✨!
</span></span><span style="display:flex;"><span>  Ask or answer a question, submit a feature request...
</span></span><span style="display:flex;"><span>  Visit 👉 https://aws.github.io/copilot-cli/community/get-involved/ to see how!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ copilot env ls
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">test</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl http://****.ap-northeast-1.elb.amazonaws.com/
</span></span><span style="display:flex;"><span>ok
</span></span></code></pre></div><p>Manifest like following is created.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>$ cat copilot/app/manifest.yml 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">name</span>: app
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">type</span>: Load Balanced Web Service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">http</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">path</span>: <span style="color:#f1fa8c">&#39;/&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">image</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">build</span>: Dockerfile
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8080</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">cpu</span>: <span style="color:#bd93f9">256</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">memory</span>: <span style="color:#bd93f9">512</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">count</span>: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">exec</span>: <span style="color:#ff79c6">true</span>
</span></span></code></pre></div><h2 id="command-execution-with-ecs-exec">Command execution with ECS Exec</h2>
<p><a href="https://docs.aws.amazon.com/AmazonECS/latest/userguide/ecs-exec.html">ECS Exec</a> is a feature that can run commands in a container like &ldquo;kubectl exec&rdquo;, and Copilot can use it with <a href="https://aws.github.io/copilot-cli/docs/commands/svc-exec/">copilot svc exec</a>.
If <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html">Session Manager plugin for the AWS CLI</a> isn&rsquo;t installed in the local machine yet, it is installed first.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ copilot svc <span style="color:#8be9fd;font-style:italic">exec</span> --app testapp <span style="color:#8be9fd;font-style:italic">test</span> --env <span style="color:#8be9fd;font-style:italic">test</span> --name app
</span></span><span style="display:flex;"><span>Looks like the Session Manager plugin is not installed yet.
</span></span><span style="display:flex;"><span>Would you like to install the plugin to execute into the container? Yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ session-manager-plugin --version
</span></span><span style="display:flex;"><span>1.2.339.0
</span></span></code></pre></div><p>If no command or /bin/sh is passed, shell is started.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ copilot svc <span style="color:#8be9fd;font-style:italic">exec</span> --app testapp <span style="color:#8be9fd;font-style:italic">test</span> --env <span style="color:#8be9fd;font-style:italic">test</span> --name app --command /bin/sh
</span></span><span style="display:flex;"><span>Execute <span style="color:#f1fa8c">`</span>/bin/sh<span style="color:#f1fa8c">`</span> in container app in task e136ade28eeb48c5ae69b3681e0e0741.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Starting session with SessionId: ecs-execute-command-0ff9d37f33292cbcd
</span></span><span style="display:flex;"><span>/ <span style="color:#6272a4"># hostname</span>
</span></span><span style="display:flex;"><span>ip-10-0-0-147.ap-northeast-1.compute.internal
</span></span></code></pre></div><p><a href="https://docs.aws.amazon.com/AmazonECS/latest/userguide/ecs-exec.html#ecs-exec-architecture">Internally</a>, the <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html">SSM agent</a> binary is mounted and a session is created in <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html">Session Manager</a> of Systems Manager (formerly SSM).</p>




<div class="img_container"><a href="/en/article/410/images/session_manager.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/en/article/410/images/session_manager_hue1f95cdf5312afc0c8778fb6c7da9f8a_451472_600x370_fit_lanczos_3.png" width="600" height="169" alt="Session Manager">
</a></div>


<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>/ <span style="color:#6272a4"># yum -y install procps</span>
</span></span><span style="display:flex;"><span>/ <span style="color:#6272a4"># ps aux</span>
</span></span><span style="display:flex;"><span>USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span style="display:flex;"><span>root         <span style="color:#bd93f9">1</span>  0.0  1.1 <span style="color:#bd93f9">2689044</span> <span style="color:#bd93f9">47296</span> ?       Ssl  03:31   0:02 java App
</span></span><span style="display:flex;"><span>root         <span style="color:#bd93f9">8</span>  0.0  0.3 <span style="color:#bd93f9">1323312</span> <span style="color:#bd93f9">15552</span> ?       Ssl  03:31   0:00 /managed-agents/execute-command/amazon-ssm-agent
</span></span><span style="display:flex;"><span>root        <span style="color:#bd93f9">35</span>  0.0  0.7 <span style="color:#bd93f9">1410172</span> <span style="color:#bd93f9">28080</span> ?       Sl   03:31   0:00 /managed-agents/execute-command/ssm-agent-worker
</span></span><span style="display:flex;"><span>root        <span style="color:#bd93f9">46</span>  0.2  0.5 <span style="color:#bd93f9">1327588</span> <span style="color:#bd93f9">23196</span> ?       Sl   04:10   0:01 /managed-agents/execute-command/ssm-session-worker ecs-execute-command-0893f9d72f4a53852
</span></span><span style="display:flex;"><span>root        <span style="color:#bd93f9">55</span>  0.0  0.0  <span style="color:#bd93f9">13564</span>  <span style="color:#bd93f9">3216</span> pts/0    Ss   04:10   0:00 /bin/sh
</span></span><span style="display:flex;"><span>root       <span style="color:#bd93f9">213</span>  0.0  0.0  <span style="color:#bd93f9">51672</span>  <span style="color:#bd93f9">3812</span> pts/0    R+   04:17   0:00 ps aux
</span></span></code></pre></div><h2 id="port-forwarding-with-session-manager">Port forwarding with Session Manager</h2>
<p>Session Manager also supports <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-getting-started-enable-ssh-connections.html">SSH tunnel</a>, so SSH connection can be established without opening the port,
but port forwarding can be performed by the SSM agent alone by starting-session with <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-sessions-start.html#sessions-start-port-forwarding">AWS-StartPortForwardingSession</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ aws ssm start-session --target <span style="color:#ff79c6">[</span>instance_id<span style="color:#ff79c6">]</span> --document-name AWS-StartPortForwardingSession --parameters <span style="color:#f1fa8c">&#39;{&#34;portNumber&#34;:[&#34;5005&#34;], &#34;localPortNumber&#34;:[&#34;5005&#34;]}&#39;</span>
</span></span></code></pre></div><h3 id="way-with-the-self-installed-ssm-agent">Way with the self installed SSM agent</h3>
<p><a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/agent-install-al2.html">Install</a> the SSM agent and AWS CLI.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span><span style="color:#f1fa8c"> amazoncorretto:18-al2-full AS builder</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">COPY</span> . .
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">RUN</span> javac -d ./out src/App.java
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#3d3f4a"><span><span style="color:#ff79c6">RUN</span> yum install -y unzip <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex; background-color:#3d3f4a"><span><span style="color:#f1fa8c"></span>    <span style="color:#ff79c6">&amp;&amp;</span> curl <span style="color:#f1fa8c">&#34;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip&#34;</span> -o <span style="color:#f1fa8c">&#34;awscliv2.zip&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex; background-color:#3d3f4a"><span><span style="color:#f1fa8c"></span>    <span style="color:#ff79c6">&amp;&amp;</span> unzip awscliv2.zip
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span><span style="color:#f1fa8c"> amazoncorretto:18.0.1-al2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#3d3f4a"><span><span style="color:#6272a4"># Install SSM Agent &amp; jq</span>
</span></span><span style="display:flex; background-color:#3d3f4a"><span><span style="color:#ff79c6">RUN</span> yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm jq <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex; background-color:#3d3f4a"><span><span style="color:#f1fa8c"></span>    <span style="color:#ff79c6">&amp;&amp;</span> rm -rf /var/cache/yum/* <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex; background-color:#3d3f4a"><span><span style="color:#f1fa8c"></span>    <span style="color:#ff79c6">&amp;&amp;</span> yum clean all
</span></span><span style="display:flex; background-color:#3d3f4a"><span>
</span></span><span style="display:flex; background-color:#3d3f4a"><span><span style="color:#6272a4"># Install AWS CLI</span>
</span></span><span style="display:flex; background-color:#3d3f4a"><span><span style="color:#ff79c6">COPY</span> --from<span style="color:#ff79c6">=</span>builder ./aws ./aws
</span></span><span style="display:flex; background-color:#3d3f4a"><span><span style="color:#ff79c6">RUN</span> ./aws/install
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">COPY</span> ./entrypoint.sh .
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">RUN</span> chmod u+x ./entrypoint.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">COPY</span> --from<span style="color:#ff79c6">=</span>builder ./out .
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">EXPOSE</span><span style="color:#f1fa8c"> 8080</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">CMD</span> [<span style="color:#f1fa8c">&#34;java&#34;</span>, <span style="color:#f1fa8c">&#34;App&#34;</span>]
</span></span></code></pre></div><p>entrypoint.sh <a href="https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/sysman-managed-instance-activation.html#create-managed-instance-activation-commandline">creates an activation</a> with
<a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/ssm/create-activation.html">aws ssm create-activaton</a>,
registers the instance to Systems Manager with <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-install-managed-linux.html">amazon-ssm-agent -register</a>,
and deregister-managed-instance on terminated.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cat entrypoint.sh
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#!/bin/bash -e</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">SERVICE_NAME_FULL</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">COPILOT_ENVIRONMENT_NAME</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">_</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">COPILOT_APPLICATION_NAME</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">_</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">COPILOT_SERVICE_NAME</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ASSUME_ROLE</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>aws sts assume-role --role-arn <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">ACTIVATION_ROLE_ARN</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span> --role-session-name <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">SERVICE_NAME_FULL</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">AWS_ACCESS_KEY_ID</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#8be9fd;font-style:italic">$ASSUME_ROLE</span> | jq -r .Credentials.AccessKeyId<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">AWS_SECRET_ACCESS_KEY</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#8be9fd;font-style:italic">$ASSUME_ROLE</span> | jq -r .Credentials.SecretAccessKey<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">AWS_SESSION_TOKEN</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#8be9fd;font-style:italic">$ASSUME_ROLE</span> | jq -r .Credentials.SessionToken<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;- create SSM activation&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ACTIVATION</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>aws ssm create-activation <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --default-instance-name <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">SERVICE_NAME_FULL</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --description <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">SERVICE_NAME_FULL</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c"> service in ECS on Fargate&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --iam-role <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">SSM_ROLE_NAME</span><span style="color:#f1fa8c">}</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ACTIVATION_CODE</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#8be9fd;font-style:italic">$ACTIVATION</span> | jq -r .ActivationCode<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ACTIVATION_ID</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#8be9fd;font-style:italic">$ACTIVATION</span> | jq -r .ActivationId<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;- register instance&#34;</span>
</span></span><span style="display:flex;"><span>amazon-ssm-agent -register -code <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">ACTIVATION_CODE</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span> -id <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">ACTIVATION_ID</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span> -region ap-northeast-1 -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cleanup<span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;- cleanup&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">MANAGED_INSTANCE_ID</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>cat /var/lib/amazon/ssm/registration | jq -r .ManagedInstanceID<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">[</span> -n <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">MANAGED_INSTANCE_ID</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">]</span>; <span style="color:#ff79c6">then</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;- deregister instance </span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">MANAGED_INSTANCE_ID</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>      aws ssm deregister-managed-instance --instance-id <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">MANAGED_INSTANCE_ID</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">||</span> <span style="color:#8be9fd;font-style:italic">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">[</span> -n <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">CHILD_PID</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">]</span>; <span style="color:#ff79c6">then</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;- kill the child process </span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">CHILD_PID</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">kill</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">CHILD_PID</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">wait</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">CHILD_PID</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">trap</span> <span style="color:#f1fa8c">&#34;cleanup&#34;</span> SIGTERM
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nohup amazon-ssm-agent &amp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># for troubleshooting</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># sleep 30</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># cat /var/log/amazon/ssm/amazon-ssm-agent.log || true</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># cat /var/log/amazon/ssm/errors.log || true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;- execute </span><span style="color:#8be9fd;font-style:italic">$*</span><span style="color:#f1fa8c"> as a child process&#34;</span>
</span></span><span style="display:flex;"><span>sh -c <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$*</span><span style="color:#f1fa8c">&#34;</span> &amp;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">CHILD_PID</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$!</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">wait</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">CHILD_PID</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span></code></pre></div><p>The <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-service-role.html">role</a> that is passed when create-activation is created by placing CloudFormation template in <a href="https://aws.github.io/copilot-cli/docs/developing/additional-aws-resources/">addons/</a>.
Parameters <a href="https://aws.github.io/copilot-cli/docs/developing/additional-aws-resources/#writing-a-template">must</a> contains App, Env, Name.
Outputs can be referenced as capital snake case environment values like SSM_ROLE_NAME.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>$ tree copilot/
</span></span><span style="display:flex;"><span>copilot/
</span></span><span style="display:flex;"><span>└── app
</span></span><span style="display:flex;"><span>    ├── addons
</span></span><span style="display:flex;"><span>    │   └── ssm-role.yaml
</span></span><span style="display:flex;"><span>    └── manifest.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat copilot/app/addons/ssm-role.yaml
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">AWSTemplateFormatVersion</span>: 2010-09-09
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">Parameters</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">App</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">Type</span>: String
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">Description</span>: Your application&#39;s name.
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">Env</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">Type</span>: String
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">Description</span>: The environment name your service, job, or workflow is being deployed to.
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">Name</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">Type</span>: String
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">Description</span>: The name of the service, job, or workflow being deployed.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">Resources</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">SSMRole</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">Type</span>: AWS::IAM::Role
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">AssumeRolePolicyDocument</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">Version</span>: 2012-10-17
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">Statement</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ff79c6">Effect</span>: Allow
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">Principal</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">Service</span>: [ <span style="color:#f1fa8c">&#39;ssm.amazonaws.com&#39;</span> ]
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">Action</span>: [ <span style="color:#f1fa8c">&#39;sts:AssumeRole&#39;</span> ]
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">Condition</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">StringEquals</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">aws:SourceAccount</span>: !Ref AWS::AccountId
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">ArnEquals</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">aws:SourceArn</span>: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:*
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">ManagedPolicyArns</span>:
</span></span><span style="display:flex;"><span>        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
</span></span><span style="display:flex;"><span>        - arn:aws:iam::aws:policy/AmazonSSMDirectoryServiceAccess
</span></span><span style="display:flex;"><span>        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ActivationRole</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">Type</span>: AWS::IAM::Role
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">AssumeRolePolicyDocument</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">Version</span>: 2012-10-17
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">Statement</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ff79c6">Effect</span>: Allow
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">Principal</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">AWS</span>: [ !Ref AWS::AccountId ]
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">Action</span>: [ <span style="color:#f1fa8c">&#39;sts:AssumeRole&#39;</span> ]
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">Policies</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">PolicyName</span>: SSMRolePassPolicy
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">Version</span>: 2012-10-17
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">Statement</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#ff79c6">Effect</span>: Allow
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">Action</span>:
</span></span><span style="display:flex;"><span>                  - iam:PassRole
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">Resource</span>: !GetAtt SSMRole.Arn
</span></span><span style="display:flex;"><span>              - <span style="color:#ff79c6">Effect</span>: Allow
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">Action</span>:
</span></span><span style="display:flex;"><span>                  - ssm:CreateActivation
</span></span><span style="display:flex;"><span>                  - ssm:DeregisterManagedInstance
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">Resource</span>: <span style="color:#f1fa8c">&#39;*&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">Outputs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">SSMRoleName</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">Description</span>: The SSM role name passed to create-activation
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">Value</span>: !Ref SSMRole
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ActivationRoleArn</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">Description</span>: The role arn to create activation and pass the SSM role
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">Value</span>: !GetAtt ActivationRole.Arn
</span></span></code></pre></div><p>iam:PassRole permission, which is needed for create-activation, can be added to TaskRole by creating AWS::IAM::ManagedPolicy as follows and outputting it, but
iam:* is denied by <a href="https://github.com/aws/copilot-cli/blob/v1.19.0/internal/pkg/template/templates/workloads/partials/cf/taskrole.yml#L19">DenyIAMExceptTaggedRoles</a> policy, so create a role and assume it.
Roles created here are attached tags of the application, so it <a href="https://github.com/aws/copilot-cli/blob/v1.19.0/internal/pkg/template/templates/workloads/partials/cf/taskrole.yml#L23">can</a> be assumed.</p>




<div class="img_container"><a href="/en/article/410/images/addon_policy.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/en/article/410/images/addon_policy_hu93c20d99275452b84ceb5bc7c4a292d2_188186_600x370_fit_lanczos_3.png" width="600" height="244" alt="Addon policy">
</a></div>


<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">SSMRolePassPolicy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">Type</span>: AWS::IAM::ManagedPolicy
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">Properties</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">Version</span>: 2012-10-17
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">Statement</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">Effect</span>: Allow
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">Action</span>:
</span></span><span style="display:flex;"><span>            - iam:PassRole
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">Resource</span>: !GetAtt SSMRole.Arn
</span></span></code></pre></div><p>Set ENTRYPOINT with manifest <a href="https://aws.github.io/copilot-cli/docs/manifest/lb-web-service/#entrypoint">entrypoint</a> so that local run is not affected.
It also disables ECS Exec to avoid conflicts with SSM agents.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>$ cat copilot/app/manifest.yml 
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">entrypoint</span>: [<span style="color:#f1fa8c">&#34;./entrypoint.sh&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">command</span>: [<span style="color:#f1fa8c">&#34;java&#34;</span>, <span style="color:#f1fa8c">&#34;App&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">exec</span>: <span style="color:#ff79c6">false</span>
</span></span></code></pre></div><p>Success if PingStatus is Online after deployment.
If enough permissions aren&rsquo;t given, ConnectionLost occurs, so check the SSM agent log.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ aws ssm describe-instance-information
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;InstanceInformationList&#34;</span>: <span style="color:#ff79c6">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;InstanceId&#34;</span>: <span style="color:#f1fa8c">&#34;mi-078951953b63f94d0&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;PingStatus&#34;</span>: <span style="color:#f1fa8c">&#34;Online&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;LastPingDateTime&#34;</span>: <span style="color:#f1fa8c">&#34;2022-07-21T20:32:05.949000+09:00&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;AgentVersion&#34;</span>: <span style="color:#f1fa8c">&#34;3.1.1575.0&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;IsLatestVersion&#34;</span>: false,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;PlatformType&#34;</span>: <span style="color:#f1fa8c">&#34;Linux&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;PlatformName&#34;</span>: <span style="color:#f1fa8c">&#34;Amazon Linux&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;PlatformVersion&#34;</span>: <span style="color:#f1fa8c">&#34;2&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;ActivationId&#34;</span>: <span style="color:#f1fa8c">&#34;842e7174-729e-4dba-a7ba-7caf293ebf28&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;IamRole&#34;</span>: <span style="color:#f1fa8c">&#34;testapp-test-app-AddonsStack-1JJP0GYRGTT98-SSMRole-MASCURUWZ85I&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;RegistrationDate&#34;</span>: <span style="color:#f1fa8c">&#34;2022-07-21T20:23:30.200000+09:00&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;ResourceType&#34;</span>: <span style="color:#f1fa8c">&#34;ManagedInstance&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;Name&#34;</span>: <span style="color:#f1fa8c">&#34;test_testapp_app&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;IPAddress&#34;</span>: <span style="color:#f1fa8c">&#34;10.0.1.220&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;ComputerName&#34;</span>: <span style="color:#f1fa8c">&#34;ip-10-0-1-220.ap-northeast-1.compute.internal&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>This instance is treated as on-premises, so Instance Tier <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-managedinstances-advanced.html">must</a> be Advance to start-session.
If set, each on-premises instance starts to be <a href="https://aws.amazon.com/systems-manager/pricing/?nc1=h_ls#On-Premises_Instance_Management">charged</a> per time.</p>




<div class="img_container"><a href="/en/article/410/images/advanced_instances.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/en/article/410/images/advanced_instances_hu2cf9dc7fbf52b99f78b5bbe73c91ab9b_143140_600x370_fit_lanczos_3.png" width="600" height="214" alt="Instance tier settings">
</a></div>


<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ aws ssm start-session --target mi-078951953b63f94d0 --document-name AWS-StartPortForwardingSession --parameters &#39;{&#34;portNumber&#34;:[&#34;8080&#34;], &#34;localPortNumber&#34;:[&#34;5000&#34;]}&#39;
</span></span><span style="display:flex;"><span>$ curl localhost:5000
</span></span><span style="display:flex;"><span>ok
</span></span></code></pre></div><h3 id="way-with-the-ecs-execs-ssm-agent">Way with the ECS Exec&rsquo;s SSM agent</h3>
<p>In fact, a session to the same target as ECS Exec can be started directly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ aws ssm start-session --target ecs:testapp-test-Cluster-VHaYIQCdoUj8_c0add05ab98c49d798ba1cb515c9940d_c0add05ab98c49d798ba1cb515c9940d-527074092 <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --document-name AWS-StartPortForwardingSession --parameters <span style="color:#f1fa8c">&#39;{&#34;portNumber&#34;:[&#34;8080&#34;], &#34;localPortNumber&#34;:[&#34;5000&#34;]}&#39;</span>
</span></span><span style="display:flex;"><span>$ curl localhost:5000
</span></span><span style="display:flex;"><span>ok
</span></span></code></pre></div><h2 id="clean-up">Clean up</h2>
<p>Clean up the environment it isn&rsquo;t needed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ copilot app delete testapp
</span></span></code></pre></div><h2 id="references">References</h2>
<p><a href="https://tech.smartcamp.co.jp/entry/fargate-with-session-manager#amazon-ssm-agentAWS-CLI%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">AWS Fargateで動いているコンテナにログインしたくて Systems Manager の Session Manager を使ってみた話 - SMARTCAMP Engineer Blog</a></p>
<p><a href="https://kenchan0130.github.io/post/2020-12-10-1">Session Managerでプライベートネットワークにセキュアにアクセスする環境を構築</a></p>
<p><a href="https://qiita.com/qualitia_cdev/items/2a6d96b26ac12ee66d4e">Docker でプロセスをきれいに終了したい - Qiita</a></p>

    </div>
    <div class="share">
      <div class="cell">
        <div>share</div>
        <div>
          <a class="share-button" href='https://twitter.com/intent/tweet?url=https://www.sambaiz.net/en/article/410/&text=Deploy%20a%20container%20to%20ECS%20on%20Fargate,%20execute%20commands%20by%20ECS%20Exec,%20and%20perform%20port%20forwarding%20by%20Session%20Manager%20-%20sambaiz-net'>
            <img src="/image/twitter.png" width="40px" height="40px" alt="twitter">
          </a>
          <a href="https://b.hatena.ne.jp/entry/" class="share-button hatena-bookmark-button" data-hatena-bookmark-layout="touch" data-hatena-bookmark-width="40" data-hatena-bookmark-height="40" title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="40" height="40" style="border: none;" />
          </a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
        </div>
      </div>
    </div>
  </article>
</div>

</div>
</body>

</html>