<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Creating new tables in BigQuery by processing data with SQL using dbt - sambaiz-net</title>
  <meta name="twitter:title" content="Creating new tables in BigQuery by processing data with SQL using dbt - sambaiz-net">
  <meta property='og:title' content="Creating new tables in BigQuery by processing data with SQL using dbt - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="dbt is a tool for transforming data using SQL or Python">
  <meta name="twitter:description" content="dbt is a tool for transforming data using SQL or Python">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/509/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/509/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/509/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/509/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Creating new tables in BigQuery by processing data with SQL using dbt",
    "datePublished": "2024-11-16T21:55:00JST",
    "dateModified": "2024-11-16T21:55:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "dbt is a tool for transforming data using SQL or Python"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/509/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Creating new tables in BigQuery by processing data with SQL using dbt</h1>
        <time>2024-11-16</time>
        <a class="tag" href='/en/tags/dbt/'>dbt</a><a class="tag" href='/en/tags/gcp/'>gcp</a>
      </div>
      <p><a href="https://docs.getdbt.com/docs/introduction">dbt</a> is a tool for transforming data using SQL or Python. There is dbt Core, an OSS CLI that provides basic functionality, and dbt Cloud, a service that <a href="https://www.getdbt.com/product/dbt-core-vs-dbt-cloud">includes</a> a browser-based IDE, CI, alerts, and more. This article is for dbt Core.</p>
<p>Install dbt Core and the <a href="https://docs.getdbt.com/docs/connect-adapters">adapters</a> for data platforms. In addition to officially maintained ones like BigQuery, Spark, and Snowflake, community adapters are also available.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ python -m venv dbt-env
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">source</span> dbt-env/bin/activate
</span></span><span style="display:flex;"><span>$ python -m pip install dbt-core dbt-bigquery
</span></span><span style="display:flex;"><span>$ dbt --version
</span></span><span style="display:flex;"><span>Core:
</span></span><span style="display:flex;"><span>  - installed: 1.8.8
</span></span><span style="display:flex;"><span>  - latest:    1.8.8 - Up to date!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Plugins:
</span></span><span style="display:flex;"><span>  - bigquery: 1.8.3 - Up to date!
</span></span></code></pre></div><p><a href="https://docs.getdbt.com/reference/commands/init">dbt init</a> is used to create a project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ dbt init testdbt
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>1<span style="color:#ff79c6">]</span> bigquery
</span></span><span style="display:flex;"><span>Enter a number: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>1<span style="color:#ff79c6">]</span> oauth
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>2<span style="color:#ff79c6">]</span> service_account
</span></span><span style="display:flex;"><span>Desired authentication method option <span style="color:#ff79c6">(</span>enter a number<span style="color:#ff79c6">)</span>: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>project <span style="color:#ff79c6">(</span>GCP project id<span style="color:#ff79c6">)</span>:
</span></span><span style="display:flex;"><span>dataset <span style="color:#ff79c6">(</span>the name of your dbt dataset<span style="color:#ff79c6">)</span>: dbttest
</span></span><span style="display:flex;"><span>threads <span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span> or more<span style="color:#ff79c6">)</span>:
</span></span><span style="display:flex;"><span>job_execution_timeout_seconds <span style="color:#ff79c6">[</span>300<span style="color:#ff79c6">]</span>:
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>1<span style="color:#ff79c6">]</span> US
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>2<span style="color:#ff79c6">]</span> EU
</span></span><span style="display:flex;"><span>Desired location option <span style="color:#ff79c6">(</span>enter a number<span style="color:#ff79c6">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tree testdbt
</span></span><span style="display:flex;"><span>testdbt
</span></span><span style="display:flex;"><span>├── README.md
</span></span><span style="display:flex;"><span>├── analyses
</span></span><span style="display:flex;"><span>├── dbt_project.yml
</span></span><span style="display:flex;"><span>├── macros
</span></span><span style="display:flex;"><span>├── models
</span></span><span style="display:flex;"><span>│   └── example
</span></span><span style="display:flex;"><span>│       ├── my_first_dbt_model.sql
</span></span><span style="display:flex;"><span>│       ├── my_second_dbt_model.sql
</span></span><span style="display:flex;"><span>│       └── schema.yml
</span></span><span style="display:flex;"><span>├── seeds
</span></span><span style="display:flex;"><span>├── snapshots
</span></span><span style="display:flex;"><span>└── tests
</span></span></code></pre></div><p>The entered values are written to ~/.dbt/profiles.yml.
The reference destination can be specified using the <a href="https://docs.getdbt.com/docs/core/connect-data-platform/connection-profiles#advanced-customizing-a-profile-directory">&ndash;profiles-dir or DBT_PROFILES_DIR environment variable</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>$ cat ~/.dbt/profiles.yml
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">testdbt</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">outputs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">dev</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">dataset</span>: dbttest
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">job_execution_timeout_seconds</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">job_retries</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">location</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">method</span>: oauth
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">priority</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">project</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">threads</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">type</span>: bigquery
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">target</span>: dev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat testdbt/dbt_project.yml
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">profile</span>: <span style="color:#f1fa8c">&#39;testdbt&#39;</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Use dbt debug to verify the connection.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#6272a4"># gcloud auth application-default login</span>
</span></span><span style="display:flex;"><span>$ dbt debug
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>17:00:18  Configuration:
</span></span><span style="display:flex;"><span>17:00:18    profiles.yml file <span style="color:#ff79c6">[</span>OK found and valid<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>17:00:18    dbt_project.yml file <span style="color:#ff79c6">[</span>OK found and valid<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>17:00:18  Required dependencies:
</span></span><span style="display:flex;"><span>17:00:18   - git <span style="color:#ff79c6">[</span>OK found<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>17:00:18  Registered adapter: <span style="color:#8be9fd;font-style:italic">bigquery</span><span style="color:#ff79c6">=</span>1.8.3
</span></span><span style="display:flex;"><span>17:00:21    Connection test: <span style="color:#ff79c6">[</span>OK connection ok<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>17:00:21  All checks passed!
</span></span></code></pre></div><p>Write SQL to create tables with <a href="https://docs.getdbt.com/docs/build/materializations">materialized</a>=table. Note that <a href="https://github.com/dbt-labs/dbt-bigquery/blob/v1.8.3/dbt/include/bigquery/macros/adapters.sql#L16">CREATE OR REPLACE TABLE AS SELECT</a> will be executed and data will be overwritten.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>$ cat models<span style="color:#ff79c6">/</span>example<span style="color:#ff79c6">/</span>my_first_dbt_model.<span style="color:#ff79c6">sql</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{ config(materialized<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;table&#39;</span>) }}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">with</span> source_data <span style="color:#ff79c6">as</span> (
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">select</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">as</span> id
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">union</span> <span style="color:#ff79c6">all</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">select</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">as</span> id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">select</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> source_data
</span></span></code></pre></div><p>In case materialized=incremental, data is added incrementally. The default <a href="https://docs.getdbt.com/reference/resource-configs/bigquery-configs#merge-behavior-incremental-models">incremental_strategy</a> is <a href="https://docs.getdbt.com/reference/resource-configs/bigquery-configs#the-merge-strategy">merge</a>, which updates if there&rsquo;s a match on the unique_key and inserts if not, making it costly for large tables. insert_overwrite deletes the data in the target partition before inserting. Setting <a href="https://docs.getdbt.com/reference/resource-configs/bigquery-configs#copying-partitions">copy_partitions</a>: true calls the <a href="https://cloud.google.com/bigquery/docs/managing-tables#copy-table">copy table API</a> instead of using a merge statement, eliminating the cost of insertion.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>{{ config(
</span></span><span style="display:flex;"><span>    materialized<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;incremental&#34;</span>,
</span></span><span style="display:flex;"><span>    incremental_strategy<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;insert_overwrite&#34;</span>,
</span></span><span style="display:flex;"><span>    partition_by<span style="color:#ff79c6">=</span>{
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;field&#34;</span>: <span style="color:#f1fa8c">&#34;created_date&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;data_type&#34;</span>: <span style="color:#f1fa8c">&#34;timestamp&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;granularity&#34;</span>: <span style="color:#f1fa8c">&#34;day&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;copy_partitions&#34;</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>) }}
</span></span></code></pre></div><p>SQL can be written in Jinja templates, expressing branches by <a href="https://docs.getdbt.com/reference/dbt-jinja-functions/target">target</a> etc. and referencing <a href="https://docs.getdbt.com/docs/build/project-variables">variables</a> passed through &ndash;vars or vars in dbt_project.yml using <a href="https://docs.getdbt.com/reference/dbt-jinja-functions/var">var()</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">$ dbt run --vars &#39;{&#34;test&#34;: 3333}&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">or
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">vars:
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  test: 1111
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">select</span> <span style="color:#bd93f9">3</span> <span style="color:#ff79c6">as</span> id
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">union</span> <span style="color:#ff79c6">all</span>
</span></span><span style="display:flex;"><span>{<span style="color:#ff79c6">%</span> <span style="color:#ff79c6">if</span> target.name <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;prd&#39;</span> <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">select</span> {{ var(<span style="color:#f1fa8c">&#39;test&#39;</span>) }} <span style="color:#ff79c6">as</span> id
</span></span><span style="display:flex;"><span>{<span style="color:#ff79c6">%</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">select</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">as</span> id
</span></span><span style="display:flex;"><span>{<span style="color:#ff79c6">%</span> endif <span style="color:#ff79c6">%</span>}
</span></span></code></pre></div><p>To maintain style, lint by <a href="https://sqlfluff.com/">sqlfluff</a> is <a href="https://docs.getdbt.com/best-practices/how-we-style/2-how-we-style-our-sql">recommended</a> in Best practice guides.</p>
<p><a href="https://www.sambaiz.net/en/article/512/">Model Layering in dbt&rsquo;s Best Practice Guides - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pip install sqlfluff
</span></span><span style="display:flex;"><span>$ sqlfluff lint --dialect bigquery models/example
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#ff79c6">[</span>models/example/my_first_dbt_model.sql<span style="color:#ff79c6">]</span> FAIL          
</span></span><span style="display:flex;"><span>L:  <span style="color:#bd93f9">10</span> | P:   <span style="color:#bd93f9">9</span> | CP01 | Keywords must be consistently lower <span style="color:#ff79c6">case</span>.
</span></span><span style="display:flex;"><span>                       | <span style="color:#ff79c6">[</span>capitalisation.keywords<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#ff79c6">[</span>models/example/my_second_dbt_model.sql<span style="color:#ff79c6">]</span> FAIL         
</span></span><span style="display:flex;"><span>L:   <span style="color:#bd93f9">1</span> | P:   <span style="color:#bd93f9">4</span> |  TMP | Undefined jinja template variable: <span style="color:#f1fa8c">&#39;codegen&#39;</span>
</span></span></code></pre></div><p>You can check data with <a href="https://docs.getdbt.com/reference/commands/show">dbt show</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ dbt show --select <span style="color:#f1fa8c">&#34;my_first_dbt_model.sql&#34;</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Previewing node <span style="color:#f1fa8c">&#39;my_first_dbt_model&#39;</span>:
</span></span><span style="display:flex;"><span>| id |
</span></span><span style="display:flex;"><span>| -- |
</span></span><span style="display:flex;"><span>|  <span style="color:#bd93f9">1</span> |
</span></span><span style="display:flex;"><span>|    |
</span></span></code></pre></div><p>Once you execute <a href="https://docs.getdbt.com/reference/commands/run">dbt run</a>,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ dbt run
</span></span><span style="display:flex;"><span>17:19:34  Running with <span style="color:#8be9fd;font-style:italic">dbt</span><span style="color:#ff79c6">=</span>1.8.8
</span></span><span style="display:flex;"><span>17:19:35  Registered adapter: <span style="color:#8be9fd;font-style:italic">bigquery</span><span style="color:#ff79c6">=</span>1.8.3
</span></span><span style="display:flex;"><span>17:19:35  Found <span style="color:#bd93f9">2</span> models, <span style="color:#bd93f9">4</span> data tests, <span style="color:#bd93f9">479</span> macros
</span></span><span style="display:flex;"><span>17:19:35
</span></span><span style="display:flex;"><span>17:19:38  Concurrency: <span style="color:#bd93f9">1</span> threads <span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">target</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;dev&#39;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>17:19:38
</span></span><span style="display:flex;"><span>17:19:38  <span style="color:#bd93f9">1</span> of <span style="color:#bd93f9">2</span> START sql table model dbttest.my_first_dbt_model ........................ <span style="color:#ff79c6">[</span>RUN<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>17:19:41  <span style="color:#bd93f9">1</span> of <span style="color:#bd93f9">2</span> OK created sql table model dbttest.my_first_dbt_model ................... <span style="color:#ff79c6">[</span>CREATE TABLE <span style="color:#ff79c6">(</span>2.0 rows, <span style="color:#bd93f9">0</span> processed<span style="color:#ff79c6">)</span> in 3.47s<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>17:19:41  <span style="color:#bd93f9">2</span> of <span style="color:#bd93f9">2</span> START sql view model dbttest.my_second_dbt_model ........................ <span style="color:#ff79c6">[</span>RUN<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>17:19:43  <span style="color:#bd93f9">2</span> of <span style="color:#bd93f9">2</span> OK created sql view model dbttest.my_second_dbt_model ................... <span style="color:#ff79c6">[</span>CREATE VIEW <span style="color:#ff79c6">(</span><span style="color:#bd93f9">0</span> processed<span style="color:#ff79c6">)</span> in 1.24s<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>17:19:43
</span></span><span style="display:flex;"><span>17:19:43  Finished running <span style="color:#bd93f9">1</span> table model, <span style="color:#bd93f9">1</span> view model in <span style="color:#bd93f9">0</span> hours <span style="color:#bd93f9">0</span> minutes and 8.00 seconds <span style="color:#ff79c6">(</span>8.00s<span style="color:#ff79c6">)</span>.
</span></span><span style="display:flex;"><span>17:19:43
</span></span><span style="display:flex;"><span>17:19:43  Completed successfully
</span></span><span style="display:flex;"><span>17:19:43
</span></span><span style="display:flex;"><span>17:19:43  Done. <span style="color:#8be9fd;font-style:italic">PASS</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> <span style="color:#8be9fd;font-style:italic">WARN</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> <span style="color:#8be9fd;font-style:italic">ERROR</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> <span style="color:#8be9fd;font-style:italic">SKIP</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> <span style="color:#8be9fd;font-style:italic">TOTAL</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>
</span></span></code></pre></div><p>tables are created and the data are inserted.</p>




<div class="img_container"><a href="/article/509/images/tables.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/509/images/tables_hu_b1e8d218a0f43cc2.png" width="600" height="306" alt="tables and data">
</a></div>


<p>The executed queries are shown in the logs.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>$ cat logs<span style="color:#ff79c6">/</span>dbt.log
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">19</span>:<span style="color:#bd93f9">48</span>:<span style="color:#bd93f9">05</span>.<span style="color:#bd93f9">057309</span> [debug] [Thread<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span> (]: <span style="color:#ff79c6">On</span> model.testdbt.my_first_dbt_model: <span style="color:#6272a4">/* {&#34;app&#34;: &#34;dbt&#34;, &#34;dbt_version&#34;: &#34;1.8.8&#34;, &#34;profile_name&#34;: &#34;testdbt&#34;, &#34;target_name&#34;: &#34;dev&#34;, &#34;node_id&#34;: &#34;model.testdbt.my_first_dbt_model&#34;} */</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">-- back compat for old kwarg name
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    merge <span style="color:#ff79c6">into</span> <span style="color:#ff79c6">`</span>sambaiztest<span style="color:#ff79c6">`</span>.<span style="color:#ff79c6">`</span>dbttest<span style="color:#ff79c6">`</span>.<span style="color:#ff79c6">`</span>my_first_dbt_model<span style="color:#ff79c6">`</span> <span style="color:#ff79c6">as</span> DBT_INTERNAL_DEST
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">using</span> (
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">with</span> source_data <span style="color:#ff79c6">as</span> (
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">select</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">as</span> id
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">union</span> <span style="color:#ff79c6">all</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">select</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">as</span> id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">select</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> source_data
</span></span><span style="display:flex;"><span>        ) <span style="color:#ff79c6">as</span> DBT_INTERNAL_SOURCE
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">on</span> (<span style="color:#ff79c6">FALSE</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">when</span> <span style="color:#ff79c6">not</span> matched <span style="color:#ff79c6">then</span> <span style="color:#ff79c6">insert</span>
</span></span><span style="display:flex;"><span>        (<span style="color:#ff79c6">`</span>id<span style="color:#ff79c6">`</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">values</span>
</span></span><span style="display:flex;"><span>        (<span style="color:#ff79c6">`</span>id<span style="color:#ff79c6">`</span>)
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>bq query &ndash;format=json <a href="https://cloud.google.com/bigquery/docs/exporting-data">outputs INTEGER columns as STRING</a>, making it difficult to get the diff between existing data and dbt show. You can generate just the query with <a href="https://docs.getdbt.com/reference/commands/compile">dbt compile</a>, and the path to the sql file is in target/manifest.json, so you can run this with bq query and get the diff with <a href="https://github.com/josephburnett/jd">jd</a> etc. to make it easier to see.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">MODEL_NAME</span><span style="color:#ff79c6">=</span>my_first_dbt_model
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dbt compile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">SQL_FILE</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>jq -r <span style="color:#f1fa8c">&#34;.nodes | to_entries[] | select(.value.name==\&#34;</span><span style="color:#8be9fd;font-style:italic">$MODEL_NAME</span><span style="color:#f1fa8c">\&#34;) | .value.compiled_path&#34;</span> target/manifest.json<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#8be9fd;font-style:italic">$SQL_FILE</span> | bq query --use_legacy_sql<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">false</span> --format<span style="color:#ff79c6">=</span>json | jq &gt; dbt_materialized.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">TABLE_NAME</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>jq -r <span style="color:#f1fa8c">&#34;.nodes | to_entries[] | select(.value.name==\&#34;</span><span style="color:#8be9fd;font-style:italic">$MODEL_NAME</span><span style="color:#f1fa8c">\&#34;) | .value.relation_name&#34;</span> target/manifest.json<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;SELECT * FROM </span><span style="color:#8be9fd;font-style:italic">$TABLE_NAME</span><span style="color:#f1fa8c">&#34;</span> | bq query --use_legacy_sql<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">false</span> --format<span style="color:#ff79c6">=</span>json | jq &gt; bq_original.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jd dbt_materialized.json bq_original.json
</span></span></code></pre></div><p><a href="https://docs.getdbt.com/reference/commands/test">dbt test</a> runs the <a href="https://docs.getdbt.com/docs/build/data-tests">data_tests</a> defined in the schema. my_first_dbt_model FAILS because it has a null id.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ dbt <span style="color:#8be9fd;font-style:italic">test</span>
</span></span><span style="display:flex;"><span>17:23:54  Running with <span style="color:#8be9fd;font-style:italic">dbt</span><span style="color:#ff79c6">=</span>1.8.8
</span></span><span style="display:flex;"><span>17:23:55  Registered adapter: <span style="color:#8be9fd;font-style:italic">bigquery</span><span style="color:#ff79c6">=</span>1.8.3
</span></span><span style="display:flex;"><span>17:23:55  Found <span style="color:#bd93f9">2</span> models, <span style="color:#bd93f9">4</span> data tests, <span style="color:#bd93f9">479</span> macros
</span></span><span style="display:flex;"><span>17:23:55
</span></span><span style="display:flex;"><span>17:23:56  Concurrency: <span style="color:#bd93f9">1</span> threads <span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">target</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;dev&#39;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>17:23:56
</span></span><span style="display:flex;"><span>17:23:56  <span style="color:#bd93f9">1</span> of <span style="color:#bd93f9">4</span> START <span style="color:#8be9fd;font-style:italic">test</span> not_null_my_first_dbt_model_id ............................... <span style="color:#ff79c6">[</span>RUN<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>17:23:58  <span style="color:#bd93f9">1</span> of <span style="color:#bd93f9">4</span> FAIL <span style="color:#bd93f9">1</span> not_null_my_first_dbt_model_id ................................... <span style="color:#ff79c6">[</span>FAIL <span style="color:#bd93f9">1</span> in 1.61s<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>17:23:58  <span style="color:#bd93f9">2</span> of <span style="color:#bd93f9">4</span> START <span style="color:#8be9fd;font-style:italic">test</span> not_null_my_second_dbt_model_id .............................. <span style="color:#ff79c6">[</span>RUN<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>17:24:00  <span style="color:#bd93f9">2</span> of <span style="color:#bd93f9">4</span> PASS not_null_my_second_dbt_model_id .................................... <span style="color:#ff79c6">[</span>PASS in 1.91s<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>17:24:00  <span style="color:#bd93f9">3</span> of <span style="color:#bd93f9">4</span> START <span style="color:#8be9fd;font-style:italic">test</span> unique_my_first_dbt_model_id ................................. <span style="color:#ff79c6">[</span>RUN<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>17:24:01  <span style="color:#bd93f9">3</span> of <span style="color:#bd93f9">4</span> PASS unique_my_first_dbt_model_id ....................................... <span style="color:#ff79c6">[</span>PASS in 1.67s<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>17:24:01  <span style="color:#bd93f9">4</span> of <span style="color:#bd93f9">4</span> START <span style="color:#8be9fd;font-style:italic">test</span> unique_my_second_dbt_model_id ................................ <span style="color:#ff79c6">[</span>RUN<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>17:24:03  <span style="color:#bd93f9">4</span> of <span style="color:#bd93f9">4</span> PASS unique_my_second_dbt_model_id ...................................... <span style="color:#ff79c6">[</span>PASS in 1.81s<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>17:24:03
</span></span><span style="display:flex;"><span>17:24:03  Finished running <span style="color:#bd93f9">4</span> data tests in <span style="color:#bd93f9">0</span> hours <span style="color:#bd93f9">0</span> minutes and 7.95 seconds <span style="color:#ff79c6">(</span>7.95s<span style="color:#ff79c6">)</span>.
</span></span><span style="display:flex;"><span>17:24:03
</span></span><span style="display:flex;"><span>17:24:03  Completed with <span style="color:#bd93f9">1</span> error and <span style="color:#bd93f9">0</span> warnings:
</span></span><span style="display:flex;"><span>17:24:03
</span></span><span style="display:flex;"><span>17:24:03  Failure in <span style="color:#8be9fd;font-style:italic">test</span> not_null_my_first_dbt_model_id <span style="color:#ff79c6">(</span>models/example/schema.yml<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>17:24:03    Got <span style="color:#bd93f9">1</span> result, configured to fail <span style="color:#ff79c6">if</span> !<span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>17:24:03
</span></span><span style="display:flex;"><span>17:24:03    compiled code at target/compiled/testdbt/models/example/schema.yml/not_null_my_first_dbt_model_id.sql
</span></span><span style="display:flex;"><span>17:24:03
</span></span><span style="display:flex;"><span>17:24:03  Done. <span style="color:#8be9fd;font-style:italic">PASS</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span> <span style="color:#8be9fd;font-style:italic">WARN</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> <span style="color:#8be9fd;font-style:italic">ERROR</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> <span style="color:#8be9fd;font-style:italic">SKIP</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> <span style="color:#8be9fd;font-style:italic">TOTAL</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">4</span>
</span></span></code></pre></div><p><a href="https://docs.getdbt.com/reference/commands/build">dbt build</a> runs both run and test, so my_second_dbt_model is not created due to <a href="https://docs.getdbt.com/reference/dbt-jinja-functions/ref">dependent</a> my_first_dbt_model tests failure. Besides, if you run dbt show on a model that has dependencies, it will refer to the actual table.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cat models/example/my_second_dbt_model.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">select</span> *
</span></span><span style="display:flex;"><span>from <span style="color:#ff79c6">{{</span> ref<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#39;my_first_dbt_model&#39;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">}}</span>
</span></span><span style="display:flex;"><span>where <span style="color:#8be9fd;font-style:italic">id</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>
</span></span></code></pre></div><p><a href="https://docs.getdbt.com/reference/commands/cmd-docs">dbt docs</a> generates documentation based on schema.yml.
Since it is a static site, so you <a href="https://docs.getdbt.com/docs/build/documentation#for-dbt-docs-users">can host</a> it on S3 etc.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>$ cat models/example/schema.yml
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">version</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">models</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">name</span>: my_first_dbt_model
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">description</span>: <span style="color:#f1fa8c">&#34;A starter dbt model&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">columns</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">name</span>: id
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">description</span>: <span style="color:#f1fa8c">&#34;The primary key for this table&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">data_tests</span>:
</span></span><span style="display:flex;"><span>          - unique
</span></span><span style="display:flex;"><span>          - not_null
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">name</span>: my_second_dbt_model
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">description</span>: <span style="color:#f1fa8c">&#34;A starter dbt model&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">columns</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">name</span>: id
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">description</span>: <span style="color:#f1fa8c">&#34;The primary key for this table&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">data_tests</span>:
</span></span><span style="display:flex;"><span>          - unique
</span></span><span style="display:flex;"><span>          - not_null
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ dbt docs generate
</span></span><span style="display:flex;"><span>$ dbt docs serve
</span></span></code></pre></div>



<div class="img_container"><a href="/article/509/images/docs.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/509/images/docs_hu_af91c33c0d50c3d5.png" width="600" height="251" alt="Document">
</a></div>


<p>You can also specify data_type in schema.yml, but the actual created table schema is based on the model query, and by default no error will occur even if there is a discrepancy. If you enable <a href="https://docs.getdbt.com/reference/resource-configs/contract">contract</a>, an error will occur before materializing.</p>
<p>If you do this, when using materialized=incremental, you need to change <a href="https://docs.getdbt.com/docs/build/incremental-models#what-if-the-columns-of-my-incremental-model-change">on_schema_change</a> from the default ignore to append_new_columns or fail. This indicates the behavior when columns are changed due to changes in the query. If you set it to ignore, the table schema will not be updated even if a new column is added, but if you set it to append_new_columns, it will be added. However, nested columns such as STRUCT fields are not supported. In either case, deletions and type changes will not be reflected.</p>
<p>Also, the description is not reflected in BigQuery by default, so you need to enable <a href="https://docs.getdbt.com/reference/resource-configs/persist_docs">persist_docs</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#ff79c6">models</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">name</span>: my_first_dbt_model
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">description</span>: <span style="color:#f1fa8c">&#34;A starter dbt model&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">contract</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">enforced</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">on_schema_change</span>: <span style="color:#f1fa8c">&#34;append_new_columns&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">columns</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">name</span>: id
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">data_type</span>: STRING
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">description</span>: <span style="color:#f1fa8c">&#34;The primary key for this table&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Compilation Error in model my_first_dbt_model (models/example/my_first_dbt_model.sql)</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># This model has an enforced contract that failed.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Please ensure the name, data_type, and number of columns in your contract match the columns in your model&#39;s definition.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># | column_name | definition_type | contract_type | mismatch_reason    |</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># | ----------- | --------------- | ------------- | ------------------ |</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># | id          | INT64           | STRING        | data type mismatch |</span>
</span></span></code></pre></div><p>If you put csv files in the seeds directory and run <a href="https://docs.getdbt.com/reference/commands/seed">dbt seed</a>, tables with the static data will be created.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>$ cat seeds<span style="color:#ff79c6">/</span>test_data.csv 
</span></span><span style="display:flex;"><span>id
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">100</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">200</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">300</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ dbt seed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">select *
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">from {{ ref(&#39;test_data&#39;) }}
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">*/</span>
</span></span></code></pre></div><p>if you define your own macro in the macros directory, you can refer to it from models and run data_tests.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>$ cat macros<span style="color:#ff79c6">/</span>test.<span style="color:#ff79c6">sql</span> 
</span></span><span style="display:flex;"><span>{<span style="color:#ff79c6">%</span> macro offset_id(id) <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>    {<span style="color:#ff79c6">%</span> <span style="color:#ff79c6">if</span> target.name <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;prd&#39;</span> <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>        {{ id }} <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1000</span>
</span></span><span style="display:flex;"><span>    {<span style="color:#ff79c6">%</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>        {{ id }}
</span></span><span style="display:flex;"><span>    {<span style="color:#ff79c6">%</span> endif <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>{<span style="color:#ff79c6">%</span> endmacro <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">select {{ offset_id(1) }} as id
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{<span style="color:#ff79c6">%</span> test positive_value(model, <span style="color:#ff79c6">column_name</span>) <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">select</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">from</span> {{ model }}
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">where</span> {{ <span style="color:#ff79c6">column_name</span> }} <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>{<span style="color:#ff79c6">%</span> endtest <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">models:
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  - name: my_first_dbt_model
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    columns:
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">      - name: id
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        data_tests:
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">          - positive_value
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">*/</span>
</span></span></code></pre></div><p>Macros can also cause side effects, and by calling from <a href="https://docs.getdbt.com/reference/resource-configs/pre-hook-post-hook">pre/post_hook</a> or materialized=ephemeral that don&rsquo;t create tables, you can perform any processing within the dbt workflow. The <a href="https://docs.getdbt.com/reference/dbt-jinja-functions/execute">execute</a> variable is false during DAG generation when queries don&rsquo;t run, and <a href="https://docs.getdbt.com/reference/dbt-jinja-functions/run_query">run_query</a> is a macro that executes queries. You can call this using jinja&rsquo;s <a href="https://jinja.palletsprojects.com/en/stable/templates/#expression-statement">do</a> without output. Besides, you can run it with <a href="https://docs.getdbt.com/reference/commands/run-operation">dbt run-operation</a>, and codegen is also implemented as macro.</p>
<p><a href="https://www.sambaiz.net/en/article/513/">Automatically generate sources.yml, staging models, and schema.yml using dbt codegen - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>{<span style="color:#ff79c6">%</span> macro export_to_gcs(
</span></span><span style="display:flex;"><span>    source_model,
</span></span><span style="display:flex;"><span>    gcs_bucket,
</span></span><span style="display:flex;"><span>    export_format<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;CSV&#39;</span>
</span></span><span style="display:flex;"><span>) <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{<span style="color:#ff79c6">%</span> <span style="color:#ff79c6">if</span> execute <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%</span> <span style="color:#8be9fd;font-style:italic">set</span> gcs_path <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;exports/&#39;</span> <span style="color:#ff79c6">~</span> model<span style="color:#ff79c6">.</span>name <span style="color:#ff79c6">~</span> <span style="color:#f1fa8c">&#39;.csv&#39;</span> <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%</span> <span style="color:#8be9fd;font-style:italic">set</span> gcs_uri <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;gs://&#39;</span> <span style="color:#ff79c6">~</span> gcs_bucket <span style="color:#ff79c6">~</span> <span style="color:#f1fa8c">&#39;/&#39;</span> <span style="color:#ff79c6">~</span> gcs_path <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%</span> <span style="color:#8be9fd;font-style:italic">set</span> export_query <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>  EXPORT DATA
</span></span><span style="display:flex;"><span>  OPTIONS(
</span></span><span style="display:flex;"><span>    uri<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;{{ gcs_uri }}&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">format</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;{{ export_format }}&#39;</span>
</span></span><span style="display:flex;"><span>    {<span style="color:#ff79c6">%</span> <span style="color:#ff79c6">if</span> export_format <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;CSV&#39;</span> <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>    , header<span style="color:#ff79c6">=</span>true,
</span></span><span style="display:flex;"><span>    field_delimiter<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;,&#39;</span>
</span></span><span style="display:flex;"><span>    {<span style="color:#ff79c6">%</span> endif <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>  AS (
</span></span><span style="display:flex;"><span>    {{ source_model }}
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%</span> endset <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%</span> do run_query(export_query) <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>{<span style="color:#ff79c6">%</span> endif <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{<span style="color:#ff79c6">%</span> endmacro <span style="color:#ff79c6">%</span>}
</span></span></code></pre></div><p>Such macros can be called from ephemeral models like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>{{ config(materialized<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;ephemeral&#39;</span>) }}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{<span style="color:#ff79c6">%-</span> <span style="color:#ff79c6">set</span> query <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">select</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">from</span> {{ <span style="color:#ff79c6">ref</span>(<span style="color:#f1fa8c">&#39;my_model&#39;</span>) }}
</span></span><span style="display:flex;"><span>{<span style="color:#ff79c6">%-</span> endset <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{ export_to_gcs(
</span></span><span style="display:flex;"><span>    source_model<span style="color:#ff79c6">=</span>query,
</span></span><span style="display:flex;"><span>    gcs_bucket<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;my-bucket&#39;</span>
</span></span><span style="display:flex;"><span>) }}
</span></span></code></pre></div><p>You can also override the behavior of adding the default_schema prefix when you specify a schema in the config by defining <a href="https://docs.getdbt.com/docs/build/custom-schemas#how-does-dbt-generate-a-models-schema-name">generate_schema_name</a>, which is used to generate the schema name.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>{<span style="color:#ff79c6">%</span> macro generate_schema_name(custom_schema_name, node) <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {<span style="color:#ff79c6">%-</span> <span style="color:#8be9fd;font-style:italic">set</span> default_schema <span style="color:#ff79c6">=</span> target<span style="color:#ff79c6">.</span>schema <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>    {<span style="color:#ff79c6">%-</span> <span style="color:#ff79c6">if</span> custom_schema_name <span style="color:#ff79c6">is</span> none <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        {{ default_schema }}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {<span style="color:#ff79c6">%-</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        {{ default_schema }}_{{ custom_schema_name <span style="color:#ff79c6">|</span> trim }}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {<span style="color:#ff79c6">%-</span> endif <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{<span style="color:#ff79c6">%-</span> endmacro <span style="color:#ff79c6">%</span>}
</span></span></code></pre></div><p>Similarly, you can also define your own <a href="https://docs.getdbt.com/guides/create-new-materializations">materialization</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>{<span style="color:#ff79c6">%-</span> materialization table_function, adapter<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;bigquery&#39;</span> <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%-</span> <span style="color:#ff79c6">set</span> params <span style="color:#ff79c6">=</span> config.<span style="color:#ff79c6">get</span>(<span style="color:#f1fa8c">&#39;params&#39;</span>, <span style="color:#f1fa8c">&#39;&#39;</span>) <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%-</span> <span style="color:#ff79c6">set</span> relation <span style="color:#ff79c6">=</span> api.Relation.<span style="color:#ff79c6">create</span>(identifier<span style="color:#ff79c6">=</span>this.identifier, <span style="color:#ff79c6">schema</span><span style="color:#ff79c6">=</span>this.<span style="color:#ff79c6">schema</span>, <span style="color:#ff79c6">database</span><span style="color:#ff79c6">=</span>this.<span style="color:#ff79c6">database</span>, <span style="color:#ff79c6">type</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;view&#34;</span>) <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%-</span> <span style="color:#ff79c6">set</span> funcname <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;`&#34;</span> <span style="color:#ff79c6">~</span> ([relation.<span style="color:#ff79c6">database</span>, relation.<span style="color:#ff79c6">schema</span>, relation.identifier] <span style="color:#ff79c6">|</span> <span style="color:#ff79c6">join</span>(<span style="color:#f1fa8c">&#34;.&#34;</span>)) <span style="color:#ff79c6">~</span> <span style="color:#f1fa8c">&#34;`&#34;</span> <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%</span> <span style="color:#ff79c6">call</span> <span style="color:#ff79c6">statement</span>(<span style="color:#f1fa8c">&#39;main&#39;</span>) <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">OR</span> <span style="color:#ff79c6">REPLACE</span> <span style="color:#ff79c6">TABLE</span> <span style="color:#ff79c6">FUNCTION</span> {{ funcname }}({{ params }})
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">AS</span> (
</span></span><span style="display:flex;"><span>    {{ <span style="color:#ff79c6">sql</span> }}
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>  {<span style="color:#ff79c6">%-</span> endcall <span style="color:#ff79c6">%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  {{ <span style="color:#ff79c6">return</span>({<span style="color:#f1fa8c">&#39;relations&#39;</span>: [relation]}) }}
</span></span><span style="display:flex;"><span>{<span style="color:#ff79c6">%-</span> endmaterialization <span style="color:#ff79c6">-%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">{{
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  config(
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    materialized=&#39;table_function&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    params=&#39;aaa INT, bbb INT&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  )
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">}}
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">SELECT aaa as a, bbb as b
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">*/</span>
</span></span></code></pre></div><h2 id="reference">Reference</h2>
<p><a href="https://zenn.dev/raksul_data/articles/dbt_incremental_model_on_bq">dbtのincremental modelを用いたBigQueryの差分更新 〜 copy_partitionsも試してみた 〜</a></p>
<p><a href="https://qiita.com/kitta65/items/c1a1f8821d9b13dbba1e">[BigQuery] dbtでtable functionを管理する #SQL - Qiita</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>