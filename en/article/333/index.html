<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 30px;
        height: 30px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.5rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .share-button > img {
        border: none;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .share {
        position: relative;
        text-align: right;
        margin-top: 5px;
    }

    .share .cell {
        display: inline-block;
        text-align: center;
        margin-bottom: 5px;
    }

    .share-button {
        display: inline-block;
        margin: 0 5px;
    }

    @media screen and (min-width: 1400px) {
        .share .cell {
            position: absolute;
            bottom: 0;
            margin-left: 5px;
        }

        .share-button {
            display: inline-block;
            margin: 5px 0;
        }
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Enable Job Bookmark of AWS Glue to process from the records following ones executed previously - sambaiz-net</title>
  <meta name="twitter:title" content="Enable Job Bookmark of AWS Glue to process from the records following ones executed previously - sambaiz-net">
  <meta property='og:title' content="Enable Job Bookmark of AWS Glue to process from the records following ones executed previously - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="Process the difference data from the previous time">
  <meta name="twitter:description" content="Process the difference data from the previous time">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/333/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/333/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/333/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/333/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Enable Job Bookmark of AWS Glue to process from the records following ones executed previously",
    "datePublished": "2021-04-16T20:00:00JST",
    "dateModified": "2021-04-16T20:00:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "Process the difference data from the previous time"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/333/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://twitter.com/sambaiz">
            <img src="/image/twitter.png" width="30px" height="30px" alt="twitter">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://bookmeter.com/users/1060169/books/read">
            <img src="/image/bookmeter.png" width="30px" height="30px" alt="bookmeter">
          </a>
        </div>
        <div class="sns-item">
          <a href="https://filmarks.com/users/sambaiz" class="filmarks" aria-label="filmarks"></a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/log/">
            log</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/docker/">
            docker</a>
          
          <a class="tag" href="/tags/infra/">
            infra</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Enable Job Bookmark of AWS Glue to process from the records following ones executed previously</h1>
        <time>2021-04-16</time>
        <a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/python/'>python</a><a class="tag" href='/en/tags/spark/'>spark</a>
      </div>
      <p><a href="https://docs.aws.amazon.com/glue/latest/dg/monitor-continuations.html">Job Bookmark</a> of AWS Glue is a feature that saves what records are processed, and prevent it from being executed next time.
Parquet and ORC, which were not supported before 1.0, are now supported.</p>
<p><a href="https://www.sambaiz.net/article/203/">AWS GlueでCSVを加工しParquetに変換してパーティションを切りAthenaで参照する - sambaiz-net</a></p>
<p>Bookmark is available if Job Bookmark is enabled, call DynamicFrame methods with a <code>transaction_ctx</code>, and call <code>job.commit()</code>.</p>
<p><img src="https://www.sambaiz.net/images/333.png" alt="Bookmark settings"></p>
<p>For example, following job that counts a table and outputs it doesn&rsquo;t count records previously counted if Bookmark is available, so it outputs not total but difference count from the previous time.
The lag before it can be referenced due to S3 eventual consistency is also taken into account.
Instead of simply selecting the target based on the last execution time alone, Glue looks at data from a little before the last execution time.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">import</span> sys
<span style="color:#ff79c6">from</span> awsglue.transforms <span style="color:#ff79c6">import</span> <span style="color:#ff79c6">*</span>
<span style="color:#ff79c6">from</span> awsglue.utils <span style="color:#ff79c6">import</span> getResolvedOptions
<span style="color:#ff79c6">from</span> pyspark.context <span style="color:#ff79c6">import</span> SparkContext
<span style="color:#ff79c6">from</span> awsglue.context <span style="color:#ff79c6">import</span> GlueContext
<span style="color:#ff79c6">from</span> awsglue.job <span style="color:#ff79c6">import</span> Job
args <span style="color:#ff79c6">=</span> getResolvedOptions(sys<span style="color:#ff79c6">.</span>argv, [<span style="color:#f1fa8c">&#39;JOB_NAME&#39;</span>])
sc <span style="color:#ff79c6">=</span> SparkContext()
glueContext <span style="color:#ff79c6">=</span> GlueContext(sc)
spark <span style="color:#ff79c6">=</span> glueContext<span style="color:#ff79c6">.</span>spark_session
job <span style="color:#ff79c6">=</span> Job(glueContext)
job<span style="color:#ff79c6">.</span>init(args[<span style="color:#f1fa8c">&#39;JOB_NAME&#39;</span>], args)
source <span style="color:#ff79c6">=</span> glueContext<span style="color:#ff79c6">.</span>create_dynamic_frame<span style="color:#ff79c6">.</span>from_catalog(
    database<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;test&#34;</span>, table_name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;test&#34;</span>, transformation_ctx<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;source&#34;</span>)
source<span style="color:#ff79c6">.</span>toDF()<span style="color:#ff79c6">.</span>createOrReplaceTempView(<span style="color:#f1fa8c">&#34;t&#34;</span>)
df <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>sql(<span style="color:#f1fa8c">&#34;SELECT COUNT(1) as cnt FROM t&#34;</span>)
df<span style="color:#ff79c6">.</span>write<span style="color:#ff79c6">.</span>mode(<span style="color:#f1fa8c">&#34;append&#34;</span>)<span style="color:#ff79c6">.</span>csv(
    <span style="color:#f1fa8c">&#34;s3://*****/test-table-summary&#34;</span>, compression<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gzip&#34;</span>)
job<span style="color:#ff79c6">.</span>commit()
</code></pre></div><p>If there is no differences from the previous time so that the contents of DynamicFrame are empty, the schema of DataFrame is also empty. Therefore if the field is referenced in SQL, <code>cannnot resolve *** given input columns</code> error is occured. To resolve this problem, a check like <code>if df.count() == 0</code> is needed.</p>
<p>Even if the data is partitioned by date and specified the date in the query, since it cannot be narrowed down in Bookmark, the following logs are output a lot and all partitions are searched.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">INFO [Thread-5] hadoop.PartitionFilesListerUsingBookmark (FileSystemBookmark.scala:apply(356)): After initial job bookmarks filter, processing 0.00% of 592 files in partition DynamicFramePartition(com.amazonaws.services.glue.DynamicRecord@218398ba,s3://hogefuga/log/2021/09/02/11/,1630504916000).
</code></pre></div><p>As a result, it takes time from adding Executors to starting the Task on the timeline.</p>
<p><a href="https://www.sambaiz.net/en/article/382/">Spark Web UI: Monitor Job Stages, Tasks distribution and SQL plan - sambaiz-net</a></p>
<p><img src="https://www.sambaiz.net/images/333-2.png" alt="Web UI Timeline"></p>
<p>Passing the following parameter to <code>from_catalog()</code> will allow you to <a href="https://docs.aws.amazon.com/glue/latest/dg/aws-glue-programming-etl-partitions.html">narrow down the target partition</a>.
<code>additional_options</code> is narrowed down when <code>getPartition()</code>, so it is efficient when the number of partitions is huge but the <a href="https://docs.aws.amazon.com/glue/latest/dg/partition-indexes.html">partition index</a> is needed on the table, and it cannot be indexed if the partition key type is date.
<code>pushDownPredicate</code> is narrowed down after <code>getPartition()</code>. These can also be used together.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python">pushDownPredicate<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;day&gt;=10 and customer_id like &#39;10%&#39;&#34;</span>,
additional_options<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#34;catalogPartitionPredicate&#34;</span>:<span style="color:#f1fa8c">&#34;year=&#39;2021&#39; and month=&#39;06&#39;&#34;</span>}
</code></pre></div>
    </div>
    <div class="share">
      <div class="cell">
        <div>share</div>
        <div>
          <a class="share-button" href='https://twitter.com/intent/tweet?url=https://www.sambaiz.net/en/article/333/&text=Enable%20Job%20Bookmark%20of%20AWS%20Glue%20to%20process%20from%20the%20records%20following%20ones%20executed%20previously%20-%20sambaiz-net'>
            <img src="/image/twitter.png" width="40px" height="40px" alt="twitter">
          </a>
          <a href="https://b.hatena.ne.jp/entry/" class="share-button hatena-bookmark-button" data-hatena-bookmark-layout="touch" data-hatena-bookmark-width="40" data-hatena-bookmark-height="40" title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="40" height="40" style="border: none;" />
          </a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
        </div>
      </div>
    </div>
  </article>
</div>

</div>
</body>

</html>