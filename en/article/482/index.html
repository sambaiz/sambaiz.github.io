<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Update replicas using K8s HorizontalPodAutoscaler and set determination interval and increase/decrease limit - sambaiz-net</title>
  <meta name="twitter:title" content="Update replicas using K8s HorizontalPodAutoscaler and set determination interval and increase/decrease limit - sambaiz-net">
  <meta property='og:title' content="Update replicas using K8s HorizontalPodAutoscaler and set determination interval and increase/decrease limit - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="HorizontalPodAutoscaler (HPA) updates the replicas of the scaleTargetRef resource based on metrics">
  <meta name="twitter:description" content="HorizontalPodAutoscaler (HPA) updates the replicas of the scaleTargetRef resource based on metrics">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/482/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/482/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/482/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/482/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Update replicas using K8s HorizontalPodAutoscaler and set determination interval and increase/decrease limit",
    "datePublished": "2024-04-29T19:01:00JST",
    "dateModified": "2024-04-29T19:01:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "HorizontalPodAutoscaler (HPA) updates the replicas of the scaleTargetRef resource based on metrics"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/482/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/linux/">
            linux</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Update replicas using K8s HorizontalPodAutoscaler and set determination interval and increase/decrease limit</h1>
        <time>2024-04-29</time>
        <a class="tag" href='/en/tags/kubernetes/'>kubernetes</a>
      </div>
      <p><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">HorizontalPodAutoscaler (HPA)</a> updates the replicas of the scaleTargetRef resource based on metrics.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: autoscaling/v2
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: HorizontalPodAutoscaler
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: testapp-hpa
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">scaleTargetRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">name</span>: testapp
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">minReplicas</span>: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">maxReplicas</span>: <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">metrics</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">type</span>: Resource
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">resource</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">name</span>: cpu
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">target</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">type</span>: Utilization
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">averageUtilization</span>: <span style="color:#bd93f9">70</span>
</span></span></code></pre></div><p>If replicas is included in the Deployment&rsquo;s manifest, it may be overwritten when it is applied, so it is better not to include it. However, note that if you delete the replicas and apply it, replicas will be update to the default value 1 by the merge patch with <a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/declarative-config/#how-apply-calculates-differences-and-merges-changes">kubectl.kubernetes.io/last-applied-configuration</a>.</p>
<p>If you want to specify metrics such as cpu etc., you need to install <a href="https://github.com/kubernetes-sigs/metrics-server">Metrics Server</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#6272a4">// $ kubectl top node
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// error: Metrics API not available
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>cluster.addHelmChart(<span style="color:#f1fa8c">&#39;metrics-server&#39;</span>, {
</span></span><span style="display:flex;"><span>  chart<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;metrics-server&#39;</span>,
</span></span><span style="display:flex;"><span>  release<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;metrics-server&#39;</span>,
</span></span><span style="display:flex;"><span>  repository<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;https://kubernetes-sigs.github.io/metrics-server&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;kube-system&#39;</span>,
</span></span><span style="display:flex;"><span>  createNamespace: <span style="color:#8be9fd">false</span>,
</span></span><span style="display:flex;"><span>  wait: <span style="color:#8be9fd">true</span>
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>Utilization is calculated from the total container usage and request or limit resource amount, and replicas is determined by the following formula. For example, if averageUtilization: 70 and average CPU usage is 140%, replicas will be set to double the current value.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>desiredReplicas = ceil[currentReplicas * ( currentMetricValue / desiredMetricValue )]
</span></span></code></pre></div><p>If you use multiple generation instance types, there can be variation in CPU usage among Pods, and the average may not scale well. In that case, you can refer to external metrics provided by KEDA, etc.</p>
<p><a href="https://www.sambaiz.net/en/article/490/">Prometheus metrics and time based scaling with KEDA (Kubernetes Event-driven Autoscaling) - sambaiz-net</a></p>
<p>If the load comes from requests, it would be good to change the routing policy of ALB to LOR.</p>
<p><a href="https://www.sambaiz.net/en/article/471/">Install AWS Load Balancer Controller on EKS cluster and set up ALB Ingress - sambaiz-net</a></p>
<p>If there are multiple metrics, the maximum number of replicas will be used, and if there is a metrics that can&rsquo;t be obtained, scale down won&rsquo;t occur.</p>
<p>The determination interval is &ndash;horizontal-pod-autoscaler-sync-period of <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/">kube-controller-manager</a>, and the default is 15 seconds. In order to make scaling earlier, I would like to make it as short as possible, but it can&rsquo;t be changed at present on EKS, which can&rsquo;t touch the control plane. Anyway, if there are not enough resources, pods will not start, so it is also necessary to work on making it easier to request resources using PriorityClass and on speeding up node scaling.</p>
<p><a href="https://www.sambaiz.net/en/article/481/">Priority of K8s pods and preemption - sambaiz-net</a></p>
<p><a href="https://www.sambaiz.net/en/article/455/">Install Karpenter on an EKS cluster with CDK to auto-scale flexibility and quickly - sambaiz-net</a></p>
<p>You can set the upper limit for increase/decrease in behavior, and <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#default-behavior">the default</a> is following settings. periodSeconds: 15 and value: 100 in the Percent policy mean that the number of pods will increase/decrease by at most 100% of the current number of pods in 15 seconds. If there are multiple policies, selectPolicy selects which value will be applied, and the default is Max. <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#stabilization-window">stabilizationWindowSeconds</a> is a value to avoid flapping, where the number of pods is unstable due to frequent metrics updates, and the maximum value during this period will be used.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">behavior</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">scaleDown</span>:
</span></span><span style="display:flex;"><span>	  <span style="color:#ff79c6">stabilizationWindowSeconds</span>: <span style="color:#bd93f9">300</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#ff79c6">policies</span>:
</span></span><span style="display:flex;"><span>	  - <span style="color:#ff79c6">type</span>: Percent
</span></span><span style="display:flex;"><span>		  <span style="color:#ff79c6">value</span>: <span style="color:#bd93f9">100</span>
</span></span><span style="display:flex;"><span>		  <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">15</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">scaleUp</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">stabilizationWindowSeconds</span>: <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#ff79c6">policies</span>:
</span></span><span style="display:flex;"><span>	  - <span style="color:#ff79c6">type</span>: Percent
</span></span><span style="display:flex;"><span>	    <span style="color:#ff79c6">value</span>: <span style="color:#bd93f9">100</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">15</span>
</span></span><span style="display:flex;"><span>	  - <span style="color:#ff79c6">type</span>: Pods
</span></span><span style="display:flex;"><span>	    <span style="color:#ff79c6">value</span>: <span style="color:#bd93f9">4</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">15</span>
</span></span><span style="display:flex;"><span>	   <span style="color:#ff79c6">selectPolicy</span>: Max
</span></span></code></pre></div><h2 id="references">References</h2>
<p><a href="https://zenn.dev/zozotech/articles/b931eca7abc19d">あれ、本番環境のKubernetes Podがいなくなっちゃったよ</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>