<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 30px;
        height: 30px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .share-button > img {
        border: none;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }

    .share {
        position: relative;
        text-align: right;
        margin-top: 5px;
    }

    .share .cell {
        display: inline-block;
        text-align: center;
        margin-bottom: 5px;
    }

    .share-button {
        display: inline-block;
        margin: 0 5px;
    }

    @media screen and (min-width: 1400px) {
        .share .cell {
            position: absolute;
            bottom: 0;
            margin-left: 5px;
        }

        .share-button {
            display: inline-block;
            margin: 5px 0;
        }
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Create an environment of Amazon Managed Workflow for Apache Airflow (MWAA) with CDK and run a workflow - sambaiz-net</title>
  <meta name="twitter:title" content="Create an environment of Amazon Managed Workflow for Apache Airflow (MWAA) with CDK and run a workflow - sambaiz-net">
  <meta property='og:title' content="Create an environment of Amazon Managed Workflow for Apache Airflow (MWAA) with CDK and run a workflow - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="Managed service of Apache Airflow">
  <meta name="twitter:description" content="Managed service of Apache Airflow">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/428/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/428/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/428/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/428/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Create an environment of Amazon Managed Workflow for Apache Airflow (MWAA) with CDK and run a workflow",
    "datePublished": "2022-11-28T19:34:00JST",
    "dateModified": "2022-11-28T19:34:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "Managed service of Apache Airflow"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/428/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.goodreads.com/sambaiz">
            <img src="/image/goodreads.svg" width="30px" height="30px" alt="goodreads">
          </a>
        </div>
        <div class="sns-item">
          <a href="https://filmarks.com/users/sambaiz" class="filmarks" aria-label="filmarks"></a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/ios/">
            ios</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Create an environment of Amazon Managed Workflow for Apache Airflow (MWAA) with CDK and run a workflow</h1>
        <time>2022-11-28</time>
        <a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/airflow/'>airflow</a><a class="tag" href='/en/tags/etl/'>etl</a>
      </div>
      <p><a href="https://aws.amazon.com/managed-workflows-for-apache-airflow">Amazon Managed Workflow for Apache Airflow (MWAA)</a> is a managed service of <a href="https://airflow.apache.org/">Apache Airflow</a>.
Unlike Step Functions that is serverless, it <a href="https://aws.amazon.com/managed-workflows-for-apache-airflow/pricing/">costs</a> per an instance hour,
but Airflow&rsquo;s abundant features and third-party&rsquo;s, including AWS, <a href="https://airflow.apache.org/docs/#providers-packagesdocsapache-airflow-providersindexhtml">providers packages</a> are available.</p>
<p><a href="https://www.sambaiz.net/en/article/425/">Run Apache Airflow with Docker Compose and execute a workflow - sambaiz-net</a></p>
<p>Step Functions doesn&rsquo;t support execution from the middle of the workflow currently, so retrying a very long workflow can be hard.
Also, if you include the input value in an array of object values such as args of EmrAddStep, you need to process it into an array with Lambda in advance.
If you feel inconvenienced with such things now, migrating to MWAA may be a option.</p>
<p><a href="https://www.sambaiz.net/article/332/">CDKでStep Functionsによるワークフローを構築する - sambaiz-net</a></p>
<h2 id="create-an-environment-with-cdk">Create an environment with CDK</h2>
<p>Referring to CloudFormation template in <a href="https://docs.aws.amazon.com/mwaa/latest/userguide/quick-start.html">Quick start</a>, write CDK codes.</p>
<p>To create a MWAA environment, following resources are required.</p>
<ul>
<li><a href="https://docs.aws.amazon.com/mwaa/latest/userguide/networking-about.html#networking-about-overview-public">VPC</a>
<ul>
<li>2 public (if routing over the Internet) and private subnets.</li>
<li>A security group that allows communicating with each other.</li>
</ul>
</li>
<li>S3 Bucket that DAG&rsquo;s sources and requirements.txt place</li>
<li><a href="https://docs.aws.amazon.com/mwaa/latest/userguide/mwaa-create-role.html">Execution Role</a>
<ul>
<li>s3
<ul>
<li>if no blockPublicAccess, &ldquo;Unable to check PublicAccessBlock configuration&rdquo; error occurs</li>
</ul>
</li>
<li>cloudwatch: sending metrics and logs</li>
<li>sqs: queueing tasks</li>
<li>kms: encrypting data</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> { 
</span></span><span style="display:flex;"><span>  Stack, 
</span></span><span style="display:flex;"><span>  StackProps,
</span></span><span style="display:flex;"><span>  Tags,
</span></span><span style="display:flex;"><span>  aws_ec2 <span style="color:#ff79c6">as</span> ec2, 
</span></span><span style="display:flex;"><span>  aws_s3 <span style="color:#ff79c6">as</span> s3, 
</span></span><span style="display:flex;"><span>  aws_iam <span style="color:#ff79c6">as</span> iam,
</span></span><span style="display:flex;"><span>  aws_mwaa <span style="color:#ff79c6">as</span> mwaa
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#39;aws-cdk-lib&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> { Construct } <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#39;constructs&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> MwaaStack <span style="color:#ff79c6">extends</span> Stack {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">constructor</span>(scope: <span style="color:#8be9fd">Construct</span>, id: <span style="color:#8be9fd">string</span>, props?: <span style="color:#8be9fd">StackProps</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">super</span>(scope, id, props);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> vpc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ec2.Vpc(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;MwaaVPC&#39;</span>, {
</span></span><span style="display:flex;"><span>      ipAddresses: <span style="color:#8be9fd">ec2.IpAddresses.cidr</span>(<span style="color:#f1fa8c">&#39;10.0.0.0/16&#39;</span>),
</span></span><span style="display:flex;"><span>      maxAzs: <span style="color:#8be9fd">2</span>,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    Tags.<span style="color:#ff79c6">of</span>(vpc).add(<span style="color:#f1fa8c">&#39;Name&#39;</span>, <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span><span style="color:#ff79c6">this</span>.stackName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">VPC`</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> securityGroup <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ec2.SecurityGroup(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;MwaaSecurityGroup&#39;</span>, {
</span></span><span style="display:flex;"><span>      vpc: <span style="color:#8be9fd">vpc</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    securityGroup.addIngressRule(securityGroup, ec2.Port.allTcp())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> sourceBucket <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> s3.Bucket(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;MwaaSourceBucket&#39;</span>, {
</span></span><span style="display:flex;"><span>      blockPublicAccess<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>        blockPublicAcls: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>        blockPublicPolicy: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>        ignorePublicAcls: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>        restrictPublicBuckets: <span style="color:#8be9fd">true</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> mwaaEnvironmentName <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span><span style="color:#ff79c6">this</span>.stackName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">-mwaa-env`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> executionRole <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> iam.Role(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;MwaaExecutionRole&#39;</span>, {
</span></span><span style="display:flex;"><span>      roleName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span><span style="color:#ff79c6">this</span>.stackName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">-exeuction-role`</span>,
</span></span><span style="display:flex;"><span>      assumedBy: <span style="color:#8be9fd">new</span> iam.CompositePrincipal(
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> iam.ServicePrincipal(<span style="color:#f1fa8c">&#39;airflow-env.amazonaws.com&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> iam.ServicePrincipal(<span style="color:#f1fa8c">&#39;airflow.amazonaws.com&#39;</span>),
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>      path<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;/service-role/&#39;</span>,
</span></span><span style="display:flex;"><span>      inlinePolicies<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#39;execution-policy&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">new</span> iam.PolicyDocument({
</span></span><span style="display:flex;"><span>          statements<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>              effect: <span style="color:#8be9fd">iam.Effect.ALLOW</span>,
</span></span><span style="display:flex;"><span>              actions<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;airflow:PublishMetrics&#39;</span>],
</span></span><span style="display:flex;"><span>              resources<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">`arn:aws:airflow:</span><span style="color:#f1fa8c">${</span><span style="color:#ff79c6">this</span>.region<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:</span><span style="color:#f1fa8c">${</span><span style="color:#ff79c6">this</span>.account<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:environment/</span><span style="color:#f1fa8c">${</span>mwaaEnvironmentName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>]
</span></span><span style="display:flex;"><span>            }),
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>              effect: <span style="color:#8be9fd">iam.Effect.DENY</span>,
</span></span><span style="display:flex;"><span>              actions<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;s3:ListAllMyBuckets&#39;</span>],
</span></span><span style="display:flex;"><span>              resources<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>                sourceBucket.bucketArn,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>sourceBucket.bucketArn<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/*`</span>
</span></span><span style="display:flex;"><span>              ]
</span></span><span style="display:flex;"><span>            }),
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>              effect: <span style="color:#8be9fd">iam.Effect.ALLOW</span>,
</span></span><span style="display:flex;"><span>              actions<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;s3:GetObject*&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;s3:GetBucket*&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;s3:List*&#39;</span>
</span></span><span style="display:flex;"><span>              ],
</span></span><span style="display:flex;"><span>              resources<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>                sourceBucket.bucketArn,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>sourceBucket.bucketArn<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/*`</span>
</span></span><span style="display:flex;"><span>              ]
</span></span><span style="display:flex;"><span>            }),
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>              effect: <span style="color:#8be9fd">iam.Effect.ALLOW</span>,
</span></span><span style="display:flex;"><span>              actions<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;logs:DescribeLogGroups&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;s3:GetAccountPublicAccessBlock&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;cloudwatch:PutMetricData&#39;</span>
</span></span><span style="display:flex;"><span>              ],
</span></span><span style="display:flex;"><span>              resources<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;*&#39;</span>]
</span></span><span style="display:flex;"><span>            }),
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>              effect: <span style="color:#8be9fd">iam.Effect.ALLOW</span>,
</span></span><span style="display:flex;"><span>              actions<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;logs:CreateLogStream&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;logs:CreateLogGroup&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;logs:PutLogEvents&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;logs:GetLogEvents&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;logs:GetLogRecord&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;logs:GetLogGroupFields&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;logs:GetQueryResults&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;logs:DescribeLogGroups&#39;</span>,
</span></span><span style="display:flex;"><span>              ], 
</span></span><span style="display:flex;"><span>              resources<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">`arn:aws:logs:</span><span style="color:#f1fa8c">${</span><span style="color:#ff79c6">this</span>.region<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:</span><span style="color:#f1fa8c">${</span><span style="color:#ff79c6">this</span>.account<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:log-group:airflow-</span><span style="color:#f1fa8c">${</span>mwaaEnvironmentName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">-*`</span>],
</span></span><span style="display:flex;"><span>            }),
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>              effect: <span style="color:#8be9fd">iam.Effect.ALLOW</span>,
</span></span><span style="display:flex;"><span>              actions<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;sqs:ChangeMessageVisibility&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;sqs:DeleteMessage&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;sqs:GetQueueAttributes&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;sqs:GetQueueUrl&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;sqs:ReceiveMessage&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;sqs:SendMessage&#39;</span>
</span></span><span style="display:flex;"><span>              ],
</span></span><span style="display:flex;"><span>              resources<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">`arn:aws:sqs:</span><span style="color:#f1fa8c">${</span><span style="color:#ff79c6">this</span>.region<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:*:airflow-celery-*`</span>]
</span></span><span style="display:flex;"><span>            }),
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>              effect: <span style="color:#8be9fd">iam.Effect.ALLOW</span>,
</span></span><span style="display:flex;"><span>              actions<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;kms:Decrypt&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;kms:DescribeKey&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;kms:GenerateDataKey*&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;kms:Encrypt&#39;</span>
</span></span><span style="display:flex;"><span>              ],
</span></span><span style="display:flex;"><span>              notResources<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">`arn:aws:kms:*:</span><span style="color:#f1fa8c">${</span><span style="color:#ff79c6">this</span>.account<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:key/*&#34;`</span>],
</span></span><span style="display:flex;"><span>              conditions<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>                StringLike<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>                  <span style="color:#f1fa8c">&#39;kms:ViaService&#39;</span><span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">`sqs.</span><span style="color:#f1fa8c">${</span><span style="color:#ff79c6">this</span>.region<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">.amazonaws.com`</span>
</span></span><span style="display:flex;"><span>                  ],
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>              },
</span></span><span style="display:flex;"><span>            }),
</span></span><span style="display:flex;"><span>          ]
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The resource amount of a scheduler/worker depends on <a href="https://docs.aws.amazon.com/mwaa/latest/userguide/environment-class.html#environment-class-onconsole">environmentClass</a>, and a small worker runs <a href="https://docs.aws.amazon.com/mwaa/latest/userguide/best-practices-tuning.html#best-practices-tuning-tasks">5 tasks</a> concurrently by default.</p>
<p>As it is, params couldn&rsquo;t be overwritten with configs passed on triggered, so set <a href="https://airflow.apache.org/docs/apache-airflow/2.2.2/configurations-ref.html#dag-run-conf-overrides-params">core.dag_run_conf_overrides_params</a> to true with airflowConfigurationOptions.
Configs can be <a href="https://airflow.apache.org/docs/apache-airflow/2.4.3/howto/set-config.html">obtained</a> with AIRFLOW__{SECTION}__{KEY} environment variables.</p>
<p>Creating an environment takes tens of minutes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> mwaaEnvironment <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> mwaa.CfnEnvironment(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;MwaaEnvironment&#39;</span>, {
</span></span><span style="display:flex;"><span>  name: <span style="color:#8be9fd">mwaaEnvironmentName</span>,
</span></span><span style="display:flex;"><span>  airflowVersion<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;2.2.2&#39;</span>,
</span></span><span style="display:flex;"><span>  airflowConfigurationOptions<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;core.dag_run_conf_overrides_params&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;app.env&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;prd&#39;</span>, <span style="color:#6272a4">// os.getenv(&#34;AIRFLOW__APP__ENV&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  },
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>  sourceBucketArn: <span style="color:#8be9fd">sourceBucket.bucketArn</span>,
</span></span><span style="display:flex;"><span>  executionRoleArn: <span style="color:#8be9fd">executionRole.roleArn</span>,
</span></span><span style="display:flex;"><span>  dagS3Path<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;dags&#39;</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  networkConfiguration<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    securityGroupIds<span style="color:#ff79c6">:</span> [ securityGroup.securityGroupId ],
</span></span><span style="display:flex;"><span>    subnetIds: <span style="color:#8be9fd">vpc.privateSubnets.map</span>(s <span style="color:#ff79c6">=&gt;</span> s.subnetId),
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  webserverAccessMode<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;PUBLIC_ONLY&#34;</span>,
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  environmentClass<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;mw1.small&#39;</span>,
</span></span><span style="display:flex;"><span>  maxWorkers: <span style="color:#8be9fd">1</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  loggingConfiguration<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    dagProcessingLogs<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      enabled: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>      logLevel<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;INFO&#39;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    schedulerLogs<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      enabled: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>      logLevel<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;INFO&#39;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    taskLogs<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      enabled: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>      logLevel<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;INFO&#39;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    workerLogs<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      enabled: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>      logLevel<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;INFO&#39;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    webserverLogs<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      enabled: <span style="color:#8be9fd">true</span>,
</span></span><span style="display:flex;"><span>      logLevel<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;INFO&#39;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><h2 id="access-to-airflow-uihttpsdocsawsamazoncommwaalatestuserguideaccess-airflow-uihtml"><a href="https://docs.aws.amazon.com/mwaa/latest/userguide/access-airflow-ui.html">Access to Airflow UI</a></h2>
<p>It can be accessed from the console, and it can also be accessed by obtaining a login token with CLI.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">ENV_NAME</span><span style="color:#ff79c6">=</span>MwaaStack-mwaa-env
</span></span><span style="display:flex;"><span>$ aws mwaa create-web-login-token --name <span style="color:#8be9fd;font-style:italic">$ENV_NAME</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;WebServerHostname&#34;</span>: <span style="color:#f1fa8c">&#34;*****.c9.ap-northeast-1.airflow.amazonaws.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;WebToken&#34;</span>: <span style="color:#f1fa8c">&#34;*****&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ open <span style="color:#ff79c6">$(</span>aws mwaa create-web-login-token --name <span style="color:#8be9fd;font-style:italic">$ENV_NAME</span> | jq -r <span style="color:#f1fa8c">&#39;&#34;https://&#34; + .WebServerHostname + &#34;/aws_mwaa/aws-console-sso?login=true#&#34; + .WebToken&#39;</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>Besides, when you <a href="https://docs.aws.amazon.com/mwaa/latest/userguide/airflow-cli-command-reference.html">call Airflow CLI</a>, get the cli token and authorize with it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ aws mwaa create-cli-token --name <span style="color:#8be9fd;font-style:italic">$ENV_NAME</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;CliToken&#34;</span>: <span style="color:#f1fa8c">&#34;*****&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;WebServerHostname&#34;</span>: <span style="color:#f1fa8c">&#34;*****.c8.ap-northeast-1.airflow.amazonaws.com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">CLI_JSON</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>aws mwaa create-cli-token --name <span style="color:#8be9fd;font-style:italic">$ENV_NAME</span><span style="color:#ff79c6">)</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#8be9fd;font-style:italic">CLI_TOKEN</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#8be9fd;font-style:italic">$CLI_JSON</span> | jq -r <span style="color:#f1fa8c">&#39;.CliToken&#39;</span><span style="color:#ff79c6">)</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#8be9fd;font-style:italic">WEB_SERVER_HOSTNAME</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#8be9fd;font-style:italic">$CLI_JSON</span> | jq -r <span style="color:#f1fa8c">&#39;.WebServerHostname&#39;</span><span style="color:#ff79c6">)</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    <span style="color:#ff79c6">&amp;&amp;</span> curl -X POST <span style="color:#f1fa8c">&#34;https://</span><span style="color:#8be9fd;font-style:italic">$WEB_SERVER_HOSTNAME</span><span style="color:#f1fa8c">/aws_mwaa/cli&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    -H <span style="color:#f1fa8c">&#34;Authorization: Bearer </span><span style="color:#8be9fd;font-style:italic">$CLI_TOKEN</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    -H <span style="color:#f1fa8c">&#34;Content-Type: text/plain&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    -d <span style="color:#f1fa8c">&#34;version&#34;</span> | jq -r <span style="color:#f1fa8c">&#39;.stdout&#39;</span> | base64 -d
</span></span><span style="display:flex;"><span>2.2.2
</span></span></code></pre></div><h2 id="run-a-workflow">Run a workflow</h2>
<p>Upload the following codes that add a step with <a href="https://airflow.apache.org/docs/apache-airflow-providers-amazon/6.1.0/_api/airflow/providers/amazon/aws/operators/emr/index.html#airflow.providers.amazon.aws.operators.emr.EmrAddStepsOperator">EmrAddStepsOperator</a>, and
wait until it has been completed with <a href="https://airflow.apache.org/docs/apache-airflow-providers-amazon/6.1.0/_api/airflow/providers/amazon/aws/sensors/emr/index.html#airflow.providers.amazon.aws.sensors.emr.EmrStepSensor">EmrStepSensor</a>, to dagS3Path.
These are equivalent to <a href="https://docs.aws.amazon.com/step-functions/latest/dg/connect-emr.html">elasticmapreduce:addStep.sync</a> of Step Functions.</p>
<p><a href="https://www.sambaiz.net/en/article/409/">Launch an EMR cluster with AWS CLI and run Spark applications - sambaiz-net</a></p>
<p>The default mode of <a href="https://airflow.apache.org/docs/apache-airflow/2.5.0/_api/airflow/sensors/base/index.html">BaseSensorOperator</a> is &ldquo;poke&rdquo;, and it takes up a worker slot while waiting, but &ldquo;reschedule&rdquo; does not.</p>
<p>Putting an Operator and a Sensor into a TaskGroup makes the DAG easier to see, but Tasks are scheduled individually like any other, so it needs to devise for retries.</p>
<p><a href="https://www.sambaiz.net/en/article/432/">Retry processing consisting of multiple Tasks with Callbacks in Airflow - sambaiz-net</a></p>




<div class="img_container"><a href="/en/article/428/images/taskgroup.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/en/article/428/images/taskgroup_hu98ae7cb84e3423cf896c965e80ccf842_31798_600x370_fit_lanczos_3.png" width="600" height="183" alt="TaskGroup">
</a></div>


<p>apache-airflow-providers-amazon installed in <a href="https://docs.aws.amazon.com/mwaa/latest/userguide/connections-packages.html#connections-packages-table-222">Airflow v2.2.2 environment</a> is v2.4.0, which is a little old, so the module name is different.
Also, some operators such as <a href="https://airflow.apache.org/docs/apache-airflow-providers-amazon/6.2.0/_api/airflow/providers/amazon/aws/operators/lambda_function/index.html">AwsLambdaInvokeFunctionOperator</a> haven&rsquo;t existed yet, so if you want to use them, you need to implement them by yourself with <a href="https://github.com/apache/airflow/blob/2.2.2/airflow/providers/amazon/aws/hooks/lambda_function.py">hook</a> or bring codes from the latest version.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>$ cat test<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> datetime <span style="color:#ff79c6">import</span> datetime
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> airflow <span style="color:#ff79c6">import</span> DAG
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> airflow.providers.amazon.aws.operators.emr_add_steps <span style="color:#ff79c6">import</span> EmrAddStepsOperator
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> airflow.providers.amazon.aws.sensors.emr_step <span style="color:#ff79c6">import</span> EmrStepSensor
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> airflow.utils.task_group <span style="color:#ff79c6">import</span> TaskGroup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">with</span> DAG(
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#39;test&#39;</span>,
</span></span><span style="display:flex;"><span>  default_args<span style="color:#ff79c6">=</span>{},
</span></span><span style="display:flex;"><span>  start_date<span style="color:#ff79c6">=</span>datetime(<span style="color:#bd93f9">2022</span>, <span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">17</span>),
</span></span><span style="display:flex;"><span>  params<span style="color:#ff79c6">=</span>{
</span></span><span style="display:flex;"><span>     <span style="color:#f1fa8c">&#34;cluster_id&#34;</span>: <span style="color:#f1fa8c">&#34;j-3C4OVZL6MAM6H&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>) <span style="color:#ff79c6">as</span> dag:
</span></span><span style="display:flex;"><span>  clusterId <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;{{ params.cluster_id }}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">with</span> TaskGroup(<span style="color:#f1fa8c">&#34;app1&#34;</span>) <span style="color:#ff79c6">as</span> app1:
</span></span><span style="display:flex;"><span>    add_app1_step <span style="color:#ff79c6">=</span> EmrAddStepsOperator(
</span></span><span style="display:flex;"><span>      task_id<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;add_app1_step&#34;</span>,
</span></span><span style="display:flex;"><span>      job_flow_id<span style="color:#ff79c6">=</span>clusterId,
</span></span><span style="display:flex;"><span>      steps<span style="color:#ff79c6">=</span>[
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">&#34;Name&#34;</span>: <span style="color:#f1fa8c">&#34;calculate_pi&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">&#34;ActionOnFailure&#34;</span>: <span style="color:#f1fa8c">&#34;CONTINUE&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">&#34;HadoopJarStep&#34;</span>: {
</span></span><span style="display:flex;"><span>              <span style="color:#f1fa8c">&#34;Jar&#34;</span>: <span style="color:#f1fa8c">&#34;command-runner.jar&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#f1fa8c">&#34;Args&#34;</span>: [<span style="color:#f1fa8c">&#34;/usr/lib/spark/bin/run-example&#34;</span>, <span style="color:#f1fa8c">&#34;SparkPi&#34;</span>, <span style="color:#f1fa8c">&#34;10&#34;</span>],
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    wait_app1_step <span style="color:#ff79c6">=</span> EmrStepSensor(
</span></span><span style="display:flex;"><span>      task_id<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;wait_app1_step&#34;</span>,
</span></span><span style="display:flex;"><span>      job_flow_id<span style="color:#ff79c6">=</span>clusterId,
</span></span><span style="display:flex;"><span>      step_id<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">{{{{</span><span style="color:#f1fa8c"> ti.xcom_pull(task_ids=&#39;</span><span style="color:#f1fa8c">{</span>add_app1_step<span style="color:#ff79c6">.</span>task_id<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#39;, key=&#39;return_value&#39;)[0] </span><span style="color:#f1fa8c">}}}}</span><span style="color:#f1fa8c">&#34;</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    add_app1_step <span style="color:#ff79c6">&gt;&gt;</span> wait_app1_step
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">with</span> TaskGroup(<span style="color:#f1fa8c">&#34;app2&#34;</span>) <span style="color:#ff79c6">as</span> app2:
</span></span><span style="display:flex;"><span>    add_app2_step <span style="color:#ff79c6">=</span> EmrAddStepsOperator(
</span></span><span style="display:flex;"><span>      task_id<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;add_app2_step&#34;</span>,
</span></span><span style="display:flex;"><span>      job_flow_id<span style="color:#ff79c6">=</span>clusterId,
</span></span><span style="display:flex;"><span>      steps<span style="color:#ff79c6">=</span>[
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">&#34;Name&#34;</span>: <span style="color:#f1fa8c">&#34;calculate_pi&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">&#34;ActionOnFailure&#34;</span>: <span style="color:#f1fa8c">&#34;CONTINUE&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">&#34;HadoopJarStep&#34;</span>: {
</span></span><span style="display:flex;"><span>              <span style="color:#f1fa8c">&#34;Jar&#34;</span>: <span style="color:#f1fa8c">&#34;command-runner.jar&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#f1fa8c">&#34;Args&#34;</span>: [<span style="color:#f1fa8c">&#34;/usr/lib/spark/bin/run-example&#34;</span>, <span style="color:#f1fa8c">&#34;SparkPi&#34;</span>, <span style="color:#f1fa8c">&#34;10&#34;</span>],
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    wait_app2_step <span style="color:#ff79c6">=</span> EmrStepSensor(
</span></span><span style="display:flex;"><span>      task_id<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;wait_app2_step&#34;</span>,
</span></span><span style="display:flex;"><span>      job_flow_id<span style="color:#ff79c6">=</span>clusterId,
</span></span><span style="display:flex;"><span>      step_id<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">{{{{</span><span style="color:#f1fa8c"> ti.xcom_pull(task_ids=&#39;</span><span style="color:#f1fa8c">{</span>add_app2_step<span style="color:#ff79c6">.</span>task_id<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#39;, key=&#39;return_value&#39;)[0] </span><span style="color:#f1fa8c">}}}}</span><span style="color:#f1fa8c">&#34;</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    add_app2_step <span style="color:#ff79c6">&gt;&gt;</span> wait_app2_step
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  app1 <span style="color:#ff79c6">&gt;&gt;</span> app2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ aws s3 cp text<span style="color:#ff79c6">.</span>py s3:<span style="color:#ff79c6">//&lt;</span>source_bucket_name<span style="color:#ff79c6">&gt;/</span>dags<span style="color:#ff79c6">/</span>
</span></span></code></pre></div><p>If you run this task, it fails, and you see AccessDeniedException in the log, so attach the required policies to the Execution Role.
When no logs appeared, fixed the role and re-created an environment, and then I could see them.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>  effect: <span style="color:#8be9fd">iam.Effect.ALLOW</span>,
</span></span><span style="display:flex;"><span>  actions<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;elasticmapreduce:AddJobFlowSteps&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;elasticmapreduce:DescribeStep&#39;</span>,
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  resources<span style="color:#ff79c6">:</span> [ <span style="color:#f1fa8c">&#39;*&#39;</span> ]
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div>
    </div>
    <div class="share">
      <div class="cell">
        <div>share</div>
        <div>
          <a class="share-button" href='https://twitter.com/intent/tweet?url=https://www.sambaiz.net/en/article/428/&text=Create%20an%20environment%20of%20Amazon%20Managed%20Workflow%20for%20Apache%20Airflow%20%28MWAA%29%20with%20CDK%20and%20run%20a%20workflow%20-%20sambaiz-net'>
            <img src="/image/twitter.png" width="40px" height="40px" alt="twitter">
          </a>
          <a href="https://b.hatena.ne.jp/entry/" class="share-button hatena-bookmark-button" data-hatena-bookmark-layout="touch" data-hatena-bookmark-width="40" data-hatena-bookmark-height="40" title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="40" height="40" style="border: none;" />
          </a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
        </div>
      </div>
    </div>
  </article>
</div>

</div>
</body>

</html>