<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Running Spark MLlib on EMR Serverless from EMR Studio&#39;s Jupyter Notebook - sambaiz-net</title>
  <meta name="twitter:title" content="Running Spark MLlib on EMR Serverless from EMR Studio&#39;s Jupyter Notebook - sambaiz-net">
  <meta property='og:title' content="Running Spark MLlib on EMR Serverless from EMR Studio&#39;s Jupyter Notebook - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="EMR Studio is a Jupyter Notebook-based IDE that runs on EMR clusters. While cluster and S3 charges apply, the service itself is free. With EMR Serverless, you can use it easily without having to maintain constantly running clusters. As a similar service, Athena for Apache Spark is available and while it&#39;s easier to use as an extension of regular Athena, it has some limitations, such as no support for MLlib. Additionally, EMR Studio offers richer features like external IdP authentication and Git integration.">
  <meta name="twitter:description" content="EMR Studio is a Jupyter Notebook-based IDE that runs on EMR clusters. While cluster and S3 charges apply, the service itself is free. With EMR Serverless, you can use it easily without having to maintain constantly running clusters. As a similar service, Athena for Apache Spark is available and while it&#39;s easier to use as an extension of regular Athena, it has some limitations, such as no support for MLlib. Additionally, EMR Studio offers richer features like external IdP authentication and Git integration.">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/527/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/527/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/527/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/527/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Running Spark MLlib on EMR Serverless from EMR Studio's Jupyter Notebook",
    "datePublished": "2025-02-11T14:52:00JST",
    "dateModified": "2025-02-11T14:52:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "EMR Studio is a Jupyter Notebook-based IDE that runs on EMR clusters. While cluster and S3 charges apply, the service itself is free. With EMR Serverless, you can use it easily without having to maintain constantly running clusters. As a similar service, Athena for Apache Spark is available and while it's easier to use as an extension of regular Athena, it has some limitations, such as no support for MLlib. Additionally, EMR Studio offers richer features like external IdP authentication and Git integration."
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/527/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Running Spark MLlib on EMR Serverless from EMR Studio&#39;s Jupyter Notebook</h1>
        <time>2025-02-11</time>
        <a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/python/'>python</a><a class="tag" href='/en/tags/spark/'>spark</a>
      </div>
      <p><a href="https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-studio.html">EMR Studio</a> is a Jupyter Notebook-based IDE that runs on EMR clusters. While cluster and S3 charges apply, the service itself is free. With <a href="https://aws.amazon.com/emr/serverless">EMR Serverless</a>, you can use it easily without having to maintain constantly running clusters.</p>
<p>As a similar service, Athena for Apache Spark is available and while it&rsquo;s easier to use as an extension of regular Athena, it has some <a href="https://docs.aws.amazon.com/athena/latest/ug/notebooks-spark-considerations-and-limitations.html">limitations</a>, such as no support for MLlib. Additionally, EMR Studio offers richer features like <a href="https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-studio-create-studio.html">external IdP authentication</a> and <a href="https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-studio-git-repo.html">Git integration</a>.</p>
<p><a href="https://www.sambaiz.net/article/438/">Athena for Apache Spark の Notebook で DataFrame.toPandas().plot() した際の日本語が文字化けしないようにする - sambaiz-net</a></p>
<p>When you create a Studio,</p>




<div class="img_container"><a href="/article/527/images/create_studio.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/527/images/create_studio_hu_86301998005e4719.png" width="464" height="370" alt="Create Studio">
</a></div>


<p>Along with it, EMR Serverless and its associated Workspace (Notebook) are created. The Cluster ID corresponds to the Application ID, which can be confusing since you won&rsquo;t find it when searching for clusters.</p>




<div class="img_container"><a href="/article/527/images/workspaces.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/527/images/workspaces_hu_b7eaf0b85c5bd4ae.png" width="600" height="153" alt="Workspace">
</a></div>


<p>When running <a href="https://docs.aws.amazon.com/emr/latest/EMR-Serverless-UserGuide/interactive-workloads.html">interactive workloads</a> on EMR Serverless, kernels that have been idle for more than 60 minutes are automatically terminated from Notebooks. This time limit cannot be changed. Additionally, there is also an <a href="https://docs.aws.amazon.com/emr/latest/EMR-Serverless-UserGuide/app-behavior.html">auto-stop</a> setting for the Application itself. Even if the Application stops, the Workspace doesn’t disappear.</p>




<div class="img_container"><a href="/article/527/images/stopped_applications.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/527/images/stopped_applications_hu_3b852b3845f8ab35.png" width="600" height="97" alt="Stopped Application">
</a></div>


<p>When you configure VPC settings for Studio, you can switch to EMR on EC2 or on EKS. Clusters <a href="https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-studio-cluster-requirements.html">need to have</a> Spark, Livy, and Jupyter Enterprise Gateway installed. Note that EMR Serverless also has network settings, and changes to Studio settings will not be reflected. While it seems to be able to access S3 even with the default &ldquo;No network connectivity&rdquo; setting, it can’t connect to the Internet.</p>
<p><a href="https://www.sambaiz.net/en/article/486/">Install Livy on EMR on EKS and run Spark jobs from local Jupyter notebooks with Sparkmagic - sambaiz-net</a></p>




<div class="img_container"><a href="/article/527/images/compute.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/527/images/compute_hu_59e07c16909d8633.png" width="221" height="370" alt="Compute settings">
</a></div>


<p>Let&rsquo;s try running MLlib. By default, the Interactive runtime role only has EMR Studio&rsquo;s S3 permissions, so you&rsquo;ll need to grant glue and S3 permissions as needed.</p>
<p><a href="https://www.sambaiz.net/en/article/446/">Clustering by k-means method with MLlib of Spark - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> pyspark.sql <span style="color:#ff79c6">import</span> SparkSession
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> pyspark.ml.feature <span style="color:#ff79c6">import</span> VectorAssembler
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> pyspark.ml.clustering <span style="color:#ff79c6">import</span> KMeans
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>spark <span style="color:#ff79c6">=</span> SparkSession<span style="color:#ff79c6">.</span>builder<span style="color:#ff79c6">.</span>appName(<span style="color:#f1fa8c">&#34;test&#34;</span>)<span style="color:#ff79c6">.</span>getOrCreate()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>    (<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1.0</span>, <span style="color:#bd93f9">2.0</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1.5</span>, <span style="color:#bd93f9">1.8</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">5.0</span>, <span style="color:#bd93f9">8.0</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">6.0</span>, <span style="color:#bd93f9">9.0</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">9.0</span>, <span style="color:#bd93f9">3.0</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">9.5</span>, <span style="color:#bd93f9">2.5</span>)
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>columns <span style="color:#ff79c6">=</span> [<span style="color:#f1fa8c">&#34;id&#34;</span>, <span style="color:#f1fa8c">&#34;x&#34;</span>, <span style="color:#f1fa8c">&#34;y&#34;</span>]
</span></span><span style="display:flex;"><span>df <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>createDataFrame(data, columns)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>assembler <span style="color:#ff79c6">=</span> VectorAssembler(inputCols<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#34;x&#34;</span>, <span style="color:#f1fa8c">&#34;y&#34;</span>], outputCol<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;features&#34;</span>)
</span></span><span style="display:flex;"><span>vectorized_data <span style="color:#ff79c6">=</span> assembler<span style="color:#ff79c6">.</span>transform(df)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kmeans <span style="color:#ff79c6">=</span> KMeans(k<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span>, seed<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>, featuresCol<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;features&#34;</span>, predictionCol<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;prediction&#34;</span>)
</span></span><span style="display:flex;"><span>model <span style="color:#ff79c6">=</span> kmeans<span style="color:#ff79c6">.</span>fit(vectorized_data)
</span></span><span style="display:flex;"><span>predictions <span style="color:#ff79c6">=</span> model<span style="color:#ff79c6">.</span>transform(vectorized_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>predictions<span style="color:#ff79c6">.</span>show()
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">+---+---+---+---------+----------+
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">| id|  x|  y| features|prediction|
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">+---+---+---+---------+----------+
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">|  0|1.0|2.0|[1.0,2.0]|         1|
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">|  1|1.5|1.8|[1.5,1.8]|         1|
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">|  2|5.0|8.0|[5.0,8.0]|         0|
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">|  3|6.0|9.0|[6.0,9.0]|         0|
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">|  4|9.0|3.0|[9.0,3.0]|         2|
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">|  5|9.5|2.5|[9.5,2.5]|         2|
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">+---+---+---+---------+----------+
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span></code></pre></div>
    </div>
  </article>
</div>

</div>
</body>

</html>