<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>IP address exhaustion with EKS cluster and migration to IPv6 - sambaiz-net</title>
  <meta name="twitter:title" content="IP address exhaustion with EKS cluster and migration to IPv6 - sambaiz-net">
  <meta property='og:title' content="IP address exhaustion with EKS cluster and migration to IPv6 - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="When I ran a large application on an EKS cluster, the subnet&#39;s IP addresses ran out">
  <meta name="twitter:description" content="When I ran a large application on an EKS cluster, the subnet&#39;s IP addresses ran out">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/en/article/460/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/460/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/460/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/460/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "IP address exhaustion with EKS cluster and migration to IPv6",
    "datePublished": "2023-12-15T01:02:00JST",
    "dateModified": "2023-12-15T01:02:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "When I ran a large application on an EKS cluster, the subnet's IP addresses ran out"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/article/460/">日本語</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/en/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>IP address exhaustion with EKS cluster and migration to IPv6</h1>
        <time>2023-12-15</time>
        <a class="tag" href='/en/tags/aws/'>aws</a><a class="tag" href='/en/tags/kubernetes/'>kubernetes</a>
      </div>
      <p>When I ran a large application on an EKS cluster, the subnet&rsquo;s IP addresses ran out.</p>
<h2 id="reason-for-ip-address-exhaustion">Reason for IP address exhaustion</h2>
<p>Pod IP addresses are assigned by ipamd (IP Address Management Daemon) of <a href="https://github.com/aws/amazon-vpc-cni-k8s">VPC CNI</a>, and these are from the instance&rsquo;s secondary IP addresses.</p>




<div class="img_container"><a href="/article/460/images/secondary_ip_addrs.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/460/images/secondary_ip_addrs_hu6279438281126401799.png" width="600" height="323" alt="Secondary IP address">
</a></div>


<p>The number of secondary IP addresses are controlled with <a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/21c4bd73015b715866480cb1cfb9caba2f788027/README.md#warm_eni_target">WARM_ENI_TARGET</a> (Default: 1), which is the number of spare ENIs, or
<a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/21c4bd73015b715866480cb1cfb9caba2f788027/README.md#warm_eni_target">WARM_IP_TARGET</a> (Default: None), which is the number of spare IP addresses in VPC CNI settings.
By default, when the first Pod runs, the remaining IP address of the ENI is reduced by one, the second ENI is attached, and the maximum IP addresses that can be attached to the ENI are newly retained.
The maximum number of ENIs that can be attached to an instance and the maximum number of IP addresses that can be attached to an ENI are <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html#AvailableIpPerENI">depending on</a> the instance type.</p>
<p>This results in holding more IP addresses than necessary, especially when a small number of Pods are running on a node with a large instance type.
In this case, you can set WARM_IP_TARGET to hold the minimum number of IP addresses required.
When the cluster is large, EC2 API calls may be throttled due to a large number of calls, so it is recommended to set MINIMUM_IP_TARGET as well.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span>$ kubectl set env ds aws<span style="color:#ff79c6">-</span>node <span style="color:#ff79c6">-</span>n kube<span style="color:#ff79c6">-</span>system WARM_IP_TARGET<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>
</span></span></code></pre></div><p>It can also be changed with CDK.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">new</span> eks.KubernetesPatch(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;LimitWarmIPAddr&#39;</span>, {
</span></span><span style="display:flex;"><span>  cluster,
</span></span><span style="display:flex;"><span>  resourceName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;daemonset/aws-node&#39;</span>,
</span></span><span style="display:flex;"><span>  resourceNamespace<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;kube-system&#39;</span>,
</span></span><span style="display:flex;"><span>  applyPatch<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    spec<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      template<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>        spec<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>          containers<span style="color:#ff79c6">:</span> [{
</span></span><span style="display:flex;"><span>            name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;aws-node&#39;</span>,
</span></span><span style="display:flex;"><span>            env<span style="color:#ff79c6">:</span> [{
</span></span><span style="display:flex;"><span>              name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;WARM_IP_TARGET&#39;</span>,
</span></span><span style="display:flex;"><span>              value<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;2&#39;</span>,
</span></span><span style="display:flex;"><span>            }]
</span></span><span style="display:flex;"><span>          }],
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  restorePatch<span style="color:#ff79c6">:</span> {},
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>In this example, 5 Pods are running on a node with 7 IP addresses.</p>




<div class="img_container"><a href="/article/460/images/pods_and_ip_addrs.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/460/images/pods_and_ip_addrs_hu8441253510961873742.png" width="600" height="117" alt="Pod and IP addresses">
</a></div>






<div class="img_container"><a href="/article/460/images/secondary_ip_addrs2.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/460/images/secondary_ip_addrs2_hu1823757228288251863.png" width="600" height="267" alt="Secondary IP addresses with WARM_IP_TARGET">
</a></div>


<h2 id="migration-to-ipv6">migration to IPv6</h2>
<p>However, when a large number of Pods are running, there is no fundamental solution other than expanding CIDR blocks of subnets to solve IP addresses exhaustion.
In such a case, you can assign IPv6 addresses to Pods by setting the <a href="https://docs.aws.amazon.com/eks/latest/APIReference/API_KubernetesNetworkConfigRequest.html#AmazonEKS-Type-KubernetesNetworkConfigRequest-ipFamily">ipFamily</a> of the cluster to IPv6.
This setting is available only when the cluster is created. Also, IPv6 blocks must be assigned to the subnet, and it is <a href="https://docs.aws.amazon.com/eks/latest/userguide/cni-ipv6.html">not supported</a> on older instance types that are not Nitro-based.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#ff79c6">new</span> eks.Cluster(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;cluster&#39;</span>, {
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  ipFamily<span style="color:#ff79c6">:</span> eks.IpFamily.IP_V6
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>The IPv6 addresses are assigned from the IPv6 prefix. If the IPv6 prefix is not set or the node doesn&rsquo;t have the ec2:AssignIpv6Addresses permission,
you will see &ldquo;failed to assign an IP address to container&rdquo; error.
By the way, if you set ENABLE_PREFIX_DELEGATION=true even for IPv4, the addresses are assigned from the prefix, so you can run more Pods on one node.</p>




<div class="img_container"><a href="/article/460/images/pods_and_ipv6_addrs.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/460/images/pods_and_ipv6_addrs_hu7430401190652409603.png" width="600" height="118" alt="Pod and IPv6 addresses">
</a></div>






<div class="img_container"><a href="/article/460/images/ipv6prefix.png">
    <img style="max-width: 100%; width: auto; height: auto;" src="/article/460/images/ipv6prefix_hu9759310407602371010.png" width="600" height="299" alt="IPv6 prefix">
</a></div>


<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>nodeRole.attachInlinePolicy(<span style="color:#ff79c6">new</span> iam.Policy(scope, <span style="color:#f1fa8c">&#39;IPV6Policy&#39;</span>, {
</span></span><span style="display:flex;"><span>  statements<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">new</span> iam.PolicyStatement({
</span></span><span style="display:flex;"><span>      actions<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#34;ec2:AssignIpv6Addresses&#34;</span>, <span style="color:#f1fa8c">&#34;ec2:UnassignIpv6Addresses&#34;</span>],
</span></span><span style="display:flex;"><span>      resources<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#34;arn:aws:ec2:*:*:network-interface/*&#34;</span>],
</span></span><span style="display:flex;"><span>    }),
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>}))
</span></span></code></pre></div><p>Pods communicate with IPv6,
and in order to communicate with <a href="https://aws.amazon.com/jp/blogs/containers/amazon-eks-launches-ipv6-support/#:~:text=Pod%20to%20External%20IPv4">external IPv4 endpoints</a>, host-local IPv4 addresses are also assigned and it is NAT to the host ENI IPv4 address.</p>
<p><a href="https://www.sambaiz.net/en/article/457/">Create resources required for EC2 instance without public IPv4 but IPv6 address to communicate with the Internet - sambaiz-net</a></p>
<p>If capacity is not a managed node group, you need to pass <a href="https://github.com/awslabs/amazon-eks-ami/blob/master/files/bootstrap.sh">bootstrap.sh</a> parameter or pods aren&rsquo;t assigned IPv6 addresses.</p>
<p><a href="https://www.sambaiz.net/en/article/468/">Call AWS API with AwsCustomResource in CDK - sambaiz-net</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> clusterInfo <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> custom_resources.AwsCustomResource(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#39;EksDescribeCluster&#39;</span>, {
</span></span><span style="display:flex;"><span>  onUpdate<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    service<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;eks&#39;</span>,
</span></span><span style="display:flex;"><span>    action<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;describeCluster&#39;</span>,
</span></span><span style="display:flex;"><span>    parameters<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>      name: <span style="color:#8be9fd">cluster.clusterName</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    physicalResourceId: <span style="color:#8be9fd">custom_resources.PhysicalResourceId.fromResponse</span>(<span style="color:#f1fa8c">&#34;cluster.arn&#34;</span>)
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  policy: <span style="color:#8be9fd">custom_resources.AwsCustomResourcePolicy.fromSdkCalls</span>({
</span></span><span style="display:flex;"><span>    resources<span style="color:#ff79c6">:</span> [cluster.clusterArn]
</span></span><span style="display:flex;"><span>  }),
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cluster.addAutoScalingGroupCapacity(<span style="color:#f1fa8c">&#39;EKSClusterDefaultCapacity&#39;</span>, {
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  bootstrapOptions<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    additionalArgs<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">`--ip-family ipv6 --service-ipv6-cidr </span><span style="color:#f1fa8c">${</span>clusterInfo.getResponseField(<span style="color:#f1fa8c">&#34;cluster.kubernetesNetworkConfig.serviceIpv6Cidr&#34;</span>)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><h2 id="references">References</h2>
<p><a href="https://medium.com/@sueken0117/eks-production-ready-part-2-1702a120476d">EKS production ready! part.2</a></p>
<p><a href="https://dunkshoot.hatenablog.com/entry/eks_reduce_number_of_ipaddress">EKS Cluster の消費 IP 数を減らす - YasuBlog</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>