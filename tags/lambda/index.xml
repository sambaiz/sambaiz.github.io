<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Lambda on sambaiz-net</title>
    <link>https://www.sambaiz.net/tags/lambda/</link>
    <description>Recent content in Lambda on sambaiz-net</description>
    <generator>Hugo -- gohugo.io</generator>
    <copyright>sambaiz-net</copyright>
    <lastBuildDate>Sun, 07 Jul 2019 17:10:00 +0900</lastBuildDate>
    
	<atom:link href="https://www.sambaiz.net/tags/lambda/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>Cognito UserPoolã®PreSignUpã§å‘¼ã°ã‚Œã‚‹Lambdaã§ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶é™ã™ã‚‹</title>
      <link>https://www.sambaiz.net/article/228/</link>
      <pubDate>Sun, 07 Jul 2019 17:10:00 +0900</pubDate>
      
      <guid>https://www.sambaiz.net/article/228/</guid>
      <description>ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®IdPã‹ã‚‰Cognitoã«SignUpã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹å ´åˆã€ç‰¹å®šã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã„ã£ãŸã‚ˆã†ãªåˆ¶é™ã‚’ã‹ã‘ãŸã„ã“ã¨ãŒã‚ã‚‹ã€‚ ã“ã‚Œã‚’PreSignUpæ™‚ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã§UserPoolã«å…¥ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
Lambda CognitoEventUserPoolsPreSignupã‚’å—ã‘å–ã£ã¦è¿”ã™ã€‚
package main import ( &amp;quot;errors&amp;quot; &amp;quot;fmt&amp;quot; &amp;quot;github.com/aws/aws-lambda-go/events&amp;quot; &amp;quot;github.com/aws/aws-lambda-go/lambda&amp;quot; ) func handler(event events.CognitoEventUserPoolsPreSignup) (events.CognitoEventUserPoolsPreSignup, error) { fmt.Printf(&amp;quot;PreSignup of user: %s\n&amp;quot;, event.UserName) if event.Request.UserAttributes[&amp;quot;email&amp;quot;] != &amp;quot;godgourd@gmail.com&amp;quot; { return event, errors.New(&amp;quot;Forbidden&amp;quot;) } return event, nil } func main() { lambda.Start(handler) }  ãƒªã‚½ãƒ¼ã‚¹ UserPoolã®LambdaConfigã§ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã§ãã‚‹ã€‚ Cognitoã‹ã‚‰Lambdaã‚’å‘¼ã¹ã‚‹PermissionãŒå¿…è¦ã€‚
UserPool: Type: AWS::Cognito::UserPool Properties: ... LambdaConfig: PreSignUp: !GetAtt PresignupLambdaFunction.Arn UserPoolLambdaInvokePermission: Type: AWS::Lambda::Permission Properties: Action: lambda:invokeFunction Principal: cognito-idp.amazonaws.com FunctionName: !GetAtt PresignupLambdaFunction.Arn SourceArn: arn:aws:cognito-idp:&amp;lt;region&amp;gt;:&amp;lt;account_id&amp;gt;:userpool/*  ãªãŠALBã®Actionã§Cognitoèªè¨¼ã‚’å…¥ã‚Œã‚‹ã¨ç™»éŒ²å¤±æ•—æ™‚ã«500ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã†ã€‚ã“ã‚Œã‚’å›é¿ã™ã‚‹ã«ã¯è‡ªå‰ã§ã‚„ã‚‹ã—ã‹ãªã„ã®ã‹ã‚‚ã—ã‚Œãªã„ã€‚</description>
    </item>
    
    <item>
      <title>Lambdaã¨ALBã§Cognitoèªè¨¼ã‚’ã‹ã‘ã¦å¤±æ•—ã—ãŸã‚‰ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«é£›ã°ã™</title>
      <link>https://www.sambaiz.net/article/227/</link>
      <pubDate>Wed, 03 Jul 2019 23:55:00 +0900</pubDate>
      
      <guid>https://www.sambaiz.net/article/227/</guid>
      <description>ALBã®Targetã¨ã—ã¦LambdaãŒé¸æŠã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€ è‹¥å¹²ã®æ™‚é–“èª²é‡‘ãŒç™ºç”Ÿã™ã‚‹ä»£ã‚ã‚Šã«æŸ”è»Ÿã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ãã‚‹API Gatewayã®ã‚ˆã†ã«ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚ Actionã¨ã—ã¦Cognitoèªè¨¼ã‚’å…¥ã‚Œã¦èªè¨¼ã«å¤±æ•—ã—ãŸã‚‰ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤ºã•ã›ã‚‹ã€‚
API Gatewayã§Cognitoã®èªè¨¼ã‚’ã‹ã‘ã¦å¿…è¦ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«é£›ã°ã™å‡¦ç†ã‚’Goã§æ›¸ã - sambaiz-net
ACMã§è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã™ã‚‹ HTTPSã§Listenã™ã‚‹ãŸã‚è¨¼æ˜æ›¸ãŒå¿…è¦ã€‚ AWS Certificate Manager (ACM)ã§AWSã§ä½¿ãˆã‚‹è¨¼æ˜æ›¸ã‚’ç„¡æ–™ã§ç™ºè¡Œã§ãå‚ç…§ã§ãã‚‹ã€‚ å¤–éƒ¨ã§å–ã£ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã‚‚ã‚ˆã„ã€‚ æ¤œè¨¼æ–¹æ³•ã¯DNSã¨ãƒ¡ãƒ¼ãƒ«ã¨ã§é¸ã¶ã“ã¨ãŒã§ãã¦ã€DNSã§è¡Œã†å ´åˆRoute53ãªã‚‰ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§æ¤œè¨¼ç”¨ã®CNAMEãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã§ãã‚‹ã€‚ æ¤œè¨¼ã¾ã§ã‚„ã‚„æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§ã¡ã‚ƒã‚“ã¨é€šã£ã¦ã‚‹ã‹nslookupã§ç¢ºèªã—ã¨ã„ãŸæ–¹ãŒã‚ˆã„ã€‚
Application Load Balancer (ALB) æ¬¡ã®è¦ç´ ã‹ã‚‰æ§‹æˆã•ã‚Œã‚‹L7ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã€‚
 Listener: æŒ‡å®šã—ãŸãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¨ãƒãƒ¼ãƒˆã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã‚‹ã€‚ ListenerRule: ãƒ‘ã‚¹ã‚„Headerãªã©ã®å€¤ã‚’æ¡ä»¶ã«ã©ã®TargetGroupã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã‹ã®ãƒ«ãƒ¼ãƒ«ã€‚
 TargetGroup: ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹1ã¤ä»¥ä¸Šã®Targetã€‚Instance, IP, LambdaãŒé¸ã¹ã‚‹ã€‚  Ruleã®ä½œæˆ Serverless Frameworkã§ã¯ALBã®enentã‚’ä»˜ã‘ã‚‹ã ã‘ã§Lambdaã«å‘ãRuleãŒä½œæˆã•ã‚Œã‚‹ãŒã€ãã“ã«ã¯Cognitoã‚’è¿½åŠ ã§ããªã•ãã†ãªã®ã§ä½¿ã£ã¦ã„ãªã„ã€‚OnUnauthenticatedRequestã§èªè¨¼å¤±æ•—æ™‚ã®æŒ™å‹•ã‚’é¸æŠã§ãã‚‹ã€‚UserPoolã¨Secretã‚ã‚Šã®Clientã¯ã‚ã‚‰ã‹ã˜ã‚ä½œã£ã¦ãŠãã€‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URLã«ã¯https://&amp;lt;domain&amp;gt;/oauth2/idpresponseã‚’è¿½åŠ ã™ã‚‹ã€‚
API Gatewayã ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®ä¸Šé™ãŒ30ç§’ãªã®ã«å¯¾ã—ã¦ALBã¯Lambdaã®ä¸Šé™ã¾ã§å¾…ã¦ã‚‹ã€‚
$ cat serverless.yml service: alb-cognito-auth-example frameworkVersion: &amp;quot;&amp;gt;=1.28.0 &amp;lt;2.0.0&amp;quot; provider: name: aws runtime: go1.x region: ap-northeast-1 package: exclude: - ./** include: - ./bin/** functions: privateapi: handler: bin/privateapi timeout: 30 resources: Resources: ALBTargetGroup: DependsOn: InvokeLambdaPermissionForALB Type: AWS::ElasticLoadBalancingV2::TargetGroup Properties: Name: &amp;quot;private-lambda-target-group&amp;quot; TargetType: &amp;quot;lambda&amp;quot; Targets: - Id: !</description>
    </item>
    
    <item>
      <title>API Gatewayã§Cognitoã®èªè¨¼ã‚’ã‹ã‘ã¦å¿…è¦ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«é£›ã°ã™å‡¦ç†ã‚’Goã§æ›¸ã</title>
      <link>https://www.sambaiz.net/article/226/</link>
      <pubDate>Wed, 03 Jul 2019 20:15:00 +0900</pubDate>
      
      <guid>https://www.sambaiz.net/article/226/</guid>
      <description>ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥API Gatewayã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã¨ãã«Cognitoã®Tokenã§èªè¨¼ã—ã€å¤±æ•—ã—ãŸã‚‰ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤ºã•ã›ã‚‹ã€‚ API Gatewayã§Cognitoã®èªè¨¼ã‚’ã‹ã‘ã‚‹å ´åˆã€Authorizerã§UserPoolã‚’æŒ‡å®šã™ã‚‹ã®ãŒæœ€ã‚‚ç°¡å˜ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã ãŒã€ ã“ã‚Œã ã¨Headerã«Tokenã‚’ä»˜ã‘ã¦ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šèªè¨¼ã«å¤±æ•—ã™ã‚‹ã¨UnauthorizedãŒè¿”ã‚‹ã€‚
Cognito UserPoolã¨API Gatewayã§èªè¨¼ä»˜ãAPIã‚’ç«‹ã¦ã‚‹ - sambaiz-net
ãªãŠAPI Gatewayã§ã¯ãªãALBã‚’Lambdaã®å‰æ®µã«æŒŸã‚ã°ä»Šå›ã‚„ã‚‹ã“ã¨ãŒç°¡å˜ã«å®Ÿç¾ã§ãã‚‹ã€‚
Lambdaã¨ALBã§Cognitoèªè¨¼ã‚’ã‹ã‘ã¦å¤±æ•—ã—ãŸã‚‰ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«é£›ã°ã™ - sambaiz-net
æº–å‚™ UserPoolã¨Clientã‚’ä½œæˆã™ã‚‹ã€‚ CloudFormationã§ä½œæˆã™ã‚‹å ´åˆSchemaã®Mutableã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒfalseãªã®ã«æ³¨æ„ã€‚å¤‰ãˆã‚‹ã¨ä½œã‚Šç›´ã•ã‚Œã‚‹ã€‚
Resources: Userpool: Type: AWS::Cognito::UserPool Properties: AdminCreateUserConfig: AllowAdminCreateUserOnly: false Schema: - Mutable: true Name: email Required: true - Mutable: true Name: name Required: true UsernameAttributes: - email UserPoolName: testpool UserpoolClient: Type: AWS::Cognito::UserPoolClient Properties: UserPoolId: Ref: Userpool ClientName: testclient GenerateSecret: true  ä»Šå›ã¯ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ ã‚„ã‚„ã“ã—ã„ç”¨èªã§ã‚ã‚‹ãŒID Poolã®ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ãƒ†ã‚£ãƒƒãƒ‰ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨ã¯ç•°ãªã‚‹ã€‚
UserPoolã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚„ã€Googleã®OAuth Client IDã®ç™ºè¡Œã¨Attributes Mappingã€Clientã®è¨­å®šã¯CloudFormationã§ã§ããªã„ã®ã§æ‰‹ã§ã‚„ã‚‹ã€‚ Attributes Mappingã§å¤‰ãˆã‚‰ã‚Œã‚‹ãŒusernameã¯å¤‰æ›´ä¸å¯ãªå€¤ãªã®ã§subã®ã¾ã¾ã«ã—ã¦ãŠãã€‚
è¨­å®šãŒçµ‚ã‚ã£ãŸã‚‰ https://&amp;lt;user-pool-domain&amp;gt;/login?client_id=&amp;lt;client-id&amp;gt;&amp;amp;redirect_uri=&amp;lt;redirect-uri&amp;gt;&amp;amp;response_type=code ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€&amp;lt;redirect-uri&amp;gt;?</description>
    </item>
    
    <item>
      <title>Datadogã®AWS integrationã¨Alertã®è¨­å®šã‚’Terraformã§è¡Œã†</title>
      <link>https://www.sambaiz.net/article/219/</link>
      <pubDate>Sat, 04 May 2019 19:25:00 +0900</pubDate>
      
      <guid>https://www.sambaiz.net/article/219/</guid>
      <description>Datadogã®AWS integrationã¨Alertã®è¨­å®šã‚’Terraformã§è¡Œã„ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ å…¨ä½“ã®ã‚³ãƒ¼ãƒ‰ã¯GitHubã«ç½®ã„ã¦ã‚ã‚‹ã€‚
AWS Integration ã¾ãšdatadog_integration_awsã§AWS integrationã®è¨­å®šã‚’ä½œæˆã—ã¦ExternalIDã‚’å–å¾—ã—ã€Policy/Roleã‚’ä½œæˆã™ã‚‹ã€‚å¿…è¦ãªæ¨©é™ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã€‚
resource &amp;quot;datadog_integration_aws&amp;quot; &amp;quot;test&amp;quot; { account_id = &amp;quot;${var.aws_account_id}&amp;quot; role_name = &amp;quot;${var.aws_integration_role_name}&amp;quot; filter_tags = [&amp;quot;datadog:1&amp;quot;] } data &amp;quot;aws_iam_policy_document&amp;quot; &amp;quot;datadog_aws_integration_assume_role&amp;quot; { statement { actions = [&amp;quot;sts:AssumeRole&amp;quot;] principals { type = &amp;quot;AWS&amp;quot; identifiers = [&amp;quot;arn:aws:iam::464622532012:root&amp;quot;] } condition { test = &amp;quot;StringEquals&amp;quot; variable = &amp;quot;sts:ExternalId&amp;quot; values = [ &amp;quot;${datadog_integration_aws.test.external_id}&amp;quot;, ] } } }  Datadog providerã«ã¯ãªã„Slackãªã©ãã®ä»–ã®integrationã¯æ‰‹å‹•ã§è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ ã¾ãŸã€Logã‚‚é›†ã‚ã‚‹å ´åˆServerless Application Repositoryã‹ã‚‰å…¬å¼ã®Datadog-Log-Forwarderã‚’å…¥ã‚Œã¦ AWS Integrationã®ã¨ã“ã‚ã«Lambdaã®ARNã‚’å…¥ã‚Œã‚‹ã®ã‚‚æ‰‹å‹•ã€‚
Alert datadog_monitorã§Alertã‚’ä½œæˆã™ã‚‹ã€‚ ä»Šå›ã¯Lambdaã®å®Ÿè¡ŒãŒå¤±æ•—ã—ãŸã¨ãã¨ã€WARNã¨ã„ã†æ–‡å­—åˆ—ãŒå«ã¾ã‚Œã‚‹ãƒ­ã‚°ãŒä¸€å®šæ•°å‡ºåŠ›ã•ã‚ŒãŸã¨ãã«Alertã‚’é£›ã°ã™ã‚ˆã†ã«ã—ã¦ã¿ãŸã€‚ ãªãŠinfoã‚„warnã¨ã„ã£ãŸãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã¯jsonã®levelãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å…¥ã‚Œã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®pipelineã§ãƒãƒƒãƒ—ã•ã‚Œã‚‹ã®ã§é€šå¸¸ã¯æ–‡å­—åˆ—æ¯”è¼ƒãªã©ã™ã‚‹å¿…è¦ã¯ãªã„ã€‚
åˆã‚ã«ä½œã‚‹ã¨ãã¯ä¸€åº¦ç”»é¢ã§æ„å›³é€šã‚Šã‚¢ãƒ©ãƒ¼ãƒˆãŒé£›ã¶ã‚‚ã®ã‚’ä½œæˆã—ã€ã‚¯ã‚¨ãƒªãªã©ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã®ãŒç¢ºå®Ÿã€‚
resource &amp;quot;datadog_monitor&amp;quot; &amp;quot;lambda-error-alert&amp;quot; { name = &amp;quot;lambda-error-alert&amp;quot; type = &amp;quot;metric alert&amp;quot; message = &amp;quot;Error occurred.</description>
    </item>
    
    <item>
      <title>AWS SAMã§Lambdaã®é–¢æ•°ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—Serverless Application Repositoryã«å…¬é–‹ã™ã‚‹</title>
      <link>https://www.sambaiz.net/article/207/</link>
      <pubDate>Sun, 10 Feb 2019 16:35:00 +0900</pubDate>
      
      <guid>https://www.sambaiz.net/article/207/</guid>
      <description>AWS SAM (Serverless Application Model)ã¯AWSå…¬å¼ã® ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã€‚ CloudFormationã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãã“ã¨ã§Lambdaé–¢æ•°ã¨å…±ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ã‚„ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã‚‚å«ã‚ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã€ ãã®ç‚¹ã§Serverless Frameworkã¨ç«‹ã¡ä½ç½®ãŒè¿‘ã„ãŒã€å‘ã“ã†ãŒLambdaä»¥å¤–ã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒã«ã‚‚å¯¾å¿œã—ã¦ã„ãŸã‚Šã€ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã‚ˆã£ã¦æ©Ÿèƒ½æ‹¡å¼µã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ä¸€æ–¹ã€ã“ã¡ã‚‰ã¯æ¯”è¼ƒçš„è–„ã„ãƒ„ãƒ¼ãƒ«ã«ãªã£ã¦ã„ã‚‹ã€‚ ãŸã ã€Serverless Application Repositoryã§å…¬é–‹ã™ã‚‹ã«ã¯SAMã®å½¢å¼ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ Serverless Frameworkã«ã‚‚SAMã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‡ºåŠ›ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚ã‚‹ã€‚
Serverless Frameworkã§Lambdaã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ - sambaiz-net
SAM CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« $ brew tap aws/tap $ brew install aws-sam-cli $ sam --version SAM CLI, version 0.11.0  init initã™ã‚‹ã¨æ¬¡ã®æ§‹æˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œã‚‰ã‚Œã‚‹ã€‚
$ sam init --runtime go1.x -n test-sam $ cd test-sam/ $ ls Makefile	README.md	hello-world	template.yaml  template.yamlã®ä¸­ã«é–¢æ•°ã®è¨­å®šã‚„CloudFormationã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›¸ãã€‚
$ cat template.yaml AWSTemplateFormatVersion: &#39;2010-09-09&#39; Transform: AWS::Serverless-2016-10-31 Description: &amp;gt; test-sam Sample SAM Template for test-sam # More info about Globals: https://github.</description>
    </item>
    
    <item>
      <title>CloudFormationã§VPCã‚’ä½œæˆã—ã¦Lambdaã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—Aurora Serverlessã‚’ä½¿ã†</title>
      <link>https://www.sambaiz.net/article/206/</link>
      <pubDate>Sun, 03 Feb 2019 17:31:00 +0900</pubDate>
      
      <guid>https://www.sambaiz.net/article/206/</guid>
      <description>Aurora Serverlessã¯ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒ«ã™ã‚‹Auroraã§ã€ ä½¿ã£ãŸAurora Capacity Unit (ACU)ã«ã‚ˆã£ã¦æ–™é‡‘ãŒç™ºç”Ÿã™ã‚‹ãŸã‚ã€ ä½¿ç”¨é »åº¦ãŒå°‘ãªã‹ã£ãŸã‚Šå¤‰å‹•ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦å®‰ãRDBã‚’ä½¿ã†ã“ã¨ãŒã§ãã‚‹ã€‚ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç«‹ã¦ã‚‹ã¨æœ€ä½ã§ã‚‚æœˆ3000å††ãã‚‰ã„ã‹ã‹ã‚‹ãŒã€Serverlessã ã¨ã»ã¨ã‚“ã©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åˆ†ã‹ã‚‰é‹ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¦è¶£å‘³ã§ã‚‚ä½¿ã„ã‚„ã™ã„ã€‚ ãŸã ã—Lambdaã¨åŒæ§˜ã«å¸¸ã«åŒç­‰ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ã£ã¦ã„ã‚‹çŠ¶æ…‹ã ã¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨æ¯”ã¹ã¦å‰²é«˜ã«ãªã‚‹ã€‚
ä»Šå›ã¯Lambdaã§ä½¿ã†ã€‚ Serverlessã¨åå‰ã«ã¯ä»˜ã„ã¦ã„ã‚‹ãŒç”¨é€”ã¨ã—ã¦ã¯Lambdaã«é™ã‚‰ãšã€ ã‚€ã—ã‚ã‚³ãƒ³ãƒ†ãƒŠã®æ•°ãŒå®¹æ˜“ã«å¢—ãˆå¾—ã‚‹Lambdaã¯åŒæ™‚æ¥ç¶šæ•°ãŒå•é¡Œã«ãªã‚‹RDBã¨ä¸€èˆ¬ã«ç›¸æ€§ãŒè‰¯ããªã„ã€‚ ç¾åœ¨Betaã®ã€ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼µã‚‰ãšã«HTTPSã§ã‚¯ã‚¨ãƒªã‚’æŠ•ã’ã‚‰ã‚Œã‚‹Data APIã¯ã“ã®å•é¡Œã‚’è§£æ¶ˆã™ã‚‹ã¨æ€ã‚ã‚Œã‚‹ãŒã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒå¼µã‚Œãªã‹ã£ãŸã‚Šã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚µã‚¤ã‚ºã«åˆ¶é™ãŒã‚ã‚‹ã‚ˆã†ã ã€‚ä»Šå›ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã‹ã‚‰åˆæœŸã‚¯ã‚¨ãƒªã‚’æµã™ãŸã‚ã«Data APIã‚’æœ‰åŠ¹ã«ã—ã¦ã„ã‚‹ã€‚
ä»–ã®é¸æŠè‚¢ã¨ã—ã¦ã€DynamoDBã¯ç¾çŠ¶æœ€æœ‰åŠ›ã§æœ€è¿‘ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚‚ã‚µãƒãƒ¼ãƒˆã•ã‚ŒãŸãŒSQLã®ã‚ˆã†ã«è¤‡é›‘ãªã‚¯ã‚¨ãƒªã¯æŠ•ã’ã‚‰ã‚Œãªã„ã€‚ Athenaã¯ã‚¯ã‚¨ãƒªã¯æŠ•ã’ã‚‰ã‚Œã‚‹ãŒãã“ãã“æ™‚é–“ãŒã‹ã‹ã‚‹ã—ã€INSERT/UPDATEã¯ã§ããšã‚¯ã‚¨ãƒªã”ã¨ã«æ–™é‡‘ãŒç™ºç”Ÿã™ã‚‹ã€‚
Serverless Frameworkã‚’ä½¿ã£ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚ãƒªãƒã‚¸ãƒˆãƒªã¯ã“ã“ã€‚
Serverless Frameworkã§Lambdaã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ - sambaiz-net
VPCã®ä½œæˆ Aurora Serverlessã®åˆ¶é™ã®ä¸€ã¤ã¨ã—ã¦VPCå†…ã‹ã‚‰ã—ã‹æ¥ç¶šã—ã‹ã§ããªã„ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚‹ã€‚ã¨ã„ã†ã“ã¨ã§VPCã‹ã‚‰ä½œæˆã—ã¦ã„ãã€‚ä»¥å‰Terraformã§ä½œã£ãŸã®ã¨åŒã˜ãƒªã‚½ãƒ¼ã‚¹ã‚’CloudFormationã§ä½œã‚‹ã€‚
Terraformã§VPCã‚’ç®¡ç†ã™ã‚‹moduleã‚’ä½œã‚‹ - sambaiz-net
Lambdaã‚’VPCå†…ã§å‹•ã‹ã™ã¨ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«ENIã‚‚ä½œæˆã™ã‚‹ãŸã‚ç«‹ã¡ä¸ŠãŒã‚Šã®éš›æ™‚é–“ãŒã‹ã‹ã‚‹ã€‚å¿…è¦ãªã‚‰å®šæœŸçš„ã«å‘¼ã³å‡ºã—ã¦å‰Šé™¤ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ã€‚ ã¾ãŸã€ä»Šå›ã¯ãƒ†ã‚¹ãƒˆã®ãŸã‚/24ã§VPCã‚’åˆ‡ã£ã¦ã„ã‚‹ãŒã€å°ã•ã„ã¨ENIã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ¯æ¸‡ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
 VPC  TestVPC: Type: AWS::EC2::VPC Properties: CidrBlock: 172.32.0.0/24 Tags: - Key: Name Value: test-vpc   Subnet  Aurora Serverlessã®ãŸã‚ã«å°‘ãªãã¨ã‚‚2ã¤ã®ã‚µãƒ–ãƒãƒƒãƒˆãŒå¿…è¦ã€‚
TestPublicSubnet: Type: AWS::EC2::Subnet Properties: VpcId: !Ref TestVPC CidrBlock: 172.32.0.0/25 AvailabilityZone: us-east-1d Tags: - Key: Name Value: test-public-subnet1 TestPrivateSubnet1: Type: AWS::EC2::Subnet Properties: VpcId: !</description>
    </item>
    
    <item>
      <title>AWS Systems Manager (SSM)ã®Parameter Storeã«èªè¨¼æƒ…å ±ã‚’ç½®ãå‚ç…§ã™ã‚‹</title>
      <link>https://www.sambaiz.net/article/204/</link>
      <pubDate>Mon, 07 Jan 2019 23:50:00 +0900</pubDate>
      
      <guid>https://www.sambaiz.net/article/204/</guid>
      <description>DBã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„APIãƒˆãƒ¼ã‚¯ãƒ³ã¨ã„ã£ãŸèªè¨¼æƒ…å ±ã‚’ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚„è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¸Šã«æ›¸ãã¨OSSåŒ–ãªã©å…¬é–‹ç¯„å›²ã‚’åºƒã’ã‚‹ã¨ãã«ã‚„ã‚„å›°ã‚‹ã—æ¼ã‚Œã‚‹ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã‚‹ã®ã§ãªã‚‹ã¹ãé¿ã‘ãŸã„ã€‚ ãã“ã§SSMã®Parameter Storeã«å€¤ã‚’ç½®ãã€å®Ÿè¡Œæ™‚ã‚„ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«å‚ç…§ã™ã‚‹ã€‚
SSMã®Parameter Storeã¨Secrets Manager Systems Manager (SSM)ã¯AWSã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å¯è¦–åŒ–ã—ãŸã‚Šæ“ä½œã‚’è‡ªå‹•åŒ–ã—ãŸã‚Šã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ç¾¤ã§ã€ è¨­å®šã‚’æŒã¤Parameter Storeã¯ãã®ä¸€ã¤ã€‚å€¤ã¯æš—å·åŒ–ã—ã¦æŒã¤ã“ã¨ã‚‚ã§ãã‚‹ã€‚ æ–™é‡‘ã¯ã‹ã‹ã‚‰ãªã„ã€‚
SSMã®Parameter Storeã¨ä¼¼ãŸã‚ˆã†ãªåˆ¥ã®AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã« Secrets Managerã¨ã„ã†ã®ãŒã‚ã£ã¦ã€RDSãªã©ã¨é€£æºã—ã¦Lambdaã«ã‚ˆã£ã¦å®šæœŸçš„ã«æ–°ã—ã„å€¤ã‚’ç”Ÿæˆã—ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ ãŸã ã—æ–™é‡‘ãŒã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ä»¶æ•°($0.4/æœˆ)ã¨APIã‚³ãƒ¼ãƒ«($0.05/10000å›)ã§ã‹ã‹ã‚‹ã€‚
CloudFormationã§VPCã‚’ä½œæˆã—ã¦Lambdaã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—Aurora Serverlessã‚’ä½¿ã† - sambaiz-net
ä»Šã¯Paramter Storeã¨Secrets ManagerãŒçµ±åˆã•ã‚Œã¦ã„ã¦ã€Parameter Storeã®APIã§ã©ã¡ã‚‰ã‚‚å‚ç…§ã§ãã‚‹ã‚ˆã†ã ã€‚ ä»Šå›ã¯ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã—ãªã„ã®ã§å˜ç´”ã«æ–™é‡‘ãŒã‹ã‹ã‚‰ãªã„Parameter Storeã®æ–¹ã«æ›¸ãè¾¼ã‚€ã“ã¨ã«ã™ã‚‹ã€‚ ãŸã ã—ã€Parameter Storeã¯ç¾çŠ¶ä¸€åº¦ã«å¤§é‡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã¶ã‚ˆã†ãªä½¿ã„æ–¹ã‚’ã™ã‚‹ã¨Rate exceededã«ãªã£ã¦ã—ã¾ã†å•é¡ŒãŒã‚ã‚‹ã€‚
å®Ÿè¡Œæ™‚ã®å€¤å–å¾— å®Ÿè¡Œæ™‚ã«å€¤ã‚’å–å¾—ã™ã‚‹ã®ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚
package main import ( &amp;quot;fmt&amp;quot; &amp;quot;github.com/aws/aws-sdk-go/aws&amp;quot; &amp;quot;github.com/aws/aws-sdk-go/aws/awserr&amp;quot; &amp;quot;github.com/aws/aws-sdk-go/aws/session&amp;quot; &amp;quot;github.com/aws/aws-sdk-go/service/ssm&amp;quot; ) type Parameter struct { ssm *ssm.SSM } func newParameter(sess *session.Session) *Parameter { return &amp;amp;Parameter{ ssm: ssm.New(sess), } } func (s *Parameter) Get(name string, decrypt bool) (string, error) { param, err := s.</description>
    </item>
    
    <item>
      <title>Serverless Frameworkã§Lambdaã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹</title>
      <link>https://www.sambaiz.net/article/155/</link>
      <pubDate>Sun, 11 Feb 2018 23:20:00 +0900</pubDate>
      
      <guid>https://www.sambaiz.net/article/155/</guid>
      <description>Serverless Frameworkã§Lambda Functionã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚ ApexãŒåŸºæœ¬çš„ã«Functionè‡ªä½“ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã‹ã—ãªã„ã®ã«å¯¾ã—ã¦ã€ã“ã¡ã‚‰ã¯eventã®è¨­å®šãªã©ã‚‚è«¸ã€…ã‚„ã£ã¦ãã‚Œã¦å¼·ã„ã€‚
Apexã§Lambdaã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ - sambaiz-net
$ npm install -g serverless $ serverless version 1.26.0  Apexã§ã¯Functionã”ã¨ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œã‚‰ã‚ŒãŸãŒã€Serverlessã§ã¯Serviceã”ã¨ã«ä½œã‚‰ã‚Œã€ ä¸€ã¤ã®Serviceå†…ã§è¤‡æ•°ã®Functionã‚’å®šç¾©ã§ãã‚‹ã€‚handlerã¯åŒã˜ã§ã‚‚ç•°ãªã£ã¦ã„ã¦ã‚‚ã‚ˆã„ã€‚
Apexã®å½¢å¼ã®å ´åˆã€å…±é€šã®å‡¦ç†ã‚’Webpackãªã©ã§å„Functionã«æŒã£ã¦æ¥ãŸã‚Šã€ åŒã˜ã‚ˆã†ãªå‡¦ç†ã®è¤‡æ•°ã®Functionã‚’ç«‹ã¦ã‚‹éš›ã¯ã‚³ãƒ”ãƒ¼ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸãŒã€ ã“ã¡ã‚‰ã¯å¿…è¦æœ€å°é™ã®å¤‰æ›´ã§ãã‚Œã‚‰ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã€‚
templateã‹ã‚‰Serviceã‚’createã™ã‚‹ã€‚
$ serverless create --template aws-nodejs --path testservice $ ls testservice/ handler.js	serverless.yml  è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«serverless.yml ã«ã¯Lambdaã®åŸºæœ¬çš„ãªã‚‚ã®ã®ã»ã‹ã«ã€VPCã‚„eventã€IAM Roleãªã©ã‚‚æ›¸ã‘ã¦ã€ã“ã‚Œã‚‰ã¯deployæ™‚ã«ä½œã‚‰ã‚Œã‚‹CloudFormationã®stackã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã‚‹ã€‚å¿…è¦ãªã‚‰ç”Ÿã®CloudFormationã®è¨­å®šã‚‚æ›¸ã‘ã‚‹ã€‚
Apexã§ã‚‚Terraformã«ã‚ˆã£ã¦ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãŒã€æ›¸ãã®ã¯ã“ã¡ã‚‰ã®æ–¹ãŒã¯ã‚‹ã‹ã«æ¥½ã€‚
Apexã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸLambdaã®ãƒˆãƒªã‚¬ãƒ¼ã‚’Terraformã§ç®¡ç†ã™ã‚‹ - sambaiz-net
$ cat sesrverless.yml service: testservice provider: name: aws profile: foobar region: ap-northeast-1 runtime: nodejs6.10 memorySize: 512 timeout: 10 functions: hello: handler: handler.hello events: - http: path: hello/world method: get cors: true  deployã™ã‚‹ã¨{service}-{stage}-{function}ã®FunctionãŒä½œã‚‰ã‚Œã‚‹ã€‚ ä»Šå›ã®å ´åˆã¯testservice-prd-testã€‚stageã‚’ymlã§ã‚‚æŒ‡å®šã—ãªã‹ã£ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®devã«ãªã‚‹ã€‚</description>
    </item>
    
    <item>
      <title>Datadogã®Lambda Integrationã§æ°—è±¡ãƒ‡ãƒ¼ã‚¿ã‚’é€ã£ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã‚’é£›ã°ã™</title>
      <link>https://www.sambaiz.net/article/152/</link>
      <pubDate>Mon, 05 Feb 2018 23:55:00 +0900</pubDate>
      
      <guid>https://www.sambaiz.net/article/152/</guid>
      <description>æœ€è¿‘æœãŒå¯’ãã¦å¸ƒå›£ã‹ã‚‰å‡ºã‚‹ã®ãŒã¤ã‚‰ã„ã€‚é›¨ã‚„é›ªãŒé™ã£ã¦ã„ãŸã‚‰å°šæ›´ã®ã“ã¨ã€ãã‚Œãªã‚‰ãã‚Œã§ç¾çŠ¶ã‚’æŠŠæ¡ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ ãã“ã§ã€ç„¡æ–™ã‹ã‚‰ä½¿ãˆã‚‹æ°—è±¡API OpenWeatherMapã®ãƒ‡ãƒ¼ã‚¿ã‚’datadogã«é€ã£ã¦ã€ç‰¹ã«å¯’ã„æ—¥ã‚„é›¨é›ªãŒé™ã‚‹ã‚ˆã†ãªæœã«ã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’é£›ã°ã™ã“ã¨ã«ã—ãŸã€‚
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç«‹ã£ã¦ã„ãŸã‚‰DataDog Agentã®DogStatsDçµŒç”±ã§é€ã‚‹ã“ã¨ãŒã§ãã€ ãã†ã§ãªã‘ã‚Œã°é€šå¸¸ã¯APIã‚’å‘¼ã¶ã“ã¨ã«ãªã‚‹ã‚“ã ã‘ã©ã€Lambdaã§ã¯ã€AWS Integrationã‚’è¨­å®šã™ã‚‹ã¨æœ‰åŠ¹ã«ãªã‚‹Lambda Integrationã«ã‚ˆã£ã¦ MONITORING|unix_epoch_timestamp|value|metric_type|my.metric.name|#tag1:value,tag2ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§console.logã™ã‚‹ã ã‘ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒé€ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
const axios = require(&#39;axios&#39;); const CITY = &#39;Shibuya&#39;; const API_KEY = &#39;*****&#39;; const WEATHER_API = `http://api.openweathermap.org/data/2.5/weather?q=${CITY}&amp;amp;units=metric&amp;amp;appid=${API_KEY}`; const METRIC_COUNTER = &#39;counter&#39;; const METRIC_GAUGE = &#39;gauge&#39;; const monitor = (metricName, metricType, value, tags) =&amp;gt; { const unixEpochTimestamp = Math.floor(new Date().getTime()); console.log(`MONITORING|${unixEpochTimestamp}|${value}|${metricType}|${metricName}|#${tags.join(&#39;,&#39;)}`); }; exports.handler = async (event, context, callback) =&amp;gt; { const data = (await axios.get(WEATHER_API)).data const namePrefix = &#39;livinginfo.weather&#39; monitor(`${namePrefix}.temperature`, METRIC_GAUGE, data.main.temp, []) monitor(`${namePrefix}.</description>
    </item>
    
    <item>
      <title>Apexã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸLambdaã®ãƒˆãƒªã‚¬ãƒ¼ã‚’Terraformã§ç®¡ç†ã™ã‚‹</title>
      <link>https://www.sambaiz.net/article/144/</link>
      <pubDate>Sun, 12 Nov 2017 22:23:00 +0900</pubDate>
      
      <guid>https://www.sambaiz.net/article/144/</guid>
      <description>Apexã§functionã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ãƒˆãƒªã‚¬ãƒ¼ãŒç™»éŒ²ã•ã‚Œãªã„ã®ã§ã‚ã¨ã§è¿½åŠ ã™ã‚‹ã“ã¨ã«ãªã‚‹ã€‚ ã“ã‚Œã‚’æ‰‹ä½œæ¥­ã§è¡Œã†ã“ã¨ã‚‚ã§ãã‚‹ã®ã ã‘ã©ã€ã›ã£ã‹ããªã®ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ä¸€ç·’ã«ç®¡ç†ã—ãŸã„ã€‚ ãã‚“ãªã¨ãã®ãŸã‚ã«terraformã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ©ãƒƒãƒ—ã—ãŸapex infraãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã€‚
Terraformã§VPCã‚’ç®¡ç†ã™ã‚‹moduleã‚’ä½œã‚‹ - sambaiz-net
functionsã¨åŒåˆ—ã«infrastructureãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦tfãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãã€‚ ãã®ä¸‹ã«ç’°å¢ƒã”ã¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¦ã€ãã®å ´åˆã¯--envã§æŒ‡å®šã—ãŸç’°å¢ƒã®ã‚‚ã®ãŒä½¿ã‚ã‚Œã‚‹ã€‚
- functions - infrastructure main.tf variables.tf - modules - cloudwatch_schedule main.tf variables.tf project.json  functionã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ãã®ARNãŒå¤‰æ•°ã§å–ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
$ apex list --tfvars apex_function_hello=&amp;quot;arn:aws:lambda:ap-northeast-1:*****:function:usetf_hello&amp;quot;  ä»Šå›è¨­å®šã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã¯Cloudwatch Eventã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã€‚ä½œæˆã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚
 aws_cloudwatch_event_ruleã§ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ«(ä»Šå›ã¯schedule)ã‚’ä½œæˆ aws_cloudwatch_event_targetã§ãƒ«ãƒ¼ãƒ«ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ(ä»Šå›ã¯Lambda)ã‚’è¨­å®š aws_lambda_permissionã§ãƒ«ãƒ¼ãƒ«ã«å¯¾è±¡Lambdaã‚’invokeã™ã‚‹æ¨©é™ã‚’ä»˜ã‘ã‚‹  $ cat infrastructure/modules/cloudwatch_schefule/variables.tf variable &amp;quot;lambda_function_name&amp;quot; {} variable &amp;quot;lambda_function_arn&amp;quot; {} variable &amp;quot;schedule_expression&amp;quot; { description = &amp;quot;cloudwatch schedule expression e.g. \&amp;quot;cron(0/5 * * * ? *)\&amp;quot;&amp;quot; } $ cat infrastructure/modules/cloudwatch_schefule/main.tf resource &amp;quot;aws_cloudwatch_event_rule&amp;quot; &amp;quot;lambda&amp;quot; { name = &amp;quot;lambda_rule_${var.</description>
    </item>
    
    <item>
      <title>Apexã§Lambdaã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹</title>
      <link>https://www.sambaiz.net/article/140/</link>
      <pubDate>Sun, 22 Oct 2017 16:06:00 +0900</pubDate>
      
      <guid>https://www.sambaiz.net/article/140/</guid>
      <description>Apexã§Lambdaã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚ ã¨ã¦ã‚‚ç°¡å˜ã«ä½¿ãˆã‚‹ã—ã€å¤‰ãªã“ã¨ã‚‚ã—ãªã„ã®ã§è‰¯ã„æ„Ÿã˜ã€‚
Serverless Frameworkã ã¨eventã®è¨­å®šã¾ã§ã‚«ãƒãƒ¼ã§ãã¦ã‚ˆã‚Šä¾¿åˆ©ã€‚
Serverless Frameworkã§Lambdaã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ - sambaiz-net
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚
$ curl https://raw.githubusercontent.com/apex/apex/master/install.sh | sh   IAMFullAccess AWSLambdaFullAccess  ã‚’ä»˜ã‘ãŸIAMã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™»éŒ²ã—ã¦ãŠãã€‚
$ aws configure --profile apex $ aws configure list --profile apex Name Value Type Location ---- ----- ---- -------- profile apex manual --profile access_key ****************OVGQ shared-credentials-file secret_key ****************oi5t shared-credentials-file region ap-northeast-1 config-file ~/.aws/config  apex initã—ã¦nameã¨descriptionã‚’å…¥ã‚Œã‚‹ã¨IAMãŒç™»éŒ²ã•ã‚Œã€ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ãŒä½œã‚‰ã‚Œã‚‹ã€‚
$ apex init --profile apex Project name: try-apex Project description: test [+] creating IAM try-apex_lambda_function role [+] creating IAM try-apex_lambda_logs policy [+] attaching policy to lambda_function role.</description>
    </item>
    
    <item>
      <title>Lambdaä¸Šã§Puppeteer/Headless Chromeã‚’å‹•ã‹ã™Starter Kitã‚’ä½œã£ãŸ</title>
      <link>https://www.sambaiz.net/article/132/</link>
      <pubDate>Sun, 10 Sep 2017 23:45:00 +0900</pubDate>
      
      <guid>https://www.sambaiz.net/article/132/</guid>
      <description>Puppeteerã§Headless Chromeã‚’å‹•ã‹ã™ã‚³ãƒ¼ãƒ‰ã‚’ Lambdaä¸Šã§å‹•ã‹ã™Starter Kitã‚’ä½œã£ãŸã€‚
puppeteer-lambda-starter-kit
Chromeã®æº–å‚™ Puppeteerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã«è½ã¨ã—ã¦ãã‚‹Chromeã‚’Lambdaä¸Šã§å‹•ã‹ãã†ã¨ã—ã¦ã‚‚ Lambdaã«ãªã„shared libraryã«ä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚å¤±æ•—ã™ã‚‹ã€‚
error while loading shared libraries: libpangocairo-1.0.so.0: cannot open shared object file: No such file or directory  Lambdaä¸Šã§Headless Chromeã‚’å‹•ã‹ã™ä¾‹ãŒãªã„ã‹èª¿ã¹ãŸã‚‰serverless-chromeã¨ã„ã†ã®ãŒã‚ã£ã¦ã€ Headlessç”¨ã®è¨­å®šã§Chromeã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã„ãŸã€‚ ã»ã‹ã«ã¯chromelessã¨ã„ã†ã®ã‚‚ã‚ã‚‹ã‘ã© ã“ã‚Œã¯serverless-chromeã« ä¾å­˜ã—ã¦ã„ã‚‹ã€‚ æœ€å°æ§‹æˆã§Puppeteerã‚’ä½¿ã„ãŸã‹ã£ãŸã®ã§ã€ä»Šå›ã¯ã“ã‚Œã‚‰ã‚’ä½¿ã‚ãšä¸€ã‹ã‚‰ä½œã‚‹ã“ã¨ã«ã—ãŸã€‚
serverless-chromeã«ã‚‚ãƒ“ãƒ«ãƒ‰ã—ãŸã‚‚ã®ãŒç½®ã„ã¦ã‚ã‚‹ãŒã€å°‘ã—ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤ã„ã‚ˆã†ã ã£ãŸã®ã§æœ€æ–°ç‰ˆã§ãƒ“ãƒ«ãƒ‰ã—ãŸã€‚ åŸºæœ¬çš„ã«ã¯æ›¸ã„ã¦ã‚ã‚‹ é€šã‚Šã‚„ã‚Œã°ã†ã¾ãã„ãã€‚ä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ã¨ã®shared memoryã¨ã—ã¦/dev/shmã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã‚’ã€/tmpã«ç½®ãæ›ãˆã‚‹ ã‚ˆã†ã«ã—ãªã„ã¨ã€å®Ÿè¡Œæ™‚ã®page.goto()ã§Failed Provisional Load: ***, error_code: -12ã«ãªã‚‹ã€‚
ãƒ“ãƒ«ãƒ‰ã—ãŸheadless_shellã«ã¯å•é¡Œã«ãªã£ãŸä¾å­˜ã¯å«ã¾ã‚Œã¦ã„ãªã„ã‚ˆã†ã ã€‚
$ ldd headless_shell linux-vdso.so.1 =&amp;gt; (0x00007ffcb6fed000) libpthread.so.0 =&amp;gt; /lib64/libpthread.so.0 (0x00007f5f17dbe000) libdl.so.2 =&amp;gt; /lib64/libdl.so.2 (0x00007f5f17bba000) librt.so.1 =&amp;gt; /lib64/librt.so.1 (0x00007f5f179b1000) libnss3.so =&amp;gt; /usr/lib64/libnss3.so (0x00007f5f17692000) libnssutil3.so =&amp;gt; /usr/lib64/libnssutil3.so (0x00007f5f17466000) libsmime3.</description>
    </item>
    
    <item>
      <title>Node.jsã§ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›</title>
      <link>https://www.sambaiz.net/article/89/</link>
      <pubDate>Tue, 28 Mar 2017 21:36:00 +0900</pubDate>
      
      <guid>https://www.sambaiz.net/article/89/</guid>
      <description>node-iconvã‚’ä½¿ã†ã€‚
$ npm install iconv  SHIFT_JISã‹ã‚‰UTF-8ã¸ã®å¤‰æ›ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚
const Iconv = require(&#39;iconv&#39;).Iconv; const before = new Buffer([ 0x8b, 0x8d, 0x8e, 0x4d, 0x26, 0x82, 0xb2, 0x94, 0xd1 ]); const iconv = new Iconv(&#39;SHIFT_JIS&#39;, &#39;UTF-8&#39;); console.log(`before: ${before.toString(&#39;hex&#39;)} ${before.toString()}`) const after = iconv.convert(before); console.log(`after: ${after.toString(&#39;hex&#39;)} ${after.toString()}`);  before: 8b8d8e4d2682b294d1 ï¿½ï¿½ï¿½M&amp;amp;ï¿½ï¿½ï¿½ï¿½ after: e7899be79abf26e38194e9a3af ç‰›çš¿&amp;amp;ã”é£¯  æ–‡å­—ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦ã¯å¤‰æ›å¾Œã«è¡¨ã›ãªã„ã“ã¨ãŒã‚ã‚‹ã€‚ ä¾‹ãˆã°ã€UTF-8ã‹ã‚‰SHIFT_JISã¸ã®å¤‰æ›ã§ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ğŸšã‚’æ¸¡ã™ã¨å¤‰æ›ã§ããšã€ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚
throw errnoException(&#39;EILSEQ&#39;, &#39;Illegal character sequence.&#39;);  //IGNOREã‚’ä»˜ã‘ã‚‹ã“ã¨ã§ ãã®ã‚ˆã†ãªæ–‡å­—ãŒã‚ã£ãŸå ´åˆã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ã—ãªã„ã‚ˆã†ã«ã§ãã‚‹ã€‚
const Iconv = require(&#39;iconv&#39;).Iconv; const before = &amp;quot;ç‰›çš¿&amp;amp;ğŸš&amp;quot;; const iconv = new Iconv(&#39;UTF-8&#39;, &#39;SHIFT_JIS//IGNORE&#39;); console.</description>
    </item>
    
    <item>
      <title>fluentdã§Kinesis Streamsã«é€ã£ã¦Lambdaã§èª­ã‚“ã§S3ã«ä¿å­˜ã™ã‚‹</title>
      <link>https://www.sambaiz.net/article/73/</link>
      <pubDate>Sun, 26 Feb 2017 18:56:00 +0900</pubDate>
      
      <guid>https://www.sambaiz.net/article/73/</guid>
      <description>aws-fluent-plugin-kinesisã§Kinesis Streamsã«é€ã‚Šã€Lambdaã§èª­ã‚“ã§S3ã«ä¿å­˜ã™ã‚‹ã€‚ è¦ã™ã‚‹ã«Firehoseã®ã‚ˆã†ãªã“ã¨ã‚’ã‚„ã‚ŠãŸã„ã®ã ã‘ã‚Œã©Tokyoãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ã¾ã æ¥ãªã„ã®ã§è‡ªåˆ†ã§ã‚„ã‚‹ã€‚
fluentdã§é€ã‚‹ $ td-agent-gem install fluent-plugin-kinesis  try_flush_intervalã¨queued_chunk_flush_intervalã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯è¼‰ã£ã¦ã„ãªã„ãŒã€ ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã«ã‚ˆã‚‹ã¨ãã‚Œãã‚Œqueueã«æ¬¡ã®chunkãŒãªã„ã¨ãã¨ã‚ã‚‹ã¨ãã®flushã™ã‚‹é–“éš”ã€‚ ã„ãšã‚Œã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯1ã ãŒã€ã“ã‚Œã‚’æ¸›ã‚‰ã™ã“ã¨ã§ã‚‚ã£ã¨é »ç¹ã«åãå‡ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã‚‰ã—ã„ã€‚
Fluentd ã® out_forward ã¨ BufferedOutput
ã‚ã¨ã‚·ãƒ£ãƒ¼ãƒ‰ã«æŒ¯ã‚Šåˆ†ã‘ã‚‹ãŸã‚ã®partition_key ã‚’æŒ‡å®šã§ãã‚‹ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ©ãƒ³ãƒ€ãƒ ã€‚
&amp;lt;source&amp;gt; @type tail path /var/log/td-agent/hoge.log pos_file /etc/td-agent/log.pos tag hoge.log format json time_key timestamp # 2017-01-01T01:01:01+0900 time_format %Y-%m-%dT%H:%M:%S%z &amp;lt;/source&amp;gt; &amp;lt;match hoge.log&amp;gt; @type kinesis_streams region ap-northeast-1 stream_name teststream include_time_key true flush_interval 1 buffer_chunk_limit 1m try_flush_interval 0.1 queued_chunk_flush_interval 0.01 num_threads 15 &amp;lt;/match&amp;gt;  ã„ãã¤ã‹é€ã£ã¦ã¿ã‚‹ã€‚
for i in `seq 1 1000` do echo &#39;{&amp;quot;hoge&amp;quot;: &amp;quot;fuga&amp;quot;, &amp;quot;timestamp&amp;quot;: &amp;quot;2017-01-01T01:01:01+0900&amp;quot;}&#39; &amp;gt;&amp;gt; /var/log/td-agent/hoge.</description>
    </item>
    
  </channel>
</rss>