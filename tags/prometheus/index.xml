<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Prometheus on sambaiz-net</title>
    <link>https://www.sambaiz.net/tags/prometheus/</link>
    <description>Recent content in Prometheus on sambaiz-net</description>
    <generator>Hugo</generator>
    <language>ja</language>
    <copyright>sambaiz-net</copyright>
    <lastBuildDate>Mon, 09 Feb 2026 08:00:00 +0900</lastBuildDate>
    <atom:link href="https://www.sambaiz.net/tags/prometheus/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>celery-exporter で Celery のメトリクスを Prometheus 形式で公開する</title>
      <link>https://www.sambaiz.net/article/560/</link>
      <pubDate>Mon, 09 Feb 2026 08:00:00 +0900</pubDate>
      <guid>https://www.sambaiz.net/article/560/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://github.com/celery/celery&#34;&gt;Celery&lt;/a&gt; は Python の分散タスクキュー。Worker が Redis などの Broker からタスクを取り出して実行する。&lt;a href=&#34;https://github.com/danihodovic/celery-exporter&#34;&gt;celery-exporter&lt;/a&gt; を使うと Celery の&lt;a href=&#34;https://docs.celeryproject.org/en/latest/userguide/monitoring.html#real-time-processing&#34;&gt;イベント&lt;/a&gt;からタスクの実行状況を集計して Prometheus 形式で取得できる。&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff79c6&#34;&gt;import&lt;/span&gt; os&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff79c6&#34;&gt;from&lt;/span&gt; celery &lt;span style=&#34;color:#ff79c6&#34;&gt;import&lt;/span&gt; Celery&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;app &lt;span style=&#34;color:#ff79c6&#34;&gt;=&lt;/span&gt; Celery(&lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#39;tasks&amp;#39;&lt;/span&gt;, broker&lt;span style=&#34;color:#ff79c6&#34;&gt;=&lt;/span&gt;os&lt;span style=&#34;color:#ff79c6&#34;&gt;.&lt;/span&gt;environ&lt;span style=&#34;color:#ff79c6&#34;&gt;.&lt;/span&gt;get(&lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#39;CELERY_BROKER_URL&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#39;redis://localhost:6379/0&amp;#39;&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;app&lt;span style=&#34;color:#ff79c6&#34;&gt;.&lt;/span&gt;conf&lt;span style=&#34;color:#ff79c6&#34;&gt;.&lt;/span&gt;update(&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    worker_send_task_events&lt;span style=&#34;color:#ff79c6&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ff79c6&#34;&gt;True&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    task_send_sent_event&lt;span style=&#34;color:#ff79c6&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ff79c6&#34;&gt;True&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;@app.task&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff79c6&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#50fa7b&#34;&gt;add&lt;/span&gt;(x, y):&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ff79c6&#34;&gt;return&lt;/span&gt; x &lt;span style=&#34;color:#ff79c6&#34;&gt;+&lt;/span&gt; y&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Redis、Celery Worker、celery-exporter を起動する。&lt;/p&gt;</description>
    </item>
    <item>
      <title>Kubecost の Prometheus メトリクスから Pod のラベルごとのコストを算出する</title>
      <link>https://www.sambaiz.net/article/493/</link>
      <pubDate>Wed, 17 Jul 2024 19:59:00 +0900</pubDate>
      <guid>https://www.sambaiz.net/article/493/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://www.kubecost.com/&#34;&gt;Kubecost&lt;/a&gt; は Kubernetes のコストを可視化し最適化するツール。&#xA;AWS が &lt;a href=&#34;https://docs.aws.amazon.com/eks/latest/userguide/cost-monitoring.html&#34;&gt;EKS optimized bundle&lt;/a&gt; を提供しており一部 Enterprise 相当の機能を使うことができる。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;div class=&#34;img_container&#34;&gt;&lt;a href=&#34;https://www.sambaiz.net/article/493/images/eksoptimized.png&#34;&gt;&#xA;    &lt;img style=&#34;max-width: 100%; width: auto; height: auto;&#34; src=&#34;https://www.sambaiz.net/article/493/images/eksoptimized_hu_1baae43af30b2422.png&#34; width=&#34;600&#34; height=&#34;184&#34; alt=&#34;EKS Optimized license&#34;&gt;&#xA;&lt;/a&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Helm でインストールする。Promehteus はデフォルトでインストールされるが、すでにあるものを用いることもできる。&lt;/p&gt;</description>
    </item>
    <item>
      <title>PromQLでメトリクスを取得・集計する</title>
      <link>https://www.sambaiz.net/article/491/</link>
      <pubDate>Sun, 09 Jun 2024 17:55:00 +0900</pubDate>
      <guid>https://www.sambaiz.net/article/491/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://prometheus.io/docs/prometheus/2.53/querying/basics/&#34;&gt;PromQL&lt;/a&gt; は Prometheus で実行できるクエリ言語で、次のようにしてメトリクスの単一時間のサンプルを &lt;a href=&#34;https://prometheus.io/docs/prometheus/2.53/querying/basics/#instant-vector-selectors&#34;&gt;Instant vector&lt;/a&gt; として取得したり、大括弧で期間を指定することでその期間の全てのサンプルを &lt;a href=&#34;https://prometheus.io/docs/prometheus/2.53/querying/basics/#range-vector-selectors&#34;&gt;Range vector&lt;/a&gt; として取得できる。&lt;/p&gt;</description>
    </item>
    <item>
      <title>KEDA (Kubernetes Event-driven Autoscaling) で Prometheus のメトリクスや時間ベースのスケーリングを行う</title>
      <link>https://www.sambaiz.net/article/490/</link>
      <pubDate>Wed, 05 Jun 2024 23:08:00 +0900</pubDate>
      <guid>https://www.sambaiz.net/article/490/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://keda.sh/docs/2.14/concepts/&#34;&gt;KEDA&lt;/a&gt; は Kubernetes でイベントドリブンなスケーリングを行えるようにするコンポーネントで、HorizontalPodAutoscaler とともにはたらく。CPU のほか Prometheus や Cron など様々なイベントソースの &lt;a href=&#34;https://keda.sh/docs/2.14/scalers/&#34;&gt;Scaler&lt;/a&gt; が提供されており、それをもとに HPA で replicas を増減させたり、0 ↔ 1 の変更を行ったりもできる。&lt;/p&gt;</description>
    </item>
    <item>
      <title>Prometheus を CDK でインストールして Recording rules で集計したデータを New Relic に Remote write することでデータ量を節約する</title>
      <link>https://www.sambaiz.net/article/487/</link>
      <pubDate>Thu, 23 May 2024 02:22:00 +0900</pubDate>
      <guid>https://www.sambaiz.net/article/487/</guid>
      <description>&lt;p&gt;Prometheus の &lt;a href=&#34;https://prometheus.io/docs/prometheus/2.52/configuration/recording_rules/&#34;&gt;Recording rules&lt;/a&gt; は PromQL で既存のメトリクスから新たなメトリクスを作ることができる機能。これによって集計したデータを送ることで生のデータを送るのと比べて New Relic へのデータ送信量を節約することができるが、newrelic-bundle に含まれる newrelic-prometheus-configurator の Prometheus は Agent mode で動くので Recording rules に&lt;a href=&#34;https://github.com/prometheus/prometheus/blob/v2.52.0/config/config.go#L124&#34;&gt;対応していない&lt;/a&gt;。&lt;/p&gt;</description>
    </item>
    <item>
      <title>CDKでEKSクラスタにnewrelic-bundleをインストールしてモニタリングする</title>
      <link>https://www.sambaiz.net/article/466/</link>
      <pubDate>Sat, 13 Jan 2024 21:07:00 +0900</pubDate>
      <guid>https://www.sambaiz.net/article/466/</guid>
      <description>&lt;p&gt;NewRelic の &lt;a href=&#34;https://docs.newrelic.com/docs/kubernetes-pixie/kubernetes-integration/installation/kubernetes-integration-install-configure/&#34;&gt;Kubernetes Integration&lt;/a&gt; の各種コンポーネントをまとめた&#xA;&lt;a href=&#34;https://github.com/newrelic/helm-charts/tree/master/charts/nri-bundle&#34;&gt;nri-bundle&lt;/a&gt; という Helm Chart が提供されており、Guided install を進めると渡すパラメータが生成されるのでこれを CDK に書き写した。&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;div class=&#34;img_container&#34;&gt;&lt;a href=&#34;https://www.sambaiz.net/article/466/images/guided_install.png&#34;&gt;&#xA;    &lt;img style=&#34;max-width: 100%; width: auto; height: auto;&#34; src=&#34;https://www.sambaiz.net/article/466/images/guided_install_hu_4854bf03e712c04a.png&#34; width=&#34;600&#34; height=&#34;228&#34; alt=&#34;Guided install&#34;&gt;&#xA;&lt;/a&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Chart を見ると認証情報はそのまま文字列で渡すほか Secret を指定することもできたので、External Secrets で SecretsManager から取り込む。&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
