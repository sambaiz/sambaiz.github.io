<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>TensorFlowのRNN(LSTM)のチュートリアルのコードを読む - sambaiz-net</title>
  <meta name="twitter:title" content="TensorFlowのRNN(LSTM)のチュートリアルのコードを読む - sambaiz-net">
  <meta property='og:title' content="TensorFlowのRNN(LSTM)のチュートリアルのコードを読む - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="RNN">
  <meta name="twitter:description" content="RNN">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/article/146/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "TensorFlowのRNN(LSTM)のチュートリアルのコードを読む",
    "datePublished": "2018-01-03T21:12:00JST",
    "dateModified": "2018-01-03T21:12:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "RNN"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>TensorFlowのRNN(LSTM)のチュートリアルのコードを読む</h1>
        <time>2018-01-03</time>
        <a class="tag" href='/tags/tensorflow/'>tensorflow</a><a class="tag" href='/tags/machinelearning/'>machinelearning</a>
      </div>
      <p>TensorflowのRNN(Recurrent Neural Networks)の<a href="https://www.tensorflow.org/tutorials/recurrent">チュートリアル</a>の<a href="https://github.com/tensorflow/models/blob/12f279d6f4cb33574bc20109b41eb8a59f40cfd1/tutorials/rnn/ptb/ptb_word_lm.py">コード</a>を読む。これは文章のそれまでの単語の履歴から、その次に続く単語を予測することで言語モデルを作るもの。</p>
<h2 id="rnnlstmとは">RNN/LSTMとは</h2>
<p>RNNは入力に対して出力のほかに情報を次のステップに渡すことで時系列データで学習できるようにするネットワーク。
展開すると同じネットワークに単語を一つずつ入れていくように表現できる。</p>
<p><img src="https://www.sambaiz.net/images/146-rnn.png" alt="RNN"></p>
<p>これを単純にMLPで実装しようとすると逆誤差伝搬する際に過去の層にも伝搬させる(BPTT: Backpropagation through time)必要があり、
時間を遡るほど活性化関数の微分係数が再帰的に繰り返し掛けられるため勾配が消失や爆発しやすくなってしまう。
また、時系列データのうちに発火したいものと発火したくないものが混在している場合、同じ重みにつながっているため更新を打ち消しあってしまう入力/出力重み衝突という問題もある。</p>
<p>これらを解決するのがLSTM(Long Short Term Memory networks)で、
勾配消失は活性化関数がxで重みが単位行列のニューロンの <strong>CEC(Constant Error Carousel)</strong> によって常に誤差に掛けられる係数を1にすることで防ぎ、
入力/出力重み衝突は必要な入出力を通したり不必要な情報は忘れさせるために値域(0,1)の値を掛ける <strong>input gate</strong>、<strong>forget gate</strong>、<strong>output gate</strong> によって回避する。gateは入力と前回の出力によって制御される。</p>
<p><img src="https://www.sambaiz.net/images/146-lstm.png" alt="RNN"></p>
<p>TensorflowではいくつかLSTMの実装が用意されていて、 CudnnLSTM や BasicLSTMCell、LSTMBlockCell などがある。
<a href="https://developer.nvidia.com/cudnn">cuDNN</a>というのはNVIDIAのCUDAのDNNライブラリのこと。
LSTMBlockCell はもう少し複雑なLSTMで BasicLSTMCell よりも速い。</p>
<h2 id="動かしてみる">動かしてみる</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ git clone https://github.com/tensorflow/models.git
</span></span><span style="display:flex;"><span>$ cd models/tutorials/rnn/ptb/
</span></span><span style="display:flex;"><span>$ wget http://www.fit.vutbr.cz/~imikolov/rnnlm/simple-examples.tgz
</span></span><span style="display:flex;"><span>$ tar xvf simple-examples.tgz 
</span></span><span style="display:flex;"><span>$ python3 -m venv env
</span></span><span style="display:flex;"><span>$ . ./env/bin/activate
</span></span><span style="display:flex;"><span>$ pip install numpy tensorflow
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ python ptb_word_lm.py --data_path=simple-examples/data/ --num_gpus=0
</span></span><span style="display:flex;"><span>Epoch: 1 Learning rate: 1.000
</span></span><span style="display:flex;"><span>0.004 perplexity: 5534.452 speed: 894 wps
</span></span><span style="display:flex;"><span>0.104 perplexity: 845.383 speed: 1277 wps
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>0.803 perplexity: 316.808 speed: 1195 wps
</span></span><span style="display:flex;"><span>0.903 perplexity: 298.087 speed: 1205 wps
</span></span><span style="display:flex;"><span>Epoch: 1 Train Perplexity: 283.825
</span></span><span style="display:flex;"><span>Epoch: 1 Valid Perplexity: 182.132
</span></span><span style="display:flex;"><span>Epoch: 2 Learning rate: 1.000
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Epoch: 4 Learning rate: 1.000
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Epoch: 5 Learning rate: 0.500
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Epoch: 6 Learning rate: 0.250
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Epoch: 7 Learning rate: 0.125
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Epoch: 13 Learning rate: 0.002
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Test Perplexity: 121.759
</span></span></code></pre></div><h2 id="reader">reader</h2>
<p>readerにはテストがあったので、これを使って実際にどんな出力をしているか見てみる。</p>
<h3 id="ptb_raw_data">ptb_raw_data</h3>
<p>単語をIDに変換したものと語彙数が返る。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">setUp</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>  <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_string_data <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">.</span>join(
</span></span><span style="display:flex;"><span>    [<span style="color:#f1fa8c">&#34; hello there i am&#34;</span>,
</span></span><span style="display:flex;"><span>     <span style="color:#f1fa8c">&#34; rain as day&#34;</span>,
</span></span><span style="display:flex;"><span>     <span style="color:#f1fa8c">&#34; want some cheesy puffs ?&#34;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">testPtbRawData</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>  tmpdir <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>test<span style="color:#ff79c6">.</span>get_temp_dir()
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> suffix <span style="color:#ff79c6">in</span> <span style="color:#f1fa8c">&#34;train&#34;</span>, <span style="color:#f1fa8c">&#34;valid&#34;</span>, <span style="color:#f1fa8c">&#34;test&#34;</span>:
</span></span><span style="display:flex;"><span>    filename <span style="color:#ff79c6">=</span> os<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>join(tmpdir, <span style="color:#f1fa8c">&#34;ptb.</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">.txt&#34;</span> <span style="color:#ff79c6">%</span> suffix)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">with</span> tf<span style="color:#ff79c6">.</span>gfile<span style="color:#ff79c6">.</span>GFile(filename, <span style="color:#f1fa8c">&#34;w&#34;</span>) <span style="color:#ff79c6">as</span> fh:
</span></span><span style="display:flex;"><span>    fh<span style="color:#ff79c6">.</span>write(<span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_string_data)
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># Smoke test</span>
</span></span><span style="display:flex;"><span>  output <span style="color:#ff79c6">=</span> reader<span style="color:#ff79c6">.</span>ptb_raw_data(tmpdir)
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#39;output: </span><span style="color:#f1fa8c">{0}</span><span style="color:#f1fa8c">&#39;</span><span style="color:#ff79c6">.</span>format(output))
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># output: (</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">#   [5, 10, 6, 1, 8, 2, 4, 11, 9, 3, 7, 0], # train</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">#   [5, 10, 6, 1, 8, 2, 4, 11, 9, 3, 7, 0], # valid</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">#   [5, 10, 6, 1, 8, 2, 4, 11, 9, 3, 7, 0], # test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">#   12 # vocabulary</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># )</span>
</span></span><span style="display:flex;"><span>  <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>assertEqual(<span style="color:#8be9fd;font-style:italic">len</span>(output), <span style="color:#bd93f9">4</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(word_to_id)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">=&gt;</span> {<span style="color:#f1fa8c">&#39;?&#39;</span>: <span style="color:#bd93f9">0</span>, <span style="color:#f1fa8c">&#39;am&lt;eos&gt;&#39;</span>: <span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">&#39;as&#39;</span>: <span style="color:#bd93f9">2</span>, <span style="color:#f1fa8c">&#39;cheesy&#39;</span>: <span style="color:#bd93f9">3</span>, <span style="color:#f1fa8c">&#39;day&lt;eos&gt;&#39;</span>: <span style="color:#bd93f9">4</span>, <span style="color:#f1fa8c">&#39;hello&#39;</span>: <span style="color:#bd93f9">5</span>, <span style="color:#f1fa8c">&#39;i&#39;</span>: <span style="color:#bd93f9">6</span>, <span style="color:#f1fa8c">&#39;puffs&#39;</span>: <span style="color:#bd93f9">7</span>, <span style="color:#f1fa8c">&#39;rain&#39;</span>: <span style="color:#bd93f9">8</span>, <span style="color:#f1fa8c">&#39;some&#39;</span>: <span style="color:#bd93f9">9</span>, <span style="color:#f1fa8c">&#39;there&#39;</span>: <span style="color:#bd93f9">10</span>, <span style="color:#f1fa8c">&#39;want&#39;</span>: <span style="color:#bd93f9">11</span>}
</span></span></code></pre></div><h3 id="ptb_producer">ptb_producer</h3>
<p>session.runする度に時系列順に[batch_size, num_steps]のTensorを出力する。
二つ目の返り値は一つ右にずらしたもの。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">testPtbProducer</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>  raw_data <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># t=0↓  t=1↓</span>
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">6</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>  batch_size <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>  num_steps <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>  x, y <span style="color:#ff79c6">=</span> reader<span style="color:#ff79c6">.</span>ptb_producer(raw_data, batch_size, num_steps)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">with</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>test_session() <span style="color:#ff79c6">as</span> session:
</span></span><span style="display:flex;"><span>    coord <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>train<span style="color:#ff79c6">.</span>Coordinator()
</span></span><span style="display:flex;"><span>    tf<span style="color:#ff79c6">.</span>train<span style="color:#ff79c6">.</span>start_queue_runners(session, coord<span style="color:#ff79c6">=</span>coord)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>      xval, yval <span style="color:#ff79c6">=</span> session<span style="color:#ff79c6">.</span>run([x, y])
</span></span><span style="display:flex;"><span>      <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>assertAllEqual(xval, [[<span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">3</span>], [<span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">6</span>], [<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>]])
</span></span><span style="display:flex;"><span>      <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>assertAllEqual(yval, [[<span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">2</span>], [<span style="color:#bd93f9">6</span>, <span style="color:#bd93f9">1</span>], [<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">3</span>]])
</span></span><span style="display:flex;"><span>      xval, yval <span style="color:#ff79c6">=</span> session<span style="color:#ff79c6">.</span>run([x, y])
</span></span><span style="display:flex;"><span>      <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>assertAllEqual(xval, [[<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">1</span>], [<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>], [<span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">4</span>]])
</span></span><span style="display:flex;"><span>      <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>assertAllEqual(yval, [[<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>], [<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>], [<span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">1</span>]])
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">finally</span>:
</span></span><span style="display:flex;"><span>      coord<span style="color:#ff79c6">.</span>request_stop()
</span></span><span style="display:flex;"><span>      coord<span style="color:#ff79c6">.</span>join()
</span></span></code></pre></div><p>実装はこんな感じ。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>i <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>train<span style="color:#ff79c6">.</span>range_input_producer(epoch_size, shuffle<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>)<span style="color:#ff79c6">.</span>dequeue()
</span></span><span style="display:flex;"><span>x <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>strided_slice(data, [<span style="color:#bd93f9">0</span>, i <span style="color:#ff79c6">*</span> num_steps],
</span></span><span style="display:flex;"><span>                        [batch_size, (i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">*</span> num_steps])
</span></span><span style="display:flex;"><span>x<span style="color:#ff79c6">.</span>set_shape([batch_size, num_steps])
</span></span><span style="display:flex;"><span>y <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>strided_slice(data, [<span style="color:#bd93f9">0</span>, i <span style="color:#ff79c6">*</span> num_steps <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>],
</span></span><span style="display:flex;"><span>                        [batch_size, (i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">*</span> num_steps <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>])
</span></span><span style="display:flex;"><span>y<span style="color:#ff79c6">.</span>set_shape([batch_size, num_steps])
</span></span></code></pre></div><p>range_input_producerはその名の通りrangeのように0から値を生成するが、
Threadを調整する<a href="https://www.tensorflow.org/api_docs/python/tf/train/Coordinator">Coordinator</a>を生成し、
<a href="https://www.tensorflow.org/api_docs/python/tf/train/start_queue_runners">start_queue_runners</a>に渡す必要がある。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># example of range_input_producer</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">with</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>test_session() <span style="color:#ff79c6">as</span> session:
</span></span><span style="display:flex;"><span>  i <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>train<span style="color:#ff79c6">.</span>range_input_producer(<span style="color:#bd93f9">100</span>, shuffle<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>)<span style="color:#ff79c6">.</span>dequeue()
</span></span><span style="display:flex;"><span>  coord <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>train<span style="color:#ff79c6">.</span>Coordinator()
</span></span><span style="display:flex;"><span>  tf<span style="color:#ff79c6">.</span>train<span style="color:#ff79c6">.</span>start_queue_runners(session, coord<span style="color:#ff79c6">=</span>coord)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(session<span style="color:#ff79c6">.</span>run(i)) <span style="color:#6272a4"># =&gt; 0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(session<span style="color:#ff79c6">.</span>run(i)) <span style="color:#6272a4"># =&gt; 1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(session<span style="color:#ff79c6">.</span>run(i)) <span style="color:#6272a4"># =&gt; 2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">finally</span>:
</span></span><span style="display:flex;"><span>    coord<span style="color:#ff79c6">.</span>request_stop()
</span></span><span style="display:flex;"><span>    coord<span style="color:#ff79c6">.</span>join() <span style="color:#6272a4"># Wait for all the threads to terminate.</span>
</span></span></code></pre></div><h2 id="model">Model</h2>
<h3 id="入力の準備">入力の準備</h3>
<p><a href="https://www.tensorflow.org/api_docs/python/tf/nn/embedding_lookup">embedding_lookup</a>で
embeddingから各stepの単語のものを抽出する。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">with</span> tf<span style="color:#ff79c6">.</span>device(<span style="color:#f1fa8c">&#34;/cpu:0&#34;</span>):
</span></span><span style="display:flex;"><span>  embedding <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>get_variable(
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;embedding&#34;</span>, [vocab_size, size], dtype<span style="color:#ff79c6">=</span>data_type())
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># shape=(batch_size, num_steps, size), dtype=float32</span>
</span></span><span style="display:flex;"><span>  inputs <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>embedding_lookup(embedding, input_<span style="color:#ff79c6">.</span>input_data)
</span></span></code></pre></div><p>embedding_lookupの挙動はこんな感じ。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># example of embedding_lookup</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">with</span> tf<span style="color:#ff79c6">.</span>Session() <span style="color:#ff79c6">as</span> session:
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">print</span>(session<span style="color:#ff79c6">.</span>run(tf<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>embedding_lookup(
</span></span><span style="display:flex;"><span>    [[<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>], [<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">3</span>], [<span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">5</span>], [<span style="color:#bd93f9">6</span>, <span style="color:#bd93f9">7</span>], [<span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">9</span>], [<span style="color:#bd93f9">10</span>, <span style="color:#bd93f9">11</span>]],
</span></span><span style="display:flex;"><span>    [[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">1</span>,<span style="color:#bd93f9">2</span>], [<span style="color:#bd93f9">3</span>,<span style="color:#bd93f9">4</span>,<span style="color:#bd93f9">5</span>], [<span style="color:#bd93f9">6</span>,<span style="color:#bd93f9">7</span>,<span style="color:#bd93f9">8</span>]]
</span></span><span style="display:flex;"><span>  ))) 
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># =&gt; [[ 0  2  4]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">#     [ 6  8 10]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">#     [ 1  3  5]]</span>
</span></span></code></pre></div><p>学習中の場合、過学習を防ぐためkeep_prob残してDropoutし、RNNのグラフを作り始める。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> is_training <span style="color:#ff79c6">and</span> config<span style="color:#ff79c6">.</span>keep_prob <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">1</span>:
</span></span><span style="display:flex;"><span>  inputs <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>dropout(inputs, config<span style="color:#ff79c6">.</span>keep_prob)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output, state <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_build_rnn_graph(inputs, config, is_training)
</span></span></code></pre></div><h3 id="rnnのグラフ">RNNのグラフ</h3>
<p>rnn_mode で実装を選べるようになっている。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_build_rnn_graph</span>(<span style="font-style:italic">self</span>, inputs, config, is_training):
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> config<span style="color:#ff79c6">.</span>rnn_mode <span style="color:#ff79c6">==</span> CUDNN:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_build_rnn_graph_cudnn(inputs, config, is_training)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_build_rnn_graph_lstm(inputs, config, is_training)
</span></span></code></pre></div><p>Cellは LSTMBlockCell を DroopoutWrapper でラップしたもの。
さらにこれをCellの出力が次のCellの入力になる MultiRNNCell で num_layers の数重ねている。</p>
<p>最初に<a href="https://www.tensorflow.org/api_docs/python/tf/contrib/rnn/BasicLSTMCell#zero_state">zero_state</a>の
初期状態から num_steps まわして各stepでのoutputと最後のstateを返す。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_get_lstm_cell</span>(<span style="font-style:italic">self</span>, config, is_training):
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> config<span style="color:#ff79c6">.</span>rnn_mode <span style="color:#ff79c6">==</span> BASIC:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> tf<span style="color:#ff79c6">.</span>contrib<span style="color:#ff79c6">.</span>rnn<span style="color:#ff79c6">.</span>BasicLSTMCell(
</span></span><span style="display:flex;"><span>      config<span style="color:#ff79c6">.</span>hidden_size, forget_bias<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0.0</span>, state_is_tuple<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,
</span></span><span style="display:flex;"><span>      reuse<span style="color:#ff79c6">=</span><span style="color:#ff79c6">not</span> is_training)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> config<span style="color:#ff79c6">.</span>rnn_mode <span style="color:#ff79c6">==</span> BLOCK:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> tf<span style="color:#ff79c6">.</span>contrib<span style="color:#ff79c6">.</span>rnn<span style="color:#ff79c6">.</span>LSTMBlockCell(
</span></span><span style="display:flex;"><span>      config<span style="color:#ff79c6">.</span>hidden_size, forget_bias<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0.0</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">raise</span> ValueError(<span style="color:#f1fa8c">&#34;rnn_mode </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c"> not supported&#34;</span> <span style="color:#ff79c6">%</span> config<span style="color:#ff79c6">.</span>rnn_mode)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_build_rnn_graph_lstm</span>(<span style="font-style:italic">self</span>, inputs, config, is_training):
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">make_cell</span>():
</span></span><span style="display:flex;"><span>    cell <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_get_lstm_cell(config, is_training)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> is_training <span style="color:#ff79c6">and</span> config<span style="color:#ff79c6">.</span>keep_prob <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">1</span>:
</span></span><span style="display:flex;"><span>      cell <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>contrib<span style="color:#ff79c6">.</span>rnn<span style="color:#ff79c6">.</span>DropoutWrapper(
</span></span><span style="display:flex;"><span>        cell, output_keep_prob<span style="color:#ff79c6">=</span>config<span style="color:#ff79c6">.</span>keep_prob)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> cell
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  cell <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>contrib<span style="color:#ff79c6">.</span>rnn<span style="color:#ff79c6">.</span>MultiRNNCell(
</span></span><span style="display:flex;"><span>    [make_cell() <span style="color:#ff79c6">for</span> _ <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(config<span style="color:#ff79c6">.</span>num_layers)], state_is_tuple<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_initial_state <span style="color:#ff79c6">=</span> cell<span style="color:#ff79c6">.</span>zero_state(config<span style="color:#ff79c6">.</span>batch_size, data_type())
</span></span><span style="display:flex;"><span>  state <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_initial_state
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># [shape=(batch_size, hidden_size) dtype=float32, ...]</span>
</span></span><span style="display:flex;"><span>  outputs <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">with</span> tf<span style="color:#ff79c6">.</span>variable_scope(<span style="color:#f1fa8c">&#34;RNN&#34;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> time_step <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>num_steps):
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> time_step <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>: tf<span style="color:#ff79c6">.</span>get_variable_scope()<span style="color:#ff79c6">.</span>reuse_variables()
</span></span><span style="display:flex;"><span>      (cell_output, state) <span style="color:#ff79c6">=</span> cell(inputs[:, time_step, :], state)
</span></span><span style="display:flex;"><span>      outputs<span style="color:#ff79c6">.</span>append(cell_output)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># shape=(batch_size * num_steps, hidden_size), dtype=float32</span>
</span></span><span style="display:flex;"><span>  output <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>reshape(tf<span style="color:#ff79c6">.</span>concat(outputs, <span style="color:#bd93f9">1</span>), [<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>, config<span style="color:#ff79c6">.</span>hidden_size])
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> output, state
</span></span></code></pre></div><h3 id="コスト">コスト</h3>
<p>出力層を通したのをlogits(log(p/(1-p)) (0≦p≦1))のシーケンスとして扱い、
<a href="https://www.tensorflow.org/api_docs/python/tf/contrib/seq2seq/sequence_loss">sequence_loss</a>で
それぞれ交差エントロピーを求め、その和をコストとする。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>output, state <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_build_rnn_graph(inputs, config, is_training)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>softmax_w <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>get_variable(
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;softmax_w&#34;</span>, [size, vocab_size], dtype<span style="color:#ff79c6">=</span>data_type())
</span></span><span style="display:flex;"><span>softmax_b <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>get_variable(<span style="color:#f1fa8c">&#34;softmax_b&#34;</span>, [vocab_size], dtype<span style="color:#ff79c6">=</span>data_type())
</span></span><span style="display:flex;"><span>logits <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>xw_plus_b(output, softmax_w, softmax_b)
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># shape=(batch_size, num_steps, vocab_size), dtype=float32</span>
</span></span><span style="display:flex;"><span>logits <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>reshape(logits, [<span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>batch_size, <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>num_steps, vocab_size])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loss <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>contrib<span style="color:#ff79c6">.</span>seq2seq<span style="color:#ff79c6">.</span>sequence_loss(
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># logits: [batch_size, sequence_length=num_steps, num_decoder_symbols=vocab_size] and dtype float</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># The logits correspond to the prediction across all classes at each timestep.</span>
</span></span><span style="display:flex;"><span>    logits,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># targets: [batch_size, sequence_length=num_steps] and dtype int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># The target represents the true class at each timestep.</span>
</span></span><span style="display:flex;"><span>    input_<span style="color:#ff79c6">.</span>targets,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># weights: [batch_size, sequence_length] and dtype float</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># When using weights as masking, set all valid timesteps to 1 and all padded timesteps to 0</span>
</span></span><span style="display:flex;"><span>    tf<span style="color:#ff79c6">.</span>ones([<span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>batch_size, <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>num_steps], dtype<span style="color:#ff79c6">=</span>data_type()),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    average_across_timesteps<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>,
</span></span><span style="display:flex;"><span>    average_across_batch<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Update the cost</span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_cost <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>reduce_sum(loss)
</span></span><span style="display:flex;"><span><span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_final_state <span style="color:#ff79c6">=</span> state
</span></span></code></pre></div><h3 id="勾配">勾配</h3>
<p><a href="https://www.tensorflow.org/api_docs/python/tf/trainable_variables">trainable_variables</a>で trainable=True (つまり_lr以外)のvariableを取得し、
<a href="https://www.tensorflow.org/api_docs/python/tf/gradients">gradients</a>で各variableに対しての勾配を求め、
<a href="https://www.tensorflow.org/api_docs/python/tf/clip_by_global_norm">clip_by_global_norm</a>で大きさを抑える。
これはgradient clippingと呼ばれる勾配爆発を防ぐための手法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> is_training:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_lr <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>Variable(<span style="color:#bd93f9">0.0</span>, trainable<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>)
</span></span><span style="display:flex;"><span>tvars <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>trainable_variables()
</span></span><span style="display:flex;"><span>grads, _ <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>clip_by_global_norm(tf<span style="color:#ff79c6">.</span>gradients(<span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_cost, tvars),
</span></span><span style="display:flex;"><span>                                    config<span style="color:#ff79c6">.</span>max_grad_norm)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># example of trainable_variables</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">with</span> tf<span style="color:#ff79c6">.</span>Session() <span style="color:#ff79c6">as</span> session:
</span></span><span style="display:flex;"><span>  a <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>Variable(<span style="color:#bd93f9">10.0</span>, trainable<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>)
</span></span><span style="display:flex;"><span>  b <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>Variable(<span style="color:#bd93f9">20.0</span>)
</span></span><span style="display:flex;"><span>  c <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>get_variable(<span style="color:#f1fa8c">&#34;c&#34;</span>, [<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>])
</span></span><span style="display:flex;"><span>  d <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>get_variable(<span style="color:#f1fa8c">&#34;d&#34;</span>, [<span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">3</span>], trainable<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>)
</span></span><span style="display:flex;"><span>  session<span style="color:#ff79c6">.</span>run(tf<span style="color:#ff79c6">.</span>global_variables_initializer())
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">print</span>(session<span style="color:#ff79c6">.</span>run(tf<span style="color:#ff79c6">.</span>trainable_variables()))
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># [20.0, array([[ 1.10110056,  0.6373167 ],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># [ 0.44673324, -0.11995673]], dtype=float32)]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># example of gradients &amp; clip_by_global_norm</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">with</span> tf<span style="color:#ff79c6">.</span>Session() <span style="color:#ff79c6">as</span> session:
</span></span><span style="display:flex;"><span>  xs <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>Variable([<span style="color:#bd93f9">10.</span>, <span style="color:#bd93f9">20.</span>, <span style="color:#bd93f9">30.</span>])
</span></span><span style="display:flex;"><span>  ys <span style="color:#ff79c6">=</span> [xs <span style="color:#ff79c6">**</span> <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">123</span>, xs <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">5</span>]
</span></span><span style="display:flex;"><span>  grad <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>gradients(ys,xs)
</span></span><span style="display:flex;"><span>  session<span style="color:#ff79c6">.</span>run(tf<span style="color:#ff79c6">.</span>global_variables_initializer())
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">print</span>(session<span style="color:#ff79c6">.</span>run(grad)) <span style="color:#6272a4"># [20 + 5, 40 + 5, 60 + 5]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  list_clipped, global_norm <span style="color:#ff79c6">=</span> session<span style="color:#ff79c6">.</span>run(tf<span style="color:#ff79c6">.</span>clip_by_global_norm(grad,<span style="color:#bd93f9">2</span>))
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># global_norm = sqrt(sum([l2norm(t)**2 for t in t_list]))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># = sqrt(25 ** 2 + 45 ** 2 + 65 ** 2)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">print</span>(global_norm) <span style="color:#6272a4"># 82.9156</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># t_list[i] * clip_norm / max(global_norm, clip_norm)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># = [25, 45, 65] * 2 / global_norm</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">print</span>(list_clipped) <span style="color:#6272a4"># [0.60302269, 1.08544087, 1.56785905]</span>
</span></span></code></pre></div><h3 id="optimize">Optimize</h3>
<p>学習率_lrの GradientDescenetOptimizer でoptimizeする。
<a href="https://www.tensorflow.org/api_docs/python/tf/train/GradientDescentOptimizer#apply_gradients">apply_gradients</a>するたびに
global_stepがインクリメントされる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>optimizer <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>train<span style="color:#ff79c6">.</span>GradientDescentOptimizer(<span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_lr)
</span></span><span style="display:flex;"><span><span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_train_op <span style="color:#ff79c6">=</span> optimizer<span style="color:#ff79c6">.</span>apply_gradients(
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">zip</span>(grads, tvars),
</span></span><span style="display:flex;"><span>  global_step<span style="color:#ff79c6">=</span>tf<span style="color:#ff79c6">.</span>train<span style="color:#ff79c6">.</span>get_or_create_global_step())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_new_lr <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>placeholder(
</span></span><span style="display:flex;"><span>  tf<span style="color:#ff79c6">.</span>float32, shape<span style="color:#ff79c6">=</span>[], name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;new_learning_rate&#34;</span>)
</span></span><span style="display:flex;"><span><span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_lr_update <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>assign(<span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_lr, <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_new_lr)
</span></span></code></pre></div><h3 id="run_epoch">run_epoch</h3>
<p>session.run() する。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>fetches <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;cost&#34;</span>: model<span style="color:#ff79c6">.</span>cost,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;final_state&#34;</span>: model<span style="color:#ff79c6">.</span>final_state,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> eval_op <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">not</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>  fetches[<span style="color:#f1fa8c">&#34;eval_op&#34;</span>] <span style="color:#ff79c6">=</span> eval_op
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> step <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(model<span style="color:#ff79c6">.</span>input<span style="color:#ff79c6">.</span>epoch_size):
</span></span><span style="display:flex;"><span>  feed_dict <span style="color:#ff79c6">=</span> {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> i, (c, h) <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">enumerate</span>(model<span style="color:#ff79c6">.</span>initial_state):
</span></span><span style="display:flex;"><span>    feed_dict[c] <span style="color:#ff79c6">=</span> state[i]<span style="color:#ff79c6">.</span>c
</span></span><span style="display:flex;"><span>    feed_dict[h] <span style="color:#ff79c6">=</span> state[i]<span style="color:#ff79c6">.</span>h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  vals <span style="color:#ff79c6">=</span> session<span style="color:#ff79c6">.</span>run(fetches, feed_dict)
</span></span><span style="display:flex;"><span>  cost <span style="color:#ff79c6">=</span> vals[<span style="color:#f1fa8c">&#34;cost&#34;</span>]
</span></span><span style="display:flex;"><span>  state <span style="color:#ff79c6">=</span> vals[<span style="color:#f1fa8c">&#34;final_state&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  costs <span style="color:#ff79c6">+=</span> cost
</span></span><span style="display:flex;"><span>  iters <span style="color:#ff79c6">+=</span> model<span style="color:#ff79c6">.</span>input<span style="color:#ff79c6">.</span>num_steps
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> verbose <span style="color:#ff79c6">and</span> step <span style="color:#ff79c6">%</span> (model<span style="color:#ff79c6">.</span>input<span style="color:#ff79c6">.</span>epoch_size <span style="color:#ff79c6">//</span> <span style="color:#bd93f9">10</span>) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">10</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">%.3f</span><span style="color:#f1fa8c"> perplexity: </span><span style="color:#f1fa8c">%.3f</span><span style="color:#f1fa8c"> speed: </span><span style="color:#f1fa8c">%.0f</span><span style="color:#f1fa8c"> wps&#34;</span> <span style="color:#ff79c6">%</span>
</span></span><span style="display:flex;"><span>      (step <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">1.0</span> <span style="color:#ff79c6">/</span> model<span style="color:#ff79c6">.</span>input<span style="color:#ff79c6">.</span>epoch_size, np<span style="color:#ff79c6">.</span>exp(costs <span style="color:#ff79c6">/</span> iters),
</span></span><span style="display:flex;"><span>       iters <span style="color:#ff79c6">*</span> model<span style="color:#ff79c6">.</span>input<span style="color:#ff79c6">.</span>batch_size <span style="color:#ff79c6">*</span> <span style="color:#8be9fd;font-style:italic">max</span>(<span style="color:#bd93f9">1</span>, FLAGS<span style="color:#ff79c6">.</span>num_gpus) <span style="color:#ff79c6">/</span>
</span></span><span style="display:flex;"><span>       (time<span style="color:#ff79c6">.</span>time() <span style="color:#ff79c6">-</span> start_time)))
</span></span></code></pre></div><h3 id="main">main</h3>
<p>起点。学習率はmax_epochまで初期値で、それ以後のepochでは指数的に減少させていく。</p>
<p><a href="https://www.tensorflow.org/api_docs/python/tf/train/Supervisor">Supervisor</a>は</p>
<ul>
<li>Threadを調整する<a href="https://www.tensorflow.org/api_docs/python/tf/train/Coordinator">Corrdinator</a></li>
<li>variableを保存する<a href="https://www.tensorflow.org/api_docs/python/tf/train/Saver">Saver</a></li>
<li>チェックポイントからセッションを再開する<a href="https://www.tensorflow.org/api_docs/python/tf/train/SessionManager">SessionManager</a></li>
</ul>
<p>のラッパー。</p>
<blockquote>
<p>追記(2018-07-01): Supervisorはdeprecatedになったので代わりにMonitoredSessionを使うべき。</p>
<p><a href="https://www.sambaiz.net/article/175/">TensorFlowのMonitoredSession - sambaiz-net</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">with</span> tf<span style="color:#ff79c6">.</span>Graph()<span style="color:#ff79c6">.</span>as_default():
</span></span><span style="display:flex;"><span>  tf<span style="color:#ff79c6">.</span>train<span style="color:#ff79c6">.</span>import_meta_graph(metagraph)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> model <span style="color:#ff79c6">in</span> models<span style="color:#ff79c6">.</span>values():
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">.</span>import_ops()
</span></span><span style="display:flex;"><span>  sv <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>train<span style="color:#ff79c6">.</span>Supervisor(logdir<span style="color:#ff79c6">=</span>FLAGS<span style="color:#ff79c6">.</span>save_path)
</span></span><span style="display:flex;"><span>  config_proto <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>ConfigProto(allow_soft_placement<span style="color:#ff79c6">=</span>soft_placement)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">with</span> sv<span style="color:#ff79c6">.</span>managed_session(config<span style="color:#ff79c6">=</span>config_proto) <span style="color:#ff79c6">as</span> session:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(config<span style="color:#ff79c6">.</span>max_max_epoch):
</span></span><span style="display:flex;"><span>      lr_decay <span style="color:#ff79c6">=</span> config<span style="color:#ff79c6">.</span>lr_decay <span style="color:#ff79c6">**</span> <span style="color:#8be9fd;font-style:italic">max</span>(i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">-</span> config<span style="color:#ff79c6">.</span>max_epoch, <span style="color:#bd93f9">0.0</span>)
</span></span><span style="display:flex;"><span>      m<span style="color:#ff79c6">.</span>assign_lr(session, config<span style="color:#ff79c6">.</span>learning_rate <span style="color:#ff79c6">*</span> lr_decay)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Epoch: </span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c"> Learning rate: </span><span style="color:#f1fa8c">%.3f</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">%</span> (i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>, session<span style="color:#ff79c6">.</span>run(m<span style="color:#ff79c6">.</span>lr)))
</span></span><span style="display:flex;"><span>      train_perplexity <span style="color:#ff79c6">=</span> run_epoch(session, m, eval_op<span style="color:#ff79c6">=</span>m<span style="color:#ff79c6">.</span>train_op,
</span></span><span style="display:flex;"><span>                                    verbose<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Epoch: </span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c"> Train Perplexity: </span><span style="color:#f1fa8c">%.3f</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">%</span> (i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>, train_perplexity))
</span></span><span style="display:flex;"><span>      valid_perplexity <span style="color:#ff79c6">=</span> run_epoch(session, mvalid)
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Epoch: </span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c"> Valid Perplexity: </span><span style="color:#f1fa8c">%.3f</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">%</span> (i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>, valid_perplexity))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    test_perplexity <span style="color:#ff79c6">=</span> run_epoch(session, mtest)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Test Perplexity: </span><span style="color:#f1fa8c">%.3f</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">%</span> test_perplexity)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> FLAGS<span style="color:#ff79c6">.</span>save_path:
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Saving model to </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">.&#34;</span> <span style="color:#ff79c6">%</span> FLAGS<span style="color:#ff79c6">.</span>save_path)
</span></span><span style="display:flex;"><span>      sv<span style="color:#ff79c6">.</span>saver<span style="color:#ff79c6">.</span>save(session, FLAGS<span style="color:#ff79c6">.</span>save_path, global_step<span style="color:#ff79c6">=</span>sv<span style="color:#ff79c6">.</span>global_step)
</span></span></code></pre></div><p><a href="https://www.sambaiz.net/article/154/">TensorFlow/RNNで連続的な値を取る時系列データを予測する - sambaiz-net</a></p>
<h2 id="参考">参考</h2>
<p><a href="https://www.amazon.co.jp/%E8%A9%B3%E8%A7%A3-%E3%83%87%E3%82%A3%E3%83%BC%E3%83%97%E3%83%A9%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0-TensorFlow%E3%83%BBKeras%E3%81%AB%E3%82%88%E3%82%8B%E6%99%82%E7%B3%BB%E5%88%97%E3%83%87%E3%83%BC%E3%82%BF%E5%87%A6%E7%90%86-%E5%B7%A3%E7%B1%A0-%E6%82%A0%E8%BC%94/dp/4839962510">詳解 ディープラーニング ~TensorFlow・Kerasによる時系列データ処理~</a></p>
<p><a href="https://colah.github.io/posts/2015-08-Understanding-LSTMs/">Understanding LSTM Networks &ndash; colah&rsquo;s blog</a></p>
<p><a href="https://qiita.com/t_Signull/items/21b82be280b46f467d1b">わかるLSTM ～ 最近の動向と共に - Qiita</a></p>
<p><a href="http://returnn.readthedocs.io/en/latest/tf_lstm_benchmark.html">TensorFlow LSTM benchmark — RETURNN 1.0-dev documentation</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>