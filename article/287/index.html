<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="generator" content="Hugo 0.79.1" />

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        font-family: -apple-system, "BlinkMacSystemFont", "Helvetica Neue", "Yu Gothic", YuGothic, Verdana, Meiryo, sans-serif;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 30px;
        height: 30px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.5rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single p>code {
        background-color: #eee;
        color: #333;
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>SageMakerでPyTorchのモデルを学習させる - sambaiz-net</title>
  <meta name="twitter:title" content="SageMakerでPyTorchのモデルを学習させる - sambaiz-net">
  <meta property='og:title' content="SageMakerでPyTorchのモデルを学習させる - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="SageMaker">
  <meta name="twitter:description" content="SageMaker">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/article/287/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "SageMakerでPyTorchのモデルを学習させる",
    "datePublished": "2020-07-24T22:59:00JST",
    "dateModified": "2020-07-24T22:59:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "SageMaker"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="アイコン" />
        <a class="nl" href="https://www.sambaiz.net/">
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://twitter.com/sambaiz">
            <img src="//www.sambaiz.net/image/twitter.png" width="30px" height="30px" alt="twitter">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="//www.sambaiz.net/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://bookmeter.com/users/1060169/bookcases/11726723">
            <img src="//www.sambaiz.net/image/bookmeter.png" width="30px" height="30px" alt="bookmeter">
          </a>
        </div>
        <div class="sns-item">
          <a href="https://filmarks.com/users/sambaiz" class="filmarks" aria-label="filmarks"></a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.alltrails.com/members/taiki-sakamoto/recordings">
            <img src="//www.sambaiz.net/image/alltrails.png" width="30px" height="30px" alt="alltrails">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/log/">
            log</a>
          
          <a class="tag" href="/tags/docker/">
            docker</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/infra/">
            infra</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>SageMakerでPyTorchのモデルを学習させる</h1>
        <time>2020-07-24</time>
        <a class="tag" href="/tags/python/">python</a><a class="tag" href="/tags/pytorch/">pytorch</a><a class="tag" href="/tags/machinelearning/">machinelearning</a><a class="tag" href="/tags/aws/">aws</a>
      </div>
      <p>AWSの機械学習サービス<a href="https://aws.amazon.com/jp/sagemaker/">SageMaker</a>でPyTorchのモデルを学習させる。</p>
<h2 id="コード">コード</h2>
<p>まず学習させるモデルとそれを呼び出すエントリーポイントになるコードを書く。全体のコードは<a href="https://github.com/sambaiz/sagemaker-pytorch-mnist">GitHub</a>にある。
実際の環境と同じSageMakerのコンテナをローカルで動かしてVSCodeのRemote Developmentで接続して開発すると入っていないパッケージは警告が出たりして良い。</p>
<p><a href="https://www.sambaiz.net/article/289/">VSCodeのRemote DevelopmentでSageMakerのコンテナ環境でモデルを開発する - sambaiz-net</a></p>
<h3 id="モデル">モデル</h3>
<p>以前作ったMNISTのモデルを使う。</p>
<p><a href="https://www.sambaiz.net/article/205/">PyTorchでMNISTする - sambaiz-net</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python">$ cat model<span style="color:#ff79c6">.</span>py
<span style="color:#ff79c6">import</span> torch
<span style="color:#ff79c6">from</span> torch <span style="color:#ff79c6">import</span> nn, cuda
<span style="color:#ff79c6">import</span> torch.nn.functional <span style="color:#ff79c6">as</span> F
<span style="color:#ff79c6">import</span> torch.distributed <span style="color:#ff79c6">as</span> dist
<span style="color:#ff79c6">import</span> torch.optim <span style="color:#ff79c6">as</span> optim


<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">Model</span>(nn<span style="color:#ff79c6">.</span>Module):
    <span style="color:#ff79c6">def</span> __init__(self, dropout):
        <span style="color:#8be9fd;font-style:italic">super</span>(Model, self)<span style="color:#ff79c6">.</span>__init__()
        self<span style="color:#ff79c6">.</span>conv1 <span style="color:#ff79c6">=</span> nn<span style="color:#ff79c6">.</span>Conv2d(<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">5</span>)  <span style="color:#6272a4"># -&gt; 24x24</span>
        self<span style="color:#ff79c6">.</span>pool1 <span style="color:#ff79c6">=</span> nn<span style="color:#ff79c6">.</span>MaxPool2d(<span style="color:#bd93f9">2</span>)  <span style="color:#6272a4"># -&gt; 12x12</span>
        self<span style="color:#ff79c6">.</span>conv2 <span style="color:#ff79c6">=</span> nn<span style="color:#ff79c6">.</span>Conv2d(<span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">5</span>)  <span style="color:#6272a4"># -&gt; 8x8</span>
        self<span style="color:#ff79c6">.</span>dropout <span style="color:#ff79c6">=</span> nn<span style="color:#ff79c6">.</span>Dropout(p<span style="color:#ff79c6">=</span>dropout)
        self<span style="color:#ff79c6">.</span>dense <span style="color:#ff79c6">=</span> nn<span style="color:#ff79c6">.</span>Linear(<span style="color:#bd93f9">128</span> <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">8</span> <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">10</span>)

    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">forward</span>(self, x):
        x <span style="color:#ff79c6">=</span> F<span style="color:#ff79c6">.</span>relu(self<span style="color:#ff79c6">.</span>conv1(x))
        x <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>pool1(x)
        x <span style="color:#ff79c6">=</span> F<span style="color:#ff79c6">.</span>relu(self<span style="color:#ff79c6">.</span>conv2(x))
        x <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>dropout(x)
        x <span style="color:#ff79c6">=</span> x<span style="color:#ff79c6">.</span>view(x<span style="color:#ff79c6">.</span>size(<span style="color:#bd93f9">0</span>), <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>)  <span style="color:#6272a4"># Flatten</span>
        <span style="color:#ff79c6">return</span> F<span style="color:#ff79c6">.</span>relu(self<span style="color:#ff79c6">.</span>dense(x))


<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_average_gradients</span>(model):
    size <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">float</span>(dist<span style="color:#ff79c6">.</span>get_world_size())
    <span style="color:#ff79c6">for</span> param <span style="color:#ff79c6">in</span> model<span style="color:#ff79c6">.</span>parameters():
        dist<span style="color:#ff79c6">.</span>all_reduce(param<span style="color:#ff79c6">.</span>grad<span style="color:#ff79c6">.</span>data, op<span style="color:#ff79c6">=</span>dist<span style="color:#ff79c6">.</span>ReduceOp<span style="color:#ff79c6">.</span>SUM)
        param<span style="color:#ff79c6">.</span>grad<span style="color:#ff79c6">.</span>data <span style="color:#ff79c6">/=</span> size


<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">train</span>(model, train_loader, device, is_distributed, lr, momentum):
    optimizer <span style="color:#ff79c6">=</span> optim<span style="color:#ff79c6">.</span>SGD(model<span style="color:#ff79c6">.</span>parameters(), lr<span style="color:#ff79c6">=</span>lr, momentum<span style="color:#ff79c6">=</span>momentum)
    criterion <span style="color:#ff79c6">=</span> nn<span style="color:#ff79c6">.</span>CrossEntropyLoss()
    model<span style="color:#ff79c6">.</span>train()
    <span style="color:#ff79c6">for</span> data, target <span style="color:#ff79c6">in</span> train_loader:
        data, target <span style="color:#ff79c6">=</span> data<span style="color:#ff79c6">.</span>to(device), target<span style="color:#ff79c6">.</span>to(device)
        optimizer<span style="color:#ff79c6">.</span>zero_grad()
        output <span style="color:#ff79c6">=</span> model(data)
        loss <span style="color:#ff79c6">=</span> criterion(output, target)
        loss<span style="color:#ff79c6">.</span>backward()
        <span style="color:#ff79c6">if</span> is_distributed <span style="color:#ff79c6">and</span> <span style="color:#ff79c6">not</span> cuda<span style="color:#ff79c6">.</span>is_available():
            <span style="color:#6272a4"># average gradients manually for multi-machine cpu case only</span>
            _average_gradients(model)
        optimizer<span style="color:#ff79c6">.</span>step()


<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test</span>(model, test_loader, device):
    model<span style="color:#ff79c6">.</span>eval()
    correct <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
    loss_sum <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
    <span style="color:#ff79c6">with</span> torch<span style="color:#ff79c6">.</span>no_grad():
        <span style="color:#ff79c6">for</span> data, target <span style="color:#ff79c6">in</span> test_loader:
            data, target <span style="color:#ff79c6">=</span> data<span style="color:#ff79c6">.</span>to(device), target<span style="color:#ff79c6">.</span>to(device)
            output <span style="color:#ff79c6">=</span> model(data)
            loss_sum <span style="color:#ff79c6">+=</span> F<span style="color:#ff79c6">.</span>nll_loss(output, target, reduction<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;sum&#39;</span>)<span style="color:#ff79c6">.</span>cpu()<span style="color:#ff79c6">.</span>data  <span style="color:#6272a4"># sum up batch loss</span>
            pred <span style="color:#ff79c6">=</span> output<span style="color:#ff79c6">.</span>max(<span style="color:#bd93f9">1</span>, keepdim<span style="color:#ff79c6">=</span>True)[<span style="color:#bd93f9">1</span>]  <span style="color:#6272a4"># get the index of the max log-probability</span>
            correct <span style="color:#ff79c6">+=</span> pred<span style="color:#ff79c6">.</span>eq(target<span style="color:#ff79c6">.</span>view_as(pred))<span style="color:#ff79c6">.</span>sum()<span style="color:#ff79c6">.</span>item()
    accuracy <span style="color:#ff79c6">=</span> correct <span style="color:#ff79c6">/</span> <span style="color:#8be9fd;font-style:italic">len</span>(test_loader<span style="color:#ff79c6">.</span>dataset)
    loss <span style="color:#ff79c6">=</span> loss_sum <span style="color:#ff79c6">/</span> <span style="color:#8be9fd;font-style:italic">len</span>(test_loader<span style="color:#ff79c6">.</span>dataset)
    <span style="color:#ff79c6">return</span> accuracy, loss
</code></pre></div><h3 id="エントリーポイント">エントリーポイント</h3>
<p><a href="https://github.com/awslabs/amazon-sagemaker-examples/blob/b01821341caf3d6af351e852b0dd9955db0e4515/sagemaker-python-sdk/pytorch_mnist/mnist.py">サンプルコード</a>をベースに
環境変数や引数でパラメータを受け取り、GPUや分散学習のための準備を行う。
<code>fit()</code>のinputで渡したS3のファイルは<code>${SM_CHANNEL_XXXX}</code>のパスにダウンロードされていて、<code>${SM_MODEL_DIR}</code>に置いたファイルが保存される。
ホスティング時にEIを用いる場合<code>model.pt</code>という名前のTorchScriptとして保存する必要がある。</p>
<p><a href="https://www.sambaiz.net/article/290/">SageMakerで学習したPyTorchのモデルをElastic Inferenceを有効にしてデプロイする - sambaiz-net</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">import</span> logging
<span style="color:#ff79c6">import</span> torch
<span style="color:#ff79c6">from</span> torchvision <span style="color:#ff79c6">import</span> datasets, transforms
<span style="color:#ff79c6">import</span> torch.distributed <span style="color:#ff79c6">as</span> dist
<span style="color:#ff79c6">import</span> os
<span style="color:#ff79c6">import</span> model <span style="color:#ff79c6">as</span> md
<span style="color:#ff79c6">import</span> argparse
<span style="color:#ff79c6">import</span> sys
<span style="color:#ff79c6">import</span> json

logger <span style="color:#ff79c6">=</span> logging<span style="color:#ff79c6">.</span>getLogger(__name__)
logger<span style="color:#ff79c6">.</span>setLevel(logging<span style="color:#ff79c6">.</span>DEBUG)
logger<span style="color:#ff79c6">.</span>addHandler(logging<span style="color:#ff79c6">.</span>StreamHandler(sys<span style="color:#ff79c6">.</span>stdout))


<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_make_train_loader</span>(batch_size, data_dir, is_distributed, <span style="color:#ff79c6">**</span>kwargs):
    dataset <span style="color:#ff79c6">=</span> datasets<span style="color:#ff79c6">.</span>MNIST(data_dir, train<span style="color:#ff79c6">=</span>True, transform<span style="color:#ff79c6">=</span>transforms<span style="color:#ff79c6">.</span>ToTensor(), download<span style="color:#ff79c6">=</span>False)
    train_sampler <span style="color:#ff79c6">=</span> torch<span style="color:#ff79c6">.</span>utils<span style="color:#ff79c6">.</span>data<span style="color:#ff79c6">.</span>distributed<span style="color:#ff79c6">.</span>DistributedSampler(dataset) <span style="color:#ff79c6">if</span> is_distributed <span style="color:#ff79c6">else</span> None
    <span style="color:#ff79c6">return</span> torch<span style="color:#ff79c6">.</span>utils<span style="color:#ff79c6">.</span>data<span style="color:#ff79c6">.</span>DataLoader(dataset, batch_size<span style="color:#ff79c6">=</span>batch_size, shuffle<span style="color:#ff79c6">=</span>train_sampler <span style="color:#ff79c6">is</span> None, sampler<span style="color:#ff79c6">=</span>train_sampler, <span style="color:#ff79c6">**</span>kwargs)


<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_make_test_loader</span>(batch_size, data_dir, <span style="color:#ff79c6">**</span>kwargs):
    dataset <span style="color:#ff79c6">=</span> datasets<span style="color:#ff79c6">.</span>MNIST(data_dir, train<span style="color:#ff79c6">=</span>False, transform<span style="color:#ff79c6">=</span>transforms<span style="color:#ff79c6">.</span>ToTensor(), download<span style="color:#ff79c6">=</span>False)
    <span style="color:#ff79c6">return</span> torch<span style="color:#ff79c6">.</span>utils<span style="color:#ff79c6">.</span>data<span style="color:#ff79c6">.</span>DataLoader(dataset, batch_size<span style="color:#ff79c6">=</span>batch_size, shuffle<span style="color:#ff79c6">=</span>True, <span style="color:#ff79c6">**</span>kwargs)


<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">train</span>(args):
    is_distributed <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">len</span>(args<span style="color:#ff79c6">.</span>hosts) <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">and</span> args<span style="color:#ff79c6">.</span>backend <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">not</span> None
    use_cuda <span style="color:#ff79c6">=</span> args<span style="color:#ff79c6">.</span>num_gpus <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>
    kwargs <span style="color:#ff79c6">=</span> {<span style="color:#f1fa8c">&#39;num_workers&#39;</span>: <span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">&#39;pin_memory&#39;</span>: True} <span style="color:#ff79c6">if</span> use_cuda <span style="color:#ff79c6">else</span> {}
    device <span style="color:#ff79c6">=</span> torch<span style="color:#ff79c6">.</span>device(<span style="color:#f1fa8c">&#34;cuda&#34;</span> <span style="color:#ff79c6">if</span> use_cuda <span style="color:#ff79c6">else</span> <span style="color:#f1fa8c">&#34;cpu&#34;</span>)

    <span style="color:#ff79c6">if</span> is_distributed:
        <span style="color:#6272a4"># Initialize the distributed environment.</span>
        world_size <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">len</span>(args<span style="color:#ff79c6">.</span>hosts)
        os<span style="color:#ff79c6">.</span>environ[<span style="color:#f1fa8c">&#39;WORLD_SIZE&#39;</span>] <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">str</span>(world_size)
        host_rank <span style="color:#ff79c6">=</span> args<span style="color:#ff79c6">.</span>hosts<span style="color:#ff79c6">.</span>index(args<span style="color:#ff79c6">.</span>current_host)
        os<span style="color:#ff79c6">.</span>environ[<span style="color:#f1fa8c">&#39;RANK&#39;</span>] <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">str</span>(host_rank)
        dist<span style="color:#ff79c6">.</span>init_process_group(backend<span style="color:#ff79c6">=</span>args<span style="color:#ff79c6">.</span>backend, rank<span style="color:#ff79c6">=</span>host_rank, world_size<span style="color:#ff79c6">=</span>world_size)

    <span style="color:#6272a4"># set the seed for generating random numbers</span>
    torch<span style="color:#ff79c6">.</span>manual_seed(args<span style="color:#ff79c6">.</span>seed)
    <span style="color:#ff79c6">if</span> use_cuda:
        torch<span style="color:#ff79c6">.</span>cuda<span style="color:#ff79c6">.</span>manual_seed(args<span style="color:#ff79c6">.</span>seed)

    model <span style="color:#ff79c6">=</span> md<span style="color:#ff79c6">.</span>Model(args<span style="color:#ff79c6">.</span>dropout)<span style="color:#ff79c6">.</span>to(device)
    <span style="color:#ff79c6">if</span> is_distributed <span style="color:#ff79c6">and</span> use_cuda:
        <span style="color:#6272a4"># multi-machine multi-gpu case</span>
        model <span style="color:#ff79c6">=</span> torch<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>parallel<span style="color:#ff79c6">.</span>DistributedDataParallel(model)
    <span style="color:#ff79c6">else</span>:
        <span style="color:#6272a4"># single-machine multi-gpu case or single-machine or multi-machine cpu case</span>
        model <span style="color:#ff79c6">=</span> torch<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>DataParallel(model)

    train_loader <span style="color:#ff79c6">=</span> _make_train_loader(args<span style="color:#ff79c6">.</span>batch_size, args<span style="color:#ff79c6">.</span>data_dir, is_distributed, <span style="color:#ff79c6">**</span>kwargs)
    test_loader <span style="color:#ff79c6">=</span> _make_test_loader(args<span style="color:#ff79c6">.</span>test_batch_size, args<span style="color:#ff79c6">.</span>data_dir, <span style="color:#ff79c6">**</span>kwargs)

    <span style="color:#ff79c6">for</span> epoch <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">1</span>, args<span style="color:#ff79c6">.</span>epochs <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>):
        logger<span style="color:#ff79c6">.</span>info(f<span style="color:#f1fa8c">&#39;epoch: {epoch}/{args.epochs}&#39;</span>)
        md<span style="color:#ff79c6">.</span>train(model, train_loader, device, is_distributed, args<span style="color:#ff79c6">.</span>lr, args<span style="color:#ff79c6">.</span>momentum)
        test_accuracy, test_loss <span style="color:#ff79c6">=</span> md<span style="color:#ff79c6">.</span>test(model, test_loader, device)
        logger<span style="color:#ff79c6">.</span>info(f<span style="color:#f1fa8c">&#39;test accuracy: {test_accuracy}, test loss: {test_loss};&#39;</span>)
    save_model(model, args<span style="color:#ff79c6">.</span>model_dir)


<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">save_model</span>(model, model_dir):
    path <span style="color:#ff79c6">=</span> os<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>join(model_dir, <span style="color:#f1fa8c">&#39;model.pt&#39;</span>)
    torch<span style="color:#ff79c6">.</span>jit<span style="color:#ff79c6">.</span>save(torch<span style="color:#ff79c6">.</span>jit<span style="color:#ff79c6">.</span>script(model<span style="color:#ff79c6">.</span>module), path)


<span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;__main__&#39;</span>:
    parser <span style="color:#ff79c6">=</span> argparse<span style="color:#ff79c6">.</span>ArgumentParser()

    <span style="color:#6272a4"># hyperparameters</span>
    parser<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--batch-size&#39;</span>, <span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">int</span>, default<span style="color:#ff79c6">=</span><span style="color:#bd93f9">64</span>, metavar<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;N&#39;</span>, help<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;input batch size for training (default: 64)&#39;</span>)
    parser<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--test-batch-size&#39;</span>, <span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">int</span>, default<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1000</span>, metavar<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;N&#39;</span>, help<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;input batch size for testing (default: 1000)&#39;</span>)
    parser<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--epochs&#39;</span>, <span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">int</span>, default<span style="color:#ff79c6">=</span><span style="color:#bd93f9">10</span>, metavar<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;N&#39;</span>, help<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;number of epochs to train (default: 10)&#39;</span>)
    parser<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--seed&#39;</span>, <span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">int</span>, default<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>, metavar<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;S&#39;</span>, help<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;random seed (default: 1)&#39;</span>)
    parser<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--backend&#39;</span>, <span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">str</span>, default<span style="color:#ff79c6">=</span>None, help<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;backend for distributed training (tcp, gloo on cpu and gloo, nccl on gpu)&#39;</span>)
    <span style="color:#6272a4"># model params</span>
    parser<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--dropout&#39;</span>, <span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">float</span>, default<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0.5</span>, metavar<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;DROP&#39;</span>, help<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;dropout rate (default: 0.5)&#39;</span>)
    <span style="color:#6272a4"># optimizer params</span>
    parser<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--lr&#39;</span>, <span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">float</span>, default<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0.01</span>, metavar<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;LR&#39;</span>, help<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;learning rate (default: 0.01)&#39;</span>)
    parser<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--momentum&#39;</span>, <span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">float</span>, default<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0.5</span>, metavar<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;M&#39;</span>, help<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;SGD momentum (default: 0.5)&#39;</span>)

    <span style="color:#6272a4"># Container environment</span>
    parser<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--hosts&#39;</span>, <span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">str</span>, default<span style="color:#ff79c6">=</span>os<span style="color:#ff79c6">.</span>environ<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;SM_HOSTS&#39;</span>, <span style="color:#f1fa8c">&#39;[]&#39;</span>))
    parser<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--current-host&#39;</span>, <span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">str</span>, default<span style="color:#ff79c6">=</span>os<span style="color:#ff79c6">.</span>environ<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;SM_CURRENT_HOST&#39;</span>))
    parser<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--model-dir&#39;</span>, <span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">str</span>, default<span style="color:#ff79c6">=</span>os<span style="color:#ff79c6">.</span>environ<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;SM_MODEL_DIR&#39;</span>, <span style="color:#f1fa8c">&#39;.&#39;</span>))
    parser<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--num-gpus&#39;</span>, <span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">int</span>, default<span style="color:#ff79c6">=</span>os<span style="color:#ff79c6">.</span>environ<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;SM_NUM_GPUS&#39;</span>, <span style="color:#bd93f9">0</span>))

    <span style="color:#6272a4"># fit() inputs (SM_CHANNEL_XXXX)</span>
    parser<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--data-dir&#39;</span>, <span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">str</span>, default<span style="color:#ff79c6">=</span>os<span style="color:#ff79c6">.</span>environ<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;SM_CHANNEL_TRAINING&#39;</span>, <span style="color:#f1fa8c">&#39;mnist&#39;</span>))

    args <span style="color:#ff79c6">=</span> parser<span style="color:#ff79c6">.</span>parse_args()
    args<span style="color:#ff79c6">.</span>hosts <span style="color:#ff79c6">=</span> json<span style="color:#ff79c6">.</span>loads(args<span style="color:#ff79c6">.</span>hosts)

    train(args)
</code></pre></div><h3 id="ローカル実行">ローカル実行</h3>
<p>ローカルで実行できることを確認する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python">$ cat Makefile
download_datasets:
	python download_datasets<span style="color:#ff79c6">.</span>py

local_run: download_datasets
	python main<span style="color:#ff79c6">.</span>py

$ cat download_datasets<span style="color:#ff79c6">.</span>py
<span style="color:#ff79c6">from</span> torchvision <span style="color:#ff79c6">import</span> datasets

<span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;__main__&#39;</span>:
    dataset <span style="color:#ff79c6">=</span> datasets<span style="color:#ff79c6">.</span>MNIST(<span style="color:#f1fa8c">&#39;.&#39;</span>, train<span style="color:#ff79c6">=</span>True, download<span style="color:#ff79c6">=</span>True)
    dataset <span style="color:#ff79c6">=</span> datasets<span style="color:#ff79c6">.</span>MNIST(<span style="color:#f1fa8c">&#39;.&#39;</span>, train<span style="color:#ff79c6">=</span>False, download<span style="color:#ff79c6">=</span>True)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">$ make local_run
epoch: 1/10
test_accuracy: 0.9593, test_loss_avg: -10.719537734985352
...
</code></pre></div><h2 id="実行">実行</h2>
<p>SageMaker Studioから実行した。</p>
<h3 id="sagemaker-studioへのオンボードhttpsdocsawsamazoncomja_jpsagemakerlatestdggs-studio-onboardhtml"><a href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/gs-studio-onboard.html">SageMaker Studioへのオンボード</a></h3>
<p>SageMaker Studioを初めて使う場合はユーザー名とS3などにアクセスするためのExecution roleなどを設定する必要がある。QuickstartではIAM認証になるが、Standard setupでSSO認証にすることもできる。</p>
<p><img src="https://www.sambaiz.net/images/287-onboard.png" alt="Onboard"></p>
<p>StatusがReadyになるとユーザー一覧からOpen Studioできる。</p>
<p><img src="https://www.sambaiz.net/images/287-studio.png" alt="Onboard"></p>
<h3 id="前準備">前準備</h3>
<p>必要なパッケージをインストールし、データセットをS3に上げる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">import</span> sys
!{sys<span style="color:#ff79c6">.</span>executable} <span style="color:#ff79c6">-</span>m pip install sagemaker<span style="color:#ff79c6">-</span>experiments
!{sys<span style="color:#ff79c6">.</span>executable} <span style="color:#ff79c6">-</span>m pip install torch
!{sys<span style="color:#ff79c6">.</span>executable} <span style="color:#ff79c6">-</span>m pip install torchvision
!apt<span style="color:#ff79c6">-</span>get install <span style="color:#ff79c6">-</span>y make

<span style="color:#ff79c6">import</span> os
sess <span style="color:#ff79c6">=</span> boto3<span style="color:#ff79c6">.</span>Session()
account_id <span style="color:#ff79c6">=</span> sess<span style="color:#ff79c6">.</span>client(<span style="color:#f1fa8c">&#39;sts&#39;</span>)<span style="color:#ff79c6">.</span>get_caller_identity()[<span style="color:#f1fa8c">&#34;Account&#34;</span>]
os<span style="color:#ff79c6">.</span>environ[<span style="color:#f1fa8c">&#39;DATASETS_BUCKET&#39;</span>] <span style="color:#ff79c6">=</span> f<span style="color:#f1fa8c">&#39;sagemaker-test-mnist-{sess.region_name}-{account_id}&#39;</span>
os<span style="color:#ff79c6">.</span>environ[<span style="color:#f1fa8c">&#39;DATASETS_KEY_PREFIX&#39;</span>] <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;mnist&#39;</span>
!make upload_datasets
</code></pre></div><h3 id="学習">学習</h3>
<p>PyTorchの<a href="https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html">Estimator</a>を作成し、<code>fit()</code>でTraining jobsを開始する。<a href="https://docs.aws.amazon.com/sagemaker/latest/dg/sagemaker-roles.html#sagemaker-roles-get-execution-role">get_execution_role()</a>はNotebookインスタンスのroleのARNを返す関数で、それ以外の環境で実行するとエラーになる。</p>
<p><img src="https://www.sambaiz.net/images/287-trainingjobs.png" alt="Training jobs"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">from</span> sagemaker.pytorch <span style="color:#ff79c6">import</span> PyTorch
<span style="color:#ff79c6">import</span> sagemaker

estimator <span style="color:#ff79c6">=</span> PyTorch(
    source_dir<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;/root/sagemaker-pytorch-mnist&#39;</span>,
    entry_point<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;main.py&#39;</span>,
    output_path<span style="color:#ff79c6">=</span>f<span style="color:#f1fa8c">&#39;s3://{os.environ[&#34;DATASETS_BUCKET&#34;]}/artifacts&#39;</span>,
    role<span style="color:#ff79c6">=</span>sagemaker<span style="color:#ff79c6">.</span>get_execution_role(),
    framework_version<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;1.3.1&#39;</span>,
    py_version<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;py3&#39;</span>,
    train_instance_count<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>,
    train_instance_type<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;ml.g4dn.xlarge&#39;</span>,
    hyperparameters<span style="color:#ff79c6">=</span>{
        <span style="color:#f1fa8c">&#39;epochs&#39;</span>: <span style="color:#bd93f9">10</span>,
        <span style="color:#f1fa8c">&#39;backend&#39;</span>: <span style="color:#f1fa8c">&#39;gloo&#39;</span>,
        <span style="color:#f1fa8c">&#39;dropout&#39;</span>: <span style="color:#bd93f9">0.2</span>,
    },
    metric_definitions<span style="color:#ff79c6">=</span>[
        {<span style="color:#f1fa8c">&#39;Name&#39;</span>:<span style="color:#f1fa8c">&#39;test:accuracy&#39;</span>, <span style="color:#f1fa8c">&#39;Regex&#39;</span>:<span style="color:#f1fa8c">&#39;test accuracy: (.*?),&#39;</span>},
        {<span style="color:#f1fa8c">&#39;Name&#39;</span>:<span style="color:#f1fa8c">&#39;test:loss&#39;</span>, <span style="color:#f1fa8c">&#39;Regex&#39;</span>:<span style="color:#f1fa8c">&#39;test loss: (.*?);&#39;</span>}
    ],
    enable_sagemaker_metrics<span style="color:#ff79c6">=</span>True,
)

inputs <span style="color:#ff79c6">=</span> sagemaker<span style="color:#ff79c6">.</span>inputs<span style="color:#ff79c6">.</span>s3_input(f<span style="color:#f1fa8c">&#39;s3://{os.environ[&#34;DATASETS_BUCKET&#34;]}/{os.environ[&#34;DATASETS_KEY_PREFIX&#34;]}&#39;</span>)

estimator<span style="color:#ff79c6">.</span>fit(inputs<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;training&#39;</span>: inputs})
</code></pre></div><p>出力したログの正規表現で一致した部分の値がメトリクスとしてCloudWatchに送られる。</p>
<p><img src="https://www.sambaiz.net/images/287-metrics.png" alt="メトリクス"></p>
<p>学習が終わると<code>output_path</code>にモデルが保存される。</p>
<p><a href="https://www.sambaiz.net/article/373/">SageMaker Studioの使っていないKernelを自動でシャットダウンするsagemaker-studio-auto-shutdown-extension - sambaiz-net</a></p>

    </div>
  </article>
</div>

</div>
</body>

</html>