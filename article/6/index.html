<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="generator" content="Hugo 0.79.1" />

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        font-family: -apple-system, "BlinkMacSystemFont", "Helvetica Neue", "Yu Gothic", YuGothic, Verdana, Meiryo, sans-serif;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 30px;
        height: 30px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.5rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single p>code {
        background-color: #eee;
        color: #333;
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>TensorFlow チュートリアル2(Deep MNIST for Experts) - sambaiz-net</title>
  <meta name="twitter:title" content="TensorFlow チュートリアル2(Deep MNIST for Experts) - sambaiz-net">
  <meta property='og:title' content="TensorFlow チュートリアル2(Deep MNIST for Experts) - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="書き数字識別の難しい方">
  <meta name="twitter:description" content="書き数字識別の難しい方">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/article/6/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "TensorFlow チュートリアル2(Deep MNIST for Experts)",
    "datePublished": "2016-07-12T21:16:00JST",
    "dateModified": "2016-07-12T21:16:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "書き数字識別の難しい方"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="アイコン" />
        <a class="nl" href="https://www.sambaiz.net/">
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://twitter.com/sambaiz">
            <img src="//www.sambaiz.net/image/twitter.png" width="30px" height="30px" alt="twitter">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="//www.sambaiz.net/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://bookmeter.com/users/1060169/bookcases/11726723">
            <img src="//www.sambaiz.net/image/bookmeter.png" width="30px" height="30px" alt="bookmeter">
          </a>
        </div>
        <div class="sns-item">
          <a href="https://filmarks.com/users/sambaiz" class="filmarks" aria-label="filmarks"></a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.alltrails.com/members/taiki-sakamoto/recordings">
            <img src="//www.sambaiz.net/image/alltrails.png" width="30px" height="30px" alt="alltrails">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/log/">
            log</a>
          
          <a class="tag" href="/tags/docker/">
            docker</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/infra/">
            infra</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>TensorFlow チュートリアル2(Deep MNIST for Experts)</h1>
        <time>2016-07-12</time>
        <a class="tag" href="/tags/tensorflow/">tensorflow</a>
      </div>
      <p><a href="https://www.sambaiz.net/article/3">前回</a>に引き続き、まとめながら進めていく。</p>
<p><a href="https://www.tensorflow.org/versions/r0.9/tutorials/mnist/pros/index.html">Deep MNIST for Experts</a></p>
<h3 id="start-tensorflow-interactivesession">Start TensorFlow InteractiveSession</h3>
<p>今回は、前回のようにグラフを作成してからSessionを開始する代わりに
<code>InteractiveSession</code>を使う。
グラフを作成し実行するのをインタラクティブに行うことができ、IPythonのような環境で便利だ。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">import</span> tensorflow <span style="color:#ff79c6">as</span> tf
sess <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>InteractiveSession()
</code></pre></div><h3 id="build-a-multilayer-convolutional-network">Build a Multilayer Convolutional Network</h3>
<p>前回のシンプルなモデルではあまり良い結果が出なかった。
そこで、今回はもう少し良いモデルの畳み込みニューラルネットワークを作成する。</p>
<h3 id="weight-initialization">Weight Initialization</h3>
<p>勾配が0になるのを避けるために重みの初期化時にノイズを付ける。
<code>tf.truncated_normal</code>は<a href="https://www.tensorflow.org/versions/r0.9/api_docs/python/constant_op.html#truncated_normal">正規分布で、μ±2σ範囲内のランダムな値を返す</a>。
以下の例だと、<code>mean</code>のデフォルトが0.0なので、正規分布 <code>N(0, 0.01)</code>の、<code>-0.2&lt;=x&lt;=0.2</code>な値がランダムに返ることになる。</p>
<p>また、<a href="https://ja.wikipedia.org/wiki/%E6%B4%BB%E6%80%A7%E5%8C%96%E9%96%A2%E6%95%B0#ReLU.EF.BC.88.E3.83.A9.E3.83.B3.E3.83.97.E9.96.A2.E6.95.B0.EF.BC.89">ReLU(Rectified Linear Unit, 正規化線形関数)</a>ニューロンを使うので、&ldquo;死んだニューロン&quot;を避けるために、バイアスは小さな正の値で初期化する。</p>
<p><a href="https://www.sambaiz.net/article/133/">ニューラルネットワークと活性化関数 - sambaiz-net</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">weight_variable</span>(shape):
  initial <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>truncated_normal(shape, stddev<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0.1</span>)
  <span style="color:#ff79c6">return</span> tf<span style="color:#ff79c6">.</span>Variable(initial)

<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">bias_variable</span>(shape):
  initial <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>constant(<span style="color:#bd93f9">0.1</span>, shape<span style="color:#ff79c6">=</span>shape)
  <span style="color:#ff79c6">return</span> tf<span style="color:#ff79c6">.</span>Variable(initial)
</code></pre></div><h3 id="convolution-and-pooling">Convolution and Pooling</h3>
<p>TensorFlowに畳み込みとプーリングの関数が用意されている。</p>
<p>畳み込みというのは、画像に対してフィルターを少しずつ動かしながら掛けていく処理のこと。<a href="http://www.clg.niigata-u.ac.jp/~medimg/practice_medical_imaging/imgproc_scion/4filter/index.htm">このページ</a>が分かりやすい。
例えば、<a href="https://en.wikipedia.org/wiki/Sobel_operator">ソーベルフィルタ</a>で輪郭になっているところを抽出するように、
フィルターの値によって、その区域における、ある特徴を際立たせたりすることができる。
今回はこのフィルターが重みとなり、際立たせたいのはその数字を識別するための特徴ということになる。
前回は画像を一次元の配列として扱い重みを学習していたので、縦の情報が失われていたが、この方法ではそれがない。</p>
<p>プーリングというのは画像から区域ごとにサンプリングする処理のこと。最大プーリングや、平均プーリングなどの手法がある。
畳み込みのように順番に区域を見ていって、最大プーリングならそのうちの最大のものを採用し、他のものは無視する。
サイズが小さくなるだけではなく、ちょっとした位置のずれを吸収することができる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">conv2d</span>(x, W):
  <span style="color:#ff79c6">return</span> tf<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>conv2d(x, W, strides<span style="color:#ff79c6">=</span>[<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>], padding<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;SAME&#39;</span>)

<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">max_pool_2x2</span>(x):
  <span style="color:#ff79c6">return</span> tf<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>max_pool(x, ksize<span style="color:#ff79c6">=</span>[<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">1</span>],
                        strides<span style="color:#ff79c6">=</span>[<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">1</span>], padding<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;SAME&#39;</span>)
</code></pre></div><p><code>tf.nn.conv2d</code>は<a href="https://www.tensorflow.org/versions/r0.9/api_docs/python/nn.html#conv2d">畳み込みを行う。</a>
主な入力は<code>[画像の数, 縦サイズ, 横サイズ, チャンネル数(色とか)]</code>の画像と、
<code>[縦サイズ, 横サイズ, 入力チャンネル数, 出力チャンネル数]</code>のフィルター。
<code>strides</code>は一度にどれくらいフィルターを動かしていくかで、<code>strides[1]</code>が縦、<code>strides[2]</code>が横に動かす量。
<code>strides[0]</code>と<code>strides[3]</code>は1でなくてはならない。
<code>padding</code>は&quot;SAME&quot;か&quot;VALID&quot;から選択できるパディングについての設定だ。詳細は
<a href="https://www.tensorflow.org/versions/r0.9/api_docs/python/nn.html#convolution">ここ</a>
に書いてある。</p>
<p><code>tf.nn.max_pool</code>は<a href="https://www.tensorflow.org/versions/r0.9/api_docs/python/nn.html#max_pool">最大プーリングを行う。</a>
<code>ksize</code>は入力のそれぞれの次元に対応した見ていく区域のサイズ。<code>[1, 2, 2, 1]</code>ならそれぞれの画像を<code>2*2</code>ずつ見ていくことになる。</p>
<h3 id="first-convolutional-layer">First Convolutional Layer</h3>
<p>最初のレイヤーは、畳み込みと最大プーリングで構成される。
畳み込みはそれぞれ<code>5*5</code>の32チャンネル出力のフィルターでされる。
つまり、重みであるフィルターは<code>[5, 5, 1, 32]</code>のtensorということになる。
それぞれのチャンネルに対してのバイアスがb_conv1。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python">W_conv1 <span style="color:#ff79c6">=</span> weight_variable([<span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">32</span>])
b_conv1 <span style="color:#ff79c6">=</span> bias_variable([<span style="color:#bd93f9">32</span>])
</code></pre></div><p>画像に対して、畳み込みを適用するするために<code>tf.reshape</code>で
<a href="https://www.tensorflow.org/versions/r0.9/api_docs/python/array_ops.html#reshape">変形する</a>
必要がある。-1というのは特別な値で、他の次元との積が合計が元のものと変わらないように決定される。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python">x <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>placeholder(tf<span style="color:#ff79c6">.</span>float32, [None, <span style="color:#bd93f9">784</span>])
x_image <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>reshape(x, [<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>,<span style="color:#bd93f9">28</span>,<span style="color:#bd93f9">28</span>,<span style="color:#bd93f9">1</span>])
</code></pre></div><p>これで畳み込めるようになったので画像と重みを畳み込み、バイアスを足したものにReLUを適用した後、最大プーリングする。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python">h_conv1 <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>relu(conv2d(x_image, W_conv1) <span style="color:#ff79c6">+</span> b_conv1)
h_pool1 <span style="color:#ff79c6">=</span> max_pool_2x2(h_conv1)
</code></pre></div><h3 id="second-convolutional-layer">Second Convolutional Layer</h3>
<p>deepネットワークにするために最初のレイヤーのようなものをいくつか重ねる。
2番目のレイヤーでは64チャンネル出力のフィルターで畳み込みを行いプーリングする。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python">W_conv2 <span style="color:#ff79c6">=</span> weight_variable([<span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">64</span>])
b_conv2 <span style="color:#ff79c6">=</span> bias_variable([<span style="color:#bd93f9">64</span>])

h_conv2 <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>relu(conv2d(h_pool1, W_conv2) <span style="color:#ff79c6">+</span> b_conv2)
h_pool2 <span style="color:#ff79c6">=</span> max_pool_2x2(h_conv2)
</code></pre></div><h3 id="densely-connected-layer">Densely Connected Layer</h3>
<p>2つのレイヤーを経て元々<code>28*28</code>だった画像は<code>7*7</code>にまで削減された。
2つめのレイヤーの出力は64チャンネルだったので、<code>7*7*64</code>次元のデータになっている。
このレイヤーでは、これらにそれぞれ1024のニューロンを結びつける。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python">W_fc1 <span style="color:#ff79c6">=</span> weight_variable([<span style="color:#bd93f9">7</span> <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">7</span> <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">1024</span>])
b_fc1 <span style="color:#ff79c6">=</span> bias_variable([<span style="color:#bd93f9">1024</span>])

h_pool2_flat <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>reshape(h_pool2, [<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">7</span><span style="color:#ff79c6">*</span><span style="color:#bd93f9">7</span><span style="color:#ff79c6">*</span><span style="color:#bd93f9">64</span>])
h_fc1 <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>relu(tf<span style="color:#ff79c6">.</span>matmul(h_pool2_flat, W_fc1) <span style="color:#ff79c6">+</span> b_fc1)
</code></pre></div><h3 id="dropout">Dropout</h3>
<p>過学習を防ぐために訓練データごとにニューロンを何割か無視する
<a href="https://ja.wikipedia.org/wiki/%E3%83%87%E3%82%A3%E3%83%BC%E3%83%97%E3%83%A9%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0#.E3.83.89.E3.83.AD.E3.83.83.E3.83.97.E3.82.A2.E3.82.A6.E3.83.88">ドロップアウト</a>
を行う。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python">keep_prob <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>placeholder(tf<span style="color:#ff79c6">.</span>float32)
h_fc1_drop <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>dropout(h_fc1, keep_prob)
</code></pre></div><h3 id="readout-layer">Readout Layer</h3>
<p>最後にsoftmaxでそれぞれの数字である確率を求める。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python">W_fc2 <span style="color:#ff79c6">=</span> weight_variable([<span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">10</span>])
b_fc2 <span style="color:#ff79c6">=</span> bias_variable([<span style="color:#bd93f9">10</span>])

y_conv<span style="color:#ff79c6">=</span>tf<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>softmax(tf<span style="color:#ff79c6">.</span>matmul(h_fc1_drop, W_fc2) <span style="color:#ff79c6">+</span> b_fc2)
</code></pre></div><h3 id="train-and-evaluate-the-model">Train and Evaluate the Model</h3>
<p>今回は前回使った<code>GradientDescentOptimizer</code>よりも性能が高い<code>AdamOptimizer</code>というのが使われている。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python">y_ <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>placeholder(tf<span style="color:#ff79c6">.</span>float32, [None, <span style="color:#bd93f9">10</span>])
cross_entropy <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>reduce_mean(<span style="color:#ff79c6">-</span>tf<span style="color:#ff79c6">.</span>reduce_sum(y_ <span style="color:#ff79c6">*</span> tf<span style="color:#ff79c6">.</span>log(y_conv), reduction_indices<span style="color:#ff79c6">=</span>[<span style="color:#bd93f9">1</span>]))
train_step <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>train<span style="color:#ff79c6">.</span>AdamOptimizer(<span style="color:#bd93f9">1e-4</span>)<span style="color:#ff79c6">.</span>minimize(cross_entropy)
correct_prediction <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>equal(tf<span style="color:#ff79c6">.</span>argmax(y_conv,<span style="color:#bd93f9">1</span>), tf<span style="color:#ff79c6">.</span>argmax(y_,<span style="color:#bd93f9">1</span>))
accuracy <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>reduce_mean(tf<span style="color:#ff79c6">.</span>cast(correct_prediction, tf<span style="color:#ff79c6">.</span>float32))
sess<span style="color:#ff79c6">.</span>run(tf<span style="color:#ff79c6">.</span>initialize_all_variables())
<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">20000</span>):
  batch <span style="color:#ff79c6">=</span> mnist<span style="color:#ff79c6">.</span>train<span style="color:#ff79c6">.</span>next_batch(<span style="color:#bd93f9">50</span>)
  <span style="color:#ff79c6">if</span> i<span style="color:#ff79c6">%</span><span style="color:#bd93f9">100</span> <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>:
    train_accuracy <span style="color:#ff79c6">=</span> accuracy<span style="color:#ff79c6">.</span>eval(feed_dict<span style="color:#ff79c6">=</span>{
        x:batch[<span style="color:#bd93f9">0</span>], y_: batch[<span style="color:#bd93f9">1</span>], keep_prob: <span style="color:#bd93f9">1.0</span>})
    <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c">&#34;step </span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">, training accuracy </span><span style="color:#f1fa8c">%g</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">%</span>(i, train_accuracy))
  train_step<span style="color:#ff79c6">.</span>run(feed_dict<span style="color:#ff79c6">=</span>{x: batch[<span style="color:#bd93f9">0</span>], y_: batch[<span style="color:#bd93f9">1</span>], keep_prob: <span style="color:#bd93f9">0.5</span>})

<span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c">&#34;test accuracy </span><span style="color:#f1fa8c">%g</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">%</span>accuracy<span style="color:#ff79c6">.</span>eval(feed_dict<span style="color:#ff79c6">=</span>{
    x: mnist<span style="color:#ff79c6">.</span>test<span style="color:#ff79c6">.</span>images, y_: mnist<span style="color:#ff79c6">.</span>test<span style="color:#ff79c6">.</span>labels, keep_prob: <span style="color:#bd93f9">1.0</span>}))
</code></pre></div><p>これを実行するとこんな出力が得られた。
かなり時間がかかったのでここで打ち切ったが、およそ99.2%の正解率になるらしい。
前回が92%だったのに比べてもすごく良い値に見える。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">step 0, training accuracy 0.12
step 100, training accuracy 0.8
step 200, training accuracy 0.9
step 300, training accuracy 0.9
step 400, training accuracy 0.98
step 500, training accuracy 0.88
step 600, training accuracy 0.98
step 700, training accuracy 0.98
step 800, training accuracy 0.9
step 900, training accuracy 1
step 1000, training accuracy 0.98
step 1100, training accuracy 0.98
step 1200, training accuracy 1
step 1300, training accuracy 0.98
step 1400, training accuracy 0.94
step 1500, training accuracy 0.98
</code></pre></div>
    </div>
  </article>
</div>

</div>
</body>

</html>