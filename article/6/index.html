<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="Hugo 0.17" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/magula.min.css">
    <link rel="stylesheet" href="/css/slidebars.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://sambaiz.net/index.xml">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@sambaiz">
    
    <title>TensorFlow チュートリアル2(Deep MNIST for Experts) - sambaiz-net</title>
    <meta name="twitter:title" content="TensorFlow チュートリアル2(Deep MNIST for Experts) - sambaiz-net">
    <meta property='og:title' content="TensorFlow チュートリアル2(Deep MNIST for Experts) - sambaiz-net">
    <meta property="og:type" content="article">
    
      <meta name="description" content="書き数字識別の難しい方">
      <meta name="twitter:description" content="書き数字識別の難しい方">
    
    

    <meta property="og:url" content="http://sambaiz.net/article/6/">
    <meta property="og:image" content="http://sambaiz.net/images/my_l.jpg">
    <meta name="twitter:image" content="http://sambaiz.net/images/my.jpg" />
    <meta name="google-site-verification" content="CEqNYjzc4Y7hb3FY7uUkmllGzeDc40brBwQJixeH61Q" />

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id":"http:\/\/sambaiz.net\/"
    },
    "headline": "TensorFlow チュートリアル2(Deep MNIST for Experts) | sambaiz-net ",
    "datePublished": "2016-07-12T21:16:00JST",
    "dateModified": "2016-07-12T21:16:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "image": "http:\/\/sambaiz.net\/images/my.jpg"
    },
    "publisher": {
      "@type": "Organization",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "http:\/\/sambaiz.net\/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "http:\/\/sambaiz.net\/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "書き数字識別の難しい方"
  }
</script>
</head>

<body>
  <div off-canvas="id-1 left reveal">
  
  <ul class="tag-list">
    
  </ul>
  
  <ul class="tag-list">
    <li><a href="http://sambaiz.net/tags/log">log</a></li><li><a href="http://sambaiz.net/tags/golang">golang</a></li><li><a href="http://sambaiz.net/tags/unity">unity</a></li><li><a href="http://sambaiz.net/tags/aws">aws</a></li><li><a href="http://sambaiz.net/tags/fluentd">fluentd</a></li><li><a href="http://sambaiz.net/tags/infra">infra</a></li><li><a href="http://sambaiz.net/tags/docker">docker</a></li><li><a href="http://sambaiz.net/tags/elasticsearch">elasticsearch</a></li><li><a href="http://sambaiz.net/tags/hololens">hololens</a></li><li><a href="http://sambaiz.net/tags/linux">linux</a></li><li><a href="http://sambaiz.net/tags/k8s">k8s</a></li><li><a href="http://sambaiz.net/tags/node.js">node.js</a></li><li><a href="http://sambaiz.net/tags/tensorflow">tensorflow</a></li><li><a href="http://sambaiz.net/tags/ble">ble</a></li><li><a href="http://sambaiz.net/tags/gcp">gcp</a></li><li><a href="http://sambaiz.net/tags/android">android</a></li><li><a href="http://sambaiz.net/tags/angular">angular</a></li><li><a href="http://sambaiz.net/tags/cron">cron</a></li><li><a href="http://sambaiz.net/tags/mysql">mysql</a></li><li><a href="http://sambaiz.net/tags/uwp">uwp</a></li><li><a href="http://sambaiz.net/tags/web">web</a></li><li><a href="http://sambaiz.net/tags/.net">.net</a></li><li><a href="http://sambaiz.net/tags/firebase">firebase</a></li><li><a href="http://sambaiz.net/tags/javascript">javascript</a></li><li><a href="http://sambaiz.net/tags/norikra">norikra</a></li><li><a href="http://sambaiz.net/tags/product">product</a></li><li><a href="http://sambaiz.net/tags/react">react</a></li><li><a href="http://sambaiz.net/tags/vr">vr</a></li><li><a href="http://sambaiz.net/tags/api">api</a></li><li><a href="http://sambaiz.net/tags/csharp">csharp</a></li><li><a href="http://sambaiz.net/tags/css">css</a></li><li><a href="http://sambaiz.net/tags/d3.js">d3.js</a></li><li><a href="http://sambaiz.net/tags/event">event</a></li><li><a href="http://sambaiz.net/tags/grpc">grpc</a></li><li><a href="http://sambaiz.net/tags/hugo">hugo</a></li><li><a href="http://sambaiz.net/tags/ios">ios</a></li><li><a href="http://sambaiz.net/tags/jenkins">jenkins</a></li><li><a href="http://sambaiz.net/tags/jvm">jvm</a></li><li><a href="http://sambaiz.net/tags/leveldb">leveldb</a></li><li><a href="http://sambaiz.net/tags/neo4j">neo4j</a></li><li><a href="http://sambaiz.net/tags/nodejs">nodejs</a></li><li><a href="http://sambaiz.net/tags/oauth">oauth</a></li><li><a href="http://sambaiz.net/tags/rx">rx</a></li><li><a href="http://sambaiz.net/tags/rxjs">rxjs</a></li><li><a href="http://sambaiz.net/tags/server">server</a></li><li><a href="http://sambaiz.net/tags/terraform">terraform</a></li><li><a href="http://sambaiz.net/tags/typescript">typescript</a></li><li><a href="http://sambaiz.net/tags/video">video</a></li>
  </ul>
  
</div>

  <div canvas="container" id="container">
    <header>
      <button type="button" class="btn toggle-side">TAG</button>

      <div class="title">
        <img src="http://sambaiz.net/images/my.png" width="60px" height="60px" />
        <a class="nl" href="http://sambaiz.net/">sambaiz-net</a>
      </div>

      <div class="sns">
        <a class="nl" href="https://twitter.com/sambaiz"><i class="fa fa-2x fa-twitter"></i></a>
        <a class="nl" href="https://github.com/sambaiz"><i class="fa fa-2x fa-github"></i></a>
      </div>
    </header>


<div class="container">

  <div class="row">
    <div class="col-md-12">

      <article class="single">
        <div class="single body">
          <h1>TensorFlow チュートリアル2(Deep MNIST for Experts)</h1>
          <p>(2016-07-12)</p>
          

<p><a href="http://sambaiz.net/article/3">前回</a>に引き続き、まとめながら進めていく。</p>

<p><a href="https://www.tensorflow.org/versions/r0.9/tutorials/mnist/pros/index.html">Deep MNIST for Experts</a></p>

<h3 id="start-tensorflow-interactivesession">Start TensorFlow InteractiveSession</h3>

<p>今回は、前回のようにグラフを作成してからSessionを開始する代わりに
<code>InteractiveSession</code>を使う。
グラフを作成し実行するのをインタラクティブに行うことができ、IPythonのような環境で便利だ。</p>

<pre><code>import tensorflow as tf
sess = tf.InteractiveSession()
</code></pre>

<h3 id="build-a-multilayer-convolutional-network">Build a Multilayer Convolutional Network</h3>

<p>前回のシンプルなモデルでは、あまり良い結果が出なかった。
そこで、今回はもう少し洗練されたモデル、小さな畳み込みニューラルネットワークを作成する。</p>

<h3 id="weight-initialization">Weight Initialization</h3>

<p>このモデルを作成するためには、たくさんの重みとバイアスを作成する必要がある。</p>

<p>重みは、対称性を破り、勾配0を避けるために、少しのノイズで初期化すべきだ。</p>

<p>また、<a href="https://ja.wikipedia.org/wiki/%E6%B4%BB%E6%80%A7%E5%8C%96%E9%96%A2%E6%95%B0#ReLU.EF.BC.88.E3.83.A9.E3.83.B3.E3.83.97.E9.96.A2.E6.95.B0.EF.BC.89">ReLU(Rectified Linear Unit, 正規化線形関数)</a>ニューロンを使うので、&rdquo;死んだニューロン&rdquo;を避けるためにわずかな正の値のバイアスで初期化すると良い。</p>

<p><code>tf.truncated_normal</code>は<a href="https://www.tensorflow.org/versions/r0.9/api_docs/python/constant_op.html#truncated_normal">正規分布で、μ±2σ範囲内のランダムな値を返す。</a>
以下の例だと、<code>mean</code>のデフォルトが0.0なので、正規分布 <code>N(0, 0.01)</code>の、<code>-0.2&lt;=x&lt;=0.2</code>な値がランダムに返ることになる。</p>

<pre><code>def weight_variable(shape):
  initial = tf.truncated_normal(shape, stddev=0.1)
  return tf.Variable(initial)

def bias_variable(shape):
  initial = tf.constant(0.1, shape=shape)
  return tf.Variable(initial)
</code></pre>

<h3 id="convolution-and-pooling">Convolution and Pooling</h3>

<p>TensorFlowは柔軟な畳み込みとプーリングの手続きを提供している。</p>

<p>畳み込みというのは、画像に対してフィルターを少しずつ動かしながら掛けていく処理のことだ。<a href="http://www.clg.niigata-u.ac.jp/~medimg/practice_medical_imaging/imgproc_scion/4filter/index.htm">このページ</a>が分かりやすい。
例えば、<a href="https://en.wikipedia.org/wiki/Sobel_operator">ソーベルフィルタ</a>で輪郭になっているところを抽出するように、
フィルターの値によって、その区域における、ある特徴を際立たせたりすることができる。
今回はこのフィルターが重みとなり、際立たせたいのはその数字を識別するための特徴ということになる。
前回は画像を一次元の配列として扱い重みを学習していたので、縦の情報が失われていたが、この方法ではそれがない。</p>

<p>プーリングというのは画像から区域ごとにサンプリングする処理だ。最大プーリングや、平均プーリングなどの手法がある。
畳み込みのように順番に区域を見ていって、最大プーリングならそのうちの最大のものを採用し、他のものは無視する。
サイズが小さくなるだけではなく、ちょっとした位置のずれを吸収することができる。</p>

<pre><code>def conv2d(x, W):
  return tf.nn.conv2d(x, W, strides=[1, 1, 1, 1], padding='SAME')

def max_pool_2x2(x):
  return tf.nn.max_pool(x, ksize=[1, 2, 2, 1],
                        strides=[1, 2, 2, 1], padding='SAME')
</code></pre>

<p><code>tf.nn.conv2d</code>は<a href="https://www.tensorflow.org/versions/r0.9/api_docs/python/nn.html#conv2d">畳み込みを行う。</a>
主な入力は<code>[画像の数, 縦サイズ, 横サイズ, チャンネル数(色とか)]</code>の画像と、
<code>[縦サイズ, 横サイズ, 入力チャンネル数, 出力チャンネル数]</code>のフィルターだ。
<code>strides</code>は一度にどれくらいフィルターを動かしていくかで、<code>strides[1]</code>が縦、<code>strides[2]</code>が横に動かす量だ。
<code>strides[0]</code>と<code>strides[3]</code>は1でなくてはならない。
<code>padding</code>は&rdquo;SAME&rdquo;か&rdquo;VALID&rdquo;から選択できるパディングについての設定だ。詳細は
<a href="https://www.tensorflow.org/versions/r0.9/api_docs/python/nn.html#convolution">ここ</a>
に書いてある。</p>

<p><code>tf.nn.max_pool</code>は<a href="https://www.tensorflow.org/versions/r0.9/api_docs/python/nn.html#max_pool">最大プーリングを行う。</a>
<code>ksize</code>は入力のそれぞれの次元に対応した見ていく区域のサイズだ。<code>[1, 2, 2, 1]</code>ならそれぞれの画像を<code>2*2</code>ずつ見ていくことになる。</p>

<h3 id="first-convolutional-layer">First Convolutional Layer</h3>

<p>最初のレイヤーは、畳み込みと最大プーリングで構成される。
畳み込みはそれぞれ<code>5*5</code>の32チャンネル出力のフィルターでされる。
つまり、重みであるフィルターは<code>[5, 5, 1, 32]</code>のtensorということになる。
そして、それぞれのチャンネルに対してバイアスが存在する。</p>

<pre><code>W_conv1 = weight_variable([5, 5, 1, 32])
b_conv1 = bias_variable([32])
</code></pre>

<p>画像に対して、畳み込みを適用するするために<code>tf.reshape</code>で
<a href="https://www.tensorflow.org/versions/r0.9/api_docs/python/array_ops.html#reshape">変形する</a>
必要がある。-1というのは特別な値で、他の次元との積が合計が元のものと変わらないように決定される。</p>

<pre><code>x = tf.placeholder(tf.float32, [None, 784])
x_image = tf.reshape(x, [-1,28,28,1])
</code></pre>

<p>これで畳み込めるようになったので、画像と重みを畳み込み、バイアスを足したものにReLUを適用した後、最大プーリングする。</p>

<pre><code>h_conv1 = tf.nn.relu(conv2d(x_image, W_conv1) + b_conv1)
h_pool1 = max_pool_2x2(h_conv1)
</code></pre>

<h3 id="second-convolutional-layer">Second Convolutional Layer</h3>

<p>deepネットワークにするために最初のレイヤーのようなものをいくつか重ねる。
2番目のレイヤーでは64チャンネル出力のフィルターで畳み込みを行い、プーリングする。</p>

<pre><code>W_conv2 = weight_variable([5, 5, 32, 64])
b_conv2 = bias_variable([64])

h_conv2 = tf.nn.relu(conv2d(h_pool1, W_conv2) + b_conv2)
h_pool2 = max_pool_2x2(h_conv2)
</code></pre>

<h3 id="densely-connected-layer">Densely Connected Layer</h3>

<p>2つのレイヤーを経て元々<code>28*28</code>だった画像は<code>7*7</code>にまで削減された。
2つめのレイヤーの出力は64チャンネルだったので、<code>7*7*64</code>次元のデータになっている。
このレイヤーでは、これらにそれぞれ1024のニューロンを結びつける。</p>

<pre><code>W_fc1 = weight_variable([7 * 7 * 64, 1024])
b_fc1 = bias_variable([1024])

h_pool2_flat = tf.reshape(h_pool2, [-1, 7*7*64])
h_fc1 = tf.nn.relu(tf.matmul(h_pool2_flat, W_fc1) + b_fc1)
</code></pre>

<h3 id="dropout">Dropout</h3>

<p>過学習を防ぐために
<a href="https://ja.wikipedia.org/wiki/%E3%83%87%E3%82%A3%E3%83%BC%E3%83%97%E3%83%A9%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0#.E3.83.89.E3.83.AD.E3.83.83.E3.83.97.E3.82.A2.E3.82.A6.E3.83.88">ドロップアウト</a>
を行う。
ドロップアウトというのは訓練データごとにニューロンを何割か無視することだ。</p>

<pre><code>keep_prob = tf.placeholder(tf.float32)
h_fc1_drop = tf.nn.dropout(h_fc1, keep_prob)
</code></pre>

<h3 id="readout-layer">Readout Layer</h3>

<p>最後にsoftmaxでそれぞれの数字である確率を求める。</p>

<pre><code>W_fc2 = weight_variable([1024, 10])
b_fc2 = bias_variable([10])

y_conv=tf.nn.softmax(tf.matmul(h_fc1_drop, W_fc2) + b_fc2)
</code></pre>

<h3 id="train-and-evaluate-the-model">Train and Evaluate the Model</h3>

<p>今回は前回使った<code>GradientDescentOptimizer</code>よりも洗練されている<code>AdamOptimizer</code>というのが使われている。</p>

<pre><code>y_ = tf.placeholder(tf.float32, [None, 10])
cross_entropy = tf.reduce_mean(-tf.reduce_sum(y_ * tf.log(y_conv), reduction_indices=[1]))
train_step = tf.train.AdamOptimizer(1e-4).minimize(cross_entropy)
correct_prediction = tf.equal(tf.argmax(y_conv,1), tf.argmax(y_,1))
accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))
sess.run(tf.initialize_all_variables())
for i in range(20000):
  batch = mnist.train.next_batch(50)
  if i%100 == 0:
    train_accuracy = accuracy.eval(feed_dict={
        x:batch[0], y_: batch[1], keep_prob: 1.0})
    print(&quot;step %d, training accuracy %g&quot;%(i, train_accuracy))
  train_step.run(feed_dict={x: batch[0], y_: batch[1], keep_prob: 0.5})

print(&quot;test accuracy %g&quot;%accuracy.eval(feed_dict={
    x: mnist.test.images, y_: mnist.test.labels, keep_prob: 1.0}))
</code></pre>

<p>これを実行するとこんな出力が得られた。
かなり時間がかかったのでここで打ち切ったが、およそ99.2%の正解率になるらしい。
前回が92%だったのに比べてもすごく良い値に見える。</p>

<pre><code>step 0, training accuracy 0.12
step 100, training accuracy 0.8
step 200, training accuracy 0.9
step 300, training accuracy 0.9
step 400, training accuracy 0.98
step 500, training accuracy 0.88
step 600, training accuracy 0.98
step 700, training accuracy 0.98
step 800, training accuracy 0.9
step 900, training accuracy 1
step 1000, training accuracy 0.98
step 1100, training accuracy 0.98
step 1200, training accuracy 1
step 1300, training accuracy 0.98
step 1400, training accuracy 0.94
step 1500, training accuracy 0.98
</code></pre>

        </div>
      </article>
    </div>
  </div>
</div>

</div> 
<script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script src="/js/slidebars.min.js"></script>
<script>
    ( function ( $ ) {
      
      var controller = new slidebars();
      controller.init();

      $( '.toggle-side' ).on( 'click', function ( event ) {
          event.stopPropagation();
          event.preventDefault();

          controller.toggle( 'id-1' );
        } );

        $( '#container' ).on( 'click', function ( event ) {
            controller.close( 'id-1' );
          });
    } ) ( jQuery );
</script>

<script>hljs.initHighlightingOnLoad();</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-39190067-3', 'auto');
ga('send', 'pageview');
</script>


  </body>
</html>

