<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        
        font-family: "Helvetica Neue", 
            Arial, 
            "Hiragino Kaku Gothic ProN",
            "Hiragino Sans",
            "BIZ UDPGothic",
            Meiryo,
            sans-serif;
    }

    table {
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    table th,table td{
        padding: 0.2rem 1.0rem;
    }

    table tr{
        border-bottom: solid 1px #eee;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 32px;
        height: 32px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.4rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    code {
        
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    }

    .single p>code, .single li>code {
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single strong {
        color: #d2691e;
        font-weight: normal;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 1rem;
        margin-block-end: 1rem;
        font-size: 0.875rem;
    }

    .single .img_container {
        margin-block-start: 0.1rem;
        margin-block-end: 0.1rem;
        text-align: center;
    }

    .single img {
        border: 1px solid #ddd;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single blockquote > p {
        margin-block-start: 0;
        margin-block-end: 0;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-end: 0.4rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Go で atomic にメモリを読み書きするための低レベルなパッケージ sync/atomic のベンチマークを取る - sambaiz-net</title>
  <meta name="twitter:title" content="Go で atomic にメモリを読み書きするための低レベルなパッケージ sync/atomic のベンチマークを取る - sambaiz-net">
  <meta property='og:title' content="Go で atomic にメモリを読み書きするための低レベルなパッケージ sync/atomic のベンチマークを取る - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="o の sync/atomic は atomic にメモリを読み書きするための低レベルなパッケージ。arm64 の場合 LDADDALD といった atomic にメモリを操作する CPU 命令が実行される">
  <meta name="twitter:description" content="o の sync/atomic は atomic にメモリを読み書きするための低レベルなパッケージ。arm64 の場合 LDADDALD といった atomic にメモリを操作する CPU 命令が実行される">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/article/498/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  
  
  <link rel="alternate" hreflang="ja" href="https://www.sambaiz.net/article/498/" />
  
  <link rel="alternate" hreflang="x-default" href="https://www.sambaiz.net/article/498/" />
  
  
  <link rel="alternate" hreflang="en" href="https://www.sambaiz.net/en/article/498/" />
  
  
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "Go で atomic にメモリを読み書きするための低レベルなパッケージ sync/atomic のベンチマークを取る",
    "datePublished": "2024-09-23T23:28:00JST",
    "dateModified": "2024-09-23T23:28:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "o の sync/atomic は atomic にメモリを読み書きするための低レベルなパッケージ。arm64 の場合 LDADDALD といった atomic にメモリを操作する CPU 命令が実行される"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
      <ul>
          
          <li>
              <a href="https://www.sambaiz.net/en/article/498/">English</a>
          </li>
          
      </ul>
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.google.com/maps/contrib/102687103399829824749/photos">
            <img src="/image/googlemaps.svg" width="30px" height="30px" alt="google maps">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://boardgamearena.com/player?id=83835726">
            <img src="/image/boardgamearena.webp" width="30px" height="30px" alt="board game arena">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/etl/">
            etl</a>
          
          <a class="tag" href="/tags/web/">
            web</a>
          
          <a class="tag" href="/tags/spark/">
            spark</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>Go で atomic にメモリを読み書きするための低レベルなパッケージ sync/atomic のベンチマークを取る</h1>
        <time>2024-09-23</time>
        <a class="tag" href='/tags/golang/'>golang</a>
      </div>
      <p>Go の <a href="https://pkg.go.dev/sync/atomic">sync/atomic</a> は atomic にメモリを読み書きするための低レベルなパッケージ。arm64 の場合 <a href="https://developer.arm.com/documentation/ddi0602/2024-06/Base-Instructions/LDADD--LDADDA--LDADDAL--LDADDL--Atomic-add-on-word-or-doubleword-in-memory-">LDADDALD</a> といった atomic にメモリを操作する CPU 命令が<a href="https://github.com/golang/go/blob/go1.23.1/src/internal/runtime/atomic/atomic_arm64.s#L269">実行される</a>。複数の goroutine から値を読み書きする場合、通常 channel を介して通信するか sync.Mutex でロックをかける方法を取るので、扱いに注意が必要なこのパッケージの関数を自分で呼ぶ機会がなかった。ただ <a href="https://github.com/prometheus/client_golang/blob/v1.20.4/prometheus/counter.go#L152">Prometheus Go client</a> などのライブラリで呼ばれていることはあって、どの程度差があるのか気になったのでベンチマークを取ってみた。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go version
</span></span><span style="display:flex;"><span>go version go1.23.0 darwin/arm64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ system_profiler SPHardwareDataType
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Hardware:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Hardware Overview:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      Model Name: MacBook Air
</span></span><span style="display:flex;"><span>      Model Identifier: Mac14,2
</span></span><span style="display:flex;"><span>      Model Number: Z15Y001BPJ/A
</span></span><span style="display:flex;"><span>      Chip: Apple M2
</span></span><span style="display:flex;"><span>      Total Number of Cores: <span style="color:#bd93f9">8</span> <span style="color:#ff79c6">(</span><span style="color:#bd93f9">4</span> performance and <span style="color:#bd93f9">4</span> efficiency<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      Memory: <span style="color:#bd93f9">16</span> GB
</span></span><span style="display:flex;"><span>      ...
</span></span></code></pre></div><h2 id="読み込み">読み込み</h2>
<p>いくつかの goroutine から atomic.LoadInt64 と sync.RWMutex と channel を用いて取得する。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkAtomicLoad</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">var</span> x <span style="color:#8be9fd">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, numGoroutines <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> []<span style="color:#8be9fd">int</span>{<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">16</span>} {
</span></span><span style="display:flex;"><span>		b.<span style="color:#50fa7b">Run</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;goroutines-%d&#34;</span>, numGoroutines), <span style="color:#8be9fd;font-style:italic">func</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>			<span style="color:#8be9fd;font-style:italic">var</span> wg sync.WaitGroup
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; numGoroutines; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>				wg.<span style="color:#50fa7b">Add</span>(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; j &lt; b.N<span style="color:#ff79c6">/</span>numGoroutines; j<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>						atomic.<span style="color:#50fa7b">LoadInt64</span>(<span style="color:#ff79c6">&amp;</span>x)
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			wg.<span style="color:#50fa7b">Wait</span>()
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkMutexLoad</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">var</span> x <span style="color:#8be9fd">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">var</span> mu sync.RWMutex
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, numGoroutines <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> []<span style="color:#8be9fd">int</span>{<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">16</span>} {
</span></span><span style="display:flex;"><span>		b.<span style="color:#50fa7b">Run</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;goroutines-%d&#34;</span>, numGoroutines), <span style="color:#8be9fd;font-style:italic">func</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>			<span style="color:#8be9fd;font-style:italic">var</span> wg sync.WaitGroup
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; numGoroutines; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>				wg.<span style="color:#50fa7b">Add</span>(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; j &lt; b.N<span style="color:#ff79c6">/</span>numGoroutines; j<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>						mu.<span style="color:#50fa7b">RLock</span>()
</span></span><span style="display:flex;"><span>						_ = x
</span></span><span style="display:flex;"><span>						mu.<span style="color:#50fa7b">RUnlock</span>()
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			wg.<span style="color:#50fa7b">Wait</span>()
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkChannelLoad</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">var</span> x <span style="color:#8be9fd">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, numGoroutines <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> []<span style="color:#8be9fd">int</span>{<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">16</span>} {
</span></span><span style="display:flex;"><span>		b.<span style="color:#50fa7b">Run</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;goroutines-%d&#34;</span>, numGoroutines), <span style="color:#8be9fd;font-style:italic">func</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>			<span style="color:#8be9fd;font-style:italic">var</span> wg sync.WaitGroup
</span></span><span style="display:flex;"><span>			ch <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int64</span>, b.N)
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; b.N; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>				ch <span style="color:#ff79c6">&lt;-</span> x
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>			b.<span style="color:#50fa7b">ResetTimer</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; numGoroutines; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>				wg.<span style="color:#50fa7b">Add</span>(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; j &lt; b.N<span style="color:#ff79c6">/</span>numGoroutines; j<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#ff79c6">&lt;-</span>ch
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			wg.<span style="color:#50fa7b">Wait</span>()
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>atomic.LoadInt64 が他と比べて数十倍早く CPU クロックサイクル (3.49GHz → 0.29ns) のスケールになっている。
また、並列数を増やすと他が遅くなっていくのに対して atomic は多少オーバーヘッドはあるものの、全体の実行時間としては短くなる程度に収まっている。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># go test -bench=. -cpu=8
</span></span><span style="display:flex;"><span>BenchmarkAtomicLoad/goroutines-1-8              1000000000               0.5997 ns/op
</span></span><span style="display:flex;"><span>BenchmarkAtomicLoad/goroutines-2-8              1000000000               0.3114 ns/op
</span></span><span style="display:flex;"><span>BenchmarkAtomicLoad/goroutines-4-8              1000000000               0.1607 ns/op
</span></span><span style="display:flex;"><span>BenchmarkAtomicLoad/goroutines-8-8              1000000000               0.1475 ns/op
</span></span><span style="display:flex;"><span>BenchmarkAtomicLoad/goroutines-16-8             1000000000               0.1439 ns/op
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BenchmarkMutexLoad/goroutines-1-8               121244922                9.565 ns/op
</span></span><span style="display:flex;"><span>BenchmarkMutexLoad/goroutines-2-8               48834085                25.86 ns/op
</span></span><span style="display:flex;"><span>BenchmarkMutexLoad/goroutines-4-8               35727799                35.35 ns/op
</span></span><span style="display:flex;"><span>BenchmarkMutexLoad/goroutines-8-8               16799722                70.55 ns/op
</span></span><span style="display:flex;"><span>BenchmarkMutexLoad/goroutines-16-8              18368448                72.44 ns/op
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BenchmarkChannelLoad/goroutines-1-8             78505557                15.51 ns/op
</span></span><span style="display:flex;"><span>BenchmarkChannelLoad/goroutines-2-8             58123460                25.45 ns/op
</span></span><span style="display:flex;"><span>BenchmarkChannelLoad/goroutines-4-8             40698946                30.50 ns/op
</span></span><span style="display:flex;"><span>BenchmarkChannelLoad/goroutines-8-8             34705275                34.15 ns/op
</span></span><span style="display:flex;"><span>BenchmarkChannelLoad/goroutines-16-8            38005101                35.36 ns/op
</span></span></code></pre></div><h2 id="代入">代入</h2>
<p>同様に atomic.StoreInt64 と Mutex, channel を比較する。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkAtomicStore</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">var</span> x <span style="color:#8be9fd">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, numGoroutines <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> []<span style="color:#8be9fd">int</span>{<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">16</span>} {
</span></span><span style="display:flex;"><span>		b.<span style="color:#50fa7b">Run</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;goroutines-%d&#34;</span>, numGoroutines), <span style="color:#8be9fd;font-style:italic">func</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>			<span style="color:#8be9fd;font-style:italic">var</span> wg sync.WaitGroup
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; numGoroutines; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>				wg.<span style="color:#50fa7b">Add</span>(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; j &lt; b.N<span style="color:#ff79c6">/</span>numGoroutines; j<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>						atomic.<span style="color:#50fa7b">StoreInt64</span>(<span style="color:#ff79c6">&amp;</span>x, <span style="color:#8be9fd;font-style:italic">int64</span>(j))
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			wg.<span style="color:#50fa7b">Wait</span>()
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkMutexStore</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">var</span> x <span style="color:#8be9fd">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">var</span> mu sync.RWMutex
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, numGoroutines <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> []<span style="color:#8be9fd">int</span>{<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">16</span>} {
</span></span><span style="display:flex;"><span>		b.<span style="color:#50fa7b">Run</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;goroutines-%d&#34;</span>, numGoroutines), <span style="color:#8be9fd;font-style:italic">func</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>			<span style="color:#8be9fd;font-style:italic">var</span> wg sync.WaitGroup
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; numGoroutines; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>				wg.<span style="color:#50fa7b">Add</span>(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; j &lt; b.N<span style="color:#ff79c6">/</span>numGoroutines; j<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>						mu.<span style="color:#50fa7b">Lock</span>()
</span></span><span style="display:flex;"><span>						x = <span style="color:#8be9fd;font-style:italic">int64</span>(j)
</span></span><span style="display:flex;"><span>						mu.<span style="color:#50fa7b">Unlock</span>()
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			wg.<span style="color:#50fa7b">Wait</span>()
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	_ = x
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkChannelStore</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, numGoroutines <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> []<span style="color:#8be9fd">int</span>{<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">16</span>} {
</span></span><span style="display:flex;"><span>		b.<span style="color:#50fa7b">Run</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;goroutines-%d&#34;</span>, numGoroutines), <span style="color:#8be9fd;font-style:italic">func</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>			<span style="color:#8be9fd;font-style:italic">var</span> wg sync.WaitGroup
</span></span><span style="display:flex;"><span>			ch <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int64</span>, b.N)
</span></span><span style="display:flex;"><span>			done <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">bool</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			b.<span style="color:#50fa7b">ResetTimer</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> ch {
</span></span><span style="display:flex;"><span>					_ = j
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				done <span style="color:#ff79c6">&lt;-</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>			}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; numGoroutines; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>				wg.<span style="color:#50fa7b">Add</span>(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; j &lt; b.N<span style="color:#ff79c6">/</span>numGoroutines; j<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>						ch <span style="color:#ff79c6">&lt;-</span> <span style="color:#8be9fd;font-style:italic">int64</span>(j)
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			wg.<span style="color:#50fa7b">Wait</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#8be9fd;font-style:italic">close</span>(ch)
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&lt;-</span>done
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>atomic も並列数に伴って実行時間が増えているが、毎回排他ロックを取っている Mutex ほどの伸びはない。channel は並列数を増やしても実行時間がそれほど増えていないが、それでも atomic の方が数倍速い。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># go test -bench=. -cpu=8
</span></span><span style="display:flex;"><span>BenchmarkAtomicStore/goroutines-1-8             1000000000               0.6098 ns/op
</span></span><span style="display:flex;"><span>BenchmarkAtomicStore/goroutines-2-8             541424420                2.225 ns/op
</span></span><span style="display:flex;"><span>BenchmarkAtomicStore/goroutines-4-8             342192758                3.520 ns/op
</span></span><span style="display:flex;"><span>BenchmarkAtomicStore/goroutines-8-8             213443438                5.775 ns/op
</span></span><span style="display:flex;"><span>BenchmarkAtomicStore/goroutines-16-8            218372529                5.596 ns/op
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BenchmarkMutexStore/goroutines-1-8              73933736                17.38 ns/op
</span></span><span style="display:flex;"><span>BenchmarkMutexStore/goroutines-2-8              23721489                61.15 ns/op
</span></span><span style="display:flex;"><span>BenchmarkMutexStore/goroutines-4-8              10803847               108.3 ns/op
</span></span><span style="display:flex;"><span>BenchmarkMutexStore/goroutines-8-8              11043054               110.8 ns/op
</span></span><span style="display:flex;"><span>BenchmarkMutexStore/goroutines-16-8             10729257               113.7 ns/op
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BenchmarkChannelStore/goroutines-1-8            30754740                39.72 ns/op
</span></span><span style="display:flex;"><span>BenchmarkChannelStore/goroutines-2-8            15660642               101.8 ns/op
</span></span><span style="display:flex;"><span>BenchmarkChannelStore/goroutines-4-8            25406817                52.38 ns/op
</span></span><span style="display:flex;"><span>BenchmarkChannelStore/goroutines-8-8            18875343                53.60 ns/op
</span></span><span style="display:flex;"><span>BenchmarkChannelStore/goroutines-16-8           22960464                52.04 ns/op
</span></span></code></pre></div><h2 id="加算">加算</h2>
<p>最後に atomic.AddInt64() を試す。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkAtomicAdd</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">var</span> x <span style="color:#8be9fd">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, numGoroutines <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> []<span style="color:#8be9fd">int</span>{<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">16</span>} {
</span></span><span style="display:flex;"><span>		b.<span style="color:#50fa7b">Run</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;goroutines-%d&#34;</span>, numGoroutines), <span style="color:#8be9fd;font-style:italic">func</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>			<span style="color:#8be9fd;font-style:italic">var</span> wg sync.WaitGroup
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; numGoroutines; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>				wg.<span style="color:#50fa7b">Add</span>(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; j &lt; b.N<span style="color:#ff79c6">/</span>numGoroutines; j<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>						atomic.<span style="color:#50fa7b">AddInt64</span>(<span style="color:#ff79c6">&amp;</span>x, <span style="color:#8be9fd;font-style:italic">int64</span>(j))
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			wg.<span style="color:#50fa7b">Wait</span>()
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkMutexAdd</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">var</span> x <span style="color:#8be9fd">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">var</span> mu sync.RWMutex
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, numGoroutines <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> []<span style="color:#8be9fd">int</span>{<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">16</span>} {
</span></span><span style="display:flex;"><span>		b.<span style="color:#50fa7b">Run</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;goroutines-%d&#34;</span>, numGoroutines), <span style="color:#8be9fd;font-style:italic">func</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>			<span style="color:#8be9fd;font-style:italic">var</span> wg sync.WaitGroup
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; numGoroutines; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>				wg.<span style="color:#50fa7b">Add</span>(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; j &lt; b.N<span style="color:#ff79c6">/</span>numGoroutines; j<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>						mu.<span style="color:#50fa7b">Lock</span>()
</span></span><span style="display:flex;"><span>						x <span style="color:#ff79c6">+=</span> <span style="color:#8be9fd;font-style:italic">int64</span>(j)
</span></span><span style="display:flex;"><span>						mu.<span style="color:#50fa7b">Unlock</span>()
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			wg.<span style="color:#50fa7b">Wait</span>()
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	_ = x
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkChannelAdd</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, numGoroutines <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> []<span style="color:#8be9fd">int</span>{<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">16</span>} {
</span></span><span style="display:flex;"><span>		b.<span style="color:#50fa7b">Run</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;goroutines-%d&#34;</span>, numGoroutines), <span style="color:#8be9fd;font-style:italic">func</span>(b <span style="color:#ff79c6">*</span>testing.B) {
</span></span><span style="display:flex;"><span>			<span style="color:#8be9fd;font-style:italic">var</span> wg sync.WaitGroup
</span></span><span style="display:flex;"><span>			ch <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int64</span>, b.N)
</span></span><span style="display:flex;"><span>			done <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">bool</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			b.<span style="color:#50fa7b">ResetTimer</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>				<span style="color:#8be9fd;font-style:italic">var</span> x <span style="color:#8be9fd">int64</span>
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> ch {
</span></span><span style="display:flex;"><span>					x <span style="color:#ff79c6">+=</span> j
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				done <span style="color:#ff79c6">&lt;-</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>			}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; numGoroutines; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>				wg.<span style="color:#50fa7b">Add</span>(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; j &lt; b.N<span style="color:#ff79c6">/</span>numGoroutines; j<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>						ch <span style="color:#ff79c6">&lt;-</span> <span style="color:#8be9fd;font-style:italic">int64</span>(j)
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			wg.<span style="color:#50fa7b">Wait</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#8be9fd;font-style:italic">close</span>(ch)
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&lt;-</span>done
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>atomic の実行時間が増えて channel との差が 2 倍未満まで狭まった。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># go test -bench=. -cpu=8
</span></span><span style="display:flex;"><span>BenchmarkAtomicAdd/goroutines-1-8               298405735                3.840 ns/op
</span></span><span style="display:flex;"><span>BenchmarkAtomicAdd/goroutines-2-8               100000000               12.98 ns/op
</span></span><span style="display:flex;"><span>BenchmarkAtomicAdd/goroutines-4-8               70431834                17.26 ns/op
</span></span><span style="display:flex;"><span>BenchmarkAtomicAdd/goroutines-8-8               34193878                35.93 ns/op
</span></span><span style="display:flex;"><span>BenchmarkAtomicAdd/goroutines-16-8              34694154                36.35 ns/op
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BenchmarkMutexAdd/goroutines-1-8                71619702                16.14 ns/op
</span></span><span style="display:flex;"><span>BenchmarkMutexAdd/goroutines-2-8                20886546                67.79 ns/op
</span></span><span style="display:flex;"><span>BenchmarkMutexAdd/goroutines-4-8                10610626               113.9 ns/op
</span></span><span style="display:flex;"><span>BenchmarkMutexAdd/goroutines-8-8                10662531               111.8 ns/op
</span></span><span style="display:flex;"><span>BenchmarkMutexAdd/goroutines-16-8               10869400               111.1 ns/op
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BenchmarkChannelAdd/goroutines-1-8              30208658                39.65 ns/op
</span></span><span style="display:flex;"><span>BenchmarkChannelAdd/goroutines-2-8              10090827               144.2 ns/op
</span></span><span style="display:flex;"><span>BenchmarkChannelAdd/goroutines-4-8              23074944                52.90 ns/op
</span></span><span style="display:flex;"><span>BenchmarkChannelAdd/goroutines-8-8              23826226                53.23 ns/op
</span></span><span style="display:flex;"><span>BenchmarkChannelAdd/goroutines-16-8             23380171                51.86 ns/op
</span></span></code></pre></div>
    </div>
  </article>
</div>

</div>
</body>

</html>