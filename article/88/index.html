<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="Hugo 0.17" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/magula.min.css">
    <link rel="stylesheet" href="/css/slidebars.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://sambaiz.net/index.xml">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@sambaiz">
    
    <title>HoloLensのSharing - sambaiz.net</title>
    <meta name="twitter:title" content="HoloLensのSharing - sambaiz.net">
    <meta property='og:title' content="HoloLensのSharing - sambaiz.net">
    <meta property="og:type" content="article">
    
    

    <meta property="og:url" content="http://sambaiz.net/article/88/">
    <meta property="og:image" content="http://sambaiz.net/images/my_l.jpg">
    <meta name="twitter:image" content="http://sambaiz.net/images/my.jpg" />
    <meta name="google-site-verification" content="CEqNYjzc4Y7hb3FY7uUkmllGzeDc40brBwQJixeH61Q" />

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id":"http:\/\/sambaiz.net\/"
    },
    "headline": "HoloLensのSharing | sambaiz.net ",
    "datePublished": "2017-03-25T22:20:00JST",
    "dateModified": "2017-03-25T22:20:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "image": "http:\/\/sambaiz.net\/images/my.jpg"
    },
    "publisher": {
      "@type": "Organization",
      "name": "sambaiz.net",
      "logo": {
        "@type": "ImageObject",
        "url": "http:\/\/sambaiz.net\/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "http:\/\/sambaiz.net\/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": ""
  }
</script>
</head>

<body>
  <div off-canvas="id-1 left reveal">
  
  <ul class="tag-list">
    
  </ul>
  
  <ul class="tag-list">
    <li><a href="http://sambaiz.net/tags/golang">golang</a></li><li><a href="http://sambaiz.net/tags/log">log</a></li><li><a href="http://sambaiz.net/tags/aws">aws</a></li><li><a href="http://sambaiz.net/tags/fluentd">fluentd</a></li><li><a href="http://sambaiz.net/tags/unity">unity</a></li><li><a href="http://sambaiz.net/tags/docker">docker</a></li><li><a href="http://sambaiz.net/tags/elasticsearch">elasticsearch</a></li><li><a href="http://sambaiz.net/tags/infra">infra</a></li><li><a href="http://sambaiz.net/tags/node.js">node.js</a></li><li><a href="http://sambaiz.net/tags/tensorflow">tensorflow</a></li><li><a href="http://sambaiz.net/tags/gcp">gcp</a></li><li><a href="http://sambaiz.net/tags/k8s">k8s</a></li><li><a href="http://sambaiz.net/tags/android">android</a></li><li><a href="http://sambaiz.net/tags/angular">angular</a></li><li><a href="http://sambaiz.net/tags/cron">cron</a></li><li><a href="http://sambaiz.net/tags/hololens">hololens</a></li><li><a href="http://sambaiz.net/tags/linux">linux</a></li><li><a href="http://sambaiz.net/tags/mysql">mysql</a></li><li><a href="http://sambaiz.net/tags/web">web</a></li><li><a href="http://sambaiz.net/tags/.net">.net</a></li><li><a href="http://sambaiz.net/tags/ble">ble</a></li><li><a href="http://sambaiz.net/tags/javascript">javascript</a></li><li><a href="http://sambaiz.net/tags/product">product</a></li><li><a href="http://sambaiz.net/tags/react">react</a></li><li><a href="http://sambaiz.net/tags/vr">vr</a></li><li><a href="http://sambaiz.net/tags/api">api</a></li><li><a href="http://sambaiz.net/tags/csharp">csharp</a></li><li><a href="http://sambaiz.net/tags/css">css</a></li><li><a href="http://sambaiz.net/tags/d3.js">d3.js</a></li><li><a href="http://sambaiz.net/tags/firebase">firebase</a></li><li><a href="http://sambaiz.net/tags/grpc">grpc</a></li><li><a href="http://sambaiz.net/tags/hugo">hugo</a></li><li><a href="http://sambaiz.net/tags/ios">ios</a></li><li><a href="http://sambaiz.net/tags/jenkins">jenkins</a></li><li><a href="http://sambaiz.net/tags/jvm">jvm</a></li><li><a href="http://sambaiz.net/tags/leveldb">leveldb</a></li><li><a href="http://sambaiz.net/tags/neo4j">neo4j</a></li><li><a href="http://sambaiz.net/tags/oauth">oauth</a></li><li><a href="http://sambaiz.net/tags/rx">rx</a></li><li><a href="http://sambaiz.net/tags/rxjs">rxjs</a></li><li><a href="http://sambaiz.net/tags/server">server</a></li><li><a href="http://sambaiz.net/tags/uwp">uwp</a></li><li><a href="http://sambaiz.net/tags/video">video</a></li>
  </ul>
  
</div>

  <div canvas="container" id="container">
    <header>
      <button type="button" class="btn toggle-side">TAG</button>

      <div class="title">
        <img src="http://sambaiz.net/images/my.png" width="60px" height="60px" />
        <a class="nl" href="http://sambaiz.net/">sambaiz.net</a>
      </div>

      <div class="sns">
        <a class="nl" href="https://twitter.com/sambaiz"><i class="fa fa-2x fa-twitter"></i></a>
        <a class="nl" href="https://github.com/sambaiz"><i class="fa fa-2x fa-github"></i></a>
      </div>
    </header>


<div class="container">

  <div class="row">
    <div class="col-md-12">

      <article class="single">
        <div class="single body">
          <h1>HoloLensのSharing</h1>
          <p>(2017-03-25)</p>
          

<ul>
<li>HoloToolkit-Unity v1.5.5.0</li>
</ul>

<h2 id="サーバー">サーバー</h2>

<p>SharingService.exeを
<a href="https://github.com/Microsoft/HoloToolkit-Unity/tree/v1.5.5.0/External/HoloToolkit/Sharing/Server">ここ</a>
からとってきて実行する。開発に使っているHoloToolkitと同じリリースバージョンのものを使う。</p>

<pre><code>&gt; SharingService.exe -local
...
SharingService: Listening for session list connections on port 20602 of all network devices of the local machine.
SharingService: Local IP addresses are:
SharingService:         xxx.xxx.xxx.xxx
SharingService: Created Session &quot;Default&quot; with ID 0 on port 20601
</code></pre>

<p>今日のTokyo Hololens Meetup Vol.2の開発者セッションで、
ちょうどSharingの話があったのだけれど、残念ながら先着順で出遅れて聞けなかった。</p>

<p>Tweetを見る限りだとカスタマイズできず、スケーリングできないSharingService.exeは使わずに
<a href="https://github.com/neuecc/MagicOnion">MagicOnion</a>というのを自前で作ったらしい。</p>

<p><a href="https://togetter.com/li/1094037">Tokyo Hololens MeetuUp Vol.2 Session5 #HoloLensJP #TMCN - Togetterまとめ</a></p>

<h2 id="クライアント-https-github-com-microsoft-holotoolkit-unity-blob-v1-5-5-0-assets-holotoolkit-sharing"><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing">クライアント</a></h2>

<p><code>Assets/HoloToolkit/Sharing/Tests</code>のSceneで試してみる。</p>

<p>以下のcapabilitiesを設定し、</p>

<ul>
<li>SpatialPerception</li>
<li>InternetClient</li>
</ul>

<p>SharingのServer Addressを設定してビルド。ほかにはこんな設定がある。</p>

<ul>
<li><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing/Scripts/SharingStage.cs#L15">Client Role</a>

<ul>
<li>Primary: 直接セッションサーバーに接続し、セッションを管理する</li>
<li>Secondary: Primaryクライアントに接続して、セッション管理は任せる</li>
</ul></li>
<li>Server Address</li>
<li>Port</li>
<li>Auto Discover Server</li>
<li>Session Name</li>
</ul>

<p>起動して以下のようなエラーが出たらSharingService.exeがHoloToolkitのバージョンと合っていない。</p>

<pre><code>List Server Handshake Failed: Invalid schema version.
Expected: 17, got 15
Please sync to latest XTools
</code></pre>

<p>接続と離脱のメッセージはこんな感じ。</p>

<pre><code>SharingService: User UnknownUser at address xxx.xxx.xxx.xxx joined session Default
SharingService: User UnknownUser left session Default
</code></pre>

<p>2つ以上クライアントを立ち上げると、他のクライアントの、球からの相対的な頭の位置にCubeが映った。</p>

<p><img src="http://sambaiz.net/images/88-sharing.jpg" alt="他のクライアントの頭の位置にCubeがある" /></p>

<p>が、球の場所が空間に対して同期されない・・・。</p>

<p>原因を探るために、
TestsのSceneと同様に、SharingのPrefabにCustomMessage.csを、
適当なGameObjectにImportExportAnchorManager.csとRemoteHeadManager.csと
目印になるオブジェクトを追加し、
ImportExportAnchorManager.csにこんな感じのを追加してcurrentStateを表示してみた。</p>

<pre><code>public GameObject statusText;
private void Update()
{
    statusText.GetComponent&lt;TextMesh&gt;().text = currentState.ToString();
    ...
}
</code></pre>

<p>結果、起動してからまだReady状態になっていなかったことが分かった。
少し待ってみるといろんな状態を経て、Ready状態になると、
目印のオブジェクトが物理的に同じところに移動し、頭の位置も正しいところに移動した。</p>

<p><img src="http://sambaiz.net/images/88-sharing2.png" alt="Sharingしている状態" /></p>

<hr />

<p>なにをやっているか見ていく。</p>

<p>まずは拾えるevent。</p>

<p><a href="http://sambaiz.net/article/83/">C#のdelegateとevent - sambaiz.net</a></p>

<h2 id="sharingsessiontracker-https-github-com-microsoft-holotoolkit-unity-blob-v1-5-5-0-assets-holotoolkit-sharing-scripts-sharingsessiontracker-cs"><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing/Scripts/SharingSessionTracker.cs">SharingSessionTracker</a></h2>

<ul>
<li>public event EventHandler<SessionJoinedEventArgs> SessionJoined;</li>
</ul>

<p>ユーザーがセッションに入ったとき。</p>

<pre><code>public class SessionJoinedEventArgs : EventArgs
{
    public User joiningUser;
}
</code></pre>

<ul>
<li>public event EventHandler<SessionLeftEventArgs> SessionLeft;</li>
</ul>

<p>セッションから出たとき。</p>

<pre><code>public class SessionLeftEventArgs : EventArgs
{
    public long exitingUserId;
}
</code></pre>

<h2 id="sharingstage-https-github-com-microsoft-holotoolkit-unity-blob-v1-5-5-0-assets-holotoolkit-sharing-scripts-sharingstage-cs"><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing/Scripts/SharingStage.cs">SharingStage</a></h2>

<ul>
<li>public event EventHandler SharingManagerConnected;</li>
</ul>

<p>SharingManagerが接続されたとき。ArgsはEmpty。</p>

<pre><code>connectedEvent(this, EventArgs.Empty);
</code></pre>

<hr />

<p>これらのeventをsubscribeしているTestsの中のコード。</p>

<h2 id="custommessages-https-github-com-microsoft-holotoolkit-unity-blob-v1-5-5-0-assets-holotoolkit-sharing-tests-custommessages-cs"><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing/Tests/CustomMessages.cs">CustomMessages</a></h2>

<p>データを送受信するところ。</p>

<h3 id="初期化-https-github-com-microsoft-holotoolkit-unity-blob-v1-5-5-0-assets-holotoolkit-sharing-tests-custommessages-cs-l57"><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing/Tests/CustomMessages.cs#L57">初期化</a></h3>

<p>SharingManagerが接続されたら初期化がはじまる。</p>

<pre><code>void Start()
{
    SharingStage.Instance.SharingManagerConnected += SharingManagerConnected;
}

private void SharingManagerConnected(object sender, EventArgs e)
{
    InitializeMessageHandlers();
}
</code></pre>

<p>まず、ServerとのConnectionを取得し、Messageを受信したときのeventをsubscribeしている。</p>

<pre><code>SharingStage sharingStage = SharingStage.Instance;
serverConnection = sharingStage.Manager.GetServerConnection();
connectionAdapter = new NetworkConnectionAdapter();
connectionAdapter.MessageReceivedCallback += OnMessageReceived;
</code></pre>

<p>それから自分自身のユーザーIDも保存してある。これはMessageを送るときに使う。</p>

<pre><code>localUserID = SharingStage.Instance.Manager.GetLocalUser().GetID();
</code></pre>

<p>最後に<code>MessageHandlers</code>にnullを詰めて終わり。</p>

<pre><code>for (byte index = (byte)TestMessageID.HeadTransform; index &lt; (byte)TestMessageID.Max; index++)
{
    if (MessageHandlers.ContainsKey((TestMessageID)index) == false)
    {
        MessageHandlers.Add((TestMessageID)index, null);
    }

    serverConnection.AddListener(index, connectionAdapter);
}
</code></pre>

<p>後からこういう風にhandlerを設定している。</p>

<pre><code>CustomMessages.Instance.MessageHandlers[CustomMessages.TestMessageID.HeadTransform] = this.UpdateHeadTransform;
</code></pre>

<h3 id="受信">受信</h3>

<p>messageTypeに対応したhandlerに渡す。初期状態では全てnullなので何もしない。</p>

<pre><code>void OnMessageReceived(NetworkConnection connection, NetworkInMessage msg)
{
    byte messageType = msg.ReadByte();
    MessageCallback messageHandler = MessageHandlers[(TestMessageID)messageType];
    if (messageHandler != null)
    {
        messageHandler(msg);
    }
}
</code></pre>

<h3 id="送信">送信</h3>

<pre><code>CustomMessages.Instance.SendStageTransform(transform.localPosition, transform.localRotation);
CustomMessages.Instance.SendHeadTransform(headPosition, headRotation);
</code></pre>

<p>こんな感じにBroadcastしている。</p>

<pre><code>public void SendHeadTransform(Vector3 position, Quaternion rotation)
{
    // If we are connected to a session, broadcast our head info
    if (serverConnection != null &amp;&amp; serverConnection.IsConnected())
    {
        // Create an outgoing network message to contain all the info we want to send
        NetworkOutMessage msg = CreateMessage((byte)TestMessageID.HeadTransform);

        AppendTransform(msg, position, rotation);

        // Send the message as a broadcast, which will cause the server to forward it to all other users in the session.
        serverConnection.Broadcast(
            msg,
            MessagePriority.Immediate,
            MessageReliability.UnreliableSequenced,
            MessageChannel.Avatar);
    }
}
</code></pre>

<h2 id="importexportanchormanager-https-github-com-microsoft-holotoolkit-unity-blob-v1-5-5-0-assets-holotoolkit-sharing-tests-importexportanchormanager-cs"><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing/Tests/ImportExportAnchorManager.cs">ImportExportAnchorManager</a></h2>

<p>オブジェクトのpositionを物理的に固定する<a href="https://docs.unity3d.com/ScriptReference/VR.WSA.WorldAnchor.html">WorldAnchor</a>を共有する。</p>

<p><code>currentState</code>は最初<code>AnchorStore_Initializing</code>で、
<code>anchorStore</code>が取得できたら<code>AnchorStore_Initialized</code>になる。</p>

<pre><code>private ImportExportState currentState = ImportExportState.Start;

// インスタンスがロードされたときに呼ばれる。コンストラクターの代わり
protected override void Awake()
{
    base.Awake();
    Debug.Log(&quot;Import Export Manager starting&quot;);
    // We need to get our local anchor store started up.
    currentState = ImportExportState.AnchorStore_Initializing;
    WorldAnchorStore.GetAsync(AnchorStoreReady);
}

private void AnchorStoreReady(WorldAnchorStore store)
{
    anchorStore = store;
    currentState = ImportExportState.AnchorStore_Initialized;
}

private void Start()
{
    SharingStage.Instance.SharingManagerConnected += SharingManagerConnected;
    SharingSessionTracker.Instance.SessionJoined += Instance_SessionJoined;
}
</code></pre>

<p>SharingManagerが接続されたら、RoomManagerのインスタンスを取得して、
Anchorのダウンロードとアップロードしたときのeventをsubscribeしている。</p>

<p>Uploaded時は<code>currentState</code>を<code>Ready</code>にし、
Downloaded時は<code>rawAnchorData</code>に保存し、<code>currentState</code>を<code>DataReady</code>にする。</p>

<pre><code>private void SharingManagerConnected(object sender, EventArgs e)
{
    // Setup the room manager callbacks.
    roomManager = SharingStage.Instance.Manager.GetRoomManager();
    roomManagerCallbacks = new RoomManagerAdapter();

    roomManagerCallbacks.AnchorsDownloadedEvent += RoomManagerCallbacks_AnchorsDownloaded;
    roomManagerCallbacks.AnchorUploadedEvent += RoomManagerCallbacks_AnchorUploaded;
    roomManager.AddListener(roomManagerCallbacks);
}

private void RoomManagerCallbacks_AnchorUploaded(bool successful, XString failureReason)
{
    if (successful)
    {
        currentState = ImportExportState.Ready;
    }
    else
    {
        Debug.Log(&quot;Upload failed &quot; + failureReason);
        currentState = ImportExportState.Failed;
    }
}

private byte[] rawAnchorData = null;

private void RoomManagerCallbacks_AnchorsDownloaded(bool successful, AnchorDownloadRequest request, XString failureReason)
{
    // If we downloaded anchor data successfully we should import the data.
    if (successful)
    {
        int datasize = request.GetDataSize();
        Debug.Log(datasize + &quot; bytes &quot;);
        rawAnchorData = new byte[datasize];

        request.GetData(rawAnchorData, datasize);
        currentState = ImportExportState.DataReady;
    }
    else
    {
        // If we failed, we can ask for the data again.
        Debug.Log(&quot;Anchor DL failed &quot; + failureReason);
        MakeAnchorDataRequest();
    }
}
</code></pre>

<p>SessionJoin時には、<code>sharingServiceReady</code>をtrueにする。</p>

<p><code>InitRoomApi()</code>では<code>currentRoom</code>にJoin(あるいは新しく作る)し、Roomを代入している。</p>

<p><code>currentState</code>は新しくRoomを作った場合<code>InitialAnchorRequired</code>で、すでにあるRoomに入った場合<code>RoomApiInitialized</code>になる。</p>

<pre><code>private bool sharingServiceReady = false;
private Room currentRoom;

private void Instance_SessionJoined(object sender, SharingSessionTracker.SessionJoinedEventArgs e)
{
    SharingSessionTracker.Instance.SessionJoined -= Instance_SessionJoined;

    // ほかの処理が落ち着くまで5秒待って実行する
    Invoke(&quot;MarkSharingServiceReady&quot;, 5);
}

private void MarkSharingServiceReady()
{
    sharingServiceReady = true;

#if UNITY_EDITOR || UNITY_STANDALONE
    InitRoomApi();
#endif
}

private void InitRoomApi()
{
    if (roomManager.GetRoomCount() == 0)
    {
        if (LocalUserHasLowestUserId())
        {
            Debug.Log(&quot;Creating room &quot;);            
            currentRoom = roomManager.CreateRoom(new XString(&quot;DefaultRoom&quot;), roomID, false);
            currentState = ImportExportState.InitialAnchorRequired;
        }
    }
    else
    {
        Debug.Log(&quot;Joining room &quot;);
        currentRoom = roomManager.GetRoom(0);
        roomManager.JoinRoom(currentRoom);
        currentState = ImportExportState.RoomApiInitialized;
    }
}
</code></pre>

<p>Update。ここで<code>currentState</code>を見ている。ここまでの<code>currentState</code>をまとめると、</p>

<ul>
<li>AnchorStore_Initializing: 初期状態</li>
<li>AnchorStore_Initialized: AnchorStore取得完了</li>
<li>InitialAnchorRequired: 新しくRoomを作った(のでWorldAnchorを生成する)</li>
<li>RoomApiInitialized: すでにあるRoomに入った</li>
<li>Ready: Upload完了</li>
<li>DataReady: Download完了</li>
</ul>

<p>こんな感じ。</p>

<pre><code>private void Update()
{
    switch (currentState)
    {
        case ImportExportState.AnchorStore_Initialized:
            if (sharingServiceReady)
            {
                InitRoomApi();
            }
            break;
        case ImportExportState.RoomApiInitialized:
            StartAnchorProcess();
            break;
        case ImportExportState.DataReady:
            // DataReady is set when the anchor download completes.
            currentState = ImportExportState.Importing;
            WorldAnchorTransferBatch.ImportAsync(rawAnchorData, ImportComplete);
            break;
        case ImportExportState.InitialAnchorRequired:
            currentState = ImportExportState.CreatingInitialAnchor;
            CreateAnchorLocally();
            break;
        case ImportExportState.ReadyToExportInitialAnchor:
            // We've created an anchor locally and it is ready to export.
            currentState = ImportExportState.UploadingInitialAnchor;
            Export();
            break;
    }
}
</code></pre>

<p>Roomを新しく作ったならWorldAnchorを作成する必要がある。
<a href="https://docs.unity3d.com/ScriptReference/VR.WSA.WorldAnchor-isLocated.html">isLocated</a>がtrueになったら
<code>OnTrackingChanged_InitialAnchor</code>にし、AnchorをUploadする。</p>

<pre><code>private void CreateAnchorLocally()
{
    WorldAnchor anchor = GetComponent&lt;WorldAnchor&gt;();
    if (anchor == null)
    {
        anchor = gameObject.AddComponent&lt;WorldAnchor&gt;();
    }

    if (anchor.isLocated)
    {
        currentState = ImportExportState.ReadyToExportInitialAnchor;
    }
    else
    {
        anchor.OnTrackingChanged += Anchor_OnTrackingChanged_InitialAnchor;
    }
}

private void Anchor_OnTrackingChanged_InitialAnchor(WorldAnchor self, bool located)
{
    if (located)
    {
        Debug.Log(&quot;Found anchor, ready to export&quot;);
        currentState = ImportExportState.ReadyToExportInitialAnchor;
    }
    else
    {
        Debug.Log(&quot;Failed to locate local anchor (super bad!)&quot;);
        currentState = ImportExportState.Failed;
    }

    self.OnTrackingChanged -= Anchor_OnTrackingChanged_InitialAnchor;
}
</code></pre>

<p><code>anchorStore</code>に保存して、SerializeしてUploadする。</p>

<pre><code>private void Export()
{
    WorldAnchor anchor = GetComponent&lt;WorldAnchor&gt;();

    string guidString = Guid.NewGuid().ToString();
    exportingAnchorName = guidString;

    // Save the anchor to our local anchor store.
    if (anchorStore.Save(exportingAnchorName, anchor))
    {
        sharedAnchorInterface = new WorldAnchorTransferBatch();
        sharedAnchorInterface.AddWorldAnchor(guidString, anchor);
        WorldAnchorTransferBatch.ExportAsync(sharedAnchorInterface, WriteBuffer, ExportComplete);
    }
    else
    {
        Debug.Log(&quot;This anchor didn't work, trying again&quot;);
        currentState = ImportExportState.InitialAnchorRequired;
    }
}

public void ExportComplete(SerializationCompletionReason status)
{
    if (status == SerializationCompletionReason.Succeeded &amp;&amp; exportingAnchorBytes.Count &gt; minTrustworthySerializedAnchorDataSize)
    {
        Debug.Log(&quot;Uploading anchor: &quot; + exportingAnchorName);
        roomManager.UploadAnchor(
            currentRoom,
            new XString(exportingAnchorName),
            exportingAnchorBytes.ToArray(),
            exportingAnchorBytes.Count);
    }
    else
    {
        Debug.Log(&quot;This anchor didn't work, trying again&quot;);
        currentState = ImportExportState.InitialAnchorRequired;
    }
}
</code></pre>

<p>もしすでにあるRoomにJoinしている(<code>RoomApiInitialized</code>)なら、Anchorをダウンロードし始め、<code>DataRequested</code>になる。
ダウンロードしたら<code>DataReady</code>になって、AnchorデータをImportする。</p>

<pre><code>private void StartAnchorProcess()
{
    // First, are there any anchors in this room?
    int anchorCount = currentRoom.GetAnchorCount();

    // If there are anchors, we should attach to the first one.
    if (anchorCount &gt; 0)
    {
        // Extract the name of the anchor.
        XString storedAnchorString = currentRoom.GetAnchorName(0);
        string storedAnchorName = storedAnchorString.GetString();

        // Attempt to attach to the anchor in our local anchor store.
        if (AttachToCachedAnchor(storedAnchorName) == false)
        {
            MakeAnchorDataRequest();
        }
    }
}

private void MakeAnchorDataRequest()
{
    if (roomManager.DownloadAnchor(currentRoom, currentRoom.GetAnchorName(0)))
    {
        currentState = ImportExportState.DataRequested;
    }
    else
    {
        Debug.Log(&quot;Couldn't make the download request.&quot;);
        currentState = ImportExportState.Failed;
    }
}
</code></pre>

<p>Import完了したら<code>anchorStore</code>に保存し、<code>Ready</code>にする。</p>

<pre><code>private void ImportComplete(SerializationCompletionReason status, WorldAnchorTransferBatch wat)
{
    if (status == SerializationCompletionReason.Succeeded &amp;&amp; wat.GetAllIds().Length &gt; 0)
    {
        Debug.Log(&quot;Import complete&quot;);

        string first = wat.GetAllIds()[0];
        Debug.Log(&quot;Anchor name: &quot; + first);

        WorldAnchor anchor = wat.LockObject(first, gameObject);
        anchorStore.Save(first, anchor);
        currentState = ImportExportState.Ready;
    }
    else
    {
        Debug.Log(&quot;Import fail&quot;);
        currentState = ImportExportState.DataReady;
    }
}
</code></pre>

<h2 id="remoteheadmanager-https-github-com-microsoft-holotoolkit-unity-blob-v1-5-5-0-assets-holotoolkit-sharing-tests-remoteheadmanager-cs"><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing/Tests/RemoteHeadManager.cs">RemoteHeadManager</a></h2>

<p>他のユーザーの頭の位置にオブジェクトを表示させる。</p>

<p>受信時のhandlerを設定し、eventをsubscribeする。</p>

<pre><code>void Start()
{
    CustomMessages.Instance.MessageHandlers[CustomMessages.TestMessageID.HeadTransform] = this.UpdateHeadTransform;

    SharingSessionTracker.Instance.SessionJoined += Instance_SessionJoined;
    SharingSessionTracker.Instance.SessionLeft += Instance_SessionLeft;
}
</code></pre>

<p>joinしたのが自分自身じゃないかチェック。</p>

<pre><code>private void Instance_SessionJoined(object sender, SharingSessionTracker.SessionJoinedEventArgs e)
{
    if (e.joiningUser.GetID() != SharingStage.Instance.Manager.GetLocalUser().GetID())
    {
        GetRemoteHeadInfo(e.joiningUser.GetID());
    }
}
</code></pre>

<p><code>remoteHeads</code>になければ、HeadObjectを作成し、追加する。</p>

<pre><code>public RemoteHeadInfo GetRemoteHeadInfo(long userID)
{
    RemoteHeadInfo headInfo;

    // Get the head info if its already in the list, otherwise add it
    if (!this.remoteHeads.TryGetValue(userID, out headInfo))
    {
        headInfo = new RemoteHeadInfo();
        headInfo.UserID = userID;
        headInfo.HeadObject = CreateRemoteHead();

        this.remoteHeads.Add(userID, headInfo);
    }

    return headInfo;
}
</code></pre>

<p>Sessionから離れたときはオブジェクトを削除し、remoteHeadsから取り除く。</p>

<pre><code>private void Instance_SessionLeft(object sender, SharingSessionTracker.SessionLeftEventArgs e)
{
    if (e.exitingUserId != SharingStage.Instance.Manager.GetLocalUser().GetID())
    {
        RemoveRemoteHead(this.remoteHeads[e.exitingUserId].HeadObject);
        this.remoteHeads.Remove(e.exitingUserId);
    }
}

void RemoveRemoteHead(GameObject remoteHeadObject)
{
    DestroyImmediate(remoteHeadObject);
}
</code></pre>

<p>受信時のhandlerではMessageからpositionとquarternionを取得し、オブジェクトの位置を動かしている。</p>

<pre><code>void UpdateHeadTransform(NetworkInMessage msg)
{
    // Parse the message
    long userID = msg.ReadInt64();

    Vector3 headPos = CustomMessages.Instance.ReadVector3(msg);

    Quaternion headRot = CustomMessages.Instance.ReadQuaternion(msg);

    RemoteHeadInfo headInfo = GetRemoteHeadInfo(userID);
    headInfo.HeadObject.transform.localPosition = headPos;
    headInfo.HeadObject.transform.localRotation = headRot;
}
</code></pre>

<p>自分の頭の位置はUpdate()で送信している。</p>

<pre><code>void Update()
{
    // Grab the current head transform and broadcast it to all the other users in the session
    Transform headTransform = Camera.main.transform;

    // Transform the head position and rotation from world space into local space
    Vector3 headPosition = this.transform.InverseTransformPoint(headTransform.position);
    Quaternion headRotation = Quaternion.Inverse(this.transform.rotation) * headTransform.rotation;

    CustomMessages.Instance.SendHeadTransform(headPosition, headRotation);
}
</code></pre>

<h2 id="ライセンス">ライセンス</h2>

<pre><code>MIT License

Copyright (c) 2016 Microsoft Corporation

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
</code></pre>

        </div>
      </article>
    </div>
  </div>
</div>

</div> 
<script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script src="/js/slidebars.min.js"></script>
<script>
    ( function ( $ ) {
      
      var controller = new slidebars();
      controller.init();

      $( '.toggle-side' ).on( 'click', function ( event ) {
          event.stopPropagation();
          event.preventDefault();

          controller.toggle( 'id-1' );
        } );

        $( '#container' ).on( 'click', function ( event ) {
            controller.close( 'id-1' );
          });
    } ) ( jQuery );
</script>

<script>hljs.initHighlightingOnLoad();</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-39190067-3', 'auto');
ga('send', 'pageview');
</script>


  </body>
</html>

