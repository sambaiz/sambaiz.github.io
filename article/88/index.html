<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="generator" content="Hugo 0.75.1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 30px;
        height: 30px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.5rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 20px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single p>code {
        background-color: #eee;
        color: #333;
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {}

    .single hr {}
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>HoloLensのSharing - sambaiz-net</title>
  <meta name="twitter:title" content="HoloLensのSharing - sambaiz-net">
  <meta property='og:title' content="HoloLensのSharing - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="Sharing">
  <meta name="twitter:description" content="Sharing">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/article/88/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />
  <meta name="google-site-verification" content="CEqNYjzc4Y7hb3FY7uUkmllGzeDc40brBwQJixeH61Q" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id":"https:\/\/www.sambaiz.net\/"
    },
    "headline": "HoloLensのSharing - sambaiz-net",
    "datePublished": "2017-03-25T22:20:00JST",
    "dateModified": "2017-03-25T22:20:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "image": "https:\/\/www.sambaiz.net\/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https:\/\/www.sambaiz.net\/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https:\/\/www.sambaiz.net\/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "Sharing"
  }
</script>
</head>

<body>
  <div>
    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="アイコン" />
        <a class="nl" href="https://www.sambaiz.net/">
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://twitter.com/sambaiz">
            <img src="//www.sambaiz.net/image/twitter.png" width="30px" height="30px" alt="twitter">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="//www.sambaiz.net/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a href="https://filmarks.com/users/sambaiz" class="filmarks" aria-label="filmarks"></a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>HoloLensのSharing</h1>
        <time>2017-03-25</time>
      </div>
      <ul>
<li>HoloToolkit-Unity v1.5.5.0</li>
</ul>
<h2 id="サーバー">サーバー</h2>
<p>SharingService.exeを
<a href="https://github.com/Microsoft/HoloToolkit-Unity/tree/v1.5.5.0/External/HoloToolkit/Sharing/Server">ここ</a>
からとってきて実行する。開発に使っているHoloToolkitと同じリリースバージョンのものを使う。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">&gt; SharingService.exe -local
...
SharingService: Listening for session list connections on port 20602 of all network devices of the local machine.
SharingService: Local IP addresses are:
SharingService:         xxx.xxx.xxx.xxx
SharingService: Created Session &#34;Default&#34; with ID 0 on port 20601
</code></pre></div><p>今日のTokyo Hololens Meetup Vol.2の開発者セッションで、
ちょうどSharingの話があったのだけれど、残念ながら先着順で出遅れて聞けなかった。</p>
<p>Tweetを見る限りだとカスタマイズできず、スケーリングできないSharingService.exeは使わずに
<a href="https://github.com/neuecc/MagicOnion">MagicOnion</a>というのを自前で作ったらしい。</p>
<p><a href="https://togetter.com/li/1094037">Tokyo Hololens MeetuUp Vol.2 Session5 #HoloLensJP #TMCN - Togetterまとめ</a></p>
<h2 id="クライアントhttpsgithubcommicrosoftholotoolkit-unityblobv1550assetsholotoolkitsharing"><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing">クライアント</a></h2>
<p><code>Assets/HoloToolkit/Sharing/Tests</code>のSceneで試してみる。</p>
<p>以下のcapabilitiesを設定し、</p>
<ul>
<li>SpatialPerception</li>
<li>InternetClient</li>
</ul>
<p>SharingのServer Addressを設定してビルド。ほかにはこんな設定がある。</p>
<ul>
<li><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing/Scripts/SharingStage.cs#L15">Client Role</a>
<ul>
<li>Primary: 直接セッションサーバーに接続し、セッションを管理する</li>
<li>Secondary: Primaryクライアントに接続して、セッション管理は任せる</li>
</ul>
</li>
<li>Server Address</li>
<li>Port</li>
<li>Auto Discover Server</li>
<li>Session Name</li>
</ul>
<p>起動して以下のようなエラーが出たらSharingService.exeがHoloToolkitのバージョンと合っていない。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">List Server Handshake Failed: Invalid schema version.
Expected: 17, got 15
Please sync to latest XTools
</code></pre></div><p>接続と離脱のメッセージはこんな感じ。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">SharingService: User UnknownUser at address xxx.xxx.xxx.xxx joined session Default
SharingService: User UnknownUser left session Default
</code></pre></div><p>2つ以上クライアントを立ち上げると、他のクライアントの、球からの相対的な頭の位置にCubeが映った。</p>
<p><img src="https://www.sambaiz.net/images/88-sharing.jpg" alt="他のクライアントの頭の位置にCubeがある"></p>
<p>が、球の場所が空間に対して同期されない・・・。</p>
<p>原因を探るために、
TestsのSceneと同様に、SharingのPrefabにCustomMessage.csを、
適当なGameObjectにImportExportAnchorManager.csとRemoteHeadManager.csと
目印になるオブジェクトを追加し、
ImportExportAnchorManager.csにこんな感じのを追加してcurrentStateを表示してみた。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">public</span> GameObject statusText;
<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> Update()
{
    statusText.GetComponent&lt;TextMesh&gt;().text = currentState.ToString();
    ...
}
</code></pre></div><p>結果、起動してからまだReady状態になっていなかったことが分かった。
少し待ってみるといろんな状態を経て、Ready状態になると、
目印のオブジェクトが物理的に同じところに移動し、頭の位置も正しいところに移動した。</p>
<p><img src="https://www.sambaiz.net/images/88-sharing2.png" alt="Sharingしている状態"></p>
<hr>
<p>なにをやっているか見ていく。</p>
<p>まずは拾えるevent。</p>
<p><a href="https://www.sambaiz.net/article/83/">C#のdelegateとevent - sambaiz.net</a></p>
<h2 id="sharingsessiontrackerhttpsgithubcommicrosoftholotoolkit-unityblobv1550assetsholotoolkitsharingscriptssharingsessiontrackercs"><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing/Scripts/SharingSessionTracker.cs">SharingSessionTracker</a></h2>
<ul>
<li>public event EventHandler<!-- raw HTML omitted --> SessionJoined;</li>
</ul>
<p>ユーザーがセッションに入ったとき。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">public</span> <span style="color:#ff79c6">class</span> <span style="color:#50fa7b">SessionJoinedEventArgs</span> : EventArgs
{
    <span style="color:#ff79c6">public</span> User joiningUser;
}
</code></pre></div><ul>
<li>public event EventHandler<!-- raw HTML omitted --> SessionLeft;</li>
</ul>
<p>セッションから出たとき。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">public</span> <span style="color:#ff79c6">class</span> <span style="color:#50fa7b">SessionLeftEventArgs</span> : EventArgs
{
    <span style="color:#ff79c6">public</span> <span style="color:#8be9fd">long</span> exitingUserId;
}
</code></pre></div><h2 id="sharingstagehttpsgithubcommicrosoftholotoolkit-unityblobv1550assetsholotoolkitsharingscriptssharingstagecs"><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing/Scripts/SharingStage.cs">SharingStage</a></h2>
<ul>
<li>public event EventHandler SharingManagerConnected;</li>
</ul>
<p>SharingManagerが接続されたとき。ArgsはEmpty。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#">connectedEvent(<span style="color:#ff79c6">this</span>, EventArgs.Empty);
</code></pre></div><hr>
<p>これらのeventをsubscribeしているTestsの中のコード。</p>
<h2 id="custommessageshttpsgithubcommicrosoftholotoolkit-unityblobv1550assetsholotoolkitsharingtestscustommessagescs"><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing/Tests/CustomMessages.cs">CustomMessages</a></h2>
<p>データを送受信するところ。</p>
<h3 id="初期化httpsgithubcommicrosoftholotoolkit-unityblobv1550assetsholotoolkitsharingtestscustommessagescsl57"><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing/Tests/CustomMessages.cs#L57">初期化</a></h3>
<p>SharingManagerが接続されたら初期化がはじまる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">void</span> Start()
{
    SharingStage.Instance.SharingManagerConnected += SharingManagerConnected;
}

<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> SharingManagerConnected(<span style="color:#8be9fd">object</span> sender, EventArgs e)
{
    InitializeMessageHandlers();
}
</code></pre></div><p>まず、ServerとのConnectionを取得し、Messageを受信したときのeventをsubscribeしている。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#">SharingStage sharingStage = SharingStage.Instance;
serverConnection = sharingStage.Manager.GetServerConnection();
connectionAdapter = <span style="color:#ff79c6">new</span> NetworkConnectionAdapter();
connectionAdapter.MessageReceivedCallback += OnMessageReceived;
</code></pre></div><p>それから自分自身のユーザーIDも保存してある。これはMessageを送るときに使う。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#">localUserID = SharingStage.Instance.Manager.GetLocalUser().GetID();
</code></pre></div><p>最後に<code>MessageHandlers</code>にnullを詰めて終わり。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">byte</span> index = (<span style="color:#8be9fd">byte</span>)TestMessageID.HeadTransform; index &lt; (<span style="color:#8be9fd">byte</span>)TestMessageID.Max; index++)
{
    <span style="color:#ff79c6">if</span> (MessageHandlers.ContainsKey((TestMessageID)index) == <span style="color:#ff79c6">false</span>)
    {
        MessageHandlers.Add((TestMessageID)index, <span style="color:#ff79c6">null</span>);
    }

    serverConnection.AddListener(index, connectionAdapter);
}
</code></pre></div><p>後からこういう風にhandlerを設定している。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">CustomMessages.Instance.MessageHandlers[CustomMessages.TestMessageID.HeadTransform] = this.UpdateHeadTransform;
</code></pre></div><h3 id="受信">受信</h3>
<p>messageTypeに対応したhandlerに渡す。初期状態では全てnullなので何もしない。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">void</span> OnMessageReceived(NetworkConnection connection, NetworkInMessage msg)
{
    <span style="color:#8be9fd">byte</span> messageType = msg.ReadByte();
    MessageCallback messageHandler = MessageHandlers[(TestMessageID)messageType];
    <span style="color:#ff79c6">if</span> (messageHandler != <span style="color:#ff79c6">null</span>)
    {
        messageHandler(msg);
    }
}
</code></pre></div><h3 id="送信">送信</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#">CustomMessages.Instance.SendStageTransform(transform.localPosition, transform.localRotation);
CustomMessages.Instance.SendHeadTransform(headPosition, headRotation);
</code></pre></div><p>こんな感じにBroadcastしている。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">public</span> <span style="color:#ff79c6">void</span> SendHeadTransform(Vector3 position, Quaternion rotation)
{
    <span style="color:#6272a4">// If we are connected to a session, broadcast our head info
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> (serverConnection != <span style="color:#ff79c6">null</span> &amp;&amp; serverConnection.IsConnected())
    {
        <span style="color:#6272a4">// Create an outgoing network message to contain all the info we want to send
</span><span style="color:#6272a4"></span>        NetworkOutMessage msg = CreateMessage((<span style="color:#8be9fd">byte</span>)TestMessageID.HeadTransform);

        AppendTransform(msg, position, rotation);

        <span style="color:#6272a4">// Send the message as a broadcast, which will cause the server to forward it to all other users in the session.
</span><span style="color:#6272a4"></span>        serverConnection.Broadcast(
            msg,
            MessagePriority.Immediate,
            MessageReliability.UnreliableSequenced,
            MessageChannel.Avatar);
    }
}
</code></pre></div><h2 id="importexportanchormanagerhttpsgithubcommicrosoftholotoolkit-unityblobv1550assetsholotoolkitsharingtestsimportexportanchormanagercs"><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing/Tests/ImportExportAnchorManager.cs">ImportExportAnchorManager</a></h2>
<p>オブジェクトのpositionを物理的に固定する<a href="https://docs.unity3d.com/ScriptReference/VR.WSA.WorldAnchor.html">WorldAnchor</a>を共有する。</p>
<p><code>currentState</code>は最初<code>AnchorStore_Initializing</code>で、
<code>anchorStore</code>が取得できたら<code>AnchorStore_Initialized</code>になる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">private</span> ImportExportState currentState = ImportExportState.Start;

<span style="color:#6272a4">// インスタンスがロードされたときに呼ばれる。コンストラクターの代わり
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">protected</span> <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">void</span> Awake()
{
    <span style="color:#ff79c6">base</span>.Awake();
    Debug.Log(<span style="color:#f1fa8c">&#34;Import Export Manager starting&#34;</span>);
    <span style="color:#6272a4">// We need to get our local anchor store started up.
</span><span style="color:#6272a4"></span>    currentState = ImportExportState.AnchorStore_Initializing;
    WorldAnchorStore.GetAsync(AnchorStoreReady);
}

<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> AnchorStoreReady(WorldAnchorStore store)
{
    anchorStore = store;
    currentState = ImportExportState.AnchorStore_Initialized;
}

<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> Start()
{
    SharingStage.Instance.SharingManagerConnected += SharingManagerConnected;
    SharingSessionTracker.Instance.SessionJoined += Instance_SessionJoined;
}
</code></pre></div><p>SharingManagerが接続されたら、RoomManagerのインスタンスを取得して、
Anchorのダウンロードとアップロードしたときのeventをsubscribeしている。</p>
<p>Uploaded時は<code>currentState</code>を<code>Ready</code>にし、
Downloaded時は<code>rawAnchorData</code>に保存し、<code>currentState</code>を<code>DataReady</code>にする。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> SharingManagerConnected(<span style="color:#8be9fd">object</span> sender, EventArgs e)
{
    <span style="color:#6272a4">// Setup the room manager callbacks.
</span><span style="color:#6272a4"></span>    roomManager = SharingStage.Instance.Manager.GetRoomManager();
    roomManagerCallbacks = <span style="color:#ff79c6">new</span> RoomManagerAdapter();

    roomManagerCallbacks.AnchorsDownloadedEvent += RoomManagerCallbacks_AnchorsDownloaded;
    roomManagerCallbacks.AnchorUploadedEvent += RoomManagerCallbacks_AnchorUploaded;
    roomManager.AddListener(roomManagerCallbacks);
}

<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> RoomManagerCallbacks_AnchorUploaded(<span style="color:#8be9fd">bool</span> successful, XString failureReason)
{
    <span style="color:#ff79c6">if</span> (successful)
    {
        currentState = ImportExportState.Ready;
    }
    <span style="color:#ff79c6">else</span>
    {
        Debug.Log(<span style="color:#f1fa8c">&#34;Upload failed &#34;</span> + failureReason);
        currentState = ImportExportState.Failed;
    }
}

<span style="color:#ff79c6">private</span> <span style="color:#8be9fd">byte</span>[] rawAnchorData = <span style="color:#ff79c6">null</span>;

<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> RoomManagerCallbacks_AnchorsDownloaded(<span style="color:#8be9fd">bool</span> successful, AnchorDownloadRequest request, XString failureReason)
{
    <span style="color:#6272a4">// If we downloaded anchor data successfully we should import the data.
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> (successful)
    {
        <span style="color:#8be9fd">int</span> datasize = request.GetDataSize();
        Debug.Log(datasize + <span style="color:#f1fa8c">&#34; bytes &#34;</span>);
        rawAnchorData = <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span>[datasize];

        request.GetData(rawAnchorData, datasize);
        currentState = ImportExportState.DataReady;
    }
    <span style="color:#ff79c6">else</span>
    {
        <span style="color:#6272a4">// If we failed, we can ask for the data again.
</span><span style="color:#6272a4"></span>        Debug.Log(<span style="color:#f1fa8c">&#34;Anchor DL failed &#34;</span> + failureReason);
        MakeAnchorDataRequest();
    }
}
</code></pre></div><p>SessionJoin時には、<code>sharingServiceReady</code>をtrueにする。</p>
<p><code>InitRoomApi()</code>では<code>currentRoom</code>にJoin(あるいは新しく作る)し、Roomを代入している。</p>
<p><code>currentState</code>は新しくRoomを作った場合<code>InitialAnchorRequired</code>で、すでにあるRoomに入った場合<code>RoomApiInitialized</code>になる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">private</span> <span style="color:#8be9fd">bool</span> sharingServiceReady = <span style="color:#ff79c6">false</span>;
<span style="color:#ff79c6">private</span> Room currentRoom;

<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> Instance_SessionJoined(<span style="color:#8be9fd">object</span> sender, SharingSessionTracker.SessionJoinedEventArgs e)
{
    SharingSessionTracker.Instance.SessionJoined -= Instance_SessionJoined;

    <span style="color:#6272a4">// ほかの処理が落ち着くまで5秒待って実行する
</span><span style="color:#6272a4"></span>    Invoke(<span style="color:#f1fa8c">&#34;MarkSharingServiceReady&#34;</span>, <span style="color:#bd93f9">5</span>);
}

<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> MarkSharingServiceReady()
{
    sharingServiceReady = <span style="color:#ff79c6">true</span>;

<span style="color:#ff79c6">#if UNITY_EDITOR || UNITY_STANDALONE
</span><span style="color:#ff79c6"></span>    InitRoomApi();
<span style="color:#ff79c6">#endif
</span><span style="color:#ff79c6"></span>}

<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> InitRoomApi()
{
    <span style="color:#ff79c6">if</span> (roomManager.GetRoomCount() == <span style="color:#bd93f9">0</span>)
    {
        <span style="color:#ff79c6">if</span> (LocalUserHasLowestUserId())
        {
            Debug.Log(<span style="color:#f1fa8c">&#34;Creating room &#34;</span>);            
            currentRoom = roomManager.CreateRoom(<span style="color:#ff79c6">new</span> XString(<span style="color:#f1fa8c">&#34;DefaultRoom&#34;</span>), roomID, <span style="color:#ff79c6">false</span>);
            currentState = ImportExportState.InitialAnchorRequired;
        }
    }
    <span style="color:#ff79c6">else</span>
    {
        Debug.Log(<span style="color:#f1fa8c">&#34;Joining room &#34;</span>);
        currentRoom = roomManager.GetRoom(<span style="color:#bd93f9">0</span>);
        roomManager.JoinRoom(currentRoom);
        currentState = ImportExportState.RoomApiInitialized;
    }
}
</code></pre></div><p>Update。ここで<code>currentState</code>を見ている。ここまでの<code>currentState</code>をまとめると、</p>
<ul>
<li>AnchorStore_Initializing: 初期状態</li>
<li>AnchorStore_Initialized: AnchorStore取得完了</li>
<li>InitialAnchorRequired: 新しくRoomを作った(のでWorldAnchorを生成する)</li>
<li>RoomApiInitialized: すでにあるRoomに入った</li>
<li>Ready: Upload完了</li>
<li>DataReady: Download完了</li>
</ul>
<p>こんな感じ。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> Update()
{
    <span style="color:#ff79c6">switch</span> (currentState)
    {
        <span style="color:#ff79c6">case</span> ImportExportState.AnchorStore_Initialized:
            <span style="color:#ff79c6">if</span> (sharingServiceReady)
            {
                InitRoomApi();
            }
            <span style="color:#ff79c6">break</span>;
        <span style="color:#ff79c6">case</span> ImportExportState.RoomApiInitialized:
            StartAnchorProcess();
            <span style="color:#ff79c6">break</span>;
        <span style="color:#ff79c6">case</span> ImportExportState.DataReady:
            <span style="color:#6272a4">// DataReady is set when the anchor download completes.
</span><span style="color:#6272a4"></span>            currentState = ImportExportState.Importing;
            WorldAnchorTransferBatch.ImportAsync(rawAnchorData, ImportComplete);
            <span style="color:#ff79c6">break</span>;
        <span style="color:#ff79c6">case</span> ImportExportState.InitialAnchorRequired:
            currentState = ImportExportState.CreatingInitialAnchor;
            CreateAnchorLocally();
            <span style="color:#ff79c6">break</span>;
        <span style="color:#ff79c6">case</span> ImportExportState.ReadyToExportInitialAnchor:
            <span style="color:#6272a4">// We&#39;ve created an anchor locally and it is ready to export.
</span><span style="color:#6272a4"></span>            currentState = ImportExportState.UploadingInitialAnchor;
            Export();
            <span style="color:#ff79c6">break</span>;
    }
}
</code></pre></div><p>Roomを新しく作ったならWorldAnchorを作成する必要がある。
<a href="https://docs.unity3d.com/ScriptReference/VR.WSA.WorldAnchor-isLocated.html">isLocated</a>がtrueになったら
<code>OnTrackingChanged_InitialAnchor</code>にし、AnchorをUploadする。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> CreateAnchorLocally()
{
    WorldAnchor anchor = GetComponent&lt;WorldAnchor&gt;();
    <span style="color:#ff79c6">if</span> (anchor == <span style="color:#ff79c6">null</span>)
    {
        anchor = gameObject.AddComponent&lt;WorldAnchor&gt;();
    }

    <span style="color:#ff79c6">if</span> (anchor.isLocated)
    {
        currentState = ImportExportState.ReadyToExportInitialAnchor;
    }
    <span style="color:#ff79c6">else</span>
    {
        anchor.OnTrackingChanged += Anchor_OnTrackingChanged_InitialAnchor;
    }
}

<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> Anchor_OnTrackingChanged_InitialAnchor(WorldAnchor self, <span style="color:#8be9fd">bool</span> located)
{
    <span style="color:#ff79c6">if</span> (located)
    {
        Debug.Log(<span style="color:#f1fa8c">&#34;Found anchor, ready to export&#34;</span>);
        currentState = ImportExportState.ReadyToExportInitialAnchor;
    }
    <span style="color:#ff79c6">else</span>
    {
        Debug.Log(<span style="color:#f1fa8c">&#34;Failed to locate local anchor (super bad!)&#34;</span>);
        currentState = ImportExportState.Failed;
    }

    self.OnTrackingChanged -= Anchor_OnTrackingChanged_InitialAnchor;
}
</code></pre></div><p><code>anchorStore</code>に保存して、SerializeしてUploadする。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> Export()
{
    WorldAnchor anchor = GetComponent&lt;WorldAnchor&gt;();

    <span style="color:#8be9fd">string</span> guidString = Guid.NewGuid().ToString();
    exportingAnchorName = guidString;

    <span style="color:#6272a4">// Save the anchor to our local anchor store.
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> (anchorStore.Save(exportingAnchorName, anchor))
    {
        sharedAnchorInterface = <span style="color:#ff79c6">new</span> WorldAnchorTransferBatch();
        sharedAnchorInterface.AddWorldAnchor(guidString, anchor);
        WorldAnchorTransferBatch.ExportAsync(sharedAnchorInterface, WriteBuffer, ExportComplete);
    }
    <span style="color:#ff79c6">else</span>
    {
        Debug.Log(<span style="color:#f1fa8c">&#34;This anchor didn&#39;t work, trying again&#34;</span>);
        currentState = ImportExportState.InitialAnchorRequired;
    }
}

<span style="color:#ff79c6">public</span> <span style="color:#ff79c6">void</span> ExportComplete(SerializationCompletionReason status)
{
    <span style="color:#ff79c6">if</span> (status == SerializationCompletionReason.Succeeded &amp;&amp; exportingAnchorBytes.Count &gt; minTrustworthySerializedAnchorDataSize)
    {
        Debug.Log(<span style="color:#f1fa8c">&#34;Uploading anchor: &#34;</span> + exportingAnchorName);
        roomManager.UploadAnchor(
            currentRoom,
            <span style="color:#ff79c6">new</span> XString(exportingAnchorName),
            exportingAnchorBytes.ToArray(),
            exportingAnchorBytes.Count);
    }
    <span style="color:#ff79c6">else</span>
    {
        Debug.Log(<span style="color:#f1fa8c">&#34;This anchor didn&#39;t work, trying again&#34;</span>);
        currentState = ImportExportState.InitialAnchorRequired;
    }
}
</code></pre></div><p>もしすでにあるRoomにJoinしている(<code>RoomApiInitialized</code>)なら、Anchorをダウンロードし始め、<code>DataRequested</code>になる。
ダウンロードしたら<code>DataReady</code>になって、AnchorデータをImportする。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> StartAnchorProcess()
{
    <span style="color:#6272a4">// First, are there any anchors in this room?
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> anchorCount = currentRoom.GetAnchorCount();

    <span style="color:#6272a4">// If there are anchors, we should attach to the first one.
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> (anchorCount &gt; <span style="color:#bd93f9">0</span>)
    {
        <span style="color:#6272a4">// Extract the name of the anchor.
</span><span style="color:#6272a4"></span>        XString storedAnchorString = currentRoom.GetAnchorName(<span style="color:#bd93f9">0</span>);
        <span style="color:#8be9fd">string</span> storedAnchorName = storedAnchorString.GetString();

        <span style="color:#6272a4">// Attempt to attach to the anchor in our local anchor store.
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> (AttachToCachedAnchor(storedAnchorName) == <span style="color:#ff79c6">false</span>)
        {
            MakeAnchorDataRequest();
        }
    }
}

<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> MakeAnchorDataRequest()
{
    <span style="color:#ff79c6">if</span> (roomManager.DownloadAnchor(currentRoom, currentRoom.GetAnchorName(<span style="color:#bd93f9">0</span>)))
    {
        currentState = ImportExportState.DataRequested;
    }
    <span style="color:#ff79c6">else</span>
    {
        Debug.Log(<span style="color:#f1fa8c">&#34;Couldn&#39;t make the download request.&#34;</span>);
        currentState = ImportExportState.Failed;
    }
}
</code></pre></div><p>Import完了したら<code>anchorStore</code>に保存し、<code>Ready</code>にする。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> ImportComplete(SerializationCompletionReason status, WorldAnchorTransferBatch wat)
{
    <span style="color:#ff79c6">if</span> (status == SerializationCompletionReason.Succeeded &amp;&amp; wat.GetAllIds().Length &gt; <span style="color:#bd93f9">0</span>)
    {
        Debug.Log(<span style="color:#f1fa8c">&#34;Import complete&#34;</span>);

        <span style="color:#8be9fd">string</span> first = wat.GetAllIds()[<span style="color:#bd93f9">0</span>];
        Debug.Log(<span style="color:#f1fa8c">&#34;Anchor name: &#34;</span> + first);

        WorldAnchor anchor = wat.LockObject(first, gameObject);
        anchorStore.Save(first, anchor);
        currentState = ImportExportState.Ready;
    }
    <span style="color:#ff79c6">else</span>
    {
        Debug.Log(<span style="color:#f1fa8c">&#34;Import fail&#34;</span>);
        currentState = ImportExportState.DataReady;
    }
}
</code></pre></div><h2 id="remoteheadmanagerhttpsgithubcommicrosoftholotoolkit-unityblobv1550assetsholotoolkitsharingtestsremoteheadmanagercs"><a href="https://github.com/Microsoft/HoloToolkit-Unity/blob/v1.5.5.0/Assets/HoloToolkit/Sharing/Tests/RemoteHeadManager.cs">RemoteHeadManager</a></h2>
<p>他のユーザーの頭の位置にオブジェクトを表示させる。</p>
<p>受信時のhandlerを設定し、eventをsubscribeする。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">void</span> Start()
{
    CustomMessages.Instance.MessageHandlers[CustomMessages.TestMessageID.HeadTransform] = <span style="color:#ff79c6">this</span>.UpdateHeadTransform;

    SharingSessionTracker.Instance.SessionJoined += Instance_SessionJoined;
    SharingSessionTracker.Instance.SessionLeft += Instance_SessionLeft;
}
</code></pre></div><p>joinしたのが自分自身じゃないかチェック。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> Instance_SessionJoined(<span style="color:#8be9fd">object</span> sender, SharingSessionTracker.SessionJoinedEventArgs e)
{
    <span style="color:#ff79c6">if</span> (e.joiningUser.GetID() != SharingStage.Instance.Manager.GetLocalUser().GetID())
    {
        GetRemoteHeadInfo(e.joiningUser.GetID());
    }
}
</code></pre></div><p><code>remoteHeads</code>になければ、HeadObjectを作成し、追加する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">public</span> RemoteHeadInfo GetRemoteHeadInfo(<span style="color:#8be9fd">long</span> userID)
{
    RemoteHeadInfo headInfo;

    <span style="color:#6272a4">// Get the head info if its already in the list, otherwise add it
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> (!<span style="color:#ff79c6">this</span>.remoteHeads.TryGetValue(userID, <span style="color:#ff79c6">out</span> headInfo))
    {
        headInfo = <span style="color:#ff79c6">new</span> RemoteHeadInfo();
        headInfo.UserID = userID;
        headInfo.HeadObject = CreateRemoteHead();

        <span style="color:#ff79c6">this</span>.remoteHeads.Add(userID, headInfo);
    }

    <span style="color:#ff79c6">return</span> headInfo;
}
</code></pre></div><p>Sessionから離れたときはオブジェクトを削除し、remoteHeadsから取り除く。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">private</span> <span style="color:#ff79c6">void</span> Instance_SessionLeft(<span style="color:#8be9fd">object</span> sender, SharingSessionTracker.SessionLeftEventArgs e)
{
    <span style="color:#ff79c6">if</span> (e.exitingUserId != SharingStage.Instance.Manager.GetLocalUser().GetID())
    {
        RemoveRemoteHead(<span style="color:#ff79c6">this</span>.remoteHeads[e.exitingUserId].HeadObject);
        <span style="color:#ff79c6">this</span>.remoteHeads.Remove(e.exitingUserId);
    }
}

<span style="color:#ff79c6">void</span> RemoveRemoteHead(GameObject remoteHeadObject)
{
    DestroyImmediate(remoteHeadObject);
}
</code></pre></div><p>受信時のhandlerではMessageからpositionとquarternionを取得し、オブジェクトの位置を動かしている。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">void</span> UpdateHeadTransform(NetworkInMessage msg)
{
    <span style="color:#6272a4">// Parse the message
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">long</span> userID = msg.ReadInt64();

    Vector3 headPos = CustomMessages.Instance.ReadVector3(msg);

    Quaternion headRot = CustomMessages.Instance.ReadQuaternion(msg);

    RemoteHeadInfo headInfo = GetRemoteHeadInfo(userID);
    headInfo.HeadObject.transform.localPosition = headPos;
    headInfo.HeadObject.transform.localRotation = headRot;
}
</code></pre></div><p>自分の頭の位置はUpdate()で送信している。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c#" data-lang="c#"><span style="color:#ff79c6">void</span> Update()
{
    <span style="color:#6272a4">// Grab the current head transform and broadcast it to all the other users in the session
</span><span style="color:#6272a4"></span>    Transform headTransform = Camera.main.transform;

    <span style="color:#6272a4">// Transform the head position and rotation from world space into local space
</span><span style="color:#6272a4"></span>    Vector3 headPosition = <span style="color:#ff79c6">this</span>.transform.InverseTransformPoint(headTransform.position);
    Quaternion headRotation = Quaternion.Inverse(<span style="color:#ff79c6">this</span>.transform.rotation) * headTransform.rotation;

    CustomMessages.Instance.SendHeadTransform(headPosition, headRotation);
}
</code></pre></div><h2 id="ライセンス">ライセンス</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">MIT License

Copyright (c) 2016 Microsoft Corporation

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &#34;Software&#34;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED &#34;AS IS&#34;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
</code></pre></div>
    </div>
  </article>
</div>

</div>

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date(); a = s.createElement(o),
      m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-39190067-3', 'auto');
  ga('send', 'pageview');
</script>


</body>

</html>