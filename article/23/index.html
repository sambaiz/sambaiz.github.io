<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NCML2RV');</script>
  

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        font-family: 'Noto Sans JP', sans-serif;
    }

    .languages {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        color: #3a9240;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 30px;
        height: 30px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.5rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single p>code {
        background-color: #eee;
        color: #333;
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single .highlight {
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
        background-color: ;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .share {
        position: relative;
        text-align: right;
        margin-top: 5px;
    }

    .share .cell {
        display: inline-block;
        text-align: center;
        margin-bottom: 5px;
    }

    .share-button {
        display: inline-block;
        margin: 0 5px;
    }

    @media screen and (min-width: 1400px) {
        .share .cell {
            position: absolute;
            bottom: 0;
            margin-left: 5px;
        }

        .share-button {
            display: inline-block;
            margin: 5px 0;
        }
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>android-bluetoothChatを読む - sambaiz-net</title>
  <meta name="twitter:title" content="android-bluetoothChatを読む - sambaiz-net">
  <meta property='og:title' content="android-bluetoothChatを読む - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="bluetoothのサンプルコードを読む">
  <meta name="twitter:description" content="bluetoothのサンプルコードを読む">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/article/23/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />

  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id": "https://www.sambaiz.net/"
    },
    "headline": "android-bluetoothChatを読む",
    "datePublished": "2016-10-15T14:00:00JST",
    "dateModified": "2016-10-15T14:00:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "url": "https://www.sambaiz.net/",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "bluetoothのサンプルコードを読む"
  }
</script>
</head>

<body>
  
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCML2RV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <div>
    <div class="languages">
      
    </div>

    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="icon" />
        <a class="nl" href='/'>
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://twitter.com/sambaiz">
            <img src="/image/twitter.png" width="30px" height="30px" alt="twitter">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://bookmeter.com/users/1060169/books/read">
            <img src="/image/bookmeter.png" width="30px" height="30px" alt="bookmeter">
          </a>
        </div>
        <div class="sns-item">
          <a href="https://filmarks.com/users/sambaiz" class="filmarks" aria-label="filmarks"></a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://www.alltrails.com/members/taiki-sakamoto/recordings">
            <img src="/image/alltrails.png" width="30px" height="30px" alt="alltrails">
          </a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/log/">
            log</a>
          
          <a class="tag" href="/tags/docker/">
            docker</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/infra/">
            infra</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>android-bluetoothChatを読む</h1>
        <time>2016-10-15</time>
        <a class="tag" href='/tags/android/'>android</a>
      </div>
      <p>Classic Bluetoothのサンプルコード。</p>
<p><a href="https://github.com/googlesamples/android-BluetoothChat">https://github.com/googlesamples/android-BluetoothChat</a></p>
<h2 id="mainactivity">MainActivity</h2>
<p>まず、MainActivity。</p>
<p>Fragmentのcommitや、</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java">@Override
<span style="color:#00f">protected</span> <span style="color:#2b91af">void</span> onCreate(Bundle savedInstanceState) {
    <span style="color:#00f">super</span>.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    <span style="color:#00f">if</span> (savedInstanceState == <span style="color:#00f">null</span>) {
        FragmentTransaction transaction = getSupportFragmentManager().beginTransaction();
        BluetoothChatFragment fragment = <span style="color:#00f">new</span> BluetoothChatFragment();
        transaction.replace(R.id.sample_content_fragment, fragment);
        transaction.commit();
    }
}
</code></pre></div><p>オプションメニューの設定をしている。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java"><span style="color:#008000">// 最初だけ呼ばれる
</span><span style="color:#008000"></span>@Override
<span style="color:#00f">public</span> <span style="color:#2b91af">boolean</span> onCreateOptionsMenu(Menu menu) {
    getMenuInflater().inflate(R.menu.main, menu);
    <span style="color:#00f">return</span> <span style="color:#00f">true</span>;
}

<span style="color:#008000">// 表示される度に呼ばれる
</span><span style="color:#008000"></span>@Override
<span style="color:#00f">public</span> <span style="color:#2b91af">boolean</span> onPrepareOptionsMenu(Menu menu) {
    MenuItem logToggle = menu.findItem(R.id.menu_toggle_log);
    logToggle.setVisible(findViewById(R.id.sample_output) <span style="color:#00f">instanceof</span> ViewAnimator);
    logToggle.setTitle(mLogShown ? R.string.sample_hide_log : R.string.sample_show_log);

    <span style="color:#00f">return</span> <span style="color:#00f">super</span>.onPrepareOptionsMenu(menu);
}

@Override
<span style="color:#00f">public</span> <span style="color:#2b91af">boolean</span> onOptionsItemSelected(MenuItem item) {
    <span style="color:#00f">switch</span>(item.getItemId()) {
        <span style="color:#00f">case</span> R.id.menu_toggle_log:
            mLogShown = !mLogShown;
            ViewAnimator output = (ViewAnimator) findViewById(R.id.sample_output);
            <span style="color:#00f">if</span> (mLogShown) {
                output.setDisplayedChild(1);
            } <span style="color:#00f">else</span> {
                output.setDisplayedChild(0);
            }　
            <span style="color:#008000">// メニューを再作成する(onCreateOptionsMenu, onPrepareOptionsMenuが呼ばれる)
</span><span style="color:#008000"></span>            supportInvalidateOptionsMenu();
            <span style="color:#00f">return</span> <span style="color:#00f">true</span>;
    }
    <span style="color:#00f">return</span> <span style="color:#00f">super</span>.onOptionsItemSelected(item);
}
</code></pre></div><h2 id="bluetoothchatfragment">BluetoothChatFragment</h2>
<p>onCreateではBluetoothAdapterを取得して、Bluetoothが使えるかどうかを確認する。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java">@Override
<span style="color:#00f">public</span> <span style="color:#2b91af">void</span> onCreate(Bundle savedInstanceState) {
    <span style="color:#00f">super</span>.onCreate(savedInstanceState);
    setHasOptionsMenu(<span style="color:#00f">true</span>);
    <span style="color:#008000">// Get local Bluetooth adapter
</span><span style="color:#008000"></span>    mBluetoothAdapter = BluetoothAdapter.getDefaultAdapter();

    <span style="color:#008000">// If the adapter is null, then Bluetooth is not supported
</span><span style="color:#008000"></span>    <span style="color:#00f">if</span> (mBluetoothAdapter == <span style="color:#00f">null</span>) {
        FragmentActivity activity = getActivity();
        Toast.makeText(activity, <span style="color:#a31515">&#34;Bluetooth is not available&#34;</span>, Toast.LENGTH_LONG).show();
        activity.finish();
    }
}
</code></pre></div><p>onStartではもしBluetoothが有効でなければ有効にするよう要求し、有効になったらsetupする。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java">@Override
<span style="color:#00f">public</span> <span style="color:#2b91af">void</span> onStart() {
    <span style="color:#00f">super</span>.onStart();
    <span style="color:#008000">// If BT is not on, request that it be enabled.
</span><span style="color:#008000"></span>    <span style="color:#008000">// setupChat() will then be called during onActivityResult
</span><span style="color:#008000"></span>    <span style="color:#00f">if</span> (!mBluetoothAdapter.isEnabled()) {
        Intent enableIntent = <span style="color:#00f">new</span> Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);
        startActivityForResult(enableIntent, REQUEST_ENABLE_BT);
        <span style="color:#008000">// Otherwise, setup the chat session
</span><span style="color:#008000"></span>    } <span style="color:#00f">else</span> <span style="color:#00f">if</span> (mChatService == <span style="color:#00f">null</span>) {
        setupChat();
    }
}

<span style="color:#00f">public</span> <span style="color:#2b91af">void</span> onActivityResult(<span style="color:#2b91af">int</span> requestCode, <span style="color:#2b91af">int</span> resultCode, Intent data) {
    <span style="color:#00f">switch</span> (requestCode) {
        <span style="color:#00f">case</span> REQUEST_CONNECT_DEVICE_SECURE:
            <span style="color:#008000">// When DeviceListActivity returns with a device to connect
</span><span style="color:#008000"></span>            <span style="color:#00f">if</span> (resultCode == Activity.RESULT_OK) {
                connectDevice(data, <span style="color:#00f">true</span>);
            }
            <span style="color:#00f">break</span>;
        <span style="color:#00f">case</span> REQUEST_CONNECT_DEVICE_INSECURE:
            <span style="color:#008000">// When DeviceListActivity returns with a device to connect
</span><span style="color:#008000"></span>            <span style="color:#00f">if</span> (resultCode == Activity.RESULT_OK) {
                connectDevice(data, <span style="color:#00f">false</span>);
            }
            <span style="color:#00f">break</span>;
        <span style="color:#00f">case</span> REQUEST_ENABLE_BT:
            <span style="color:#008000">// When the request to enable Bluetooth returns
</span><span style="color:#008000"></span>            <span style="color:#00f">if</span> (resultCode == Activity.RESULT_OK) {
                <span style="color:#008000">// Bluetooth is now enabled, so set up a chat session
</span><span style="color:#008000"></span>                setupChat();
            } <span style="color:#00f">else</span> {
                <span style="color:#008000">// User did not enable Bluetooth or an error occurred
</span><span style="color:#008000"></span>                Log.d(TAG, <span style="color:#a31515">&#34;BT not enabled&#34;</span>);
                Toast.makeText(getActivity(), R.string.bt_not_enabled_leaving,
                        Toast.LENGTH_SHORT).show();
                getActivity().finish();
            }
    }
}
</code></pre></div><p>onActivityResultではDeviceListActivityで、接続する端末を選択した結果もハンドリングしていて、connectDeviceを呼ぶ。
アドレスからmBluetoothAdapter.getRemoteDevice(address)でdeviceを取得して、これをサービスに渡して接続する。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java"><span style="color:#00f">private</span> <span style="color:#2b91af">void</span> connectDevice(Intent data, <span style="color:#2b91af">boolean</span> secure) {
    <span style="color:#008000">// Get the device MAC address
</span><span style="color:#008000"></span>    String address = data.getExtras()
            .getString(DeviceListActivity.EXTRA_DEVICE_ADDRESS);
    <span style="color:#008000">// Get the BluetoothDevice object
</span><span style="color:#008000"></span>    BluetoothDevice device = mBluetoothAdapter.getRemoteDevice(address);
    <span style="color:#008000">// Attempt to connect to the device
</span><span style="color:#008000"></span>    mChatService.connect(device, secure);
}
</code></pre></div><p>Serviceのstartとstop。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java">@Override
<span style="color:#00f">public</span> <span style="color:#2b91af">void</span> onDestroy() {
    <span style="color:#00f">super</span>.onDestroy();
    <span style="color:#00f">if</span> (mChatService != <span style="color:#00f">null</span>) {
        mChatService.stop();
    }
}

@Override
<span style="color:#00f">public</span> <span style="color:#2b91af">void</span> onResume() {
    <span style="color:#00f">super</span>.onResume();

    <span style="color:#008000">// Performing this check in onResume() covers the case in which BT was
</span><span style="color:#008000"></span>    <span style="color:#008000">// not enabled during onStart(), so we were paused to enable it...
</span><span style="color:#008000"></span>    <span style="color:#008000">// onResume() will be called when ACTION_REQUEST_ENABLE activity returns.
</span><span style="color:#008000"></span>    <span style="color:#00f">if</span> (mChatService != <span style="color:#00f">null</span>) {
        <span style="color:#008000">// Only if the state is STATE_NONE, do we know that we haven&#39;t started already
</span><span style="color:#008000"></span>        <span style="color:#00f">if</span> (mChatService.getState() == BluetoothChatService.STATE_NONE) {
            <span style="color:#008000">// Start the Bluetooth chat services
</span><span style="color:#008000"></span>            mChatService.start();
        }
    }
}
</code></pre></div><p>viewまわり。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java">@Override
<span style="color:#00f">public</span> View onCreateView(LayoutInflater inflater, @Nullable ViewGroup container,
                         @Nullable Bundle savedInstanceState) {
    <span style="color:#00f">return</span> inflater.inflate(R.layout.fragment_bluetooth_chat, container, <span style="color:#00f">false</span>);
}

@Override
<span style="color:#00f">public</span> <span style="color:#2b91af">void</span> onViewCreated(View view, @Nullable Bundle savedInstanceState) {
    mConversationView = (ListView) view.findViewById(R.id.in);
    mOutEditText = (EditText) view.findViewById(R.id.edit_text_out);
    mSendButton = (Button) view.findViewById(R.id.button_send);
}
</code></pre></div><p>setupChatでは会話用リストにAdapterをセットしたり、入力欄やボタンにリスナーを登録するほかに、ChatServiceを初期化する。
初期化する際に第二引数として渡すmHandlerでは、Serviceからのメッセージにより処理を行う。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java"><span style="color:#00f">private</span> <span style="color:#2b91af">void</span> setupChat() {
    Log.d(TAG, <span style="color:#a31515">&#34;setupChat()&#34;</span>);

    <span style="color:#008000">// Initialize the array adapter for the conversation thread
</span><span style="color:#008000"></span>    mConversationArrayAdapter = <span style="color:#00f">new</span> ArrayAdapter&lt;String&gt;(getActivity(), R.layout.message);

    mConversationView.setAdapter(mConversationArrayAdapter);

    <span style="color:#008000">// Initialize the compose field with a listener for the return key
</span><span style="color:#008000"></span>    mOutEditText.setOnEditorActionListener(mWriteListener);

    <span style="color:#008000">// Initialize the send button with a listener that for click events
</span><span style="color:#008000"></span>    mSendButton.setOnClickListener(<span style="color:#00f">new</span> View.OnClickListener() {
        <span style="color:#00f">public</span> <span style="color:#2b91af">void</span> onClick(View v) {
            <span style="color:#008000">// Send a message using content of the edit text widget
</span><span style="color:#008000"></span>            View view = getView();
            <span style="color:#00f">if</span> (<span style="color:#00f">null</span> != view) {
                TextView textView = (TextView) view.findViewById(R.id.edit_text_out);
                String message = textView.getText().toString();
                sendMessage(message);
            }
        }
    });

    <span style="color:#008000">// Initialize the BluetoothChatService to perform bluetooth connections
</span><span style="color:#008000"></span>    mChatService = <span style="color:#00f">new</span> BluetoothChatService(getActivity(), mHandler);

    <span style="color:#008000">// Initialize the buffer for outgoing messages
</span><span style="color:#008000"></span>    mOutStringBuffer = <span style="color:#00f">new</span> StringBuffer(<span style="color:#a31515">&#34;&#34;</span>);
}

<span style="color:#00f">private</span> TextView.OnEditorActionListener mWriteListener = <span style="color:#00f">new</span> TextView.OnEditorActionListener() {
  <span style="color:#00f">public</span> <span style="color:#2b91af">boolean</span> onEditorAction(TextView view, <span style="color:#2b91af">int</span> actionId, KeyEvent event) {
      <span style="color:#008000">// If the action is a key-up event on the return key, send the message
</span><span style="color:#008000"></span>      <span style="color:#00f">if</span> (actionId == EditorInfo.IME_NULL &amp;&amp; event.getAction() == KeyEvent.ACTION_UP) {
          String message = view.getText().toString();
          sendMessage(message);
      }
      <span style="color:#00f">return</span> <span style="color:#00f">true</span>;
  }
};

<span style="color:#00f">private</span> <span style="color:#00f">final</span> Handler mHandler = <span style="color:#00f">new</span> Handler() {
    @Override
    <span style="color:#00f">public</span> <span style="color:#2b91af">void</span> handleMessage(Message msg) {
        FragmentActivity activity = getActivity();
        <span style="color:#00f">switch</span> (msg.what) {
            <span style="color:#00f">case</span> Constants.MESSAGE_STATE_CHANGE:
                <span style="color:#00f">switch</span> (msg.arg1) {
                    <span style="color:#00f">case</span> BluetoothChatService.STATE_CONNECTED:
                        setStatus(getString(R.string.title_connected_to, mConnectedDeviceName));
                        mConversationArrayAdapter.clear();
                        <span style="color:#00f">break</span>;
                    <span style="color:#00f">case</span> BluetoothChatService.STATE_CONNECTING:
                        setStatus(R.string.title_connecting);
                        <span style="color:#00f">break</span>;
                    <span style="color:#00f">case</span> BluetoothChatService.STATE_LISTEN:
                    <span style="color:#00f">case</span> BluetoothChatService.STATE_NONE:
                        setStatus(R.string.title_not_connected);
                        <span style="color:#00f">break</span>;
                }
                <span style="color:#00f">break</span>;
            <span style="color:#00f">case</span> Constants.MESSAGE_WRITE:
                <span style="color:#2b91af">byte</span>[] writeBuf = (<span style="color:#2b91af">byte</span>[]) msg.obj;
                <span style="color:#008000">// construct a string from the buffer
</span><span style="color:#008000"></span>                String writeMessage = <span style="color:#00f">new</span> String(writeBuf);
                mConversationArrayAdapter.add(<span style="color:#a31515">&#34;Me:  &#34;</span> + writeMessage);
                <span style="color:#00f">break</span>;
            <span style="color:#00f">case</span> Constants.MESSAGE_READ:
                <span style="color:#2b91af">byte</span>[] readBuf = (<span style="color:#2b91af">byte</span>[]) msg.obj;
                <span style="color:#008000">// construct a string from the valid bytes in the buffer
</span><span style="color:#008000"></span>                String readMessage = <span style="color:#00f">new</span> String(readBuf, 0, msg.arg1);
                mConversationArrayAdapter.add(mConnectedDeviceName + <span style="color:#a31515">&#34;:  &#34;</span> + readMessage);
                <span style="color:#00f">break</span>;
            <span style="color:#00f">case</span> Constants.MESSAGE_DEVICE_NAME:
                <span style="color:#008000">// save the connected device&#39;s name
</span><span style="color:#008000"></span>                mConnectedDeviceName = msg.getData().getString(Constants.DEVICE_NAME);
                <span style="color:#00f">if</span> (<span style="color:#00f">null</span> != activity) {
                    Toast.makeText(activity, <span style="color:#a31515">&#34;Connected to &#34;</span>
                            + mConnectedDeviceName, Toast.LENGTH_SHORT).show();
                }
                <span style="color:#00f">break</span>;
            <span style="color:#00f">case</span> Constants.MESSAGE_TOAST:
                <span style="color:#00f">if</span> (<span style="color:#00f">null</span> != activity) {
                    Toast.makeText(activity, msg.getData().getString(Constants.TOAST),
                            Toast.LENGTH_SHORT).show();
                }
                <span style="color:#00f">break</span>;
        }
    }
};
</code></pre></div><p>デバイスを検出可能にするのと、DeviceListActivityを始めるメニュー。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java">@Override
<span style="color:#00f">public</span> <span style="color:#2b91af">void</span> onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
    inflater.inflate(R.menu.bluetooth_chat, menu);
}

@Override
<span style="color:#00f">public</span> <span style="color:#2b91af">boolean</span> onOptionsItemSelected(MenuItem item) {
    <span style="color:#00f">switch</span> (item.getItemId()) {
        <span style="color:#00f">case</span> R.id.secure_connect_scan: {
            <span style="color:#008000">// Launch the DeviceListActivity to see devices and do scan
</span><span style="color:#008000"></span>            Intent serverIntent = <span style="color:#00f">new</span> Intent(getActivity(), DeviceListActivity.class);
            startActivityForResult(serverIntent, REQUEST_CONNECT_DEVICE_SECURE);
            <span style="color:#00f">return</span> <span style="color:#00f">true</span>;
        }
        <span style="color:#00f">case</span> R.id.insecure_connect_scan: {
            <span style="color:#008000">// Launch the DeviceListActivity to see devices and do scan
</span><span style="color:#008000"></span>            Intent serverIntent = <span style="color:#00f">new</span> Intent(getActivity(), DeviceListActivity.class);
            startActivityForResult(serverIntent, REQUEST_CONNECT_DEVICE_INSECURE);
            <span style="color:#00f">return</span> <span style="color:#00f">true</span>;
        }
        <span style="color:#00f">case</span> R.id.discoverable: {
            <span style="color:#008000">// Ensure this device is discoverable by others
</span><span style="color:#008000"></span>            ensureDiscoverable();
            <span style="color:#00f">return</span> <span style="color:#00f">true</span>;
        }
    }
    <span style="color:#00f">return</span> <span style="color:#00f">false</span>;
}

<span style="color:#00f">private</span> <span style="color:#2b91af">void</span> ensureDiscoverable() {
    <span style="color:#00f">if</span> (mBluetoothAdapter.getScanMode() !=
            BluetoothAdapter.SCAN_MODE_CONNECTABLE_DISCOVERABLE) {
        Intent discoverableIntent = <span style="color:#00f">new</span> Intent(BluetoothAdapter.ACTION_REQUEST_DISCOVERABLE);
        discoverableIntent.putExtra(BluetoothAdapter.EXTRA_DISCOVERABLE_DURATION, 300);
        startActivity(discoverableIntent);
    }
}
</code></pre></div><h2 id="bluetoothchatservice">BluetoothChatService</h2>
<p>初期stateはSTATE_NONE。
setStateしたときにobtainMessageでstateが変わったときの処理をhandlerに行わせる。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java"><span style="color:#00f">public</span> BluetoothChatService(Context context, Handler handler) {
    mAdapter = BluetoothAdapter.getDefaultAdapter();
    mState = STATE_NONE;
    mHandler = handler;
}

<span style="color:#00f">private</span> <span style="color:#00f">synchronized</span> <span style="color:#2b91af">void</span> setState(<span style="color:#2b91af">int</span> state) {
    Log.d(TAG, <span style="color:#a31515">&#34;setState() &#34;</span> + mState + <span style="color:#a31515">&#34; -&gt; &#34;</span> + state);
    mState = state;

    <span style="color:#008000">// Give the new state to the Handler so the UI Activity can update
</span><span style="color:#008000"></span>    mHandler.obtainMessage(Constants.MESSAGE_STATE_CHANGE, state, -1).sendToTarget();
}
</code></pre></div><p>接続しようとしている、した、される処理はそれぞれ別スレッドで行われる。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java"><span style="color:#00f">public</span> <span style="color:#00f">synchronized</span> <span style="color:#2b91af">void</span> start() {
    Log.d(TAG, <span style="color:#a31515">&#34;start&#34;</span>);

    <span style="color:#008000">// Cancel any thread attempting to make a connection
</span><span style="color:#008000"></span>    <span style="color:#00f">if</span> (mConnectThread != <span style="color:#00f">null</span>) {
        mConnectThread.cancel();
        mConnectThread = <span style="color:#00f">null</span>;
    }

    <span style="color:#008000">// Cancel any thread currently running a connection
</span><span style="color:#008000"></span>    <span style="color:#00f">if</span> (mConnectedThread != <span style="color:#00f">null</span>) {
        mConnectedThread.cancel();
        mConnectedThread = <span style="color:#00f">null</span>;
    }

    setState(STATE_LISTEN);

    <span style="color:#008000">// Start the thread to listen on a BluetoothServerSocket
</span><span style="color:#008000"></span>    <span style="color:#00f">if</span> (mSecureAcceptThread == <span style="color:#00f">null</span>) {
        mSecureAcceptThread = <span style="color:#00f">new</span> AcceptThread(<span style="color:#00f">true</span>);
        mSecureAcceptThread.start();
    }
    <span style="color:#00f">if</span> (mInsecureAcceptThread == <span style="color:#00f">null</span>) {
        mInsecureAcceptThread = <span style="color:#00f">new</span> AcceptThread(<span style="color:#00f">false</span>);
        mInsecureAcceptThread.start();
    }
}

<span style="color:#00f">public</span> <span style="color:#00f">synchronized</span> <span style="color:#2b91af">void</span> stop() {
    Log.d(TAG, <span style="color:#a31515">&#34;stop&#34;</span>);

    <span style="color:#00f">if</span> (mConnectThread != <span style="color:#00f">null</span>) {
        mConnectThread.cancel();
        mConnectThread = <span style="color:#00f">null</span>;
    }

    <span style="color:#00f">if</span> (mConnectedThread != <span style="color:#00f">null</span>) {
        mConnectedThread.cancel();
        mConnectedThread = <span style="color:#00f">null</span>;
    }

    <span style="color:#00f">if</span> (mSecureAcceptThread != <span style="color:#00f">null</span>) {
        mSecureAcceptThread.cancel();
        mSecureAcceptThread = <span style="color:#00f">null</span>;
    }

    <span style="color:#00f">if</span> (mInsecureAcceptThread != <span style="color:#00f">null</span>) {
        mInsecureAcceptThread.cancel();
        mInsecureAcceptThread = <span style="color:#00f">null</span>;
    }
    setState(STATE_NONE);
}
</code></pre></div><p>まず、接続するためのConnectThread。コンストラクタでつなげるdeviceからsocketを作成し、
runで接続する。接続できたらconnectedを呼び、ConnectedThreadを始める。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java"><span style="color:#00f">private</span> <span style="color:#00f">class</span> <span style="color:#2b91af">ConnectThread</span> <span style="color:#00f">extends</span> Thread {
    <span style="color:#00f">private</span> <span style="color:#00f">final</span> BluetoothSocket mmSocket;
    <span style="color:#00f">private</span> <span style="color:#00f">final</span> BluetoothDevice mmDevice;
    <span style="color:#00f">private</span> String mSocketType;

    <span style="color:#00f">public</span> ConnectThread(BluetoothDevice device, <span style="color:#2b91af">boolean</span> secure) {
        mmDevice = device;
        BluetoothSocket tmp = <span style="color:#00f">null</span>;
        mSocketType = secure ? <span style="color:#a31515">&#34;Secure&#34;</span> : <span style="color:#a31515">&#34;Insecure&#34;</span>;

        <span style="color:#008000">// Get a BluetoothSocket for a connection with the
</span><span style="color:#008000"></span>        <span style="color:#008000">// given BluetoothDevice
</span><span style="color:#008000"></span>        <span style="color:#00f">try</span> {
            <span style="color:#00f">if</span> (secure) {
                tmp = device.createRfcommSocketToServiceRecord(
                        MY_UUID_SECURE);
            } <span style="color:#00f">else</span> {
                tmp = device.createInsecureRfcommSocketToServiceRecord(
                        MY_UUID_INSECURE);
            }
        } <span style="color:#00f">catch</span> (IOException e) {
            Log.e(TAG, <span style="color:#a31515">&#34;Socket Type: &#34;</span> + mSocketType + <span style="color:#a31515">&#34;create() failed&#34;</span>, e);
        }
        mmSocket = tmp;
    }

    <span style="color:#00f">public</span> <span style="color:#2b91af">void</span> run() {
        Log.i(TAG, <span style="color:#a31515">&#34;BEGIN mConnectThread SocketType:&#34;</span> + mSocketType);
        setName(<span style="color:#a31515">&#34;ConnectThread&#34;</span> + mSocketType);

        <span style="color:#008000">// Always cancel discovery because it will slow down a connection
</span><span style="color:#008000"></span>        mAdapter.cancelDiscovery();

        <span style="color:#008000">// Make a connection to the BluetoothSocket
</span><span style="color:#008000"></span>        <span style="color:#00f">try</span> {
            <span style="color:#008000">// This is a blocking call and will only return on a
</span><span style="color:#008000"></span>            <span style="color:#008000">// successful connection or an exception
</span><span style="color:#008000"></span>            mmSocket.connect();
        } <span style="color:#00f">catch</span> (IOException e) {
            <span style="color:#008000">// Close the socket
</span><span style="color:#008000"></span>            <span style="color:#00f">try</span> {
                mmSocket.close();
            } <span style="color:#00f">catch</span> (IOException e2) {
                Log.e(TAG, <span style="color:#a31515">&#34;unable to close() &#34;</span> + mSocketType +
                        <span style="color:#a31515">&#34; socket during connection failure&#34;</span>, e2);
            }
            connectionFailed();
            <span style="color:#00f">return</span>;
        }

        <span style="color:#008000">// Reset the ConnectThread because we&#39;re done
</span><span style="color:#008000"></span>        <span style="color:#00f">synchronized</span> (BluetoothChatService.this) {
            mConnectThread = <span style="color:#00f">null</span>;
        }

        <span style="color:#008000">// Start the connected thread
</span><span style="color:#008000"></span>        connected(mmSocket, mmDevice, mSocketType);
    }

    <span style="color:#00f">public</span> <span style="color:#2b91af">void</span> cancel() {
        <span style="color:#00f">try</span> {
            mmSocket.close();
        } <span style="color:#00f">catch</span> (IOException e) {
            Log.e(TAG, <span style="color:#a31515">&#34;close() of connect &#34;</span> + mSocketType + <span style="color:#a31515">&#34; socket failed&#34;</span>, e);
        }
    }
}

<span style="color:#00f">public</span> <span style="color:#00f">synchronized</span> <span style="color:#2b91af">void</span> connected(BluetoothSocket socket, BluetoothDevice
        device, <span style="color:#00f">final</span> String socketType) {
    Log.d(TAG, <span style="color:#a31515">&#34;connected, Socket Type:&#34;</span> + socketType);

    <span style="color:#008000">// Cancel the thread that completed the connection
</span><span style="color:#008000"></span>    <span style="color:#00f">if</span> (mConnectThread != <span style="color:#00f">null</span>) {
        mConnectThread.cancel();
        mConnectThread = <span style="color:#00f">null</span>;
    }

    <span style="color:#008000">// Cancel any thread currently running a connection
</span><span style="color:#008000"></span>    <span style="color:#00f">if</span> (mConnectedThread != <span style="color:#00f">null</span>) {
        mConnectedThread.cancel();
        mConnectedThread = <span style="color:#00f">null</span>;
    }

    <span style="color:#008000">// Cancel the accept thread because we only want to connect to one device
</span><span style="color:#008000"></span>    <span style="color:#00f">if</span> (mSecureAcceptThread != <span style="color:#00f">null</span>) {
        mSecureAcceptThread.cancel();
        mSecureAcceptThread = <span style="color:#00f">null</span>;
    }
    <span style="color:#00f">if</span> (mInsecureAcceptThread != <span style="color:#00f">null</span>) {
        mInsecureAcceptThread.cancel();
        mInsecureAcceptThread = <span style="color:#00f">null</span>;
    }

    <span style="color:#008000">// Start the thread to manage the connection and perform transmissions
</span><span style="color:#008000"></span>    mConnectedThread = <span style="color:#00f">new</span> ConnectedThread(socket, socketType);
    mConnectedThread.start();

    <span style="color:#008000">// Send the name of the connected device back to the UI Activity
</span><span style="color:#008000"></span>    Message msg = mHandler.obtainMessage(Constants.MESSAGE_DEVICE_NAME);
    Bundle bundle = <span style="color:#00f">new</span> Bundle();
    bundle.putString(Constants.DEVICE_NAME, device.getName());
    msg.setData(bundle);
    mHandler.sendMessage(msg);

    setState(STATE_CONNECTED);
}
</code></pre></div><p>ConnectedThreadではsocketからinputStreamとoutputStreamを取得し、
runでは読んでメッセージで渡し、writeで書く。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java"><span style="color:#00f">private</span> <span style="color:#00f">class</span> <span style="color:#2b91af">ConnectedThread</span> <span style="color:#00f">extends</span> Thread {
    <span style="color:#00f">private</span> <span style="color:#00f">final</span> BluetoothSocket mmSocket;
    <span style="color:#00f">private</span> <span style="color:#00f">final</span> InputStream mmInStream;
    <span style="color:#00f">private</span> <span style="color:#00f">final</span> OutputStream mmOutStream;

    <span style="color:#00f">public</span> ConnectedThread(BluetoothSocket socket, String socketType) {
        Log.d(TAG, <span style="color:#a31515">&#34;create ConnectedThread: &#34;</span> + socketType);
        mmSocket = socket;
        InputStream tmpIn = <span style="color:#00f">null</span>;
        OutputStream tmpOut = <span style="color:#00f">null</span>;

        <span style="color:#008000">// Get the BluetoothSocket input and output streams
</span><span style="color:#008000"></span>        <span style="color:#00f">try</span> {
            tmpIn = socket.getInputStream();
            tmpOut = socket.getOutputStream();
        } <span style="color:#00f">catch</span> (IOException e) {
            Log.e(TAG, <span style="color:#a31515">&#34;temp sockets not created&#34;</span>, e);
        }

        mmInStream = tmpIn;
        mmOutStream = tmpOut;
    }

    <span style="color:#00f">public</span> <span style="color:#2b91af">void</span> run() {
        Log.i(TAG, <span style="color:#a31515">&#34;BEGIN mConnectedThread&#34;</span>);
        <span style="color:#2b91af">byte</span>[] buffer = <span style="color:#00f">new</span> <span style="color:#2b91af">byte</span>[1024];
        <span style="color:#2b91af">int</span> bytes;

        <span style="color:#008000">// Keep listening to the InputStream while connected
</span><span style="color:#008000"></span>        <span style="color:#00f">while</span> (mState == STATE_CONNECTED) {
            <span style="color:#00f">try</span> {
                <span style="color:#008000">// Read from the InputStream
</span><span style="color:#008000"></span>                bytes = mmInStream.read(buffer);

                <span style="color:#008000">// Send the obtained bytes to the UI Activity
</span><span style="color:#008000"></span>                mHandler.obtainMessage(Constants.MESSAGE_READ, bytes, -1, buffer)
                        .sendToTarget();
            } <span style="color:#00f">catch</span> (IOException e) {
                Log.e(TAG, <span style="color:#a31515">&#34;disconnected&#34;</span>, e);
                connectionLost();
                <span style="color:#008000">// Start the service over to restart listening mode
</span><span style="color:#008000"></span>                BluetoothChatService.this.start();
                <span style="color:#00f">break</span>;
            }
        }
    }

    <span style="color:#008000">/**
</span><span style="color:#008000">     * Write to the connected OutStream.
</span><span style="color:#008000">     *
</span><span style="color:#008000">     * @param buffer The bytes to write
</span><span style="color:#008000">     */</span>
    <span style="color:#00f">public</span> <span style="color:#2b91af">void</span> write(<span style="color:#2b91af">byte</span>[] buffer) {
        <span style="color:#00f">try</span> {
            mmOutStream.write(buffer);

            <span style="color:#008000">// Share the sent message back to the UI Activity
</span><span style="color:#008000"></span>            mHandler.obtainMessage(Constants.MESSAGE_WRITE, -1, -1, buffer)
                    .sendToTarget();
        } <span style="color:#00f">catch</span> (IOException e) {
            Log.e(TAG, <span style="color:#a31515">&#34;Exception during write&#34;</span>, e);
        }
    }

    <span style="color:#00f">public</span> <span style="color:#2b91af">void</span> cancel() {
        <span style="color:#00f">try</span> {
            mmSocket.close();
        } <span style="color:#00f">catch</span> (IOException e) {
            Log.e(TAG, <span style="color:#a31515">&#34;close() of connect socket failed&#34;</span>, e);
        }
    }
}
</code></pre></div><p>AcceptThreadでは常に受け入れられる形にしておく。もしつながったらConnectThreadと同様にconnectedする。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java"><span style="color:#00f">private</span> <span style="color:#00f">class</span> <span style="color:#2b91af">AcceptThread</span> <span style="color:#00f">extends</span> Thread {
    <span style="color:#008000">// The local server socket
</span><span style="color:#008000"></span>    <span style="color:#00f">private</span> <span style="color:#00f">final</span> BluetoothServerSocket mmServerSocket;
    <span style="color:#00f">private</span> String mSocketType;

    <span style="color:#00f">public</span> AcceptThread(<span style="color:#2b91af">boolean</span> secure) {
        BluetoothServerSocket tmp = <span style="color:#00f">null</span>;
        mSocketType = secure ? <span style="color:#a31515">&#34;Secure&#34;</span> : <span style="color:#a31515">&#34;Insecure&#34;</span>;

        <span style="color:#008000">// Create a new listening server socket
</span><span style="color:#008000"></span>        <span style="color:#00f">try</span> {
            <span style="color:#00f">if</span> (secure) {
                tmp = mAdapter.listenUsingRfcommWithServiceRecord(NAME_SECURE,
                        MY_UUID_SECURE);
            } <span style="color:#00f">else</span> {
                tmp = mAdapter.listenUsingInsecureRfcommWithServiceRecord(
                        NAME_INSECURE, MY_UUID_INSECURE);
            }
        } <span style="color:#00f">catch</span> (IOException e) {
            Log.e(TAG, <span style="color:#a31515">&#34;Socket Type: &#34;</span> + mSocketType + <span style="color:#a31515">&#34;listen() failed&#34;</span>, e);
        }
        mmServerSocket = tmp;
    }

    <span style="color:#00f">public</span> <span style="color:#2b91af">void</span> run() {
        Log.d(TAG, <span style="color:#a31515">&#34;Socket Type: &#34;</span> + mSocketType +
                <span style="color:#a31515">&#34;BEGIN mAcceptThread&#34;</span> + <span style="color:#00f">this</span>);
        setName(<span style="color:#a31515">&#34;AcceptThread&#34;</span> + mSocketType);

        BluetoothSocket socket = <span style="color:#00f">null</span>;

        <span style="color:#008000">// Listen to the server socket if we&#39;re not connected
</span><span style="color:#008000"></span>        <span style="color:#00f">while</span> (mState != STATE_CONNECTED) {
            <span style="color:#00f">try</span> {
                <span style="color:#008000">// This is a blocking call and will only return on a
</span><span style="color:#008000"></span>                <span style="color:#008000">// successful connection or an exception
</span><span style="color:#008000"></span>                socket = mmServerSocket.accept();
            } <span style="color:#00f">catch</span> (IOException e) {
                Log.e(TAG, <span style="color:#a31515">&#34;Socket Type: &#34;</span> + mSocketType + <span style="color:#a31515">&#34;accept() failed&#34;</span>, e);
                <span style="color:#00f">break</span>;
            }

            <span style="color:#008000">// If a connection was accepted
</span><span style="color:#008000"></span>            <span style="color:#00f">if</span> (socket != <span style="color:#00f">null</span>) {
                <span style="color:#00f">synchronized</span> (BluetoothChatService.this) {
                    <span style="color:#00f">switch</span> (mState) {
                        <span style="color:#00f">case</span> STATE_LISTEN:
                        <span style="color:#00f">case</span> STATE_CONNECTING:
                            <span style="color:#008000">// Situation normal. Start the connected thread.
</span><span style="color:#008000"></span>                            connected(socket, socket.getRemoteDevice(),
                                    mSocketType);
                            <span style="color:#00f">break</span>;
                        <span style="color:#00f">case</span> STATE_NONE:
                        <span style="color:#00f">case</span> STATE_CONNECTED:
                            <span style="color:#008000">// Either not ready or already connected. Terminate new socket.
</span><span style="color:#008000"></span>                            <span style="color:#00f">try</span> {
                                socket.close();
                            } <span style="color:#00f">catch</span> (IOException e) {
                                Log.e(TAG, <span style="color:#a31515">&#34;Could not close unwanted socket&#34;</span>, e);
                            }
                            <span style="color:#00f">break</span>;
                    }
                }
            }
        }
        Log.i(TAG, <span style="color:#a31515">&#34;END mAcceptThread, socket Type: &#34;</span> + mSocketType);

    }

    <span style="color:#00f">public</span> <span style="color:#2b91af">void</span> cancel() {
        Log.d(TAG, <span style="color:#a31515">&#34;Socket Type&#34;</span> + mSocketType + <span style="color:#a31515">&#34;cancel &#34;</span> + <span style="color:#00f">this</span>);
        <span style="color:#00f">try</span> {
            mmServerSocket.close();
        } <span style="color:#00f">catch</span> (IOException e) {
            Log.e(TAG, <span style="color:#a31515">&#34;Socket Type&#34;</span> + mSocketType + <span style="color:#a31515">&#34;close() of server failed&#34;</span>, e);
        }
    }
}
</code></pre></div><p>connectでは、接続しようとしているならそれをキャンセル、接続したものがあるならsocketを閉じて
新しい接続を始める。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java"><span style="color:#00f">public</span> <span style="color:#00f">synchronized</span> <span style="color:#2b91af">void</span> connect(BluetoothDevice device, <span style="color:#2b91af">boolean</span> secure) {
    Log.d(TAG, <span style="color:#a31515">&#34;connect to: &#34;</span> + device);

    <span style="color:#008000">// Cancel any thread attempting to make a connection
</span><span style="color:#008000"></span>    <span style="color:#00f">if</span> (mState == STATE_CONNECTING) {
        <span style="color:#00f">if</span> (mConnectThread != <span style="color:#00f">null</span>) {
            mConnectThread.cancel();
            mConnectThread = <span style="color:#00f">null</span>;
        }
    }

    <span style="color:#008000">// Cancel any thread currently running a connection
</span><span style="color:#008000"></span>    <span style="color:#00f">if</span> (mConnectedThread != <span style="color:#00f">null</span>) {
        mConnectedThread.cancel();
        mConnectedThread = <span style="color:#00f">null</span>;
    }

    <span style="color:#008000">// Start the thread to connect with the given device
</span><span style="color:#008000"></span>    mConnectThread = <span style="color:#00f">new</span> ConnectThread(device, secure);
    mConnectThread.start();
    setState(STATE_CONNECTING);
}
</code></pre></div><p>writeでは接続済みであることを確認後、connectedThreadの(参照を)コピーして、writeしている。
この間にmConnectedThreadにnullが代入されたりすることをsynchronizedで防ぐ。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java"><span style="color:#00f">public</span> <span style="color:#2b91af">void</span> write(<span style="color:#2b91af">byte</span>[] out) {
    <span style="color:#008000">// Create temporary object
</span><span style="color:#008000"></span>    ConnectedThread r;
    <span style="color:#008000">// Synchronize a copy of the ConnectedThread
</span><span style="color:#008000"></span>    <span style="color:#00f">synchronized</span> (<span style="color:#00f">this</span>) {
        <span style="color:#00f">if</span> (mState != STATE_CONNECTED) <span style="color:#00f">return</span>;
        r = mConnectedThread;
    }
    <span style="color:#008000">// Perform the write unsynchronized
</span><span style="color:#008000"></span>    r.write(out);
}
</code></pre></div><h2 id="devicelistactivity">DeviceListActivity</h2>
<p>検出可能にしている他端末を探し、選択する。</p>
<p><code>requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS)</code>して、
<code>setProgressBarIndeterminateVisibility(true)</code>すると右上にプログレスバーが表示できる。</p>
<p><code>new IntentFilter(BluetoothDevice.ACTION_FOUND)</code>と
<code>new IntentFilter(BluetoothAdapter.ACTION_DISCOVERY_FINISHED)</code>で
<code>registerReceiver(mReceiver, filter)</code>して、
デバイスを見つけたときと探し終わったときにブロードキャストされてくるインテントを受信するレシーバーを登録する。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java">@Override
<span style="color:#00f">protected</span> <span style="color:#2b91af">void</span> onCreate(Bundle savedInstanceState) {
    <span style="color:#00f">super</span>.onCreate(savedInstanceState);

    <span style="color:#008000">// Setup the window
</span><span style="color:#008000"></span>    requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);
    setContentView(R.layout.activity_device_list);

    <span style="color:#008000">// Set result CANCELED in case the user backs out
</span><span style="color:#008000"></span>    setResult(Activity.RESULT_CANCELED);

    <span style="color:#008000">// Initialize the button to perform device discovery
</span><span style="color:#008000"></span>    Button scanButton = (Button) findViewById(R.id.button_scan);
    scanButton.setOnClickListener(<span style="color:#00f">new</span> View.OnClickListener() {
        <span style="color:#00f">public</span> <span style="color:#2b91af">void</span> onClick(View v) {
            doDiscovery();
            v.setVisibility(View.GONE);
        }
    });

    <span style="color:#008000">// Initialize array adapters. One for already paired devices and
</span><span style="color:#008000"></span>    <span style="color:#008000">// one for newly discovered devices
</span><span style="color:#008000"></span>    ArrayAdapter&lt;String&gt; pairedDevicesArrayAdapter =
            <span style="color:#00f">new</span> ArrayAdapter&lt;String&gt;(<span style="color:#00f">this</span>, R.layout.device_name);
    mNewDevicesArrayAdapter = <span style="color:#00f">new</span> ArrayAdapter&lt;String&gt;(<span style="color:#00f">this</span>, R.layout.device_name);

    <span style="color:#008000">// Find and set up the ListView for paired devices
</span><span style="color:#008000"></span>    ListView pairedListView = (ListView) findViewById(R.id.paired_devices);
    pairedListView.setAdapter(pairedDevicesArrayAdapter);
    pairedListView.setOnItemClickListener(mDeviceClickListener);

    <span style="color:#008000">// Find and set up the ListView for newly discovered devices
</span><span style="color:#008000"></span>    ListView newDevicesListView = (ListView) findViewById(R.id.new_devices);
    newDevicesListView.setAdapter(mNewDevicesArrayAdapter);
    newDevicesListView.setOnItemClickListener(mDeviceClickListener);

    <span style="color:#008000">// Register for broadcasts when a device is discovered
</span><span style="color:#008000"></span>    IntentFilter filter = <span style="color:#00f">new</span> IntentFilter(BluetoothDevice.ACTION_FOUND);
    <span style="color:#00f">this</span>.registerReceiver(mReceiver, filter);

    <span style="color:#008000">// Register for broadcasts when discovery has finished
</span><span style="color:#008000"></span>    filter = <span style="color:#00f">new</span> IntentFilter(BluetoothAdapter.ACTION_DISCOVERY_FINISHED);
    <span style="color:#00f">this</span>.registerReceiver(mReceiver, filter);

    <span style="color:#008000">// Get the local Bluetooth adapter
</span><span style="color:#008000"></span>    mBtAdapter = BluetoothAdapter.getDefaultAdapter();

    <span style="color:#008000">// Get a set of currently paired devices
</span><span style="color:#008000"></span>    Set&lt;BluetoothDevice&gt; pairedDevices = mBtAdapter.getBondedDevices();

    <span style="color:#008000">// If there are paired devices, add each one to the ArrayAdapter
</span><span style="color:#008000"></span>    <span style="color:#00f">if</span> (pairedDevices.size() &gt; 0) {
        findViewById(R.id.title_paired_devices).setVisibility(View.VISIBLE);
        <span style="color:#00f">for</span> (BluetoothDevice device : pairedDevices) {
            pairedDevicesArrayAdapter.add(device.getName() + <span style="color:#a31515">&#34;\n&#34;</span> + device.getAddress());
        }
    } <span style="color:#00f">else</span> {
        String noDevices = getResources().getText(R.string.none_paired).toString();
        pairedDevicesArrayAdapter.add(noDevices);
    }
}

<span style="color:#00f">private</span> <span style="color:#2b91af">void</span> doDiscovery() {
    Log.d(TAG, <span style="color:#a31515">&#34;doDiscovery()&#34;</span>);

    <span style="color:#008000">// Indicate scanning in the title
</span><span style="color:#008000"></span>    setProgressBarIndeterminateVisibility(<span style="color:#00f">true</span>);
    setTitle(R.string.scanning);

    <span style="color:#008000">// Turn on sub-title for new devices
</span><span style="color:#008000"></span>    findViewById(R.id.title_new_devices).setVisibility(View.VISIBLE);

    <span style="color:#008000">// If we&#39;re already discovering, stop it
</span><span style="color:#008000"></span>    <span style="color:#00f">if</span> (mBtAdapter.isDiscovering()) {
        mBtAdapter.cancelDiscovery();
    }

    <span style="color:#008000">// Request discover from BluetoothAdapter
</span><span style="color:#008000"></span>    mBtAdapter.startDiscovery();
}

<span style="color:#00f">private</span> <span style="color:#00f">final</span> BroadcastReceiver mReceiver = <span style="color:#00f">new</span> BroadcastReceiver() {
    @Override
    <span style="color:#00f">public</span> <span style="color:#2b91af">void</span> onReceive(Context context, Intent intent) {
        String action = intent.getAction();

        <span style="color:#008000">// When discovery finds a device
</span><span style="color:#008000"></span>        <span style="color:#00f">if</span> (BluetoothDevice.ACTION_FOUND.equals(action)) {
            <span style="color:#008000">// Get the BluetoothDevice object from the Intent
</span><span style="color:#008000"></span>            BluetoothDevice device = intent.getParcelableExtra(BluetoothDevice.EXTRA_DEVICE);
            <span style="color:#008000">// If it&#39;s already paired, skip it, because it&#39;s been listed already
</span><span style="color:#008000"></span>            <span style="color:#00f">if</span> (device.getBondState() != BluetoothDevice.BOND_BONDED) {
                mNewDevicesArrayAdapter.add(device.getName() + <span style="color:#a31515">&#34;\n&#34;</span> + device.getAddress());
            }
            <span style="color:#008000">// When discovery is finished, change the Activity title
</span><span style="color:#008000"></span>        } <span style="color:#00f">else</span> <span style="color:#00f">if</span> (BluetoothAdapter.ACTION_DISCOVERY_FINISHED.equals(action)) {
            setProgressBarIndeterminateVisibility(<span style="color:#00f">false</span>);
            setTitle(R.string.select_device);
            <span style="color:#00f">if</span> (mNewDevicesArrayAdapter.getCount() == 0) {
                String noDevices = getResources().getText(R.string.none_found).toString();
                mNewDevicesArrayAdapter.add(noDevices);
            }
        }
    }
};
</code></pre></div><p>onDestroyで、探索をやめ、登録したレシーバーを外す。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java">@Override
<span style="color:#00f">protected</span> <span style="color:#2b91af">void</span> onDestroy() {
    <span style="color:#00f">super</span>.onDestroy();

    <span style="color:#008000">// Make sure we&#39;re not doing discovery anymore
</span><span style="color:#008000"></span>    <span style="color:#00f">if</span> (mBtAdapter != <span style="color:#00f">null</span>) {
        mBtAdapter.cancelDiscovery();
    }

    <span style="color:#008000">// Unregister broadcast listeners
</span><span style="color:#008000"></span>    <span style="color:#00f">this</span>.unregisterReceiver(mReceiver);
}
</code></pre></div><p>接続先リストから選択されたら、アドレスを付けて結果を返す。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java"><span style="color:#00f">private</span> AdapterView.OnItemClickListener mDeviceClickListener
        = <span style="color:#00f">new</span> AdapterView.OnItemClickListener() {
    <span style="color:#00f">public</span> <span style="color:#2b91af">void</span> onItemClick(AdapterView&lt;?&gt; av, View v, <span style="color:#2b91af">int</span> arg2, <span style="color:#2b91af">long</span> arg3) {
        <span style="color:#008000">// Cancel discovery because it&#39;s costly and we&#39;re about to connect
</span><span style="color:#008000"></span>        mBtAdapter.cancelDiscovery();

        <span style="color:#008000">// Get the device MAC address, which is the last 17 chars in the View
</span><span style="color:#008000"></span>        String info = ((TextView) v).getText().toString();
        String address = info.substring(info.length() - 17);

        <span style="color:#008000">// Create the result Intent and include the MAC address
</span><span style="color:#008000"></span>        Intent intent = <span style="color:#00f">new</span> Intent();
        intent.putExtra(EXTRA_DEVICE_ADDRESS, address);

        <span style="color:#008000">// Set result and finish this Activity
</span><span style="color:#008000"></span>        setResult(Activity.RESULT_OK, intent);
        finish();
    }
};
</code></pre></div>
    </div>
    <div class="share">
      <div class="cell">
        <div>share</div>
        <div>
          <a class="share-button" href='https://twitter.com/intent/tweet?url=https://www.sambaiz.net/article/23/&text=android-bluetoothChat%e3%82%92%e8%aa%ad%e3%82%80%20-%20sambaiz-net'>
            <img src="/image/twitter.png" width="40px" height="40px" alt="twitter">
          </a>
          <a href="https://b.hatena.ne.jp/entry/" class="share-button hatena-bookmark-button" data-hatena-bookmark-layout="touch" data-hatena-bookmark-width="40" data-hatena-bookmark-height="40" title="このエントリーをはてなブックマークに追加">
            <img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="40" height="40" style="border: none;" />
          </a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
        </div>
      </div>
    </div>
  </article>
</div>

</div>
</body>

</html>