<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="generator" content="Hugo 0.69.2" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
    crossorigin="anonymous">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/magula.min.css">
  <link rel="stylesheet" href="/css/slidebars.min.css">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>Firebaseをwebで使う(Hosting, Authentication, Realtime Database, Storage) - sambaiz-net</title>
  <meta name="twitter:title" content="Firebaseをwebで使う(Hosting, Authentication, Realtime Database, Storage) - sambaiz-net">
  <meta property='og:title' content="Firebaseをwebで使う(Hosting, Authentication, Realtime Database, Storage) - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="GoogleのmBaaS">
  <meta name="twitter:description" content="GoogleのmBaaS">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/article/94/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />
  <meta name="google-site-verification" content="CEqNYjzc4Y7hb3FY7uUkmllGzeDc40brBwQJixeH61Q" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id":"https:\/\/www.sambaiz.net\/"
    },
    "headline": "Firebaseをwebで使う(Hosting, Authentication, Realtime Database, Storage) | sambaiz-net ",
    "datePublished": "2017-04-16T20:03:00JST",
    "dateModified": "2017-04-16T20:03:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "image": "https:\/\/www.sambaiz.net\/images/my.jpg"
    },
    "publisher": {
      "@type": "Organization",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https:\/\/www.sambaiz.net\/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https:\/\/www.sambaiz.net\/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "GoogleのmBaaS"
  }
</script>
</head>

<body>
  <div off-canvas="id-1 left reveal">
  
  <ul class="tag-list">
    
  </ul>
  
  <ul class="tag-list">
    <li><a href="https://www.sambaiz.net/tags/aws">aws</a></li><li><a href="https://www.sambaiz.net/tags/golang">golang</a></li><li><a href="https://www.sambaiz.net/tags/machinelearning">machinelearning</a></li><li><a href="https://www.sambaiz.net/tags/log">log</a></li><li><a href="https://www.sambaiz.net/tags/kubernetes">kubernetes</a></li><li><a href="https://www.sambaiz.net/tags/infra">infra</a></li><li><a href="https://www.sambaiz.net/tags/python">python</a></li><li><a href="https://www.sambaiz.net/tags/lambda">lambda</a></li><li><a href="https://www.sambaiz.net/tags/tensorflow">tensorflow</a></li><li><a href="https://www.sambaiz.net/tags/unity">unity</a></li><li><a href="https://www.sambaiz.net/tags/fluentd">fluentd</a></li><li><a href="https://www.sambaiz.net/tags/gcp">gcp</a></li><li><a href="https://www.sambaiz.net/tags/node.js">node.js</a></li><li><a href="https://www.sambaiz.net/tags/web">web</a></li><li><a href="https://www.sambaiz.net/tags/docker">docker</a></li><li><a href="https://www.sambaiz.net/tags/ios">ios</a></li><li><a href="https://www.sambaiz.net/tags/linux">linux</a></li><li><a href="https://www.sambaiz.net/tags/mysql">mysql</a></li><li><a href="https://www.sambaiz.net/tags/elasticsearch">elasticsearch</a></li><li><a href="https://www.sambaiz.net/tags/javascript">javascript</a></li><li><a href="https://www.sambaiz.net/tags/hololens">hololens</a></li><li><a href="https://www.sambaiz.net/tags/auth">auth</a></li><li><a href="https://www.sambaiz.net/tags/c&#43;&#43;">c&#43;&#43;</a></li><li><a href="https://www.sambaiz.net/tags/product">product</a></li><li><a href="https://www.sambaiz.net/tags/swift">swift</a></li><li><a href="https://www.sambaiz.net/tags/circleci">circleci</a></li><li><a href="https://www.sambaiz.net/tags/react">react</a></li><li><a href="https://www.sambaiz.net/tags/typescript">typescript</a></li><li><a href="https://www.sambaiz.net/tags/algorithm">algorithm</a></li><li><a href="https://www.sambaiz.net/tags/android">android</a></li><li><a href="https://www.sambaiz.net/tags/ble">ble</a></li><li><a href="https://www.sambaiz.net/tags/event">event</a></li><li><a href="https://www.sambaiz.net/tags/angular">angular</a></li><li><a href="https://www.sambaiz.net/tags/cron">cron</a></li><li><a href="https://www.sambaiz.net/tags/istio">istio</a></li><li><a href="https://www.sambaiz.net/tags/terraform">terraform</a></li><li><a href="https://www.sambaiz.net/tags/uwp">uwp</a></li><li><a href="https://www.sambaiz.net/tags/.net">.net</a></li><li><a href="https://www.sambaiz.net/tags/crypto">crypto</a></li><li><a href="https://www.sambaiz.net/tags/css">css</a></li><li><a href="https://www.sambaiz.net/tags/datadog">datadog</a></li><li><a href="https://www.sambaiz.net/tags/firebase">firebase</a></li><li><a href="https://www.sambaiz.net/tags/github">github</a></li><li><a href="https://www.sambaiz.net/tags/grpc">grpc</a></li><li><a href="https://www.sambaiz.net/tags/hadoop">hadoop</a></li><li><a href="https://www.sambaiz.net/tags/norikra">norikra</a></li><li><a href="https://www.sambaiz.net/tags/rx">rx</a></li><li><a href="https://www.sambaiz.net/tags/server">server</a></li><li><a href="https://www.sambaiz.net/tags/statistics">statistics</a></li><li><a href="https://www.sambaiz.net/tags/vr">vr</a></li><li><a href="https://www.sambaiz.net/tags/ansible">ansible</a></li><li><a href="https://www.sambaiz.net/tags/api">api</a></li><li><a href="https://www.sambaiz.net/tags/cdn">cdn</a></li><li><a href="https://www.sambaiz.net/tags/compress">compress</a></li><li><a href="https://www.sambaiz.net/tags/csharp">csharp</a></li><li><a href="https://www.sambaiz.net/tags/d3.js">d3.js</a></li><li><a href="https://www.sambaiz.net/tags/digdag">digdag</a></li><li><a href="https://www.sambaiz.net/tags/hugo">hugo</a></li><li><a href="https://www.sambaiz.net/tags/jenkins">jenkins</a></li><li><a href="https://www.sambaiz.net/tags/jvm">jvm</a></li><li><a href="https://www.sambaiz.net/tags/kotlin">kotlin</a></li><li><a href="https://www.sambaiz.net/tags/language">language</a></li><li><a href="https://www.sambaiz.net/tags/leveldb">leveldb</a></li><li><a href="https://www.sambaiz.net/tags/lisp">lisp</a></li><li><a href="https://www.sambaiz.net/tags/math">math</a></li><li><a href="https://www.sambaiz.net/tags/neo4j">neo4j</a></li><li><a href="https://www.sambaiz.net/tags/objective-c">objective-c</a></li><li><a href="https://www.sambaiz.net/tags/pytorch">pytorch</a></li><li><a href="https://www.sambaiz.net/tags/read_paper">read_paper</a></li><li><a href="https://www.sambaiz.net/tags/scikit-learn">scikit-learn</a></li><li><a href="https://www.sambaiz.net/tags/serialize">serialize</a></li><li><a href="https://www.sambaiz.net/tags/sonnet">sonnet</a></li><li><a href="https://www.sambaiz.net/tags/spark">spark</a></li><li><a href="https://www.sambaiz.net/tags/spec">spec</a></li><li><a href="https://www.sambaiz.net/tags/video">video</a></li><li><a href="https://www.sambaiz.net/tags/vscode">vscode</a></li>
  </ul>
  
</div>

  <div canvas="container" id="container">
    <header>
      <button type="button" class="btn toggle-side">TAG</button>

      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" />
        <a class="nl" href="https://www.sambaiz.net/">sambaiz-net</a>
      </div>

      <div class="sns">
        <a class="nl" href="https://twitter.com/sambaiz"><i class="fa fa-2x fa-twitter"></i></a>
        <a class="nl" href="https://github.com/sambaiz"><i class="fa fa-2x fa-github"></i></a>
        <style>
          .filmarks-base {
            display: inline-block;
            width: 29px;
            height: 29px;
          }

          .filmarks {
            display: inline-block;
            width: 25px;
            height: 25px;
            background: url(/image/filmarks.svg) no-repeat;
            background-size: 450%;
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
          }

          .vocabularycom-base {
            display: inline-block;
            width: 29px;
            height: 29px;
          }

          .vocabularycom {
            display: inline-block;
            height: 25px;
            width: 25px;
            background: url(/image/vocabularycom.png) no-repeat;
            background-size: contain;
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
          }

          .leetcode-base {
            display: inline-block;
            width: 29px;
            height: 29px;
          }

          .leetcode {
            display: inline-block;
            height: 25px;
            width: 25px;
            background: url(/image/leetcode.png) no-repeat;
            background-size: contain;
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
          }
        </style>
        <div class="filmarks-base">
          <a href="https://filmarks.com/users/sambaiz" class="filmarks"></a>
        </div>
        <div class="vocabularycom-base">
          <a href="https://www.vocabulary.com/profiles/B0JI0K19KKMVKH" class="vocabularycom"></a>
        </div>
        <div class="leetcode-base">
          <a href="https://leetcode.com/sambaiz/" class="leetcode"></a>
        </div>
      </div>
    </header>

<div class="container">

  <div class="row">
    <div class="col-md-12">

      <article class="single">
        <div class="single body">
          <h1>Firebaseをwebで使う(Hosting, Authentication, Realtime Database, Storage)</h1>
          <p>(2017-04-16)</p>
          <h2 id="firebasehttpsfirebasegooglecomhljaとは"><a href="https://firebase.google.com/?hl=ja">Firebase</a>とは</h2>
<p>GoogleのmBaaS。Android/iOSアプリの開発に使う認証、データストア、クラッシュレポート、分析、通知、広告などなど全部入りサービス。
今年のGoogleI/Oでも<a href="https://events.google.com/io/schedule/?section=may-19">毎時間のように</a>
Firebaseのセッションがあって大分推している印象。</p>
<p>基本的にはアプリで使うのだけれど、webで使える機能も結構ある。今回は</p>
<ul>
<li>Hosting</li>
<li>Authentication</li>
<li>Realtime Database</li>
<li>Storage</li>
</ul>
<p>を使ってみる。</p>
<h2 id="料金httpsfirebasegooglecompricing"><a href="https://firebase.google.com/pricing/">料金</a></h2>
<p>プランは無料のSPARKと25ドル/月のFLAME、従量課金のBLAZEがある。
試す分にはSPARKで十分だけど、Realtime Databaseの同時接続数が100なので注意。</p>
<h2 id="セットアップhttpsfirebasegooglecomdocswebsetup"><a href="https://firebase.google.com/docs/web/setup">セットアップ</a></h2>
<p><a href="https://firebase.google.com/docs/cli/">firebase-cli</a>をインストール、ログインして初期化する。</p>
<pre><code>$ npm install -g firebase-tools
$ firebase login
$ mkdir firebase-chat &amp;&amp; cd firebase-chat
$ firebase init
...
? What Firebase CLI features do you want to setup for this folder? 
❯◉ Database: Deploy Firebase Realtime Database Rules
 ◉ Functions: Configure and deploy Cloud Functions
 ◉ Hosting: Configure and deploy Firebase Hosting sites

? What Firebase project do you want to associate as default? *****

? What file should be used for Database Rules? database.rules.json

? Do you want to install dependencies with npm now? Yes

? What do you want to use as your public directory? public

? Configure as a single-page app (rewrite all urls to /index.html)? Yes

✔  Firebase initialization complete!

$ ls
database.rules.json	firebase.json		functions		public
</code></pre><p>firebase.jsonはこんな感じ。</p>
<pre><code>$ cat firebase.json
{
  &quot;database&quot;: {
    &quot;rules&quot;: &quot;database.rules.json&quot;
  },
  &quot;hosting&quot;: {
    &quot;public&quot;: &quot;public&quot;,
    &quot;rewrites&quot;: [
      {
        &quot;source&quot;: &quot;**&quot;,
        &quot;destination&quot;: &quot;/index.html&quot;
      }
    ]
  }
}
</code></pre><p>ローカルでサーバーを立ち上げて確認する。</p>
<pre><code>$ firebase serve
Server listening at: http://localhost:5000

$ curl http://localhost:5000 # Firebase SDK loaded with auth, database, messaging, storage
</code></pre><h2 id="hostinghttpsfirebasegooglecomdocshostinghlja"><a href="https://firebase.google.com/docs/hosting/?hl=ja">Hosting</a></h2>
<p>静的サイトのホスティング。もちろん独自ドメインも使える。</p>
<pre><code>$ firebase deploy --only hosting
...
✔  Deploy complete!

Project Console: https://console.firebase.google.com/project/*****/overview
Hosting URL: https://*****.firebaseapp.com
</code></pre><h2 id="authenticationhttpsfirebasegooglecomdocsauth"><a href="https://firebase.google.com/docs/auth/">Authentication</a></h2>
<p>ユーザー認証。Googleだけではなく、TwitterやFacebook、Githubといったプロバイダや、メールとパスワードでの認証が用意されていて、
コンソールから有効にする必要がある。</p>
<p>実装はFirebase SDKで自分でやるか、</p>
<pre><code>const provider = new firebase.auth.GoogleAuthProvider();
firebase.auth().signInWithPopup(provider).then((result) =&gt; {
    console.log(`sign in successfully. ${result.user.displayName}`)
}).catch((error) =&gt; {
    console.log(`fail to sign in. ${error.message}`)
});
</code></pre><p><a href="https://github.com/firebase/FirebaseUI-Web">FirebaseUI Auth</a>を使う。</p>
<pre><code>&lt;script defer src=&quot;https://cdn.firebase.com/libs/firebaseui/1.0.1/firebaseui.js&quot;&gt;&lt;/script&gt;
&lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;https://cdn.firebase.com/libs/firebaseui/1.0.1/firebaseui.css&quot; /&gt;

&lt;div id=&quot;firebaseui-auth-container&quot;&gt;&lt;/div&gt;
</code></pre><pre><code>// FirebaseUI config.
var uiConfig = {
  signInOptions: [
    // Leave the lines as is for the providers you want to offer your users.
    firebase.auth.GoogleAuthProvider.PROVIDER_ID
  ],
  callbacks: {
    signInSuccess: function(currentUser, credential, redirectUrl) {
      // リダイレクトさせない
      return false;
    }
  },
  // Terms of service url.
  tosUrl: '&lt;your-tos-url&gt;'
};

// Initialize the FirebaseUI Widget using Firebase.
var ui = new firebaseui.auth.AuthUI(firebase.auth());
// The start method will wait until the DOM is loaded.
ui.start('#firebaseui-auth-container', uiConfig);
</code></pre><p>こんな感じにボタンが並ぶ。</p>
<p><img src="https://www.sambaiz.net/images/93-firebase-authentication.png" alt="Firebase authentication"></p>
<p><code>onAuthStateChanged()</code>でsign in/outをハンドリングでき、</p>
<pre><code>firebase.auth().onAuthStateChanged((user) =&gt; {
    if (user) {
      console.log(`${user.displayName} sign in`);
    } else {
      console.log('sign out');
    }
  }, (error) =&gt; {
    console.log(error);
  }
);
</code></pre><p>currentUserでsign inしてるユーザーを取得できる。</p>
<pre><code>if(firebase.auth().currentUser){
  console.log(firebase.auth().currentUser.displayName);
}else{
  // need to sign in
}
</code></pre><h2 id="realtime-databasehttpsfirebasegooglecomdocsdatabase"><a href="https://firebase.google.com/docs/database/">Realtime Database</a></h2>
<p>NoSQLなデータベース。直接読み書きするのではなく、
ローカルにデータを保存してリアルタイムに同期するため一時的にオフライン状態になっても読み書きできる。</p>
<h3 id="読み書きhttpsfirebasegooglecomdocsdatabasewebread-and-write"><a href="https://firebase.google.com/docs/database/web/read-and-write">読み書き</a></h3>
<p>データベースへの書き込みと更新。refで<code>users/1</code>のように参照を取って操作する。
<a href="https://firebase.google.com/docs/reference/js/firebase.database.Reference?hl=ja#push">push()</a>で
<code>hoge/-Khp36CCygw5AI6G8L1B</code>のようなユニークなキーを発行することができ、これは時系列にソートされるようになっている。</p>
<pre><code>const database = firebase.database();

for(let i = 0; i &lt; 10; i++){
    
    const newHogeRef = database.ref('hoge').push();
    console.log(`newHogeRef: ${newHogeRef.toString()}`);
    
    newHogeRef.set({
        idx: i,
        aaa: &quot;bbb123&quot;,
    });

    newHogeRef.update({
        aaa: &quot;bbb456&quot;,
        eee: &quot;fff&quot;
    });
}
</code></pre><pre><code>newHogeRef: https://test-3a363.firebaseio.com/hoge/-Khp36CCygw5AI6G8L1B
newHogeRef: https://test-3a363.firebaseio.com/hoge/-Khp36CLyJ9BQVefW-l5
newHogeRef: https://test-3a363.firebaseio.com/hoge/-Khp36CMs9-jJoKUUgr0
</code></pre><p><a href="https://firebase.google.com/docs/reference/js/firebase.database.Reference?hl=ja#on">on()</a>で
value eventを拾うと、
呼んだときとデータに変更があったときに<a href="https://firebase.google.com/docs/reference/js/firebase.database.DataSnapshot?hl=ja">snapshot</a>が取得できる。</p>
<pre><code>database.ref(&quot;hoge&quot;).orderByKey().limitToLast(3).on(&quot;value&quot;, (snapshot) =&gt; {
    snapshot.forEach((data) =&gt; console.log(data.val()));
});
</code></pre><pre><code>...
Object {aaa: &quot;bbb456&quot;, eee: &quot;fff&quot;, idx: 7}
Object {aaa: &quot;bbb456&quot;, eee: &quot;fff&quot;, idx: 8}
Object {aaa: &quot;bbb456&quot;, eee: &quot;fff&quot;, idx: 9}
</code></pre><h3 id="アクセス権限バリデーションhttpsfirebasegooglecomdocsdatabasesecuritysecuring-data"><a href="https://firebase.google.com/docs/database/security/securing-data">アクセス権限・バリデーション</a></h3>
<p>firebase.jsonで指定しているdatabase ruleファイル(database.rules.json)でルールを設定する。
デフォルトで認証していれば読み書きできる設定になっている。</p>
<pre><code>{
  &quot;rules&quot;: {
    &quot;.read&quot;: &quot;auth != null&quot;,
    &quot;.write&quot;: &quot;auth != null&quot;
  }
}
</code></pre><p>read/writeだけではなくバリデーションの設定もこんな感じでできる。
これは<code>users/${ユーザーのuid}</code>への読み書きを本人のみができるようにするもの。</p>
<pre><code>{
  &quot;rules&quot;: {
    &quot;users&quot;: {
      &quot;$uid&quot;: {
        &quot;.read&quot;: &quot;$uid === auth.uid&quot;,
        &quot;.write&quot;: &quot;$uid === auth.uid&quot;,
        &quot;.validate&quot;: &quot;newData.hasChildren(['age', 'name']) &amp;&amp; newData.child('age').isNumber() &amp;&amp; newData.child('age').val() &gt;= 0 &amp;&amp; newData.child('age').val() &lt; 200 &amp;&amp; newData.child('name').isString() &amp;&amp; newData.child('name').val().length &lt; 50&quot;
      }
    }
  }
}
</code></pre><pre><code>$ firebase deploy --only database
</code></pre><p>上の設定を適用したデータベースに読み書きしてみる。</p>
<pre><code>const uid = firebase.auth().currentUser.uid;

database.ref(`users/${uid}`).set({
    age: 20,
    name: &quot;taro&quot;
});

// ok: Object {age: 20, name: &quot;taro&quot;}
database.ref(`users/${uid}`).on(&quot;value&quot;, (snapshot) =&gt; {
    console.log(snapshot.val()); // Object {age: 20, name: &quot;taro&quot;}
});
</code></pre><p>以下のような不正なデータや不正なキーに書き込もうとすると
<code>PERMISSION_DENIED: Permission denied</code>になる。</p>
<pre><code>// ageがおかしい
database.ref(`users/${uid}`).set({
    age: &quot;aaaa&quot;,
    name: &quot;jiro&quot;
});

// 本人じゃない
database.ref(`users/hogehoge`).set({
    age: 20,
    name: &quot;jiro&quot;
});
</code></pre><p>ちなみに、さっきまでアクセスできていたhogeにもアクセスできなくなっている。</p>
<pre><code>// PERMISSION_DENIED: Permission denied
database.ref(&quot;hoge&quot;).orderByKey().limitToLast(3).on(&quot;value&quot;, (snapshot) =&gt; {
    snapshot.forEach((data) =&gt; console.log(data.val()));
});
</code></pre><p>これを解決するためにrulesのルートに<code>auth != null</code>の設定を入れてしまうと、
<a href="https://firebase.google.com/docs/database/security/securing-data#read_and_write_rules_cascade">浅い階層のルールが深い階層のルールより優先される</a>
ためusersのread/writeの設定が無効になってしまうので注意。ただしvalidateはそれぞれの階層でチェックされる。</p>
<pre><code>{
  &quot;rules&quot;: {
    &quot;.read&quot;: &quot;auth != null&quot;,
    &quot;.write&quot;: &quot;auth != null&quot;,
    &quot;users&quot;: {
      &quot;$uid&quot;: {
        &quot;.read&quot;: &quot;$uid === auth.uid&quot;,
        &quot;.write&quot;: &quot;$uid === auth.uid&quot;,
        &quot;.validate&quot;: &quot;newData.hasChildren(['age', 'name']) &amp;&amp; newData.child('age').isNumber() &amp;&amp; newData.child('age').val() &gt;= 0 &amp;&amp; newData.child('age').val() &lt; 200 &amp;&amp; newData.child('name').isString() &amp;&amp; newData.child('name').val().length &lt; 50&quot;
      }
    }
  }
}
</code></pre><h2 id="storagehttpsfirebasegooglecomdocsstorage"><a href="https://firebase.google.com/docs/storage/">Storage</a></h2>
<p>画像などを保存しておくために使う。
Realtime Databaseと同様、
ネットワーク品質が良くない環境でも使えるように、処理が中断されても途中から処理を再開するようになっている。
裏側ではGoogle Cloud Storageが使われている。</p>
<h3 id="アップロードhttpsfirebasegooglecomdocsstoragewebupload-files"><a href="https://firebase.google.com/docs/storage/web/upload-files">アップロード</a></h3>
<pre><code>&lt;input type=&quot;file&quot; id=&quot;file-upload&quot;&gt;
</code></pre><pre><code>const storage = firebase.storage();

const inputFile = document.getElementById('file-upload');

inputFile.addEventListener('change', (e) =&gt; {
  const files = e.target.files;
  const user = firebase.auth().currentUser;
  if(user){
    const ref = storage.ref(`images/${user.uid}`);
    const uploadTask = ref.put(files[0]);
  }
}, false);
</code></pre><p>中断、再開、キャンセル。</p>
<pre><code>uploadTask.pause();
uploadTask.resume();
uploadTask.cancel();
</code></pre><p>アップロードの状態はstage_changed eventで確認し、完了するとダウンロードURLを取得できる。</p>
<pre><code>uploadTask.on('state_changed', (snapshot) =&gt; {

  const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
  console.log('Upload is ' + progress + '% done');

  switch (snapshot.state) {
    case firebase.storage.TaskState.PAUSED: // or 'paused'
      console.log('Upload is paused');
      break;
    case firebase.storage.TaskState.RUNNING: // or 'running'
      console.log('Upload is running');
      break;
  }
}, (error) =&gt; {
  // Handle unsuccessful uploads
  console.log(error);
}, () =&gt; {
  // Handle successful uploads on complete
  // For instance, get the download URL: https://firebasestorage.googleapis.com/...
  console.log(uploadTask.snapshot.downloadURL);
});
</code></pre><h3 id="アクセス制限バリデーションhttpsfirebasegooglecomdocsstoragesecurityhlja"><a href="https://firebase.google.com/docs/storage/security/?hl=ja">アクセス制限・バリデーション</a></h3>
<p>Realtime Databaseと同様にアクセス制限やバリデーションをかけることができる。
設定はコンソールから。</p>
<p><img src="https://www.sambaiz.net/images/93-firebase-storage-rule.png" alt="Storageのルール"></p>
<pre><code>service firebase.storage {
  match /b/*****.appspot.com/o {
    match /images/{imageId} {
      // Only allow uploads of any image file that's less than 5MB
      allow write: if request.resource.size &lt; 5 * 1024 * 1024
                   &amp;&amp; request.resource.contentType.matches('image/.*')
                   &amp;&amp; request.auth != null;
      allow read: if request.auth != null;             
    }
  }
}
</code></pre><h3 id="ダウンロードhttpsfirebasegooglecomdocsstoragewebdownload-files"><a href="https://firebase.google.com/docs/storage/web/download-files">ダウンロード</a></h3>
<p><code>getDownloadURL()</code>でURLを取得する。</p>
<pre><code>&lt;img id=&quot;myimg&quot;&gt;
</code></pre><pre><code>const ref = storage.ref(`images/${user.uid}`).getDownloadURL().then((url) =&gt; {
  
  const img = document.getElementById('myimg');
  img.src = url;

}).catch((error) =&gt; {

  switch (error.code) {
    case 'storage/object-not-found':
      console.log(&quot;not found&quot;);
      break;

    default:
      console.log(error);
  }
});;
</code></pre>
        </div>
      </article>
    </div>
  </div>
</div>

</div> 
<script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script src="/js/slidebars.min.js"></script>
<script>
    ( function ( $ ) {
      
      var controller = new slidebars();
      controller.init();

      $( '.toggle-side' ).on( 'click', function ( event ) {
          event.stopPropagation();
          event.preventDefault();

          controller.toggle( 'id-1' );
        } );

        $( '#container' ).on( 'click', function ( event ) {
            controller.close( 'id-1' );
          });
    } ) ( jQuery );
</script>

<script>hljs.initHighlightingOnLoad();</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-39190067-3', 'auto');
ga('send', 'pageview');
</script>


  </body>
</html>

