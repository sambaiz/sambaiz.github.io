<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="generator" content="Hugo 0.79.1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <style>
    body {
        background-color: #f1f1f1;
        line-height: 1.3;
        font-family: -apple-system, "BlinkMacSystemFont", "Helvetica Neue", "Yu Gothic", YuGothic, Verdana, Meiryo, sans-serif;
    }

    header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
    }

    header>.title {
        font-size: 1.875rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sns-item {
        display: inline-block;
        margin: 3px;
    }

    .filmarks {
        display: inline-block;
        width: 30px;
        height: 30px;
        margin-top: 3px;
        background: url(/image/filmarks.svg) no-repeat;
        background-size: 450%;
    }

    header>.tags {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        max-width: 1000px;
        margin: auto;
        padding: 0 20px;
    }

    header>.tags .others {
        font-weight: bold;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .nl {
        display: inline-block;
    }

    .cell {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
    }

    time {
        color: #333;
    }

    .tag {
        color: #3a9240;
        margin: 0 5px;
    }

    .tag:hover {
        text-decoration: underline;
    }

     
    .paging {
        display: inline-block;
        font-size: 1.25rem;
        margin: 10px 10px;
    }

    .paging.next {
        float: right;
    }


     
    .list>.title {
        font-size: 1.75rem;
        margin: 0 0 10px 10px;
    }

     
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(262px, 1fr));
        gap: 20px;
        margin: 0 10px;
    }

    .grid-nl {
        width: 100%;
    }

    .grid-cell {
        height: 11.25rem;
        overflow: hidden;
        box-sizing: content-box;
    }

    .grid-cell>.title {
        font-size: 1.5rem;
        word-wrap: break-word;
    }

     
    .single {
        margin: 0 10px 10px 10px;
        line-height: 1.5;
    }

    @media screen and (min-width: 768px) {
        .single .cell {
            padding: 10px 20px;
        }
    }

    .single-header {
        margin-block-start: 1.875rem;
        margin-block-end: 1.875rem;
        line-height: 1.3;
    }

    .single-header h1 {
        font-size: 2rem;
        font-weight: bold;
    }

    .single h2 {
        font-size: 1.8rem;
        border-bottom: 1px solid #ddd;
        margin-block-start: 1.875rem;
    }

    .single h3 {
        font-size: 1.5rem;
        margin-block-start: 1.5rem;
    }

    .single h4 {
        font-size: 1.2rem;
        margin-block-start: 1rem;
    }

    .single a {
        color: #3a9240;
    }

    .single a:hover {
        text-decoration: underline;
    }

    .single p {
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single p>code {
        background-color: #eee;
        color: #333;
        padding: 0 0.2rem;
        display: inline-block;
        overflow: auto;
        max-width: 100%;
        vertical-align: bottom;
    }

    .single .highlight {
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3), 0 0 1px rgba(0, 0, 0, 0.1) inset;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single .highlight>pre {
        padding: 10px;
        overflow-x: auto;
    }

    .single img {
        max-width: 100%;
    }

    .single blockquote {
        border-left: 5px solid #ddd;
        color: #777;
        padding: 1rem 0 1rem 1rem;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }

    .single hr {
        color: #bbb;
        margin-block-start: 1.5rem;
        margin-block-end: 1.5rem;
    }

    .single ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-block-start: 0.83rem;
        margin-block-end: 0.83rem;
    }
</style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>TensorFlowのモデルをTPUに対応させてColabで学習し実行時間を計測する - sambaiz-net</title>
  <meta name="twitter:title" content="TensorFlowのモデルをTPUに対応させてColabで学習し実行時間を計測する - sambaiz-net">
  <meta property='og:title' content="TensorFlowのモデルをTPUに対応させてColabで学習し実行時間を計測する - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="CPU/GPU/TPUでCNNを学習させて実行時間を比較する">
  <meta name="twitter:description" content="CPU/GPU/TPUでCNNを学習させて実行時間を比較する">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/article/199/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />
  <meta name="google-site-verification" content="CEqNYjzc4Y7hb3FY7uUkmllGzeDc40brBwQJixeH61Q" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id":"https:\/\/www.sambaiz.net\/"
    },
    "headline": "TensorFlowのモデルをTPUに対応させてColabで学習し実行時間を計測する - sambaiz-net",
    "datePublished": "2018-11-27T09:57:00JST",
    "dateModified": "2018-11-27T09:57:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "image": "https:\/\/www.sambaiz.net\/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https:\/\/www.sambaiz.net\/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https:\/\/www.sambaiz.net\/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "CPU\/GPU\/TPUでCNNを学習させて実行時間を比較する"
  }
</script>
</head>

<body>
  <div>
    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" alt="アイコン" />
        <a class="nl" href="https://www.sambaiz.net/">
          <h1>sambaiz-net</h1>
        </a>
      </div>

      <div class="sns">
        <div class="sns-item">
          <a class="nl" href="https://twitter.com/sambaiz">
            <img src="//www.sambaiz.net/image/twitter.png" width="30px" height="30px" alt="twitter">
          </a>
        </div>
        <div class="sns-item">
          <a class="nl" href="https://github.com/sambaiz">
            <img src="//www.sambaiz.net/image/github.png" width="30px" height="30px" alt="github">
          </a>
        </div>
        <div class="sns-item">
          <a href="https://filmarks.com/users/sambaiz" class="filmarks" aria-label="filmarks"></a>
        </div>
      </div>
      <div class="tags">
        <div>
          
          <a class="tag" href="/tags/aws/">
            aws</a>
          
          <a class="tag" href="/tags/golang/">
            golang</a>
          
          <a class="tag" href="/tags/machinelearning/">
            machinelearning</a>
          
          <a class="tag" href="/tags/python/">
            python</a>
          
          <a class="tag" href="/tags/kubernetes/">
            kubernetes</a>
          
          <a class="tag" href="/tags/log/">
            log</a>
          
          <a class="tag" href="/tags/docker/">
            docker</a>
          
          <a class="tag" href="/tags/gcp/">
            gcp</a>
          
          <a class="tag" href="/tags/fluentd/">
            fluentd</a>
          
          <a class="tag" href="/tags/infra/">
            infra</a>
          
          <a class="tag others" href="/tags/">...</a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="cell">
      <div class="single-header">
        <h1>TensorFlowのモデルをTPUに対応させてColabで学習し実行時間を計測する</h1>
        <time>2018-11-27</time>
        <a class="tag" href="/tags/machinelearning/">machinelearning</a><a class="tag" href="/tags/tensorflow/">tensorflow</a>
      </div>
      <p>TPU(Tensor Processing Unit)は
Google開発のニューラルネットワークの学習に特化したASIC(Application Specific Integrated Circuit)。
<a href="https://cloudplatform-jp.googleblog.com/2017/05/an-in-depth-look-at-googles-first-tensor-processing-unit-tpu.html">一般的なGPUと比べて15~30倍もの性能が出る</a>
らしく検索や翻訳などGoogleのサービスでも使われている。</p>
<p>TPUを使える環境として、無料で使えるJupyter Notebooksの<a href="https://colab.research.google.com/">Google Colab</a>と
GCPの<a href="https://cloud.google.com/tpu/">Cloud TPU</a>がある。ColabのTPUも裏側ではCloud TPUが動いている。
Cloud TPUを直に使うとVMから接続して使うことになるので、TPUの<a href="https://cloud.google.com/tpu/docs/pricing">料金</a>に加えてVMの料金もかかる。</p>
<h2 id="モデルのtpu対応">モデルのTPU対応</h2>
<p>CNNのモデルを<a href="https://www.tensorflow.org/api_docs/python/tf/contrib/tpu/TPUEstimator">TPUEstimator</a>でTPUに対応させる。</p>
<p><a href="https://www.tensorflow.org/guide/estimators">Estimator</a>はTensorFlowの高レベルAPIで、
<a href="https://www.tensorflow.org/api_docs/python/tf/estimator/Estimator#train">train()</a>、
<a href="https://www.tensorflow.org/api_docs/python/tf/estimator/Estimator#evaluate">evaluate()</a>、
<a href="https://www.tensorflow.org/api_docs/python/tf/estimator/Estimator#predict">predict()</a>、
<a href="https://www.tensorflow.org/api_docs/python/tf/estimator/Estimator#export_saved_model">export_saved_model()</a>
といったモデルの学習から保存まで必要な機能を一通り提供する。</p>
<p>初めは比較的低レベルのAPIを使おうとしていたが、XLA(Accelerated Linear Algebra)によるコンパイルがうまくいかないなど様々な問題にあたって大変だったので使っておくと良いと思う。
それでもトライアンドエラーの繰り返しで、典型的なものは<a href="https://cloud.google.com/tpu/docs/troubleshooting">Troubleshooting</a>にあるが、ないものは調べるなりしてなんとかやっていくしかない。</p>
<p>定数などの定義。BATCH_SIZEはCloud TPUのシャード数の8で割り切れる値にする必要がある。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">import</span> pandas <span style="color:#ff79c6">as</span> pd
<span style="color:#ff79c6">from</span> sklearn.model_selection <span style="color:#ff79c6">import</span> train_test_split
<span style="color:#ff79c6">import</span> tensorflow <span style="color:#ff79c6">as</span> tf
<span style="color:#ff79c6">import</span> numpy <span style="color:#ff79c6">as</span> np
flags <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>app<span style="color:#ff79c6">.</span>flags
flags<span style="color:#ff79c6">.</span>DEFINE_boolean(<span style="color:#f1fa8c">&#39;use_tpu&#39;</span>, True, <span style="color:#f1fa8c">&#39;use tpu or not&#39;</span>)
tf<span style="color:#ff79c6">.</span>app<span style="color:#ff79c6">.</span>flags<span style="color:#ff79c6">.</span>DEFINE_string(<span style="color:#f1fa8c">&#39;f&#39;</span>, <span style="color:#f1fa8c">&#39;&#39;</span>, <span style="color:#f1fa8c">&#39;kernel&#39;</span>)
FLAGS <span style="color:#ff79c6">=</span> flags<span style="color:#ff79c6">.</span>FLAGS

EPOCH_NUM <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">100</span>
BATCH_SIZE <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">800</span> <span style="color:#6272a4"># must be divisible by number of replicas 8</span>
EVAL_BATCH_SIZE <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">800</span>
SHARD_NUM <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">8</span> <span style="color:#6272a4"># A single Cloud TPU has 8 shards.</span>
ITERATION_NUM <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">100</span> <span style="color:#6272a4"># Number of training steps to run on the Cloud TPU before returning control.</span>
</code></pre></div><h3 id="入力データの準備">入力データの準備</h3>
<p>入力は関数で渡し、tf.data APIのdatasetを返せばイテレートしてくれる。</p>
<p><a href="https://www.sambaiz.net/article/195/">TensorFlowのtf.data API - sambaiz-net</a></p>
<p>batch()でdrop_remainderをTrueにして端数を切り捨てないと、shapeが確定せずコンパイルできない。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">from</span> google.colab <span style="color:#ff79c6">import</span> auth
<span style="color:#ff79c6">from</span> googleapiclient.discovery <span style="color:#ff79c6">import</span> build
<span style="color:#ff79c6">from</span> io <span style="color:#ff79c6">import</span> BytesIO

auth<span style="color:#ff79c6">.</span>authenticate_user()
bucket <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&lt;bucket_name&gt;&#34;</span>
gcs_service <span style="color:#ff79c6">=</span> build(<span style="color:#f1fa8c">&#39;storage&#39;</span>, <span style="color:#f1fa8c">&#39;v1&#39;</span>)
train_data <span style="color:#ff79c6">=</span> gcs_service<span style="color:#ff79c6">.</span>objects()<span style="color:#ff79c6">.</span>get_media(bucket<span style="color:#ff79c6">=</span>bucket, <span style="color:#8be9fd;font-style:italic">object</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;train.csv&#39;</span>)<span style="color:#ff79c6">.</span>execute()
train <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>read_csv(BytesIO(train_data))

MODEL_DIR <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;gs://{}/model/tpu&#39;</span><span style="color:#ff79c6">.</span>format(bucket)

(x_train, x_valid, y_train, y_valid) <span style="color:#ff79c6">=</span> train_test_split(
    train<span style="color:#ff79c6">.</span>drop(<span style="color:#f1fa8c">&#39;label&#39;</span>, axis<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>)<span style="color:#ff79c6">.</span>values<span style="color:#ff79c6">.</span>reshape((<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">28</span>, <span style="color:#bd93f9">28</span>, <span style="color:#bd93f9">1</span>))<span style="color:#ff79c6">.</span>astype(np<span style="color:#ff79c6">.</span>float32), 
    np<span style="color:#ff79c6">.</span>identity(<span style="color:#bd93f9">10</span>)[train[<span style="color:#f1fa8c">&#39;label&#39;</span>]]<span style="color:#ff79c6">.</span>astype(np<span style="color:#ff79c6">.</span>float32), 
    test_size <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0.1</span>, random_state <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">100</span>)

<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">train_input_fn</span>(params):
    dataset <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>data<span style="color:#ff79c6">.</span>Dataset<span style="color:#ff79c6">.</span>from_tensor_slices(({<span style="color:#f1fa8c">&#39;x&#39;</span>: x_train}, y_train)) <span style="color:#6272a4"># (features, labels)</span>
    dataset <span style="color:#ff79c6">=</span> dataset<span style="color:#ff79c6">.</span>shuffle(buffer_size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1000</span>)
    dataset <span style="color:#ff79c6">=</span> dataset<span style="color:#ff79c6">.</span>batch(params[<span style="color:#f1fa8c">&#39;batch_size&#39;</span>], drop_remainder<span style="color:#ff79c6">=</span>True)
    <span style="color:#ff79c6">return</span> dataset

<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">valid_input_fn</span>(params):
    dataset <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>data<span style="color:#ff79c6">.</span>Dataset<span style="color:#ff79c6">.</span>from_tensor_slices(({<span style="color:#f1fa8c">&#39;x&#39;</span>: x_valid}, y_valid))
    dataset <span style="color:#ff79c6">=</span> dataset<span style="color:#ff79c6">.</span>batch(params[<span style="color:#f1fa8c">&#39;batch_size&#39;</span>], drop_remainder<span style="color:#ff79c6">=</span>True)
    <span style="color:#ff79c6">return</span> dataset
</code></pre></div><p>入出力するファイルはローカルではなくGCSなどに置く必要があるのでCloud TPUからも読み書きできるようにする。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-json" data-lang="json">{
    <span style="color:#ff79c6">&#34;domain&#34;</span>: <span style="color:#f1fa8c">&#34;global&#34;</span>,
    <span style="color:#ff79c6">&#34;reason&#34;</span>: <span style="color:#f1fa8c">&#34;forbidden&#34;</span>,
    <span style="color:#ff79c6">&#34;message&#34;</span>: <span style="color:#f1fa8c">&#34;service-******@cloud-tpu.iam.gserviceaccount.com does not have storage.objects.create access to &lt;bucket_name&gt;.&#34;</span>
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">!gsutil acl ch -u service-*****@cloud-tpu.iam.gserviceaccount.com:WRITER gs://&lt;bucket_name&gt;
</code></pre></div><h3 id="モデルの作成">モデルの作成</h3>
<p>Estimatorには次のシグネチャのmodel_fnを渡す。
引数のfeaturesとlabelsはinput_fnの返り値で、
modeは<a href="https://www.tensorflow.org/api_docs/python/tf/estimator/ModeKeys">tf.estimator.ModeKeys</a>の<code>TRAIN</code>、<code>EVAL</code>、<code>PREDICT</code>で、
paramsはEstimator生成時に渡せるパラメータ。
optimizerは<a href="https://www.tensorflow.org/api_docs/python/tf/contrib/tpu/CrossShardOptimizer">CrossShardOptimizer</a>で<a href="https://www.tensorflow.org/guide/using_tpu#optimizer">wrapする</a>。</p>
<p>TPUに対応している<a href="https://cloud.google.com/tpu/docs/tensorflow-ops">op</a>で作る必要がある。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">model_fn</span>(features, labels, mode, params):
    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">metric_fn</span>(labels, logits):
        <span style="color:#ff79c6">return</span> {
            <span style="color:#f1fa8c">&#39;accuracy&#39;</span>: tf<span style="color:#ff79c6">.</span>metrics<span style="color:#ff79c6">.</span>accuracy(
                labels<span style="color:#ff79c6">=</span>tf<span style="color:#ff79c6">.</span>argmax(labels, axis<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>), predictions<span style="color:#ff79c6">=</span>tf<span style="color:#ff79c6">.</span>argmax(logits, axis<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>))
         }
    is_training <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>equal(mode, tf<span style="color:#ff79c6">.</span>estimator<span style="color:#ff79c6">.</span>ModeKeys<span style="color:#ff79c6">.</span>TRAIN)
    conv1 <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>layers<span style="color:#ff79c6">.</span>conv2d(
        inputs<span style="color:#ff79c6">=</span>features[<span style="color:#f1fa8c">&#39;x&#39;</span>],
        filters<span style="color:#ff79c6">=</span><span style="color:#bd93f9">32</span>, 
        kernel_size<span style="color:#ff79c6">=</span>[<span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">5</span>], 
        padding<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;same&#34;</span>, 
        activation<span style="color:#ff79c6">=</span>tf<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>relu)
    pool1 <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>layers<span style="color:#ff79c6">.</span>max_pooling2d(inputs<span style="color:#ff79c6">=</span>conv1, pool_size<span style="color:#ff79c6">=</span>[<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>], strides<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>)
    conv2 <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>layers<span style="color:#ff79c6">.</span>conv2d(
        inputs<span style="color:#ff79c6">=</span>pool1, 
        filters<span style="color:#ff79c6">=</span><span style="color:#bd93f9">64</span>, 
        kernel_size<span style="color:#ff79c6">=</span>[<span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">5</span>],
        padding<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;same&#34;</span>, 
        activation<span style="color:#ff79c6">=</span>tf<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>relu)
    pool2 <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>layers<span style="color:#ff79c6">.</span>max_pooling2d(inputs<span style="color:#ff79c6">=</span>conv2, pool_size<span style="color:#ff79c6">=</span>[<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>], strides<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>)
    pool2_flat <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>layers<span style="color:#ff79c6">.</span>flatten(pool2)
    dense <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>layers<span style="color:#ff79c6">.</span>dense(inputs<span style="color:#ff79c6">=</span>pool2_flat, units<span style="color:#ff79c6">=</span><span style="color:#bd93f9">128</span>, activation<span style="color:#ff79c6">=</span>tf<span style="color:#ff79c6">.</span>nn<span style="color:#ff79c6">.</span>relu)
    dropout <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>layers<span style="color:#ff79c6">.</span>dropout(
        inputs<span style="color:#ff79c6">=</span>dense, rate<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0.4</span>, training<span style="color:#ff79c6">=</span>mode <span style="color:#ff79c6">==</span> tf<span style="color:#ff79c6">.</span>estimator<span style="color:#ff79c6">.</span>ModeKeys<span style="color:#ff79c6">.</span>TRAIN)
    logits <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>layers<span style="color:#ff79c6">.</span>dense(inputs<span style="color:#ff79c6">=</span>dropout, units<span style="color:#ff79c6">=</span><span style="color:#bd93f9">10</span>)

    loss <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>losses<span style="color:#ff79c6">.</span>softmax_cross_entropy(
        onehot_labels<span style="color:#ff79c6">=</span>labels, logits<span style="color:#ff79c6">=</span>logits)
    
    <span style="color:#ff79c6">if</span> mode <span style="color:#ff79c6">==</span> tf<span style="color:#ff79c6">.</span>estimator<span style="color:#ff79c6">.</span>ModeKeys<span style="color:#ff79c6">.</span>EVAL:
        <span style="color:#ff79c6">return</span> tf<span style="color:#ff79c6">.</span>contrib<span style="color:#ff79c6">.</span>tpu<span style="color:#ff79c6">.</span>TPUEstimatorSpec(mode, loss<span style="color:#ff79c6">=</span>loss, 
                                               eval_metrics<span style="color:#ff79c6">=</span>(metric_fn, [labels, logits]))

    optimizer <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>train<span style="color:#ff79c6">.</span>AdamOptimizer(<span style="color:#bd93f9">0.01</span>)
    <span style="color:#ff79c6">if</span> FLAGS<span style="color:#ff79c6">.</span>use_tpu:
        optimizer <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>contrib<span style="color:#ff79c6">.</span>tpu<span style="color:#ff79c6">.</span>CrossShardOptimizer(optimizer)

    <span style="color:#ff79c6">return</span> tf<span style="color:#ff79c6">.</span>contrib<span style="color:#ff79c6">.</span>tpu<span style="color:#ff79c6">.</span>TPUEstimatorSpec(
        mode<span style="color:#ff79c6">=</span>mode,
        loss<span style="color:#ff79c6">=</span>loss,
        predictions<span style="color:#ff79c6">=</span>{
            <span style="color:#f1fa8c">&#39;pred&#39;</span>: tf<span style="color:#ff79c6">.</span>argmax(logits, axis<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>)
        },
        train_op<span style="color:#ff79c6">=</span>optimizer<span style="color:#ff79c6">.</span>minimize(loss, tf<span style="color:#ff79c6">.</span>train<span style="color:#ff79c6">.</span>get_or_create_global_step()))
</code></pre></div><h3 id="tpuestimatorの生成">TPUEstimatorの生成</h3>
<p>TPUのアドレスが環境変数COLAB_TPU_ADDRに入るのでこれをmasterとする。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">if</span> FLAGS<span style="color:#ff79c6">.</span>use_tpu:
    master <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;grpc://&#39;</span> <span style="color:#ff79c6">+</span> os<span style="color:#ff79c6">.</span>environ[<span style="color:#f1fa8c">&#39;COLAB_TPU_ADDR&#39;</span>]
    run_config <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>contrib<span style="color:#ff79c6">.</span>tpu<span style="color:#ff79c6">.</span>RunConfig(
        master<span style="color:#ff79c6">=</span>master,
        session_config<span style="color:#ff79c6">=</span>tf<span style="color:#ff79c6">.</span>ConfigProto(
            allow_soft_placement<span style="color:#ff79c6">=</span>True, log_device_placement<span style="color:#ff79c6">=</span>True),
        tpu_config<span style="color:#ff79c6">=</span>tf<span style="color:#ff79c6">.</span>contrib<span style="color:#ff79c6">.</span>tpu<span style="color:#ff79c6">.</span>TPUConfig(ITERATION_NUM, SHARD_NUM))
<span style="color:#ff79c6">else</span>:
    run_config <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>contrib<span style="color:#ff79c6">.</span>tpu<span style="color:#ff79c6">.</span>RunConfig()

classifier <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>contrib<span style="color:#ff79c6">.</span>tpu<span style="color:#ff79c6">.</span>TPUEstimator(
    model_fn<span style="color:#ff79c6">=</span>model_fn,
    model_dir<span style="color:#ff79c6">=</span>MODEL_DIR,
    config<span style="color:#ff79c6">=</span>run_config,
    params<span style="color:#ff79c6">=</span>{},
    train_batch_size<span style="color:#ff79c6">=</span>BATCH_SIZE,
    eval_batch_size<span style="color:#ff79c6">=</span>EVAL_BATCH_SIZE,
    predict_batch_size<span style="color:#ff79c6">=</span>BATCH_SIZE,
    use_tpu<span style="color:#ff79c6">=</span>FLAGS<span style="color:#ff79c6">.</span>use_tpu)
</code></pre></div><h3 id="学習">学習</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">for</span> epoch <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(EPOCH_NUM):
  max_steps <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">len</span>(x_train)<span style="color:#ff79c6">*</span>(epoch<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>)<span style="color:#ff79c6">//</span>BATCH_SIZE
  valid_steps <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">len</span>(x_valid)<span style="color:#ff79c6">//</span>EVAL_BATCH_SIZE
  <span style="color:#ff79c6">if</span> FLAGS<span style="color:#ff79c6">.</span>use_tpu: 
    max_steps <span style="color:#ff79c6">//=</span> SHARD_NUM
  train_spec <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>estimator<span style="color:#ff79c6">.</span>TrainSpec(input_fn<span style="color:#ff79c6">=</span>train_input_fn, max_steps<span style="color:#ff79c6">=</span>max_steps)
  eval_spec <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>estimator<span style="color:#ff79c6">.</span>EvalSpec(input_fn<span style="color:#ff79c6">=</span>valid_input_fn, steps<span style="color:#ff79c6">=</span>valid_steps)
  result <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>estimator<span style="color:#ff79c6">.</span>train_and_evaluate(classifier, train_spec, eval_spec)
  <span style="color:#ff79c6">if</span> result[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">not</span> None:
    <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c">&#39;epoch: {}, loss: {} accuracy: {}&#39;</span><span style="color:#ff79c6">.</span>format(epoch<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>, result[<span style="color:#bd93f9">0</span>][<span style="color:#f1fa8c">&#39;loss&#39;</span>], result[<span style="color:#bd93f9">0</span>][<span style="color:#f1fa8c">&#39;accuracy&#39;</span>]))
  <span style="color:#ff79c6">else</span>:
    <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c">&#39;epoch: {} is already trained&#39;</span><span style="color:#ff79c6">.</span>format(epoch<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>))
</code></pre></div><h3 id="colabでtensorboardを開く">ColabでTensorBoardを開く</h3>
<p>このスクリプトを実行するとTensorBoardを立ち上げてngrokで外に開いてくれる。</p>
<p><a href="https://github.com/mixuala/colab_utils">mixuala/colab_utils</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python">!git clone https:<span style="color:#ff79c6">//</span>github<span style="color:#ff79c6">.</span>com<span style="color:#ff79c6">/</span>mixuala<span style="color:#ff79c6">/</span>colab_utils
<span style="color:#ff79c6">import</span> os
<span style="color:#ff79c6">import</span> colab_utils.tboard

<span style="color:#6272a4"># set paths</span>
ROOT <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">%</span>pwd
colab_utils<span style="color:#ff79c6">.</span>tboard<span style="color:#ff79c6">.</span>launch_tensorboard(bin_dir<span style="color:#ff79c6">=</span>ROOT, log_dir<span style="color:#ff79c6">=</span>MODEL_DIR)
</code></pre></div><h2 id="結果">結果</h2>
<p>学習させて実行時間を計測する。計測はセルの頭に<code>%%time</code>を付けるとできる。</p>
<h3 id="cpu">CPU</h3>
<p>ベースライン。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">CPU times: user 18min 28s, sys: 32.8 s, total: 19min 1s
Wall time: 14min 33s
</code></pre></div><h3 id="gpu">GPU</h3>
<p>ランタイムからアクセラレータをGPUに設定。使われるGPUはNVIDIAの<a href="https://www.nvidia.co.jp/object/tesla-k80-jp.html">Tesla K80</a>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">from</span> tensorflow.python.client <span style="color:#ff79c6">import</span> device_lib
device_lib<span style="color:#ff79c6">.</span>list_local_devices()
<span style="color:#6272a4"># ...</span>
<span style="color:#6272a4"># physical_device_desc: &#34;device: 0, name: Tesla K80, pci bus id: 0000:00:04.0, compute capability: 3.7&#34;]</span>
</code></pre></div><p>結果。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">CPU times: user 3min 2s, sys: 24.2 s, total: 3min 26s
Wall time: 8min 6s
</code></pre></div><h3 id="tpu">TPU</h3>
<p>アクセラレータをTPUに変更。
GPUより速くなることを期待したが、むしろCPUよりも遅くなってしまった。その上精度の伸びも遅くて良いところがない。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">CPU times: user 3min, sys: 23.8 s, total: 3min 24s
Wall time: 15min
</code></pre></div><h2 id="再チャレンジ">再チャレンジ</h2>
<p>エポックの立ち上がりが遅いので学習を切らずに続けて行わせてみる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-python" data-lang="python"><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">train_input_fn</span>(params):
    dataset <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>data<span style="color:#ff79c6">.</span>Dataset<span style="color:#ff79c6">.</span>from_tensor_slices(({<span style="color:#f1fa8c">&#39;x&#39;</span>: x_train}, y_train)) <span style="color:#6272a4"># (features, labels)</span>
    dataset <span style="color:#ff79c6">=</span> dataset<span style="color:#ff79c6">.</span>shuffle(buffer_size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1000</span>)
    dataset <span style="color:#ff79c6">=</span> dataset<span style="color:#ff79c6">.</span>batch(params[<span style="color:#f1fa8c">&#39;batch_size&#39;</span>], drop_remainder<span style="color:#ff79c6">=</span>True)
    dataset <span style="color:#ff79c6">=</span> dataset<span style="color:#ff79c6">.</span>repeat(EPOCH_NUM)
    <span style="color:#ff79c6">return</span> dataset

epoch <span style="color:#ff79c6">=</span> EPOCH_NUM<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>
max_steps <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">len</span>(x_train)<span style="color:#ff79c6">*</span>(epoch<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>)<span style="color:#ff79c6">/</span>BATCH_SIZE
valid_steps <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">len</span>(x_valid)<span style="color:#ff79c6">//</span>EVAL_BATCH_SIZE
<span style="color:#ff79c6">if</span> FLAGS<span style="color:#ff79c6">.</span>use_tpu: 
  max_steps <span style="color:#ff79c6">//=</span> SHARD_NUM
train_spec <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>estimator<span style="color:#ff79c6">.</span>TrainSpec(input_fn<span style="color:#ff79c6">=</span>train_input_fn, max_steps<span style="color:#ff79c6">=</span>max_steps)
eval_spec <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>estimator<span style="color:#ff79c6">.</span>EvalSpec(input_fn<span style="color:#ff79c6">=</span>valid_input_fn, steps<span style="color:#ff79c6">=</span>valid_steps)
result <span style="color:#ff79c6">=</span> tf<span style="color:#ff79c6">.</span>estimator<span style="color:#ff79c6">.</span>train_and_evaluate(classifier, train_spec, eval_spec)
<span style="color:#ff79c6">if</span> result[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">not</span> None:
  <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c">&#39;epoch: {}, loss: {} accuracy: {}&#39;</span><span style="color:#ff79c6">.</span>format(epoch<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>, result[<span style="color:#bd93f9">0</span>][<span style="color:#f1fa8c">&#39;loss&#39;</span>],  result[<span style="color:#bd93f9">0</span>][<span style="color:#f1fa8c">&#39;accuracy&#39;</span>]))
<span style="color:#ff79c6">else</span>:
  <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c">&#39;epoch: {} is already trained&#39;</span><span style="color:#ff79c6">.</span>format(epoch<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>))
</code></pre></div><p>これを実行したところGPUと同程度には速くなった。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback"># GPU
CPU times: user 40.9 s, sys: 7.8 s, total: 48.7 s
Wall time: 1min 43s

# TPU
CPU times: user 35.2 s, sys: 4.46 s, total: 39.7 s
Wall time: 1min 34s
</code></pre></div><p>さらにEPOCH_NUMを5から100にして再計測する。</p>
<h2 id="結果-1">結果</h2>
<h3 id="gpu-1">GPU</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">CPU times: user 3min 27s, sys: 2min, total: 5min 28s
Wall time: 6min 5s
</code></pre></div><h3 id="tpu-1">TPU</h3>
<p>エポック数を大幅に増やしたのにも関わらずほとんど実行時間が変わらずとても速い。
CPU時間も変わっていないので演算がTPUで完結していてCPU-TPU間のデータの受け渡しが最小限で済んでいるのかもしれない。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">CPU times: user 34.5 s, sys: 7.32 s, total: 41.8 s
Wall time: 1min 38s
</code></pre></div><h2 id="参考">参考</h2>
<p><a href="https://medium.com/deep-learning-turkey/google-colab-free-gpu-tutorial-e113627b9f5d">Google Colab Free GPU Tutorial – Deep Learning Turkey – Medium</a></p>
<p><a href="https://qiita.com/koshian2/items/fb989cebe0266d1b32fc">Google ColabのTPUで対GPUの最速に挑戦する - Qiita</a></p>

    </div>
  </article>
</div>

</div>

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date(); a = s.createElement(o),
      m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-39190067-3', 'auto');
  ga('send', 'pageview');
</script>


</body>

</html>