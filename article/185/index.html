<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="generator" content="Hugo 0.38.2" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
    crossorigin="anonymous">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/magula.min.css">
  <link rel="stylesheet" href="/css/slidebars.min.css">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>IstioをHelmでインストールしてRoutingとTelemetryを行いJaeger/Kialiで確認する - sambaiz-net</title>
  <meta name="twitter:title" content="IstioをHelmでインストールしてRoutingとTelemetryを行いJaeger/Kialiで確認する - sambaiz-net">
  <meta property='og:title' content="IstioをHelmでインストールしてRoutingとTelemetryを行いJaeger/Kialiで確認する - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="Istio">
  <meta name="twitter:description" content="Istio">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/article/185/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />
  <meta name="google-site-verification" content="CEqNYjzc4Y7hb3FY7uUkmllGzeDc40brBwQJixeH61Q" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id":"https://www.sambaiz.net/"
    },
    "headline": "IstioをHelmでインストールしてRoutingとTelemetryを行いJaeger/Kialiで確認する | sambaiz-net ",
    "datePublished": "2018-09-02T23:50:00JST",
    "dateModified": "2018-09-02T23:50:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "image": "https://www.sambaiz.net/images/my.jpg"
    },
    "publisher": {
      "@type": "Organization",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.sambaiz.net/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https://www.sambaiz.net/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "Istio"
  }
</script>
</head>

<body>
  <div off-canvas="id-1 left reveal">
  
  <ul class="tag-list">
    
  </ul>
  
  <ul class="tag-list">
    <li><a href="https://www.sambaiz.net/tags/golang">golang</a></li><li><a href="https://www.sambaiz.net/tags/aws">aws</a></li><li><a href="https://www.sambaiz.net/tags/machinelearning">machinelearning</a></li><li><a href="https://www.sambaiz.net/tags/kubernetes">kubernetes</a></li><li><a href="https://www.sambaiz.net/tags/log">log</a></li><li><a href="https://www.sambaiz.net/tags/tensorflow">tensorflow</a></li><li><a href="https://www.sambaiz.net/tags/unity">unity</a></li><li><a href="https://www.sambaiz.net/tags/gcp">gcp</a></li><li><a href="https://www.sambaiz.net/tags/fluentd">fluentd</a></li><li><a href="https://www.sambaiz.net/tags/node.js">node.js</a></li><li><a href="https://www.sambaiz.net/tags/web">web</a></li><li><a href="https://www.sambaiz.net/tags/python">python</a></li><li><a href="https://www.sambaiz.net/tags/infra">infra</a></li><li><a href="https://www.sambaiz.net/tags/docker">docker</a></li><li><a href="https://www.sambaiz.net/tags/lambda">lambda</a></li><li><a href="https://www.sambaiz.net/tags/javascript">javascript</a></li><li><a href="https://www.sambaiz.net/tags/mysql">mysql</a></li><li><a href="https://www.sambaiz.net/tags/elasticsearch">elasticsearch</a></li><li><a href="https://www.sambaiz.net/tags/hololens">hololens</a></li><li><a href="https://www.sambaiz.net/tags/linux">linux</a></li><li><a href="https://www.sambaiz.net/tags/ble">ble</a></li><li><a href="https://www.sambaiz.net/tags/product">product</a></li><li><a href="https://www.sambaiz.net/tags/android">android</a></li><li><a href="https://www.sambaiz.net/tags/angular">angular</a></li><li><a href="https://www.sambaiz.net/tags/auth">auth</a></li><li><a href="https://www.sambaiz.net/tags/cron">cron</a></li><li><a href="https://www.sambaiz.net/tags/istio">istio</a></li><li><a href="https://www.sambaiz.net/tags/react">react</a></li><li><a href="https://www.sambaiz.net/tags/terraform">terraform</a></li><li><a href="https://www.sambaiz.net/tags/uwp">uwp</a></li><li><a href="https://www.sambaiz.net/tags/.net">.net</a></li><li><a href="https://www.sambaiz.net/tags/circleci">circleci</a></li><li><a href="https://www.sambaiz.net/tags/css">css</a></li><li><a href="https://www.sambaiz.net/tags/event">event</a></li><li><a href="https://www.sambaiz.net/tags/firebase">firebase</a></li><li><a href="https://www.sambaiz.net/tags/grpc">grpc</a></li><li><a href="https://www.sambaiz.net/tags/hadoop">hadoop</a></li><li><a href="https://www.sambaiz.net/tags/norikra">norikra</a></li><li><a href="https://www.sambaiz.net/tags/rx">rx</a></li><li><a href="https://www.sambaiz.net/tags/vr">vr</a></li><li><a href="https://www.sambaiz.net/tags/api">api</a></li><li><a href="https://www.sambaiz.net/tags/cdn">cdn</a></li><li><a href="https://www.sambaiz.net/tags/compress">compress</a></li><li><a href="https://www.sambaiz.net/tags/crypto">crypto</a></li><li><a href="https://www.sambaiz.net/tags/csharp">csharp</a></li><li><a href="https://www.sambaiz.net/tags/d3.js">d3.js</a></li><li><a href="https://www.sambaiz.net/tags/datadog">datadog</a></li><li><a href="https://www.sambaiz.net/tags/hugo">hugo</a></li><li><a href="https://www.sambaiz.net/tags/ios">ios</a></li><li><a href="https://www.sambaiz.net/tags/jenkins">jenkins</a></li><li><a href="https://www.sambaiz.net/tags/jvm">jvm</a></li><li><a href="https://www.sambaiz.net/tags/leveldb">leveldb</a></li><li><a href="https://www.sambaiz.net/tags/math">math</a></li><li><a href="https://www.sambaiz.net/tags/neo4j">neo4j</a></li><li><a href="https://www.sambaiz.net/tags/scikit-learn">scikit-learn</a></li><li><a href="https://www.sambaiz.net/tags/serialize">serialize</a></li><li><a href="https://www.sambaiz.net/tags/server">server</a></li><li><a href="https://www.sambaiz.net/tags/sonnet">sonnet</a></li><li><a href="https://www.sambaiz.net/tags/spark">spark</a></li><li><a href="https://www.sambaiz.net/tags/spec">spec</a></li><li><a href="https://www.sambaiz.net/tags/statistics">statistics</a></li><li><a href="https://www.sambaiz.net/tags/typescript">typescript</a></li><li><a href="https://www.sambaiz.net/tags/video">video</a></li>
  </ul>
  
</div>

  <div canvas="container" id="container">
    <header>
      <button type="button" class="btn toggle-side">TAG</button>

      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" />
        <a class="nl" href="https://www.sambaiz.net/">sambaiz-net</a>
      </div>

      <div class="sns">
        <a class="nl" href="https://twitter.com/sambaiz"><i class="fa fa-2x fa-twitter"></i></a>
        <a class="nl" href="https://github.com/sambaiz"><i class="fa fa-2x fa-github"></i></a>
        <style>
          .strava-badge-base {
            display: inline-block;
            height: 29px;
            width: 29px;
          }

          .strava-badge {
            display: inline-block;
            height: 24px;
            width: 24px;
            background: url(/image/strava.png) no-repeat;
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
          }

          .filmarks-base {
            display: inline-block;
            width: 29px;
            height: 29px;
          }

          .filmarks {
            display: inline-block;
            width: 25px;
            height: 25px;
            background: url(/image/filmarks.svg) no-repeat;
            background-size: 450%;
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
          }

          .studyplus-base {
            display: inline-block;
            width: 29px;
            height: 29px;
          }

          .studyplus {
            display: inline-block;
            height: 24px;
            width: 24px;
            background: url(/image/studyplus.png) no-repeat;
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
          }
        </style>
        <div class="strava-badge-base">
          <a href="https://strava.com/athletes/36758958/badge" class="strava-badge"></a>
        </div>
        <div class="filmarks-base">
          <a href="https://filmarks.com/users/sambaiz" class="filmarks"></a>
        </div>
        <div class="studyplus-base">
          <a href="https://www.studyplus.jp/users/0842722cd7a6483baa7979f9d3f7c2e6/studylog/logs" class="studyplus"></a>
        </div>
      </div>
    </header>

<div class="container">

  <div class="row">
    <div class="col-md-12">

      <article class="single">
        <div class="single body">
          <h1>IstioをHelmでインストールしてRoutingとTelemetryを行いJaeger/Kialiで確認する</h1>
          <p>(2018-09-02)</p>
          

<p>Istioは<a href="https://www.envoyproxy.io/">Envoy</a>というProxyをSidecarとしてPodに入れてトラフィックを通すことでマイクロサービスのRoutingやTelemetryをサービスのコードに手を入れずに行うことができるサービスメッシュ。
もともとEnvoy自体は単体で、コネクションを張りっぱなしのgRPC(HTTP/2)をK8sのServiceのL4ロードバランサーでは分散できない問題の解決方法の一つとして
各PodのIPの一覧を返す<a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services">Headless Service</a>と使われていたが、各Manifestに入れたりConfigMapを編集したりする必要があり少し面倒だった。
Istioにするとそれらが省けて、さらに賢いRoutingやモニタリングの仕組みまで付いてくるのでとても便利だ。</p>

<h2 id="インストール-https-istio-io-docs-setup-kubernetes-helm-install"><a href="https://istio.io/docs/setup/kubernetes/helm-install/">インストール</a></h2>

<p>IstioをダウンロードしてきてHelmでインストールする。Istioには様々なコンポーネントが含まれているが、<a href="https://github.com/istio/istio/blob/b17b4989699a6d9dc98245c511dc7d544d88e945/install/kubernetes/helm/istio/README.md#configuration">パラメータ</a>でインストールするものを選択することができる。</p>

<p><a href="https://www.sambaiz.net/article/122/">KubernetesのパッケージマネージャーHelmを使う - sambaiz-net</a></p>

<p>今回はデフォルトではfalseになっているGrafana/Jaeger/Kialiをtrueにしてほぼ全て入るようにしている。</p>

<p>RBACが有効な場合はServiceAccountを作ってcluster-adminあるいは必要なRoleをBindしておく。</p>

<p><a href="https://www.sambaiz.net/article/160/">RBACが有効なGKEでHelmを使う - sambaiz-net</a></p>

<pre><code>$ curl -L https://git.io/getLatestIstio | sh -
$ cd istio-1.0.1/
# helm init --service-account tiller
$ helm install install/kubernetes/helm/istio --name istio --namespace istio-system --set grafana.enabled=true --set grafana.persist=true --set grafana.storageClassName=standard --set tracing.enabled=true --set kiali.enabled=true
$ kubectl get pod -n istio-system
NAME                                        READY     STATUS    RESTARTS   AGE
grafana-598678cbb-bglbq                     1/1       Running   0          3m
istio-citadel-6f9887d776-tvdg8              1/1       Running   0          3m
istio-egressgateway-84d78d84bf-zpxrq        1/1       Running   0          3m
istio-galley-556f5558f5-hk2r8               1/1       Running   0          3m
istio-ingressgateway-78cccbddbb-gh2xl       1/1       Running   0          3m
istio-pilot-799845f56d-l777d                2/2       Running   0          3m
istio-policy-7666fcd574-nbx8s               2/2       Running   0          3m
istio-sidecar-injector-7b6589c9-m7x77       1/1       Running   0          3m
istio-statsd-prom-bridge-55965ff9c8-s6dmj   1/1       Running   0          3m
istio-telemetry-844c8d6bff-9trcf            2/2       Running   0          3m
istio-tracing-77f9f94b98-g7v6f              1/1       Running   0          3m
kiali-bdf7fdc78-9lpd4                       1/1       Running   0          3m
prometheus-7456f56c96-drhlq                 1/1       Running   0          3m
</code></pre>

<p>default namespaceにラベルを貼って自動でEnvoyが各Podに<a href="https://github.com/istio/istio/blob/1.0.1/install/kubernetes/helm/istio/templates/sidecar-injector-configmap.yaml#L77">Injectionされる</a>ようにする。</p>

<pre><code>$ kubectl get namespace -L istio-injection
NAME           STATUS    AGE       ISTIO-INJECTION
default        Active    27m       
istio-system   Active    16m       
kube-public    Active    27m       
kube-system    Active    27m 

$ kubectl label namespace default istio-injection=enabled
</code></pre>

<p>併せて<a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/">Init Containers</a>としてInjectionされるistio-initのiptablesで<a href="https://github.com/istio/istio/blob/1.0.1/tools/deb/istio-iptables.sh#L292">Envoy以外</a>のトラフィックが<a href="https://github.com/istio/istio/blob/1.0.1/tools/deb/istio-iptables.sh#L202">Envoyのポートに向く</a>のでサービスのコードでは向き先を変える必要がない。</p>

<h2 id="routing">Routing</h2>

<h3 id="pilot-https-istio-io-docs-concepts-traffic-management-pilot-and-envoy"><a href="https://istio.io/docs/concepts/traffic-management/#pilot-and-envoy">Pilot</a></h3>

<p>全Envoyを管理するPilotにEnvoy間のトラフィックのルーティングや、リトライやサーキットブレーカーのルールを設定できる。
EnvoyはPilotからサービスディスカバリして他Envoyについて知り、定期的にロードバランシングプールに含まれるインスタンスのヘルスチェックをして失敗数がしきい値を超えたら成功数がしきい値を超えるまでプールから追い出し、ルールに従いトラフィックを制御する。</p>

<h3 id="リソース">リソース</h3>

<ul>
<li><a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#Gateway">Gateway</a>: HTTP/TCPロードバランサー。</li>
</ul>

<p>Ingressとは異なりL4-L6のポートやTLSの設定は持つがL7の設定は持たず、VirtualServiceに持つ。
インフラ管理者とサービス開発者が触るであろうリソースが分離されている。</p>

<p><a href="https://www.sambaiz.net/article/173/">GKEでのService(ClusterIP/NodePort/LoadBalancer)とIngress - sambaiz-net</a></p>

<ul>
<li><a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#VirtualService">VirtualService</a>: ルーティングのルール。</li>
<li><a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#DestinationRule">DestinationRule</a>: ロードバランシングのルール。</li>
</ul>

<h3 id="例-https-istio-io-docs-examples-bookinfo"><a href="https://istio.io/docs/examples/bookinfo/">例</a></h3>

<p>サンプルアプリケーションBookInfoを動かす。</p>

<pre><code>$ kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
$ kubectl get pod
NAME                              READY     STATUS    RESTARTS   AGE
details-v1-7bcdcc4fd6-x92f5       2/2       Running   0          1m
productpage-v1-8584c875d8-jxl68   2/2       Running   0          1m
ratings-v1-54cf9dc8f8-wv9xz       2/2       Running   0          1m
reviews-v1-59cbdd7959-vxf2f       2/2       Running   0          1m
reviews-v2-dccb4cfc9-mc22f        2/2       Running   0          1m
reviews-v3-5465dc97bc-pgvbl       2/2       Running   0          1m
</code></pre>

<p>GatewayとVirtualServiceを作成して外に開く。</p>

<pre><code>$ cat samples/bookinfo/networking/bookinfo-gateway.yaml
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway # use istio default controller
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - &quot;*&quot;
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo
spec:
  hosts:
  - &quot;*&quot;
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage
        port:
          number: 9080

$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
$ export INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
$ export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name==&quot;http2&quot;)].port}')
$ export GATEWAY_URL=http://$INGRESS_HOST:$INGRESS_PORT
$ open $GATEWAY_URL/productpage
</code></pre>

<p><img src="https://www.sambaiz.net/images/185-bookinfo.png" alt="BookInfo" /></p>

<p>DestinationRuleを作成する。この時点では各バージョンがラウンドロビンする。</p>

<pre><code>$ cat samples/bookinfo/networking/destination-rule-all.yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: productpage
spec:
  host: productpage
  subsets:
  - name: v1
    labels:
      version: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
  - name: v3
    labels:
      version: v3
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: ratings
spec:
  host: ratings
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
  - name: v2-mysql
    labels:
      version: v2-mysql
  - name: v2-mysql-vm
    labels:
      version: v2-mysql-vm
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: details
spec:
  host: details
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---

$ kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml
</code></pre>

<p>VirtualServiceのdestinationでsubsetを指定するとそのバージョンのみに<a href="https://istio.io/docs/tasks/traffic-management/request-routing/">飛ぶ</a>ようになる。</p>

<pre><code>$ cat samples/bookinfo/networking/virtual-service-all-v1.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: productpage
spec:
  hosts:
  - productpage
  http:
  - route:
    - destination:
        host: productpage
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings
spec:
  hosts:
  - ratings
  http:
  - route:
    - destination:
        host: ratings
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: details
spec:
  hosts:
  - details
  http:
  - route:
    - destination:
        host: details
        subset: v1
---

$ kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre>

<p>VirtualServiceはheaderの中身をみてルーティングさせることもできる。</p>

<pre><code>$ cat samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
    - reviews
  http:
  - match:
    - headers:
        end-user:
          exact: jason
    route:
    - destination:
        host: reviews
        subset: v2
  - route:
    - destination:
        host: reviews
        subset: v1

$ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
</code></pre>

<p><a href="https://istio.io/docs/tasks/traffic-management/fault-injection/">Fault Injection</a>して特定条件や割合で意図的に遅延を生じさせたり、エラーコードを返らせたりできる。バグの発見や調査、Chaos Engineeringもできそうだ。</p>

<pre><code>$ cat samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings
spec:
  hosts:
  - ratings
  http:
  - match:
    - headers:
        end-user:
          exact: jason
    fault:
      delay:
        percent: 100
        fixedDelay: 7s
    route:
    - destination:
        host: ratings
        subset: v1
  - route:
    - destination:
        host: ratings
        subset: v1

$ kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml
</code></pre>

<p>routeには複数のdestinationを指定できてweightによって飛ばす割合を<a href="https://istio.io/docs/tasks/traffic-management/traffic-shifting/">変えられる</a>。
カナリアリリースやA/Bテストが簡単にできる。</p>

<pre><code>$ cat samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
    - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 50
    - destination:
        host: reviews
        subset: v3
      weight: 50

$ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml
</code></pre>

<h2 id="telemetry">Telemetry</h2>

<h3 id="mixer-https-istio-io-docs-concepts-policies-and-telemetry"><a href="https://istio.io/docs/concepts/policies-and-telemetry/">Mixer</a></h3>

<p>MixerはポリシーコントロールとTelemetryを行うコンポーネント。
<a href="https://istio.io/docs/reference/config/policy-and-telemetry/adapters/">Adapter</a>によってStackdriverやCloudWatchなど様々なバックエンドに対応している。</p>

<p>Envoyは前提条件を確認するためリクエストの前と、Telemetryするためリクエストの後にMixerを呼び出す。ただしキャッシュとバッファを持っていて毎回呼び出しはしない。また、Mixerもキャッシュやバッファを持ちバックエンドの呼び出し回数を減らしている。
MixerがSPOFとなり可用性が下がるのではと思われるが、バックエンドの障害をある程度許容できるのに加えて Mixer自身はステートレスで他のバックエンドよりも可用性が高く設計されているためむしろ<a href="https://istio.io/blog/2017/mixer-spof-myth/">SLOが向上する</a>そうだ。</p>

<h3 id="リソース-1">リソース</h3>

<ul>
<li><a href="https://istio.io/docs/concepts/policies-and-telemetry/#handlers">Handler(Adapter)</a>: Mixerからバックエンドへ送る。</li>
<li><a href="https://istio.io/docs/concepts/policies-and-telemetry/#instances">Instance</a>: EnvoyからMixerに送られてきたAttributeをAdapterの入力へマッピングする。</li>
<li><a href="https://istio.io/docs/concepts/policies-and-telemetry/#rules">Rule</a>: Handlerが特定のInstancesで呼び出されるルール。</li>
</ul>

<h3 id="例-https-istio-io-docs-tasks-telemetry-metrics-logs"><a href="https://istio.io/docs/tasks/telemetry/metrics-logs/">例</a></h3>

<p>リクエストの2倍の数を値とするmetric instance。<a href="https://istio.io/docs/reference/config/policy-and-telemetry/expression-language/">configuration expression language(CEXL)</a>が使われている。</p>

<pre><code>$ cat new_telemetry.yaml 
# Configuration for metric instances
apiVersion: &quot;config.istio.io/v1alpha2&quot;
kind: metric
metadata:
  name: doublerequestcount
  namespace: istio-system
spec:
  value: &quot;2&quot; # count each request twice
  dimensions:
    reporter: conditional((context.reporter.kind | &quot;inbound&quot;) == &quot;outbound&quot;, &quot;client&quot;, &quot;server&quot;)
    source: source.workload.name | &quot;unknown&quot;
    destination: destination.workload.name | &quot;unknown&quot;
    message: '&quot;twice the fun!&quot;'
  monitored_resource_type: '&quot;UNSPECIFIED&quot;'
---
</code></pre>

<p>このmetricを受け取るprometheus handler。</p>

<pre><code># Configuration for a Prometheus handler
apiVersion: &quot;config.istio.io/v1alpha2&quot;
kind: prometheus
metadata:
  name: doublehandler
  namespace: istio-system
spec:
  metrics:
  - name: double_request_count # Prometheus metric name
    instance_name: doublerequestcount.metric.istio-system # Mixer instance name (fully-qualified)
    kind: COUNTER
    label_names:
    - reporter
    - source
    - destination
    - message
---
</code></pre>

<p>そしてこれらを紐づけるrule。</p>

<pre><code># Rule to send metric instances to a Prometheus handler
apiVersion: &quot;config.istio.io/v1alpha2&quot;
kind: rule
metadata:
  name: doubleprom
  namespace: istio-system
spec:
  actions:
  - handler: doublehandler.prometheus
    instances:
    - doublerequestcount.metric
---
</code></pre>

<p><a href="https://istio.io/docs/reference/config/policy-and-telemetry/templates/logentry/">logentry</a>はログを表すinstance。
あとはそれを標準出力するhandlerとrule。</p>

<pre><code># Configuration for logentry instances
apiVersion: &quot;config.istio.io/v1alpha2&quot;
kind: logentry
metadata:
  name: newlog
  namespace: istio-system
spec:
  severity: '&quot;warning&quot;'
  timestamp: request.time
  variables:
    source: source.labels[&quot;app&quot;] | source.workload.name | &quot;unknown&quot;
    user: source.user | &quot;unknown&quot;
    destination: destination.labels[&quot;app&quot;] | destination.workload.name | &quot;unknown&quot;
    responseCode: response.code | 0
    responseSize: response.size | 0
    latency: response.duration | &quot;0ms&quot;
  monitored_resource_type: '&quot;UNSPECIFIED&quot;'
---
# Configuration for a stdio handler
apiVersion: &quot;config.istio.io/v1alpha2&quot;
kind: stdio
metadata:
  name: newhandler
  namespace: istio-system
spec:
 severity_levels:
   warning: 1 # Params.Level.WARNING
 outputAsJson: true
---
# Rule to send logentry instances to a stdio handler
apiVersion: &quot;config.istio.io/v1alpha2&quot;
kind: rule
metadata:
  name: newlogstdio
  namespace: istio-system
spec:
  match: &quot;true&quot; # match for all requests
  actions:
   - handler: newhandler.stdio
     instances:
     - newlog.logentry
---

$ kubectl apply -f new_telemetry.yaml 
</code></pre>

<p>Prometheus handlerによってdoublerequestcount metricが届いている。</p>

<pre><code>$ kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=prometheus -o jsonpath='{.items[0].metadata.name}') 9090:9090
$ open http://localhost:9090/graph
</code></pre>

<p><img src="https://www.sambaiz.net/images/185-prometheus.png" alt="Prometheus" /></p>

<p>stdio handlerによってnewlog logentryが出力されている。</p>

<pre><code>$ kubectl -n istio-system logs -f $(kubectl -n istio-system get pods -l istio-mixer-type=telemetry -o jsonpath='{.items[0].metadata.name}') -c mixer | grep \&quot;instance\&quot;:\&quot;newlog.logentry.istio-system\&quot; 
{&quot;level&quot;:&quot;warn&quot;,&quot;time&quot;:&quot;2018-09-01T13:53:45.897141Z&quot;,&quot;instance&quot;:&quot;l&quot;,&quot;destination&quot;:&quot;telemetry&quot;,&quot;latency&quot;:&quot;3.817501ms&quot;,&quot;responseCode&quot;:200,&quot;responseSize&quot;:5,&quot;source&quot;:&quot;details&quot;,&quot;user&quot;:&quot;unknown&quot;}
{&quot;level&quot;:&quot;warn&quot;,&quot;time&quot;:&quot;2018-09-01T13:53:45.899237Z&quot;,&quot;instance&quot;:&quot;newlog.logentry.istio-system&quot;,&quot;destination&quot;:&quot;telemetry&quot;,&quot;latency&quot;:&quot;4.423947ms&quot;,&quot;responseCode&quot;:200,&quot;responseSize&quot;:5,&quot;source&quot;:&quot;productpage&quot;,&quot;user&quot;:&quot;unknown&quot;}
</code></pre>

<h2 id="grafana">Grafana</h2>

<p>Grafanaを開くと最初からIstioのダッシュボードがいくつか作られている。
Prometheusに送ったmetricをGrafanaで可視化できる。</p>

<pre><code>$ kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=grafana -o jsonpath='{.items[0].metadata.name}') 3000:3000
$ open http://localhost:3000
</code></pre>

<p><img src="https://www.sambaiz.net/images/185-grafana.png" alt="Grafana" /></p>

<h2 id="jaeger">Jaeger</h2>

<p><a href="https://www.jaegertracing.io/">Jaeger</a>は分散トレーシングツール。
パフォーマンスが問題になったときにどこのサービスがボトルネックになっているかが分かる。</p>

<pre><code>$ kubectl port-forward -n istio-system $(kubectl get pod -n istio-system -l app=jaeger -o jsonpath='{.items[0].metadata.name}') 16686:16686
$ open http://localhost:16686
</code></pre>

<p><img src="https://www.sambaiz.net/images/185-jaeger.png" alt="Jaeger" /></p>

<h2 id="kiali">Kiali</h2>

<p><a href="http://www.kiali.io/">Kiali</a>はサービスメッシュを可視化するツール。v1とv3にリクエストが飛んでいてv2には飛んでいないことが分かる。</p>

<pre><code>$ kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=kiali -o jsonpath='{.items[0].metadata.name}') 20001:20001
$ open http://localhost:20001
</code></pre>

<p><img src="https://www.sambaiz.net/images/185-kiali.png" alt="Kiali" /></p>

<h2 id="参考">参考</h2>

<p><a href="https://qiita.com/wataru420/items/a63a8b205308a93e253c">kubernetesでgRPCするときにenvoy挟んでみたよ</a></p>

<p><a href="https://thenewstack.io/why-you-should-care-about-istio-gateways/">Why You Should Care About Istio Gateways - The New Stack</a></p>

        </div>
      </article>
    </div>
  </div>
</div>

</div> 
<script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script src="/js/slidebars.min.js"></script>
<script>
    ( function ( $ ) {
      
      var controller = new slidebars();
      controller.init();

      $( '.toggle-side' ).on( 'click', function ( event ) {
          event.stopPropagation();
          event.preventDefault();

          controller.toggle( 'id-1' );
        } );

        $( '#container' ).on( 'click', function ( event ) {
            controller.close( 'id-1' );
          });
    } ) ( jQuery );
</script>

<script>hljs.initHighlightingOnLoad();</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-39190067-3', 'auto');
ga('send', 'pageview');
</script>


  </body>
</html>

