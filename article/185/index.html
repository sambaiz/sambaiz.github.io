<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="generator" content="Hugo 0.75.1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/destyle.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.sambaiz.net/index.xml">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">

  <meta name="theme-color" content="#41a248">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@sambaiz">
  
  <title>IstioをHelmでインストールしてRoutingとTelemetryを行いJaeger/Kialiで確認する - sambaiz-net</title>
  <meta name="twitter:title" content="IstioをHelmでインストールしてRoutingとTelemetryを行いJaeger/Kialiで確認する - sambaiz-net">
  <meta property='og:title' content="IstioをHelmでインストールしてRoutingとTelemetryを行いJaeger/Kialiで確認する - sambaiz-net">
  <meta property="og:type" content="article">
  
  <meta name="description" content="Istio">
  <meta name="twitter:description" content="Istio">
  
  

  <meta property="og:url" content="https://www.sambaiz.net/article/185/">
  <meta property="og:image" content="https://www.sambaiz.net/images/my_l.jpg">
  <meta name="twitter:image" content="https://www.sambaiz.net/images/my.jpg" />
  <meta name="google-site-verification" content="CEqNYjzc4Y7hb3FY7uUkmllGzeDc40brBwQJixeH61Q" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id":"https:\/\/www.sambaiz.net\/"
    },
    "headline": "IstioをHelmでインストールしてRoutingとTelemetryを行いJaeger\/Kialiで確認する - sambaiz-net",
    "datePublished": "2018-09-02T23:50:00JST",
    "dateModified": "2018-09-02T23:50:00JST",
    "author": {
      "@type": "Person",
      "name": "sambaiz",
      "image": "https:\/\/www.sambaiz.net\/images/my.jpg"
    },
    "publisher": {
      "@type": "Person",
      "name": "sambaiz-net",
      "logo": {
        "@type": "ImageObject",
        "url": "https:\/\/www.sambaiz.net\/images/my.jpg",
        "height": 60,
        "width": 60
      }
    },
    "image": {
      "@type": "ImageObject",
      "url": "https:\/\/www.sambaiz.net\/images/my.jpg",
      "height": 138,
      "width": 138
    },
    "description": "Istio"
  }
</script>
</head>

<body>
  <div>
    <header>
      <div class="title">
        <img src="https://www.sambaiz.net/images/my.png" width="60px" height="60px" />
        <a class="nl" href="https://www.sambaiz.net/">sambaiz-net</a>
      </div>

      <div>
        <a class="nl" href="https://twitter.com/sambaiz"><i class="fa fa-2x fa-twitter"></i></a>
        <a class="nl" href="https://github.com/sambaiz"><i class="fa fa-2x fa-github"></i></a>
        <style>
          .filmarks-base {
            display: inline-block;
            width: 29px;
            height: 29px;
          }

          .filmarks {
            display: inline-block;
            width: 25px;
            height: 25px;
            background: url(/image/filmarks.svg) no-repeat;
            background-size: 450%;
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
          }
        </style>
        <div class="filmarks-base">
          <a href="https://filmarks.com/users/sambaiz" class="filmarks"></a>
        </div>
      </div>
    </header>

<div class="container">
  <article class="single">
    <div class="single body">
      <h1>IstioをHelmでインストールしてRoutingとTelemetryを行いJaeger/Kialiで確認する</h1>
      <p>(2018-09-02)</p>
      <p>Istioは<a href="https://www.envoyproxy.io/">Envoy</a>というProxyをSidecarとしてPodに入れてトラフィックを通すことでマイクロサービスのRoutingやTelemetryをサービスのコードに手を入れずに行うことができるサービスメッシュ。
もともとEnvoy自体は単体で、コネクションを張りっぱなしのgRPC(HTTP/2)をK8sのServiceのL4ロードバランサーでは分散できない問題の解決方法の一つとして
各PodのIPの一覧を返す<a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services">Headless Service</a>と使われていたが、各Manifestに入れたりConfigMapを編集したりする必要があり少し面倒だった。
Istioにするとそれらが省けて、さらに賢いRoutingやモニタリングの仕組みまで付いてくるのでとても便利だ。</p>
<h2 id="インストールhttpsistioiodocssetupkuberneteshelm-install"><a href="https://istio.io/docs/setup/kubernetes/helm-install/">インストール</a></h2>
<p>IstioをダウンロードしてきてHelmでインストールする。Istioには様々なコンポーネントが含まれているが、<a href="https://github.com/istio/istio/blob/b17b4989699a6d9dc98245c511dc7d544d88e945/install/kubernetes/helm/istio/README.md#configuration">パラメータ</a>でインストールするものを選択することができる。</p>
<p><a href="https://www.sambaiz.net/article/122/">KubernetesのパッケージマネージャーHelmを使う - sambaiz-net</a></p>
<p>今回はデフォルトではfalseになっているGrafana/Jaeger/Kialiをtrueにしてほぼ全て入るようにしている。</p>
<p>RBACが有効な場合はServiceAccountを作ってcluster-adminあるいは必要なRoleをBindしておく。</p>
<p><a href="https://www.sambaiz.net/article/160/">RBACが有効なGKEでHelmを使う - sambaiz-net</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">$ curl -L https://git.io/getLatestIstio | sh -
$ cd istio-1.0.1/
# helm init --service-account tiller
$ helm install install/kubernetes/helm/istio --name istio --namespace istio-system --set grafana.enabled=true --set grafana.persist=true --set grafana.storageClassName=standard --set tracing.enabled=true --set kiali.enabled=true
$ kubectl get pod -n istio-system
NAME                                        READY     STATUS    RESTARTS   AGE
grafana-598678cbb-bglbq                     1/1       Running   0          3m
istio-citadel-6f9887d776-tvdg8              1/1       Running   0          3m
istio-egressgateway-84d78d84bf-zpxrq        1/1       Running   0          3m
istio-galley-556f5558f5-hk2r8               1/1       Running   0          3m
istio-ingressgateway-78cccbddbb-gh2xl       1/1       Running   0          3m
istio-pilot-799845f56d-l777d                2/2       Running   0          3m
istio-policy-7666fcd574-nbx8s               2/2       Running   0          3m
istio-sidecar-injector-7b6589c9-m7x77       1/1       Running   0          3m
istio-statsd-prom-bridge-55965ff9c8-s6dmj   1/1       Running   0          3m
istio-telemetry-844c8d6bff-9trcf            2/2       Running   0          3m
istio-tracing-77f9f94b98-g7v6f              1/1       Running   0          3m
kiali-bdf7fdc78-9lpd4                       1/1       Running   0          3m
prometheus-7456f56c96-drhlq                 1/1       Running   0          3m
</code></pre></div><p>default namespaceにラベルを貼って自動でEnvoyが各Podに<a href="https://github.com/istio/istio/blob/1.0.1/install/kubernetes/helm/istio/templates/sidecar-injector-configmap.yaml#L77">Injectionされる</a>ようにする。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">$ kubectl get namespace -L istio-injection
NAME           STATUS    AGE       ISTIO-INJECTION
default        Active    27m       
istio-system   Active    16m       
kube-public    Active    27m       
kube-system    Active    27m 

$ kubectl label namespace default istio-injection=enabled
</code></pre></div><p>併せて<a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/">Init Containers</a>としてInjectionされるistio-initのiptablesで<a href="https://github.com/istio/istio/blob/1.0.1/tools/deb/istio-iptables.sh#L292">Envoy以外</a>のトラフィックが<a href="https://github.com/istio/istio/blob/1.0.1/tools/deb/istio-iptables.sh#L202">Envoyのポートに向く</a>のでサービスのコードでは向き先を変える必要がない。</p>
<h2 id="routing">Routing</h2>
<h3 id="pilothttpsistioiodocsconceptstraffic-managementpilot-and-envoy"><a href="https://istio.io/docs/concepts/traffic-management/#pilot-and-envoy">Pilot</a></h3>
<p>全Envoyを管理するPilotにEnvoy間のトラフィックのルーティングや、リトライやサーキットブレーカーのルールを設定できる。
EnvoyはPilotからサービスディスカバリして他Envoyについて知り、定期的にロードバランシングプールに含まれるインスタンスのヘルスチェックをして失敗数がしきい値を超えたら成功数がしきい値を超えるまでプールから追い出し、ルールに従いトラフィックを制御する。</p>
<h3 id="リソース">リソース</h3>
<ul>
<li><a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#Gateway">Gateway</a>: HTTP/TCPロードバランサー。</li>
</ul>
<p>Ingressとは異なりL4-L6のポートやTLSの設定は持つがL7の設定は持たず、VirtualServiceに持つ。
インフラ管理者とサービス開発者が触るであろうリソースが分離されている。</p>
<p><a href="https://www.sambaiz.net/article/173/">GKEでのService(ClusterIP/NodePort/LoadBalancer)とIngress - sambaiz-net</a></p>
<ul>
<li><a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#VirtualService">VirtualService</a>: ルーティングのルール。</li>
<li><a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#DestinationRule">DestinationRule</a>: ロードバランシングのルール。</li>
</ul>
<h3 id="例httpsistioiodocsexamplesbookinfo"><a href="https://istio.io/docs/examples/bookinfo/">例</a></h3>
<p>サンプルアプリケーションBookInfoを動かす。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">$ kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
$ kubectl get pod
NAME                              READY     STATUS    RESTARTS   AGE
details-v1-7bcdcc4fd6-x92f5       2/2       Running   0          1m
productpage-v1-8584c875d8-jxl68   2/2       Running   0          1m
ratings-v1-54cf9dc8f8-wv9xz       2/2       Running   0          1m
reviews-v1-59cbdd7959-vxf2f       2/2       Running   0          1m
reviews-v2-dccb4cfc9-mc22f        2/2       Running   0          1m
reviews-v3-5465dc97bc-pgvbl       2/2       Running   0          1m
</code></pre></div><p>GatewayとVirtualServiceを作成して外に開く。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml">$ cat samples/bookinfo/networking/bookinfo-gateway.yaml
<span style="color:#ff79c6">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#ff79c6">kind</span>: Gateway
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: bookinfo-gateway
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">selector</span>:
    <span style="color:#ff79c6">istio</span>: ingressgateway # use istio default controller
  <span style="color:#ff79c6">servers</span>:
  - <span style="color:#ff79c6">port</span>:
      <span style="color:#ff79c6">number</span>: <span style="color:#bd93f9">80</span>
      <span style="color:#ff79c6">name</span>: http
      <span style="color:#ff79c6">protocol</span>: HTTP
    <span style="color:#ff79c6">hosts</span>:
    - <span style="color:#f1fa8c">&#34;*&#34;</span>
---
<span style="color:#ff79c6">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#ff79c6">kind</span>: VirtualService
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: bookinfo
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">hosts</span>:
  - <span style="color:#f1fa8c">&#34;*&#34;</span>
  <span style="color:#ff79c6">gateways</span>:
  - bookinfo-gateway
  <span style="color:#ff79c6">http</span>:
  - <span style="color:#ff79c6">match</span>:
    - <span style="color:#ff79c6">uri</span>:
        <span style="color:#ff79c6">exact</span>: /productpage
    - <span style="color:#ff79c6">uri</span>:
        <span style="color:#ff79c6">exact</span>: /login
    - <span style="color:#ff79c6">uri</span>:
        <span style="color:#ff79c6">exact</span>: /logout
    - <span style="color:#ff79c6">uri</span>:
        <span style="color:#ff79c6">prefix</span>: /api/v1/products
    <span style="color:#ff79c6">route</span>:
    - <span style="color:#ff79c6">destination</span>:
        <span style="color:#ff79c6">host</span>: productpage
        <span style="color:#ff79c6">port</span>:
          <span style="color:#ff79c6">number</span>: <span style="color:#bd93f9">9080</span>

$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
$ export INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=&#39;{.status.loadBalancer.ingress[0].ip}&#39;)
$ export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=&#39;{.spec.ports[?(@.name==&#34;http2&#34;)].port}&#39;)
$ export GATEWAY_URL=http://$INGRESS_HOST:$INGRESS_PORT
$ open $GATEWAY_URL/productpage
</code></pre></div><p><img src="https://www.sambaiz.net/images/185-bookinfo.png" alt="BookInfo"></p>
<p>DestinationRuleを作成する。この時点では各バージョンがラウンドロビンする。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml">$ cat samples/bookinfo/networking/destination-rule-all.yaml
<span style="color:#ff79c6">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#ff79c6">kind</span>: DestinationRule
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: productpage
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">host</span>: productpage
  <span style="color:#ff79c6">subsets</span>:
  - <span style="color:#ff79c6">name</span>: v1
    <span style="color:#ff79c6">labels</span>:
      <span style="color:#ff79c6">version</span>: v1
---
<span style="color:#ff79c6">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#ff79c6">kind</span>: DestinationRule
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: reviews
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">host</span>: reviews
  <span style="color:#ff79c6">subsets</span>:
  - <span style="color:#ff79c6">name</span>: v1
    <span style="color:#ff79c6">labels</span>:
      <span style="color:#ff79c6">version</span>: v1
  - <span style="color:#ff79c6">name</span>: v2
    <span style="color:#ff79c6">labels</span>:
      <span style="color:#ff79c6">version</span>: v2
  - <span style="color:#ff79c6">name</span>: v3
    <span style="color:#ff79c6">labels</span>:
      <span style="color:#ff79c6">version</span>: v3
---
<span style="color:#ff79c6">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#ff79c6">kind</span>: DestinationRule
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: ratings
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">host</span>: ratings
  <span style="color:#ff79c6">subsets</span>:
  - <span style="color:#ff79c6">name</span>: v1
    <span style="color:#ff79c6">labels</span>:
      <span style="color:#ff79c6">version</span>: v1
  - <span style="color:#ff79c6">name</span>: v2
    <span style="color:#ff79c6">labels</span>:
      <span style="color:#ff79c6">version</span>: v2
  - <span style="color:#ff79c6">name</span>: v2-mysql
    <span style="color:#ff79c6">labels</span>:
      <span style="color:#ff79c6">version</span>: v2-mysql
  - <span style="color:#ff79c6">name</span>: v2-mysql-vm
    <span style="color:#ff79c6">labels</span>:
      <span style="color:#ff79c6">version</span>: v2-mysql-vm
---
<span style="color:#ff79c6">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#ff79c6">kind</span>: DestinationRule
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: details
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">host</span>: details
  <span style="color:#ff79c6">subsets</span>:
  - <span style="color:#ff79c6">name</span>: v1
    <span style="color:#ff79c6">labels</span>:
      <span style="color:#ff79c6">version</span>: v1
  - <span style="color:#ff79c6">name</span>: v2
    <span style="color:#ff79c6">labels</span>:
      <span style="color:#ff79c6">version</span>: v2
---

$ kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml
</code></pre></div><p>VirtualServiceのdestinationでsubsetを指定するとそのバージョンのみに<a href="https://istio.io/docs/tasks/traffic-management/request-routing/">飛ぶ</a>ようになる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml">$ cat samples/bookinfo/networking/virtual-service-all-v1.yaml
<span style="color:#ff79c6">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#ff79c6">kind</span>: VirtualService
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: productpage
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">hosts</span>:
  - productpage
  <span style="color:#ff79c6">http</span>:
  - <span style="color:#ff79c6">route</span>:
    - <span style="color:#ff79c6">destination</span>:
        <span style="color:#ff79c6">host</span>: productpage
        <span style="color:#ff79c6">subset</span>: v1
---
<span style="color:#ff79c6">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#ff79c6">kind</span>: VirtualService
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: reviews
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">hosts</span>:
  - reviews
  <span style="color:#ff79c6">http</span>:
  - <span style="color:#ff79c6">route</span>:
    - <span style="color:#ff79c6">destination</span>:
        <span style="color:#ff79c6">host</span>: reviews
        <span style="color:#ff79c6">subset</span>: v1
---
<span style="color:#ff79c6">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#ff79c6">kind</span>: VirtualService
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: ratings
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">hosts</span>:
  - ratings
  <span style="color:#ff79c6">http</span>:
  - <span style="color:#ff79c6">route</span>:
    - <span style="color:#ff79c6">destination</span>:
        <span style="color:#ff79c6">host</span>: ratings
        <span style="color:#ff79c6">subset</span>: v1
---
<span style="color:#ff79c6">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#ff79c6">kind</span>: VirtualService
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: details
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">hosts</span>:
  - details
  <span style="color:#ff79c6">http</span>:
  - <span style="color:#ff79c6">route</span>:
    - <span style="color:#ff79c6">destination</span>:
        <span style="color:#ff79c6">host</span>: details
        <span style="color:#ff79c6">subset</span>: v1
---

$ kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre></div><p>VirtualServiceはheaderの中身をみてルーティングさせることもできる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml">$ cat samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
<span style="color:#ff79c6">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#ff79c6">kind</span>: VirtualService
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: reviews
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">hosts</span>:
    - reviews
  <span style="color:#ff79c6">http</span>:
  - <span style="color:#ff79c6">match</span>:
    - <span style="color:#ff79c6">headers</span>:
        <span style="color:#ff79c6">end-user</span>:
          <span style="color:#ff79c6">exact</span>: jason
    <span style="color:#ff79c6">route</span>:
    - <span style="color:#ff79c6">destination</span>:
        <span style="color:#ff79c6">host</span>: reviews
        <span style="color:#ff79c6">subset</span>: v2
  - <span style="color:#ff79c6">route</span>:
    - <span style="color:#ff79c6">destination</span>:
        <span style="color:#ff79c6">host</span>: reviews
        <span style="color:#ff79c6">subset</span>: v1

$ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
</code></pre></div><p><a href="https://istio.io/docs/tasks/traffic-management/fault-injection/">Fault Injection</a>して特定条件や割合で意図的に遅延を生じさせたり、エラーコードを返らせたりできる。バグの発見や調査、Chaos Engineeringもできそうだ。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml">$ cat samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml
<span style="color:#ff79c6">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#ff79c6">kind</span>: VirtualService
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: ratings
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">hosts</span>:
  - ratings
  <span style="color:#ff79c6">http</span>:
  - <span style="color:#ff79c6">match</span>:
    - <span style="color:#ff79c6">headers</span>:
        <span style="color:#ff79c6">end-user</span>:
          <span style="color:#ff79c6">exact</span>: jason
    <span style="color:#ff79c6">fault</span>:
      <span style="color:#ff79c6">delay</span>:
        <span style="color:#ff79c6">percent</span>: <span style="color:#bd93f9">100</span>
        <span style="color:#ff79c6">fixedDelay</span>: 7s
    <span style="color:#ff79c6">route</span>:
    - <span style="color:#ff79c6">destination</span>:
        <span style="color:#ff79c6">host</span>: ratings
        <span style="color:#ff79c6">subset</span>: v1
  - <span style="color:#ff79c6">route</span>:
    - <span style="color:#ff79c6">destination</span>:
        <span style="color:#ff79c6">host</span>: ratings
        <span style="color:#ff79c6">subset</span>: v1

$ kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml
</code></pre></div><p>routeには複数のdestinationを指定できてweightによって飛ばす割合を<a href="https://istio.io/docs/tasks/traffic-management/traffic-shifting/">変えられる</a>。
カナリアリリースやA/Bテストが簡単にできる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml">$ cat samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml
<span style="color:#ff79c6">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#ff79c6">kind</span>: VirtualService
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: reviews
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">hosts</span>:
    - reviews
  <span style="color:#ff79c6">http</span>:
  - <span style="color:#ff79c6">route</span>:
    - <span style="color:#ff79c6">destination</span>:
        <span style="color:#ff79c6">host</span>: reviews
        <span style="color:#ff79c6">subset</span>: v1
      <span style="color:#ff79c6">weight</span>: <span style="color:#bd93f9">50</span>
    - <span style="color:#ff79c6">destination</span>:
        <span style="color:#ff79c6">host</span>: reviews
        <span style="color:#ff79c6">subset</span>: v3
      <span style="color:#ff79c6">weight</span>: <span style="color:#bd93f9">50</span>

$ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml
</code></pre></div><h2 id="telemetry">Telemetry</h2>
<h3 id="mixerhttpsistioiodocsconceptspolicies-and-telemetry"><a href="https://istio.io/docs/concepts/policies-and-telemetry/">Mixer</a></h3>
<p>MixerはポリシーコントロールとTelemetryを行うコンポーネント。
<a href="https://istio.io/docs/reference/config/policy-and-telemetry/adapters/">Adapter</a>によってStackdriverやCloudWatchなど様々なバックエンドに対応している。</p>
<p>Envoyは前提条件を確認するためリクエストの前と、Telemetryするためリクエストの後にMixerを呼び出す。ただしキャッシュとバッファを持っていて毎回呼び出しはしない。また、Mixerもキャッシュやバッファを持ちバックエンドの呼び出し回数を減らしている。
MixerがSPOFとなり可用性が下がるのではと思われるが、バックエンドの障害をある程度許容できるのに加えて Mixer自身はステートレスで他のバックエンドよりも可用性が高く設計されているためむしろ<a href="https://istio.io/blog/2017/mixer-spof-myth/">SLOが向上する</a>そうだ。</p>
<h3 id="リソース-1">リソース</h3>
<ul>
<li><a href="https://istio.io/docs/concepts/policies-and-telemetry/#handlers">Handler(Adapter)</a>: Mixerからバックエンドへ送る。</li>
<li><a href="https://istio.io/docs/concepts/policies-and-telemetry/#instances">Instance</a>: EnvoyからMixerに送られてきたAttributeをAdapterの入力へマッピングする。</li>
<li><a href="https://istio.io/docs/concepts/policies-and-telemetry/#rules">Rule</a>: Handlerが特定のInstancesで呼び出されるルール。</li>
</ul>
<h3 id="例httpsistioiodocstaskstelemetrymetrics-logs"><a href="https://istio.io/docs/tasks/telemetry/metrics-logs/">例</a></h3>
<p>リクエストの2倍の数を値とするmetric instance。<a href="https://istio.io/docs/reference/config/policy-and-telemetry/expression-language/">configuration expression language(CEXL)</a>が使われている。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml">$ cat new_telemetry.yaml 
<span style="color:#6272a4"># Configuration for metric instances</span>
<span style="color:#ff79c6">apiVersion</span>: <span style="color:#f1fa8c">&#34;config.istio.io/v1alpha2&#34;</span>
<span style="color:#ff79c6">kind</span>: metric
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: doublerequestcount
  <span style="color:#ff79c6">namespace</span>: istio-system
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">value</span>: <span style="color:#f1fa8c">&#34;2&#34;</span> <span style="color:#6272a4"># count each request twice</span>
  <span style="color:#ff79c6">dimensions</span>:
    <span style="color:#ff79c6">reporter</span>: conditional((context.reporter.kind | &#34;inbound&#34;) == &#34;outbound&#34;, &#34;client&#34;, &#34;server&#34;)
    <span style="color:#ff79c6">source</span>: source.workload.name | &#34;unknown&#34;
    <span style="color:#ff79c6">destination</span>: destination.workload.name | &#34;unknown&#34;
    <span style="color:#ff79c6">message</span>: <span style="color:#f1fa8c">&#39;&#34;twice the fun!&#34;&#39;</span>
  <span style="color:#ff79c6">monitored_resource_type</span>: <span style="color:#f1fa8c">&#39;&#34;UNSPECIFIED&#34;&#39;</span>
---
</code></pre></div><p>このmetricを受け取るprometheus handler。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml"><span style="color:#6272a4"># Configuration for a Prometheus handler</span>
<span style="color:#ff79c6">apiVersion</span>: <span style="color:#f1fa8c">&#34;config.istio.io/v1alpha2&#34;</span>
<span style="color:#ff79c6">kind</span>: prometheus
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: doublehandler
  <span style="color:#ff79c6">namespace</span>: istio-system
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">metrics</span>:
  - <span style="color:#ff79c6">name</span>: double_request_count # Prometheus metric name
    <span style="color:#ff79c6">instance_name</span>: doublerequestcount.metric.istio-system # Mixer instance name (fully-qualified)
    <span style="color:#ff79c6">kind</span>: COUNTER
    <span style="color:#ff79c6">label_names</span>:
    - reporter
    - source
    - destination
    - message
---
</code></pre></div><p>そしてこれらを紐づけるrule。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml"><span style="color:#6272a4"># Rule to send metric instances to a Prometheus handler</span>
<span style="color:#ff79c6">apiVersion</span>: <span style="color:#f1fa8c">&#34;config.istio.io/v1alpha2&#34;</span>
<span style="color:#ff79c6">kind</span>: rule
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: doubleprom
  <span style="color:#ff79c6">namespace</span>: istio-system
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">actions</span>:
  - <span style="color:#ff79c6">handler</span>: doublehandler.prometheus
    <span style="color:#ff79c6">instances</span>:
    - doublerequestcount.metric
---
</code></pre></div><p><a href="https://istio.io/docs/reference/config/policy-and-telemetry/templates/logentry/">logentry</a>はログを表すinstance。
あとはそれを標準出力するhandlerとrule。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml"><span style="color:#6272a4"># Configuration for logentry instances</span>
<span style="color:#ff79c6">apiVersion</span>: <span style="color:#f1fa8c">&#34;config.istio.io/v1alpha2&#34;</span>
<span style="color:#ff79c6">kind</span>: logentry
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: newlog
  <span style="color:#ff79c6">namespace</span>: istio-system
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">severity</span>: <span style="color:#f1fa8c">&#39;&#34;warning&#34;&#39;</span>
  <span style="color:#ff79c6">timestamp</span>: request.time
  <span style="color:#ff79c6">variables</span>:
    <span style="color:#ff79c6">source</span>: source.labels[&#34;app&#34;] | source.workload.name | &#34;unknown&#34;
    <span style="color:#ff79c6">user</span>: source.user | &#34;unknown&#34;
    <span style="color:#ff79c6">destination</span>: destination.labels[&#34;app&#34;] | destination.workload.name | &#34;unknown&#34;
    <span style="color:#ff79c6">responseCode</span>: response.code | 0
    <span style="color:#ff79c6">responseSize</span>: response.size | 0
    <span style="color:#ff79c6">latency</span>: response.duration | &#34;0ms&#34;
  <span style="color:#ff79c6">monitored_resource_type</span>: <span style="color:#f1fa8c">&#39;&#34;UNSPECIFIED&#34;&#39;</span>
---
<span style="color:#6272a4"># Configuration for a stdio handler</span>
<span style="color:#ff79c6">apiVersion</span>: <span style="color:#f1fa8c">&#34;config.istio.io/v1alpha2&#34;</span>
<span style="color:#ff79c6">kind</span>: stdio
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: newhandler
  <span style="color:#ff79c6">namespace</span>: istio-system
<span style="color:#ff79c6">spec</span>:
 <span style="color:#ff79c6">severity_levels</span>:
   <span style="color:#ff79c6">warning</span>: <span style="color:#bd93f9">1</span> <span style="color:#6272a4"># Params.Level.WARNING</span>
 <span style="color:#ff79c6">outputAsJson</span>: <span style="color:#ff79c6">true</span>
---
<span style="color:#6272a4"># Rule to send logentry instances to a stdio handler</span>
<span style="color:#ff79c6">apiVersion</span>: <span style="color:#f1fa8c">&#34;config.istio.io/v1alpha2&#34;</span>
<span style="color:#ff79c6">kind</span>: rule
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: newlogstdio
  <span style="color:#ff79c6">namespace</span>: istio-system
<span style="color:#ff79c6">spec</span>:
  <span style="color:#ff79c6">match</span>: <span style="color:#f1fa8c">&#34;true&#34;</span> <span style="color:#6272a4"># match for all requests</span>
  <span style="color:#ff79c6">actions</span>:
   - <span style="color:#ff79c6">handler</span>: newhandler.stdio
     <span style="color:#ff79c6">instances</span>:
     - newlog.logentry
---

$ kubectl apply -f new_telemetry.yaml 
</code></pre></div><p>Prometheus handlerによってdoublerequestcount metricが届いている。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">$ kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=prometheus -o jsonpath=&#39;{.items[0].metadata.name}&#39;) 9090:9090
$ open http://localhost:9090/graph
</code></pre></div><p><img src="https://www.sambaiz.net/images/185-prometheus.png" alt="Prometheus"></p>
<p>stdio handlerによってnewlog logentryが出力されている。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-json" data-lang="json">$ kubectl -n istio-system logs -f $(kubectl -n istio-system get pods -l istio-mixer-type=telemetry -o jsonpath=&#39;{.items[0].metadata.name}&#39;) -c mixer | grep \<span style="color:#f1fa8c">&#34;instance\&#34;:\&#34;newlog.logentry.istio-system\&#34; 
</span><span style="color:#f1fa8c">{&#34;</span>level<span style="color:#f1fa8c">&#34;:&#34;</span>warn<span style="color:#f1fa8c">&#34;,&#34;</span>time<span style="color:#f1fa8c">&#34;:&#34;</span><span style="color:#bd93f9">2018-09-01</span>T<span style="color:#bd93f9">13</span>:<span style="color:#bd93f9">53</span>:<span style="color:#bd93f9">45.897141</span>Z<span style="color:#f1fa8c">&#34;,&#34;</span>instance<span style="color:#f1fa8c">&#34;:&#34;</span>l<span style="color:#f1fa8c">&#34;,&#34;</span>destination<span style="color:#f1fa8c">&#34;:&#34;</span>telemetry<span style="color:#f1fa8c">&#34;,&#34;</span>latency<span style="color:#f1fa8c">&#34;:&#34;</span><span style="color:#bd93f9">3.817501</span>ms<span style="color:#f1fa8c">&#34;,&#34;</span>responseCode<span style="color:#f1fa8c">&#34;:200,&#34;</span>responseSize<span style="color:#f1fa8c">&#34;:5,&#34;</span>source<span style="color:#f1fa8c">&#34;:&#34;</span>details<span style="color:#f1fa8c">&#34;,&#34;</span>user<span style="color:#f1fa8c">&#34;:&#34;</span>unknown<span style="color:#f1fa8c">&#34;}
</span><span style="color:#f1fa8c">{&#34;</span>level<span style="color:#f1fa8c">&#34;:&#34;</span>warn<span style="color:#f1fa8c">&#34;,&#34;</span>time<span style="color:#f1fa8c">&#34;:&#34;</span><span style="color:#bd93f9">2018-09-01</span>T<span style="color:#bd93f9">13</span>:<span style="color:#bd93f9">53</span>:<span style="color:#bd93f9">45.899237</span>Z<span style="color:#f1fa8c">&#34;,&#34;</span>instance<span style="color:#f1fa8c">&#34;:&#34;</span>newlog.logentry.istio-system<span style="color:#f1fa8c">&#34;,&#34;</span>destination<span style="color:#f1fa8c">&#34;:&#34;</span>telemetry<span style="color:#f1fa8c">&#34;,&#34;</span>latency<span style="color:#f1fa8c">&#34;:&#34;</span><span style="color:#bd93f9">4.423947</span>ms<span style="color:#f1fa8c">&#34;,&#34;</span>responseCode<span style="color:#f1fa8c">&#34;:200,&#34;</span>responseSize<span style="color:#f1fa8c">&#34;:5,&#34;</span>source<span style="color:#f1fa8c">&#34;:&#34;</span>productpage<span style="color:#f1fa8c">&#34;,&#34;</span>user<span style="color:#f1fa8c">&#34;:&#34;</span>unknown&#34;}
</code></pre></div><h2 id="grafana">Grafana</h2>
<p>Grafanaを開くと最初からIstioのダッシュボードがいくつか作られている。
Prometheusに送ったmetricをGrafanaで可視化できる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">$ kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=grafana -o jsonpath=&#39;{.items[0].metadata.name}&#39;) 3000:3000
$ open http://localhost:3000
</code></pre></div><p><img src="https://www.sambaiz.net/images/185-grafana.png" alt="Grafana"></p>
<h2 id="jaeger">Jaeger</h2>
<p><a href="https://www.jaegertracing.io/">Jaeger</a>は分散トレーシングツール。
パフォーマンスが問題になったときにどこのサービスがボトルネックになっているかが分かる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">$ kubectl port-forward -n istio-system $(kubectl get pod -n istio-system -l app=jaeger -o jsonpath=&#39;{.items[0].metadata.name}&#39;) 16686:16686
$ open http://localhost:16686
</code></pre></div><p><img src="https://www.sambaiz.net/images/185-jaeger.png" alt="Jaeger"></p>
<h2 id="kiali">Kiali</h2>
<p><a href="http://www.kiali.io/">Kiali</a>はサービスメッシュを可視化するツール。v1とv3にリクエストが飛んでいてv2には飛んでいないことが分かる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">$ kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=kiali -o jsonpath=&#39;{.items[0].metadata.name}&#39;) 20001:20001
$ open http://localhost:20001
</code></pre></div><p><img src="https://www.sambaiz.net/images/185-kiali.png" alt="Kiali"></p>
<h2 id="参考">参考</h2>
<p><a href="https://qiita.com/wataru420/items/a63a8b205308a93e253c">kubernetesでgRPCするときにenvoy挟んでみたよ</a></p>
<p><a href="https://thenewstack.io/why-you-should-care-about-istio-gateways/">Why You Should Care About Istio Gateways - The New Stack</a></p>

    </div>
  </article>
</div>

</div>

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date(); a = s.createElement(o),
      m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-39190067-3', 'auto');
  ga('send', 'pageview');
</script>


</body>

</html>